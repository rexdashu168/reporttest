<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤ (Revenue Pro)</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>if(typeof XLSX==='undefined'){document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>');}</script>
    <style>
        /* ===== 1. ç‰ˆé¢é‚„åŸè‡³ v7.0 (æ‰‹æ©Ÿå„ªå…ˆã€ç½®ä¸­ã€ç„¡å½ˆçª—) ===== */
        :root { --primary: #c96442; --bg: #f5f4ef; --text: #333; --gray: #666; --border: #e0e0e0; --link: #2980b9; --up: #e74c3c; --down: #27ae60; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; 
            background: var(--bg); color: var(--text); padding-bottom: 60px;
            overflow-x: hidden; 
        }

        .container { 
            width: 100%; max-width: 600px; margin: 0 auto; padding: 16px; position: relative;
        }

        /* Loading & Transitions */
        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .view-page { display: none; animation: fadeIn 0.25s ease-out; width: 100%; }
        .view-page.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

        /* Header & Tabs */
        .header { text-align: center; padding: 10px 0 20px; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
        .header h1 { color: var(--primary); font-size: 20px; margin-bottom: 4px; font-weight: 800; }
        .db-switcher { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 15px; scrollbar-width: none; }
        .db-tab { flex: 0 0 auto; padding: 6px 14px; background: #fff; border: 1px solid var(--border); border-radius: 20px; font-size: 13px; color: var(--gray); cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .db-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 5px rgba(201, 100, 66, 0.3); }
        .count { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 10px; font-size: 10px; }
        
        /* Search Box */
        .search-box { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 35px 12px 40px; border-radius: 25px; border: 2px solid var(--border); background: #fff; font-size: 15px; outline: none; }
        .search-input:focus { border-color: var(--primary); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #999; }
        .clear-btn { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; background: #ccc; color: #fff; border-radius: 50%; font-size: 12px; line-height: 20px; text-align: center; cursor: pointer; display: none; }

        /* Cards */
        .card-list { display: flex; flex-direction: column; gap: 12px; }
        .card { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; }
        .card:active { transform: scale(0.98); }
        .card-head { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: flex-start; }
        .card-title { font-weight: 700; font-size: 16px; color: #2c3e50; line-height: 1.3; }
        .stock-code { color: #999; font-weight: 400; font-size: 14px; margin-left: 5px; }
        .card-meta { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .tag { font-size: 11px; padding: 2px 8px; border-radius: 6px; color: #fff; font-weight: 500; }
        .tag.brk { background: var(--primary); }
        .tag.ind { background: #2980b9; }
        .tag.dt { background: #e0e0e0; color: #666; }
        .tag.st { background: #27ae60; }
        .tag.concept { background: #8e44ad; }
        .card-body { font-size: 13px; color: #555; line-height: 1.6; word-break: break-word; }

        /* Detail Elements */
        .detail-navbar { position: sticky; top: 0; background: var(--bg); padding: 10px 0; z-index: 100; margin-bottom: 10px; margin-left: -16px; margin-right: -16px; padding-left: 16px; padding-right: 16px; box-shadow: 0 4px 6px -4px rgba(0,0,0,0.1); }
        .back-btn { background: #fff; border: 1px solid var(--border); padding: 8px 16px; border-radius: 20px; color: var(--primary); font-weight: 700; font-size: 14px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
        
        /* Information Components */
        .info-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.03); }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .info-label { color: #888; }
        .info-val { font-weight: 600; color: #333; text-align: right; max-width: 65%; }
        
        /* === 2. ç‡Ÿæ”¶ä¸€é é€šå°ˆç”¨æ¨£å¼ === */
        .fin-tab-group { display: flex; border: 1px solid var(--primary); border-radius: 8px; overflow: hidden; margin-bottom: 10px; }
        .fin-tab-btn { flex: 1; padding: 8px; text-align: center; font-size: 13px; color: var(--primary); background: #fff; cursor: pointer; font-weight: 600; border-right: 1px solid var(--primary); }
        .fin-tab-btn:last-child { border-right: none; }
        .fin-tab-btn.active { background: var(--primary); color: #fff; }
        
        .data-table-wrap { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; margin-bottom: 15px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
        .data-table th { background: #f8f9fa; padding: 8px; color: #555; font-weight: 700; border-bottom: 2px solid #ddd; text-align: right; position: sticky; top: 0; }
        .data-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: right; color: #333; }
        .data-table th:first-child, .data-table td:first-child { text-align: left; position: sticky; left: 0; background: #fff; z-index: 2; border-right: 2px solid #eee; }
        .data-table tr:nth-child(even) td { background: #fcfcfc; }
        .data-table tr:nth-child(even) td:first-child { background: #fcfcfc; }
        
        /* Colors */
        .t-up { color: var(--up); font-weight: 700; }
        .t-down { color: var(--down); font-weight: 700; }
        .hl-block { background: #fafaf8; padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary); margin-bottom: 10px; font-size: 13px; line-height: 1.6; }
        
        /* Navigation Buttons */
        .nav-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; background: #fff; padding: 10px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .nav-btn { padding: 10px 5px; border-radius: 8px; border: none; background: #f5f5f5; font-size: 13px; font-weight: 600; color: #666; cursor: pointer; }
        .nav-btn.active.b-basic { background: #e3f2fd; color: #1565c0; } 
        .nav-btn.active.b-fin { background: #fff8e1; color: #f57f17; } 
        .nav-btn.active.b-prod { background: #efebe9; color: #5d4037; } 
        .nav-btn.active.b-rep { background: #f3e5f5; color: #7b1fa2; } 
        .nav-btn.active.b-time { background: #ffebee; color: #c62828; } 
        .nav-btn.active.b-rate { background: #e0f2f1; color: #00695c; } 
        
        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeIn 0.3s; }
        .fin-sub-pane { display: none; }
        .fin-sub-pane.active { display: block; animation: fadeIn 0.3s; }

        /* Others */
        .highlight { background-color: #fff3cd; color: #856404; font-weight: bold; padding: 0 2px; border-radius: 2px; }
        .tag-link, .stock-link { color: var(--link); cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div style="font-size:40px;margin-bottom:10px">ğŸ“Š</div>
    <div style="font-weight:700;font-size:18px;margin-bottom:5px">Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</div>
    <div style="font-size:13px;color:#888" id="loadSub">æ­£åœ¨å»ºæ§‹ç‡Ÿæ”¶ä¸€é é€š...</div>
    <div style="width:200px;height:4px;background:#ddd;margin-top:15px;border-radius:2px;overflow:hidden"><div style="width:0%;height:100%;background:#c96442;transition:width 0.3s" id="loadBar"></div></div>
</div>

<div class="container">
    <div id="view-home" class="view-page active">
        <div class="header">
            <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
            <p style="font-size:12px;color:#666">å…¨æ–¹ä½å°è‚¡æŠ•è³‡æ±ºç­–ç³»çµ±</p>
        </div>

        <div class="db-switcher">
            <div class="db-tab active" onclick="setDB('news')">âš¡ å¤–é›» <span class="count" id="c-news">0</span></div>
            <div class="db-tab" onclick="setDB('memo')">ğŸ“‹ Memo <span class="count" id="c-memo">0</span></div>
            <div class="db-tab" onclick="setDB('reports')">ğŸ“‘ å ±å‘Š <span class="count" id="c-reports">0</span></div>
            <div class="db-tab" onclick="setDB('strategy')">ğŸ¯ ç­–ç•¥ <span class="count" id="c-strategy">0</span></div>
            <div class="db-tab" onclick="setDB('stocks')">ğŸ¢ å€‹è‚¡ <span class="count" id="c-stocks">0</span></div>
            <div class="db-tab" onclick="setDB('cb')">ğŸ« CB <span class="count" id="c-cb">0</span></div>
        </div>

        <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" class="search-input" id="search" placeholder="æœå°‹å…¬å¸ã€ä»£è™Ÿã€#Tag..." oninput="handleInput(this)">
            <div class="clear-btn" id="clearBtn" onclick="clearSearch()">âœ•</div>
        </div>

        <div style="font-size:12px;color:#666;margin-bottom:10px;">æ‰¾åˆ° <b id="resCount" style="color:var(--primary)">0</b> ç­†è³‡æ–™</div>
        <div class="card-list" id="list"></div>
    </div>

    <div id="view-detail" class="view-page">
        <div class="detail-navbar">
            <button class="back-btn" onclick="goBack()">â® è¿”å›åˆ—è¡¨</button>
        </div>
        
        <div id="m-info"></div>
        
        <div id="stock-nav" class="nav-grid" style="display:none">
            <button class="nav-btn active b-basic" onclick="swTab('basic', this)">ğŸ“Š åŸºæœ¬</button>
            <button class="nav-btn b-fin" onclick="swTab('fin', this)">ğŸ’° è²¡å‹™</button>
            <button class="nav-btn b-prod" onclick="swTab('prod', this)">ğŸ“¦ ç”¢å“</button>
            <button class="nav-btn b-rep" onclick="swTab('rep', this)">ğŸ“° å ±å°</button>
            <button class="nav-btn b-time" onclick="swTab('time', this)">ğŸ“… æ™‚ç¨‹</button>
            <button class="nav-btn b-rate" onclick="swTab('rate', this)">â­ è©•ç­‰</button>
        </div>

        <div id="m-body"></div>
    </div>
</div>

<script>
// --- Data & Config ---
const FILES = {
    NEWS: '01_news.xlsx', MEMO: '02_memo.xlsx', REPORTS: '03_reports.xlsx',
    MASTER: '04_master.xlsx', STRAT: '05_Strategy.xlsx', CB: '00_CB.xlsx', REV: '06_revenue.xlsx'
};
const DB = { news:[], memo:[], reports:[], strategy:[], stocks:{}, cb:[] };
const META = { 
    memoDetail:{}, tracking:{}, finance:{}, products:{}, timeline:[], ratings:{},
    cbMap:{}, relatedNews:{}, relatedMemo:{}, reportPicks:{}, stockInReports:{}, concepts: {},
    revData: { month: {}, quarter: {}, year: {}, highlights: {} }
};
let CURR_DB = 'news';

// Utils
const $ = id => document.getElementById(id);
const safe = v => (v==null||v==undefined?'':String(v).trim());
const fmtDate = v => {
    if(!v) return '';
    if(typeof v === 'number' && v > 20000) { const d=new Date((v-25569)*86400000); return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; }
    const s = String(v); if(s.match(/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}/)) return s.split(' ')[0]; return v;
};
const fmtTxt = (t) => {
    if(!t) return '';
    let html = safe(t).replace(/\n/g, '<br>').replace(/â€¢/g, '<br>â€¢ ');
    html = html.replace(/#(\S+)/g, '<span class="tag-link" onclick="setSearch(\'#$1\'); event.stopPropagation();">#$1</span>');
    html = html.replace(/(\d{4})/g, (match) => DB.stocks[match] ? `<span class="stock-link" onclick="openStock('${match}'); event.stopPropagation();">${match}</span>` : match);
    return html;
};
const getDateVal = (v) => { if(!v) return 0; if(typeof v === 'number') return (v - 25569) * 86400000; return new Date(v).getTime(); };
const colorClass = (v) => {
    if(!v || v==='-' || v===0) return '';
    const n = parseFloat(String(v).replace(/[%$,]/g,''));
    if(n > 0) return 't-up';
    if(n < 0) return 't-down';
    return '';
};
const fmtNum = (v, isPct=false) => {
    if(v===undefined || v===null || v==='') return '-';
    let n = parseFloat(String(v));
    if(isNaN(n)) return v;
    if(isPct) return n.toFixed(2) + '%';
    return n.toLocaleString();
};

// View Management
function switchPage(pageId) {
    document.querySelectorAll('.view-page').forEach(el => el.classList.remove('active'));
    $(pageId).classList.add('active');
    window.scrollTo(0,0);
}
function goBack() { switchPage('view-home'); }

// Search
function handleInput(el) { $('clearBtn').style.display = el.value.length > 0 ? 'block' : 'none'; renderList(); }
function clearSearch() { $('search').value=''; $('search').focus(); $('clearBtn').style.display='none'; renderList(); }
window.setSearch = (term) => { $('search').value = term; handleInput($('search')); goBack(); }

// --- Loaders ---
const loadStep = (t,s,p) => { $('loadTitle').innerText=t; $('loadSub').innerText=s; $('loadBar').style.width=p+'%'; };
async function fetchXlsx(url) {
    try {
        const res = await fetch(url);
        if(!res.ok) throw new Error();
        return XLSX.read(await res.arrayBuffer(), {type:'array'});
    } catch(e) { return null; }
}

async function init() {
    loadStep('å»ºç«‹ä¸»ç´¢å¼•...', FILES.MASTER, 10);
    let wb = await fetchXlsx(FILES.MASTER);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['ä¸»è³‡æ–™åº«']||[]).forEach(r=>{ if(r['ä»£è™Ÿ']) DB.stocks[safe(r['ä»£è™Ÿ'])]=r; });
        XLSX.utils.sheet_to_json(wb.Sheets['ğŸ’¡æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«']||[]).forEach(r => {
            const code=safe(r['è‚¡ç¥¨ä»£è™Ÿ']), concept=safe(r['æ¦‚å¿µåˆ†é¡']);
            if(code && concept) { if(!META.concepts[code]) META.concepts[code]=[]; if(!META.concepts[code].includes(concept)) META.concepts[code].push(concept); }
        });
    }
    
    // --- Revenue Parsing (Detailed) ---
    loadStep('è§£æè²¡å‹™å¤§æ•¸æ“š...', FILES.REV, 30);
    wb = await fetchXlsx(FILES.REV);
    if(wb) {
        // 1. Month Rev
        const sheetM = wb.Sheets['000_æœˆç‡Ÿæ”¶'] || wb.Sheets[wb.SheetNames[0]];
        const rowsM = XLSX.utils.sheet_to_json(sheetM);
        const headsM = Object.keys(rowsM[0]||{});
        const mCols = headsM.filter(h => h.includes('å–®æœˆç‡Ÿæ”¶(å„„)')).sort();
        
        // 2. Accumulated YoY (for full table)
        const sheetAcc = wb.Sheets['000_æœˆç´¯ç‡Ÿæ”¶å¹´å¢'];
        const rowsAcc = sheetAcc ? XLSX.utils.sheet_to_json(sheetAcc) : [];
        // Map accumulated yoy by code -> date -> value
        const accMap = {}; 
        rowsAcc.forEach(r => {
            const c = safe(r['ä»£è™Ÿ']);
            accMap[c] = {};
            Object.keys(r).forEach(k => { if(k.includes('ç´¯æœˆç‡Ÿæ”¶å¹´å¢')) accMap[c][k.match(/(\d+M\d+)/)[0]] = r[k]; });
        });

        // Build Month Data
        rowsM.forEach(r => {
            const c = safe(r['ä»£è™Ÿ']);
            if(!c) return;
            const data = mCols.map(col => {
                const dateCode = col.match(/(\d+M\d+)/)[0];
                return { 
                    d: dateCode, 
                    rev: r[col], 
                    accYoY: accMap[c]?.[dateCode] 
                };
            }).filter(i => i.rev); // Filter empty
            
            // Calculate MoM & YoY
            for(let i=0; i<data.length; i++) {
                // MoM
                if(i>0) {
                    const prev = parseFloat(data[i-1].rev);
                    const curr = parseFloat(data[i].rev);
                    if(prev) data[i].mom = ((curr-prev)/prev*100).toFixed(2);
                }
                // YoY (Approx 12 months back)
                if(i>=12) {
                    const prevY = parseFloat(data[i-12].rev);
                    const curr = parseFloat(data[i].rev);
                    if(prevY) data[i].yoy = ((curr-prevY)/prevY*100).toFixed(2);
                }
            }
            META.revData.month[c] = data.slice(-13).reverse(); // Store last 13 months
        });

        // 3. Quarter
        const sheetQ = wb.Sheets['000_å­£ç‡Ÿæ”¶'];
        if(sheetQ) {
            const rowsQ = XLSX.utils.sheet_to_json(sheetQ);
            const headsQ = Object.keys(rowsQ[0]||{});
            const qCols = headsQ.filter(h => h.includes('å–®å­£ç‡Ÿæ”¶(å„„)')).sort();
            rowsQ.forEach(r => {
                const c = safe(r['ä»£è™Ÿ']);
                if(!c) return;
                const data = qCols.map(col => ({ d: col.match(/(\d+Q\d)/)[0], rev: r[col] })).filter(i=>i.rev);
                // Calc QoQ / YoY
                for(let i=0; i<data.length; i++) {
                    if(i>0) data[i].qoq = ((data[i].rev-data[i-1].rev)/data[i-1].rev*100).toFixed(2);
                    if(i>=4) data[i].yoy = ((data[i].rev-data[i-4].rev)/data[i-4].rev*100).toFixed(2);
                }
                META.revData.quarter[c] = data.slice(-8).reverse();
            });
        }

        // 4. Year
        const sheetY = wb.Sheets['000_å¹´ç‡Ÿæ”¶'];
        if(sheetY) {
            const rowsY = XLSX.utils.sheet_to_json(sheetY);
            const headsY = Object.keys(rowsY[0]||{});
            const yCols = headsY.filter(h => h.includes('å¹´åº¦ç‡Ÿæ”¶(å„„)')).sort();
            rowsY.forEach(r => {
                const c = safe(r['ä»£è™Ÿ']);
                if(!c) return;
                const data = yCols.map(col => ({ d: col.match(/(\d{4})/)[0], rev: r[col] })).filter(i=>i.rev);
                for(let i=1; i<data.length; i++) {
                    data[i].yoy = ((data[i].rev-data[i-1].rev)/data[i-1].rev*100).toFixed(2);
                }
                META.revData.year[c] = data.slice(-5).reverse();
            });
        }
        
        // 5. Highlights
        const sheetN = wb.Sheets['10_è²¡å ±å‚™è¨»'];
        if(sheetN) XLSX.utils.sheet_to_json(sheetN).forEach(r=> META.revData.highlights[safe(r['ä»£è™Ÿ'])] = r);
    }

    loadStep('è®€å–å¤–é›»...', FILES.NEWS, 50);
    wb = await fetchXlsx(FILES.NEWS);
    if(wb) XLSX.utils.sheet_to_json(wb.Sheets['å¤–é›»ç¶œåˆå ±å°']||[]).forEach(r => {
        if(safe(r['è³‡æ–™é¡å‹'])==='å€‹è‚¡å ±å°') { DB.news.push(r); const k=safe(r['è‚¡è™Ÿ']); if(k){ if(!META.relatedNews[k]) META.relatedNews[k]=[]; META.relatedNews[k].push(r); } }
    });
    DB.news.sort((a,b) => getDateVal(b['æ—¥æœŸ']) - getDateVal(a['æ—¥æœŸ']));

    loadStep('è®€å–CB...', FILES.CB, 60);
    wb = await fetchXlsx(FILES.CB);
    if(wb) XLSX.utils.sheet_to_json(wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™']||[]).forEach(r => {
        DB.cb.push(r); const k=safe(r['è½‰æ›æ¨™çš„ä»£ç¢¼']); if(k){ if(!META.cbMap[k]) META.cbMap[k]=[]; META.cbMap[k].push(r); }
    });
    
    loadStep('è§£æMemo...', FILES.MEMO, 70);
    wb = await fetchXlsx(FILES.MEMO);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¡¨']||[]).forEach(r => {
            DB.memo.push(r); const k=safe(r['è‚¡è™Ÿ']); if(k){ if(!META.relatedMemo[k]) META.relatedMemo[k]=[]; META.relatedMemo[k].push(r); }
        });
        DB.memo.sort((a,b) => getDateVal(b['æ—¥æœŸ']) - getDateVal(a['æ—¥æœŸ']));
        XLSX.utils.sheet_to_json(wb.Sheets['è©³ç´°å…§å®¹åº«']||[]).forEach(r => META.memoDetail[safe(r['ç·¨è™Ÿ'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['å…¬å¸è¿½è¹¤è¡¨']||[]).forEach(r=>META.tracking[safe(r['å…¬å¸'])]=r);
        XLSX.utils.sheet_to_json(wb.Sheets['è²¡å‹™æ•¸æ“šå½™ç¸½']||[]).forEach(r=>META.finance[safe(r['å…¬å¸'])]=r);
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢å“çµæ§‹åˆ†æ']||[]).forEach(r=>META.products[safe(r['å…¬å¸'])]=r);
    }
    
    loadStep('æ•´åˆå ±å‘Š...', FILES.REPORTS, 85);
    wb = await fetchXlsx(FILES.REPORTS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r=>DB.reports.push(r));
        DB.reports.sort((a,b) => getDateVal(b['å ±å‘Šæ—¥æœŸ']) - getDateVal(a['å ±å‘Šæ—¥æœŸ']));
        XLSX.utils.sheet_to_json(wb.Sheets['å€‹è‚¡è©•åƒ¹è¡¨']||[]).forEach(r=>{ let c=safe(r['è‚¡ç¥¨ä»£è™Ÿ']).split(' ')[0]; if(c) META.ratings[c]=r; });
        XLSX.utils.sheet_to_json(wb.Sheets['åˆ¸å•†è§€é»çµè«–']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            [1,2,3].forEach(n => { const s=safe(r[`é¦–é¸å€‹è‚¡${n}`]); if(s){ if(!META.reportPicks[rid]) META.reportPicks[rid]=[]; META.reportPicks[rid].push({name:s, reason:safe(r[`é¦–é¸ç†ç”±${n}`])}); } });
        });
    }
    
    wb = await fetchXlsx(FILES.STRAT);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r=>DB.strategy.push(r));
        DB.strategy.sort((a,b) => getDateVal(b['å ±å‘Šæ—¥æœŸ']) - getDateVal(a['å ±å‘Šæ—¥æœŸ']));
        XLSX.utils.sheet_to_json(wb.Sheets['é¸è‚¡ç­–ç•¥']||[]).forEach(r => {
            const rid=safe(r['å ±å‘Šç·¨è™Ÿ']), c=safe(r['è‚¡ç¥¨ä»£è™Ÿ']);
            if(rid&&c) { if(!META.reportPicks[rid]) META.reportPicks[rid]=[]; META.reportPicks[rid].push({code:c, name:safe(r['å…¬å¸åç¨±']), note:safe(r['å‚™è¨»'])}); if(!META.stockInReports[c]) META.stockInReports[c]=[]; META.stockInReports[c].push(rid); }
        });
    }
    
    loadStep('å®Œæˆ', 'Ready', 100);
    updateCounts();
    renderList();
    setTimeout(()=>$('loader').classList.add('hidden'), 500);
}

function setDB(db) { CURR_DB=db; document.querySelectorAll('.db-tab').forEach(t=>t.classList.remove('active')); event.currentTarget.classList.add('active'); renderList(); }
function updateCounts() { $('c-news').innerText=DB.news.length; $('c-memo').innerText=DB.memo.length; $('c-reports').innerText=DB.reports.length; $('c-strategy').innerText=DB.strategy.length; $('c-stocks').innerText=Object.keys(DB.stocks).length; $('c-cb').innerText=DB.cb.length; }

function renderList() {
    const q = $('search').value.toLowerCase().trim();
    let list = [];
    if(CURR_DB==='news') list=DB.news; else if(CURR_DB==='memo') list=DB.memo; else if(CURR_DB==='reports') list=DB.reports; else if(CURR_DB==='strategy') list=DB.strategy; else if(CURR_DB==='stocks') list=Object.values(DB.stocks); else if(CURR_DB==='cb') list=DB.cb;

    const filtered = list.filter(i => {
        if(CURR_DB==='memo'&&i['ç·¨è™Ÿ']) { const d=META.memoDetail[i['ç·¨è™Ÿ']]; if(d&&JSON.stringify(d).toLowerCase().includes(q)) return true; }
        return JSON.stringify(i).toLowerCase().includes(q);
    });
    $('resCount').innerText = filtered.length;

    const hl = (text) => {
        if(!q || q.length === 0) return text;
        const safeQ = q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
        const re = new RegExp(`(${safeQ})`, 'gi');
        return text.replace(re, '<span class="highlight">$1</span>');
    };

    let html = '';
    filtered.slice(0,100).forEach(i => {
        let title='', sub='', date='', code='', tagClass='brk', body='', click='';
        if(CURR_DB==='stocks') { title=i['å…¬å¸åç¨±']; code=i['ä»£è™Ÿ']; sub=i['ç”¢æ¥­åˆ†é¡']; body=i['æ¥­å‹™æ‘˜è¦']; click=`openStock('${code}')`; }
        else if(CURR_DB==='cb') { title=i['åç¨±']; code=i['è½‰æ›æ¨™çš„ä»£ç¢¼']; sub=`è½‰åƒ¹:${i['è½‰æ›åƒ¹æ ¼(å…ƒ)']}`; body=`é¤˜é¡:${i['æœ€æ–°é¤˜é¡(ç™¾è¬)']}M | åˆ°æœŸ:${fmtDate(i['åˆ°æœŸæ—¥'])}`; click=`openStock('${code}')`; }
        else if(CURR_DB==='news') { title=i['å…¬å¸']; code=i['è‚¡è™Ÿ']; sub=i['å ±å°é‡é»åˆ†é¡']; date=i['æ—¥æœŸ']; tagClass='ind'; body=fmtTxt(i['å®Œæ•´å ±å°å…§å®¹']); click=`openStock('${code}')`; }
        else if(CURR_DB==='memo') { 
            title=i['å…¬å¸']; code=i['è‚¡è™Ÿ']; sub=i['å ±å‘Šé¡å‹']; date=i['æ—¥æœŸ']; 
            const d=META.memoDetail[i['ç·¨è™Ÿ']]; body=d?(d['ç‡Ÿé‹é‡é»']||d['Rexè§€å¯Ÿ']):'é»æ“ŠæŸ¥çœ‹è©³æƒ…';
            if(d&&d['æ¨™ç±¤']) { const t=d['æ¨™ç±¤'].split(' ').map(t=>t.startsWith('#')?t:'#'+t).map(t=>`<span class="tag-link" onclick="setSearch('${t}'); event.stopPropagation();" style="font-size:11px;color:#2980b9;">${t}</span>`).join(' '); body+=`<div style="margin-top:5px;border-top:1px dashed #eee;padding-top:4px">${t}</div>`; }
            click=`openStock('${code}')`; 
        }
        else if(CURR_DB==='reports'||CURR_DB==='strategy') {
            title=i['å ±å‘Šæ¨™é¡Œ']; sub=i['åˆ¸å•†åç¨±']; date=i['å ±å‘Šæ—¥æœŸ']; body=i['å‰¯æ¨™é¡Œ']||i['å¤§ç›¤è§€é»']||'æŸ¥çœ‹è©³æƒ…'; click=`openReport('${i['å ±å‘Šç·¨è™Ÿ']}', '${CURR_DB}')`;
        }

        html += `<div class="card" onclick="${click}">
            <div class="card-head"><div class="card-title">${hl(title)} ${code?`<span class="stock-code">${hl(code)}</span>`:''}</div></div>
            <div class="card-meta"><span class="tag ${tagClass} clickable-area" onclick="setSearch('${sub}'); event.stopPropagation();">${hl(sub)||'ä¸€èˆ¬'}</span>${date?`<span class="tag dt">${fmtDate(date)}</span>`:''}</div>
            <div class="card-body" style="overflow:visible;max-height:none;display:block;">${CURR_DB==='news'?body:(body.length>100&&!body.includes('tag-link')?body.substring(0,100)+'...':body)}</div>
        </div>`;
    });
    $('list').innerHTML = html || '<div style="text-align:center;padding:20px;color:#999">ç„¡ç›¸ç¬¦è³‡æ–™</div>';
}

window.openStock = (code) => {
    if(!code || code==='-') return;
    const s = DB.stocks[code] || { 'å…¬å¸åç¨±': code, 'ä»£è™Ÿ': code, 'ç”¢æ¥­åˆ†é¡':'æœªçŸ¥', 'æ¥­å‹™æ‘˜è¦':'' };
    const name = s['å…¬å¸åç¨±'];
    
    const cbs = META.cbMap[code], rev = META.revenue[code], memos = META.relatedMemo[code]||[], news = META.relatedNews[code]||[], fin = META.finance[name]||{}, prod = META.products[name]||{}, track = META.tracking[name]||{}, rate = META.ratings[code]||{}, concepts = META.concepts[code]||[];
    const revM = META.revData.month[code] || [];
    const revQ = META.revData.quarter[code] || [];
    const revY = META.revData.year[code] || [];
    const revH = META.revData.highlights[code] || {};

    const conceptHtml = concepts.map(c => `<span class="tag concept clickable-area" onclick="setSearch('${c}')">#${c}</span>`).join(' ');

    $('m-info').innerHTML = `
        <div class="info-card">
            <div style="font-size:20px;font-weight:800;margin-bottom:5px;color:#2c3e50;">${name} (${code})</div>
            <div class="card-meta"><span class="tag ind clickable-area" onclick="setSearch('${s['ç”¢æ¥­åˆ†é¡']}')">${s['ç”¢æ¥­åˆ†é¡']}</span>${conceptHtml}</div>
            <div style="font-size:14px;color:#666;margin-top:10px;line-height:1.5">${s['æ¥­å‹™æ‘˜è¦']}</div>
        </div>`;

    // 1. Basic
    let tBasic = `<div class="info-row"><span class="info-label">æ”¶ç›¤åƒ¹</span><span class="info-val" style="color:var(--primary)">${s['æˆäº¤']||'-'}</span></div>
                  <div class="info-row"><span class="info-label">æ¼²è·Œå¹…</span><span class="info-val">${s['æ¼²è·Œå¹…']||'-'}%</span></div>`;
    const relatedReports = META.stockInReports[code];
    if(relatedReports && relatedReports.length > 0) {
        tBasic += `<div class="section-head">ğŸ¯ æ”¶éŒ„æ–¼ç­–ç•¥å ±å‘Š</div><div class="rep-stock-grid">` + relatedReports.map(rid => {
            const r = DB.strategy.find(i=>i['å ±å‘Šç·¨è™Ÿ']===rid);
            return r ? `<div class="rep-stock-btn" onclick="openReport('${rid}', 'strategy')"><div style="font-size:12px;font-weight:700">${r['åˆ¸å•†åç¨±']}</div><div style="font-size:10px;color:#666">${fmtDate(r['å ±å‘Šæ—¥æœŸ'])}</div></div>` : '';
        }).join('') + `</div>`;
    }
    if(cbs) tBasic += `<div class="section-head">ğŸ« å¯è½‰å‚µ (CB)</div>` + cbs.map(c=>`<div class="hl-block hl-orange"><b>${c['åç¨±']}</b><br>è½‰åƒ¹:${c['è½‰æ›åƒ¹æ ¼(å…ƒ)']} | é¤˜é¡:${c['æœ€æ–°é¤˜é¡(ç™¾è¬)']}M</div>`).join('');

    // 2. Finance (Interactive Table)
    let tFin = `<div class="grid-stats">
        <div class="stat-box"><div class="stat-label">3Q25ç‡Ÿæ”¶</div><div class="stat-val">${fin['3Q25ç‡Ÿæ”¶']||'-'}</div></div>
        <div class="stat-box"><div class="stat-label">æ¯›åˆ©ç‡</div><div class="stat-val">${fin['æ¯›åˆ©ç‡']||'-'}</div></div>
        <div class="stat-box"><div class="stat-label">EPS</div><div class="stat-val">${fin['EPS']||'-'}</div></div>
    </div>
    
    <div class="fin-tab-group">
        <div class="fin-tab-btn active" onclick="swFinTab('month',this)">æœˆç‡Ÿæ”¶</div>
        <div class="fin-tab-btn" onclick="swFinTab('quarter',this)">å­£ç‡Ÿæ”¶</div>
        <div class="fin-tab-btn" onclick="swFinTab('year',this)">å¹´ç‡Ÿæ”¶</div>
    </div>

    <div id="fin-month" class="fin-sub-pane active">
        <div class="data-table-wrap">
            <table class="data-table">
                <thead><tr><th>æœˆä»½</th><th>ç‡Ÿæ”¶(å„„)</th><th>æœˆå¢%</th><th>å¹´å¢%</th><th>ç´¯è¨ˆå¹´å¢%</th></tr></thead>
                <tbody>
                    ${revM.map(r=>`<tr><td>${r.d}</td><td>${fmtNum(r.rev)}</td><td class="${colorClass(r.mom)}">${fmtNum(r.mom,true)}</td><td class="${colorClass(r.yoy)}">${fmtNum(r.yoy,true)}</td><td class="${colorClass(r.accYoY)}">${fmtNum(r.accYoY,true)}</td></tr>`).join('')}
                </tbody>
            </table>
        </div>
    </div>
    <div id="fin-quarter" class="fin-sub-pane">
        <div class="data-table-wrap">
            <table class="data-table">
                <thead><tr><th>å­£åº¦</th><th>ç‡Ÿæ”¶(å„„)</th><th>å­£å¢%</th><th>å¹´å¢%</th></tr></thead>
                <tbody>
                    ${revQ.map(r=>`<tr><td>${r.d}</td><td>${fmtNum(r.rev)}</td><td class="${colorClass(r.qoq)}">${fmtNum(r.qoq,true)}</td><td class="${colorClass(r.yoy)}">${fmtNum(r.yoy,true)}</td></tr>`).join('')}
                </tbody>
            </table>
        </div>
    </div>
    <div id="fin-year" class="fin-sub-pane">
        <div class="data-table-wrap">
            <table class="data-table">
                <thead><tr><th>å¹´åº¦</th><th>ç‡Ÿæ”¶(å„„)</th><th>å¹´å¢%</th></tr></thead>
                <tbody>
                    ${revY.map(r=>`<tr><td>${r.d}</td><td>${fmtNum(r.rev)}</td><td class="${colorClass(r.yoy)}">${fmtNum(r.yoy,true)}</td></tr>`).join('')}
                </tbody>
            </table>
        </div>
    </div>
    `;
    if(fin['4Q25æŒ‡å¼•']) tFin += `<div class="hl-block hl-blue" style="margin-top:15px"><b>ğŸ”® æœªä¾†æŒ‡å¼•</b><br>${fmtTxt(fin['4Q25æŒ‡å¼•'])}</div>`;

    // 3. Product
    let tProd = '';
    if(prod['ä¸»è¦ç”¢å“1']) tProd += `<div class="section-head">ç”¢å“çµ„åˆ</div>` + [1,2,3].map(n=>prod[`ä¸»è¦ç”¢å“${n}`]?`<div class="list-item"><div class="list-title">${prod[`ä¸»è¦ç”¢å“${n}`]}</div><div class="list-sub">${prod[`ä½”æ¯”/è¡¨ç¾${n}`]||''}</div></div>`:'').join('');
    if(prod['é—œéµæˆé•·å‹•èƒ½']) tProd += `<div class="hl-block hl-green"><b>ğŸš€ æˆé•·å‹•èƒ½</b><br>${fmtTxt(prod['é—œéµæˆé•·å‹•èƒ½'])}</div>`;

    // 4. Reports
    let tRep = '', timelineEvents = [];
    if(memos.length) tRep += `<div class="section-head">åˆ¸å•†è¨ªè«‡å ±å‘Š (${memos.length})</div>` + memos.map(m=> {
        const d = META.memoDetail[safe(m['ç·¨è™Ÿ'])];
        if(d&&d['é—œéµæ™‚ç¨‹']) timelineEvents.push({date:m['æ—¥æœŸ'], event:d['é—œéµæ™‚ç¨‹']});
        return `<div class="list-item">
            <div class="list-title">${m['åˆ¸å•†']} - ${m['å ±å‘Šé¡å‹']}</div>
            <div class="list-sub">${fmtDate(m['æ—¥æœŸ'])} | é‡è¦æ€§:${m['é‡è¦æ€§']}</div>
            ${d ? `<div class="memo-content">${d['ç‡Ÿé‹é‡é»']?`<div><span class="memo-tag">ç‡Ÿé‹é‡é»</span>${fmtTxt(d['ç‡Ÿé‹é‡é»'])}</div>`:''}${d['Rexè§€å¯Ÿ']?`<div style="margin-top:8px"><span class="memo-tag" style="background:#e3f2fd;color:#1565c0">Rexè§€å¯Ÿ</span>${fmtTxt(d['Rexè§€å¯Ÿ'])}</div>`:''}</div>`:''}</div>`;
    }).join('');
    if(news.length) tRep += `<div class="section-head">å¤–é›»å ±å° (${news.length})</div>` + news.map(n=>`<div class="list-item"><div class="list-title">${n['å ±å°é‡é»åˆ†é¡']}</div><div class="list-sub">${fmtDate(n['æ—¥æœŸ'])}</div><div class="memo-content">${fmtTxt(n['å®Œæ•´å ±å°å…§å®¹'])}</div></div>`).join('');

    // 5. Timeline
    let tTime = timelineEvents.length ? timelineEvents.map(e=>`<div class="hl-block hl-blue"><b>ğŸ“… ${fmtDate(e.date)}</b><br>${fmtTxt(e.event)}</div>`).join('') : '<div style="padding:20px;text-align:center;color:#999">ç„¡æ™‚ç¨‹è³‡æ–™</div>';

    // 6. Ratings
    let tRate = '';
    if(track['æŠ•è³‡è©•ç­‰']) tRate += `<div class="section-head">è¿½è¹¤ç‹€æ…‹</div><div class="info-row"><span class="info-label">è©•ç­‰</span><span class="info-val">${track['æŠ•è³‡è©•ç­‰']}</span></div><div class="info-row"><span class="info-label">ç›®æ¨™åƒ¹</span><span class="info-val" style="color:var(--primary)">${track['ç›®æ¨™åƒ¹']}</span></div>`;
    if(rate['è©•ç­‰']) tRate += `<div class="section-head">å€‹è‚¡å ±å‘Šè©•åƒ¹</div><div class="grid-stats"><div class="stat-box"><div class="stat-label">FY25 EPS</div><div class="stat-val">${rate['EPS_FY25F']||'-'}</div></div><div class="stat-box"><div class="stat-label">ç›®æ¨™åƒ¹</div><div class="stat-val" style="color:#c0392b">${rate['ç›®æ¨™åƒ¹']||'-'}</div></div></div><div class="hl-block hl-green"><b>ğŸ’¡ æŠ•è³‡äº®é»</b><br>${rate['æŠ•è³‡äº®é»']||'ç„¡'}</div>`;

    $('m-body').innerHTML = `
        <div id="tab-basic" class="tab-pane active">${tBasic}</div>
        <div id="tab-fin" class="tab-pane">${tFin}</div>
        <div id="tab-prod" class="tab-pane">${tProd||'<div style="color:#999;text-align:center;padding:20px">ç„¡ç”¢å“è³‡æ–™</div>'}</div>
        <div id="tab-rep" class="tab-pane">${tRep||'<div style="color:#999;text-align:center;padding:20px">ç„¡å ±å‘Š</div>'}</div>
        <div id="tab-time" class="tab-pane">${tTime}</div>
        <div id="tab-rate" class="tab-pane">${tRate||'<div style="color:#999;text-align:center;padding:20px">ç„¡è©•ç­‰</div>'}</div>
    `;

    $('stock-nav').style.display='grid';
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector('.b-basic').classList.add('active');
    switchPage('view-detail');
};

window.openReport = (rid, type) => {
    let report = (type === 'strategy' ? DB.strategy : DB.reports).find(r => r['å ±å‘Šç·¨è™Ÿ'] === rid);
    if (!report) return;
    const picks = META.reportPicks[rid] || [];

    $('stock-nav').style.display='none'; 
    $('m-info').innerHTML = `
        <div class="info-card">
            <div style="font-size:20px;font-weight:800;color:var(--primary);margin-bottom:5px">${report['å ±å‘Šæ¨™é¡Œ']}</div>
            <div style="font-size:13px;color:#666;">${report['åˆ¸å•†åç¨±']} | ${fmtDate(report['å ±å‘Šæ—¥æœŸ'])}</div>
        </div>`;

    let html = `<div class="hl-block" style="margin-top:15px;"><b>ğŸ’¡ æ ¸å¿ƒè§€é»</b><br>${fmtTxt(report['å‰¯æ¨™é¡Œ'] || report['å¤§ç›¤è§€é»'] || 'ç„¡è©³ç´°æ‘˜è¦')}</div>`;
    
    if (picks.length > 0) {
        html += `<div class="section-head">ç›¸é—œç²¾é¸å€‹è‚¡</div><div class="rep-stock-grid">` + picks.map(p => {
            let code = p.code || (Object.values(DB.stocks).find(s=>s['å…¬å¸åç¨±']===p.name)?.['ä»£è™Ÿ']);
            return `<div class="rep-stock-btn" ${code?`onclick="openStock('${code}')"`:''}>
                <div style="font-weight:700">${p.name}</div>${code?`<div style="font-size:11px;color:#999">${code}</div>`:''}${p.reason?`<div style="font-size:10px;color:#666;margin-top:2px">${p.reason}</div>`:''}
            </div>`;
        }).join('') + `</div>`;
    }
    if(report['ç¸½ç¶“è§€é»æ‘˜è¦']) html += `<div class="section-head">ç¸½ç¶“è§€é»</div><div style="font-size:13px;color:#444;line-height:1.6;background:#fff;padding:15px;border-radius:8px;border:1px solid #eee;">${fmtTxt(report['ç¸½ç¶“è§€é»æ‘˜è¦'])}</div>`;
    
    $('m-body').innerHTML = html;
    switchPage('view-detail');
};

window.swTab = (id, el) => {
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
    $('tab-'+id).classList.add('active');
};

window.swFinTab = (id, el) => {
    document.querySelectorAll('.fin-tab-btn').forEach(b=>b.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('.fin-sub-pane').forEach(p=>p.classList.remove('active'));
    $(`fin-${id}`).classList.add('active');
};

window.onload = init;
</script>
</body>
</html>
