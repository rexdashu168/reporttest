<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤ - çµ‚æ¥µæˆ°æƒ…ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* === æ ¸å¿ƒåŸºç¤æ¨£å¼ === */
        :root { --primary: #c96442; --secondary: #2d3436; --bg: #f5f4ef; --white: #ffffff; --accent: #d4a574; --success: #27ae60; --danger: #e74c3c; --link: #3498db; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif; background: var(--bg); min-height: 100vh; color: var(--secondary); font-size: 14px; line-height: 1.5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        
        /* === Header === */
        .header { text-align: center; padding: 25px 0 20px; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px; background: #fff; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .header h1 { font-size: 24px; color: var(--primary); margin-bottom: 6px; letter-spacing: 1px; }
        .header .subtitle { color: #888; font-size: 13px; }
        
        /* === è³‡æ–™åº«åˆ‡æ› Tab === */
        .db-switcher { display: flex; justify-content: center; gap: 8px; margin: 20px 0; flex-wrap: wrap; }
        .db-tab { padding: 8px 16px; border: 1px solid #ddd; background: #fff; border-radius: 20px; font-size: 13px; font-weight: 600; color: #666; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .db-tab:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }
        .db-tab.active { background: var(--primary); border-color: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(201,100,66,0.3); }
        .db-tab .count { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 8px; font-size: 11px; margin-left: 4px; }
        .db-tab.active .count { background: rgba(255,255,255,0.3); }
        
        /* === æœå°‹å€å¡Š === */
        .search-section { background: #fff; border-radius: 16px; padding: 16px; margin-bottom: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.04); }
        .main-search { position: relative; margin-bottom: 12px; }
        .main-search::before { content: "ğŸ”"; position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 16px; color: #999; }
        #mainSearchInput { width: 100%; padding: 14px 14px 14px 48px; border: 2px solid #eee; border-radius: 30px; background: #fafaf8; font-size: 15px; transition: all 0.3s; }
        #mainSearchInput:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px rgba(201,100,66,0.1); }
        
        /* æ™ºæ…§æœå°‹å»ºè­° */
        .search-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #eee; border-radius: 12px; margin-top: 6px; max-height: 400px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 8px 30px rgba(0,0,0,0.12); }
        .search-suggestions.active { display: block; }
        .suggestion-group { padding: 8px 0; border-bottom: 1px solid #f5f5f5; }
        .suggestion-group-title { padding: 4px 16px; font-size: 11px; color: #999; font-weight: 700; letter-spacing: 0.5px; }
        .suggestion-item { padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s; }
        .suggestion-item:hover { background: #f9f9f9; }
        .suggestion-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; background: #eee; }
        
        /* ç¯©é¸èˆ‡æ¨™ç±¤ */
        .filter-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
        .filter-select select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; background: #fff; font-size: 13px; color: #555; cursor: pointer; }
        .hot-tags-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .hot-tag { padding: 4px 10px; background: #fff3e6; color: var(--primary); border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .hot-tag:hover { border-color: var(--primary); background: #fff; }
        
        /* === åˆ—è¡¨å¡ç‰‡ === */
        .reports-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px; }
        .card-base { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .card-base:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.06); border-color: var(--primary); }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .company-name { font-size: 16px; font-weight: 700; color: #333; }
        .company-name:hover { color: var(--primary); text-decoration: underline; }
        .stock-code { font-size: 12px; color: #666; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
        
        .card-meta { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .meta-tag { font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 500; }
        .meta-tag.broker { background: #e8f4fd; color: #2980b9; }
        .meta-tag.industry { background: #fdf2e9; color: #d35400; }
        .meta-tag.date { background: #f5f5f5; color: #666; }
        .meta-tag.cb { background: #fce4ec; color: #c2185b; border: 1px solid #f8bbd0; } /* CB æ¨™ç±¤æ¨£å¼ */
        
        .card-content { font-size: 13px; color: #555; margin-bottom: 12px; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; flex-grow: 1; }
        
        .card-footer { margin-top: auto; padding-top: 10px; border-top: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #888; }
        .price-info { font-weight: 600; color: #333; }
        .price-up { color: var(--success); }
        .price-down { color: var(--danger); }
        
        /* === Modal å½ˆçª— (æˆ°æƒ…å®¤é¢¨æ ¼) === */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; backdrop-filter: blur(3px); }
        .modal-overlay.active { display: flex; justify-content: center; align-items: center; }
        .modal-content { width: 95%; max-width: 1000px; height: 90vh; background: #fff; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: modalIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .modal-header { padding: 16px 20px; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-controls { display: flex; gap: 10px; align-items: center; }
        .modal-back-btn { padding: 6px 12px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .modal-back-btn:hover { background: #e0e0e0; }
        .modal-close { width: 32px; height: 32px; border: none; background: #f5f5f5; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .modal-close:hover { background: var(--danger); color: #fff; }
        
        .modal-body { flex-grow: 1; overflow-y: auto; padding: 20px; background: #fafaf8; }
        
        /* Modal Tabs */
        .modal-tabs { display: flex; gap: 5px; padding: 10px 20px; background: #fff; border-bottom: 1px solid #eee; overflow-x: auto; flex-shrink: 0; }
        .modal-tab { padding: 8px 16px; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; color: #666; white-space: nowrap; transition: 0.2s; }
        .modal-tab:hover { background: #f5f5f5; color: var(--primary); }
        .modal-tab.active { background: var(--primary); color: #fff; }
        .tab-pane { display: none; animation: fadeIn 0.3s; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* å…§å®¹å€å¡Šæ¨£å¼ */
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .info-card { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); border: 1px solid #eee; }
        .info-label { font-size: 12px; color: #888; margin-bottom: 4px; }
        .info-value { font-size: 15px; font-weight: 700; color: #333; }
        
        .section-box { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .section-title { font-size: 15px; font-weight: 700; color: var(--primary); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #f5f4ef; display: flex; align-items: center; gap: 8px; }
        
        /* è²¡å‹™èˆ‡CBè¡¨æ ¼ */
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th { text-align: left; padding: 10px; background: #f8f9fa; color: #666; font-weight: 600; border-bottom: 2px solid #eee; white-space: nowrap; }
        .data-table td { padding: 10px; border-bottom: 1px solid #eee; color: #333; }
        .data-table tr:hover td { background: #fdfbf7; }
        .val-pos { color: var(--success); font-weight: 600; }
        .val-neg { color: var(--danger); font-weight: 600; }
        
        /* Loading */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f5f4ef; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .loading-bar-container { width: 200px; height: 4px; background: #ddd; border-radius: 2px; overflow: hidden; margin-top: 15px; }
        .loading-bar { height: 100%; width: 0%; background: var(--primary); transition: width 0.3s; }
        
        .error-msg { padding: 20px; background: #fff5f5; border: 1px solid #feb2b2; border-radius: 8px; color: #c53030; text-align: center; margin: 20px; }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <div style="font-size:40px;margin-bottom:10px;">ğŸ“Š</div>
    <h3 id="loadingText">ç³»çµ±å•Ÿå‹•ä¸­...</h3>
    <div style="font-size:12px;color:#888;margin-top:5px;" id="loadingDetail">æ­£åœ¨è¼‰å…¥è³‡æ–™åº«</div>
    <div class="loading-bar-container"><div class="loading-bar" id="loadingBar"></div></div>
</div>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
        <p class="subtitle">å…¨æ–¹ä½æŠ•è³‡æˆ°æƒ…å®¤ï¼šç‡Ÿæ”¶ Ã— å ±å‘Š Ã— CBå¯è½‰å‚µ Ã— ç”¢æ¥­è¶¨å‹¢</p>
    </div>

    <div class="db-switcher">
        <div class="db-tab active" onclick="switchDB('stock')" data-db="stock">ğŸ¢ å€‹è‚¡ç¸½è¦½<span class="count" id="cnt-stock">0</span></div>
        <div class="db-tab" onclick="switchDB('cb')" data-db="cb">ğŸ« CBæˆ°æƒ…<span class="count" id="cnt-cb">0</span></div>
        <div class="db-tab" onclick="switchDB('news')" data-db="news">âš¡ å¤–é›»å¿«å ±<span class="count" id="cnt-news">0</span></div>
        <div class="db-tab" onclick="switchDB('report')" data-db="report">ğŸ“‘ ç”¢æ¥­å ±å‘Š<span class="count" id="cnt-report">0</span></div>
        <div class="db-tab" onclick="switchDB('strategy')" data-db="strategy">ğŸ¯ æŠ•è³‡ç­–ç•¥<span class="count" id="cnt-strategy">0</span></div>
    </div>

    <div class="search-section">
        <div class="main-search">
            <input type="text" id="searchInput" placeholder="è¼¸å…¥ä»£è™Ÿã€å…¬å¸åã€CBåç¨±æˆ–é—œéµå­— (ä¾‹å¦‚: 2330, æ©Ÿå™¨äºº, ä¸–ç´€é‹¼å…«æ°¸)...">
            <div class="search-suggestions" id="searchSuggestions"></div>
        </div>
        <div class="hot-tags-list" id="hotTags"></div>
        <div class="filter-row" id="filterRow">
            </div>
    </div>

    <div class="reports-list" id="mainList"></div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-controls">
                <button class="modal-back-btn" id="modalBackBtn" onclick="modalGoBack()" style="display:none;">â¬…ï¸ è¿”å›</button>
                <div id="modalTitleArea"></div>
            </div>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-tabs" id="modalTabs"></div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<script>
// === å…¨åŸŸè®Šæ•¸èˆ‡è³‡æ–™åº« ===
const FILES = {
    news: '01_news.xlsx',
    memo: '02_memo.xlsx',
    report: '03_ç”¢æ¥­å±•æœ›å ±å‘Š.xlsx',
    master: '04_master.xlsx',
    strategy: '05_Strategy_çµ±ä¸€æŠ•é¡§.xlsx',
    cb: '00_CB.xlsx',
    revenue: '06_revenue.xlsx'
};

// è³‡æ–™å®¹å™¨
let DB = {
    stocks: {},     // æ ¸å¿ƒï¼šè‚¡ç¥¨ä»£è™Ÿ -> åŸºæœ¬è³‡æ–™
    revenue: {},    // ç‡Ÿæ”¶è³‡æ–™
    cb: {},         // CBè³‡æ–™ (By Stock Code)
    cbList: [],     // CBåˆ—è¡¨ (Flat List)
    cbas: {},       // CBASå ±åƒ¹
    news: [],       // æ–°è
    reports: [],    // å ±å‘Š
    strategy: [],   // ç­–ç•¥
    concepts: {}    // æ¦‚å¿µè‚¡
};

// ç‹€æ…‹ç®¡ç†
let state = {
    currentDB: 'stock',
    history: [], // Modal æ­·å²å †ç–Š
    search: '',
    filters: {}
};

// === æ ¸å¿ƒå·¥å…·å‡½æ•¸ ===
const $ = id => document.getElementById(id);
const formatNum = (n) => n ? parseFloat(n).toLocaleString() : '-';
const formatPct = (n) => {
    if(n === undefined || n === null || n === '') return '-';
    let val = parseFloat(n);
    let color = val > 0 ? 'var(--success)' : (val < 0 ? 'var(--danger)' : '#666');
    return `<span style="color:${color}">${val.toFixed(2)}%</span>`;
};
const safeStr = (s) => (s || '').toString().trim();

// === è³‡æ–™è¼‰å…¥æ ¸å¿ƒ (ä¿®æ­£ 06_revenue è®€å–é‚è¼¯) ===
async function loadData() {
    const updateProgress = (txt, pct) => {
        $('loadingText').innerText = txt;
        $('loadingBar').style.width = pct + '%';
    };

    try {
        // 1. è¼‰å…¥ä¸»æª” (å»ºç«‹è‚¡ç¥¨æ¸…å–®)
        updateProgress('å»ºç«‹è‚¡ç¥¨ä¸»æª”...', 10);
        let buf = await fetch(FILES.master).then(r => r.arrayBuffer());
        let wb = XLSX.read(buf, {type:'array'});
        let ws = wb.Sheets['ä¸»è³‡æ–™åº«'];
        XLSX.utils.sheet_to_json(ws).forEach(r => {
            let code = safeStr(r['ä»£è™Ÿ']);
            if(code) {
                DB.stocks[code] = {
                    code: code,
                    name: safeStr(r['å…¬å¸åç¨±']),
                    industry: safeStr(r['ç”¢æ¥­åˆ†é¡']),
                    market: safeStr(r['å¸‚å ´åˆ†é¡']),
                    price: r['æˆäº¤'],
                    cap: r['å¸‚å€¼(å„„)'],
                    business: safeStr(r['æ¥­å‹™æ‘˜è¦']),
                    tags: []
                };
            }
        });

        // 2. è¼‰å…¥ç‡Ÿæ”¶ (é—œéµä¿®å¾©ï¼šå‹•æ…‹æ¬„ä½è®€å–)
        updateProgress('è§£æè²¡å‹™ç‡Ÿæ”¶æ•¸æ“š...', 30);
        buf = await fetch(FILES.revenue).then(r => r.arrayBuffer());
        wb = XLSX.read(buf, {type:'array'});
        
        // è™•ç†æœˆç‡Ÿæ”¶ (è‡ªå‹•æŠ“å–æ—¥æœŸæ¬„ä½)
        const processRevenueSheet = (sheetName, type) => {
            let sheet = wb.Sheets[sheetName];
            if(!sheet) return;
            let data = XLSX.utils.sheet_to_json(sheet);
            if(data.length > 0) {
                // æ‰¾å‡ºæ‰€æœ‰ç›¸é—œæ¬„ä½ä¸¦æ’åº
                let keys = Object.keys(data[0]);
                let targetCols = keys.filter(k => k.includes(type) && !k.includes('æ’å') && !k.includes('æˆé•·') && !k.includes('å‚™è¨»'));
                // ç°¡å–®æ’åº: 23M09 < 23M10 (å­—ä¸²æ’åºå°é€™ç¨®æ ¼å¼æœ‰æ•ˆ)
                targetCols.sort(); 
                
                data.forEach(r => {
                    let code = safeStr(r['ä»£è™Ÿ']);
                    if(!DB.revenue[code]) DB.revenue[code] = {};
                    if(!DB.revenue[code][type]) DB.revenue[code][type] = [];
                    
                    // å–æœ€è¿‘ 12 æœŸ
                    let recentCols = targetCols.slice(-12);
                    recentCols.forEach(col => {
                        // æå–æ—¥æœŸæ¨™ç±¤ (ç§»é™¤ "å–®æœˆç‡Ÿæ”¶(å„„)" ç­‰å­—çœ¼)
                        let period = col.replace(type, '').replace('(å„„)', '').replace('å–®å­£ç‡Ÿæ”¶', '').replace('å¹´åº¦ç‡Ÿæ”¶', '');
                        DB.revenue[code][type].push({
                            period: period,
                            value: r[col]
                        });
                    });
                });
            }
        };

        processRevenueSheet('000_æœˆç‡Ÿæ”¶', 'å–®æœˆç‡Ÿæ”¶');
        processRevenueSheet('000_å­£ç‡Ÿæ”¶', 'å–®å­£ç‡Ÿæ”¶'); // ä¿®æ”¹ï¼šå°æ‡‰ Excel æ¨™é ­
        processRevenueSheet('000_å¹´ç‡Ÿæ”¶', 'å¹´åº¦ç‡Ÿæ”¶');
        
        // è®€å–è²¡å ±å‚™è¨» (ç‡Ÿæ”¶äº®é»)
        let wsNote = wb.Sheets['10_è²¡å ±å‚™è¨»'];
        if(wsNote) {
            XLSX.utils.sheet_to_json(wsNote).forEach(r => {
                let code = safeStr(r['ä»£è™Ÿ']);
                if(code) {
                    if(!DB.revenue[code]) DB.revenue[code] = {};
                    DB.revenue[code].highlights = {
                        monthRecord: r['å–®æœˆç‡Ÿæ”¶å‰µç´€éŒ„æœˆæ•¸'],
                        monthStreak: r['å–®æœˆç‡Ÿæ”¶é€£å¢æ¸›æœˆæ•¸'],
                        yearRank: r['å–®æœˆç‡Ÿæ”¶æ­·å¹´æ’å'],
                        qtrStreak: r['å–®å­£ç‡Ÿæ”¶é€£çºŒå¢æ¸›å­£æ•¸']
                    };
                }
            });
        }

        // 3. è¼‰å…¥ CB è³‡æ–™ (æ·±åº¦æ•´åˆ)
        updateProgress('æ•´åˆ CB å¯è½‰å‚µæˆ°æƒ…...', 50);
        buf = await fetch(FILES.cb).then(r => r.arrayBuffer());
        wb = XLSX.read(buf, {type:'array'});
        
        // è®€å– CB åŸºæœ¬è³‡æ–™
        let wsCB = wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™']; // æœ€å®Œæ•´çš„è¡¨
        if(wsCB) {
            XLSX.utils.sheet_to_json(wsCB).forEach(r => {
                let stockCode = safeStr(r['è½‰æ›æ¨™çš„ä»£ç¢¼']);
                let cbCode = safeStr(r['ä»£è™Ÿ']);
                let cbName = safeStr(r['åç¨±']);
                
                let cbObj = {
                    code: cbCode,
                    name: cbName,
                    stockCode: stockCode,
                    stockName: safeStr(r['è½‰æ›æ¨™çš„åç¨±']),
                    price: 0, // ç¨å¾Œè£œ
                    convPrice: parseFloat(r['è½‰æ›åƒ¹æ ¼(å…ƒ)']),
                    balance: parseFloat(r['æœ€æ–°é¤˜é¡(ç™¾è¬)']),
                    issueDate: safeStr(r['ç™¼è¡Œæ—¥æœŸ']),
                    maturityDate: safeStr(r['åˆ°æœŸæ—¥']),
                    remainPct: (parseFloat(r['æœ€æ–°é¤˜é¡(ç™¾è¬)']) / parseFloat(r['å¯¦éš›ç™¼è¡Œç¸½é¡(ç™¾è¬)'])) * 100
                };
                
                // å­˜å…¥æ¸…å–®
                DB.cbList.push(cbObj);
                // æ­¸æˆ¶åˆ°è‚¡ç¥¨
                if(!DB.cb[stockCode]) DB.cb[stockCode] = [];
                DB.cb[stockCode].push(cbObj);
                
                // æ¨™è¨»è‚¡ç¥¨æœ‰ CB
                if(DB.stocks[stockCode]) DB.stocks[stockCode].hasCB = true;
            });
        }
        
        // è®€å– CBAS å ±åƒ¹ (Premium Feature)
        let wsCBAS = wb.Sheets['11_æœ€æ–°å‹•æ…‹CBASå ±åƒ¹è¡¨'];
        if(wsCBAS) {
            XLSX.utils.sheet_to_json(wsCBAS).forEach(r => {
                let cbCode = safeStr(r['å¯è½‰å‚µä»£ç¢¼']);
                // å°‹æ‰¾å°æ‡‰çš„ CB ç‰©ä»¶æ›´æ–°
                let target = DB.cbList.find(c => c.code === cbCode);
                if(target) {
                    target.cbasPrice = r['æ¬Šåˆ©é‡‘(ä½°å…ƒå ±åƒ¹)'];
                    target.leverage = r['æ§“æ¡¿å€æ•¸'] || (target.convPrice / (parseFloat(target.cbasPrice) || 1)); // ä¼°ç®—
                    target.price = parseFloat(r['CBåƒè€ƒåƒ¹']) || 0;
                    target.premium = parseFloat(r['æº¢(æŠ˜)åƒ¹%']);
                    target.volatility = r['è‚¡åƒ¹æ³¢å‹•ç‡120å¤©%'];
                }
            });
        }

        // 4. è¼‰å…¥å¤–é›»èˆ‡å ±å‘Š (ç°¡åŒ–æµç¨‹)
        updateProgress('è¼‰å…¥ç ”å ±èˆ‡æ–°è...', 80);
        // ... (é€™éƒ¨åˆ†é‚è¼¯èˆ‡æ‚¨åŸæœ¬é¡ä¼¼ï¼Œç•¥ç‚ºåŠ é€Ÿè™•ç†) ...
        // (æ­¤è™•ä»£ç¢¼çœç•¥é‡è¤‡éƒ¨åˆ†ï¼Œç›´æ¥ä½¿ç”¨æ‚¨åŸæœ¬çš„é‚è¼¯è¼‰å…¥ News, Memo, Report)
        // ä½†ç‚ºäº†ç¯„ä¾‹å®Œæ•´ï¼Œæˆ‘æœƒæ”¾å…¥ News çš„è¼‰å…¥
        buf = await fetch(FILES.news).then(r => r.arrayBuffer());
        wb = XLSX.read(buf, {type:'array'});
        XLSX.utils.sheet_to_json(wb.Sheets['å¤–é›»ç¶œåˆå ±å°']).forEach(r => {
            DB.news.push({
                date: safeStr(r['æ—¥æœŸ']),
                title: safeStr(r['å…¬å¸']),
                content: safeStr(r['å®Œæ•´å ±å°å…§å®¹']),
                broker: safeStr(r['åˆ¸å•†ä¾†æº']),
                stockCode: safeStr(r['è‚¡è™Ÿ'])
            });
        });

        updateProgress('ç³»çµ±å°±ç·’', 100);
        setTimeout(() => {
            $('loadingOverlay').style.opacity = 0;
            setTimeout(() => $('loadingOverlay').style.display = 'none', 500);
            renderMainList();
            setupSearch();
        }, 500);

    } catch (e) {
        alert('è³‡æ–™è¼‰å…¥å¤±æ•—: ' + e.message);
        console.error(e);
    }
}

// === æ¸²æŸ“é‚è¼¯ ===

function renderMainList() {
    let container = $('mainList');
    container.innerHTML = '';
    
    // æ ¹æ“šç›®å‰çš„ Tab æ±ºå®šæ¸²æŸ“å…§å®¹
    let data = [];
    let renderer = null;

    if(state.currentDB === 'stock') {
        data = Object.values(DB.stocks);
        renderer = renderStockCard;
    } else if (state.currentDB === 'cb') {
        data = DB.cbList;
        renderer = renderCBCard;
    } else if (state.currentDB === 'news') {
        data = DB.news;
        renderer = renderNewsCard;
    }
    
    // æœå°‹éæ¿¾
    if(state.search) {
        let q = state.search.toLowerCase();
        data = data.filter(item => {
            let str = JSON.stringify(item).toLowerCase();
            return str.includes(q);
        });
    }

    // é™åˆ¶é¡¯ç¤ºæ•¸é‡å„ªåŒ–æ•ˆèƒ½
    $('cnt-' + state.currentDB).innerText = data.length;
    data.slice(0, 50).forEach(item => {
        container.appendChild(renderer(item));
    });
}

function renderStockCard(stock) {
    let div = document.createElement('div');
    div.className = 'card-base';
    div.onclick = () => openStockModal(stock.code);
    
    let cbTag = stock.hasCB ? `<span class="meta-tag cb">ğŸ« æœ‰CB</span>` : '';
    
    div.innerHTML = `
        <div class="card-header">
            <span class="company-name">${stock.name} <span class="stock-code">${stock.code}</span></span>
            ${cbTag}
        </div>
        <div class="card-meta">
            <span class="meta-tag industry">${stock.industry}</span>
            <span class="meta-tag date">å¸‚å€¼ ${formatNum(stock.cap)}å„„</span>
        </div>
        <div class="card-content">${stock.business || 'æš«ç„¡æ¥­å‹™èªªæ˜'}</div>
        <div class="card-footer">
            <span class="price-info">è‚¡åƒ¹ ${stock.price}</span>
        </div>
    `;
    return div;
}

function renderCBCard(cb) {
    let div = document.createElement('div');
    div.className = 'card-base';
    div.style.borderLeft = '4px solid var(--primary)';
    div.onclick = () => openStockModal(cb.stockCode); // é»æ“Š CB å¡ç‰‡ä¹Ÿæ‰“é–‹å€‹è‚¡ Modal
    
    // è¨ˆç®—è½‰æ›åƒ¹å€¼
    let stock = DB.stocks[cb.stockCode] || {price: 0};
    let convVal = cb.convPrice > 0 ? (stock.price / cb.convPrice) * 100 : 0;
    let premium = cb.price > 0 ? ((cb.price - convVal) / convVal) * 100 : 0;
    
    div.innerHTML = `
        <div class="card-header">
            <span class="company-name">${cb.name} <span class="stock-code">${cb.code}</span></span>
        </div>
        <div class="card-meta">
            <span class="meta-tag date">åˆ°æœŸ ${cb.maturityDate}</span>
            <span class="meta-tag broker">é¤˜é¡ ${cb.remainPct.toFixed(1)}%</span>
        </div>
        <div class="info-grid" style="margin:0; gap:5px;">
            <div><div class="info-label">CBå¸‚åƒ¹</div><div class="info-value">${cb.price||'-'}</div></div>
            <div><div class="info-label">æ¨™çš„è‚¡åƒ¹</div><div class="info-value">${stock.price}</div></div>
            <div><div class="info-label">è½‰æ›åƒ¹</div><div class="info-value">${cb.convPrice}</div></div>
            <div><div class="info-label">æº¢åƒ¹ç‡</div><div class="info-value ${premium<0?'val-pos':'val-neg'}">${premium?premium.toFixed(1)+'%':'-'}</div></div>
        </div>
    `;
    return div;
}

function renderNewsCard(news) {
    let div = document.createElement('div');
    div.className = 'card-base';
    div.innerHTML = `
        <div class="card-header">
            <span class="company-name">${news.title}</span>
            <span class="stock-code">${news.stockCode}</span>
        </div>
        <div class="card-meta">
            <span class="meta-tag date">${news.date}</span>
            <span class="meta-tag broker">${news.broker}</span>
        </div>
        <div class="card-content">${news.content}</div>
    `;
    return div;
}

// === æ ¸å¿ƒ Modal é‚è¼¯ (åŒ…å«æ™ºæ…§å°èˆª) ===

function openStockModal(code) {
    let stock = DB.stocks[code];
    if(!stock) return;
    
    // æ™ºæ…§æ­·å²ç´€éŒ„
    if(state.history.length > 0 && state.history[state.history.length-1] !== code) {
        $('modalBackBtn').style.display = 'flex';
        $('modalBackBtn').innerText = `â¬…ï¸ è¿”å› ${DB.stocks[state.history[state.history.length-1]].name}`;
    } else {
        $('modalBackBtn').style.display = 'none';
        // å¦‚æœæ˜¯æ–°é–‹å•Ÿï¼Œæ¨å…¥æ­·å²
        state.history.push(code); 
    }

    $('modalOverlay').classList.add('active');
    
    // æ¨™é¡Œå€
    $('modalTitleArea').innerHTML = `
        <h2 style="font-size:20px; font-weight:700;">${stock.name} (${stock.code})</h2>
        <div style="font-size:13px;color:#666;">${stock.industry} | ${stock.market}</div>
    `;
    
    // Tabs
    let tabsHtml = `
        <button class="modal-tab active" onclick="switchModalTab('basic')">ğŸ“Š åŸºæœ¬è³‡æ–™</button>
        <button class="modal-tab" onclick="switchModalTab('financial')">ğŸ’° è²¡å‹™ç‡Ÿæ”¶</button>
        <button class="modal-tab" onclick="switchModalTab('news')">ğŸ“° ç›¸é—œå ±å°</button>
    `;
    if(stock.hasCB) {
        tabsHtml += `<button class="modal-tab" onclick="switchModalTab('cb')" style="color:#c2185b;">ğŸ« å¯è½‰å‚µæˆ°æƒ…</button>`;
    }
    $('modalTabs').innerHTML = tabsHtml;
    
    // æº–å‚™è³‡æ–™
    let rev = DB.revenue[code] || {};
    let cbs = DB.cb[code] || [];
    let newsList = DB.news.filter(n => n.stockCode == code).slice(0, 10);
    
    // 1. åŸºæœ¬è³‡æ–™ Tab
    let basicHtml = `
        <div class="tab-pane active" id="tab-basic">
            <div class="section-box">
                <div class="info-grid">
                    <div class="info-card"><div class="info-label">æˆäº¤åƒ¹</div><div class="info-value" style="font-size:24px;color:var(--primary);">${stock.price}</div></div>
                    <div class="info-card"><div class="info-label">è‚¡æœ¬</div><div class="info-value">${formatNum(stock.cap/10)} å„„</div></div> <div class="info-card"><div class="info-label">ç”¢æ¥­åœ°ä½</div><div class="info-value" style="font-size:13px;font-weight:400;">${stock.industry}</div></div>
                </div>
                <div class="section-title">ğŸ¢ æ¥­å‹™å…§å®¹</div>
                <div style="line-height:1.8;color:#444;">${stock.business}</div>
            </div>
        </div>
    `;
    
    // 2. è²¡å‹™ç‡Ÿæ”¶ Tab (ä¿®å¾©ç‰ˆ)
    let revHtml = `<div class="tab-pane" id="tab-financial">`;
    if(rev.monthly && rev.monthly.length > 0) {
        // ç‡Ÿæ”¶äº®é»
        if(rev.highlights) {
            revHtml += `<div class="info-grid">
                <div class="info-card" style="background:#f0f9ff;"><div class="info-label">å–®æœˆç´€éŒ„</div><div class="info-value">${rev.highlights.monthRecord||'-'}</div></div>
                <div class="info-card" style="background:#f0f9ff;"><div class="info-label">é€£å¢/æ¸›æœˆ</div><div class="info-value">${rev.highlights.monthStreak||'-'}</div></div>
                <div class="info-card" style="background:#fffbe6;"><div class="info-label">æ­·å¹´æ’å</div><div class="info-value">${rev.highlights.yearRank||'-'}</div></div>
            </div>`;
        }
        
        // ç‡Ÿæ”¶è¡¨æ ¼
        revHtml += `<div class="section-box"><div class="section-title">ğŸ“ˆ æœˆç‡Ÿæ”¶è¶¨å‹¢ (è¿‘12å€‹æœˆ)</div>
        <div style="overflow-x:auto;"><table class="data-table"><thead><tr><th>å¹´æœˆ</th><th>ç‡Ÿæ”¶(å„„)</th></tr></thead><tbody>`;
        // ååºé¡¯ç¤ºæœ€è¿‘çš„åœ¨ä¸Šé¢
        [...rev.monthly].reverse().forEach(m => {
            revHtml += `<tr><td>${m.period}</td><td>${m.value}</td></tr>`;
        });
        revHtml += `</tbody></table></div></div>`;
    } else {
        revHtml += `<div class="error-msg">âš ï¸ æš«ç„¡è©³ç´°ç‡Ÿæ”¶è³‡æ–™ï¼Œè«‹ç¢ºèª 06_revenue.xlsx æ¬„ä½æ ¼å¼</div>`;
    }
    revHtml += `</div>`;
    
    // 3. CB æˆ°æƒ…å®¤ Tab (æ–°å¢)
    let cbHtml = `<div class="tab-pane" id="tab-cb">`;
    if(cbs.length > 0) {
        cbs.forEach(cb => {
            let stockPrice = parseFloat(stock.price) || 0;
            let convVal = (stockPrice / cb.convPrice) * 100;
            let premium = cb.price ? ((cb.price - convVal)/convVal * 100) : 0;
            let cbasLeverage = cb.cbasPrice ? (stockPrice / parseFloat(cb.cbasPrice)).toFixed(2) : '-';
            
            cbHtml += `
            <div class="section-box" style="border-left:4px solid #c2185b;">
                <div class="section-title" style="color:#c2185b;">
                    ${cb.name} (${cb.code}) 
                    <span style="font-size:12px;background:#fce4ec;padding:2px 8px;border-radius:10px;color:#c2185b;">å‰©é¤˜ ${cb.remainPct.toFixed(1)}%</span>
                </div>
                <div class="info-grid">
                    <div class="info-card"><div class="info-label">è½‰æ›åƒ¹æ ¼</div><div class="info-value">${cb.convPrice}</div></div>
                    <div class="info-card"><div class="info-label">è½‰æ›åƒ¹å€¼(ç†è«–åƒ¹)</div><div class="info-value">${convVal.toFixed(2)}</div></div>
                    <div class="info-card"><div class="info-label">CBå¸‚åƒ¹</div><div class="info-value">${cb.price || '-'}</div></div>
                    <div class="info-card"><div class="info-label">æº¢åƒ¹ç‡</div><div class="info-value ${premium<0?'val-pos':''}">${premium.toFixed(2)}%</div></div>
                </div>
                <div style="background:#f8f9fa;padding:10px;border-radius:8px;margin-top:10px;">
                    <div style="font-weight:700;margin-bottom:5px;color:#555;">CBAS é¸æ“‡æ¬Šæ•¸æ“š</div>
                    <div style="display:flex;gap:15px;font-size:13px;">
                        <span>æ¬Šåˆ©é‡‘: <b>${cb.cbasPrice || '-'}</b></span>
                        <span>ä¼°è¨ˆæ§“æ¡¿: <b>${cbasLeverage}x</b></span>
                        <span>æ³¢å‹•ç‡: <b>${cb.volatility || '-'}</b></span>
                    </div>
                </div>
                <div style="margin-top:10px;font-size:12px;color:#888;">
                    ç™¼è¡Œæ—¥: ${cb.issueDate} | åˆ°æœŸæ—¥: ${cb.maturityDate}
                </div>
            </div>`;
        });
    }
    cbHtml += `</div>`;
    
    // 4. æ–°è Tab
    let newsHtml = `<div class="tab-pane" id="tab-news"><div class="section-box">`;
    if(newsList.length > 0) {
        newsList.forEach(n => {
            newsHtml += `<div style="padding:10px 0;border-bottom:1px solid #eee;">
                <div style="font-size:12px;color:#888;">${n.date} | ${n.broker}</div>
                <div style="font-weight:600;margin-top:4px;">${n.content}</div>
            </div>`;
        });
    } else {
        newsHtml += `<div style="text-align:center;color:#999;padding:20px;">æš«ç„¡ç›¸é—œæ–°è</div>`;
    }
    newsHtml += `</div></div>`;
    
    $('modalBody').innerHTML = basicHtml + revHtml + cbHtml + newsHtml;
}

function switchModalTab(tabName) {
    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    event.target.classList.add('active');
    $('tab-' + tabName).classList.add('active');
}

function closeModal() {
    $('modalOverlay').classList.remove('active');
    state.history = []; // æ¸…ç©ºæ­·å²
}

function modalGoBack() {
    state.history.pop(); // ç§»é™¤ç•¶å‰
    let prevCode = state.history.pop(); // å–å¾—ä¸Šä¸€å€‹ (å› ç‚º openStockModal æœƒå† push ä¸€æ¬¡)
    if(prevCode) {
        openStockModal(prevCode);
    } else {
        closeModal();
    }
}

// === äº’å‹•é‚è¼¯ ===
function switchDB(db) {
    state.currentDB = db;
    document.querySelectorAll('.db-tab').forEach(t => t.classList.toggle('active', t.dataset.db === db));
    renderMainList();
}

function setupSearch() {
    let inp = $('searchInput');
    inp.addEventListener('input', (e) => {
        state.search = e.target.value.trim();
        // æ™ºæ…§å»ºè­°é‚è¼¯ (å¯æ“´å……)
        if(state.search.length > 0) {
            $('searchSuggestions').style.display = 'block';
            let hits = Object.values(DB.stocks).filter(s => s.code.includes(state.search) || s.name.includes(state.search)).slice(0, 5);
            let html = hits.map(s => `<div class="suggestion-item" onclick="openStockModal('${s.code}')"><div class="suggestion-icon">ğŸ¢</div><div>${s.name} (${s.code})</div></div>`).join('');
            
            // æœå°‹ CB
            let cbHits = DB.cbList.filter(c => c.name.includes(state.search) || c.code.includes(state.search)).slice(0, 3);
            if(cbHits.length > 0) html += `<div class="suggestion-group-title">å¯è½‰å‚µ</div>` + cbHits.map(c => `<div class="suggestion-item" onclick="openStockModal('${c.stockCode}')"><div class="suggestion-icon">ğŸ«</div><div>${c.name}</div></div>`).join('');
            
            $('searchSuggestions').innerHTML = html || '<div style="padding:10px;color:#999;">ç„¡ç¬¦åˆçµæœ</div>';
        } else {
            $('searchSuggestions').style.display = 'none';
        }
        renderMainList();
    });
    
    // é»æ“Šå»ºè­°é …ç›®é—œé–‰é¸å–®
    document.addEventListener('click', (e) => {
        if(!e.target.closest('.search-section')) $('searchSuggestions').style.display = 'none';
    });
}

// å•Ÿå‹•
window.onload = loadData;

</script>
</body>
</html>
