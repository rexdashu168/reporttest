<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤ (Clean View)</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>if(typeof XLSX==='undefined'){document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>');}</script>
    <style>
        /* ===== 1. ç¾ä»£åŒ–ç°¡ç´„é¢¨æ ¼ç³»çµ± ===== */
        :root { 
            --primary: #c96442; 
            --primary-light: #fbeee9;
            --bg: #f2f4f6; /* æŸ”å’Œç°èƒŒæ™¯ */
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --text-sub: #636e72;
            --border: #dfe6e9;
            --link: #0984e3; 
            --radius: 12px;
            --shadow: 0 4px 6px rgba(0,0,0,0.03);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg); color: var(--text-main); line-height: 1.5; padding-bottom: 40px; }
        
        /* éš±è—/é¡¯ç¤ºè¦–åœ–çš„æ©Ÿåˆ¶ */
        .view-section { display: none; padding: 16px; max-width: 800px; margin: 0 auto; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ===== Header & Search ===== */
        .app-header { margin-bottom: 20px; }
        .app-title { font-size: 24px; font-weight: 800; color: var(--primary); margin-bottom: 4px; letter-spacing: -0.5px; }
        .app-sub { font-size: 13px; color: var(--text-sub); }

        /* æœå°‹æ¡†å„ªåŒ– (å«æ¸…é™¤æŒ‰éˆ•) */
        .search-wrapper { position: relative; margin: 15px 0; }
        .search-input { 
            width: 100%; padding: 14px 40px 14px 16px; 
            border-radius: var(--radius); border: 2px solid transparent; 
            background: #fff; box-shadow: var(--shadow);
            font-size: 16px; color: var(--text-main); outline: none; transition: all 0.2s;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 4px 12px rgba(201, 100, 66, 0.15); }
        .clear-btn {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            width: 20px; height: 20px; border-radius: 50%; background: #ccc;
            color: #fff; font-size: 14px; line-height: 20px; text-align: center;
            cursor: pointer; display: none; /* é è¨­éš±è— */
        }
        .clear-btn:hover { background: #999; }

        /* DB Tabs (Pill Style) */
        .tab-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .tab-scroll::-webkit-scrollbar { display: none; }
        .db-tab { 
            white-space: nowrap; padding: 8px 16px; border-radius: 20px; 
            background: #e0e0e0; color: #666; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
        }
        .db-tab.active { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(201, 100, 66, 0.3); }
        .count-badge { font-size: 11px; margin-left: 4px; opacity: 0.8; }

        /* ===== Card List Style ===== */
        .card-list { display: flex; flex-direction: column; gap: 16px; }
        .card { 
            background: var(--card-bg); padding: 18px; border-radius: var(--radius); 
            box-shadow: var(--shadow); cursor: pointer; border: 1px solid transparent;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .card:active { transform: scale(0.98); background: #fafafa; }
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .card-title { font-size: 17px; font-weight: 700; color: var(--text-main); line-height: 1.3; }
        .card-code { color: #b2bec3; font-weight: 500; font-size: 14px; margin-left: 6px; }
        .card-meta { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
        .tag-pill { font-size: 11px; padding: 3px 8px; border-radius: 6px; font-weight: 600; }
        .tag-pill.main { background: var(--primary-light); color: var(--primary); }
        .tag-pill.sub { background: #eceff1; color: #546e7a; }
        .card-desc { font-size: 14px; color: var(--text-sub); display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.6; }

        /* ===== Detail View (The "No Modal" Page) ===== */
        .detail-navbar { 
            display: flex; align-items: center; margin-bottom: 20px; 
            position: sticky; top: 0; background: var(--bg); z-index: 10; padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .back-btn {
            background: #fff; border: 1px solid var(--border); border-radius: 8px;
            padding: 8px 16px; font-size: 14px; font-weight: 600; color: var(--text-main);
            cursor: pointer; display: flex; align-items: center; gap: 5px; box-shadow: var(--shadow);
        }
        .back-btn:active { background: #eee; }
        
        .detail-header { background: #fff; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 16px; }
        .detail-title { font-size: 24px; font-weight: 800; margin-bottom: 10px; }
        .detail-tags { display: flex; gap: 8px; flex-wrap: wrap; }

        /* Detail Content Tabs */
        .detail-tabs-nav { display: flex; background: #fff; padding: 5px; border-radius: 12px; margin-bottom: 16px; box-shadow: var(--shadow); overflow-x: auto; }
        .d-tab-btn { 
            flex: 1; text-align: center; padding: 10px; font-size: 13px; font-weight: 600; 
            color: var(--text-sub); border-radius: 8px; cursor: pointer; white-space: nowrap; 
        }
        .d-tab-btn.active { background: var(--primary-light); color: var(--primary); }

        .info-block { background: #fff; border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); margin-bottom: 16px; }
        .section-title { font-size: 15px; font-weight: 700; color: #2d3436; margin-bottom: 12px; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        .data-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .data-row:last-child { border-bottom: none; }
        .d-label { color: #999; }
        .d-value { font-weight: 600; text-align: right; }
        
        /* Interactive Links inside text */
        .magic-link { color: var(--link); font-weight: 600; cursor: pointer; text-decoration: none; padding: 0 2px; }
        .magic-link:hover { background: #e3f2fd; border-radius: 3px; }

        /* Loading */
        .loader { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader.hidden { display: none; }
    </style>
</head>
<body>

<div class="loader" id="loader">
    <div style="font-size:40px;margin-bottom:10px">ğŸ“Š</div>
    <div style="font-weight:700;color:var(--text-main)">Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</div>
    <div style="font-size:12px;color:var(--text-sub);margin-top:5px">è³‡æ–™è¼‰å…¥ä¸­...</div>
</div>

<div id="view-home" class="view-section active">
    <div class="app-header">
        <div class="app-title">Rexå¤§å”</div>
        <div class="app-sub">å…¨æ–¹ä½æŠ•è³‡æ±ºç­–ç³»çµ± v4.0 (Clean)</div>
    </div>

    <div class="search-wrapper">
        <input type="text" class="search-input" id="search" placeholder="æœå°‹å…¬å¸ã€ä»£è™Ÿæˆ– #é—œéµå­—..." oninput="handleInput(this)">
        <div class="clear-btn" id="clearBtn" onclick="clearSearch()">âœ•</div>
    </div>

    <div class="tab-scroll">
        <div class="db-tab active" onclick="setDB('news')">âš¡ å¤–é›» <span class="count-badge" id="c-news">0</span></div>
        <div class="db-tab" onclick="setDB('memo')">ğŸ“‹ Memo <span class="count-badge" id="c-memo">0</span></div>
        <div class="db-tab" onclick="setDB('reports')">ğŸ“‘ å ±å‘Š <span class="count-badge" id="c-reports">0</span></div>
        <div class="db-tab" onclick="setDB('strategy')">ğŸ¯ ç­–ç•¥ <span class="count-badge" id="c-strategy">0</span></div>
        <div class="db-tab" onclick="setDB('stocks')">ğŸ¢ å€‹è‚¡ <span class="count-badge" id="c-stocks">0</span></div>
        <div class="db-tab" onclick="setDB('cb')">ğŸ« CB <span class="count-badge" id="c-cb">0</span></div>
    </div>

    <div style="margin: 15px 0 10px; font-size:12px; color:var(--text-sub);">
        é¡¯ç¤º <b id="resCount" style="color:var(--primary)">0</b> ç­†è³‡æ–™
    </div>

    <div class="card-list" id="list"></div>
</div>

<div id="view-detail" class="view-section">
    <div class="detail-navbar">
        <button class="back-btn" onclick="goBack()">
            <span>â†</span> è¿”å›åˆ—è¡¨
        </button>
    </div>

    <div id="detail-content">
        </div>
</div>

<script>
// --- CORE LOGIC ---
const FILES = {
    NEWS: '01_news.xlsx', MEMO: '02_memo.xlsx', REPORTS: '03_reports.xlsx',
    MASTER: '04_master.xlsx', STRAT: '05_Strategy.xlsx', CB: '00_CB.xlsx', REV: '06_revenue.xlsx'
};
const DB = { news:[], memo:[], reports:[], strategy:[], stocks:{}, cb:[] };
const META = { 
    memoDetail:{}, tracking:{}, finance:{}, products:{}, timeline:[], ratings:{},
    revenue:{}, cbMap:{}, relatedNews:{}, relatedMemo:{}, concepts:{}, reportPicks:{}, stockInReports:{}
};
let CURR_DB = 'news';

// Utils
const $ = id => document.getElementById(id);
const safe = v => (v==null||v==undefined?'':String(v).trim());
const fmtDate = v => {
    if(!v) return '';
    if(typeof v === 'number' && v > 20000) { const d=new Date((v-25569)*86400000); return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; }
    return String(v).split(' ')[0];
};
// Smart Text Formatter (The Magic Link Engine)
const fmtTxt = t => {
    if(!t) return '';
    let h = safe(t).replace(/\n/g, '<br>').replace(/â€¢/g, '<br>â€¢ ');
    // Link Tags
    h = h.replace(/#(\S+)/g, '<span class="magic-link" onclick="runSearch(\'#$1\')">#$1</span>');
    // Link Stock Codes (4 digits)
    h = h.replace(/(\d{4})/g, (m) => DB.stocks[m] ? `<span class="magic-link" onclick="openStock('${m}')">${m}</span>` : m);
    return h;
};

// --- View Management (NO MODALS) ---
function switchView(viewId) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    $(viewId).classList.add('active');
    window.scrollTo(0,0);
}
function goBack() { switchView('view-home'); }

// --- Search Handling ---
function handleInput(el) {
    $('clearBtn').style.display = el.value.length > 0 ? 'block' : 'none';
    renderList();
}
function clearSearch() {
    const el = $('search');
    el.value = '';
    el.focus();
    $('clearBtn').style.display = 'none';
    renderList();
}
function runSearch(term) {
    $('search').value = term;
    handleInput($('search'));
    goBack(); // Ensure we are on home view
}

// --- Data Loading ---
async function fetchXlsx(url) {
    try {
        const res = await fetch(url);
        if(!res.ok) throw new Error();
        return XLSX.read(await res.arrayBuffer(), {type:'array'});
    } catch(e){ console.log('Skip:', url); return null; }
}

async function init() {
    // 1. Master & Concepts
    let wb = await fetchXlsx(FILES.MASTER);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['ä¸»è³‡æ–™åº«']||[]).forEach(r=> { if(r['ä»£è™Ÿ']) DB.stocks[safe(r['ä»£è™Ÿ'])]=r; });
        XLSX.utils.sheet_to_json(wb.Sheets['ğŸ’¡æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«']||[]).forEach(r=>{
            const c=safe(r['è‚¡ç¥¨ä»£è™Ÿ']), t=safe(r['æ¦‚å¿µåˆ†é¡']);
            if(c&&t) { if(!META.concepts[c]) META.concepts[c]=[]; if(!META.concepts[c].includes(t)) META.concepts[c].push(t); }
        });
    }
    // 2. News
    wb = await fetchXlsx(FILES.NEWS);
    if(wb) XLSX.utils.sheet_to_json(wb.Sheets['å¤–é›»ç¶œåˆå ±å°']||[]).forEach(r=>{
        if(safe(r['è³‡æ–™é¡å‹'])==='å€‹è‚¡å ±å°') {
            DB.news.push(r);
            const k=safe(r['è‚¡è™Ÿ']); if(k){ if(!META.relatedNews[k]) META.relatedNews[k]=[]; META.relatedNews[k].push(r); }
        }
    });
    // 3. CB
    wb = await fetchXlsx(FILES.CB);
    if(wb) XLSX.utils.sheet_to_json(wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™']||[]).forEach(r=>{
        DB.cb.push(r);
        const k=safe(r['è½‰æ›æ¨™çš„ä»£ç¢¼']); if(k){ if(!META.cbMap[k]) META.cbMap[k]=[]; META.cbMap[k].push(r); }
    });
    // 4. Memo
    wb = await fetchXlsx(FILES.MEMO);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¡¨']||[]).forEach(r=>{
            DB.memo.push(r);
            const k=safe(r['è‚¡è™Ÿ']); if(k){ if(!META.relatedMemo[k]) META.relatedMemo[k]=[]; META.relatedMemo[k].push(r); }
        });
        XLSX.utils.sheet_to_json(wb.Sheets['è©³ç´°å…§å®¹åº«']||[]).forEach(r=>META.memoDetail[safe(r['ç·¨è™Ÿ'])]=r);
        XLSX.utils.sheet_to_json(wb.Sheets['å…¬å¸è¿½è¹¤è¡¨']||[]).forEach(r=>META.tracking[safe(r['å…¬å¸'])]=r);
        XLSX.utils.sheet_to_json(wb.Sheets['è²¡å‹™æ•¸æ“šå½™ç¸½']||[]).forEach(r=>META.finance[safe(r['å…¬å¸'])]=r);
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢å“çµæ§‹åˆ†æ']||[]).forEach(r=>META.products[safe(r['å…¬å¸'])]=r);
    }
    // 5. Reports
    wb = await fetchXlsx(FILES.REPORTS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r=>DB.reports.push(r));
        XLSX.utils.sheet_to_json(wb.Sheets['å€‹è‚¡è©•åƒ¹è¡¨']||[]).forEach(r=>{
             let c=safe(r['è‚¡ç¥¨ä»£è™Ÿ']).split(' ')[0]; if(c) META.ratings[c]=r;
        });
        XLSX.utils.sheet_to_json(wb.Sheets['åˆ¸å•†è§€é»çµè«–']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            [1,2,3].forEach(n => {
                const s = safe(r[`é¦–é¸å€‹è‚¡${n}`]);
                if(s) { if(!META.reportPicks[rid]) META.reportPicks[rid]=[]; META.reportPicks[rid].push({name:s, reason:safe(r[`é¦–é¸ç†ç”±${n}`])}); }
            });
        });
    }
    // 6. Strategy
    wb = await fetchXlsx(FILES.STRAT);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r=>DB.strategy.push(r));
        XLSX.utils.sheet_to_json(wb.Sheets['é¸è‚¡ç­–ç•¥']||[]).forEach(r => {
            const rid=safe(r['å ±å‘Šç·¨è™Ÿ']), c=safe(r['è‚¡ç¥¨ä»£è™Ÿ']);
            if(rid && c) {
                if(!META.reportPicks[rid]) META.reportPicks[rid]=[]; META.reportPicks[rid].push({code:c, name:safe(r['å…¬å¸åç¨±']), note:safe(r['å‚™è¨»'])});
                if(!META.stockInReports[c]) META.stockInReports[c]=[]; META.stockInReports[c].push(rid);
            }
        });
    }
    // 7. Revenue
    wb = await fetchXlsx(FILES.REV);
    if(wb) {
        const sheet = wb.Sheets['000_æœˆç‡Ÿæ”¶'] || wb.Sheets[wb.SheetNames[0]];
        if(sheet) {
            const rows = XLSX.utils.sheet_to_json(sheet);
            if(rows.length>0) {
                const h = Object.keys(rows[0]).filter(k=>k.includes('å–®æœˆç‡Ÿæ”¶'));
                const recH = h.slice(-6);
                rows.forEach(r=>{ META.revenue[safe(r['ä»£è™Ÿ'])] = recH.map(k=>({p:k.match(/\d+M\d+/)?.[0]||'æœˆ', v:r[k]})); });
            }
        }
    }

    // Done
    $('loader').classList.add('hidden');
    updateCounts();
    renderList();
}

function setDB(db) {
    CURR_DB = db;
    document.querySelectorAll('.db-tab').forEach(t=>t.classList.remove('active'));
    event.currentTarget.classList.add('active');
    renderList();
}

function updateCounts() {
    $('c-news').innerText=DB.news.length; $('c-memo').innerText=DB.memo.length;
    $('c-reports').innerText=DB.reports.length; $('c-strategy').innerText=DB.strategy.length;
    $('c-stocks').innerText=Object.keys(DB.stocks).length; $('c-cb').innerText=DB.cb.length;
}

function renderList() {
    const q = $('search').value.toLowerCase().trim();
    let list = [], html = '';
    
    if(CURR_DB==='news') list=DB.news;
    else if(CURR_DB==='memo') list=DB.memo;
    else if(CURR_DB==='reports') list=DB.reports;
    else if(CURR_DB==='strategy') list=DB.strategy;
    else if(CURR_DB==='stocks') list=Object.values(DB.stocks);
    else if(CURR_DB==='cb') list=DB.cb;

    const filtered = list.filter(i => {
        if(CURR_DB==='memo' && i['ç·¨è™Ÿ']) {
            const d = META.memoDetail[i['ç·¨è™Ÿ']];
            if(d && JSON.stringify(d).toLowerCase().includes(q)) return true;
        }
        return JSON.stringify(i).toLowerCase().includes(q);
    });
    $('resCount').innerText = filtered.length;

    filtered.slice(0, 100).forEach(i => {
        let title='', code='', tag='', date='', body='', click='';
        
        if(CURR_DB==='stocks') {
            title=i['å…¬å¸åç¨±']; code=i['ä»£è™Ÿ']; tag=i['ç”¢æ¥­åˆ†é¡']; body=i['æ¥­å‹™æ‘˜è¦'];
            click=`openStock('${code}')`;
        } else if(CURR_DB==='news') {
            title=i['å…¬å¸']; code=i['è‚¡è™Ÿ']; tag=i['å ±å°é‡é»åˆ†é¡']; date=i['æ—¥æœŸ']; body=fmtTxt(i['å®Œæ•´å ±å°å…§å®¹']);
            click=`openStock('${code}')`;
        } else if(CURR_DB==='memo') {
            title=i['å…¬å¸']; code=i['è‚¡è™Ÿ']; tag=i['å ±å‘Šé¡å‹']; date=i['æ—¥æœŸ'];
            const d = META.memoDetail[i['ç·¨è™Ÿ']];
            body = d ? (d['ç‡Ÿé‹é‡é»']||d['Rexè§€å¯Ÿ']) : 'é»æ“ŠæŸ¥çœ‹è©³æƒ…';
            if(d && d['æ¨™ç±¤']) body += `<div style="margin-top:6px;color:var(--link);font-size:12px">${d['æ¨™ç±¤']}</div>`;
            click=`openStock('${code}')`;
        } else if(CURR_DB==='reports' || CURR_DB==='strategy') {
            title=i['å ±å‘Šæ¨™é¡Œ']; tag=i['åˆ¸å•†åç¨±']; date=i['å ±å‘Šæ—¥æœŸ']; body=i['å‰¯æ¨™é¡Œ']||i['å¤§ç›¤è§€é»'];
            click=`openReport('${i['å ±å‘Šç·¨è™Ÿ']}', '${CURR_DB}')`;
        } else if(CURR_DB==='cb') {
            title=i['åç¨±']; code=i['è½‰æ›æ¨™çš„ä»£ç¢¼']; tag=`è½‰åƒ¹:${i['è½‰æ›åƒ¹æ ¼(å…ƒ)']}`; body=`é¤˜é¡:${i['æœ€æ–°é¤˜é¡(ç™¾è¬)']}M | åˆ°æœŸ:${fmtDate(i['åˆ°æœŸæ—¥'])}`;
            click=`openStock('${code}')`;
        }

        html += `
        <div class="card" onclick="${click}">
            <div class="card-top">
                <div class="card-title">${title}<span class="card-code">${code||''}</span></div>
                ${date ? `<span style="font-size:12px;color:#999">${fmtDate(date)}</span>` : ''}
            </div>
            <div class="card-meta">
                <span class="tag-pill main">${tag||'ä¸€èˆ¬'}</span>
            </div>
            <div class="card-desc">${body}</div>
        </div>`;
    });
    $('list').innerHTML = html || '<div style="text-align:center;padding:40px;color:#999">ç„¡ç›¸ç¬¦è³‡æ–™</div>';
}

// ===== FLAT DETAIL VIEWS =====

// 1. STOCK DETAIL
window.openStock = (code) => {
    if(!code || code==='-') return;
    const s = DB.stocks[code] || { 'å…¬å¸åç¨±': code, 'ä»£è™Ÿ': code, 'ç”¢æ¥­åˆ†é¡':'æœªçŸ¥', 'æ¥­å‹™æ‘˜è¦':'' };
    const name = s['å…¬å¸åç¨±'];
    
    // Aggregation
    const cbs = META.cbMap[code];
    const rev = META.revenue[code];
    const memos = META.relatedMemo[code] || [];
    const news = META.relatedNews[code] || [];
    const fin = META.finance[name] || {};
    const prod = META.products[name] || {};
    const track = META.tracking[name] || {};
    const rate = META.ratings[code] || {};
    const concepts = META.concepts[code] || [];

    let tagsHtml = concepts.map(c => `<span class="tag-pill sub magic-link" onclick="runSearch('${c}')">#${c}</span>`).join('');
    tagsHtml += `<span class="tag-pill main magic-link" onclick="runSearch('${s['ç”¢æ¥­åˆ†é¡']}')">${s['ç”¢æ¥­åˆ†é¡']}</span>`;

    let html = `
        <div class="detail-header">
            <div class="detail-title">${name} <span style="color:#999;font-weight:400">${code}</span></div>
            <div class="detail-tags">${tagsHtml}</div>
            <div style="margin-top:10px;font-size:14px;color:#555;line-height:1.6">${s['æ¥­å‹™æ‘˜è¦']}</div>
        </div>
        
        <div class="detail-tabs-nav">
            <div class="d-tab-btn active" onclick="swDetailTab('basic',this)">åŸºæœ¬æ¦‚æ³</div>
            <div class="d-tab-btn" onclick="swDetailTab('fin',this)">è²¡å‹™æ•¸æ“š</div>
            <div class="d-tab-btn" onclick="swDetailTab('prod',this)">ç”¢å“çµ„åˆ</div>
            <div class="d-tab-btn" onclick="swDetailTab('news',this)">ç›¸é—œå ±å°</div>
        </div>
        
        <div id="dt-basic" class="d-pane active">
            <div class="info-block">
                <div class="section-title">åŸºæœ¬è³‡æ–™</div>
                <div class="data-row"><span class="d-label">æ”¶ç›¤åƒ¹</span><span class="d-value" style="color:var(--primary);font-size:16px">${s['æˆäº¤']||'-'}</span></div>
                <div class="data-row"><span class="d-label">æ¼²è·Œå¹…</span><span class="d-value">${s['æ¼²è·Œå¹…']||'-'}%</span></div>
                <div class="data-row"><span class="d-label">å¸‚å€¼</span><span class="d-value">${s['å¸‚å€¼(å„„)']||'-'} å„„</span></div>
            </div>
            ${track['æŠ•è³‡è©•ç­‰'] ? `
            <div class="info-block">
                <div class="section-title">è¿½è¹¤è©•ç­‰</div>
                <div class="data-row"><span class="d-label">è©•ç­‰</span><span class="d-value">${track['æŠ•è³‡è©•ç­‰']}</span></div>
                <div class="data-row"><span class="d-label">ç›®æ¨™åƒ¹</span><span class="d-value" style="color:#d63031">${track['ç›®æ¨™åƒ¹']}</span></div>
            </div>` : ''}
            ${cbs ? `
            <div class="info-block">
                <div class="section-title">å¯è½‰å‚µ (CB)</div>
                ${cbs.map(c=>`<div style="padding:8px 0;border-bottom:1px dashed #eee">
                    <div style="font-weight:700">${c['åç¨±']} ($${c['CBæ”¶ç›¤åƒ¹']})</div>
                    <div style="font-size:13px;color:#666;margin-top:2px">è½‰åƒ¹: ${c['è½‰æ›åƒ¹æ ¼(å…ƒ)']} | é¤˜é¡: ${c['æœ€æ–°é¤˜é¡(ç™¾è¬)']}M</div>
                </div>`).join('')}
            </div>` : ''}
        </div>

        <div id="dt-fin" class="d-pane" style="display:none">
             <div class="info-block">
                <div class="section-title">è²¡å‹™é‡é» (3Q25)</div>
                <div class="data-row"><span class="d-label">å–®å­£ç‡Ÿæ”¶</span><span class="d-value">${fin['3Q25ç‡Ÿæ”¶']||'-'}</span></div>
                <div class="data-row"><span class="d-label">æ¯›åˆ©ç‡</span><span class="d-value">${fin['æ¯›åˆ©ç‡']||'-'}</span></div>
                <div class="data-row"><span class="d-label">EPS</span><span class="d-value">${fin['EPS']||'-'}</span></div>
             </div>
             ${fin['4Q25æŒ‡å¼•'] ? `<div class="info-block"><div class="section-title">æœªä¾†æŒ‡å¼•</div><div style="font-size:14px">${fmtTxt(fin['4Q25æŒ‡å¼•'])}</div></div>` : ''}
             ${rev ? `<div class="info-block"><div class="section-title">è¿‘åŠå¹´æœˆç‡Ÿæ”¶</div>
                <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:4px;text-align:center;">
                    ${rev.map(r=>`<div style="background:#f8f9fa;padding:6px;border-radius:4px;"><div style="font-size:10px;color:#999">${r.p}</div><div style="font-weight:700;font-size:12px">${r.v}</div></div>`).join('')}
                </div></div>` : ''}
        </div>

        <div id="dt-prod" class="d-pane" style="display:none">
            ${prod['ä¸»è¦ç”¢å“1'] ? `<div class="info-block">
                <div class="section-title">ç”¢å“ç‡Ÿæ”¶çµæ§‹</div>
                ${[1,2,3].map(n=>prod[`ä¸»è¦ç”¢å“${n}`]?`<div class="data-row"><span class="d-label">${prod[`ä¸»è¦ç”¢å“${n}`]}</span><span class="d-value">${prod[`ä½”æ¯”/è¡¨ç¾${n}`]||''}</span></div>`:'').join('')}
            </div>`:''}
            ${prod['é—œéµæˆé•·å‹•èƒ½'] ? `<div class="info-block"><div class="section-title">æˆé•·å‹•èƒ½</div><div style="font-size:14px">${fmtTxt(prod['é—œéµæˆé•·å‹•èƒ½'])}</div></div>`:''}
        </div>

        <div id="dt-news" class="d-pane" style="display:none">
            ${memos.map(m=> {
                const d = META.memoDetail[m['ç·¨è™Ÿ']];
                return `<div class="info-block">
                    <div style="font-weight:700;margin-bottom:6px">${m['åˆ¸å•†']} - ${m['å ±å‘Šé¡å‹']}</div>
                    <div style="font-size:12px;color:#999;margin-bottom:8px">${fmtDate(m['æ—¥æœŸ'])} | åˆ†æå¸«: ${m['åˆ†æå¸«']||'-'}</div>
                    ${d ? `<div style="font-size:14px;color:#444;line-height:1.6;border-top:1px dashed #eee;padding-top:8px">${fmtTxt(d['ç‡Ÿé‹é‡é»'])}</div>` : ''}
                </div>`;
            }).join('')}
            ${news.map(n=>`<div class="info-block">
                <div style="font-weight:700;color:#2d3436">${n['å ±å°é‡é»åˆ†é¡']}</div>
                <div style="font-size:12px;color:#999;margin:4px 0">${fmtDate(n['æ—¥æœŸ'])} | ${n['åˆ¸å•†ä¾†æº']}</div>
                <div style="font-size:14px;color:#555;line-height:1.6">${fmtTxt(n['å®Œæ•´å ±å°å…§å®¹'])}</div>
            </div>`).join('')}
            ${(!memos.length && !news.length) ? '<div style="text-align:center;padding:20px;color:#999">ç„¡ç›¸é—œå ±å°</div>' : ''}
        </div>
    `;

    $('detail-content').innerHTML = html;
    switchView('view-detail');
};

// 2. REPORT DETAIL
window.openReport = (rid, type) => {
    let report = (type === 'strategy' ? DB.strategy : DB.reports).find(r => r['å ±å‘Šç·¨è™Ÿ'] === rid);
    if (!report) return;
    const picks = META.reportPicks[rid] || [];

    let html = `
        <div class="detail-header">
            <div class="detail-title">${report['å ±å‘Šæ¨™é¡Œ']}</div>
            <div style="color:var(--text-sub);font-size:14px">${report['åˆ¸å•†åç¨±']} | ${fmtDate(report['å ±å‘Šæ—¥æœŸ'])}</div>
        </div>

        <div class="info-block">
            <div class="section-title">æ ¸å¿ƒè§€é»</div>
            <div style="font-size:15px;line-height:1.7;color:#2d3436">${fmtTxt(report['å‰¯æ¨™é¡Œ'] || report['å¤§ç›¤è§€é»'])}</div>
        </div>
    `;

    if (picks.length > 0) {
        html += `<div class="info-block"><div class="section-title">ç›¸é—œç²¾é¸å€‹è‚¡</div><div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(140px, 1fr));gap:10px;">`;
        picks.forEach(p => {
            let code = p.code || (Object.values(DB.stocks).find(s=>s['å…¬å¸åç¨±']===p.name)?.['ä»£è™Ÿ']);
            html += `<div style="border:1px solid #eee;border-radius:8px;padding:10px;cursor:pointer;background:#fafafa" ${code ? `onclick="openStock('${code}')"` : ''}>
                <div style="font-weight:700;color:var(--primary)">${p.name}</div>
                ${code ? `<div style="font-size:11px;color:#999">${code}</div>`:''}
                ${p.reason ? `<div style="font-size:11px;color:#666;margin-top:4px;line-height:1.3">${p.reason}</div>`:''}
            </div>`;
        });
        html += `</div></div>`;
    }

    if(report['ç¸½ç¶“è§€é»æ‘˜è¦']) {
        html += `<div class="info-block"><div class="section-title">ç¸½ç¶“åˆ†æ</div><div style="font-size:14px;line-height:1.6">${fmtTxt(report['ç¸½ç¶“è§€é»æ‘˜è¦'])}</div></div>`;
    }

    $('detail-content').innerHTML = html;
    switchView('view-detail');
};

// Detail Tab Switcher
window.swDetailTab = (id, el) => {
    document.querySelectorAll('.d-tab-btn').forEach(b=>b.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('.d-pane').forEach(p=>p.style.display='none');
    $(`dt-${id}`).style.display='block';
}

window.onload = init;
</script>
</body>
</html>
