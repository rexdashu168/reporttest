<!DOCTYPE html>

<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤ v11.6</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #c96442; --bg: #faf9f5; --text: #2c2c2c; --gray: #555; --border: #d8d8d8; --link: #2980b9; --up: #e74c3c; --down: #27ae60; --clickable: #fff0e0; --clickable-hover: #ffe0c8; --clickable-border: #ffc8a0; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; font-size: 16px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; padding: 12px; }
        @media(min-width: 1024px) { .container { max-width: 1400px; padding: 20px; } }
        @media(min-width: 1600px) { .container { max-width: 1600px; } }
    .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; }
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid #e0e0e0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .header { text-align: center; padding: 18px 0; border-bottom: 1px solid var(--border); }
    .header h1 { color: var(--primary); font-size: 26px; margin-bottom: 6px; font-weight: 800; }
    .db-switcher { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin: 18px 0; }
    .db-tab { padding: 8px 16px; background: var(--clickable); border: 1px solid var(--clickable-border); border-radius: 20px; font-size: 15px; color: var(--gray); cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
    .db-tab:hover { border-color: var(--primary); background: var(--clickable-hover); }
    .db-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .count { background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-size: 12px; }

    .search-box { position: relative; margin-bottom: 18px; }
    .search-input { width: 100%; padding: 14px 40px 14px 45px; border-radius: 25px; border: 2px solid var(--border); background: #fff; font-size: 16px; outline: none; transition: border-color 0.2s; }
    .search-input:focus { border-color: var(--primary); }
    .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #888; font-size: 18px; }
    .clear-btn { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); width: 26px; height: 26px; background: var(--clickable); border: 1px solid var(--clickable-border); color: var(--primary); border-radius: 50%; font-size: 14px; line-height: 24px; text-align: center; cursor: pointer; display: none; transition: all 0.2s; }
    .clear-btn:hover { background: #e74c3c; color: #fff; border-color: #e74c3c; }

    /* CB çµ±è¨ˆå€å¡Š - æ›´é®®æ˜çš„æš–è‰²é…è‰² */
    .cb-stats { background: linear-gradient(135deg, #fff8f0 0%, #fff0e5 100%); border-radius: 14px; padding: 18px; margin-bottom: 18px; border: 1px solid #ffd8c0; box-shadow: 0 2px 8px rgba(201,100,66,0.08); }
    
    /* CB æ¨¡å¼åˆ‡æ› - å…©åˆ—é¡¯ç¤º */
    .cb-mode-switcher { display: flex; flex-wrap: nowrap; gap: 3px; margin-bottom: 8px; justify-content: space-between; }
    .cb-mode-row1 { }
    .cb-mode-row2 { margin-bottom: 14px; }
    .cb-mode-tab { padding: 6px 4px; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; border: 1px solid var(--clickable-border); background: var(--clickable); color: #333; transition: all 0.2s; white-space: nowrap; flex: 1; text-align: center; min-width: 0; }
    .cb-mode-tab:hover { border-color: var(--primary); background: var(--clickable-hover); }
    .cb-mode-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .cb-mode-tab .cnt { font-size: 9px; margin-left: 2px; opacity: 0.85; font-family: 'Menlo', 'Monaco', 'Consolas', monospace; display: block; line-height: 1.2; }
    @media(min-width: 400px) { .cb-mode-tab { padding: 6px 6px; font-size: 12px; } .cb-mode-tab .cnt { font-size: 10px; } }
    @media(min-width: 500px) { .cb-mode-tab { padding: 7px 10px; font-size: 13px; } .cb-mode-tab .cnt { font-size: 11px; display: inline; } }
    @media(min-width: 768px) { .cb-mode-tab { padding: 8px 14px; font-size: 14px; } .cb-mode-tab .cnt { margin-left: 4px; font-size: 12px; } }
    
    /* æœ‰æ“”ä¿ç²‰ç´…è‰²èƒŒæ™¯ - æ›´é®®æ˜ */
    .cb-table .guar-yes { background: #ffe0ec; color: #c9406a; font-weight: 600; padding: 3px 10px; border-radius: 4px; }
    
    /* å­æ¨™ç±¤ï¼ˆç™¼è¡Œæ¢ä»¶ã€æ™‚ç¨‹ç­‰ï¼‰ */
    .cb-sub-switcher { display: flex; gap: 8px; margin-bottom: 14px; flex-wrap: wrap; }
    .cb-sub-tab { padding: 7px 14px; border-radius: 16px; font-size: 14px; font-weight: 600; cursor: pointer; border: 1px solid var(--clickable-border); background: var(--clickable); color: #333; transition: all 0.2s; }
    .cb-sub-tab:hover { border-color: var(--primary); background: var(--clickable-hover); }
    .cb-sub-tab.active { background: #e67e22; color: #fff; border-color: #e67e22; }
    
    /* çµ±è¨ˆå’Œæ’è¡Œæ¦œä¸¦æ’å®¹å™¨ */
    .cb-stats-row { display: flex; gap: 20px; margin-bottom: 12px; flex-wrap: wrap; align-items: flex-start; }
    .cb-stats-left { flex: 1; min-width: 300px; }
    .cb-stats-right { flex: 1; min-width: 300px; }
    @media(max-width: 700px) { .cb-stats-row { flex-direction: column; } }
    
    /* TOP10 æ’è¡Œæ¦œæŒ‰éˆ• - çµ±ä¸€é«˜åº¦ */
    .cb-top10-btns { display: flex; flex-wrap: wrap; gap: 8px; }
    .cb-top10-btn-line { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 0 16px; background: var(--clickable); border: 1px solid var(--clickable-border); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 15px; font-weight: 600; color: #2c2c2c; height: 56px; }
    .cb-top10-btn-line:hover { border-color: var(--primary); background: var(--clickable-hover); }
    .cb-top10-btn-line.active { background: #27ae60; color: #fff; border-color: #27ae60; }
    .cb-top10-btn-line .top10-icon { font-size: 18px; }
    .cb-top10-btn-line .ind-num { background: rgba(0,0,0,0.1); padding: 3px 10px; border-radius: 10px; font-size: 14px; margin-left: 8px; min-width: 40px; text-align: right; font-family: 'Menlo', 'Monaco', 'Consolas', monospace; white-space: pre; display: inline-block; }
    .cb-top10-btn-line.active .ind-num { background: rgba(255,255,255,0.3); }
    
    /* è¡¨æ ¼ä¸Šæ–¹ç¯©é¸ç‹€æ…‹åˆ— */
    .cb-filter-status { background: linear-gradient(90deg, #fff5e0, #fffbe8); padding: 12px 18px; border-radius: 10px; margin-bottom: 14px; border: 1px solid #ffd080; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
    .cb-filter-status .status-text { font-size: 15px; color: #e65100; font-weight: 600; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .cb-filter-status .status-tag { background: var(--primary); color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 14px; }
    .cb-filter-status .status-count { color: #2c2c2c; }
    .cb-filter-status .status-count b { color: var(--primary); font-size: 18px; }
    .cb-filter-status .status-clear { background: var(--clickable); border: 1px solid var(--clickable-border); color: #555; padding: 6px 14px; border-radius: 16px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
    .cb-filter-status .status-clear:hover { background: #e74c3c; color: #fff; border-color: #e74c3c; }
    
    /* å€å¡Šæ¨™é¡Œ - çµ±ä¸€æ¨£å¼ï¼Œå¢åŠ ä¸Šæ–¹é–“è· */
    .cb-section-title { font-size: 16px; font-weight: 700; color: #2c2c2c; margin: 20px 0 12px; padding-left: 10px; border-left: 4px solid var(--primary); }
    .cb-section-title:first-child { margin-top: 0; }
    
    /* çµ±è¨ˆæ•¸å­—å€ - å°æ–¹æ ¼ï¼Œçµ±ä¸€é«˜åº¦ */
    .cb-stats-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 0; }
    .cb-stat-item { background: #fff; padding: 10px 16px; border-radius: 8px; text-align: center; border: 1px solid #d0d0d0; min-width: 72px; height: 58px; display: flex; flex-direction: column; justify-content: center; box-sizing: border-box; }
    .cb-stat-item.clickable { cursor: pointer; transition: all 0.2s; background: var(--clickable); border-color: var(--clickable-border); }
    .cb-stat-item.clickable:hover { border-color: var(--primary); background: var(--clickable-hover); }
    .cb-stat-item.clickable.active { background: var(--primary); border-color: var(--primary); }
    .cb-stat-num { font-size: 20px; font-weight: 800; color: var(--primary); line-height: 1.2; font-family: 'Menlo', 'Monaco', 'Consolas', monospace; letter-spacing: -1px; }
    .cb-stat-item.clickable.active .cb-stat-num { color: #fff; }
    .cb-stat-label { font-size: 13px; color: #333; margin-top: 3px; font-weight: 600; }
    .cb-stat-item.clickable.active .cb-stat-label { color: rgba(255,255,255,0.95); }
    
    /* ç”¢æ¥­å°æ–¹å¡Š - æ¨™é¡Œçµ±ä¸€æ¨£å¼ï¼Œå¢åŠ ä¸Šæ–¹é–“è· */
    .cb-ind-title { font-size: 16px; font-weight: 700; color: #2c2c2c; margin: 20px 0 12px; padding-left: 10px; border-left: 4px solid var(--primary); }
    .cb-ind-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .cb-ind-tag { padding: 7px 12px; background: var(--clickable); border-radius: 14px; font-size: 14px; color: #333; cursor: pointer; transition: all 0.2s; border: 1px solid var(--clickable-border); font-weight: 500; }
    .cb-ind-tag:hover { border-color: var(--primary); background: var(--clickable-hover); color: var(--primary); }
    .cb-ind-tag.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .cb-ind-tag .num { background: rgba(201,100,66,0.18); color: var(--primary); padding: 2px 8px; border-radius: 8px; font-size: 13px; margin-left: 5px; font-weight: 700; min-width: 36px; display: inline-block; text-align: right; font-family: 'Menlo', 'Monaco', 'Consolas', monospace; white-space: pre; }
    .cb-ind-tag.active .num { background: rgba(255,255,255,0.35); color: #fff; }
    
    /* ç«¶æ‹å‰ååè¡¨æ ¼ */
    .auction-top10-table { overflow-x: auto; margin-bottom: 12px; }
    .auction-top10-table table { width: 100%; border-collapse: collapse; font-size: 15px; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .auction-top10-table th { background: #f5f5f5; padding: 10px 8px; text-align: right; font-weight: 600; color: #444; border-bottom: 2px solid #e0e0e0; white-space: nowrap; }
    .auction-top10-table td { padding: 10px 8px; text-align: right; border-bottom: 1px solid #eee; }
    .auction-top10-table th:nth-child(1), .auction-top10-table td:nth-child(1) { text-align: center; } /* æ’åç½®ä¸­ */
    .auction-top10-table th:nth-child(2), .auction-top10-table td:nth-child(2) { text-align: left; } /* CBä»£è™Ÿé å·¦ */
    .auction-top10-table th:nth-child(3), .auction-top10-table td:nth-child(3) { text-align: left; } /* åç¨±é å·¦ */
    .auction-top10-table tr:hover { background: #fff5e8; }
    .auction-top10-table .code { color: var(--primary); font-weight: 600; cursor: pointer; background: var(--clickable); padding: 3px 8px; border-radius: 4px; }
    .auction-top10-table .code:hover { background: var(--clickable-hover); }
    .auction-top10-table .highlight { color: var(--primary); font-weight: 700; }
    .auction-top10-table .highlight-red { color: #e74c3c; font-weight: 700; }
    .auction-top10-table tfoot { background: #f8f8f8; }
    .auction-top10-table tfoot td { border-top: 2px solid #d0d0d0; font-weight: 600; }
    
    /* æµé€šé¤˜é¡å‰ååè¡¨æ ¼ */
    .balance-top10-table { overflow-x: auto; margin-bottom: 12px; }
    .balance-top10-table table { width: 100%; border-collapse: collapse; font-size: 14px; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .balance-top10-table th { background: #f5f5f5; padding: 10px 6px; text-align: center; font-weight: 600; color: #444; border-bottom: 2px solid #e0e0e0; white-space: nowrap; font-size: 13px; }
    .balance-top10-table td { padding: 8px 6px; text-align: center; border-bottom: 1px solid #eee; font-size: 13px; }
    .balance-top10-table tr:hover { background: #fff5e8; }
    .balance-top10-table .code { color: var(--primary); font-weight: 600; cursor: pointer; background: var(--clickable); padding: 3px 8px; border-radius: 4px; }
    .balance-top10-table .code:hover { background: var(--clickable-hover); }
    .balance-top10-table .name-cell { text-align: left; min-width: 90px; max-width: 130px; white-space: normal; line-height: 1.4; }
    .balance-top10-table .highlight-red { color: #e74c3c; font-weight: 700; }
    
    /* æµé€šé¤˜é¡ä¸»è¡¨æ ¼æ¬„å¯¬ç¸®æ¸› */
    .cb-table.balance-table { font-size: 13px; }
    .cb-table.balance-table th, .cb-table.balance-table td { padding: 8px 6px; }
    .cb-table.balance-table .name-col { max-width: 100px; white-space: normal; line-height: 1.4; text-align: left; }
    
    /* ä¸»æ—¨æ¬„ä½ */
    .cb-table .subject-col { text-align: left; font-size: 13px; line-height: 1.5; max-width: 320px; white-space: normal; }
    .cb-table .name-col { max-width: 110px; white-space: normal; line-height: 1.4; text-align: left; }

    .card-list { display: flex; flex-direction: column; gap: 14px; }
    @media(min-width: 1024px) { .card-list:not(.cb-mode) { display: grid; grid-template-columns: repeat(2, 1fr); } }
    @media(min-width: 1400px) { .card-list:not(.cb-mode) { grid-template-columns: repeat(3, 1fr); } }
    .card-list.cb-mode { display: block; }
    .card { background: var(--clickable); padding: 18px; border-radius: 14px; border: 1px solid var(--clickable-border); box-shadow: 0 2px 8px rgba(0,0,0,0.04); cursor: pointer; transition: all 0.2s; }
    .card:hover { border-color: var(--primary); background: var(--clickable-hover); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
    .card.industry-card { border-left: 5px solid #9b59b6; background: linear-gradient(135deg, #faf8fc 0%, var(--clickable) 100%); }
    .card-head { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .card-title { font-weight: 700; font-size: 18px; color: #2c3e50; }
    .card-meta { display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; }
    .tag { font-size: 13px; padding: 3px 10px; border-radius: 6px; color: #fff; font-weight: 500; }
    .tag.brk { background: var(--primary); }
    .tag.ind { background: #2980b9; }
    .tag.trend-ind { background: #8e44ad; }
    .tag.dt { background: #d5d5d5; color: #555; }
    .tag.concept { background: #8e44ad; }
    .tag.trend-up { background: #27ae60; }
    .tag.trend-down { background: #e74c3c; }
    .tag.cb-tag { background: #e74c3c; font-size: 12px; padding: 2px 8px; }
    .cb-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-left: auto; }
    .card-head { display: flex; align-items: center; gap: 10px; }
    .news-type { font-size: 12px; padding: 3px 8px; border-radius: 4px; margin-right: 8px; font-weight: 600; }
    .news-type.ind-type { background: #9b59b6; color: #fff; }
    
    /* CB åŸºæœ¬è³‡æ–™å­æ¨™ç±¤ */
    .cb-info-tabs { display: flex; gap: 10px; margin: 12px 0; flex-wrap: wrap; }
    .cb-table tr.active-cb td { background: #e5f5e8; }
    .cb-table tr.active-cb:hover td { background: #c5e8ca; }
    
    /* çµæœåˆ—å’Œ CB ç¯©é¸æ¨™ç±¤ */
    .result-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; margin-bottom: 12px; }
    .cb-filter-tags { display: flex; flex-wrap: wrap; gap: 8px; }
    .cb-filter-tag { font-size: 13px; padding: 5px 12px; border-radius: 16px; cursor: pointer; border: 1px solid var(--clickable-border); background: var(--clickable); transition: all 0.2s; }
    .cb-filter-tag:hover { border-color: var(--primary); background: var(--clickable-hover); }
    .cb-filter-tag.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .cb-filter-tag .cnt { margin-left: 5px; opacity: 0.75; }
    .card-body { font-size: 15px; color: #444; line-height: 1.7; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

    /* CB åˆ—è¡¨è¡¨æ ¼ */
    .cb-table-wrap { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .cb-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 15px; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .cb-table th { background: #f5f5f5; padding: 14px 10px; text-align: center; color: #444; font-weight: 600; border-bottom: 2px solid #e0e0e0; white-space: nowrap; }
    .cb-table td { padding: 12px 10px; border-bottom: 1px solid #eee; text-align: center; white-space: nowrap; }
    .cb-table tr:hover td { background: #fff8f0; }
    .cb-table .code { color: var(--primary); font-weight: 600; cursor: pointer; background: var(--clickable); padding: 4px 8px; border-radius: 4px; }
    .cb-table .code:hover { background: var(--clickable-hover); }
    .cb-table .stock { color: var(--primary); cursor: pointer; background: var(--clickable); padding: 4px 8px; border-radius: 4px; }
    .cb-table .stock:hover { background: var(--clickable-hover); }
    .cb-table th.sortable { cursor: pointer; user-select: none; }
    .cb-table th.sortable:hover { background: #eaeaea; }
    .cb-table th .sort-icon { font-size: 12px; color: #888; margin-left: 3px; }
    .cb-table th.sort-asc .sort-icon { color: var(--primary); }
    .cb-table th.sort-desc .sort-icon { color: var(--primary); }
    .cb-table th.sort-asc .sort-icon::after { content: 'â†‘'; }
    .cb-table th.sort-desc .sort-icon::after { content: 'â†“'; }
    .cb-table tfoot { background: #f5f5f5; }
    .cb-table tfoot td { border-top: 2px solid #d0d0d0; padding: 14px 10px; }
    
    /* CBAS è¡¨æ ¼ç‰¹æ®Šæ¨£å¼ - æœ‰æ“”ä¿æ¨™è¨˜ */
    .guarantee-yes { 
        display: inline-block;
        padding: 2px 8px;
        background: #fff5f5;
        border: 1px solid #ffcccc;
        border-radius: 4px;
        color: #c96442;
        font-weight: 600;
    }
    /* CBAS è¡¨æ ¼ç‰¹æ®Šæ¨£å¼ - ç«¶æ‹æ•´è¡Œæ¨™è¨˜ */
    .cb-table tr.auction-row td {
        background: #fff8f5 !important;
    }
    .cb-table tr.auction-row:hover td {
        background: #fff0e8 !important;
    }
    
    /* åŸºæœ¬è³‡æ–™è¡¨æ ¼æ¨™é¡Œ */
    .cb-info-section { margin-bottom: 20px; }
    .cb-info-title { display: flex; align-items: center; gap: 8px; padding: 12px 15px; background: linear-gradient(135deg, #fff5f0 0%, #fff 100%); border-radius: 10px 10px 0 0; border: 1px solid #ffe0d0; border-bottom: none; }
    .cb-info-title .icon { font-size: 20px; }
    .cb-info-title .text { font-size: 15px; font-weight: 700; color: var(--primary); }
    .cb-info-title .count { font-size: 12px; color: #888; margin-left: auto; }
    
    /* è¡¨æ ¼é–å®šå‰ä¸‰æ¬„ - æ‰€æœ‰è£ç½® */
    .cb-table.sticky-cols th.sticky-col,
    .cb-table.sticky-cols td.sticky-col { position: sticky; z-index: 2; }
    .cb-table.sticky-cols th.sticky-col { z-index: 3; }
    .cb-table.sticky-cols .sticky-col-1 { left: 0; background: #f8f9fa; min-width: 65px; }
    .cb-table.sticky-cols td.sticky-col-1 { background: #fff; }
    .cb-table.sticky-cols tr:hover td.sticky-col-1 { background: #fffaf8; }
    .cb-table.sticky-cols tr.active-cb td.sticky-col-1 { background: #e8f5e9; }
    .cb-table.sticky-cols .sticky-col-2 { left: 65px; background: #f8f9fa; min-width: 70px; max-width: 80px; white-space: normal; line-height: 1.2; }
    .cb-table.sticky-cols td.sticky-col-2 { background: #fff; }
    .cb-table.sticky-cols tr:hover td.sticky-col-2 { background: #fffaf8; }
    .cb-table.sticky-cols tr.active-cb td.sticky-col-2 { background: #e8f5e9; }
    .cb-table.sticky-cols .sticky-col-3 { left: 135px; background: #f8f9fa; min-width: 50px; border-right: 2px solid #ddd; }
    .cb-table.sticky-cols td.sticky-col-3 { background: #fff; border-right: 2px solid #eee; }
    .cb-table.sticky-cols tr:hover td.sticky-col-3 { background: #fffaf8; }
    .cb-table.sticky-cols tr.active-cb td.sticky-col-3 { background: #e8f5e9; }
    
    /* è¡¨æ ¼åªé–å®šå‰å…©æ¬„ - ç”¨æ–¼CBåŸºæœ¬è³‡æ–™è¡¨æ ¼ */
    .cb-table.sticky-2cols th.sticky-col,
    .cb-table.sticky-2cols td.sticky-col { position: sticky; z-index: 2; }
    .cb-table.sticky-2cols th.sticky-col { z-index: 3; }
    .cb-table.sticky-2cols .sticky-col-1 { left: 0; background: #f8f9fa; min-width: 65px; }
    .cb-table.sticky-2cols td.sticky-col-1 { background: #fff; }
    .cb-table.sticky-2cols tr:hover td.sticky-col-1 { background: #fffaf8; }
    .cb-table.sticky-2cols tr.active-cb td.sticky-col-1 { background: #e8f5e9; }
    .cb-table.sticky-2cols .sticky-col-2 { left: 65px; background: #f8f9fa; min-width: 70px; max-width: 90px; white-space: normal; line-height: 1.2; border-right: 2px solid #ddd; }
    .cb-table.sticky-2cols td.sticky-col-2 { background: #fff; border-right: 2px solid #eee; }
    .cb-table.sticky-2cols tr:hover td.sticky-col-2 { background: #fffaf8; }
    .cb-table.sticky-2cols tr.active-cb td.sticky-col-2 { background: #e8f5e9; }
    
    /* CBAS æ“”ä¿æ¬„ä½æ¨£å¼ */
    .guarantee-yes { background: #fff5f5; border: 1px solid #ffcccc; border-radius: 4px; padding: 2px 6px; color: #c96442; font-weight: 600; }
    .guarantee-no { color: #999; }
    
    /* æ‰‹æ©Ÿç‰ˆ */
    @media(max-width: 768px) {
        .cb-table { font-size: 14px; }
        .cb-table th, .cb-table td { padding: 10px 6px; }
        .cb-table .hide-mobile { display: none; }
    }
    
    /* æ¡Œæ©Ÿç‰ˆæ»¿ç‰ˆ */
    @media(min-width: 1024px) {
        .cb-table { font-size: 16px; }
        .cb-table th, .cb-table td { padding: 14px 12px; }
    }

    /* Modal */
    .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
    .modal.show { display: flex; }
    .modal-inner { background: #fff; width: 100%; max-width: 650px; height: 92vh; border-radius: 16px 16px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
    @media(min-width: 1024px) { .modal-inner { max-width: 900px; } }
    @media(min-width: 1400px) { .modal-inner { max-width: 1100px; } }
    @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
    
    .m-head { padding: 18px; border-bottom: 1px solid #e5e5e5; display: flex; justify-content: space-between; align-items: flex-start; }
    .m-close { width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--clickable-border); background: var(--clickable); font-size: 22px; color: #555; cursor: pointer; display: flex; justify-content: center; align-items: center; flex-shrink: 0; transition: all 0.2s; }
    .m-close:hover { background: var(--clickable-hover); border-color: var(--primary); color: var(--primary); }
    
    .nav-grid { display: flex; gap: 6px; padding: 12px 18px; background: #f8f8f8; border-bottom: 1px solid #e5e5e5; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .nav-btn { padding: 8px 14px; border-radius: 8px; border: 1px solid var(--clickable-border); background: var(--clickable); font-size: 14px; font-weight: 600; color: #555; cursor: pointer; white-space: nowrap; transition: all 0.2s; flex-shrink: 0; }
    .nav-btn:hover { border-color: var(--primary); background: var(--clickable-hover); }
    .nav-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

    .m-body { flex: 1; overflow-y: auto; padding: 18px; background: #fff; -webkit-overflow-scrolling: touch; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    
    .m-footer-tags { padding: 14px 18px; border-top: 1px solid #e5e5e5; background: #f8f8f8; display: none; }
    .m-footer-tags.show { display: block; }
    .m-footer-tags .tags-wrap { display: flex; flex-wrap: wrap; gap: 8px; }
    .m-footer-tags .tag { padding: 8px 14px; font-size: 14px; cursor: pointer; transition: all 0.2s; background: var(--clickable); border: 1px solid var(--clickable-border); border-radius: 8px; }
    .m-footer-tags .tag:hover { transform: scale(1.05); background: var(--clickable-hover); }

    .section-head { font-size: 16px; font-weight: 700; color: #333; margin: 24px 0 12px; padding: 10px 14px; background: linear-gradient(90deg, #f5f5f5, transparent); border-left: 5px solid var(--primary); border-radius: 0 10px 10px 0; }
    .section-head:first-child { margin-top: 0; }
    .hl-block { background: #faf8f5; padding: 14px; border-radius: 10px; border-left: 5px solid var(--primary); margin-bottom: 12px; font-size: 15px; line-height: 1.8; white-space: pre-wrap; }
    .hl-block b { color: var(--primary); }
    .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; font-size: 16px; }
    .info-label { color: #555; }
    .info-val { font-weight: 600; color: #2c2c2c; }
    
    .list-item { padding: 14px; border: 1px solid var(--clickable-border); border-radius: 12px; margin-bottom: 10px; background: var(--clickable); cursor: pointer; transition: all 0.2s; }
    .list-item:hover { border-color: var(--primary); background: var(--clickable-hover); }
    .list-title { font-weight: 700; font-size: 16px; color: #2c3e50; margin-bottom: 5px; }
    .list-sub { font-size: 14px; color: #777; margin-bottom: 8px; }
    .list-content { font-size: 15px; color: #444; line-height: 1.7; white-space: pre-wrap; }

    .tag-link { color: var(--primary); cursor: pointer; font-weight: 600; background: var(--clickable); padding: 2px 8px; border-radius: 4px; }
    .tag-link:hover { background: var(--clickable-hover); text-decoration: underline; }
    
    .fin-switcher { display: flex; margin-bottom: 12px; border: 1px solid var(--clickable-border); border-radius: 8px; overflow: hidden; }
    .fin-btn { flex: 1; padding: 8px; text-align: center; font-size: 13px; color: var(--primary); background: var(--clickable); cursor: pointer; font-weight: 600; border-right: 1px solid var(--clickable-border); transition: all 0.2s; }
    .fin-btn:last-child { border-right: none; }
    .fin-btn:hover { background: var(--clickable-hover); }
    .fin-btn.active { background: var(--primary); color: #fff; }
    .fin-sub-pane { display: none; }
    .fin-sub-pane.active { display: block; }
    
    .rev-unit { text-align: right; font-size: 11px; color: #888; margin-bottom: 8px; }

    .table-wrap { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
    .fin-table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
    .fin-table th { background: #f8f9fa; padding: 10px 8px; border-bottom: 2px solid #ddd; text-align: right; color: #555; position: sticky; top: 0; }
    .fin-table td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: right; color: #333; }
    .fin-table th:first-child, .fin-table td:first-child { position: sticky; left: 0; background: #fff; border-right: 1px solid #eee; text-align: left; z-index: 2; font-weight: 700; }
    .fin-table tr:nth-child(even) td { background: #fcfcfc; }
    .fin-table tr:nth-child(even) td:first-child { background: #fcfcfc; }
    .fin-table .highlight-row td { background: #fff3e0; font-weight: 700; }
    .fin-table .highlight-row td:first-child { background: #fff3e0; color: var(--primary); }
    
    .t-up { color: var(--up); font-weight: 700; }
    .t-down { color: var(--down); font-weight: 700; }

    .rating-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
    .rating-card .big-num { font-size: 28px; font-weight: 800; }
    .rating-card .label { font-size: 12px; opacity: 0.8; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
    @media(max-width: 480px) { .grid-3, .grid-4 { grid-template-columns: repeat(2, 1fr); } }
    
    /* å½ˆçª—ä¹å®®æ ¼å¡ç‰‡ */
    .modal-card-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
    @media(max-width: 500px) { .modal-card-grid { grid-template-columns: repeat(2, 1fr); } }
    .modal-card { background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%); border: 1px solid #e8e8e8; border-radius: 10px; padding: 12px; text-align: center; }
    .modal-card .val { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 4px; }
    .modal-card .lbl { font-size: 11px; color: #888; }
    .modal-card.highlight { background: linear-gradient(135deg, #fff5f0 0%, #fff 100%); border-color: var(--primary); }
    .modal-card.highlight .val { font-size: 22px; }
    
    /* å½ˆçª—è³‡è¨Šå€å¡Š */
    .modal-info-block { background: #fafafa; border-radius: 10px; padding: 15px; margin-bottom: 12px; }
    .modal-info-block .title { font-size: 13px; font-weight: 600; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
    .modal-info-block .content { display: flex; flex-wrap: wrap; gap: 8px 20px; }
    .modal-info-block .item { font-size: 13px; }
    .modal-info-block .item .label { color: #888; }
    .modal-info-block .item .value { font-weight: 600; color: #333; margin-left: 6px; }
    .stat-box { background: #f8f9fa; padding: 12px; text-align: center; border-radius: 8px; }
    .stat-box .num { font-size: 18px; font-weight: 700; color: var(--primary); }
    .stat-box .lbl { font-size: 11px; color: #888; margin-top: 2px; }

    .qa-item { margin-bottom: 15px; }
    .qa-q { background: #e3f2fd; padding: 10px 12px; border-radius: 8px 8px 0 0; font-weight: 600; color: #1565c0; font-size: 13px; }
    .qa-a { background: #f5f5f5; padding: 10px 12px; border-radius: 0 0 8px 8px; font-size: 13px; line-height: 1.6; color: #444; }

    .timeline-item { position: relative; padding-left: 20px; margin-bottom: 12px; }
    .timeline-item::before { content: ''; position: absolute; left: 0; top: 8px; width: 10px; height: 10px; background: var(--primary); border-radius: 50%; }
    .timeline-item::after { content: ''; position: absolute; left: 4px; top: 20px; width: 2px; height: calc(100% + 4px); background: #e0e0e0; }
    .timeline-item:last-child::after { display: none; }
    .timeline-date { font-size: 12px; font-weight: 700; color: var(--primary); }
    .timeline-text { font-size: 13px; color: #444; margin-top: 2px; }

    @media(min-width: 768px) { .modal { align-items: center; } .modal-inner { height: 85vh; border-radius: 16px; } }
    @media(max-width: 480px) { .cb-stats-grid { grid-template-columns: repeat(3, 1fr); } .cb-stat-num { font-size: 18px; } }
</style>

</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="loading-spinner"></div>
    <div style="font-weight:700;font-size:18px">Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</div>
    <div style="font-size:12px;color:#888;margin-top:8px" id="loadStatus">æ­£åœ¨è¼‰å…¥è³‡æ–™åº«...</div>
</div>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
        <p style="font-size:12px;color:#666">å…¨æ–¹ä½å°è‚¡æŠ•è³‡æ±ºç­–ç³»çµ± v11.6</p>
    </div>
<div class="db-switcher">
    <div class="db-tab active" data-db="news">âš¡ å¤–é›» <span class="count" id="c-news">0</span></div>
    <div class="db-tab" data-db="memo">ğŸ“‹ Memo <span class="count" id="c-memo">0</span></div>
    <div class="db-tab" data-db="reports">ğŸ“‘ ç”¢æ¥­ <span class="count" id="c-reports">0</span></div>
    <div class="db-tab" data-db="strategy">ğŸ”® å±•æœ› <span class="count" id="c-strategy">0</span></div>
    <div class="db-tab" data-db="stocks">ğŸ¢ å€‹è‚¡ <span class="count" id="c-stocks">0</span></div>
    <div class="db-tab" data-db="trends">ğŸ“ˆ è¶¨å‹¢ <span class="count" id="c-trends">0</span></div>
    <div class="db-tab" data-db="cb">ğŸ« CB <span class="count" id="c-cb">0</span></div>
</div>

<div class="search-box">
    <span class="search-icon">ğŸ”</span>
    <input type="text" class="search-input" id="search" placeholder="æœå°‹å…¬å¸ã€ä»£è™Ÿã€ç”¢æ¥­ã€#Tag..." oninput="handleInput(this)">
    <div class="clear-btn" id="clearBtn" onclick="clearSearch()">âœ•</div>
</div>

<!-- CB çµ±è¨ˆå€å¡Š (åªåœ¨ CB åˆ†é é¡¯ç¤º) -->
<div id="cbStatsArea" style="display:none"></div>

<!-- å€‹è‚¡çµ±è¨ˆå€å¡Š (åªåœ¨å€‹è‚¡åˆ†é é¡¯ç¤º) -->
<div id="stockStatsArea" style="display:none"></div>

<!-- Memo çµ±è¨ˆå€å¡Š (åªåœ¨ Memo åˆ†é é¡¯ç¤º) -->
<div id="memoStatsArea" style="display:none"></div>

<div class="result-bar">
    <div style="font-size:15px;color:#333;font-weight:600;">æ‰¾åˆ° <b id="resCount" style="color:var(--primary);font-size:18px;">0</b> ç­†è³‡æ–™ <span id="filterHint" style="font-size:13px;color:#e65100;margin-left:8px;"></span></div>
</div>
<div class="card-list" id="list"></div>

</div>

<div class="modal" id="modal" onclick="closeModal(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">
        <div class="m-head">
            <div id="m-info" style="flex:1"></div>
            <button class="m-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="nav-grid" id="navGrid"></div>
        <div class="m-body" id="m-body"></div>
        <div class="m-footer-tags" id="m-tags"></div>
    </div>
</div>

<script>
const FILES = {
    NEWS: '01_news.xlsx', MEMO: '02_memo.xlsx', REPORTS: '03_reports.xlsx',
    MASTER: '04_master.xlsx', STRAT: '05_Strategy_01.xlsx', CB: '00_CB.xlsx', REV: '06_revenue.xlsx',
    AUCTION: '10_auction.xlsx'
};

const DB = { 
    news:[], memo:[], memoStock:[], memoIndustry:[], reports:[], strategy:[], stocks:{}, 
    cb:[], cbHistory:[], cbAuction:[], cbPrimary:[], cbBoard:[], cbBalance:[], cbCBAS:[],
    cbRedeem:[], cbStopConv:[], cbPriceAdj:[], cbConcept:[], cbAll:[],
    conceptLists: {}, // å„æ¦‚å¿µè‚¡æ¸…å–® { 'NVDIAæ¦‚å¿µè‚¡': ['6579','2353',...], ... }
    trends:[], conceptStocks:[],
    auctionDetail: {} // ç«¶æ‹æ˜ç´°è³‡æ–™ { 'CBä»£è™Ÿ': { basic:{}, stats:{}, top10:[], intervals:[], details:[] } }
};
let CB_MODE = 'info'; // 'info' åŸºæœ¬è³‡æ–™, 'active' æ›ç‰Œä¸­, 'history' æ­·å², 'auction' ç«¶æ‹, 'primary' åˆç´šå¸‚å ´, 'balance' æµé€šé¤˜é¡, 'cbas' CBASå ±åƒ¹
let CB_INFO_TAB = 'issue'; // 'issue' ç™¼è¡Œæ¢ä»¶, 'timeline' æ™‚ç¨‹è³‡è¨Š, 'putback' è³£å›æ¢ä»¶, 'convert' è½‰æ›åˆ†æ
let PRIMARY_MODE = 'underwriting'; // 'underwriting' æ‰¿éŠ·ä¸­, 'auction' è¿‘æœŸç«¶æ‹, 'board' è‘£äº‹æœƒå…¬å‘Š
let AUCTION_TOP10 = ''; // ç«¶æ‹TOP10é¸æ“‡: 'guar_low' æœ‰æ“”ä¿æœ€ä½, 'no_guar_low' ç„¡æ“”ä¿æœ€ä½, 'guar_avg' æœ‰æ“”ä¿å¹³å‡, 'no_guar_avg' ç„¡æ“”ä¿å¹³å‡
let AUCTION_TAB = 'basic'; // ç«¶æ‹å°ˆå€æ¨™ç±¤: 'basic' åŸºæœ¬è³‡æ–™, 'bid' æŠ•æ¨™çµ±è¨ˆ, 'result' å¾—æ¨™çµæœ, 'list' æ›ç‰Œè¡Œæƒ…, 'detail' å¾—æ¨™æ˜ç´°
let AUCTION_DETAIL_DATA = []; // ç«¶æ‹æ˜ç´°åŸå§‹è³‡æ–™
let AUCTION_DETAIL_SORT = { field: 'seq', dir: 'asc' }; // ç«¶æ‹æ˜ç´°æ’åºç‹€æ…‹
let STOCK_MODE = 'all'; // 'all' å…¨éƒ¨å€‹è‚¡, 'concept' æ¦‚å¿µè‚¡
let MEMO_MODE = 'all'; // 'all' å…¨éƒ¨, 'stock' å€‹è‚¡, 'industry' ç”¢æ¥­

// CB äº¤é›†ç¯©é¸ç‹€æ…‹
let CB_FILTER = {
    industry: '',   // ç”¢æ¥­ç¯©é¸
    guarantee: '',  // æ“”ä¿ç¯©é¸ ('æœ‰æ“”ä¿' / 'ç„¡æ“”ä¿')
    status: ''      // æ›ç‰Œç‹€æ…‹ ('active' / 'delisted')
};
const META = { 
    memoDetail:{}, tracking:{}, finance:{}, products:{}, 
    concepts:{}, cbMap:{}, relatedNews:{}, relatedMemo:{},
    reportFocus:{}, reportViews:{}, reportRatings:{},
    stratMacro:{}, stratFundamental:{}, stratTheme:{}, stratChip:{}, stratTech:{}, stratQuarter:{}, stratPicks:{},
    revData: { month:{}, quarter:{}, year:{}, highlights:{} },
    cbStats: { total: 0, companies: 0, industries: {}, totalBalance: 0 },
    cbPrimaryStats: { underwriting: 0, board: 0 },
    cbBalanceStats: { total: 0, totalBalance: 0 },
    cbCBASStats: { total: 0 },
    stockStats: { total: 0, conceptTotal: 0, markets: {}, industries: {}, conceptCategories: {} },
    memoStats: { total: 0, stockTotal: 0, industryTotal: 0, brokers: {}, types: {} }
};

let CURR_DB = 'news';
const $ = id => document.getElementById(id);
const safe = v => (v==null||v==undefined?'':String(v).trim());
const padNum = n => String(n).padStart(4, '\u00A0'); // æ•¸å­—è£œé½Š4ä½å°é½Šï¼ˆç”¨ä¸é–“æ–·ç©ºæ ¼ï¼‰

// çµ±ä¸€ä»£ç¢¼è™•ç†å‡½æ•¸
const normalizeCode = v => {
    if(!v) return '';
    let s = String(v).trim();
    // ç§»é™¤ .0 (Excel æ•¸å­—æ ¼å¼)
    if(s.match(/^\d+\.0$/)) s = s.replace('.0', '');
    // ç§»é™¤ TT å¾Œç¶´
    s = s.replace(/\s*TT$/i, '');
    // è£œé›¶åˆ°4ä½
    if(s.match(/^\d{1,4}$/) && s.length < 4) s = s.padStart(4, '0');
    return s;
};

const fmtDate = v => {
    if(!v) return '';
    if(typeof v === 'number' && v > 20000) { 
        const d = new Date((v-25569)*86400000); 
        return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`; 
    }
    return String(v).split(' ')[0].split('T')[0];
};
const getDateVal = v => { if(!v) return 0; if(typeof v === 'number') return (v-25569)*86400000; return new Date(v).getTime(); };
const fmtNum = (v, decimal=0) => {
    if(v===undefined||v===null||v==='') return '-';
    let n = parseFloat(String(v).replace(/,/g,''));
    if(isNaN(n)) return v;
    return decimal > 0 ? n.toFixed(decimal) : n.toLocaleString();
};
const colorClass = v => {
    if(!v||v==='-') return '';
    let n = parseFloat(String(v).replace(/[%$,]/g,''));
    return n>0?'t-up':n<0?'t-down':'';
};

// ç”¢æ¥­ emoji æ˜ å°„
const industryEmoji = ind => {
    const emojiMap = {
        'åŠå°é«”': 'ğŸ”¬', 'åŠå°é«”æ¥­': 'ğŸ”¬',
        'é›»å­é›¶çµ„ä»¶': 'ğŸ”©', 'é›»å­é›¶çµ„ä»¶æ¥­': 'ğŸ”©',
        'é›»è…¦åŠé€±é‚Š': 'ğŸ’»', 'é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­': 'ğŸ’»',
        'å…‰é›»': 'ğŸ’¡', 'å…‰é›»æ¥­': 'ğŸ’¡',
        'é€šä¿¡ç¶²è·¯': 'ğŸ“¡', 'é€šä¿¡ç¶²è·¯æ¥­': 'ğŸ“¡',
        'é›»å­é€šè·¯': 'ğŸ”Œ', 'é›»å­é€šè·¯æ¥­': 'ğŸ”Œ',
        'è³‡è¨Šæœå‹™': 'ğŸ–¥ï¸', 'è³‡è¨Šæœå‹™æ¥­': 'ğŸ–¥ï¸',
        'å…¶ä»–é›»å­': 'ğŸ“Ÿ', 'å…¶ä»–é›»å­æ¥­': 'ğŸ“Ÿ', 'å…¶ä»–æ¥­é›»å­æ¥­': 'ğŸ“Ÿ',
        'ç”ŸæŠ€é†«ç™‚': 'ğŸ’Š', 'ç”ŸæŠ€é†«ç™‚æ¥­': 'ğŸ’Š',
        'åŒ–å·¥': 'ğŸ§ª', 'åŒ–å­¸å·¥æ¥­': 'ğŸ§ª',
        'å¡‘è† ': 'â™»ï¸', 'å¡‘è† å·¥æ¥­': 'â™»ï¸',
        'é‹¼éµ': 'ğŸ”§', 'é‹¼éµå·¥æ¥­': 'ğŸ”§',
        'é›»æ©Ÿæ©Ÿæ¢°': 'âš™ï¸',
        'æ±½è»Š': 'ğŸš—', 'æ±½è»Šå·¥æ¥­': 'ğŸš—',
        'å»ºæç‡Ÿé€ ': 'ğŸ—ï¸', 'å»ºæç‡Ÿé€ æ¥­': 'ğŸ—ï¸',
        'èˆªé‹': 'ğŸš¢', 'èˆªé‹æ¥­': 'ğŸš¢',
        'è§€å…‰é¤æ—…': 'ğŸ¨',
        'è²¿æ˜“ç™¾è²¨': 'ğŸ›’', 'è²¿æ˜“ç™¾è²¨æ¥­': 'ğŸ›’',
        'é‡‘èä¿éšª': 'ğŸ¦', 'é‡‘æ§æ¥­': 'ğŸ¦', 'éŠ€è¡Œæ¥­': 'ğŸ¦', 'è­‰åˆ¸æ¥­': 'ğŸ¦',
        'é£Ÿå“': 'ğŸœ', 'é£Ÿå“å·¥æ¥­': 'ğŸœ',
        'ç´¡ç¹”çº–ç¶­': 'ğŸ‘”',
        'é›»å™¨é›»çºœ': 'ğŸ”‹',
        'é€ ç´™': 'ğŸ“„', 'é€ ç´™å·¥æ¥­': 'ğŸ“„',
        'æ©¡è† ': 'â­•', 'æ©¡è† å·¥æ¥­': 'â­•',
        'ç»ç’ƒé™¶ç“·': 'ğŸº',
        'æ°´æ³¥': 'ğŸ§±', 'æ°´æ³¥å·¥æ¥­': 'ğŸ§±',
        'æ²¹é›»ç‡ƒæ°£': 'â›½', 'æ²¹é›»ç‡ƒæ°£æ¥­': 'â›½',
        'ç¶ èƒ½ç’°ä¿': 'ğŸŒ±',
        'æ•¸ä½é›²ç«¯': 'â˜ï¸',
        'å±…å®¶ç”Ÿæ´»': 'ğŸ ',
        'é‹å‹•ä¼‘é–’': 'âš½',
        'æ–‡åŒ–å‰µæ„': 'ğŸ¨', 'æ–‡åŒ–å‰µæ„æ¥­': 'ğŸ¨',
        'è¾²æ¥­ç§‘æŠ€': 'ğŸŒ¾', 'è¾²æ¥­ç§‘æŠ€æ¥­': 'ğŸŒ¾',
        'å…¶ä»–': 'ğŸ“¦', 'å…¶ä»–æ¥­': 'ğŸ“¦'
    };
    return emojiMap[ind] || 'ğŸ“Œ';
};

const fmtTxt = t => {
    if(!t) return '';
    let html = safe(t).replace(/\n/g, '<br>');
    html = html.replace(/#(\S+)/g, '<span class="tag-link" onclick="setSearch(\'#$1\');closeModal()">#$1</span>');
    return html;
};

// è§£æè³£å›æ¢ä»¶ä¸¦è¨ˆç®—è³£å›åƒ¹æ ¼
// æ ¼å¼ç¯„ä¾‹: ytp(2,3)=(1.75%) è¡¨ç¤ºç¬¬2å¹´å’Œç¬¬3å¹´å¯è³£å›ï¼Œå¹´åˆ©ç‡1.75%
const parsePutbackCondition = condition => {
    if(!condition) return { rate: null, years: [], prices: [] };
    
    const result = { rate: null, years: [], prices: [] };
    
    // è§£æåˆ©ç‡ï¼Œæ”¯æ´å¤šç¨®æ ¼å¼ï¼š(1.75%)ã€=1.75%ã€1.75%
    const rateMatch = condition.match(/[=\(]?\s*([\d.]+)\s*%\s*\)?/);
    if(rateMatch) {
        result.rate = parseFloat(rateMatch[1]);
    }
    
    // è§£æå¹´æœŸï¼Œæ ¼å¼ï¼š(2,3) æˆ– (2ã€3) æˆ– (2.3)
    const yearsMatch = condition.match(/\((\d+)[,ã€.](\d+)\)/);
    if(yearsMatch) {
        result.years = [parseInt(yearsMatch[1]), parseInt(yearsMatch[2])];
    } else {
        // å˜—è©¦è§£æå–®ä¸€å¹´æœŸ (3)
        const singleYearMatch = condition.match(/\((\d+)\)/);
        if(singleYearMatch && result.rate) {
            result.years = [parseInt(singleYearMatch[1])];
        }
    }
    
    // è¨ˆç®—è³£å›åƒ¹æ ¼ï¼š100 * (1 + rate/100)^year
    if(result.rate !== null && result.years.length > 0) {
        const r = 1 + result.rate / 100;
        result.prices = result.years.map(y => 100 * Math.pow(r, y));
    }
    
    return result;
};

function handleInput(el) { 
    $('clearBtn').style.display = el.value.length > 0 ? 'block' : 'none'; 
    renderList(); 
}
function clearSearch() { 
    $('search').value=''; 
    $('search').focus(); 
    $('clearBtn').style.display='none'; 
    // æ¸…é™¤ç¯©é¸æ¢ä»¶
    CB_FILTER.industry = '';
    CB_FILTER.guarantee = '';
    renderList(); 
}
window.setSearch = term => { $('search').value = term; handleInput($('search')); };

async function fetchXlsx(url) {
    try {
        $('loadStatus').innerText = `è¼‰å…¥ ${url}...`;
        const res = await fetch(url);
        if(!res.ok) throw new Error();
        return XLSX.read(await res.arrayBuffer(), {type:'array'});
    } catch(e) { console.warn('Load Error:', url); return null; }
}

async function init() {
  try {
    let wb;
    
    // 1. Master + æ¦‚å¿µè‚¡
    wb = await fetchXlsx(FILES.MASTER);
    if(wb) {
        // ä¸»è³‡æ–™åº«
        XLSX.utils.sheet_to_json(wb.Sheets['ä¸»è³‡æ–™åº«']||[]).forEach(r => {
            const code = normalizeCode(r['ä»£è™Ÿ']);
            if(code) {
                DB.stocks[code] = {...r, 'ä»£è™Ÿ': code};
                // çµ±è¨ˆå¸‚å ´å’Œç”¢æ¥­
                const market = r['å¸‚å ´åˆ†é¡'] || 'å…¶ä»–';
                const industry = r['ç”¢æ¥­åˆ†é¡'] || 'å…¶ä»–';
                META.stockStats.markets[market] = (META.stockStats.markets[market] || 0) + 1;
                META.stockStats.industries[industry] = (META.stockStats.industries[industry] || 0) + 1;
            }
        });
        META.stockStats.total = Object.keys(DB.stocks).length;
        
        // æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«
        const csSheet = wb.Sheets['ğŸ’¡æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«'];
        if(csSheet) {
            const range = XLSX.utils.decode_range(csSheet['!ref']);
            for(let R=3; R<=range.e.r; R++) {
                const code = normalizeCode(csSheet[XLSX.utils.encode_cell({r:R,c:0})]?.v);
                const name = csSheet[XLSX.utils.encode_cell({r:R,c:1})]?.v;
                const concept = csSheet[XLSX.utils.encode_cell({r:R,c:2})]?.v;
                const subCat = csSheet[XLSX.utils.encode_cell({r:R,c:3})]?.v;
                const desc = csSheet[XLSX.utils.encode_cell({r:R,c:4})]?.v;
                const importance = csSheet[XLSX.utils.encode_cell({r:R,c:5})]?.v;
                
                if(code && concept) {
                    // åŸæœ‰çš„ META.concepts å°ç…§
                    if(!META.concepts[code]) META.concepts[code] = [];
                    META.concepts[code].push({ concept: safe(concept), sub: safe(subCat) });
                    
                    // æ–°å¢åˆ° conceptStocks é™£åˆ—
                    DB.conceptStocks.push({
                        '_code': code,
                        '_name': safe(name),
                        '_concept': safe(concept),
                        '_subCat': safe(subCat),
                        '_desc': safe(desc),
                        '_importance': safe(importance),
                        '_industry': DB.stocks[code]?.['ç”¢æ¥­åˆ†é¡'] || ''
                    });
                    
                    // çµ±è¨ˆæ¦‚å¿µåˆ†é¡
                    META.stockStats.conceptCategories[concept] = (META.stockStats.conceptCategories[concept] || 0) + 1;
                }
            }
        }
        META.stockStats.conceptTotal = DB.conceptStocks.length;
        console.log('å€‹è‚¡è¼‰å…¥:', META.stockStats.total, 'æ¦‚å¿µè‚¡:', META.stockStats.conceptTotal);
        
        // è¼‰å…¥å„æ¦‚å¿µè‚¡æ¸…å–®å·¥ä½œè¡¨
        const conceptSheets = ['å¯Œæ«ƒ50æˆä»½è‚¡', 'å°ç£50æˆä»½è‚¡', 'ä¸­å‹100æˆä»½è‚¡', 'NVDIAæ¦‚å¿µè‚¡', 'å°ç©é›»æ¦‚å¿µè‚¡'];
        conceptSheets.forEach(sheetName => {
            const sheet = wb.Sheets[sheetName];
            if(sheet) {
                const rows = XLSX.utils.sheet_to_json(sheet);
                DB.conceptLists[sheetName] = rows.map(r => normalizeCode(r['ä»£ç¢¼'])).filter(c => c);
                console.log(`${sheetName}: ${DB.conceptLists[sheetName].length} æª”`);
            }
        });
    }

    // 2. Revenue - å®Œæ•´è®€å–
    wb = await fetchXlsx(FILES.REV);
    if(wb) {
        // æœˆç‡Ÿæ”¶ - æ”¶é›†å®Œæ•´è³‡æ–™
        const sheetM = wb.Sheets['000_æœˆç‡Ÿæ”¶'];
        if(sheetM) {
            const rows = XLSX.utils.sheet_to_json(sheetM, {defval: null});
            if(rows.length > 0) {
                const headers = Object.keys(rows[0]);
                const mCols = headers.filter(h => h.includes('å–®æœˆç‡Ÿæ”¶')).sort();
                const accCols = headers.filter(h => h.includes('ç´¯æœˆç‡Ÿæ”¶(å„„)') && !h.includes('å–®æœˆ')).sort();
                
                console.log('æœˆç‡Ÿæ”¶æ¬„ä½:', mCols.length, 'ç´¯è¨ˆæ¬„ä½:', accCols.length);
                
                rows.forEach(r => {
                    const code = normalizeCode(r['ä»£è™Ÿ']);
                    if(!code || code.length > 5 || code.startsWith('0')) return;
                    
                    const data = [];
                    mCols.forEach(col => {
                        const m = col.match(/(\d+)M(\d+)/);
                        if(m && r[col] !== null && r[col] !== undefined) {
                            // 25M08 = 2025å¹´8æœˆ (å‰å…©ä½å°±æ˜¯è¥¿å…ƒå¹´å¾Œå…©ä½)
                            const year = 2000 + parseInt(m[1]);
                            const month = parseInt(m[2]);
                            const period = `${year}/${month.toString().padStart(2, '0')}`;
                            const accCol = accCols.find(c => c.includes(m[0]));
                            data.push({ 
                                d: period,
                                period: m[0],
                                year: year,
                                month: month,
                                rev: r[col],
                                acc: accCol ? r[accCol] : null
                            });
                        }
                    });
                    
                    if(data.length > 0) {
                        // æŒ‰æ—¥æœŸæ’åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
                        data.sort((a, b) => b.d.localeCompare(a.d));
                        META.revData.month[code] = data;
                    }
                });
                console.log('æœˆç‡Ÿæ”¶è¼‰å…¥å…¬å¸æ•¸:', Object.keys(META.revData.month).length);
            }
        }
        
        // å­£ç‡Ÿæ”¶
        const sheetQ = wb.Sheets['000_å­£ç‡Ÿæ”¶'];
        if(sheetQ) {
            const rows = XLSX.utils.sheet_to_json(sheetQ, {defval: null});
            if(rows.length > 0) {
                const headers = Object.keys(rows[0]);
                const qCols = headers.filter(h => h.includes('å–®å­£ç‡Ÿæ”¶')).sort();
                
                rows.forEach(r => {
                    const code = normalizeCode(r['ä»£è™Ÿ']);
                    if(!code || code.length > 5 || code.startsWith('0')) return;
                    
                    const data = [];
                    qCols.forEach(col => {
                        const m = col.match(/(\d+)Q(\d)/);
                        if(m && r[col] !== null && r[col] !== undefined) {
                            const year = 2000 + parseInt(m[1]);
                            data.push({ 
                                d: `${year}Q${m[2]}`, 
                                year: year,
                                q: parseInt(m[2]),
                                rev: r[col] 
                            });
                        }
                    });
                    
                    if(data.length > 0) {
                        data.sort((a, b) => b.d.localeCompare(a.d));
                        META.revData.quarter[code] = data;
                    }
                });
                console.log('å­£ç‡Ÿæ”¶è¼‰å…¥å…¬å¸æ•¸:', Object.keys(META.revData.quarter).length);
            }
        }
        
        // å¹´ç‡Ÿæ”¶
        const sheetY = wb.Sheets['000_å¹´ç‡Ÿæ”¶'];
        if(sheetY) {
            const rows = XLSX.utils.sheet_to_json(sheetY, {defval: null});
            if(rows.length > 0) {
                const headers = Object.keys(rows[0]);
                const yCols = headers.filter(h => h.includes('å¹´åº¦ç‡Ÿæ”¶')).sort();
                
                rows.forEach(r => {
                    const code = normalizeCode(r['ä»£è™Ÿ']);
                    if(!code || code.length > 5 || code.startsWith('0')) return;
                    
                    const data = [];
                    yCols.forEach(col => {
                        const m = col.match(/(\d{4})/);
                        if(m && r[col] !== null && r[col] !== undefined) {
                            data.push({ 
                                d: m[0], 
                                year: parseInt(m[0]),
                                rev: r[col] 
                            });
                        }
                    });
                    
                    if(data.length > 0) {
                        data.sort((a, b) => b.year - a.year);
                        META.revData.year[code] = data;
                    }
                });
                console.log('å¹´ç‡Ÿæ”¶è¼‰å…¥å…¬å¸æ•¸:', Object.keys(META.revData.year).length);
            }
        }
        
        // è²¡å ±å‚™è¨»
        const sheetH = wb.Sheets['10_è²¡å ±å‚™è¨»'];
        if(sheetH) {
            XLSX.utils.sheet_to_json(sheetH, {defval: null}).forEach(r => {
                const code = normalizeCode(r['ä»£è™Ÿ']);
                if(code) META.revData.highlights[code] = r;
            });
        }
    }

    // 3. News
    wb = await fetchXlsx(FILES.NEWS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å¤–é›»ç¶œåˆå ±å°']||[]).forEach(r => {
            const code = normalizeCode(r['è‚¡è™Ÿ']);
            DB.news.push({...r, 'è‚¡è™Ÿ': code});
            if(code) { 
                if(!META.relatedNews[code]) META.relatedNews[code]=[]; 
                META.relatedNews[code].push(r); 
            }
        });
        DB.news.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
        console.log('Newsè¼‰å…¥:', DB.news.length);
    }

    // 4. Memo
    wb = await fetchXlsx(FILES.MEMO);
    if(wb) {
        // ç”¢æ¥­é¡å ±å‘Šé—œéµå­—
        const industryKeywords = ['ç”¢æ¥­', 'TPCA', 'åœ‹éš›è‚¡å¸‚', 'ç¸½ç¶“', 'ç­–ç•¥'];
        
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¡¨']||[]).forEach(r => {
            const code = normalizeCode(r['è‚¡è™Ÿ']);
            const reportType = safe(r['å ±å‘Šé¡å‹']);
            const memoData = {...r, 'è‚¡è™Ÿ': code};
            
            DB.memo.push(memoData);
            
            // åˆ¤æ–·æ˜¯å€‹è‚¡é‚„æ˜¯ç”¢æ¥­
            const isIndustry = industryKeywords.some(kw => reportType.includes(kw));
            if(isIndustry) {
                DB.memoIndustry.push(memoData);
            } else {
                DB.memoStock.push(memoData);
            }
            
            // çµ±è¨ˆåˆ¸å•†å’Œå ±å‘Šé¡å‹
            const broker = safe(r['åˆ¸å•†']);
            if(broker) META.memoStats.brokers[broker] = (META.memoStats.brokers[broker] || 0) + 1;
            if(reportType) META.memoStats.types[reportType] = (META.memoStats.types[reportType] || 0) + 1;
            
            if(code) { 
                if(!META.relatedMemo[code]) META.relatedMemo[code]=[]; 
                META.relatedMemo[code].push(r); 
            }
        });
        DB.memo.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
        DB.memoStock.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
        DB.memoIndustry.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
        
        META.memoStats.total = DB.memo.length;
        META.memoStats.stockTotal = DB.memoStock.length;
        META.memoStats.industryTotal = DB.memoIndustry.length;
        console.log('Memoè¼‰å…¥:', META.memoStats.total, 'å€‹è‚¡:', META.memoStats.stockTotal, 'ç”¢æ¥­:', META.memoStats.industryTotal);
        
        XLSX.utils.sheet_to_json(wb.Sheets['è©³ç´°å…§å®¹åº«']||[]).forEach(r => META.memoDetail[safe(r['ç·¨è™Ÿ'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['è²¡å‹™æ•¸æ“šå½™ç¸½']||[]).forEach(r => META.finance[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢å“çµæ§‹åˆ†æ']||[]).forEach(r => META.products[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['å…¬å¸è¿½è¹¤è¡¨']||[]).forEach(r => META.tracking[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢æ¥­è¶¨å‹¢ç¸½è¦½']||[]).forEach(r => {
            if(r['ç”¢æ¥­']) DB.trends.push(r);
        });
    }

    // 5. Reports
    wb = await fetchXlsx(FILES.REPORTS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r => DB.reports.push(r));
        DB.reports.sort((a,b) => getDateVal(b['å ±å‘Šæ—¥æœŸ'])-getDateVal(a['å ±å‘Šæ—¥æœŸ']));
        
        XLSX.utils.sheet_to_json(wb.Sheets['ç„¦é»åˆ†æå…§å®¹']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.reportFocus[rid]) META.reportFocus[rid]=[]; META.reportFocus[rid].push(r); }
        });
        XLSX.utils.sheet_to_json(wb.Sheets['åˆ¸å•†è§€é»çµè«–']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) META.reportViews[rid] = r;
        });
        XLSX.utils.sheet_to_json(wb.Sheets['å€‹è‚¡è©•åƒ¹è¡¨']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.reportRatings[rid]) META.reportRatings[rid]=[]; META.reportRatings[rid].push(r); }
        });
    }

    // 6. Strategy (è¶¨å‹¢å±•æœ›) - æ–°æ ¼å¼
    wb = await fetchXlsx(FILES.STRAT);
    if(wb) {
        // è®€å–å ±å‘Šç´¢å¼•
        const indexSheet = wb.Sheets['å ±å‘Šç´¢å¼•'];
        if(indexSheet) {
            const indexData = XLSX.utils.sheet_to_json(indexSheet, {header: 1});
            // æ‰¾å ±å‘Šæ¸…å–®é–‹å§‹ä½ç½® (è·³éæ¨™é¡Œ)
            for(let i = 0; i < indexData.length; i++) {
                const row = indexData[i];
                if(row[0] === 'å ±å‘Šç·¨è™Ÿ') {
                    // æ¥ä¸‹ä¾†æ˜¯å ±å‘Šè³‡æ–™
                    for(let j = i+1; j < indexData.length; j++) {
                        const r = indexData[j];
                        if(r[0] && r[0].startsWith('RPT-')) {
                            const rptId = r[0];
                            const sheetName = wb.SheetNames.find(n => n.includes(rptId.replace('-', '')));
                            
                            DB.strategy.push({
                                'å ±å‘Šç·¨è™Ÿ': rptId,
                                'å ±å‘Šä¸»é¡Œ': r[1],
                                'ä¸»è¬›å–®ä½': r[2],
                                'è¬›è€…': r[3],
                                'å ±å‘Šæ—¥æœŸ': r[4],
                                'é æ•¸': r[5],
                                '_sheetName': sheetName
                            });
                        }
                    }
                    break;
                }
            }
        }
        
        // è®€å–æ¯å€‹å ±å‘Šçš„è©³ç´°å…§å®¹
        DB.strategy.forEach(report => {
            const sheetName = report._sheetName;
            if(sheetName && wb.Sheets[sheetName]) {
                const sheetData = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {header: 1});
                const sections = [];
                let currentSection = null;
                let basicInfo = {};
                
                for(let i = 1; i < sheetData.length; i++) {
                    const row = sheetData[i];
                    const tag = row[0];
                    const val = row[1];
                    
                    if(!tag) continue;
                    
                    // åŸºæœ¬è³‡è¨Šæ¬„ä½
                    if(['å ±å‘Šç·¨è™Ÿ', 'å ±å‘Šä¸»é¡Œ', 'å‰¯æ¨™é¡Œ', 'ç™¼å¸ƒå–®ä½', 'ä¸»è¬›äºº', 'ç™¼å¸ƒæ—¥æœŸ', 'å ±å‘Šé æ•¸', 'æ ¸å¿ƒè§€é»', 'æ¨™ç±¤åˆ†é¡', 'è³‡æ–™ä¾†æº'].includes(tag)) {
                        basicInfo[tag] = val;
                        continue;
                    }
                    
                    // åˆ†é¡æ¨™é¡Œ (ç”¨ã€ã€‘åŒ…èµ·ä¾†)
                    if(tag.startsWith('ã€') && tag.endsWith('ã€‘')) {
                        if(currentSection) sections.push(currentSection);
                        currentSection = { title: tag, items: [] };
                    } else if(currentSection) {
                        currentSection.items.push({ label: tag, value: val });
                    }
                }
                if(currentSection) sections.push(currentSection);
                
                // å„²å­˜åˆ° META
                META.stratSections = META.stratSections || {};
                META.stratSections[report['å ±å‘Šç·¨è™Ÿ']] = {
                    basic: basicInfo,
                    sections: sections
                };
            }
        });
        
        DB.strategy.sort((a,b) => getDateVal(b['å ±å‘Šæ—¥æœŸ'])-getDateVal(a['å ±å‘Šæ—¥æœŸ']));
        console.log('è¶¨å‹¢å±•æœ›è¼‰å…¥:', DB.strategy.length, 'ç¯‡å ±å‘Š');
    }

    // 7. CB - å®Œæ•´è®€å–
    wb = await fetchXlsx(FILES.CB);
    if(wb) {
        // å…ˆè®€å–æ›ç‰Œé«˜ä½è³‡æ–™ (00å·¥ä½œè¡¨)
        const cbHighLow = {};
        const sheet00Name = wb.SheetNames.find(n => n.startsWith('00_'));
        if(sheet00Name) {
            XLSX.utils.sheet_to_json(wb.Sheets[sheet00Name]||[]).forEach(r => {
                const cbCode = safe(r['ä»£è™Ÿ']);
                if(cbCode) {
                    const high = parseFloat(r['æ›ç‰Œæœ€é«˜']) || 0;
                    const low = parseFloat(r['æ›ç‰Œæœ€ä½']) || 0;
                    cbHighLow[cbCode] = {
                        high: high,
                        low: low,
                        range: low > 0 ? ((high - low) / low * 100) : 0,
                        avgVol: r['æœˆå‡æˆäº¤'],
                        // æ–°å¢æ¬„ä½
                        convStart: r['è½‰æ›é–‹å§‹'],
                        convEnd: r['è½‰æ›çµæŸ'],
                        stopConvStart: r['åœæ­¢è½‰æ›èµ·å§‹æ—¥'],
                        stopConvEnd: r['åœæ­¢è½‰æ›çµ‚è¿„æ—¥'],
                        fundUse: safe(r['è³‡é‡‘ç”¨é€”'])
                    };
                }
            });
        }
        
        // è®€å– 09_æœ€æ–°å‹•æ…‹æ¯é€±æ—¥è¡Œæƒ… - å–å¾—æœ€æ–°æ”¶ç›¤åƒ¹
        const cbLatestPrice = {};
        XLSX.utils.sheet_to_json(wb.Sheets['09_æœ€æ–°å‹•æ…‹æ¯é€±æ—¥è¡Œæƒ…']||[]).forEach(r => {
            const cbCode = safe(r['ä»£ç¢¼']);
            if(cbCode) {
                cbLatestPrice[cbCode] = parseFloat(r['CBæ”¶ç›¤åƒ¹']) || 0;
            }
        });
        
        // è®€å– 05_CBç«¶æ‹ç¯©é¸æ¢ä»¶å€é–“ - å»ºç«‹ç”¢æ¥­ç°¡ç¨±å°ç…§è¡¨
        const industrySimpleMap = {
            'å…‰é›»æ¥­': 'å…‰é›»ç”¢æ¥­', 'å…¶ä»–æ¥­': 'å…¶ä»–å‚³ç”¢', 'å…¶ä»–æ¥­é›»å­æ¥­': 'å…¶ä»–é›»å­',
            'å…¶ä»–é›»å­æ¥­': 'å…¶ä»–é›»å­',
            'åŒ–å­¸å·¥æ¥­': 'åŒ–å·¥ç”¢æ¥­', 'åŠå°é«”æ¥­': 'åŠå°é«”æ¥­', 'å¡‘è† å·¥æ¥­': 'å¡‘è† ç”¢æ¥­',
            'å±…å®¶ç”Ÿæ´»': 'å±…å®¶ç”Ÿæ´»', 'å»ºæç‡Ÿé€ æ¥­': 'å»ºæç‡Ÿé€ ', 'æ•¸ä½é›²ç«¯': 'æ•¸ä½é›²ç«¯',
            'æ–‡åŒ–å‰µæ„æ¥­': 'æ–‡åŒ–å‰µæ„', 'æ©¡è† å·¥æ¥­': 'å…¶ä»–å‚³ç”¢', 'æ°´æ³¥å·¥æ¥­': 'æ°´æ³¥ç”¢æ¥­',
            'æ±½è»Šå·¥æ¥­': 'æ±½è»Šç”¢æ¥­', 'æ²¹é›»ç‡ƒæ°£æ¥­': 'æ²¹é›»ç‡ƒæ°£', 'ç»ç’ƒé™¶ç“·': 'å…¶ä»–å‚³ç”¢',
            'ç”ŸæŠ€é†«ç™‚æ¥­': 'ç”ŸæŠ€é†«ç™‚', 'ç´¡ç¹”çº–ç¶­': 'ç´¡ç¹”çº–ç¶­', 'ç¶ èƒ½ç’°ä¿': 'ç¶ èƒ½ç’°ä¿',
            'èˆªé‹æ¥­': 'èˆªé‹ç”¢æ¥­', 'è§€å…‰é¤æ—…': 'è§€å…‰é¤æ—…', 'è­‰åˆ¸æ¥­': 'é‡‘èä¿éšª',
            'è²¿æ˜“ç™¾è²¨æ¥­': 'è²¿æ˜“ç™¾è²¨', 'è³‡è¨Šæœå‹™æ¥­': 'è³‡è¨Šæœå‹™', 'è¾²æ¥­ç§‘æŠ€æ¥­': 'è¾²æ¥­ç§‘æŠ€',
            'é€šä¿¡ç¶²è·¯æ¥­': 'é€šä¿¡ç¶²è·¯', 'é€ ç´™å·¥æ¥­': 'é€ ç´™ç”¢æ¥­', 'é‹å‹•ä¼‘é–’': 'é‹å‹•ä¼‘é–’',
            'é‡‘æ§æ¥­': 'é‡‘èä¿éšª', 'éŠ€è¡Œæ¥­': 'é‡‘èä¿éšª', 'é‹¼éµå·¥æ¥­': 'é‹¼éµç”¢æ¥­',
            'é›»å™¨é›»çºœ': 'é›»å™¨é›»çºœ', 'é›»å­é€šè·¯æ¥­': 'é›»å­é€šè·¯', 'é›»å­é›¶çµ„ä»¶æ¥­': 'é›¶çµ„ä»¶æ¥­',
            'é›»æ©Ÿæ©Ÿæ¢°': 'é›»æ©Ÿæ©Ÿæ¢°', 'é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­': 'é›»è…¦é€±é‚Š', 'é£Ÿå“å·¥æ¥­': 'é£Ÿå“ç”¢æ¥­'
        };
        const getSimpleIndustry = (ind) => industrySimpleMap[ind] || ind || 'å…¶ä»–å‚³ç”¢';
        
        // è®€å– 01_ALLCBåŸºæœ¬è³‡æ–™ - å…¨éƒ¨CBï¼ˆå«æ­·å²ï¼‰
        const cbBasicInfo = {};
        const activeCodes = new Set(); // è¨˜éŒ„æ›ç‰Œä¸­çš„ä»£è™Ÿ
        
        XLSX.utils.sheet_to_json(wb.Sheets['01_ALLCBåŸºæœ¬è³‡æ–™']||[]).forEach(r => {
            const cbCode = safe(r['CBä»£è™Ÿ']);
            if(cbCode) {
                const hl = cbHighLow[cbCode] || {};
                const fullIndustry = safe(r['ç”¢æ¥­åˆ†é¡']);
                cbBasicInfo[cbCode] = {
                    stockCode: normalizeCode(r['è‚¡ç¥¨ä»£è™Ÿ']),
                    name: safe(r['åç¨±']),
                    method: safe(r['è©¢åœˆç«¶æ‹']),
                    guarantee: safe(r['æ“”ä¿']),
                    rating: r['ä¿¡è©•'],
                    issuer: safe(r['ç™¼è¡Œåˆ¸å•†']),
                    scale: r['ç™¼è¡Œè¦æ¨¡'],
                    convPrice: r['è½‰æ›åƒ¹æ ¼'],
                    years: r['ç™¼è¡Œå¹´æœŸ'],
                    issuePrice: r['ç™¼è¡Œåƒ¹æ ¼'],
                    expPrice: r['åˆ°æœŸé‚„æœ¬åƒ¹æ ¼'],
                    premium: r['è¨‚åƒ¹æº¢åƒ¹ç‡'],
                    position: safe(r['ç”¢æ¥­åœ°ä½']),
                    capital: r['è‚¡æœ¬å¤§å°'],
                    industry: getSimpleIndustry(fullIndustry),
                    listDate: r['æ›ç‰Œæ—¥æœŸ'],
                    expDate: r['åˆ°æœŸæ—¥æœŸ'],
                    high: hl.high || parseFloat(r['æ›ç‰Œæœ€é«˜']) || 0,
                    low: hl.low || parseFloat(r['æ›ç‰Œæœ€ä½']) || 0,
                    // å¾00å·¥ä½œè¡¨è®€å–çš„æ–°æ¬„ä½
                    convStart: hl.convStart,
                    convEnd: hl.convEnd,
                    stopConvStart: hl.stopConvStart,
                    stopConvEnd: hl.stopConvEnd,
                    fundUse: hl.fundUse
                };
            }
        });
        
        // è®€å– 02_ALLCBç™¼è¡Œæ™‚ç¨‹
        const cbTimeline = {};
        XLSX.utils.sheet_to_json(wb.Sheets['02_ALLCBç™¼è¡Œæ™‚ç¨‹']||[]).forEach(r => {
            const cbCode = safe(r['CBä»£è™Ÿ']);
            if(cbCode) {
                cbTimeline[cbCode] = {
                    boardDate: r['è‘£äº‹æœƒå…¬å‘Š'],
                    sendDate: r['é€ä»¶æ—¥æœŸ'],
                    effectDate: r['ç”Ÿæ•ˆæ—¥æœŸ'],
                    bidDate: safe(r['è©¢åœˆç«¶æ‹æ—¥æœŸ']),
                    payDate: r['ä»£æ”¶åƒ¹æ¬¾å…¬å‘Š'],
                    listDate: r['æ›ç‰Œæ—¥æœŸ'],
                    cbasDate: r['CBASæ‹†è§£æ—¥']
                };
            }
        });
        
        // è®€å– 03_ALLCBè³£å›æ¢ä»¶
        const cbPutback = {};
        XLSX.utils.sheet_to_json(wb.Sheets['03_ALLCBè³£å›æ¢ä»¶']||[]).forEach(r => {
            const cbCode = safe(r['CBä»£è™Ÿ']);
            if(cbCode) {
                cbPutback[cbCode] = {
                    putDate1: r['è³£å›æ—¥æœŸ1'],
                    putDate2: r['è³£å›æ—¥æœŸ2'],
                    putTiming: safe(r['æŠ•è³‡äººæå‰è³£å›']),
                    putCondition: safe(r['è³£å›æ¢ä»¶'])
                };
            }
        });
        
        // æ•´åˆåˆ° DB.cbAll
        Object.entries(cbBasicInfo).forEach(([cbCode, info]) => {
            const timeline = cbTimeline[cbCode] || {};
            const putback = cbPutback[cbCode] || {};
            DB.cbAll.push({
                '_cbCode': cbCode,
                '_stockCode': info.stockCode,
                '_name': info.name,
                '_industry': info.industry,
                '_method': info.method,
                '_guarantee': info.guarantee,
                '_rating': info.rating,
                '_issuer': info.issuer,
                '_scale': info.scale,
                '_convPrice': info.convPrice,
                '_years': info.years,
                '_issuePrice': info.issuePrice,
                '_expPrice': info.expPrice,
                '_premium': info.premium,
                '_position': info.position,
                '_capital': info.capital,
                '_listDate': info.listDate,
                '_expDate': info.expDate,
                '_high': info.high,
                '_low': info.low,
                // æ™‚ç¨‹è³‡è¨Š
                '_boardDate': timeline.boardDate,
                '_sendDate': timeline.sendDate,
                '_effectDate': timeline.effectDate,
                '_bidDate': timeline.bidDate,
                '_payDate': timeline.payDate,
                '_cbasDate': timeline.cbasDate,
                // è³£å›æ¢ä»¶
                '_putDate1': putback.putDate1,
                '_putDate2': putback.putDate2,
                '_putTiming': putback.putTiming,
                '_putCondition': putback.putCondition,
                // è½‰æ›æ—¥æœŸå’Œè³‡é‡‘ç”¨é€”ï¼ˆå¾00å·¥ä½œè¡¨ï¼‰
                '_convStart': info.convStart,
                '_convEnd': info.convEnd,
                '_stopConvStart': info.stopConvStart,
                '_stopConvEnd': info.stopConvEnd,
                '_fundUse': info.fundUse
            });
        });
        console.log('CBåŸºæœ¬è³‡æ–™è¼‰å…¥:', DB.cbAll.length, 'ç­†');
        
        // å»ºç«‹æ­·å²CBè³‡æ–™åº«ï¼ˆå…ˆæ”¾å…¨éƒ¨ï¼Œå¾Œé¢æœƒæ’é™¤æ›ç‰Œä¸­çš„ï¼‰
        // éæ¿¾æ‰æ›ç‰Œæœ€é«˜æˆ–æœ€ä½ç‚º 0 çš„è³‡æ–™
        Object.entries(cbBasicInfo).forEach(([cbCode, info]) => {
            const high = info.high;
            const low = info.low;
            // åªåŠ å…¥æœ‰æ•ˆè³‡æ–™ï¼ˆhigh å’Œ low éƒ½ä¸ç‚º 0ï¼‰
            if(high > 0 && low > 0) {
                DB.cbHistory.push({
                    '_cbCode': cbCode,
                    '_stockCode': info.stockCode,
                    '_name': info.name,
                    '_industry': info.industry,
                    '_method': info.method,
                    '_guarantee': info.guarantee,
                    '_high': high,
                    '_low': low,
                    '_range': (high - low) / low * 100,
                    'è½‰æ›åƒ¹æ ¼(å…ƒ)': info.convPrice,
                    'åˆ°æœŸæ—¥': info.expDate,
                    'æ›ç‰Œæ—¥æœŸ': info.listDate,
                    'ç™¼è¡Œè¦æ¨¡': info.scale,
                    'ç™¼è¡Œåˆ¸å•†': info.issuer
                });
            }
        });
        
        // æ—¥è¡Œæƒ… (æœ‰ç”¢æ¥­è³‡è¨Š) - å…ˆè®€å–å»ºç«‹ç”¢æ¥­å°ç…§
        const dailyMap = {};
        XLSX.utils.sheet_to_json(wb.Sheets['09_æœ€æ–°å‹•æ…‹æ¯é€±æ—¥è¡Œæƒ…']||[]).forEach(r => {
            const code = safe(r['ä»£ç¢¼']);
            const name = safe(Object.values(r)[1]);
            const ind = getSimpleIndustry(safe(r['ç”¢æ¥­']));
            
            if(code) {
                dailyMap[code] = {
                    name: name,
                    industry: ind,
                    cbPrice: r['CBæ”¶ç›¤åƒ¹'],
                    stockPrice: r['è‚¡åƒ¹'],
                    convPrice: r['è½‰æ›åƒ¹æ ¼'],
                    convValue: r['è½‰æ›åƒ¹å€¼'],
                    premium: r['æº¢(æŠ˜)åƒ¹%'],
                    expDate: r['åˆ°æœŸæ—¥']
                };
            }
        });
        
        // æ›ç‰Œä¸­ CB - åˆä½µæ—¥è¡Œæƒ…è³‡æ–™å’Œæ›ç‰Œé«˜ä½
        const activeCbCodes = new Set();
        META.cbStats.industries = {}; // é‡ç½®ç”¢æ¥­çµ±è¨ˆ
        
        XLSX.utils.sheet_to_json(wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™']||[]).forEach(r => {
            const cbCode = safe(r['ä»£è™Ÿ']);
            const stockCode = normalizeCode(r['è½‰æ›æ¨™çš„ä»£ç¢¼']);
            const daily = dailyMap[cbCode] || {};
            const hl = cbHighLow[cbCode] || {};
            const basic = cbBasicInfo[cbCode] || {};
            
            activeCbCodes.add(cbCode); // è¨˜éŒ„æ›ç‰Œä¸­çš„ä»£è™Ÿ
            
            // ç”¢æ¥­åªå¾ 01 å·¥ä½œè¡¨çš„ L æ¬„ï¼ˆç”¢æ¥­åˆ†é¡ï¼‰å–å¾—
            const industry = basic.industry || 'å…¶ä»–å‚³ç”¢';
            
            const cbData = {
                ...r,
                '_stockCode': stockCode,
                '_cbCode': cbCode,
                '_name': safe(r['åç¨±']),
                '_stockName': safe(r['è½‰æ›æ¨™çš„åç¨±']),
                '_industry': industry,
                '_cbPrice': daily.cbPrice,
                '_stockPrice': daily.stockPrice,
                '_convValue': daily.convValue,
                '_premium': daily.premium,
                '_high': hl.high || 0,
                '_low': hl.low || 0,
                '_range': hl.range || 0,
                '_method': basic.method || '',      // è©¢åœˆ or ç«¶æ‹
                '_guarantee': basic.guarantee || '' // æœ‰æ“”ä¿ or ç„¡æ“”ä¿
            };
            
            DB.cb.push(cbData);
            if(stockCode) { 
                if(!META.cbMap[stockCode]) META.cbMap[stockCode]=[]; 
                META.cbMap[stockCode].push(cbData); 
            }
            // çµ±è¨ˆç”¢æ¥­
            if(industry) {
                META.cbStats.industries[industry] = (META.cbStats.industries[industry] || 0) + 1;
            }
        });
        
        // å¾æ­·å² CB ä¸­æ’é™¤æ›ç‰Œä¸­çš„
        DB.cbHistory = DB.cbHistory.filter(c => !activeCbCodes.has(c._cbCode));
        
        // è®€å– 04_æ‰€æœ‰CBç«¶æ‹è³‡æ–™åº«
        XLSX.utils.sheet_to_json(wb.Sheets['04_æ‰€æœ‰CBç«¶æ‹è³‡æ–™åº«']||[]).forEach(r => {
            const cbCode = safe(r['CBä»£è™Ÿ']);
            if(!cbCode) return; // è·³éç©ºè³‡æ–™
            
            // å„ªå…ˆä½¿ç”¨ 00 å·¥ä½œè¡¨çš„æ›ç‰Œé«˜ä½ï¼Œè‹¥ç„¡å‰‡ç”¨ 04 å·¥ä½œè¡¨çš„
            const hl = cbHighLow[cbCode] || {};
            const high = hl.high || parseFloat(r['æ›ç‰Œæœ€é«˜']) || 0;
            const low = hl.low || parseFloat(r['æ›ç‰Œæœ€ä½']) || 0;
            // æœ€æ–°æ”¶ç›¤å¾ 09 å·¥ä½œè¡¨å–å¾—
            const latestPrice = cbLatestPrice[cbCode] || 0;
            
            const bidLots = parseFloat(r['ç«¶æ‹å¼µæ•¸']) || 0;
            const bidMultiple = parseFloat(r['æŠ•æ¨™å€æ•¸']) || 0;
            const totalBidLots = Math.round(bidLots * bidMultiple); // æŠ•æ¨™å¼µæ•¸ = ç«¶æ‹å¼µæ•¸ Ã— æŠ•æ¨™å€æ•¸
            
            DB.cbAuction.push({
                '_cbCode': cbCode,
                '_stockCode': normalizeCode(r['è‚¡ç¥¨ä»£è™Ÿ']),
                '_name': safe(r['åç¨±']),
                '_industry': getSimpleIndustry(safe(r['ç”¢æ¥­åˆ†é¡'])),
                '_guarantee': safe(r['æ“”ä¿']),
                '_high': high,
                '_low': low,
                '_latestPrice': latestPrice,
                '_range': low > 0 ? (high - low) / low * 100 : 0,
                'é–‹æ¨™æ—¥æœŸ': r['é–‹æ¨™æ—¥æœŸ'],
                'æˆªæ¨™æ—¥': r['æˆªæ¨™æ—¥'],
                'ç™¼è¡Œè¦æ¨¡': r['ç™¼è¡Œè¦æ¨¡'],
                'ç«¶æ‹å¼µæ•¸': r['ç«¶æ‹å¼µæ•¸'],
                'æŠ•æ¨™å¼µæ•¸': totalBidLots,
                'åº•æ¨™åƒ¹': r['åº•æ¨™åƒ¹'],
                'æˆªæ¨™æ”¶ç›¤': r['æˆªæ¨™æ”¶ç›¤'] || r['æˆªæ¨™æ—¥æ”¶ç›¤'] || r['æˆªæ¨™æ—¥è‚¡åƒ¹'],
                'è½‰æ›åƒ¹': r['è½‰æ›åƒ¹'],
                'æˆªæ¨™ç†è«–': r['ç†è«–åƒ¹'],
                'æœ€ä½å¾—æ¨™': r['æœ€ä½å¾—æ¨™'],
                'æœ€ä½æº¢åƒ¹': r['æœ€ä½æº¢åƒ¹'],
                'å¹³å‡å¾—æ¨™': r['å¹³å‡å¾—æ¨™'],
                'å¹³å‡æº¢åƒ¹': r['å¹³å‡æº¢åƒ¹'],
                'æŠ•æ¨™å€æ•¸': r['æŠ•æ¨™å€æ•¸'],
                'åˆæ ¼ä»¶æ•¸': r['åˆæ ¼ä»¶æ•¸'],
                'ç™¼è¡Œåˆ¸å•†': safe(r['ç™¼è¡Œåˆ¸å•†']),
                'è¨‚åƒ¹æº¢åƒ¹ç‡': r['è¨‚åƒ¹æº¢åƒ¹ç‡']
            });
        });
        
        // è®€å– 06_ç™¼è¡Œæ¡ˆä»¶ (æ‰¿éŠ·ä¸­)
        XLSX.utils.sheet_to_json(wb.Sheets['06_ç™¼è¡Œæ¡ˆä»¶']||[]).forEach(r => {
            DB.cbPrimary.push({
                '_stockCode': normalizeCode(r['è‚¡ç¥¨ä»£è™Ÿ']),
                '_cbCode': safe(r['æ¨™çš„ä»£è™Ÿ']),
                '_name': safe(r['ç™¼è¡Œæ¨™çš„']),
                '_method': safe(r['è©¢åœˆ/ç«¶æ‹']),
                '_tcri': safe(r['TCRI/æ“”ä¿']),
                '_amount': r['ç™¼è¡Œé‡'],
                '_broker': safe(r['ç™¼è¡Œåˆ¸å•†']),
                '_sendDate': r['é€ä»¶æ—¥'],
                '_effectDate': r['ç”Ÿæ•ˆæ—¥'],
                '_bidPeriod': safe(r['è©¢åœˆ/æŠ•æ¨™æœŸé–“']),
                '_premium': r['æº¢åƒ¹ç‡'],
                '_convPrice': r['è½‰æ›åƒ¹'],
                '_listDate': r['æ›ç‰Œæ—¥'],
                '_optionDate': r['å¯æ‹†è§£é¸æ“‡æ¬Šæ—¥'],
                '_price': r['æ‰¿éŠ·åƒ¹æ ¼'],
                '_years': r['å¹´æœŸ'],
                '_putback': safe(r['è³£å›æ¢ä»¶']),
                '_capital': r['è‚¡æœ¬'],
                '_stockPrice': r['è‚¡åƒ¹'],
                '_volatility': r['60å¤©æ³¢å‹•ç‡']
            });
        });
        META.cbPrimaryStats.underwriting = DB.cbPrimary.length;
        
        // è®€å– 07_è‘£äº‹æœƒæ±ºè­°
        XLSX.utils.sheet_to_json(wb.Sheets['07_è‘£äº‹æœƒæ±ºè­°']||[]).forEach(r => {
            DB.cbBoard.push({
                '_stockCode': normalizeCode(r['è‚¡é°¾ä»£è™Ÿ'] || r['è‚¡ç¥¨ä»£è™Ÿ']),
                '_cbCode': safe(r['CBä»£ç¢¼']),
                '_name': safe(r['ç™¼è¡Œæ¨™çš„']),
                '_method': safe(r['è©¢åœˆ/ç«¶åƒ¹']),
                '_tcri': safe(r['TCRI/æ“”ä¿']),
                '_amount': r['ç™¼è¡Œé‡'],
                '_broker': safe(r['ä¸»è¾¦åˆ¸å•†']),
                '_maturity': safe(r['åˆ°æœŸæ—¥']),
                '_boardDate': r['è‘£äº‹æœƒé€šé'],
                '_capital': r['è‚¡æœ¬(å„„)'],
                '_note': safe(r['å‚™è¨»'])
            });
        });
        META.cbPrimaryStats.board = DB.cbBoard.length;
        
        // è®€å– 10_æœ€æ–°å‹•æ…‹æ¯é€±é¤˜é¡è¡¨
        XLSX.utils.sheet_to_json(wb.Sheets['10_æœ€æ–°å‹•æ…‹æ¯é€±é¤˜é¡è¡¨']||[]).forEach(r => {
            DB.cbBalance.push({
                '_cbCode': safe(r['è­‰åˆ¸ä»£è™Ÿ']),
                '_name': safe(r['è­‰åˆ¸åç¨±']),
                '_thisWeek': r['æœ¬é€±è‚¡é¡'],
                '_lastWeek': r['ä¸Šé€±è‚¡é¡'],
                '_change': r['å¢æ¸›æ•¸é¡'],
                '_changeRate': r['å¢æ¸›æ¯”ç‡'],
                '_remainRate': r['ç™¼è¡Œæ¯”ç‡(å‰©é¤˜æ¯”ç‡)']
            });
        });
        META.cbBalanceStats.total = DB.cbBalance.length;
        
        // è®€å– 11_æœ€æ–°å‹•æ…‹CBASå ±åƒ¹è¡¨
        XLSX.utils.sheet_to_json(wb.Sheets['11_æœ€æ–°å‹•æ…‹CBASå ±åƒ¹è¡¨']||[]).forEach(r => {
            const tcriVal = safe(r['æ“”ä¿éŠ€è¡Œ/ä¿¡ç”¨è©•ç­‰(TCRI)']);
            const cbCode = safe(r['å¯è½‰å‚µä»£ç¢¼']);
            // åˆ¤æ–·æ“”ä¿ï¼šå¦‚æœæ˜¯ç´”æ•¸å­—æˆ–å«æ•¸å­—çš„è©•ç­‰(å¦‚ twA+)å‰‡ç„¡æ“”ä¿ï¼Œæœ‰éŠ€è¡Œåç¨±å‰‡æœ‰æ“”ä¿
            const isGuaranteed = tcriVal && !/^\d+$/.test(tcriVal) && /éŠ€|å•†éŠ€|åˆåº«/.test(tcriVal);
            // å¾ cbBasicInfo å–å¾—ç”¢æ¥­ï¼ˆ01å·¥ä½œè¡¨çš„Læ¬„ï¼‰
            const basicInfo = cbBasicInfo[cbCode] || {};
            const industry = basicInfo.industry || safe(r['ç”¢æ¥­']) || 'å…¶ä»–';
            
            DB.cbCBAS.push({
                '_name': safe(r['å¯è½‰å‚µåç¨±']),
                '_cbCode': cbCode,
                '_tcri': tcriVal,
                '_guarantee': isGuaranteed ? 'æœ‰' : 'ç„¡',
                '_method': basicInfo.method || '',
                '_premium': r['æ¬Šåˆ©é‡‘(ä½°å…ƒå ±åƒ¹)'],
                '_optExpiry': r['é¸æ“‡æ¬Šåˆ°æœŸæ—¥'],
                '_putPrice': r['è³£å›åƒ¹æ ¼(A)'],
                '_putDate': r['è³£å›æ—¥æœŸ(B)'],
                '_remainYears': r['å‰©é¤˜å¹´æœŸ'],
                '_discountRate': r['æŠ˜ç¾ç‡(C)'],
                '_premiumRef': r['æ¬Šåˆ©é‡‘åƒè€ƒåƒ¹'],
                '_stockPrice': r['ç¾è‚¡åƒè€ƒåƒ¹'],
                '_convPrice': r['è½‰æ›åƒ¹æ ¼'],
                '_convValue': r['CBè½‰æ›åƒ¹å€¼'],
                '_cbPrice': r['CBåƒè€ƒåƒ¹'],
                '_premiumPct': r['æº¢(æŠ˜)åƒ¹%'],
                '_vol120': r['è‚¡åƒ¹æ³¢å‹•ç‡120å¤©%'],
                '_vol240': r['è‚¡åƒ¹æ³¢å‹•ç‡240å¤©%'],
                '_remainPct': r['æµé€šé¤˜é¡å ç™¼è¡Œç¸½é¡%'],
                '_origAmount': r['åŸå§‹ç™¼è¡Œé‡'],
                '_industry': industry
            });
        });
        META.cbCBASStats.total = DB.cbCBAS.length;
        
        // è®€å– 12_å…¬å¸åŸ·è¡Œè´–å›æ¬Š
        XLSX.utils.sheet_to_json(wb.Sheets['12_å…¬å¸åŸ·è¡Œè´–å›æ¬Š']||[]).forEach(r => {
            const subject = safe(r['ä¸»æ—¨']);
            // å¾ä¸»æ—¨è§£æçµ‚æ­¢æ«ƒæª¯è²·è³£æ—¥æœŸ
            const endMatch = subject.match(/(\d{3})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥çµ‚æ­¢æ«ƒæª¯è²·è³£/);
            let endDate = '';
            if(endMatch) {
                const year = parseInt(endMatch[1]) + 1911;
                endDate = `${year}/${endMatch[2].padStart(2,'0')}/${endMatch[3].padStart(2,'0')}`;
            }
            // å¾ä¸»æ—¨è§£æCBä»£è™Ÿ
            const cbMatch = subject.match(/ä»£ç¢¼[ï¼š:](\d+)/);
            const cbCode = cbMatch ? cbMatch[1] : '';
            // å¾ä¸»æ—¨è§£æCBç°¡ç¨±
            const cbNameMatch = subject.match(/ç°¡ç¨±[ï¼š:]([^ï¼Œ,]+)[ï¼Œ,]/);
            const cbName = cbNameMatch ? cbNameMatch[1] : '';
            
            // å–å¾— CB æ”¶ç›¤åƒ¹å’Œæ›ç‰Œé«˜ä½
            const daily = dailyMap[cbCode] || {};
            const hl = cbHighLow[cbCode] || {};
            
            DB.cbRedeem.push({
                '_stockCode': normalizeCode(r['å…¬å¸ä»£è™Ÿ']),
                '_name': safe(r['å…¬å¸åç¨±']),
                '_cbCode': cbCode,
                '_cbName': cbName,
                '_reportDate': safe(r['ç”³å ±æ—¥æœŸ']),
                '_endDate': endDate,
                '_cbPrice': daily.cbPrice || 0,
                '_high': hl.high || 0,
                '_low': hl.low || 0,
                '_subject': subject,
                '_asoExpiry': r['ASOåˆ°æœŸæ—¥']
            });
        });
        
        // è®€å– 13_åœæ­¢è½‰æ›è³‡è¨Š
        XLSX.utils.sheet_to_json(wb.Sheets['13_åœæ­¢è½‰æ›è³‡è¨Š']||[]).forEach(r => {
            DB.cbStopConv.push({
                '_cbCode': safe(r['å‚µåˆ¸ä»£ç¢¼']),
                '_name': safe(r['å‚µåˆ¸ç°¡ç¨±']),
                '_startDate': safe(r['åœæ­¢è½‰(äº¤)æ›èµ·æ—¥']),
                '_endDate': safe(r['åœæ­¢è½‰(äº¤)æ›è¿„æ—¥']),
                '_reason': safe(r['åœæ­¢è½‰(äº¤)æ›äº‹ç”±'])
            });
        });
        
        // è®€å– 14_è½‰æ›åƒ¹æ ¼èª¿æ•´
        XLSX.utils.sheet_to_json(wb.Sheets['14_è½‰æ›åƒ¹æ ¼èª¿æ•´']||[]).forEach(r => {
            const subject = safe(r['ä¸»æ—¨']);
            
            // è§£æèª¿æ•´æ—¥æœŸ
            const dateMatch = subject.match(/è‡ª(\d{3})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥èµ·/);
            let adjDate = '';
            if(dateMatch) {
                const year = parseInt(dateMatch[1]) + 1911;
                adjDate = `${year}/${dateMatch[2].padStart(2,'0')}/${dateMatch[3].padStart(2,'0')}`;
            }
            
            // è§£æåŸå§‹åƒ¹æ ¼å’Œèª¿æ•´å¾Œåƒ¹æ ¼
            const priceMatch = subject.match(/è½‰æ›åƒ¹æ ¼è‡ª([\d.]+)å…ƒèª¿æ•´ç‚º([\d.]+)å…ƒ/);
            const origPrice = priceMatch ? priceMatch[1] : '';
            const newPrice = priceMatch ? priceMatch[2] : '';
            
            // è§£æ CB ä»£è™Ÿå’Œç°¡ç¨±
            const cbMatch = subject.match(/ä»£ç¢¼[ï¼š:](\d+)/);
            const cbCode = cbMatch ? cbMatch[1] : '';
            const nameMatch = subject.match(/ç°¡ç¨±[ï¼š:]([^ï¼Œ,]+)[ï¼Œ,]/);
            const cbName = nameMatch ? nameMatch[1] : '';
            
            DB.cbPriceAdj.push({
                '_stockCode': normalizeCode(r['å…¬å¸ä»£è™Ÿ']),
                '_name': safe(r['å…¬å¸åç¨±']),
                '_cbCode': cbCode,
                '_cbName': cbName,
                '_adjDate': adjDate,
                '_origPrice': origPrice,
                '_newPrice': newPrice,
                '_subject': subject
            });
        });
        
        // è¨ˆç®—çµ±è¨ˆ
        META.cbStats.total = DB.cb.length;
        META.cbStats.historyTotal = DB.cbHistory.length;
        META.cbStats.auctionTotal = DB.cbAuction.length;
        const companies = new Set();
        let totalBal = 0;
        DB.cb.forEach(c => {
            if(c['_stockCode']) companies.add(c['_stockCode']);
            const bal = parseFloat(c['æœ€æ–°é¤˜é¡(ç™¾è¬)']) || 0;
            totalBal += bal;
        });
        META.cbStats.companies = companies.size;
        META.cbStats.totalBalance = totalBal;
        
        console.log('CBè¼‰å…¥:', DB.cb.length, 'æ­·å²CB:', DB.cbHistory.length, 'ç«¶æ‹:', DB.cbAuction.length, 
                    'æ‰¿éŠ·ä¸­:', DB.cbPrimary.length, 'è‘£äº‹æœƒ:', DB.cbBoard.length, 
                    'é¤˜é¡:', DB.cbBalance.length, 'CBAS:', DB.cbCBAS.length,
                    'å¼·åˆ¶è´–å›:', DB.cbRedeem.length, 'åœæ­¢è½‰æ›:', DB.cbStopConv.length, 'åƒ¹æ ¼èª¿æ•´:', DB.cbPriceAdj.length);
    }

    // 7. ç«¶æ‹æ˜ç´°è³‡æ–™ - 10_auction.xlsx
    wb = await fetchXlsx(FILES.AUCTION);
    if(wb) {
        const sheetNames = wb.SheetNames;
        sheetNames.forEach(sheetName => {
            if(sheetName === 'ç¸½è¦½') return; // è·³éç¸½è¦½è¡¨
            
            const sheet = wb.Sheets[sheetName];
            if(!sheet) return;
            
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ''});
            if(rows.length < 50) return; // è³‡æ–™ä¸è¶³
            
            const cbCode = sheetName.trim();
            const detail = {
                basic: {},
                price: {},
                cost: {},
                stats: {},
                corpStats: null, // æ³•äººçµ±è¨ˆï¼ˆå¯èƒ½æ²’æœ‰ï¼‰
                top10: [],
                intervals: [],
                details: []
            };
            
            // æ‰¾åˆ°å„å€æ®µçš„èµ·å§‹è¡Œè™Ÿ
            let priceRow = -1, costRow = -1, statsRow = -1, corpRow = -1, top10Row = -1, intervalRow = -1, detailRow = -1;
            for(let i = 0; i < rows.length; i++) {
                const label = String(rows[i]?.[0] || '').trim();
                if(label === 'ã€å¾—æ¨™åƒ¹æ ¼ã€‘') priceRow = i;
                else if(label === 'ã€æ›è‚¡æˆæœ¬åˆ†æã€‘') costRow = i;
                else if(label === 'ã€æŠ•æ¨™å¾—æ¨™çµ±è¨ˆã€‘') statsRow = i;
                else if(label === 'ã€æ³•äººæŠ•æ¨™çµ±è¨ˆã€‘') corpRow = i;
                else if(label === 'ã€å‰åå¤§å¾—æ¨™é‡ã€‘') top10Row = i;
                else if(label === 'ã€å¾—æ¨™å€é–“åˆ†æã€‘') intervalRow = i;
                else if(label === 'ã€å¾—æ¨™æ˜ç´°ã€‘') detailRow = i;
            }
            
            // è§£æåŸºæœ¬è³‡æ–™ (Row 0-9)
            for(let i = 0; i <= 9; i++) {
                const label = String(rows[i]?.[0] || '').trim();
                const value = rows[i]?.[1];
                if(label && value !== undefined && value !== '' && !label.startsWith('ã€')) {
                    detail.basic[label] = value;
                }
            }
            
            // è§£æå¾—æ¨™åƒ¹æ ¼
            if(priceRow >= 0) {
                for(let i = priceRow + 1; i < priceRow + 5; i++) {
                    const label = String(rows[i]?.[0] || '').trim();
                    const value = parseFloat(rows[i]?.[1]) || 0;
                    if(label === 'æœ€ä½å¾—æ¨™') detail.price['æœ€ä½å¾—æ¨™'] = value;
                    else if(label === 'æœ€é«˜å¾—æ¨™') detail.price['æœ€é«˜å¾—æ¨™'] = value;
                    else if(label === 'åŠ æ¬Šå¹³å‡') detail.price['åŠ æ¬Šå¹³å‡'] = value;
                }
            }
            
            // è§£ææ›è‚¡æˆæœ¬åˆ†æ
            if(costRow >= 0) {
                for(let i = costRow + 1; i < costRow + 6; i++) {
                    const label = String(rows[i]?.[0] || '').trim();
                    const value = parseFloat(rows[i]?.[1]) || 0;
                    if(label === 'æœ€ä½æ›è‚¡æˆæœ¬') detail.cost['æœ€ä½æ›è‚¡æˆæœ¬'] = value;
                    else if(label === 'æœ€é«˜æ›è‚¡æˆæœ¬') detail.cost['æœ€é«˜æ›è‚¡æˆæœ¬'] = value;
                    else if(label === 'å¹³å‡æ›è‚¡æˆæœ¬') detail.cost['å¹³å‡æ›è‚¡æˆæœ¬'] = value;
                    else if(label === 'æ›è‚¡æº¢åƒ¹ç‡%') detail.cost['æ›è‚¡æº¢åƒ¹ç‡'] = value;
                }
            }
            
            // è§£ææŠ•æ¨™å¾—æ¨™çµ±è¨ˆ
            if(statsRow >= 0) {
                for(let i = statsRow + 1; i < statsRow + 10; i++) {
                    const label = String(rows[i]?.[0] || '').trim();
                    const value = parseFloat(rows[i]?.[1]) || 0;
                    if(label === 'åˆæ ¼æŠ•æ¨™ç­†æ•¸') detail.stats['åˆæ ¼æŠ•æ¨™ç­†æ•¸'] = value;
                    else if(label === 'æŠ•æ¨™æ•¸é‡') detail.stats['æŠ•æ¨™æ•¸é‡'] = value;
                    else if(label === 'æŠ•æ¨™å‡å¼µ') detail.stats['æŠ•æ¨™å‡å¼µ'] = value;
                    else if(label === 'å¾—æ¨™ç­†æ•¸') detail.stats['å¾—æ¨™ç­†æ•¸'] = value;
                    else if(label === 'å¾—æ¨™æ•¸é‡') detail.stats['å¾—æ¨™æ•¸é‡'] = value;
                    else if(label === 'å¾—æ¨™å‡å¼µ') detail.stats['å¾—æ¨™å‡å¼µ'] = value;
                    else if(label === 'å¾—æ¨™ç¸½é‡‘é¡') detail.stats['å¾—æ¨™ç¸½é‡‘é¡'] = value;
                    else if(label === 'æŠ•æ¨™å¾—æ¨™å€æ•¸') detail.stats['æŠ•æ¨™å¾—æ¨™å€æ•¸'] = value;
                    if(label.startsWith('ã€')) break; // é‡åˆ°ä¸‹ä¸€å€æ®µå°±åœæ­¢
                }
            }
            
            // è§£ææ³•äººæŠ•æ¨™çµ±è¨ˆï¼ˆå¯èƒ½æ²’æœ‰ï¼‰
            if(corpRow >= 0) {
                detail.corpStats = {};
                for(let i = corpRow + 1; i < corpRow + 6; i++) {
                    const label = String(rows[i]?.[0] || '').trim();
                    const value = parseFloat(rows[i]?.[1]) || 0;
                    if(label === 'æ³•äººæŠ•æ¨™ç­†æ•¸') detail.corpStats['æ³•äººæŠ•æ¨™ç­†æ•¸'] = value;
                    else if(label === 'æ³•äººæŠ•æ¨™æ•¸é‡') detail.corpStats['æ³•äººæŠ•æ¨™æ•¸é‡'] = value;
                    else if(label === 'æ³•äººå¾—æ¨™ç­†æ•¸') detail.corpStats['æ³•äººå¾—æ¨™ç­†æ•¸'] = value;
                    else if(label === 'æ³•äººå¾—æ¨™æ•¸é‡') detail.corpStats['æ³•äººå¾—æ¨™æ•¸é‡'] = value;
                    if(label.startsWith('ã€')) break;
                }
            }
            
            // è§£æå‰åå¤§å¾—æ¨™é‡
            if(top10Row >= 0) {
                for(let i = top10Row + 2; i < top10Row + 13; i++) { // +2è·³éæ¨™é¡Œè¡Œ
                    const rank = rows[i]?.[0];
                    const qty = parseFloat(rows[i]?.[1]) || 0;
                    const price = parseFloat(rows[i]?.[2]) || 0;
                    const amount = parseFloat(rows[i]?.[3]) || 0;
                    const cost = parseFloat(rows[i]?.[4]) || 0;
                    // åªå–æ•¸å­—æ’å1-10ï¼Œæ’é™¤ç©ºè¡Œå’Œå…¶ä»–æ¨™é¡Œ
                    if(rank && !isNaN(parseInt(rank)) && parseInt(rank) >= 1 && parseInt(rank) <= 10 && qty > 0) {
                        detail.top10.push({ rank: parseInt(rank), qty, price, amount, cost });
                    }
                }
            }
            
            // è§£æå¾—æ¨™å€é–“åˆ†æ
            if(intervalRow >= 0) {
                for(let i = intervalRow + 2; i < intervalRow + 10; i++) { // +2è·³éæ¨™é¡Œè¡Œ
                    const interval = String(rows[i]?.[0] || '').trim();
                    const count = parseFloat(rows[i]?.[1]) || 0;
                    const qty = parseFloat(rows[i]?.[2]) || 0;
                    const amount = parseFloat(rows[i]?.[3]) || 0;
                    const avgPrice = parseFloat(rows[i]?.[4]) || 0;
                    const avgCost = parseFloat(rows[i]?.[5]) || 0;
                    const ratio = parseFloat(rows[i]?.[6]) || 0;
                    // åªå–æœ‰æ•ˆçš„å€é–“è³‡æ–™ï¼Œæ’é™¤æ¨™é¡Œå’Œç¸½è¨ˆ
                    if(interval && interval.match(/^\d\./) && qty > 0) {
                        detail.intervals.push({ interval, count, qty, amount, avgPrice, avgCost, ratio });
                    }
                }
            }
            
            // è§£æå¾—æ¨™æ˜ç´°
            if(detailRow >= 0) {
                for(let i = detailRow + 2; i < rows.length; i++) { // +2è·³éæ¨™é¡Œè¡Œ
                    const seq = rows[i]?.[0];
                    const price = parseFloat(rows[i]?.[1]) || 0;
                    const qty = parseFloat(rows[i]?.[2]) || 0;
                    const amount = parseFloat(rows[i]?.[3]) || 0;
                    const cost = parseFloat(rows[i]?.[4]) || 0;
                    const intervalType = String(rows[i]?.[5] || '').trim();
                    const tail = rows[i]?.[6];
                    const cumQty = parseFloat(rows[i]?.[7]) || 0;
                    const cumRatio = parseFloat(rows[i]?.[8]) || 0;
                    
                    if(seq && !isNaN(parseInt(seq)) && price > 0 && qty > 0) {
                        detail.details.push({ seq: parseInt(seq), price, qty, amount, cost, intervalType, tail, cumQty, cumRatio });
                    }
                }
            }
            
            DB.auctionDetail[cbCode] = detail;
        });
        
        console.log('ç«¶æ‹æ˜ç´°è¼‰å…¥:', Object.keys(DB.auctionDetail).length, 'æª”');
    }

    // æ›´æ–°è¨ˆæ•¸
    $('c-news').innerText = DB.news.length;
    $('c-memo').innerText = DB.memo.length;
    $('c-reports').innerText = DB.reports.length;
    $('c-strategy').innerText = DB.strategy.length;
    $('c-stocks').innerText = Object.keys(DB.stocks).length;
    $('c-trends').innerText = DB.trends.length;
    $('c-cb').innerText = DB.cb.length;

    // ç¢ºä¿éš±è— loader
    setTimeout(() => { $('loader').classList.add('hidden'); }, 100);
    
    document.querySelectorAll('.db-tab').forEach(tab => {
        tab.onclick = () => {
            CURR_DB = tab.dataset.db;
            document.querySelectorAll('.db-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            renderList();
        };
    });
    
    renderList();
  } catch(e) {
    console.error('Init Error:', e);
    $('loader').classList.add('hidden');
    $('loadStatus').innerText = 'è¼‰å…¥ç™¼ç”ŸéŒ¯èª¤';
  }
}

// å€‹è‚¡çµ±è¨ˆå€å¡Š
function renderStockStats() {
    const stats = META.stockStats;
    const industries = Object.entries(stats.industries).sort((a,b) => b[1]-a[1]);
    const concepts = Object.entries(stats.conceptCategories).sort((a,b) => b[1]-a[1]);
    const markets = Object.entries(stats.markets).sort((a,b) => b[1]-a[1]);
    
    // é ç±¤ HTML
    const tabsHtml = `
        <div class="cb-mode-switcher">
            <span class="cb-mode-tab ${STOCK_MODE==='all'?'active':''}" onclick="setStockMode('all')">ğŸ¢ å…¨éƒ¨å€‹è‚¡</span>
            <span class="cb-mode-tab ${STOCK_MODE==='concept'?'active':''}" onclick="setStockMode('concept')">ğŸ’¡ æ¦‚å¿µè‚¡</span>
        </div>
    `;
    
    if(STOCK_MODE === 'all') {
        // å…¨éƒ¨å€‹è‚¡çµ±è¨ˆ
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.total}</div>
                        <div class="cb-stat-label">ä¸Šå¸‚æ«ƒå…¬å¸</div>
                    </div>
                    ${markets.slice(0, 4).map(([m, cnt]) => 
                        `<div class="cb-stat-item clickable" onclick="setSearch('${m}')">
                            <div class="cb-stat-num">${cnt}</div>
                            <div class="cb-stat-label">${m}</div>
                        </div>`
                    ).join('')}
                </div>
                <div class="cb-ind-title">ğŸ“Š å„ç”¢æ¥­åˆ†ä½ˆ</div>
                <div class="cb-ind-grid">
                    ${industries.slice(0, 25).map(([ind, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${ind}')">${industryEmoji(ind)} ${ind}<span class="num">${padNum(cnt)}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    } else if(STOCK_MODE === 'concept') {
        // æ¦‚å¿µè‚¡çµ±è¨ˆ
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.conceptTotal}</div>
                        <div class="cb-stat-label">æ¦‚å¿µè‚¡ç­†æ•¸</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${concepts.length}</div>
                        <div class="cb-stat-label">æ¦‚å¿µåˆ†é¡æ•¸</div>
                    </div>
                </div>
                <div class="cb-ind-title">ğŸ’¡ ç†±é–€æ¦‚å¿µåˆ†é¡</div>
                <div class="cb-ind-grid">
                    ${concepts.slice(0, 30).map(([c, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${c}')">${c}<span class="num">${padNum(cnt)}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    return '';
}

// åˆ‡æ›å€‹è‚¡æ¨¡å¼
function setStockMode(mode) {
    STOCK_MODE = mode;
    $('search').value = '';
    renderList();
}

// Memo çµ±è¨ˆå€å¡Š
function renderMemoStats() {
    const stats = META.memoStats;
    const brokers = Object.entries(stats.brokers).sort((a,b) => b[1]-a[1]);
    const types = Object.entries(stats.types).sort((a,b) => b[1]-a[1]);
    
    // é ç±¤ HTML
    const tabsHtml = `
        <div class="cb-mode-switcher">
            <span class="cb-mode-tab ${MEMO_MODE==='all'?'active':''}" onclick="setMemoMode('all')">ğŸ“‹ å…¨éƒ¨</span>
            <span class="cb-mode-tab ${MEMO_MODE==='stock'?'active':''}" onclick="setMemoMode('stock')">ğŸ¢ å€‹è‚¡</span>
            <span class="cb-mode-tab ${MEMO_MODE==='industry'?'active':''}" onclick="setMemoMode('industry')">ğŸ­ ç”¢æ¥­</span>
        </div>
    `;
    
    if(MEMO_MODE === 'all') {
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.total}</div>
                        <div class="cb-stat-label">Memoç¸½æ•¸</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setMemoMode('stock')">
                        <div class="cb-stat-num">${stats.stockTotal}</div>
                        <div class="cb-stat-label">å€‹è‚¡å ±å‘Š</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setMemoMode('industry')">
                        <div class="cb-stat-num">${stats.industryTotal}</div>
                        <div class="cb-stat-label">ç”¢æ¥­å ±å‘Š</div>
                    </div>
                </div>
                <div class="cb-ind-title">ğŸ“Š å ±å‘Šé¡å‹åˆ†ä½ˆ</div>
                <div class="cb-ind-grid">
                    ${types.slice(0, 15).map(([t, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${t}')">${t}<span class="num">${padNum(cnt)}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    } else if(MEMO_MODE === 'stock') {
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.stockTotal}</div>
                        <div class="cb-stat-label">å€‹è‚¡å ±å‘Šæ•¸</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${brokers.length}</div>
                        <div class="cb-stat-label">åˆ¸å•†æ•¸</div>
                    </div>
                </div>
                <div class="cb-ind-title">ğŸ¦ å„åˆ¸å•†å ±å‘Šæ•¸</div>
                <div class="cb-ind-grid">
                    ${brokers.slice(0, 15).map(([b, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${b}')">${b}<span class="num">${padNum(cnt)}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    } else if(MEMO_MODE === 'industry') {
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.industryTotal}</div>
                        <div class="cb-stat-label">ç”¢æ¥­å ±å‘Šæ•¸</div>
                    </div>
                </div>
                <div class="cb-ind-title">ğŸ“Š ç”¢æ¥­å ±å‘Šé¡å‹</div>
                <div class="cb-ind-grid">
                    ${types.filter(([t]) => t.includes('ç”¢æ¥­') || t.includes('TPCA')).map(([t, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${t}')">${t}<span class="num">${padNum(cnt)}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    return '';
}

// åˆ‡æ› Memo æ¨¡å¼
function setMemoMode(mode) {
    MEMO_MODE = mode;
    $('search').value = '';
    renderList();
}

// ========== ç«¶æ‹æŠ•æ¨™æ¨¡æ“¬åˆ†æåŠŸèƒ½ ==========

// å–å¾—è¿‘æœŸç«¶æ‹æ¡ˆä»¶ï¼ˆå¾æ‰¿éŠ·ä¸­ç¯©é¸ç«¶æ‹ï¼‰
function getUpcomingAuctions() {
    return DB.cbPrimary.filter(c => {
        const method = (c._method || '').toLowerCase();
        return method.includes('ç«¶æ‹') || method.includes('ç«¶åƒ¹');
    });
}

// åˆ†æç›¸ä¼¼æ¢ä»¶çš„æ­·å²ç«¶æ‹è³‡æ–™
function analyzeAuctionConditions(primary) {
    const results = {
        byGuarantee: [],      // ç›¸åŒæ“”ä¿æ¢ä»¶
        byYears: [],          // ç›¸åŒå¹´æœŸ
        byIndustry: [],       // ç›¸åŒç”¢æ¥­
        byBroker: [],         // ç›¸åŒåˆ¸å•†
        byCapitalRange: [],   // ç›¸è¿‘è‚¡æœ¬
        byScaleRange: [],     // ç›¸è¿‘ç™¼è¡Œè¦æ¨¡
        combined: []          // ç¶œåˆæ¢ä»¶
    };
    
    // è§£ææ¢ä»¶
    const tcri = (primary._tcri || '').toString();
    const isGuaranteed = tcri.includes('æ“”ä¿') || /éŠ€è¡Œ|å•†éŠ€|åˆåº«/.test(tcri);
    const guarantee = isGuaranteed ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
    const years = parseFloat(primary._years) || 0;
    const capital = parseFloat(primary._capital) || 0;
    const scale = parseFloat(primary._amount) || 0;
    const broker = primary._broker || '';
    
    // å¾è‚¡ç¥¨ä¸»è³‡æ–™å–å¾—ç”¢æ¥­
    const stockCode = primary._stockCode;
    const stockInfo = DB.stocks[stockCode] || {};
    const industry = stockInfo['ç”¢æ¥­åˆ†é¡'] || '';
    
    // éæ­·æ­·å²ç«¶æ‹è³‡æ–™
    DB.cbAuction.forEach(auction => {
        const lowestBid = parseFloat(auction['æœ€ä½å¾—æ¨™']) || 0;
        const avgBid = parseFloat(auction['å¹³å‡å¾—æ¨™']) || 0;
        if(lowestBid <= 0 || avgBid <= 0) return; // è·³éç„¡æ•ˆè³‡æ–™
        
        const auctionGuarantee = auction._guarantee || '';
        const auctionIndustry = auction._industry || '';
        const auctionBroker = auction['ç™¼è¡Œåˆ¸å•†'] || '';
        const auctionScale = parseFloat(auction['ç™¼è¡Œè¦æ¨¡']) || 0;
        
        // 1. ç›¸åŒæ“”ä¿æ¢ä»¶
        if(auctionGuarantee === guarantee) {
            results.byGuarantee.push(auction);
        }
        
        // 2. ç›¸åŒç”¢æ¥­
        if(industry && auctionIndustry && auctionIndustry.includes(industry.replace('æ¥­', ''))) {
            results.byIndustry.push(auction);
        }
        
        // 3. ç›¸åŒåˆ¸å•†
        if(broker && auctionBroker && auctionBroker.includes(broker.replace('è­‰åˆ¸', ''))) {
            results.byBroker.push(auction);
        }
        
        // 4. ç›¸è¿‘è‚¡æœ¬ï¼ˆÂ±50%ï¼‰
        if(capital > 0) {
            // å¾è‚¡ç¥¨è³‡æ–™å–å¾—æ­·å²ç«¶æ‹çš„è‚¡æœ¬ï¼ˆé€™è£¡ç”¨ç™¼è¡Œè¦æ¨¡è¿‘ä¼¼ï¼‰
            if(auctionScale >= capital * 0.3 && auctionScale <= capital * 3) {
                results.byCapitalRange.push(auction);
            }
        }
        
        // 5. ç›¸è¿‘ç™¼è¡Œè¦æ¨¡ï¼ˆÂ±50%ï¼‰
        if(scale > 0 && auctionScale >= scale * 0.5 && auctionScale <= scale * 1.5) {
            results.byScaleRange.push(auction);
        }
        
        // 6. ç¶œåˆæ¢ä»¶ï¼šæ“”ä¿ç›¸åŒ + (ç”¢æ¥­ç›¸åŒ æˆ– ç™¼è¡Œè¦æ¨¡ç›¸è¿‘)
        if(auctionGuarantee === guarantee) {
            const industryMatch = industry && auctionIndustry && auctionIndustry.includes(industry.replace('æ¥­', ''));
            const scaleMatch = scale > 0 && auctionScale >= scale * 0.5 && auctionScale <= scale * 1.5;
            if(industryMatch || scaleMatch) {
                results.combined.push(auction);
            }
        }
    });
    
    return results;
}

// è¨ˆç®—çµ±è¨ˆå€¼
function calcAuctionStats(list) {
    if(!list || list.length === 0) {
        return { count: 0, avgLowest: 0, avgLowestPrem: 0, avgAvg: 0, avgAvgPrem: 0, avgMultiple: 0, avgHigh: 0, avgLow: 0 };
    }
    
    let sumLowest = 0, sumLowestPrem = 0, sumAvg = 0, sumAvgPrem = 0, sumMultiple = 0, sumHigh = 0, sumLow = 0;
    let cntLowest = 0, cntLowestPrem = 0, cntAvg = 0, cntAvgPrem = 0, cntMultiple = 0, cntHigh = 0, cntLow = 0;
    
    list.forEach(a => {
        const lowest = parseFloat(a['æœ€ä½å¾—æ¨™']) || 0;
        const lowestPrem = parseFloat(a['æœ€ä½æº¢åƒ¹']) || 0;
        const avg = parseFloat(a['å¹³å‡å¾—æ¨™']) || 0;
        const avgPrem = parseFloat(a['å¹³å‡æº¢åƒ¹']) || 0;
        const multiple = parseFloat(a['æŠ•æ¨™å€æ•¸']) || 0;
        const high = a._high || 0;
        const low = a._low || 0;
        
        if(lowest > 0) { sumLowest += lowest; cntLowest++; }
        if(lowestPrem !== 0) { sumLowestPrem += lowestPrem; cntLowestPrem++; }
        if(avg > 0) { sumAvg += avg; cntAvg++; }
        if(avgPrem !== 0) { sumAvgPrem += avgPrem; cntAvgPrem++; }
        if(multiple > 0) { sumMultiple += multiple; cntMultiple++; }
        if(high > 0) { sumHigh += high; cntHigh++; }
        if(low > 0) { sumLow += low; cntLow++; }
    });
    
    return {
        count: list.length,
        avgLowest: cntLowest > 0 ? sumLowest / cntLowest : 0,
        avgLowestPrem: cntLowestPrem > 0 ? sumLowestPrem / cntLowestPrem : 0,
        avgAvg: cntAvg > 0 ? sumAvg / cntAvg : 0,
        avgAvgPrem: cntAvgPrem > 0 ? sumAvgPrem / cntAvgPrem : 0,
        avgMultiple: cntMultiple > 0 ? sumMultiple / cntMultiple : 0,
        avgHigh: cntHigh > 0 ? sumHigh / cntHigh : 0,
        avgLow: cntLow > 0 ? sumLow / cntLow : 0
    };
}

// è¨ˆç®—æŠ•æ¨™å»ºè­°åƒ¹æ ¼
// è¨ˆç®—è¿‘ä¸‰å€‹æœˆç«¶æ‹å¸‚æ³è¶¨å‹¢ï¼ˆå€åˆ†æœ‰æ“”ä¿/ç„¡æ“”ä¿ï¼‰
function calcRecentAuctionTrend(isGuaranteed) {
    const now = new Date();
    const threeMonthsAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
    
    // æ ¹æ“šæ“”ä¿é¡å‹ç¯©é¸
    const filterByGuarantee = (list) => {
        return list.filter(c => {
            const guar = c._guarantee || '';
            if(isGuaranteed) return guar === 'æœ‰æ“”ä¿';
            return guar === 'ç„¡æ“”ä¿' || guar === '0' || guar === '';
        });
    };
    
    // ç¯©é¸è¿‘ä¸‰å€‹æœˆçš„ç«¶æ‹è³‡æ–™ï¼ˆä¾æ“”ä¿é¡å‹ï¼‰
    const recentAuctions = filterByGuarantee(DB.cbAuction).filter(c => {
        const bidDate = getDateVal(c['é–‹æ¨™æ—¥æœŸ']);
        return bidDate >= threeMonthsAgo.getTime();
    });
    
    // å…¨éƒ¨æ­·å²è³‡æ–™ï¼ˆä¾æ“”ä¿é¡å‹ï¼‰
    const allAuctions = filterByGuarantee(DB.cbAuction);
    
    if(recentAuctions.length === 0) {
        // å¦‚æœè¿‘ä¸‰å€‹æœˆæ²’æœ‰åŒé¡å‹è³‡æ–™ï¼Œè¨ˆç®—æ•´é«”å¸‚æ³ä½œç‚ºåƒè€ƒ
        return calcOverallRecentTrend(isGuaranteed);
    }
    
    // è¨ˆç®—è¿‘ä¸‰å€‹æœˆå¹³å‡å€¼
    let sumLowestPrem = 0, sumAvgPrem = 0, sumMultiple = 0, sumLowest = 0, sumAvg = 0;
    let lowestPremCnt = 0, avgPremCnt = 0, multipleCnt = 0, lowestCnt = 0, avgCnt = 0;
    
    recentAuctions.forEach(c => {
        const lowestPrem = parseFloat(c['æœ€ä½æº¢åƒ¹']) || 0;
        const avgPrem = parseFloat(c['å¹³å‡æº¢åƒ¹']) || 0;
        const multiple = parseFloat(c['æŠ•æ¨™å€æ•¸']) || 0;
        const lowest = parseFloat(c['æœ€ä½å¾—æ¨™']) || 0;
        const avg = parseFloat(c['å¹³å‡å¾—æ¨™']) || 0;
        
        if(lowestPrem !== 0 || c['æœ€ä½æº¢åƒ¹'] !== undefined) { sumLowestPrem += lowestPrem; lowestPremCnt++; }
        if(avgPrem !== 0 || c['å¹³å‡æº¢åƒ¹'] !== undefined) { sumAvgPrem += avgPrem; avgPremCnt++; }
        if(multiple > 0) { sumMultiple += multiple; multipleCnt++; }
        if(lowest > 0) { sumLowest += lowest; lowestCnt++; }
        if(avg > 0) { sumAvg += avg; avgCnt++; }
    });
    
    const recentLowestPrem = lowestPremCnt > 0 ? sumLowestPrem / lowestPremCnt : 0;
    const recentAvgPrem = avgPremCnt > 0 ? sumAvgPrem / avgPremCnt : 0;
    const recentMultiple = multipleCnt > 0 ? sumMultiple / multipleCnt : 0;
    const recentLowest = lowestCnt > 0 ? sumLowest / lowestCnt : 0;
    const recentAvg = avgCnt > 0 ? sumAvg / avgCnt : 0;
    
    // è¨ˆç®—å…¨éƒ¨æ­·å²å¹³å‡å€¼ä½œç‚ºæ¯”è¼ƒåŸºæº–ï¼ˆåŒé¡å‹ï¼‰
    let histLowestPrem = 0, histAvgPrem = 0, histMultiple = 0, histLowest = 0, histAvg = 0;
    let histLowestPremCnt = 0, histAvgPremCnt = 0, histMultiCnt = 0, histLowestCnt = 0, histAvgCnt = 0;
    
    allAuctions.forEach(c => {
        const lowestPrem = parseFloat(c['æœ€ä½æº¢åƒ¹']) || 0;
        const avgPrem = parseFloat(c['å¹³å‡æº¢åƒ¹']) || 0;
        const multiple = parseFloat(c['æŠ•æ¨™å€æ•¸']) || 0;
        const lowest = parseFloat(c['æœ€ä½å¾—æ¨™']) || 0;
        const avg = parseFloat(c['å¹³å‡å¾—æ¨™']) || 0;
        
        if(lowestPrem !== 0 || c['æœ€ä½æº¢åƒ¹'] !== undefined) { histLowestPrem += lowestPrem; histLowestPremCnt++; }
        if(avgPrem !== 0 || c['å¹³å‡æº¢åƒ¹'] !== undefined) { histAvgPrem += avgPrem; histAvgPremCnt++; }
        if(multiple > 0) { histMultiple += multiple; histMultiCnt++; }
        if(lowest > 0) { histLowest += lowest; histLowestCnt++; }
        if(avg > 0) { histAvg += avg; histAvgCnt++; }
    });
    
    histLowestPrem = histLowestPremCnt > 0 ? histLowestPrem / histLowestPremCnt : 0;
    histAvgPrem = histAvgPremCnt > 0 ? histAvgPrem / histAvgPremCnt : 0;
    histMultiple = histMultiCnt > 0 ? histMultiple / histMultiCnt : 0;
    histLowest = histLowestCnt > 0 ? histLowest / histLowestCnt : 0;
    histAvg = histAvgCnt > 0 ? histAvg / histAvgCnt : 0;
    
    // åˆ¤æ–·å¸‚æ³è¶¨å‹¢å’Œèª¿æ•´å¹…åº¦
    const premDiff = recentAvgPrem - histAvgPrem;       // æº¢åƒ¹ç‡å·®ç•°
    const multipleDiff = recentMultiple - histMultiple; // æŠ•æ¨™å€æ•¸å·®ç•°
    const guaranteeType = isGuaranteed ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
    
    let trend = 'neutral';
    let adjustment = 0;
    let reason = '';
    
    if(premDiff > 0.02 && multipleDiff > 0.5) {
        trend = 'hot';
        adjustment = Math.min(0.025, premDiff * 0.5); // æœ€å¤šèª¿é«˜2.5%
        reason = `${guaranteeType}è¿‘3æœˆæº¢åƒ¹ ${fmtNum(recentAvgPrem * 100, 1)}% é«˜æ–¼æ­·å² ${fmtNum(histAvgPrem * 100, 1)}%ï¼ŒæŠ•æ¨™å€æ•¸ ${fmtNum(recentMultiple, 1)}x é«˜æ–¼ ${fmtNum(histMultiple, 1)}xï¼Œå¸‚å ´ç†±çµ¡`;
    } else if(premDiff < -0.02 && multipleDiff < -0.3) {
        trend = 'cold';
        adjustment = Math.max(-0.025, premDiff * 0.5); // æœ€å¤šèª¿ä½2.5%
        reason = `${guaranteeType}è¿‘3æœˆæº¢åƒ¹ ${fmtNum(recentAvgPrem * 100, 1)}% ä½æ–¼æ­·å² ${fmtNum(histAvgPrem * 100, 1)}%ï¼ŒæŠ•æ¨™å€æ•¸ ${fmtNum(recentMultiple, 1)}x ä½æ–¼ ${fmtNum(histMultiple, 1)}xï¼Œå¸‚å ´å†·æ¸…`;
    } else if(premDiff > 0.01) {
        trend = 'warm';
        adjustment = premDiff * 0.4;
        reason = `${guaranteeType}è¿‘3æœˆæº¢åƒ¹ ${fmtNum(recentAvgPrem * 100, 1)}% ç•¥é«˜æ–¼æ­·å² ${fmtNum(histAvgPrem * 100, 1)}%ï¼Œå¸‚å ´åç†±`;
    } else if(premDiff < -0.01) {
        trend = 'cool';
        adjustment = premDiff * 0.4;
        reason = `${guaranteeType}è¿‘3æœˆæº¢åƒ¹ ${fmtNum(recentAvgPrem * 100, 1)}% ç•¥ä½æ–¼æ­·å² ${fmtNum(histAvgPrem * 100, 1)}%ï¼Œå¸‚å ´åå†·`;
    } else {
        reason = `${guaranteeType}è¿‘3æœˆæº¢åƒ¹ ${fmtNum(recentAvgPrem * 100, 1)}% èˆ‡æ­·å² ${fmtNum(histAvgPrem * 100, 1)}% ç›¸è¿‘ï¼Œå¸‚å ´æŒå¹³`;
    }
    
    return {
        guaranteeType: guaranteeType,
        count: recentAuctions.length,
        totalCount: allAuctions.length,
        avgLowestPrem: recentLowestPrem,
        avgAvgPrem: recentAvgPrem,
        avgMultiple: recentMultiple,
        avgLowest: recentLowest,
        avgAvg: recentAvg,
        histLowestPrem: histLowestPrem,
        histAvgPrem: histAvgPrem,
        histMultiple: histMultiple,
        histLowest: histLowest,
        histAvg: histAvg,
        trend: trend,
        adjustment: adjustment,
        reason: reason
    };
}

// æ•´é«”å¸‚æ³ï¼ˆç•¶ç‰¹å®šæ“”ä¿é¡å‹è¿‘æœŸè³‡æ–™ä¸è¶³æ™‚ä½¿ç”¨ï¼‰
function calcOverallRecentTrend(isGuaranteed) {
    const now = new Date();
    const threeMonthsAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
    const guaranteeType = isGuaranteed ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
    
    const recentAll = DB.cbAuction.filter(c => {
        const bidDate = getDateVal(c['é–‹æ¨™æ—¥æœŸ']);
        return bidDate >= threeMonthsAgo.getTime();
    });
    
    if(recentAll.length === 0) {
        return {
            guaranteeType: guaranteeType,
            count: 0,
            totalCount: 0,
            avgLowestPrem: 0,
            avgAvgPrem: 0,
            avgMultiple: 0,
            histAvgPrem: 0,
            histMultiple: 0,
            trend: 'neutral',
            adjustment: 0,
            reason: `è¿‘3å€‹æœˆç„¡${guaranteeType}ç«¶æ‹è³‡æ–™ï¼Œç„¡æ³•è¨ˆç®—å¸‚æ³èª¿æ•´`
        };
    }
    
    // ç°¡åŒ–è¨ˆç®—æ•´é«”å¹³å‡
    let sumPrem = 0, sumMulti = 0, cnt = 0;
    recentAll.forEach(c => {
        const prem = parseFloat(c['å¹³å‡æº¢åƒ¹']) || 0;
        const multi = parseFloat(c['æŠ•æ¨™å€æ•¸']) || 0;
        if(prem !== 0) { sumPrem += prem; cnt++; }
        if(multi > 0) sumMulti += multi;
    });
    
    return {
        guaranteeType: guaranteeType,
        count: 0,
        totalCount: 0,
        avgAvgPrem: cnt > 0 ? sumPrem / cnt : 0,
        avgMultiple: recentAll.length > 0 ? sumMulti / recentAll.length : 0,
        histAvgPrem: 0,
        histMultiple: 0,
        trend: 'neutral',
        adjustment: 0,
        reason: `è¿‘3å€‹æœˆç„¡${guaranteeType}ç«¶æ‹è³‡æ–™ï¼Œåƒè€ƒæ•´é«”å¸‚æ³ä½†ä¸åšèª¿æ•´`
    };
}

function calcBidSuggestion(primary, analysis, isGuaranteed) {
    const convPrice = parseFloat(primary._convPrice) || 0;
    const stockPrice = parseFloat(primary._stockPrice) || 0;
    const premium = parseFloat(primary._premium) || 0;
    
    // ç†è«–åƒ¹ = è‚¡åƒ¹ / è½‰æ›åƒ¹ * 100
    const theoryPrice = convPrice > 0 ? (stockPrice / convPrice * 100) : 0;
    
    // å–å¾—ç¶œåˆæ¢ä»¶çµ±è¨ˆï¼ˆå„ªå…ˆï¼‰æˆ–æ“”ä¿æ¢ä»¶çµ±è¨ˆ
    const combinedStats = calcAuctionStats(analysis.combined);
    const guaranteeStats = calcAuctionStats(analysis.byGuarantee);
    const stats = combinedStats.count >= 5 ? combinedStats : guaranteeStats;
    
    // æ­·å²å¹³å‡æº¢åƒ¹ç‡ï¼ˆä¾æ“”ä¿é¡å‹å€åˆ†ï¼‰
    // æœ‰æ“”ä¿é€šå¸¸æº¢åƒ¹è¼ƒé«˜ï¼Œç„¡æ“”ä¿è¼ƒä½
    const histAvgPrem = stats.avgAvgPrem || (isGuaranteed ? 0.08 : 0.04); // æœ‰æ“”ä¿é è¨­8%ï¼Œç„¡æ“”ä¿4%
    const histAvgBid = stats.avgAvg || (isGuaranteed ? 108 : 104);
    const histLowestBid = stats.avgLowest || (isGuaranteed ? 105 : 102);
    
    // å–å¾—è¿‘æœŸå¸‚æ³èª¿æ•´ï¼ˆä¾æ“”ä¿é¡å‹å€åˆ†ï¼‰
    const recentTrend = calcRecentAuctionTrend(isGuaranteed);
    const marketAdj = recentTrend.adjustment; // å¸‚æ³èª¿æ•´æ¯”ä¾‹
    
    let suggestion = {
        theoryPrice: theoryPrice,
        method: '',
        methodDetail: '',
        conservativePrice: 0,    // ä¿å®ˆåƒ¹ï¼ˆæ¥è¿‘æœ€ä½å¾—æ¨™ï¼‰
        moderatePrice: 0,        // ç©©å¥åƒ¹ï¼ˆæ¥è¿‘å¹³å‡å¾—æ¨™ï¼‰
        aggressivePrice: 0,      // ç©æ¥µåƒ¹ï¼ˆé«˜æ–¼å¹³å‡å¾—æ¨™ï¼‰
        baseConservative: 0,     // åŸºç¤ä¿å®ˆåƒ¹ï¼ˆèª¿æ•´å‰ï¼‰
        baseModerate: 0,         // åŸºç¤ç©©å¥åƒ¹ï¼ˆèª¿æ•´å‰ï¼‰
        baseAggressive: 0,       // åŸºç¤ç©æ¥µåƒ¹ï¼ˆèª¿æ•´å‰ï¼‰
        reason: '',
        formula: '',
        recentTrend: recentTrend
    };
    
    if(theoryPrice >= 100) {
        // ç†è«–åƒ¹ >= 100ï¼šæœ‰è½‰æ›åƒ¹å€¼ï¼Œç”¨ç†è«–åƒ¹ Ã— æº¢åƒ¹ç‡
        suggestion.method = 'ç†è«–åƒ¹æ³•';
        suggestion.methodDetail = 'ç†è«–åƒ¹ â‰¥ 100ï¼Œå…·æœ‰è½‰æ›åƒ¹å€¼';
        
        // åŸºç¤åƒ¹æ ¼è¨ˆç®—
        suggestion.baseConservative = theoryPrice * (1 + histAvgPrem * 0.5);
        suggestion.baseModerate = theoryPrice * (1 + histAvgPrem);
        suggestion.baseAggressive = theoryPrice * (1 + histAvgPrem * 1.5);
        
        // å¥—ç”¨å¸‚æ³èª¿æ•´
        suggestion.conservativePrice = Math.max(100, suggestion.baseConservative * (1 + marketAdj));
        suggestion.moderatePrice = Math.max(100, suggestion.baseModerate * (1 + marketAdj));
        suggestion.aggressivePrice = Math.max(100, suggestion.baseAggressive * (1 + marketAdj));
        
        suggestion.formula = `ç†è«–åƒ¹ Ã— (1 + æ­·å²æº¢åƒ¹ç‡) Ã— å¸‚æ³èª¿æ•´`;
        suggestion.reason = `ç†è«–åƒ¹ ${fmtNum(theoryPrice, 2)} å…ƒ â‰¥ 100ï¼Œå…·è½‰æ›åƒ¹å€¼`;
        
    } else if(theoryPrice >= 80) {
        // ç†è«–åƒ¹ 80-100ï¼šæ¥è¿‘è½‰æ›åƒ¹å€¼ï¼Œæ··åˆè¨ˆç®—
        suggestion.method = 'æ··åˆè¨ˆç®—æ³•';
        suggestion.methodDetail = 'ç†è«–åƒ¹ 80~100ï¼Œæ¥è¿‘è½‰æ›åƒ¹å€¼';
        
        const blendFactor = (theoryPrice - 80) / 20; // 0~1
        
        // åŸºç¤åƒ¹æ ¼è¨ˆç®—
        suggestion.baseConservative = 100 + (histLowestBid - 100) * (1 - blendFactor * 0.3);
        suggestion.baseModerate = 100 + (histAvgBid - 100) * (1 - blendFactor * 0.2);
        suggestion.baseAggressive = suggestion.baseModerate * 1.03;
        
        // å¥—ç”¨å¸‚æ³èª¿æ•´
        suggestion.conservativePrice = Math.max(100, suggestion.baseConservative * (1 + marketAdj));
        suggestion.moderatePrice = Math.max(100, suggestion.baseModerate * (1 + marketAdj));
        suggestion.aggressivePrice = Math.max(100, suggestion.baseAggressive * (1 + marketAdj));
        
        suggestion.formula = `æ­·å²å‡åƒ¹ Ã— æ··åˆä¿‚æ•¸ Ã— å¸‚æ³èª¿æ•´`;
        suggestion.reason = `ç†è«–åƒ¹ ${fmtNum(theoryPrice, 2)} å…ƒ æ¥è¿‘100ï¼Œæ··åˆåƒè€ƒ`;
        
    } else {
        // ç†è«–åƒ¹ < 80ï¼šåº•æ¨™é™åˆ¶100å…ƒï¼Œç”¨æ­·å²å¹³å‡åƒ¹æ ¼
        suggestion.method = 'æ­·å²å‡åƒ¹æ³•';
        suggestion.methodDetail = 'ç†è«–åƒ¹ < 80ï¼Œå—åº•æ¨™100å…ƒé™åˆ¶';
        
        // åŸºç¤åƒ¹æ ¼è¨ˆç®—
        suggestion.baseConservative = histLowestBid;
        suggestion.baseModerate = histAvgBid;
        suggestion.baseAggressive = histAvgBid + (histAvgBid - histLowestBid) * 0.5;
        
        // å¥—ç”¨å¸‚æ³èª¿æ•´
        suggestion.conservativePrice = Math.max(100, suggestion.baseConservative * (1 + marketAdj));
        suggestion.moderatePrice = Math.max(100, suggestion.baseModerate * (1 + marketAdj));
        suggestion.aggressivePrice = Math.max(100, suggestion.baseAggressive * (1 + marketAdj));
        
        suggestion.formula = `æ­·å²å¹³å‡å¾—æ¨™åƒ¹ Ã— å¸‚æ³èª¿æ•´`;
        suggestion.reason = `ç†è«–åƒ¹ ${fmtNum(theoryPrice, 2)} å…ƒ < 80ï¼Œæ¡æ­·å²å‡åƒ¹`;
    }
    
    // ç¢ºä¿åƒ¹æ ¼ä¸ä½æ–¼100
    suggestion.conservativePrice = Math.max(100, suggestion.conservativePrice);
    suggestion.moderatePrice = Math.max(100, suggestion.moderatePrice);
    suggestion.aggressivePrice = Math.max(100, suggestion.aggressivePrice);
    
    return suggestion;
}

// æ¸²æŸ“è¿‘æœŸç«¶æ‹åˆ†æå€å¡Š
function renderUpcomingAuctions() {
    const auctions = getUpcomingAuctions();
    if(auctions.length === 0) return '<div style="text-align:center;padding:30px;color:#999">ç›®å‰ç„¡è¿‘æœŸç«¶æ‹æ¡ˆä»¶</div>';
    
    let html = '';
    auctions.forEach(p => {
        const analysis = analyzeAuctionConditions(p);
        const tcri = (p._tcri || '').toString();
        const isGuaranteed = tcri.includes('æ“”ä¿') || /éŠ€è¡Œ|å•†éŠ€|åˆåº«/.test(tcri);
        const suggestion = calcBidSuggestion(p, analysis, isGuaranteed);
        const combinedStats = calcAuctionStats(analysis.combined);
        const guaranteeStats = calcAuctionStats(analysis.byGuarantee);
        const stats = combinedStats.count >= 5 ? combinedStats : guaranteeStats;
        
        const guaranteeText = isGuaranteed ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
        const guaranteeClass = isGuaranteed ? 'guar-yes' : '';
        
        html += `
        <div class="auction-analysis-card" onclick="openAuctionAnalysis('${p._stockCode}', '${p._cbCode}')" style="background:#fff;border:2px solid #e0e0e0;border-radius:12px;padding:15px;margin-bottom:12px;cursor:pointer;transition:all 0.2s">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
                <div>
                    <div style="font-size:16px;font-weight:700;color:#333">${p._name} <span style="color:#999;font-size:13px">${p._stockCode}</span></div>
                    <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap">
                        <span class="tag brk">${p._broker}</span>
                        <span class="tag ${guaranteeClass}" style="${isGuaranteed ? 'background:#ffe4ec;color:#d63384' : ''}">${guaranteeText}</span>
                        <span class="tag dt">${p._bidPeriod || 'å¾…å®š'}</span>
                    </div>
                </div>
                <div style="text-align:right">
                    <div style="font-size:11px;color:#888">ç™¼è¡Œè¦æ¨¡</div>
                    <div style="font-size:16px;font-weight:700;color:var(--primary)">${fmtNum(p._amount, 0)} å„„</div>
                </div>
            </div>
            
            <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:8px;margin:12px 0;padding:12px;background:#f8f9fa;border-radius:8px">
                <div style="text-align:center">
                    <div style="font-size:11px;color:#888">è½‰æ›åƒ¹</div>
                    <div style="font-size:14px;font-weight:600">${fmtNum(p._convPrice, 1)}</div>
                </div>
                <div style="text-align:center">
                    <div style="font-size:11px;color:#888">è‚¡åƒ¹</div>
                    <div style="font-size:14px;font-weight:600">${fmtNum(p._stockPrice, 1)}</div>
                </div>
                <div style="text-align:center">
                    <div style="font-size:11px;color:#888">ç†è«–åƒ¹</div>
                    <div style="font-size:14px;font-weight:600;color:${suggestion.theoryPrice >= 100 ? '#27ae60' : '#e74c3c'}">${fmtNum(suggestion.theoryPrice, 1)}</div>
                </div>
                <div style="text-align:center">
                    <div style="font-size:11px;color:#888">è¨‚åƒ¹æº¢åƒ¹</div>
                    <div style="font-size:14px;font-weight:600">${fmtNum((p._premium || 0) * 100, 1)}%</div>
                </div>
            </div>
            
            <div style="background:linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);padding:12px;border-radius:8px;margin-top:10px">
                <div style="font-size:12px;color:#e65100;margin-bottom:8px">ğŸ“Š æŠ•æ¨™å»ºè­°ï¼ˆ${suggestion.method}ï¼‰- åƒè€ƒ${stats.count}ç­†æ­·å²è³‡æ–™</div>
                <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:10px">
                    <div style="text-align:center;background:#fff;padding:8px;border-radius:6px">
                        <div style="font-size:10px;color:#666">ä¿å®ˆåƒ¹</div>
                        <div style="font-size:16px;font-weight:700;color:#2e7d32">${fmtNum(suggestion.conservativePrice, 2)}</div>
                    </div>
                    <div style="text-align:center;background:#fff;padding:8px;border-radius:6px;border:2px solid #ff9800">
                        <div style="font-size:10px;color:#666">ç©©å¥åƒ¹</div>
                        <div style="font-size:18px;font-weight:800;color:#e65100">${fmtNum(suggestion.moderatePrice, 2)}</div>
                    </div>
                    <div style="text-align:center;background:#fff;padding:8px;border-radius:6px">
                        <div style="font-size:10px;color:#666">ç©æ¥µåƒ¹</div>
                        <div style="font-size:16px;font-weight:700;color:#c62828">${fmtNum(suggestion.aggressivePrice, 2)}</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top:10px;font-size:11px;color:#666;text-align:right">
                ğŸ“ˆ æ­·å²å‡é«˜ ${fmtNum(stats.avgHigh, 1)} ï½œ ğŸ“‰ æ­·å²å‡ä½ ${fmtNum(stats.avgLow, 1)} ï½œ é»æ“ŠæŸ¥çœ‹è©³ç´°åˆ†æ â†’
            </div>
        </div>
        `;
    });
    
    return html;
}

// é–‹å•Ÿç«¶æ‹åˆ†æå½ˆçª—
window.openAuctionAnalysis = (stockCode, cbCode) => {
    let primary = DB.cbPrimary.find(p => p._stockCode === stockCode && p._cbCode === cbCode);
    if(!primary) {
        // å˜—è©¦åªç”¨ stockCode æ‰¾
        primary = DB.cbPrimary.find(p => p._stockCode === stockCode);
        if(!primary) { alert('æ‰¾ä¸åˆ°æ¡ˆä»¶è³‡æ–™'); return; }
    }
    
    const tcri = (primary._tcri || '').toString();
    const isGuaranteed = tcri.includes('æ“”ä¿') || /éŠ€è¡Œ|å•†éŠ€|åˆåº«/.test(tcri);
    const guaranteeText = isGuaranteed ? 'æœ‰æ“”ä¿' : 'ç„¡æ“”ä¿';
    
    const analysis = analyzeAuctionConditions(primary);
    const suggestion = calcBidSuggestion(primary, analysis, isGuaranteed);
    
    const combinedStats = calcAuctionStats(analysis.combined);
    const guaranteeStats = calcAuctionStats(analysis.byGuarantee);
    const industryStats = calcAuctionStats(analysis.byIndustry);
    const brokerStats = calcAuctionStats(analysis.byBroker);
    
    const stockInfo = DB.stocks[stockCode] || {};
    const industry = stockInfo['ç”¢æ¥­åˆ†é¡'] || 'æœªåˆ†é¡';
    
    const infoHtml = `
        <div style="font-size:20px;font-weight:700;margin-bottom:5px">${primary._name} <span style="color:#999;font-size:14px">${stockCode}</span></div>
        <div class="card-meta">
            <span class="tag brk">${primary._broker}</span>
            <span class="tag ind">${industry}</span>
            <span class="tag ${isGuaranteed ? 'trend-up' : 'dt'}">${guaranteeText}</span>
            <span class="tag dt">${primary._bidPeriod || 'æŠ•æ¨™æœŸé–“å¾…å®š'}</span>
        </div>
    `;
    
    // å»ºç«‹çµ±è¨ˆæ¯”è¼ƒè¡¨æ ¼
    const renderStatsTable = (title, stats, list) => {
        if(stats.count === 0) return `<div style="color:#999;font-size:13px;padding:10px">${title}ï¼šç„¡ç¬¦åˆè³‡æ–™</div>`;
        return `
            <div class="section-head">${title} (${stats.count}ç­†)</div>
            <div class="grid-2" style="grid-template-columns:repeat(4,1fr);gap:8px">
                <div class="stat-box"><div class="num">${fmtNum(stats.avgLowest, 2)}</div><div class="lbl">æœ€ä½å¾—æ¨™å‡åƒ¹</div></div>
                <div class="stat-box"><div class="num">${fmtNum(stats.avgLowestPrem * 100, 1)}%</div><div class="lbl">æœ€ä½æº¢åƒ¹ç‡</div></div>
                <div class="stat-box"><div class="num">${fmtNum(stats.avgAvg, 2)}</div><div class="lbl">å¹³å‡å¾—æ¨™å‡åƒ¹</div></div>
                <div class="stat-box"><div class="num">${fmtNum(stats.avgAvgPrem * 100, 1)}%</div><div class="lbl">å¹³å‡æº¢åƒ¹ç‡</div></div>
            </div>
            <div class="grid-2" style="grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
                <div class="stat-box"><div class="num">${fmtNum(stats.avgMultiple, 1)}x</div><div class="lbl">å¹³å‡æŠ•æ¨™å€æ•¸</div></div>
                <div class="stat-box"><div class="num">${fmtNum(stats.avgHigh, 1)}</div><div class="lbl">æ›ç‰Œå‡é«˜åƒ¹</div></div>
                <div class="stat-box"><div class="num">${fmtNum(stats.avgLow, 1)}</div><div class="lbl">æ›ç‰Œå‡ä½åƒ¹</div></div>
            </div>
        `;
    };
    
    // Tab 1: æŠ•æ¨™å»ºè­°
    const recentTrend = suggestion.recentTrend || {};
    const trendIcon = recentTrend.trend === 'hot' ? 'ğŸ”¥' : recentTrend.trend === 'warm' ? 'ğŸ“ˆ' : recentTrend.trend === 'cold' ? 'â„ï¸' : recentTrend.trend === 'cool' ? 'ğŸ“‰' : 'â¡ï¸';
    const trendText = recentTrend.trend === 'hot' ? 'ç†±çµ¡' : recentTrend.trend === 'warm' ? 'åç†±' : recentTrend.trend === 'cold' ? 'å†·æ¸…' : recentTrend.trend === 'cool' ? 'åå†·' : 'æŒå¹³';
    const trendColor = recentTrend.trend === 'hot' || recentTrend.trend === 'warm' ? '#e65100' : recentTrend.trend === 'cold' || recentTrend.trend === 'cool' ? '#1565c0' : '#666';
    const adjPct = (recentTrend.adjustment || 0) * 100;
    const adjText = adjPct > 0 ? `+${fmtNum(adjPct, 1)}%` : adjPct < 0 ? `${fmtNum(adjPct, 1)}%` : 'ç„¡èª¿æ•´';
    
    let tSuggest = `
        <div class="rating-card" style="background:linear-gradient(135deg, #e65100 0%, #ff9800 100%)">
            <div style="font-size:14px;opacity:0.9;margin-bottom:5px">ğŸ“Š ${suggestion.method}</div>
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                    <div style="font-size:12px;opacity:0.8">ç†è«–åƒ¹æ ¼</div>
                    <div class="big-num">${fmtNum(suggestion.theoryPrice, 2)}</div>
                </div>
                <div style="text-align:right">
                    <div style="font-size:12px;opacity:0.8">ç©©å¥å»ºè­°åƒ¹</div>
                    <div class="big-num">${fmtNum(suggestion.moderatePrice, 2)}</div>
                </div>
            </div>
        </div>
        
        <div class="section-head">ğŸ’° æŠ•æ¨™åƒ¹æ ¼å»ºè­°å€é–“</div>
        <div class="grid-2" style="grid-template-columns:repeat(3, 1fr)">
            <div class="stat-box" style="background:#e8f5e9;border:2px solid #4caf50">
                <div style="font-size:11px;color:#2e7d32;margin-bottom:4px">ğŸ›¡ï¸ ä¿å®ˆç­–ç•¥</div>
                <div class="num" style="color:#2e7d32">${fmtNum(suggestion.conservativePrice, 2)}</div>
                <div class="lbl">æ¥è¿‘æœ€ä½å¾—æ¨™</div>
            </div>
            <div class="stat-box" style="background:#fff3e0;border:3px solid #ff9800">
                <div style="font-size:11px;color:#e65100;margin-bottom:4px">â­ ç©©å¥ç­–ç•¥</div>
                <div class="num" style="color:#e65100;font-size:22px">${fmtNum(suggestion.moderatePrice, 2)}</div>
                <div class="lbl">æ¥è¿‘å¹³å‡å¾—æ¨™</div>
            </div>
            <div class="stat-box" style="background:#ffebee;border:2px solid #f44336">
                <div style="font-size:11px;color:#c62828;margin-bottom:4px">ğŸ”¥ ç©æ¥µç­–ç•¥</div>
                <div class="num" style="color:#c62828">${fmtNum(suggestion.aggressivePrice, 2)}</div>
                <div class="lbl">é«˜æ–¼å¹³å‡å¾—æ¨™</div>
            </div>
        </div>
        
        <div class="section-head">ğŸ“ è¨ˆç®—æ–¹æ³•èªªæ˜ <span style="font-size:12px;color:#666;font-weight:400">ã€${guaranteeText}ã€‘</span></div>
        <div class="hl-block" style="border-left-color:#1565c0;background:#f5f9ff">
            <b>ğŸ”¹ æ¡ç”¨æ–¹æ³•ï¼š${suggestion.method}</b><br>
            <span style="color:#666">${suggestion.methodDetail || ''}</span><br>
            <span style="color:#888;font-size:11px">â€» ä»¥ä¸‹è¨ˆç®—çš†ä½¿ç”¨ã€${guaranteeText}ã€‘æ­·å²æ•¸æ“š</span><br><br>
            
            <b>ğŸ“Œ ç†è«–åƒ¹è¨ˆç®—</b><br>
            ç†è«–åƒ¹ = ç¾è‚¡è‚¡åƒ¹ Ã· è½‰æ›åƒ¹æ ¼ Ã— 100<br>
            = ${fmtNum(primary._stockPrice, 2)} Ã· ${fmtNum(primary._convPrice, 2)} Ã— 100 = <b style="color:var(--primary)">${fmtNum(suggestion.theoryPrice, 2)}</b><br><br>
            
            <b>ğŸ“Œ ä¸‰ç¨®ç­–ç•¥èªªæ˜</b> <span style="color:#888;font-size:11px">(${guaranteeText}æ­·å²æº¢åƒ¹ç‡ï¼š${fmtNum((guaranteeStats.avgAvgPrem || (isGuaranteed ? 0.08 : 0.04)) * 100, 1)}%)</span><br>
            ${suggestion.method === 'ç†è«–åƒ¹æ³•' ? `
            â€¢ <b style="color:#2e7d32">ä¿å®ˆ</b> = ç†è«–åƒ¹ Ã— (1 + æ­·å²æº¢åƒ¹ç‡ Ã— 0.5) = ${fmtNum(suggestion.theoryPrice, 2)} Ã— ${fmtNum(1 + (guaranteeStats.avgAvgPrem || (isGuaranteed ? 0.08 : 0.04)) * 0.5, 4)}<br>
            â€¢ <b style="color:#e65100">ç©©å¥</b> = ç†è«–åƒ¹ Ã— (1 + æ­·å²æº¢åƒ¹ç‡) = ${fmtNum(suggestion.theoryPrice, 2)} Ã— ${fmtNum(1 + (guaranteeStats.avgAvgPrem || (isGuaranteed ? 0.08 : 0.04)), 4)}<br>
            â€¢ <b style="color:#c62828">ç©æ¥µ</b> = ç†è«–åƒ¹ Ã— (1 + æ­·å²æº¢åƒ¹ç‡ Ã— 1.5) = ${fmtNum(suggestion.theoryPrice, 2)} Ã— ${fmtNum(1 + (guaranteeStats.avgAvgPrem || (isGuaranteed ? 0.08 : 0.04)) * 1.5, 4)}
            ` : suggestion.method === 'æ··åˆè¨ˆç®—æ³•' ? `
            â€¢ <b style="color:#2e7d32">ä¿å®ˆ</b> = 100 + (æ­·å²æœ€ä½å‡åƒ¹ - 100) Ã— æ··åˆä¿‚æ•¸<br>
            â€¢ <b style="color:#e65100">ç©©å¥</b> = 100 + (æ­·å²å¹³å‡å‡åƒ¹ - 100) Ã— æ··åˆä¿‚æ•¸<br>
            â€¢ <b style="color:#c62828">ç©æ¥µ</b> = ç©©å¥åƒ¹ Ã— 1.03
            ` : `
            â€¢ <b style="color:#2e7d32">ä¿å®ˆ</b> = ${guaranteeText}æ­·å²æœ€ä½å¾—æ¨™å‡åƒ¹ = ${fmtNum(guaranteeStats.avgLowest || (isGuaranteed ? 105 : 102), 2)}<br>
            â€¢ <b style="color:#e65100">ç©©å¥</b> = ${guaranteeText}æ­·å²å¹³å‡å¾—æ¨™å‡åƒ¹ = ${fmtNum(guaranteeStats.avgAvg || (isGuaranteed ? 108 : 104), 2)}<br>
            â€¢ <b style="color:#c62828">ç©æ¥µ</b> = å¹³å‡åƒ¹ + (å¹³å‡åƒ¹ - æœ€ä½åƒ¹) Ã— 0.5
            `}
        </div>
        
        <div class="section-head">${trendIcon} è¿‘3å€‹æœˆã€${guaranteeText}ã€‘å¸‚æ³èª¿æ•´</div>
        <div class="hl-block" style="border-left-color:${trendColor}">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                <div>
                    <b>å¸‚å ´æ°›åœï¼š</b><span style="color:${trendColor};font-weight:700">${trendText}</span>
                    <span style="font-size:11px;color:#888;margin-left:8px">(${guaranteeText}é¡å‹)</span>
                </div>
                <div style="background:${trendColor};color:#fff;padding:4px 12px;border-radius:12px;font-weight:700">
                    èª¿æ•´å¹…åº¦ï¼š${adjText}
                </div>
            </div>
            <b>ğŸ“Š è¿‘3å€‹æœˆã€${guaranteeText}ã€‘ç«¶æ‹çµ±è¨ˆ (${recentTrend.count || 0}ç­† / æ­·å²å…±${recentTrend.totalCount || 0}ç­†)</b><br>
            â€¢ å¹³å‡æº¢åƒ¹ç‡ï¼š${fmtNum((recentTrend.avgAvgPrem || 0) * 100, 1)}% <span style="color:#888">(${guaranteeText}æ­·å²å¹³å‡ ${fmtNum((recentTrend.histAvgPrem || 0) * 100, 1)}%)</span><br>
            â€¢ æŠ•æ¨™å€æ•¸ï¼š${fmtNum(recentTrend.avgMultiple || 0, 1)}x <span style="color:#888">(${guaranteeText}æ­·å²å¹³å‡ ${fmtNum(recentTrend.histMultiple || 0, 1)}x)</span><br>
            ${recentTrend.avgLowest ? `â€¢ æœ€ä½å¾—æ¨™å‡åƒ¹ï¼š${fmtNum(recentTrend.avgLowest, 2)} <span style="color:#888">(æ­·å² ${fmtNum(recentTrend.histLowest || 0, 2)})</span><br>` : ''}
            ${recentTrend.avgAvg ? `â€¢ å¹³å‡å¾—æ¨™å‡åƒ¹ï¼š${fmtNum(recentTrend.avgAvg, 2)} <span style="color:#888">(æ­·å² ${fmtNum(recentTrend.histAvg || 0, 2)})</span><br>` : ''}
            <br><span style="color:#666;font-size:12px">${recentTrend.reason || ''}</span>
        </div>
        
        <div class="section-head">ğŸ“Š èª¿æ•´å‰å¾Œå°æ¯”</div>
        <div class="cb-table-wrap"><table class="cb-table" style="font-size:13px">
            <thead><tr>
                <th>ç­–ç•¥</th>
                <th>åŸºç¤åƒ¹æ ¼</th>
                <th>å¸‚æ³èª¿æ•´</th>
                <th>æœ€çµ‚å»ºè­°</th>
            </tr></thead>
            <tbody>
                <tr>
                    <td style="color:#2e7d32;font-weight:600">ğŸ›¡ï¸ ä¿å®ˆ</td>
                    <td>${fmtNum(suggestion.baseConservative, 2)}</td>
                    <td style="color:${trendColor}">${adjText}</td>
                    <td style="font-weight:700;color:#2e7d32">${fmtNum(suggestion.conservativePrice, 2)}</td>
                </tr>
                <tr style="background:#fff8f0">
                    <td style="color:#e65100;font-weight:600">â­ ç©©å¥</td>
                    <td>${fmtNum(suggestion.baseModerate, 2)}</td>
                    <td style="color:${trendColor}">${adjText}</td>
                    <td style="font-weight:700;color:#e65100;font-size:15px">${fmtNum(suggestion.moderatePrice, 2)}</td>
                </tr>
                <tr>
                    <td style="color:#c62828;font-weight:600">ğŸ”¥ ç©æ¥µ</td>
                    <td>${fmtNum(suggestion.baseAggressive, 2)}</td>
                    <td style="color:${trendColor}">${adjText}</td>
                    <td style="font-weight:700;color:#c62828">${fmtNum(suggestion.aggressivePrice, 2)}</td>
                </tr>
            </tbody>
        </table></div>
        
        <div class="section-head">ğŸ“‹ æ¡ˆä»¶åŸºæœ¬è³‡æ–™</div>
        <div class="info-row"><span class="info-label">ç™¼è¡Œè¦æ¨¡</span><span class="info-val">${fmtNum(primary._amount, 0)} å„„</span></div>
        <div class="info-row"><span class="info-label">è½‰æ›åƒ¹æ ¼</span><span class="info-val">${fmtNum(primary._convPrice, 2)} å…ƒ</span></div>
        <div class="info-row"><span class="info-label">ç¾è‚¡è‚¡åƒ¹</span><span class="info-val">${fmtNum(primary._stockPrice, 2)} å…ƒ</span></div>
        <div class="info-row"><span class="info-label">è¨‚åƒ¹æº¢åƒ¹ç‡</span><span class="info-val">${fmtNum((primary._premium || 0) * 100, 1)}%</span></div>
        <div class="info-row"><span class="info-label">è‚¡æœ¬</span><span class="info-val">${fmtNum(primary._capital, 0)} å„„</span></div>
        <div class="info-row"><span class="info-label">60å¤©æ³¢å‹•ç‡</span><span class="info-val">${fmtNum((primary._volatility || 0) * 100, 1)}%</span></div>
        <div class="info-row"><span class="info-label">å¹´æœŸ</span><span class="info-val">${primary._years || '-'} å¹´</span></div>
        <div class="info-row"><span class="info-label">è³£å›æ¢ä»¶</span><span class="info-val">${primary._putback || '-'}</span></div>
    `;
    
    // Tab 2: æ¢ä»¶åˆ†æ
    let tAnalysis = `
        <div class="hl-block" style="border-left-color:#1565c0">
            <b>ğŸ“Š åˆ†ææ¢ä»¶</b><br>
            æ“”ä¿ï¼š${guaranteeText} ï½œ ç”¢æ¥­ï¼š${industry} ï½œ åˆ¸å•†ï¼š${primary._broker}<br>
            ç™¼è¡Œè¦æ¨¡ï¼š${fmtNum(primary._amount, 0)}å„„ ï½œ è‚¡æœ¬ï¼š${fmtNum(primary._capital, 0)}å„„
        </div>
        
        ${renderStatsTable('ğŸ”¹ ç¶œåˆæ¢ä»¶ï¼ˆæ“”ä¿+ç”¢æ¥­/è¦æ¨¡ï¼‰', combinedStats, analysis.combined)}
        ${renderStatsTable('ğŸ”¸ ç›¸åŒæ“”ä¿æ¢ä»¶', guaranteeStats, analysis.byGuarantee)}
        ${renderStatsTable('ğŸ”¹ ç›¸åŒç”¢æ¥­', industryStats, analysis.byIndustry)}
        ${renderStatsTable('ğŸ”¸ ç›¸åŒç™¼è¡Œåˆ¸å•†', brokerStats, analysis.byBroker)}
    `;
    
    // Tab 3: æ­·å²æ¡ˆä¾‹
    const displayList = analysis.combined.length > 0 ? analysis.combined : analysis.byGuarantee;
    let tHistory = `
        <div class="section-head">ğŸ“œ ç›¸ä¼¼æ¢ä»¶æ­·å²æ¡ˆä¾‹ (${displayList.length}ç­†)</div>
    `;
    
    if(displayList.length === 0) {
        tHistory += '<div style="text-align:center;padding:30px;color:#999">ç„¡ç¬¦åˆæ¢ä»¶çš„æ­·å²è³‡æ–™</div>';
    } else {
        tHistory += `<div class="cb-table-wrap"><table class="cb-table" style="font-size:12px">
            <thead><tr>
                <th>CBä»£è™Ÿ</th>
                <th>åç¨±</th>
                <th>é–‹æ¨™æ—¥</th>
                <th>æœ€ä½å¾—æ¨™</th>
                <th>å¹³å‡å¾—æ¨™</th>
                <th>æŠ•æ¨™å€æ•¸</th>
                <th>æ›ç‰Œæœ€é«˜</th>
                <th>æ›ç‰Œæœ€ä½</th>
            </tr></thead><tbody>`;
        
        displayList.slice(0, 20).forEach(a => {
            tHistory += `<tr>
                <td class="code" onclick="openCbInfo('${a._cbCode}')">${a._cbCode}</td>
                <td>${a._name}</td>
                <td>${fmtDate(a['é–‹æ¨™æ—¥æœŸ'])}</td>
                <td>${fmtNum(a['æœ€ä½å¾—æ¨™'], 2)}</td>
                <td>${fmtNum(a['å¹³å‡å¾—æ¨™'], 2)}</td>
                <td>${fmtNum(a['æŠ•æ¨™å€æ•¸'], 1)}x</td>
                <td>${fmtNum(a._high, 1)}</td>
                <td>${fmtNum(a._low, 1)}</td>
            </tr>`;
        });
        
        tHistory += '</tbody></table></div>';
    }
    
    // Tab 4: é¢¨éšªæç¤º
    let tRisk = `
        <div class="hl-block" style="border-left-color:#c62828;background:#ffebee">
            <b>âš ï¸ æŠ•æ¨™é¢¨éšªæç¤º</b><br><br>
            1. ä»¥ä¸Šå»ºè­°åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›å¾—æ¨™åƒ¹æ ¼å—å¸‚å ´ä¾›éœ€å½±éŸ¿<br>
            2. ç†è«–åƒ¹ä½æ–¼100å…ƒæ™‚ï¼Œå› åº•æ¨™é™åˆ¶ï¼Œæº¢åƒ¹ç‡é€šå¸¸è¼ƒé«˜<br>
            3. æŠ•æ¨™å€æ•¸è¶Šé«˜ï¼Œç«¶çˆ­è¶Šæ¿€çƒˆï¼Œéœ€é©åº¦æé«˜æŠ•æ¨™åƒ¹æ ¼<br>
            4. å»ºè­°è§€å¯Ÿæˆªæ¨™æ—¥è‚¡åƒ¹è®ŠåŒ–ï¼Œé©æ™‚èª¿æ•´æŠ•æ¨™ç­–ç•¥
        </div>
        
        <div class="section-head">ğŸ“ˆ ç†è«–åƒ¹èˆ‡æŠ•æ¨™ç­–ç•¥é—œä¿‚</div>
        <div class="hl-block">
            <b>ç•¶ç†è«–åƒ¹ â‰¥ 100 å…ƒï¼š</b><br>
            å¯è½‰å‚µå…·æœ‰è½‰æ›åƒ¹å€¼ï¼ŒæŠ•æ¨™åƒ¹æ ¼å¯æ¡ç”¨ã€Œç†è«–åƒ¹ Ã— (1 + æº¢åƒ¹ç‡)ã€è¨ˆç®—<br><br>
            <b>ç•¶ç†è«–åƒ¹ < 100 å…ƒï¼š</b><br>
            å› åº•æ¨™100å…ƒé™åˆ¶ï¼Œæº¢åƒ¹ç‡æœƒåé«˜ï¼Œå»ºè­°åƒè€ƒæ­·å²å¹³å‡å¾—æ¨™åƒ¹æ ¼
        </div>
        
        <div class="section-head">ğŸ’¡ æŠ•æ¨™æŠ€å·§å»ºè­°</div>
        <div class="hl-block">
            1. æˆªæ¨™æ—¥ 13:30 æ”¶ç›¤å¾Œå†æ±ºå®šæœ€çµ‚æŠ•æ¨™åƒ¹æ ¼<br>
            2. åƒè€ƒç•¶æ—¥ç†è«–åƒ¹è®ŠåŒ–èª¿æ•´æŠ•æ¨™é‡‘é¡<br>
            3. è‹¥å¸‚å ´æ°£æ°›ç†±çµ¡ï¼Œå¯é©åº¦æé«˜1-2å…ƒ<br>
            4. æ§åˆ¶å–®ç­†æŠ•æ¨™é‡‘é¡ï¼Œåˆ†æ•£é¢¨éšª<br>
            5. å»ºè­°åªå¡«å¯«ä¸€å€‹åƒ¹æ ¼ï¼Œå°ˆæ³¨æ–¼æœ€ä½³æŠ•æ¨™é»
        </div>
    `;
    
    const navItems = [
        {id:'suggest', icon:'ğŸ’°', label:'æŠ•æ¨™å»ºè­°'},
        {id:'analysis', icon:'ğŸ“Š', label:'æ¢ä»¶åˆ†æ'},
        {id:'history', icon:'ğŸ“œ', label:'æ­·å²æ¡ˆä¾‹'},
        {id:'risk', icon:'âš ï¸', label:'é¢¨éšªæç¤º'}
    ];
    
    $('m-body').innerHTML = `
        <div id="tab-suggest" class="tab-pane active">${tSuggest}</div>
        <div id="tab-analysis" class="tab-pane">${tAnalysis}</div>
        <div id="tab-history" class="tab-pane">${tHistory}</div>
        <div id="tab-risk" class="tab-pane">${tRisk}</div>
    `;
    showModal(infoHtml, navItems);
};

// ç«¶æ‹å‰ååè¡¨æ ¼
function renderAuctionTop10() {
    if(DB.cbAuction.length === 0 || !AUCTION_TOP10) return '';
    
    // æœ‰æ“”ä¿ - æœ€ä½å¾—æ¨™ç”±é«˜åˆ°ä½å‰å
    const guarLowest = DB.cbAuction
        .filter(c => c._guarantee === 'æœ‰æ“”ä¿' && parseFloat(c['æœ€ä½å¾—æ¨™']) > 0)
        .sort((a, b) => parseFloat(b['æœ€ä½å¾—æ¨™']) - parseFloat(a['æœ€ä½å¾—æ¨™']))
        .slice(0, 10);
    
    // ç„¡æ“”ä¿ - æœ€ä½å¾—æ¨™ç”±é«˜åˆ°ä½å‰å
    const noGuarLowest = DB.cbAuction
        .filter(c => c._guarantee === 'ç„¡æ“”ä¿' && parseFloat(c['æœ€ä½å¾—æ¨™']) > 0)
        .sort((a, b) => parseFloat(b['æœ€ä½å¾—æ¨™']) - parseFloat(a['æœ€ä½å¾—æ¨™']))
        .slice(0, 10);
    
    // æœ‰æ“”ä¿ - å¹³å‡å¾—æ¨™ç”±é«˜åˆ°ä½å‰å
    const guarAvg = DB.cbAuction
        .filter(c => c._guarantee === 'æœ‰æ“”ä¿' && parseFloat(c['å¹³å‡å¾—æ¨™']) > 0)
        .sort((a, b) => parseFloat(b['å¹³å‡å¾—æ¨™']) - parseFloat(a['å¹³å‡å¾—æ¨™']))
        .slice(0, 10);
    
    // ç„¡æ“”ä¿ - å¹³å‡å¾—æ¨™ç”±é«˜åˆ°ä½å‰å
    const noGuarAvg = DB.cbAuction
        .filter(c => c._guarantee === 'ç„¡æ“”ä¿' && parseFloat(c['å¹³å‡å¾—æ¨™']) > 0)
        .sort((a, b) => parseFloat(b['å¹³å‡å¾—æ¨™']) - parseFloat(a['å¹³å‡å¾—æ¨™']))
        .slice(0, 10);
    
    // æ›ç‰Œå¾Œæœ€é«˜ TOP10 (å…¨éƒ¨ï¼Œç”±é«˜åˆ°ä½)
    const highPrice = DB.cbAuction
        .filter(c => c._high > 0)
        .sort((a, b) => b._high - a._high)
        .slice(0, 10);
    
    // æœ‰æ“”ä¿ - æŠ•æ¨™å€æ•¸ç”±é«˜åˆ°ä½å‰å
    const guarMultiple = DB.cbAuction
        .filter(c => c._guarantee === 'æœ‰æ“”ä¿' && parseFloat(c['æŠ•æ¨™å€æ•¸']) > 0)
        .sort((a, b) => parseFloat(b['æŠ•æ¨™å€æ•¸']) - parseFloat(a['æŠ•æ¨™å€æ•¸']))
        .slice(0, 10);
    
    // ç„¡æ“”ä¿ - æŠ•æ¨™å€æ•¸ç”±é«˜åˆ°ä½å‰å
    const noGuarMultiple = DB.cbAuction
        .filter(c => c._guarantee === 'ç„¡æ“”ä¿' && parseFloat(c['æŠ•æ¨™å€æ•¸']) > 0)
        .sort((a, b) => parseFloat(b['æŠ•æ¨™å€æ•¸']) - parseFloat(a['æŠ•æ¨™å€æ•¸']))
        .slice(0, 10);
    
    // å¼·å‹¢æŠ—è·Œæ¨™çš„ - (æ›ç‰Œæœ€ä½ - æœ€ä½å¾—æ¨™) / æœ€ä½å¾—æ¨™ï¼Œè·Œå¹…è¶Šå°è¶ŠæŠ—è·Œ
    const antiDrop = DB.cbAuction
        .filter(c => {
            const lowestBid = parseFloat(c['æœ€ä½å¾—æ¨™']) || 0;
            const low = c._low || 0;
            return lowestBid > 0 && low > 0;
        })
        .map(c => {
            const lowestBid = parseFloat(c['æœ€ä½å¾—æ¨™']);
            const low = c._low;
            const dropRate = (low - lowestBid) / lowestBid * 100;
            return { ...c, _dropRate: dropRate };
        })
        .sort((a, b) => b._dropRate - a._dropRate) // è·Œå¹…è¶Šå°(æˆ–æ­£å€¼)è¶Šå‰é¢
        .slice(0, 10);
    
    const renderTable = (list, title, highlightField) => {
        if(list.length === 0) return '';
        const showDropRate = highlightField === '_dropRate';
        const isMultipleRank = highlightField === 'æŠ•æ¨™å€æ•¸'; // æŠ•æ¨™å€æ•¸æ’è¡Œæ¦œ
        
        // è¨ˆç®—åˆè¨ˆ/å¹³å‡å€¼
        const count = list.length;
        const sumBidLots = list.reduce((s, c) => s + (parseFloat(c['ç«¶æ‹å¼µæ•¸']) || 0), 0);
        const sumTotalBidLots = list.reduce((s, c) => s + (parseFloat(c['æŠ•æ¨™å¼µæ•¸']) || 0), 0);
        const avgMultiple = list.reduce((s, c) => s + (parseFloat(c['æŠ•æ¨™å€æ•¸']) || 0), 0) / count;
        const avgBasePrice = list.reduce((s, c) => s + (parseFloat(c['åº•æ¨™åƒ¹']) || 0), 0) / count;
        const avgClosePrice = list.filter(c => c['æˆªæ¨™æ”¶ç›¤']).reduce((s, c) => s + (parseFloat(c['æˆªæ¨™æ”¶ç›¤']) || 0), 0) / (list.filter(c => c['æˆªæ¨™æ”¶ç›¤']).length || 1);
        const avgConvPrice = list.reduce((s, c) => s + (parseFloat(c['è½‰æ›åƒ¹']) || 0), 0) / count;
        const avgTheory = list.reduce((s, c) => s + (parseFloat(c['æˆªæ¨™ç†è«–']) || 0), 0) / count;
        const avgLowestBid = list.reduce((s, c) => s + (parseFloat(c['æœ€ä½å¾—æ¨™']) || 0), 0) / count;
        const avgAvgBid = list.reduce((s, c) => s + (parseFloat(c['å¹³å‡å¾—æ¨™']) || 0), 0) / count;
        const avgHigh = list.filter(c => c._high > 0).reduce((s, c) => s + c._high, 0) / (list.filter(c => c._high > 0).length || 1);
        const avgLow = list.filter(c => c._low > 0).reduce((s, c) => s + c._low, 0) / (list.filter(c => c._low > 0).length || 1);
        const avgRange = list.filter(c => c._high > 0 && c._low > 0).reduce((s, c) => s + ((c._high - c._low) / c._low * 100), 0) / (list.filter(c => c._high > 0 && c._low > 0).length || 1);
        const avgDropRate = showDropRate ? (list.reduce((s, c) => s + (c._dropRate || 0), 0) / count) : 0;
        
        // æ ¹æ“šæ’è¡Œæ¦œé¡å‹æ±ºå®šè¡¨é ­é †åº
        const headerHtml = isMultipleRank 
            ? `<tr>
                    <th>æ’å</th>
                    <th>CBä»£è™Ÿ</th>
                    <th>åç¨±</th>
                    <th>é–‹æ¨™æ—¥</th>
                    <th>ç«¶æ‹å¼µ</th>
                    <th>æŠ•æ¨™å¼µ</th>
                    <th>æŠ•æ¨™å€æ•¸</th>
                    <th>åº•æ¨™åƒ¹</th>
                    <th>æˆªæ¨™æ”¶ç›¤</th>
                    <th>è½‰æ›åƒ¹</th>
                    <th>æˆªæ¨™ç†è«–</th>
                    <th>æœ€ä½å¾—æ¨™</th>
                    <th>å¹³å‡å¾—æ¨™</th>
                    <th>æ›ç‰Œé«˜</th>
                    <th>æ›ç‰Œä½</th>
                    <th>æŒ¯å¹…%</th>
                </tr>`
            : `<tr>
                    <th>æ’å</th>
                    <th>CBä»£è™Ÿ</th>
                    <th>åç¨±</th>
                    <th>é–‹æ¨™æ—¥</th>
                    <th>ç«¶æ‹å¼µ</th>
                    <th>æŠ•æ¨™å¼µ</th>
                    <th>æŠ•æ¨™å€æ•¸</th>
                    <th>åº•æ¨™åƒ¹</th>
                    <th>æˆªæ¨™æ”¶ç›¤</th>
                    <th>è½‰æ›åƒ¹</th>
                    <th>æˆªæ¨™ç†è«–</th>
                    <th>æœ€ä½å¾—æ¨™</th>
                    <th>å¹³å‡å¾—æ¨™</th>
                    <th>æ›ç‰Œé«˜</th>
                    <th>æ›ç‰Œä½</th>
                    ${showDropRate ? '<th>è·Œå¹…%</th>' : '<th>æŒ¯å¹…%</th>'}
                </tr>`;
        
        // åˆè¨ˆè¡Œ
        const footerHtml = `<tr>
            <td colspan="3" style="text-align:left"><b>å¹³å‡ (${count}ç­†)</b></td>
            <td></td>
            <td><b>${fmtNum(sumBidLots, 0)}</b></td>
            <td><b>${fmtNum(sumTotalBidLots, 0)}</b></td>
            <td><b>${fmtNum(avgMultiple, 2)}x</b></td>
            <td><b>${fmtNum(avgBasePrice, 2)}</b></td>
            <td><b>${fmtNum(avgClosePrice, 2)}</b></td>
            <td><b>${fmtNum(avgConvPrice, 2)}</b></td>
            <td><b>${fmtNum(avgTheory, 2)}</b></td>
            <td><b>${fmtNum(avgLowestBid, 2)}</b></td>
            <td><b>${fmtNum(avgAvgBid, 2)}</b></td>
            <td><b>${fmtNum(avgHigh, 2)}</b></td>
            <td><b>${fmtNum(avgLow, 2)}</b></td>
            ${showDropRate 
                ? `<td><b>${fmtNum(avgDropRate, 1)}%</b></td>`
                : `<td><b>${fmtNum(avgRange, 1)}%</b></td>`
            }
        </tr>`;
        
        return `<div class="cb-ind-title" style="margin-top:15px">${title}</div>
        <div class="auction-top10-table">
            <table>
                <thead>${headerHtml}</thead>
                <tbody>
                ${list.map((c, i) => {
                    const range = (c._high > 0 && c._low > 0) ? ((c._high - c._low) / c._low * 100) : 0;
                    const dropRate = c._dropRate !== undefined ? c._dropRate : 0;
                    const isHighlightLow = highlightField === 'æœ€ä½å¾—æ¨™';
                    const isHighlightAvg = highlightField === 'å¹³å‡å¾—æ¨™';
                    const isHighlightHigh = highlightField === '_high';
                    const isHighlightMultiple = highlightField === 'æŠ•æ¨™å€æ•¸';
                    const isHighlightDrop = highlightField === '_dropRate';
                    
                    // æ ¹æ“šæ’è¡Œæ¦œé¡å‹æ±ºå®šæ¬„ä½é †åº
                    if(isMultipleRank) {
                        return `<tr>
                        <td>${i+1}</td>
                        <td class="code" onclick="openCbInfo('${c._cbCode}')">${c._cbCode}</td>
                        <td>${c._name}</td>
                        <td>${fmtDate(c['é–‹æ¨™æ—¥æœŸ'])}</td>
                        <td>${fmtNum(c['ç«¶æ‹å¼µæ•¸'], 0)}</td>
                        <td>${fmtNum(c['æŠ•æ¨™å¼µæ•¸'], 0)}</td>
                        <td class="highlight">${fmtNum(c['æŠ•æ¨™å€æ•¸'], 2)}x</td>
                        <td>${fmtNum(c['åº•æ¨™åƒ¹'], 2)}</td>
                        <td>${c['æˆªæ¨™æ”¶ç›¤'] ? fmtNum(c['æˆªæ¨™æ”¶ç›¤'], 2) : '-'}</td>
                        <td>${fmtNum(c['è½‰æ›åƒ¹'], 2)}</td>
                        <td>${fmtNum(c['æˆªæ¨™ç†è«–'], 2)}</td>
                        <td>${fmtNum(c['æœ€ä½å¾—æ¨™'], 2)}</td>
                        <td>${fmtNum(c['å¹³å‡å¾—æ¨™'], 2)}</td>
                        <td>${c._high > 0 ? fmtNum(c._high, 2) : '-'}</td>
                        <td>${c._low > 0 ? fmtNum(c._low, 2) : '-'}</td>
                        <td class="${colorClass(range)}">${fmtNum(range, 1)}%</td>
                    </tr>`;
                    }
                    
                    return `<tr>
                    <td>${i+1}</td>
                    <td class="code" onclick="openCbInfo('${c._cbCode}')">${c._cbCode}</td>
                    <td>${c._name}</td>
                    <td>${fmtDate(c['é–‹æ¨™æ—¥æœŸ'])}</td>
                    <td>${fmtNum(c['ç«¶æ‹å¼µæ•¸'], 0)}</td>
                    <td>${fmtNum(c['æŠ•æ¨™å¼µæ•¸'], 0)}</td>
                    <td>${fmtNum(c['æŠ•æ¨™å€æ•¸'], 2)}x</td>
                    <td>${fmtNum(c['åº•æ¨™åƒ¹'], 2)}</td>
                    <td>${c['æˆªæ¨™æ”¶ç›¤'] ? fmtNum(c['æˆªæ¨™æ”¶ç›¤'], 2) : '-'}</td>
                    <td>${fmtNum(c['è½‰æ›åƒ¹'], 2)}</td>
                    <td>${fmtNum(c['æˆªæ¨™ç†è«–'], 2)}</td>
                    <td class="${isHighlightLow ? 'highlight' : ''}">${fmtNum(c['æœ€ä½å¾—æ¨™'], 2)}</td>
                    <td class="${isHighlightAvg ? 'highlight' : ''}">${fmtNum(c['å¹³å‡å¾—æ¨™'], 2)}</td>
                    <td class="${isHighlightHigh ? 'highlight' : ''}">${c._high > 0 ? fmtNum(c._high, 2) : '-'}</td>
                    <td>${c._low > 0 ? fmtNum(c._low, 2) : '-'}</td>
                    ${showDropRate 
                        ? `<td class="${isHighlightDrop ? 'highlight' : ''} ${colorClass(dropRate)}">${fmtNum(dropRate, 1)}%</td>`
                        : `<td class="${colorClass(range)}">${fmtNum(range, 1)}%</td>`
                    }
                </tr>`}).join('')}
                </tbody>
                <tfoot>${footerHtml}</tfoot>
            </table>
        </div>`;
    };
    
    // æ ¹æ“šé¸æ“‡é¡¯ç¤ºå°æ‡‰çš„è¡¨æ ¼
    if(AUCTION_TOP10 === 'guar_low') return renderTable(guarLowest, 'ğŸ† æœ‰æ“”ä¿ï½œæœ€ä½å¾—æ¨™ Top 10ï¼ˆç”±é«˜åˆ°ä½ï¼‰', 'æœ€ä½å¾—æ¨™');
    if(AUCTION_TOP10 === 'no_guar_low') return renderTable(noGuarLowest, 'ğŸ† ç„¡æ“”ä¿ï½œæœ€ä½å¾—æ¨™ Top 10ï¼ˆç”±é«˜åˆ°ä½ï¼‰', 'æœ€ä½å¾—æ¨™');
    if(AUCTION_TOP10 === 'guar_avg') return renderTable(guarAvg, 'ğŸ† æœ‰æ“”ä¿ï½œå¹³å‡å¾—æ¨™ Top 10ï¼ˆç”±é«˜åˆ°ä½ï¼‰', 'å¹³å‡å¾—æ¨™');
    if(AUCTION_TOP10 === 'no_guar_avg') return renderTable(noGuarAvg, 'ğŸ† ç„¡æ“”ä¿ï½œå¹³å‡å¾—æ¨™ Top 10ï¼ˆç”±é«˜åˆ°ä½ï¼‰', 'å¹³å‡å¾—æ¨™');
    if(AUCTION_TOP10 === 'high_price') return renderTable(highPrice, 'ğŸ† æ›ç‰Œå¾Œæœ€é«˜ Top 10ï¼ˆç”±é«˜åˆ°ä½ï¼‰', '_high');
    if(AUCTION_TOP10 === 'guar_multiple') return renderTable(guarMultiple, 'ğŸ† æœ‰æ“”ä¿ï½œæŠ•æ¨™å€æ•¸ Top 10ï¼ˆç”±é«˜åˆ°ä½ï¼‰', 'æŠ•æ¨™å€æ•¸');
    if(AUCTION_TOP10 === 'no_guar_multiple') return renderTable(noGuarMultiple, 'ğŸ† ç„¡æ“”ä¿ï½œæŠ•æ¨™å€æ•¸ Top 10ï¼ˆç”±é«˜åˆ°ä½ï¼‰', 'æŠ•æ¨™å€æ•¸');
    if(AUCTION_TOP10 === 'anti_drop') return renderTable(antiDrop, 'ğŸ† å¼·å‹¢æŠ—è·Œæ¨™çš„ Top 10ï¼ˆè·Œå¹…æœ€å°ï¼‰', '_dropRate');
    
    return '';
}

// è¨­å®šç«¶æ‹TOP10é¸æ“‡
function setAuctionTop10(type) {
    AUCTION_TOP10 = AUCTION_TOP10 === type ? '' : type; // é»æ“Šç›¸åŒçš„å‰‡å–æ¶ˆ
    renderList();
}

// è¨­å®šç«¶æ‹å°ˆå€æ¨™ç±¤
function setAuctionTab(tab) {
    AUCTION_TAB = tab;
    renderList();
}

// ç«¶æ‹æ˜ç´°æ’åºå‡½æ•¸
function sortAuctionDetail(field) {
    // åˆ‡æ›æ’åºæ–¹å‘
    if(AUCTION_DETAIL_SORT.field === field) {
        AUCTION_DETAIL_SORT.dir = AUCTION_DETAIL_SORT.dir === 'asc' ? 'desc' : 'asc';
    } else {
        AUCTION_DETAIL_SORT.field = field;
        AUCTION_DETAIL_SORT.dir = field === 'seq' ? 'asc' : 'desc'; // åºè™Ÿé è¨­å‡åºï¼Œå…¶ä»–é è¨­é™åº
    }
    renderAuctionDetailTable();
}

// æ¸²æŸ“ç«¶æ‹æ˜ç´°è¡¨æ ¼
function renderAuctionDetailTable() {
    const tbody = document.getElementById('auction-detail-tbody');
    if(!tbody || !AUCTION_DETAIL_DATA.length) return;
    
    const { field, dir } = AUCTION_DETAIL_SORT;
    const sorted = [...AUCTION_DETAIL_DATA].sort((a, b) => {
        let va = a[field], vb = b[field];
        if(typeof va === 'string') va = va.toLowerCase();
        if(typeof vb === 'string') vb = vb.toLowerCase();
        if(va < vb) return dir === 'asc' ? -1 : 1;
        if(va > vb) return dir === 'asc' ? 1 : -1;
        return 0;
    });
    
    tbody.innerHTML = sorted.map((d, idx) => {
        let bgColor = idx % 2 === 0 ? '#fff' : '#fafafa';
        let fontWeight = '500';
        if(d.qty >= 100) {
            bgColor = '#ffebee';
            fontWeight = '700';
        } else if(d.qty >= 30) {
            bgColor = '#fff3e0';
            fontWeight = '600';
        }
        return `<tr style="background:${bgColor}">
            <td style="padding:6px 4px;text-align:center;font-weight:500">${d.seq}</td>
            <td style="padding:6px 4px;text-align:right;font-weight:500">${fmtNum(d.price, 2)}</td>
            <td style="padding:6px 4px;text-align:right;font-weight:${fontWeight};color:${d.qty >= 100 ? '#c62828' : (d.qty >= 30 ? '#e65100' : '#333')}">${fmtNum(d.qty, 0)}</td>
            <td style="padding:6px 4px;text-align:right;font-weight:500">${fmtNum(d.amount, 0)}</td>
            <td style="padding:6px 4px;text-align:right;font-weight:500">${fmtNum(d.cost, 2)}</td>
            <td style="padding:6px 4px;text-align:left;font-size:10px;font-weight:500">${d.intervalType}</td>
            <td style="padding:6px 4px;text-align:right;font-weight:500">${fmtNum(d.cumRatio * 100, 1)}%</td>
        </tr>`;
    }).join('');
    
    // æ›´æ–°è¡¨é ­æ’åºæŒ‡ç¤º
    document.querySelectorAll('.auction-sort-th').forEach(th => {
        const f = th.dataset.field;
        const arrow = th.querySelector('.sort-arrow');
        if(arrow) {
            if(f === field) {
                arrow.textContent = dir === 'asc' ? ' â†‘' : ' â†“';
                arrow.style.opacity = '1';
            } else {
                arrow.textContent = ' â†•';
                arrow.style.opacity = '0.4';
            }
        }
    });
}
window.sortAuctionDetail = sortAuctionDetail;

// CB çµ±è¨ˆå€å¡Š - ä¹å®®æ ¼æ–¹å¡Šç‰ˆ
function renderCBStats() {
    const stats = META.cbStats;
    const industries = Object.entries(stats.industries).sort((a,b) => b[1]-a[1]);
    
    // ç«¶æ‹æ•¸é‡å¾ cbAll ä¸­ _method === 'ç«¶æ‹' è¨ˆç®—ï¼ˆèˆ‡01å·¥ä½œè¡¨ä¸€è‡´ï¼‰
    const auctionCnt = DB.cbAll.filter(c => c._method === 'ç«¶æ‹').length;
    
    // æ¨¡å¼åˆ‡æ› - ä½¿ç”¨çŸ©å½¢æŒ‰éˆ•æ¨£å¼
    const modeTabsHtml = `
        <div class="cb-section-title">ğŸ”€ åˆ†é¡æŸ¥è©¢</div>
        <div class="cb-top10-btns">
            <div class="cb-top10-btn-line ${CB_MODE==='info'?'active':''}" onclick="setCbMode('info')"><span class="top10-icon">ğŸ“‹</span>åŸºæœ¬è³‡æ–™<span class="ind-num">${padNum(DB.cbAll.length)}</span></div>
            <div class="cb-top10-btn-line ${CB_MODE==='active'?'active':''}" onclick="setCbMode('active')"><span class="top10-icon">ğŸ«</span>æ›ç‰Œäº¤æ˜“<span class="ind-num">${padNum(DB.cb.length)}</span></div>
            <div class="cb-top10-btn-line ${CB_MODE==='history'?'active':''}" onclick="setCbMode('history')"><span class="top10-icon">ğŸ“œ</span>æ­·å²è³‡æ–™<span class="ind-num">${padNum(DB.cbHistory.length)}</span></div>
            <div class="cb-top10-btn-line ${CB_MODE==='auction'?'active':''}" onclick="setCbMode('auction')"><span class="top10-icon">ğŸ”¨</span>ç«¶æ‹è³‡æ–™<span class="ind-num">${padNum(auctionCnt)}</span></div>
            <div class="cb-top10-btn-line ${CB_MODE==='primary'?'active':''}" onclick="setCbMode('primary')"><span class="top10-icon">ğŸ“</span>åˆç´šå¸‚å ´<span class="ind-num">${padNum(DB.cbPrimary.length + DB.cbBoard.length)}</span></div>
            <div class="cb-top10-btn-line ${CB_MODE==='balance'?'active':''}" onclick="setCbMode('balance')"><span class="top10-icon">ğŸ“Š</span>æµé€šé¤˜é¡<span class="ind-num">${padNum(DB.cbBalance.length)}</span></div>
            <div class="cb-top10-btn-line ${CB_MODE==='cbas'?'active':''}" onclick="setCbMode('cbas')"><span class="top10-icon">ğŸ’¹</span>CBASå ±åƒ¹<span class="ind-num">${padNum(DB.cbCBAS.length)}</span></div>
            <div class="cb-top10-btn-line ${CB_MODE==='redeem'?'active':''}" onclick="setCbMode('redeem')"><span class="top10-icon">ğŸ””</span>å¼·åˆ¶è´–å›<span class="ind-num">${padNum(DB.cbRedeem.length)}</span></div>
            <div class="cb-top10-btn-line ${CB_MODE==='stopconv'?'active':''}" onclick="setCbMode('stopconv')"><span class="top10-icon">â¸ï¸</span>åœæ­¢è½‰æ›<span class="ind-num">${padNum(DB.cbStopConv.length)}</span></div>
            <div class="cb-top10-btn-line ${CB_MODE==='priceadj'?'active':''}" onclick="setCbMode('priceadj')"><span class="top10-icon">ğŸ’°</span>åƒ¹æ ¼èª¿æ•´<span class="ind-num">${padNum(DB.cbPriceAdj.length)}</span></div>
            <div class="cb-top10-btn-line ${CB_MODE==='concept'?'active':''}" onclick="setCbMode('concept')"><span class="top10-icon">ğŸ’¡</span>é¡Œææ¦‚å¿µ<span class="ind-num">${padNum(DB.cb.length)}</span></div>
        </div>
    `;
    
    // è¨ˆç®—ç¯©é¸æ¨™ç±¤æ•¸é‡ï¼ˆæ ¹æ“šç•¶å‰æ¨¡å¼ï¼‰
    let cbList = [];
    if(CB_MODE === 'active') cbList = DB.cb;
    else if(CB_MODE === 'history') cbList = DB.cbHistory;
    else if(CB_MODE === 'auction') cbList = DB.cbAuction;
    else if(CB_MODE === 'primary') cbList = PRIMARY_MODE === 'underwriting' ? DB.cbPrimary : DB.cbBoard;
    else if(CB_MODE === 'balance') cbList = DB.cbBalance;
    else if(CB_MODE === 'cbas') cbList = DB.cbCBAS;
    
    const methodCnt = { 'è©¢åœˆ': 0, 'ç«¶æ‹': 0 };
    const guarCnt = { 'æœ‰æ“”ä¿': 0, 'ç„¡æ“”ä¿': 0 };
    cbList.forEach(c => {
        if(c._method === 'è©¢åœˆ') methodCnt['è©¢åœˆ']++;
        else if(c._method === 'ç«¶æ‹') methodCnt['ç«¶æ‹']++;
        if(c._guarantee === 'æœ‰æ“”ä¿') guarCnt['æœ‰æ“”ä¿']++;
        else if(c._guarantee === 'ç„¡æ“”ä¿' || c._guarantee === '0') guarCnt['ç„¡æ“”ä¿']++;
    });
    
    // ç”¢æ¥­æ¨™ç±¤æ¸²æŸ“å‡½æ•¸
    const renderIndustryTags = (indList, title) => {
        if(!indList || indList.length === 0) return '';
        return `
            <div class="cb-section-title">${title}</div>
            <div class="cb-top10-btns">
                ${indList.map(([ind, cnt]) => `
                    <div class="cb-top10-btn-line ${CB_FILTER.industry === ind ? 'active' : ''}" onclick="setCbFilter('industry', '${ind}')"><span class="top10-icon">${industryEmoji(ind)}</span>${ind}<span class="ind-num">${padNum(cnt)}</span></div>
                `).join('')}
            </div>
        `;
    };
    
    // å–å¾—ä¸»æœå°‹æ¬„çš„å€¼
    const searchVal = $('search')?.value || '';
    
    // åˆ¤æ–·æ˜¯å¦æœ‰ç¯©é¸æ¢ä»¶
    const hasFilter = CB_FILTER.industry || CB_FILTER.guarantee;
    
    if(CB_MODE === 'info') {
        // åŸºæœ¬è³‡æ–™æ¨¡å¼
        const allInd = {};
        const allMethod = { 'è©¢åœˆ': 0, 'ç«¶æ‹': 0 };
        const allGuar = { 'æœ‰æ“”ä¿': 0, 'ç„¡æ“”ä¿': 0 };
        DB.cbAll.forEach(c => {
            const ind = c._industry || 'å…¶ä»–';
            allInd[ind] = (allInd[ind] || 0) + 1;
            if(c._method === 'è©¢åœˆ') allMethod['è©¢åœˆ']++;
            else if(c._method === 'ç«¶æ‹') allMethod['ç«¶æ‹']++;
            if(c._guarantee === 'æœ‰æ“”ä¿') allGuar['æœ‰æ“”ä¿']++;
            else if(c._guarantee === 'ç„¡æ“”ä¿' || c._guarantee === '0') allGuar['ç„¡æ“”ä¿']++;
        });
        const sortedAllInd = Object.entries(allInd).sort((a,b) => b[1]-a[1]);
        const activeCnt = DB.cb.length;
        const historyCnt = DB.cbAll.length - activeCnt;
        
        return `
            <div class="cb-stats">
                ${modeTabsHtml}
                <div class="cb-section-title">ğŸ“ˆ çµ±è¨ˆæ•¸æ“š</div>
                <div class="cb-stats-grid">
                    <div class="cb-stat-item"><div class="cb-stat-num">${padNum(DB.cbAll.length)}</div><div class="cb-stat-label">å…¨éƒ¨CB</div></div>
                    <div class="cb-stat-item clickable ${CB_FILTER.status === 'active' ? 'active' : ''}" onclick="setCbFilter('status', 'active')"><div class="cb-stat-num">${padNum(activeCnt)}</div><div class="cb-stat-label">æ›ç‰Œä¸­</div></div>
                    <div class="cb-stat-item clickable ${CB_FILTER.status === 'delisted' ? 'active' : ''}" onclick="setCbFilter('status', 'delisted')"><div class="cb-stat-num">${padNum(historyCnt)}</div><div class="cb-stat-label">å·²ä¸‹å¸‚</div></div>
                    <div class="cb-stat-item clickable" onclick="setCbFilter('guarantee', 'è©¢åœˆ')"><div class="cb-stat-num">${padNum(allMethod['è©¢åœˆ'])}</div><div class="cb-stat-label">è©¢åœˆ</div></div>
                    <div class="cb-stat-item clickable" onclick="setCbFilter('guarantee', 'ç«¶æ‹')"><div class="cb-stat-num">${padNum(allMethod['ç«¶æ‹'])}</div><div class="cb-stat-label">ç«¶æ‹</div></div>
                    <div class="cb-stat-item clickable ${CB_FILTER.guarantee === 'æœ‰æ“”ä¿' ? 'active' : ''}" onclick="setCbFilter('guarantee', 'æœ‰æ“”ä¿')"><div class="cb-stat-num">${padNum(allGuar['æœ‰æ“”ä¿'])}</div><div class="cb-stat-label">æœ‰æ“”ä¿</div></div>
                    <div class="cb-stat-item clickable ${CB_FILTER.guarantee === 'ç„¡æ“”ä¿' ? 'active' : ''}" onclick="setCbFilter('guarantee', 'ç„¡æ“”ä¿')"><div class="cb-stat-num">${padNum(allGuar['ç„¡æ“”ä¿'])}</div><div class="cb-stat-label">ç„¡æ“”ä¿</div></div>
                </div>
                ${renderIndustryTags(sortedAllInd, 'ğŸ“Š å„ç”¢æ¥­CBåˆ†ä½ˆ')}
                <div class="cb-section-title">ğŸ“‹ è³‡æ–™åˆ†é¡</div>
                <div class="cb-top10-btns">
                    <div class="cb-top10-btn-line ${CB_INFO_TAB==='issue'?'active':''}" onclick="setCbInfoTab('issue')"><span class="top10-icon">ğŸ“</span>ç™¼è¡Œæ¢ä»¶</div>
                    <div class="cb-top10-btn-line ${CB_INFO_TAB==='timeline'?'active':''}" onclick="setCbInfoTab('timeline')"><span class="top10-icon">ğŸ“…</span>æ™‚ç¨‹è³‡è¨Š</div>
                    <div class="cb-top10-btn-line ${CB_INFO_TAB==='putback'?'active':''}" onclick="setCbInfoTab('putback')"><span class="top10-icon">ğŸ’°</span>è³£å›æ¢ä»¶</div>
                    <div class="cb-top10-btn-line ${CB_INFO_TAB==='convert'?'active':''}" onclick="setCbInfoTab('convert')"><span class="top10-icon">ğŸ”„</span>è½‰æ›åˆ†æ</div>
                </div>
            </div>
        `;
    } else if(CB_MODE === 'active') {
        // æ›ç‰Œäº¤æ˜“
        return `
            <div class="cb-stats">
                ${modeTabsHtml}
                <div class="cb-section-title">ğŸ“ˆ çµ±è¨ˆæ•¸æ“š</div>
                <div class="cb-stats-grid">
                    <div class="cb-stat-item"><div class="cb-stat-num">${padNum(stats.total)}</div><div class="cb-stat-label">æ›ç‰Œä¸­</div></div>
                    <div class="cb-stat-item"><div class="cb-stat-num">${padNum(stats.companies)}</div><div class="cb-stat-label">å…¬å¸æ•¸</div></div>
                    <div class="cb-stat-item"><div class="cb-stat-num">${padNum(Math.round(stats.totalBalance/100))}</div><div class="cb-stat-label">é¤˜é¡å„„</div></div>
                    <div class="cb-stat-item clickable ${CB_FILTER.guarantee === 'æœ‰æ“”ä¿' ? 'active' : ''}" onclick="setCbFilter('guarantee', 'æœ‰æ“”ä¿')"><div class="cb-stat-num">${padNum(guarCnt['æœ‰æ“”ä¿'])}</div><div class="cb-stat-label">æœ‰æ“”ä¿</div></div>
                    <div class="cb-stat-item clickable ${CB_FILTER.guarantee === 'ç„¡æ“”ä¿' ? 'active' : ''}" onclick="setCbFilter('guarantee', 'ç„¡æ“”ä¿')"><div class="cb-stat-num">${padNum(guarCnt['ç„¡æ“”ä¿'])}</div><div class="cb-stat-label">ç„¡æ“”ä¿</div></div>
                </div>
                ${renderIndustryTags(industries, 'ğŸ“Š å„ç”¢æ¥­CBåˆ†ä½ˆ')}
            </div>
        `;
    } else if(CB_MODE === 'history') {
        // æ­·å²é«˜ä½
        const historyInd = {};
        DB.cbHistory.forEach(c => {
            const ind = c._industry || 'å…¶ä»–';
            historyInd[ind] = (historyInd[ind] || 0) + 1;
        });
        const sortedHistInd = Object.entries(historyInd).sort((a,b) => b[1]-a[1]);
        
        return `
            <div class="cb-stats">
                ${modeTabsHtml}
                <div class="cb-section-title">ğŸ“ˆ çµ±è¨ˆæ•¸æ“š</div>
                <div class="cb-stats-grid">
                    <div class="cb-stat-item"><div class="cb-stat-num">${padNum(DB.cbHistory.length)}</div><div class="cb-stat-label">æ­·å²CB</div></div>
                    <div class="cb-stat-item clickable ${CB_FILTER.guarantee === 'æœ‰æ“”ä¿' ? 'active' : ''}" onclick="setCbFilter('guarantee', 'æœ‰æ“”ä¿')"><div class="cb-stat-num">${padNum(guarCnt['æœ‰æ“”ä¿'])}</div><div class="cb-stat-label">æœ‰æ“”ä¿</div></div>
                    <div class="cb-stat-item clickable ${CB_FILTER.guarantee === 'ç„¡æ“”ä¿' ? 'active' : ''}" onclick="setCbFilter('guarantee', 'ç„¡æ“”ä¿')"><div class="cb-stat-num">${padNum(guarCnt['ç„¡æ“”ä¿'])}</div><div class="cb-stat-label">ç„¡æ“”ä¿</div></div>
                </div>
                ${renderIndustryTags(sortedHistInd, 'ğŸ“Š å„ç”¢æ¥­æ­·å²CBåˆ†ä½ˆ')}
            </div>
        `;
    } else if(CB_MODE === 'auction') {
        // ç«¶æ‹å°ˆå€ - çµ±è¨ˆæ•¸æ“šå¾ cbAll ä¸­ _method === 'ç«¶æ‹' è¨ˆç®—
        const cbAllAuction = DB.cbAll.filter(c => c._method === 'ç«¶æ‹');
        const auctionInd = {};
        const auctionGuar = { 'æœ‰æ“”ä¿': 0, 'ç„¡æ“”ä¿': 0 };
        
        cbAllAuction.forEach(c => {
            const ind = c._industry || 'å…¶ä»–';
            auctionInd[ind] = (auctionInd[ind] || 0) + 1;
            if(c._guarantee === 'æœ‰æ“”ä¿') auctionGuar['æœ‰æ“”ä¿']++;
            else if(c._guarantee === 'ç„¡æ“”ä¿' || c._guarantee === '0') auctionGuar['ç„¡æ“”ä¿']++;
        });
        
        // å¾ cbAuction è¨ˆç®—ç«¶æ‹è©³ç´°çµ±è¨ˆï¼ˆæ›ç‰Œé«˜ä½ã€å¾—æ¨™åƒ¹ç­‰ï¼‰
        let guarHighSum = 0, guarHighCnt = 0, noGuarHighSum = 0, noGuarHighCnt = 0;
        
        DB.cbAuction.forEach(c => {
            if(c._guarantee === 'æœ‰æ“”ä¿') {
                if(c._high > 0) { guarHighSum += c._high; guarHighCnt++; }
            } else if(c._guarantee === 'ç„¡æ“”ä¿') {
                if(c._high > 0) { noGuarHighSum += c._high; noGuarHighCnt++; }
            }
        });
        
        // ç¯©é¸å¾Œçš„è³‡æ–™çµ±è¨ˆï¼ˆåŒ…å«æœå°‹é—œéµå­—ï¼‰
        const filteredAuction = DB.cbAuction.filter(c => {
            let matchIndustry = true;
            let matchGuarantee = true;
            let matchSearch = true;
            
            if(CB_FILTER.industry) matchIndustry = (c._industry || '') === CB_FILTER.industry;
            if(CB_FILTER.guarantee) {
                const guar = c._guarantee || '';
                if(CB_FILTER.guarantee === 'æœ‰æ“”ä¿') matchGuarantee = guar === 'æœ‰æ“”ä¿';
                else if(CB_FILTER.guarantee === 'ç„¡æ“”ä¿') matchGuarantee = guar === 'ç„¡æ“”ä¿' || guar === '0';
            }
            
            // æœå°‹é—œéµå­—ç¯©é¸
            if(searchVal) {
                const searchLower = searchVal.toLowerCase();
                const str = JSON.stringify(c).toLowerCase();
                matchSearch = str.includes(searchLower);
            }
            
            return matchIndustry && matchGuarantee && matchSearch;
        });
        
        let fHigh = 0, fLow = 0, fValidCnt = 0;
        let fLowestBid = 0, fLowestPrem = 0, fAvgBid = 0, fAvgPrem = 0;
        let fLowestBidCnt = 0, fLowestPremCnt = 0, fAvgBidCnt = 0, fAvgPremCnt = 0;
        let fMultiple = 0, fMultipleCnt = 0;
        let fGuarHighSum = 0, fGuarHighCnt = 0, fNoGuarHighSum = 0, fNoGuarHighCnt = 0;
        const fGuar = { 'æœ‰æ“”ä¿': 0, 'ç„¡æ“”ä¿': 0 };
        
        filteredAuction.forEach(c => {
            if(c._high > 0 && c._low > 0) { fHigh += c._high; fLow += c._low; fValidCnt++; }
            
            const lowestBid = parseFloat(c['æœ€ä½å¾—æ¨™']) || 0;
            if(lowestBid > 0) { fLowestBid += lowestBid; fLowestBidCnt++; }
            
            const lowestPrem = parseFloat(c['æœ€ä½æº¢åƒ¹']) || 0;
            if(lowestPrem !== 0 || c['æœ€ä½æº¢åƒ¹'] !== undefined) { fLowestPrem += lowestPrem; fLowestPremCnt++; }
            
            const avgBid = parseFloat(c['å¹³å‡å¾—æ¨™']) || 0;
            if(avgBid > 0) { fAvgBid += avgBid; fAvgBidCnt++; }
            
            const avgPrem = parseFloat(c['å¹³å‡æº¢åƒ¹']) || 0;
            if(avgPrem !== 0 || c['å¹³å‡æº¢åƒ¹'] !== undefined) { fAvgPrem += avgPrem; fAvgPremCnt++; }
            
            const multiple = parseFloat(c['æŠ•æ¨™å€æ•¸']) || 0;
            if(multiple > 0) { fMultiple += multiple; fMultipleCnt++; }
            
            if(c._guarantee === 'æœ‰æ“”ä¿') {
                fGuar['æœ‰æ“”ä¿']++;
                if(c._high > 0) { fGuarHighSum += c._high; fGuarHighCnt++; }
            } else if(c._guarantee === 'ç„¡æ“”ä¿') {
                fGuar['ç„¡æ“”ä¿']++;
                if(c._high > 0) { fNoGuarHighSum += c._high; fNoGuarHighCnt++; }
            }
        });
        
        const displayCnt = hasFilter ? filteredAuction.length : cbAllAuction.length;
        const avgHigh = fValidCnt > 0 ? fHigh / fValidCnt : 0;
        const avgLow = fValidCnt > 0 ? fLow / fValidCnt : 0;
        const avgLowestBid = fLowestBidCnt > 0 ? fLowestBid / fLowestBidCnt : 0;
        const avgLowestPrem = fLowestPremCnt > 0 ? fLowestPrem / fLowestPremCnt : 0;
        const avgAvgBid = fAvgBidCnt > 0 ? fAvgBid / fAvgBidCnt : 0;
        const avgAvgPrem = fAvgPremCnt > 0 ? fAvgPrem / fAvgPremCnt : 0;
        const avgMultiple = fMultipleCnt > 0 ? fMultiple / fMultipleCnt : 0;
        const guarAvgHigh = hasFilter ? (fGuarHighCnt > 0 ? fGuarHighSum / fGuarHighCnt : 0) : (guarHighCnt > 0 ? guarHighSum / guarHighCnt : 0);
        const noGuarAvgHigh = hasFilter ? (fNoGuarHighCnt > 0 ? fNoGuarHighSum / fNoGuarHighCnt : 0) : (noGuarHighCnt > 0 ? noGuarHighSum / noGuarHighCnt : 0);
        const sortedAuctionInd = Object.entries(auctionInd).sort((a,b) => b[1]-a[1]);
        
        return `
            <div class="cb-stats">
                ${modeTabsHtml}
                <div class="cb-section-title">ğŸ“ˆ çµ±è¨ˆæ•¸æ“š</div>
                <div class="cb-stats-grid">
                    <div class="cb-stat-item"><div class="cb-stat-num">${padNum(displayCnt)}</div><div class="cb-stat-label">${hasFilter ? 'ç¬¦åˆæ¢ä»¶' : 'ç«¶æ‹ç¸½æª”æ•¸'}</div></div>
                    <div class="cb-stat-item clickable ${CB_FILTER.guarantee === 'æœ‰æ“”ä¿' ? 'active' : ''}" onclick="setCbFilter('guarantee', 'æœ‰æ“”ä¿')"><div class="cb-stat-num">${padNum(hasFilter ? fGuar['æœ‰æ“”ä¿'] : auctionGuar['æœ‰æ“”ä¿'])}</div><div class="cb-stat-label">æœ‰æ“”ä¿æª”æ•¸</div></div>
                    <div class="cb-stat-item clickable ${CB_FILTER.guarantee === 'ç„¡æ“”ä¿' ? 'active' : ''}" onclick="setCbFilter('guarantee', 'ç„¡æ“”ä¿')"><div class="cb-stat-num">${padNum(hasFilter ? fGuar['ç„¡æ“”ä¿'] : auctionGuar['ç„¡æ“”ä¿'])}</div><div class="cb-stat-label">ç„¡æ“”ä¿æª”æ•¸</div></div>
                    <div class="cb-stat-item"><div class="cb-stat-num">${fmtNum(avgHigh, 1)}</div><div class="cb-stat-label">æ›ç‰Œå‡é«˜åƒ¹</div></div>
                    <div class="cb-stat-item"><div class="cb-stat-num">${fmtNum(avgLow, 1)}</div><div class="cb-stat-label">æ›ç‰Œå‡ä½åƒ¹</div></div>
                    <div class="cb-stat-item"><div class="cb-stat-num">${fmtNum(avgLowestBid, 1)}</div><div class="cb-stat-label">æœ€ä½å¾—æ¨™åƒ¹</div></div>
                    <div class="cb-stat-item"><div class="cb-stat-num">${fmtNum(avgLowestPrem * 100, 1)}%</div><div class="cb-stat-label">æœ€ä½æº¢åƒ¹ç‡</div></div>
                    <div class="cb-stat-item"><div class="cb-stat-num">${fmtNum(avgAvgBid, 1)}</div><div class="cb-stat-label">å¹³å‡å¾—æ¨™åƒ¹</div></div>
                    <div class="cb-stat-item"><div class="cb-stat-num">${fmtNum(avgAvgPrem * 100, 1)}%</div><div class="cb-stat-label">å¹³å‡æº¢åƒ¹ç‡</div></div>
                    <div class="cb-stat-item"><div class="cb-stat-num">${fmtNum(avgMultiple, 1)}x</div><div class="cb-stat-label">å‡æŠ•æ¨™å€æ•¸</div></div>
                </div>
                <div class="cb-section-title">ğŸ“‹ è³‡æ–™åˆ†é¡</div>
                <div class="cb-top10-btns">
                    <div class="cb-top10-btn-line ${AUCTION_TAB==='basic'?'active':''}" onclick="setAuctionTab('basic')"><span class="top10-icon">ğŸ“</span>åŸºæœ¬è³‡æ–™</div>
                    <div class="cb-top10-btn-line ${AUCTION_TAB==='bid'?'active':''}" onclick="setAuctionTab('bid')"><span class="top10-icon">ğŸ“Š</span>æŠ•æ¨™çµ±è¨ˆ</div>
                    <div class="cb-top10-btn-line ${AUCTION_TAB==='result'?'active':''}" onclick="setAuctionTab('result')"><span class="top10-icon">ğŸ¯</span>å¾—æ¨™çµæœ</div>
                    <div class="cb-top10-btn-line ${AUCTION_TAB==='list'?'active':''}" onclick="setAuctionTab('list')"><span class="top10-icon">ğŸ“ˆ</span>æ›ç‰Œè¡Œæƒ…</div>
                    <div class="cb-top10-btn-line ${AUCTION_TAB==='detail'?'active':''}" onclick="setAuctionTab('detail')"><span class="top10-icon">ğŸ”</span>å¾—æ¨™æ˜ç´°</div>
                </div>
                <div class="cb-section-title">ğŸ† æ’è¡Œæ¦œ TOP10</div>
                <div class="cb-top10-btns">
                    <div class="cb-top10-btn-line ${AUCTION_TOP10==='guar_low'?'active':''}" onclick="setAuctionTop10('guar_low')"><span class="top10-icon">ğŸ¥‡</span>æœ‰æ“”æœ€ä½å¾—æ¨™</div>
                    <div class="cb-top10-btn-line ${AUCTION_TOP10==='no_guar_low'?'active':''}" onclick="setAuctionTop10('no_guar_low')"><span class="top10-icon">ğŸ¥ˆ</span>ç„¡æ“”æœ€ä½å¾—æ¨™</div>
                    <div class="cb-top10-btn-line ${AUCTION_TOP10==='guar_avg'?'active':''}" onclick="setAuctionTop10('guar_avg')"><span class="top10-icon">ğŸ…</span>æœ‰æ“”å¹³å‡å¾—æ¨™</div>
                    <div class="cb-top10-btn-line ${AUCTION_TOP10==='no_guar_avg'?'active':''}" onclick="setAuctionTop10('no_guar_avg')"><span class="top10-icon">ğŸ–ï¸</span>ç„¡æ“”å¹³å‡å¾—æ¨™</div>
                    <div class="cb-top10-btn-line ${AUCTION_TOP10==='high_price'?'active':''}" onclick="setAuctionTop10('high_price')"><span class="top10-icon">ğŸ“ˆ</span>æ›ç‰Œå¾Œæœ€é«˜</div>
                    <div class="cb-top10-btn-line ${AUCTION_TOP10==='guar_multiple'?'active':''}" onclick="setAuctionTop10('guar_multiple')"><span class="top10-icon">ğŸ”¥</span>æœ‰æ“”æŠ•æ¨™å€æ•¸</div>
                    <div class="cb-top10-btn-line ${AUCTION_TOP10==='no_guar_multiple'?'active':''}" onclick="setAuctionTop10('no_guar_multiple')"><span class="top10-icon">ğŸ’¥</span>ç„¡æ“”æŠ•æ¨™å€æ•¸</div>
                    <div class="cb-top10-btn-line ${AUCTION_TOP10==='anti_drop'?'active':''}" onclick="setAuctionTop10('anti_drop')"><span class="top10-icon">ğŸ›¡ï¸</span>å¼·å‹¢æŠ—è·Œæ¨™çš„</div>
                </div>
                ${renderAuctionTop10()}
                ${renderIndustryTags(sortedAuctionInd, 'ğŸ“Š å„ç”¢æ¥­ç«¶æ‹CBåˆ†ä½ˆ')}
            </div>
        `;
    } else if(CB_MODE === 'primary') {
        // åˆç´šå¸‚å ´
        const brokerCnt = {};
        const dataList = PRIMARY_MODE === 'underwriting' ? DB.cbPrimary : (PRIMARY_MODE === 'auction' ? DB.cbPrimary : DB.cbBoard);
        dataList.forEach(c => {
            const broker = c._broker || 'å…¶ä»–';
            brokerCnt[broker] = (brokerCnt[broker] || 0) + 1;
        });
        const sortedBrokers = Object.entries(brokerCnt).sort((a,b) => b[1]-a[1]);
        
        // è¨ˆç®—è¿‘æœŸç«¶æ‹æ¡ˆä»¶æ•¸
        const upcomingAuctions = getUpcomingAuctions();
        
        // è¿‘æœŸç«¶æ‹æ¨¡å¼æ™‚é¡¯ç¤ºåˆ†æå…§å®¹
        if(PRIMARY_MODE === 'auction') {
            return `
                <div class="cb-stats">
                    ${modeTabsHtml}
                    <div class="cb-sub-switcher">
                        <span class="cb-sub-tab ${PRIMARY_MODE==='underwriting'?'active':''}" onclick="setPrimaryMode('underwriting')">ğŸ“‹ æ‰¿éŠ·ä¸­æ¡ˆä»¶</span>
                        <span class="cb-sub-tab ${PRIMARY_MODE==='auction'?'active':''}" onclick="setPrimaryMode('auction')">ğŸ¯ è¿‘æœŸç«¶æ‹ <span style="background:#e74c3c;color:#fff;padding:1px 6px;border-radius:10px;font-size:10px;margin-left:3px">${upcomingAuctions.length}</span></span>
                        <span class="cb-sub-tab ${PRIMARY_MODE==='board'?'active':''}" onclick="setPrimaryMode('board')">ğŸ“ è‘£äº‹æœƒå…¬å‘Š</span>
                    </div>
                    <div class="cb-section-title">ğŸ¯ è¿‘æœŸç«¶æ‹æŠ•æ¨™æ¨¡æ“¬åˆ†æ</div>
                    <div style="background:#fff3e0;padding:12px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ff9800">
                        <div style="font-size:13px;color:#e65100;font-weight:600;margin-bottom:6px">ğŸ’¡ åˆ†æèªªæ˜</div>
                        <div style="font-size:12px;color:#666;line-height:1.6">
                            ç³»çµ±æ ¹æ“šå„æ¡ˆä»¶çš„æ“”ä¿ã€ç”¢æ¥­ã€ç™¼è¡Œè¦æ¨¡ç­‰æ¢ä»¶ï¼Œè‡ªå‹•æ¯”å°æ­·å²ç«¶æ‹è³‡æ–™ï¼Œè¨ˆç®—æŠ•æ¨™å»ºè­°åƒ¹æ ¼ã€‚<br>
                            <b>ç†è«–åƒ¹ â‰¥ 100</b>ï¼šæ¡ç”¨ç†è«–åƒ¹ Ã— æº¢åƒ¹ç‡è¨ˆç®—ï½œ<b>ç†è«–åƒ¹ < 100</b>ï¼šå› åº•æ¨™é™åˆ¶ï¼Œåƒè€ƒæ­·å²å¹³å‡åƒ¹æ ¼
                        </div>
                    </div>
                    ${renderUpcomingAuctions()}
                </div>
            `;
        }
        
        return `
            <div class="cb-stats">
                ${modeTabsHtml}
                <div class="cb-sub-switcher">
                    <span class="cb-sub-tab ${PRIMARY_MODE==='underwriting'?'active':''}" onclick="setPrimaryMode('underwriting')">ğŸ“‹ æ‰¿éŠ·ä¸­æ¡ˆä»¶</span>
                    <span class="cb-sub-tab ${PRIMARY_MODE==='auction'?'active':''}" onclick="setPrimaryMode('auction')">ğŸ¯ è¿‘æœŸç«¶æ‹ <span style="background:#e74c3c;color:#fff;padding:1px 6px;border-radius:10px;font-size:10px;margin-left:3px">${upcomingAuctions.length}</span></span>
                    <span class="cb-sub-tab ${PRIMARY_MODE==='board'?'active':''}" onclick="setPrimaryMode('board')">ğŸ“ è‘£äº‹æœƒå…¬å‘Š</span>
                </div>
                <div class="cb-section-title">ğŸ“ˆ çµ±è¨ˆæ•¸æ“š</div>
                <div class="cb-stats-grid">
                    <div class="cb-stat-item"><div class="cb-stat-num">${padNum(dataList.length)}</div><div class="cb-stat-label">${PRIMARY_MODE === 'underwriting' ? 'æ‰¿éŠ·ä¸­' : 'è‘£äº‹æœƒ'}</div></div>
                    <div class="cb-stat-item clickable" onclick="setSearch('ç«¶æ‹')"><div class="cb-stat-num">${padNum(dataList.filter(c => c._method === 'ç«¶æ‹' || c._method === 'ç«¶åƒ¹').length)}</div><div class="cb-stat-label">ç«¶æ‹</div></div>
                    <div class="cb-stat-item clickable" onclick="setSearch('è©¢åœˆ')"><div class="cb-stat-num">${padNum(dataList.filter(c => c._method === 'è©¢åœˆ').length)}</div><div class="cb-stat-label">è©¢åœˆ</div></div>
                </div>
                <div class="cb-ind-title">ğŸ¦ ${PRIMARY_MODE === 'underwriting' ? 'ç™¼è¡Œ' : 'ä¸»è¾¦'}åˆ¸å•†åˆ†ä½ˆ</div>
                <div class="cb-ind-grid">
                    ${sortedBrokers.slice(0, 15).map(([b, cnt]) => `
                        <span class="cb-ind-tag" onclick="setSearch('${b}')">${b}<span class="num">${padNum(cnt)}</span></span>
                    `).join('')}
                </div>
            </div>
        `;
    } else if(CB_MODE === 'balance') {
        // æµé€šé¤˜é¡
        const topDecreaseRate = [...DB.cbBalance].filter(c => parseFloat(c._changeRate) < 0).sort((a, b) => parseFloat(a._changeRate) - parseFloat(b._changeRate)).slice(0, 10);
        const topDecreaseAmount = [...DB.cbBalance].filter(c => parseFloat(c._change) < 0).sort((a, b) => parseFloat(a._change) - parseFloat(b._change)).slice(0, 10);
        
        const renderBalanceTop10 = (list, title, highlightField) => {
            if(list.length === 0) return '';
            return `<div class="cb-ind-title" style="margin-top:12px">${title}</div>
            <div class="balance-top10-table"><table>
                <thead><tr><th>åæ¬¡</th><th>ä»£è™Ÿ</th><th>åç¨±</th><th>æœ¬é€±</th><th>ä¸Šé€±</th><th>å¢æ¸›</th><th>æ¯”ç‡</th><th>å‰©é¤˜%</th></tr></thead>
                <tbody>${list.map((c, i) => `<tr>
                    <td>${i+1}</td><td class="code" onclick="openCbInfo('${c._cbCode}')">${c._cbCode}</td><td class="name-cell">${c._name}</td>
                    <td>${fmtNum(c._thisWeek, 0)}</td><td>${fmtNum(c._lastWeek, 0)}</td>
                    <td class="${highlightField === '_change' ? 'highlight-red' : ''}">${fmtNum(c._change, 0)}</td>
                    <td class="${highlightField === '_changeRate' ? 'highlight-red' : ''}">${fmtNum(c._changeRate, 2)}%</td>
                    <td>${fmtNum(c._remainRate, 1)}%</td>
                </tr>`).join('')}</tbody>
            </table></div>`;
        };
        
        return `
            <div class="cb-stats">
                ${modeTabsHtml}
                <div class="cb-section-title">ğŸ“ˆ çµ±è¨ˆæ•¸æ“š</div>
                <div class="cb-stats-grid">
                    <div class="cb-stat-item"><div class="cb-stat-num">${padNum(META.cbBalanceStats.total)}</div><div class="cb-stat-label">CBæª”æ•¸</div></div>
                </div>
                ${renderBalanceTop10(topDecreaseRate, 'ğŸ“‰ æœ¬é€±æ¸›å¹…å‰10å', '_changeRate')}
                ${renderBalanceTop10(topDecreaseAmount, 'ğŸ“‰ æ¸›å°‘æ•¸é¡å‰10å', '_change')}
            </div>
        `;
    } else if(CB_MODE === 'cbas') {
        // CBASå ±åƒ¹
        const industryCnt = {};
        DB.cbCBAS.forEach(c => { const ind = c._industry || 'å…¶ä»–'; industryCnt[ind] = (industryCnt[ind] || 0) + 1; });
        const sortedInd = Object.entries(industryCnt).sort((a,b) => b[1]-a[1]);
        
        // å„æ¢ä»¶ç¯©é¸æ•¸é‡
        const cnt_y2_p5 = DB.cbCBAS.filter(c => (parseFloat(c._remainYears) || 0) > 2 && (parseFloat(c._premium) || 0) < 5).length;
        const cnt_y12_p5 = DB.cbCBAS.filter(c => { const y = parseFloat(c._remainYears) || 0; const p = parseFloat(c._premium) || 0; return y >= 1 && y <= 2 && p < 5; }).length;
        const cnt_y2_p510 = DB.cbCBAS.filter(c => { const y = parseFloat(c._remainYears) || 0; const p = parseFloat(c._premium) || 0; return y > 2 && p >= 5 && p <= 10; }).length;
        const cnt_y12_p510 = DB.cbCBAS.filter(c => { const y = parseFloat(c._remainYears) || 0; const p = parseFloat(c._premium) || 0; return y >= 1 && y <= 2 && p >= 5 && p <= 10; }).length;
        
        const q = $('search').value.trim();
        
        return `
            <div class="cb-stats">
                ${modeTabsHtml}
                <div class="cb-section-title">ğŸ“ˆ çµ±è¨ˆæ•¸æ“š</div>
                <div class="cb-stats-grid">
                    <div class="cb-stat-item"><div class="cb-stat-num">${padNum(META.cbCBASStats.total)}</div><div class="cb-stat-label">CBASæª”æ•¸</div></div>
                </div>
                <div class="cb-ind-title">ğŸ” æ¢ä»¶ç¯©é¸</div>
                <div class="cb-ind-grid">
                    <span class="cb-ind-tag ${q === 'å¹´æœŸ>2 æ¬Šåˆ©é‡‘<5' ? 'active' : ''}" onclick="setSearch('å¹´æœŸ>2 æ¬Šåˆ©é‡‘<5')">å¹´æœŸ>2å¹´ æ¬Šåˆ©é‡‘<5<span class="num">${padNum(cnt_y2_p5)}</span></span>
                    <span class="cb-ind-tag ${q === 'å¹´æœŸ1-2 æ¬Šåˆ©é‡‘<5' ? 'active' : ''}" onclick="setSearch('å¹´æœŸ1-2 æ¬Šåˆ©é‡‘<5')">å¹´æœŸ1-2å¹´ æ¬Šåˆ©é‡‘<5<span class="num">${padNum(cnt_y12_p5)}</span></span>
                    <span class="cb-ind-tag ${q === 'å¹´æœŸ>2 æ¬Šåˆ©é‡‘5-10' ? 'active' : ''}" onclick="setSearch('å¹´æœŸ>2 æ¬Šåˆ©é‡‘5-10')">å¹´æœŸ>2å¹´ æ¬Šåˆ©é‡‘5-10<span class="num">${padNum(cnt_y2_p510)}</span></span>
                    <span class="cb-ind-tag ${q === 'å¹´æœŸ1-2 æ¬Šåˆ©é‡‘5-10' ? 'active' : ''}" onclick="setSearch('å¹´æœŸ1-2 æ¬Šåˆ©é‡‘5-10')">å¹´æœŸ1-2å¹´ æ¬Šåˆ©é‡‘5-10<span class="num">${padNum(cnt_y12_p510)}</span></span>
                </div>
                ${renderIndustryTags(sortedInd, 'ğŸ“Š å„ç”¢æ¥­åˆ†ä½ˆ')}
            </div>
        `;
    } else if(CB_MODE === 'redeem') {
        return `<div class="cb-stats">${modeTabsHtml}
            <div class="cb-section-title">ğŸ“ˆ çµ±è¨ˆæ•¸æ“š</div>
            <div class="cb-stats-grid"><div class="cb-stat-item"><div class="cb-stat-num">${padNum(DB.cbRedeem.length)}</div><div class="cb-stat-label">å¼·åˆ¶è´–å›</div></div></div>
        </div>`;
    } else if(CB_MODE === 'stopconv') {
        return `<div class="cb-stats">${modeTabsHtml}
            <div class="cb-section-title">ğŸ“ˆ çµ±è¨ˆæ•¸æ“š</div>
            <div class="cb-stats-grid"><div class="cb-stat-item"><div class="cb-stat-num">${padNum(DB.cbStopConv.length)}</div><div class="cb-stat-label">åœæ­¢è½‰æ›</div></div></div>
        </div>`;
    } else if(CB_MODE === 'priceadj') {
        return `<div class="cb-stats">${modeTabsHtml}
            <div class="cb-section-title">ğŸ“ˆ çµ±è¨ˆæ•¸æ“š</div>
            <div class="cb-stats-grid"><div class="cb-stat-item"><div class="cb-stat-num">${padNum(DB.cbPriceAdj.length)}</div><div class="cb-stat-label">åƒ¹æ ¼èª¿æ•´</div></div></div>
        </div>`;
    } else if(CB_MODE === 'concept') {
        const conceptCbCounts = {};
        const conceptNames = ['å¯Œæ«ƒ50æˆä»½è‚¡', 'å°ç£50æˆä»½è‚¡', 'ä¸­å‹100æˆä»½è‚¡', 'NVDIAæ¦‚å¿µè‚¡', 'å°ç©é›»æ¦‚å¿µè‚¡'];
        conceptNames.forEach(cName => {
            const stockCodes = DB.conceptLists[cName] || [];
            conceptCbCounts[cName] = DB.cb.filter(cb => stockCodes.includes(cb._stockCode)).length;
        });
        const searchVal = $('search').value.trim();
        
        return `
            <div class="cb-stats">
                ${modeTabsHtml}
                <div class="cb-section-title">ğŸ“ˆ çµ±è¨ˆæ•¸æ“š</div>
                <div class="cb-stats-grid">
                    <div class="cb-stat-item"><div class="cb-stat-num">${padNum(DB.cb.length)}</div><div class="cb-stat-label">æ›ç‰Œä¸­</div></div>
                </div>
                <div class="cb-ind-title">ğŸ’¡ æ¦‚å¿µè‚¡åˆ†é¡</div>
                <div class="cb-ind-grid">
                    ${conceptNames.map(cName => `
                        <span class="cb-ind-tag ${searchVal === cName ? 'active' : ''}" onclick="setSearch('${cName}')">${cName.replace('æˆä»½è‚¡','').replace('æ¦‚å¿µè‚¡','')}<span class="num">${padNum(conceptCbCounts[cName])}</span></span>
                    `).join('')}
                </div>
            </div>
        `;
    }
    return '';
}

// åˆ‡æ›åˆç´šå¸‚å ´å­æ¨¡å¼
function setPrimaryMode(mode) {
    PRIMARY_MODE = mode;
    $('search').value = '';
    CB_FILTER = { industry: '', guarantee: '', status: '' }; // æ¸…é™¤ç¯©é¸
    renderList();
}

// åˆ‡æ› CB æ¨¡å¼
function setCbMode(mode) {
    CB_MODE = mode;
    $('search').value = '';
    CB_FILTER = { industry: '', guarantee: '', status: '' }; // åˆ‡æ›æ¨¡å¼æ™‚æ¸…é™¤ç¯©é¸
    renderList();
}

// CB äº¤é›†ç¯©é¸ - é»æ“Šç”¢æ¥­æˆ–æ“”ä¿æ¨™ç±¤
function setCbFilter(type, value) {
    if(type === 'industry') {
        // å¦‚æœå·²é¸ä¸­ç›¸åŒç”¢æ¥­ï¼Œå‰‡å–æ¶ˆé¸æ“‡
        CB_FILTER.industry = (CB_FILTER.industry === value) ? '' : value;
    } else if(type === 'guarantee') {
        // å¦‚æœå·²é¸ä¸­ç›¸åŒæ“”ä¿ï¼Œå‰‡å–æ¶ˆé¸æ“‡
        CB_FILTER.guarantee = (CB_FILTER.guarantee === value) ? '' : value;
    } else if(type === 'status') {
        // å¦‚æœå·²é¸ä¸­ç›¸åŒç‹€æ…‹ï¼Œå‰‡å–æ¶ˆé¸æ“‡
        CB_FILTER.status = (CB_FILTER.status === value) ? '' : value;
    }
    renderList();
}

// æ¸…é™¤æ‰€æœ‰CBç¯©é¸
function clearCbFilter() {
    CB_FILTER = { industry: '', guarantee: '', status: '' };
    $('search').value = '';
    $('clearBtn').style.display = 'none';
    renderList();
}

// æ¸…é™¤æ‰€æœ‰ç¯©é¸ï¼ˆåŒ…å«æœå°‹é—œéµå­—ï¼‰- åˆ¥åå‡½æ•¸
window.clearAllFilters = () => {
    clearCbFilter();
};

function setCbInfoTab(tab) {
    CB_INFO_TAB = tab;
    renderList();
}

function renderList() {
    const q = $('search').value.toLowerCase().trim();
    const qOriginal = $('search').value.trim(); // ä¿ç•™åŸå§‹å¤§å°å¯«
    let list = [];
    
    // é¡¯ç¤º/éš±è—çµ±è¨ˆå€å¡Š
    if(CURR_DB === 'cb') {
        $('cbStatsArea').innerHTML = renderCBStats();
        $('cbStatsArea').style.display = 'block';
        $('stockStatsArea').style.display = 'none';
        $('memoStatsArea').style.display = 'none';
    } else if(CURR_DB === 'stocks') {
        $('stockStatsArea').innerHTML = renderStockStats();
        $('stockStatsArea').style.display = 'block';
        $('cbStatsArea').style.display = 'none';
        $('memoStatsArea').style.display = 'none';
    } else if(CURR_DB === 'memo') {
        $('memoStatsArea').innerHTML = renderMemoStats();
        $('memoStatsArea').style.display = 'block';
        $('cbStatsArea').style.display = 'none';
        $('stockStatsArea').style.display = 'none';
    } else {
        $('cbStatsArea').style.display = 'none';
        $('stockStatsArea').style.display = 'none';
        $('memoStatsArea').style.display = 'none';
    }
    
    if(CURR_DB==='news') list = DB.news;
    else if(CURR_DB==='memo') {
        if(MEMO_MODE === 'all') list = DB.memo;
        else if(MEMO_MODE === 'stock') list = DB.memoStock;
        else if(MEMO_MODE === 'industry') list = DB.memoIndustry;
    }
    else if(CURR_DB==='reports') list = DB.reports;
    else if(CURR_DB==='strategy') list = DB.strategy;
    else if(CURR_DB==='stocks') {
        if(STOCK_MODE === 'all') list = Object.values(DB.stocks);
        else if(STOCK_MODE === 'concept') list = DB.conceptStocks;
    }
    else if(CURR_DB==='trends') list = DB.trends;
    else if(CURR_DB==='cb') {
        if(CB_MODE === 'info') list = DB.cbAll;
        else if(CB_MODE === 'active') list = DB.cb;
        else if(CB_MODE === 'history') list = DB.cbHistory;
        else if(CB_MODE === 'auction') list = DB.cbAuction;
        else if(CB_MODE === 'primary') list = PRIMARY_MODE === 'underwriting' ? DB.cbPrimary : DB.cbBoard;
        else if(CB_MODE === 'balance') list = DB.cbBalance;
        else if(CB_MODE === 'cbas') list = DB.cbCBAS;
        else if(CB_MODE === 'redeem') list = DB.cbRedeem;
        else if(CB_MODE === 'stopconv') list = DB.cbStopConv;
        else if(CB_MODE === 'priceadj') list = DB.cbPriceAdj;
        else if(CB_MODE === 'concept') list = DB.cb; // æ¦‚å¿µè‚¡ç”¨æ›ç‰Œä¸­ CB
    }

    const filtered = list.filter(i => {
        const str = JSON.stringify(i).toLowerCase();
        
        // CB äº¤é›†ç¯©é¸ï¼ˆç”¢æ¥­ + æ“”ä¿ + ç‹€æ…‹ï¼‰
        if(CURR_DB === 'cb' && (CB_FILTER.industry || CB_FILTER.guarantee || CB_FILTER.status)) {
            let matchIndustry = true;
            let matchGuarantee = true;
            let matchStatus = true;
            
            // ç”¢æ¥­ç¯©é¸
            if(CB_FILTER.industry) {
                const itemIndustry = i._industry || '';
                matchIndustry = itemIndustry === CB_FILTER.industry;
            }
            
            // æ“”ä¿ç¯©é¸
            if(CB_FILTER.guarantee) {
                const itemGuarantee = i._guarantee || '';
                if(CB_FILTER.guarantee === 'æœ‰æ“”ä¿') {
                    matchGuarantee = itemGuarantee === 'æœ‰æ“”ä¿';
                } else if(CB_FILTER.guarantee === 'ç„¡æ“”ä¿') {
                    matchGuarantee = itemGuarantee === 'ç„¡æ“”ä¿' || itemGuarantee === '0';
                }
            }
            
            // ç‹€æ…‹ç¯©é¸ï¼ˆæ›ç‰Œä¸­/å·²ä¸‹å¸‚ï¼‰
            if(CB_FILTER.status) {
                const isActive = DB.cb.some(c => c._cbCode === i._cbCode);
                if(CB_FILTER.status === 'active') {
                    matchStatus = isActive;
                } else if(CB_FILTER.status === 'delisted') {
                    matchStatus = !isActive;
                }
            }
            
            // äº¤é›†ï¼šå¿…é ˆåŒæ™‚ç¬¦åˆæ‰€æœ‰æ¢ä»¶
            if(!matchIndustry || !matchGuarantee || !matchStatus) return false;
            
            // å¦‚æœæœ‰é¡å¤–çš„æœå°‹å­—ä¸²ï¼Œä¹Ÿè¦ç¬¦åˆ
            if(q && !str.includes(q)) return false;
            
            return true;
        }
        
        // CBAS ç‰¹æ®Šæ¢ä»¶ç¯©é¸
        if(CURR_DB === 'cb' && CB_MODE === 'cbas') {
            const years = parseFloat(i._remainYears) || 0;
            const premium = parseFloat(i._premium) || 0;
            
            if(q === 'å¹´æœŸ>2 æ¬Šåˆ©é‡‘<5') {
                return years > 2 && premium < 5;
            }
            if(q === 'å¹´æœŸ1-2 æ¬Šåˆ©é‡‘<5') {
                return years >= 1 && years <= 2 && premium < 5;
            }
            if(q === 'å¹´æœŸ>2 æ¬Šåˆ©é‡‘5-10') {
                return years > 2 && premium >= 5 && premium <= 10;
            }
            if(q === 'å¹´æœŸ1-2 æ¬Šåˆ©é‡‘5-10') {
                return years >= 1 && years <= 2 && premium >= 5 && premium <= 10;
            }
        }
        
        // æ¦‚å¿µè‚¡ç¯©é¸
        if(CURR_DB === 'cb' && CB_MODE === 'concept') {
            const conceptNames = ['å¯Œæ«ƒ50æˆä»½è‚¡', 'å°ç£50æˆä»½è‚¡', 'ä¸­å‹100æˆä»½è‚¡', 'NVDIAæ¦‚å¿µè‚¡', 'å°ç©é›»æ¦‚å¿µè‚¡'];
            // ç”¨åŸå§‹å¤§å°å¯«æ¯”å°
            const matchedConcept = conceptNames.find(c => c === qOriginal || c.toLowerCase() === q);
            if(matchedConcept) {
                const stockCodes = DB.conceptLists[matchedConcept] || [];
                // æª¢æŸ¥ CB çš„è½‰æ›æ¨™çš„ä»£ç¢¼æ˜¯å¦åœ¨æ¦‚å¿µè‚¡æ¸…å–®ä¸­
                const cbStockCode = i._stockCode || '';
                return stockCodes.includes(cbStockCode);
            }
            // æ²’æœ‰é¸æ“‡æ¦‚å¿µè‚¡æ™‚é¡¯ç¤ºæ‰€æœ‰æ›ç‰Œä¸­ CB
            if(!q) return true;
            // å¦‚æœæœ‰æœå°‹å­—ä¸²ä½†ä¸æ˜¯æ¦‚å¿µè‚¡åç¨±ï¼Œé€²è¡Œä¸€èˆ¬æœå°‹
        }
        
        if(str.includes(q)) return true;
        if(CURR_DB==='memo' && i['ç·¨è™Ÿ']) {
            const d = META.memoDetail[i['ç·¨è™Ÿ']];
            if(d && JSON.stringify(d).toLowerCase().includes(q)) return true;
        }
        return false;
    });
    
    $('resCount').innerText = filtered.length;
    
    // æ›´æ–°ç¯©é¸æ¢ä»¶æç¤º
    let filterHintText = '';
    if(CURR_DB === 'cb' && (CB_FILTER.industry || CB_FILTER.guarantee || CB_FILTER.status)) {
        const parts = [];
        if(CB_FILTER.status) parts.push(CB_FILTER.status === 'active' ? 'æ›ç‰Œä¸­' : 'å·²ä¸‹å¸‚');
        if(CB_FILTER.industry) parts.push(CB_FILTER.industry);
        if(CB_FILTER.guarantee) parts.push(CB_FILTER.guarantee);
        filterHintText = `ï½œç¯©é¸ï¼š${parts.join(' + ')}`;
    }
    $('filterHint').innerHTML = filterHintText;

    let html = '';
    
    // CB ç”¨è¡¨æ ¼å½¢å¼
    if(CURR_DB === 'cb') {
        // åˆç´šå¸‚å ´ã€æµé€šé¤˜é¡ã€CBASã€å¼·åˆ¶è´–å›ã€åœæ­¢è½‰æ›ã€åƒ¹æ ¼èª¿æ•´ã€åŸºæœ¬è³‡æ–™ ä¸éœ€è¦éæ¿¾æ›ç‰Œé«˜ä½
        let validFiltered = filtered;
        const noFilterModes = ['primary', 'balance', 'cbas', 'redeem', 'stopconv', 'priceadj', 'info'];
        if(!noFilterModes.includes(CB_MODE)) {
            // éæ¿¾æ‰æ›ç‰Œæœ€é«˜æˆ–æœ€ä½ç‚º 0 çš„è³‡æ–™ï¼ˆåƒ…é©ç”¨æ–¼æ›ç‰Œä¸­ã€æ­·å²ã€ç«¶æ‹ï¼‰
            validFiltered = filtered.filter(r => {
                const high = parseFloat(r['_high']) || 0;
                const low = parseFloat(r['_low']) || 0;
                return high > 0 && low > 0;
            });
        }
        
        // æ›´æ–°é¡¯ç¤ºç­†æ•¸
        $('resCount').innerText = validFiltered.length;
        
        if(CB_MODE === 'info') {
            // åŸºæœ¬è³‡æ–™æ¨¡å¼ - æ ¹æ“šå­æ¨™ç±¤é¡¯ç¤ºä¸åŒæ¬„ä½
            if(CB_INFO_TAB === 'issue') {
                // ç™¼è¡Œæ¢ä»¶
                html = `<div class="cb-info-section">
                    <div class="cb-info-title">
                        <span class="icon">ğŸ“</span>
                        <span class="text">ç™¼è¡Œæ¢ä»¶</span>
                        <span class="count">${validFiltered.length} ç­†</span>
                    </div>
                    <div class="cb-table-wrap"><table class="cb-table sticky-2cols" id="cbTable">
                    <thead><tr>
                        <th class="sortable sticky-col sticky-col-1" data-col="_cbCode" data-type="string">CBä»£è™Ÿ</th>
                        <th class="sticky-col sticky-col-2">CBç°¡ç¨±</th>
                        <th class="sortable" data-col="_stockCode" data-type="string">è‚¡ç¥¨</th>
                        <th class="sortable" data-col="_method" data-type="string">è©¢/ç«¶</th>
                        <th class="sortable" data-col="_guarantee" data-type="string">æ“”ä¿</th>
                        <th class="sortable" data-col="_years" data-type="num">å¹´æœŸ</th>
                        <th class="sortable" data-col="_scale" data-type="num">è¦æ¨¡</th>
                        <th class="sortable" data-col="_convPrice" data-type="num">è½‰æ›åƒ¹</th>
                        <th class="sortable" data-col="_issuePrice" data-type="num">ç™¼è¡Œåƒ¹</th>
                        <th class="sortable" data-col="_expPrice" data-type="num">åˆ°æœŸåƒ¹</th>
                        <th class="sortable" data-col="_putTiming" data-type="string">è³£å›æ¢ä»¶</th>
                        <th class="sortable" data-col="_issuer" data-type="string">ç™¼è¡Œåˆ¸å•†</th>
                    </tr></thead><tbody>`;
                
                validFiltered.slice(0, 150).forEach(r => {
                    const isActive = DB.cb.find(c => c._cbCode === r._cbCode);
                    const statusClass = isActive ? 'active-cb' : '';
                    const guarText = r._guarantee === 'æœ‰æ“”ä¿' ? 'æœ‰' : (r._guarantee === 'ç„¡æ“”ä¿' || r._guarantee === '0' ? 'ç„¡' : r._guarantee || '');
                    const guarClass = r._guarantee === 'æœ‰æ“”ä¿' ? 'guar-yes' : '';
                    // ç°¡åŒ–è³£å›æ¢ä»¶é¡¯ç¤º
                    let putbackShort = r._putTiming || '';
                    if(putbackShort.length > 15) putbackShort = putbackShort.substring(0, 15) + '...';
                    html += `<tr class="${statusClass}">
                        <td class="code sticky-col sticky-col-1" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                        <td class="sticky-col sticky-col-2">${r._name || ''}</td>
                        <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode}</td>
                        <td>${r._method || ''}</td>
                        <td class="${guarClass}">${guarText}</td>
                        <td>${r._years || ''}</td>
                        <td>${r._scale || ''}</td>
                        <td>${fmtNum(r._convPrice, 2)}</td>
                        <td>${fmtNum(r._issuePrice, 2)}</td>
                        <td>${fmtNum(r._expPrice, 2)}</td>
                        <td title="${r._putTiming || ''}">${putbackShort}</td>
                        <td>${r._issuer || ''}</td>
                    </tr>`;
                });
                html += `</tbody></table></div></div>`;
            } else if(CB_INFO_TAB === 'timeline') {
                // æ™‚ç¨‹è³‡è¨Š
                html = `<div class="cb-info-section">
                    <div class="cb-info-title">
                        <span class="icon">ğŸ“…</span>
                        <span class="text">æ™‚ç¨‹è³‡è¨Š</span>
                        <span class="count">${validFiltered.length} ç­†</span>
                    </div>
                    <div class="cb-table-wrap"><table class="cb-table sticky-2cols" id="cbTable">
                    <thead><tr>
                        <th class="sortable sticky-col sticky-col-1" data-col="_cbCode" data-type="string">CBä»£è™Ÿ</th>
                        <th class="sticky-col sticky-col-2">CBç°¡ç¨±</th>
                        <th class="sortable" data-col="_stockCode" data-type="string">è‚¡ç¥¨</th>
                        <th class="sortable" data-col="_boardDate" data-type="date">è‘£äº‹æœƒ</th>
                        <th class="sortable" data-col="_sendDate" data-type="date">é€ä»¶æ—¥</th>
                        <th class="sortable" data-col="_effectDate" data-type="date">ç”Ÿæ•ˆæ—¥</th>
                        <th class="sortable" data-col="_payDate" data-type="date">ä»£æ”¶æ—¥</th>
                        <th class="sortable" data-col="_bidDate" data-type="string">ç«¶/è©¢æ—¥æœŸ</th>
                        <th class="sortable" data-col="_listDate" data-type="date">æ›ç‰Œæ—¥</th>
                        <th class="sortable" data-col="_cbasDate" data-type="date">æ‹†è§£æ—¥</th>
                        <th class="sortable" data-col="_expDate" data-type="date">åˆ°æœŸæ—¥</th>
                    </tr></thead><tbody>`;
                
                validFiltered.slice(0, 150).forEach(r => {
                    const isActive = DB.cb.find(c => c._cbCode === r._cbCode);
                    const statusClass = isActive ? 'active-cb' : '';
                    html += `<tr class="${statusClass}">
                        <td class="code sticky-col sticky-col-1" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                        <td class="sticky-col sticky-col-2">${r._name || ''}</td>
                        <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode}</td>
                        <td>${fmtDate(r._boardDate)}</td>
                        <td>${fmtDate(r._sendDate)}</td>
                        <td>${fmtDate(r._effectDate)}</td>
                        <td>${fmtDate(r._payDate)}</td>
                        <td>${r._bidDate || ''}</td>
                        <td>${fmtDate(r._listDate)}</td>
                        <td>${fmtDate(r._cbasDate)}</td>
                        <td>${fmtDate(r._expDate)}</td>
                    </tr>`;
                });
                html += `</tbody></table></div></div>`;
            } else if(CB_INFO_TAB === 'putback') {
                // è³£å›æ¢ä»¶
                html = `<div class="cb-info-section">
                    <div class="cb-info-title">
                        <span class="icon">ğŸ’°</span>
                        <span class="text">è³£å›æ¢ä»¶</span>
                        <span class="count">${validFiltered.length} ç­†</span>
                    </div>
                    <div class="cb-table-wrap"><table class="cb-table sticky-2cols" id="cbTable">
                    <thead><tr>
                        <th class="sortable sticky-col sticky-col-1" data-col="_cbCode" data-type="string">CBä»£è™Ÿ</th>
                        <th class="sticky-col sticky-col-2">CBç°¡ç¨±</th>
                        <th class="sortable" data-col="_stockCode" data-type="string">è‚¡ç¥¨</th>
                        <th class="sortable" data-col="_putDate1" data-type="date">è³£å›æ—¥1</th>
                        <th class="sortable" data-col="_putPrice1" data-type="num">è³£å›åƒ¹1</th>
                        <th>è³£å›ç‡</th>
                        <th class="sortable" data-col="_putDate2" data-type="date">è³£å›æ—¥2</th>
                        <th class="sortable" data-col="_putPrice2" data-type="num">è³£å›åƒ¹2</th>
                        <th class="sortable" data-col="_putTiming" data-type="string">è³£å›æ™‚æ©Ÿ</th>
                        <th>è³£å›æ¢ä»¶</th>
                    </tr></thead><tbody>`;
                
                validFiltered.slice(0, 150).forEach(r => {
                    const isActive = DB.cb.find(c => c._cbCode === r._cbCode);
                    const statusClass = isActive ? 'active-cb' : '';
                    
                    // è§£æè³£å›æ¢ä»¶è¨ˆç®—è³£å›åƒ¹
                    const putInfo = parsePutbackCondition(r._putCondition);
                    const putPrice1 = putInfo.prices[0] ? fmtNum(putInfo.prices[0], 2) : '-';
                    const putPrice2 = putInfo.prices[1] ? fmtNum(putInfo.prices[1], 2) : '-';
                    const putRate = putInfo.rate !== null ? fmtNum(putInfo.rate, 2) + '%' : '-';
                    
                    html += `<tr class="${statusClass}">
                        <td class="code sticky-col sticky-col-1" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                        <td class="sticky-col sticky-col-2">${r._name || ''}</td>
                        <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode}</td>
                        <td>${fmtDate(r._putDate1)}</td>
                        <td>${putPrice1}</td>
                        <td>${putRate}</td>
                        <td>${fmtDate(r._putDate2)}</td>
                        <td>${putPrice2}</td>
                        <td>${r._putTiming || ''}</td>
                        <td style="max-width:150px;white-space:normal;text-align:left">${r._putCondition || ''}</td>
                    </tr>`;
                });
                html += `</tbody></table></div></div>`;
            } else if(CB_INFO_TAB === 'convert') {
                // è½‰æ›åˆ†æ
                html = `<div class="cb-info-section">
                    <div class="cb-info-title">
                        <span class="icon">ğŸ”„</span>
                        <span class="text">è½‰æ›åˆ†æ</span>
                        <span class="count">${validFiltered.length} ç­†</span>
                    </div>
                    <div class="cb-table-wrap"><table class="cb-table sticky-2cols" id="cbTable">
                    <thead><tr>
                        <th class="sortable sticky-col sticky-col-1" data-col="_cbCode" data-type="string">CBä»£è™Ÿ</th>
                        <th class="sticky-col sticky-col-2">CBç°¡ç¨±</th>
                        <th class="sortable" data-col="_stockCode" data-type="string">è‚¡ç¥¨</th>
                        <th class="sortable" data-col="_convPrice" data-type="num">è½‰æ›åƒ¹</th>
                        <th class="sortable" data-col="_convRatio" data-type="num">è½‰æ›æ¯”ç‡</th>
                        <th class="sortable" data-col="_issueLots" data-type="num">ç™¼è¡Œå¼µæ•¸</th>
                        <th class="sortable" data-col="_stockLots" data-type="num">ç´„ç•¶è‚¡ç¥¨</th>
                        <th class="sortable" data-col="_convertedLots" data-type="num">å·²è½‰æ›CB</th>
                        <th class="sortable" data-col="_convertedStock" data-type="num">å·²è½‰ç´„ç•¶</th>
                        <th class="sortable" data-col="_remainLots" data-type="num">æµé€šé¤˜é¡</th>
                        <th class="sortable" data-col="_remainPct" data-type="num">é¤˜é¡%</th>
                        <th class="sortable" data-col="_remainStock" data-type="num">é¤˜é¡ç´„ç•¶</th>
                        <th class="sortable" data-col="_capital" data-type="num">è‚¡æœ¬(å„„)</th>
                        <th class="sortable" data-col="_dilutionPct" data-type="num">ä½”è‚¡æœ¬%</th>
                    </tr></thead><tbody>`;
                
                validFiltered.slice(0, 150).forEach(r => {
                    const isActive = DB.cb.find(c => c._cbCode === r._cbCode);
                    const statusClass = isActive ? 'active-cb' : '';
                    
                    // è¨ˆç®—è½‰æ›ç›¸é—œæ•¸æ“š
                    const convPrice = parseFloat(r._convPrice) || 0;
                    const scale = parseFloat(r._scale) || 0;
                    const capitalStr = String(r._capital || '').replace(/[å„„,]/g, '');
                    const capital = parseFloat(capitalStr) || 0;
                    
                    // è½‰æ›æ¯”ç‡ = ç¥¨é¢10è¬ Ã· è½‰æ›åƒ¹
                    const convRatio = convPrice > 0 ? Math.round(100000 / convPrice) : 0;
                    // ç™¼è¡Œå¼µæ•¸ = ç™¼è¡Œè¦æ¨¡(å„„) Ã— 1000
                    const issueLots = Math.round(scale * 1000);
                    // ç´„ç•¶è‚¡ç¥¨å¼µæ•¸ = è½‰æ›æ¯”ç‡ Ã— ç™¼è¡Œå¼µæ•¸ Ã· 1000
                    const stockLots = Math.round(convRatio * issueLots / 1000);
                    // è‚¡æœ¬å¼µæ•¸ = è‚¡æœ¬(å„„) Ã— 10000
                    const capitalLots = Math.round(capital * 10000);
                    // ä½”è‚¡æœ¬% = ç´„ç•¶è‚¡ç¥¨ Ã· è‚¡æœ¬å¼µæ•¸ Ã— 100
                    const dilutionPct = capitalLots > 0 ? (stockLots / capitalLots * 100) : 0;
                    
                    // å¾æµé€šé¤˜é¡è³‡æ–™ä¸­æ‰¾åˆ°è©²CBçš„é¤˜é¡
                    const balanceData = DB.cbBalance.find(b => b._cbCode === r._cbCode);
                    const remainLots = balanceData ? Math.round(parseFloat(balanceData._thisWeek) || 0) : 0;
                    // æµé€šé¤˜é¡%
                    const remainPct = issueLots > 0 ? (remainLots / issueLots * 100) : 0;
                    // æµé€šé¤˜é¡ç´„ç•¶è‚¡ç¥¨
                    const remainStock = Math.round(convRatio * remainLots / 1000);
                    // å·²è½‰æ›CBå¼µæ•¸ = ç™¼è¡Œå¼µæ•¸ - æµé€šé¤˜é¡
                    const convertedLots = issueLots - remainLots;
                    // å·²è½‰æ›ç´„ç•¶è‚¡ç¥¨
                    const convertedStock = Math.round(convRatio * convertedLots / 1000);
                    
                    html += `<tr class="${statusClass}">
                        <td class="code sticky-col sticky-col-1" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                        <td class="sticky-col sticky-col-2">${r._name || ''}</td>
                        <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode}</td>
                        <td>${fmtNum(convPrice, 2)}</td>
                        <td>${fmtNum(convRatio, 0)}</td>
                        <td>${fmtNum(issueLots, 0)}</td>
                        <td style="font-weight:600;color:var(--primary)">${fmtNum(stockLots, 0)}</td>
                        <td>${fmtNum(convertedLots, 0)}</td>
                        <td>${fmtNum(convertedStock, 0)}</td>
                        <td>${fmtNum(remainLots, 0)}</td>
                        <td>${fmtNum(remainPct, 1)}%</td>
                        <td>${fmtNum(remainStock, 0)}</td>
                        <td>${fmtNum(capital, 1)}</td>
                        <td style="font-weight:600;color:#e65100">${fmtNum(dilutionPct, 2)}%</td>
                    </tr>`;
                });
                html += `</tbody></table></div></div>`;
            }
        } else if(CB_MODE === 'auction') {
            // ç«¶æ‹æ¨¡å¼å°ˆå±¬è¡¨æ ¼ - æ ¹æ“š AUCTION_TAB é¡¯ç¤ºä¸åŒæ¬„ä½
            // ç¯©é¸ç‹€æ…‹åˆ—
            const hasAnyFilter = CB_FILTER.industry || CB_FILTER.guarantee || q;
            let filterStatusHtml = '';
            if(hasAnyFilter) {
                const filterParts = [];
                if(CB_FILTER.industry) filterParts.push(`<span class="status-tag">ç”¢æ¥­ï¼š${CB_FILTER.industry}</span>`);
                if(CB_FILTER.guarantee) filterParts.push(`<span class="status-tag">æ“”ä¿ï¼š${CB_FILTER.guarantee}</span>`);
                if(q) filterParts.push(`<span class="status-tag">é—œéµå­—ï¼š${q}</span>`);
                filterStatusHtml = `<div class="cb-filter-status">
                    <div class="status-text">ğŸ” ç¯©é¸æ¢ä»¶ï¼š${filterParts.join('')} <span class="status-count">â†’ å…± <b>${validFiltered.length}</b> æª”ç¬¦åˆ</span></div>
                    <button class="status-clear" onclick="clearAllFilters()">âœ• æ¸…é™¤ç¯©é¸</button>
                </div>`;
            }
            
            // æ¨™ç±¤æ¨™é¡Œå°æ‡‰
            const tabTitles = {
                'basic': 'ğŸ“ åŸºæœ¬è³‡æ–™',
                'bid': 'ğŸ“Š æŠ•æ¨™çµ±è¨ˆ',
                'result': 'ğŸ¯ å¾—æ¨™çµæœ',
                'list': 'ğŸ“ˆ æ›ç‰Œè¡Œæƒ…',
                'detail': 'ğŸ” å¾—æ¨™æ˜ç´°'
            };
            
            html = `<div class="cb-info-section">
                <div class="cb-info-title">
                    <span class="icon">${tabTitles[AUCTION_TAB].split(' ')[0]}</span>
                    <span class="text">${tabTitles[AUCTION_TAB].split(' ')[1]}</span>
                    <span class="count">${validFiltered.length} ç­†</span>
                </div>
                <div class="cb-table-wrap"><table class="cb-table sticky-2cols" id="cbTable">`;
            
            if(AUCTION_TAB === 'basic') {
                // åŸºæœ¬è³‡æ–™ï¼šCBä»£è™Ÿã€ç°¡ç¨±ã€è‚¡ç¥¨ã€æ“”ä¿ã€é–‹æ¨™æ—¥ã€ç™¼è¡Œè¦æ¨¡ã€ç«¶æ‹å¼µæ•¸ã€ç™¼è¡Œåˆ¸å•†
                html += `<thead><tr>
                    <th class="sortable sticky-col sticky-col-1" data-col="_cbCode" data-type="string">CBä»£è™Ÿ</th>
                    <th class="sticky-col sticky-col-2">CBç°¡ç¨±</th>
                    <th class="sortable" data-col="_stockCode" data-type="string">è‚¡ç¥¨</th>
                    <th class="sortable" data-col="_guarantee" data-type="string">æ“”ä¿</th>
                    <th class="sortable" data-col="é–‹æ¨™æ—¥æœŸ" data-type="date">é–‹æ¨™æ—¥</th>
                    <th class="sortable" data-col="ç™¼è¡Œè¦æ¨¡" data-type="num">ç™¼è¡Œè¦æ¨¡</th>
                    <th class="sortable" data-col="ç«¶æ‹å¼µæ•¸" data-type="num">ç«¶æ‹å¼µæ•¸</th>
                    <th class="sortable" data-col="è½‰æ›åƒ¹" data-type="num">è½‰æ›åƒ¹</th>
                    <th class="sortable" data-col="ç™¼è¡Œåˆ¸å•†" data-type="string">ç™¼è¡Œåˆ¸å•†</th>
                </tr></thead><tbody>`;
                validFiltered.slice(0, 150).forEach(r => {
                    const guarText = r._guarantee === 'æœ‰æ“”ä¿' ? 'æœ‰' : (r._guarantee === 'ç„¡æ“”ä¿' || r._guarantee === '0' ? 'ç„¡' : r._guarantee || '');
                    const guarClass = r._guarantee === 'æœ‰æ“”ä¿' ? 'guar-yes' : '';
                    html += `<tr>
                        <td class="code sticky-col sticky-col-1" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                        <td class="sticky-col sticky-col-2">${r._name || ''}</td>
                        <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode || ''}</td>
                        <td class="${guarClass}">${guarText}</td>
                        <td>${fmtDate(r['é–‹æ¨™æ—¥æœŸ'])}</td>
                        <td>${r['ç™¼è¡Œè¦æ¨¡'] || ''}</td>
                        <td>${fmtNum(r['ç«¶æ‹å¼µæ•¸'], 0)}</td>
                        <td>${fmtNum(r['è½‰æ›åƒ¹'], 2)}</td>
                        <td>${r['ç™¼è¡Œåˆ¸å•†'] || ''}</td>
                    </tr>`;
                });
            } else if(AUCTION_TAB === 'bid') {
                // æŠ•æ¨™çµ±è¨ˆï¼šCBä»£è™Ÿã€ç°¡ç¨±ã€è‚¡ç¥¨ã€æ“”ä¿ã€ç«¶æ‹å¼µæ•¸ã€æŠ•æ¨™å¼µæ•¸ã€æŠ•æ¨™å€æ•¸ã€åˆæ ¼ä»¶æ•¸
                html += `<thead><tr>
                    <th class="sortable sticky-col sticky-col-1" data-col="_cbCode" data-type="string">CBä»£è™Ÿ</th>
                    <th class="sticky-col sticky-col-2">CBç°¡ç¨±</th>
                    <th class="sortable" data-col="_stockCode" data-type="string">è‚¡ç¥¨</th>
                    <th class="sortable" data-col="_guarantee" data-type="string">æ“”ä¿</th>
                    <th class="sortable" data-col="ç«¶æ‹å¼µæ•¸" data-type="num">ç«¶æ‹å¼µæ•¸</th>
                    <th class="sortable" data-col="æŠ•æ¨™å¼µæ•¸" data-type="num">æŠ•æ¨™å¼µæ•¸</th>
                    <th class="sortable" data-col="æŠ•æ¨™å€æ•¸" data-type="num">æŠ•æ¨™å€æ•¸</th>
                    <th class="sortable" data-col="åˆæ ¼ä»¶æ•¸" data-type="num">åˆæ ¼ä»¶æ•¸</th>
                    <th class="sortable" data-col="åº•æ¨™åƒ¹" data-type="num">åº•æ¨™åƒ¹</th>
                    <th class="sortable" data-col="æˆªæ¨™æ”¶ç›¤" data-type="num">æˆªæ¨™è‚¡åƒ¹</th>
                    <th class="sortable" data-col="æˆªæ¨™ç†è«–" data-type="num">ç†è«–åƒ¹</th>
                </tr></thead><tbody>`;
                validFiltered.slice(0, 150).forEach(r => {
                    const guarText = r._guarantee === 'æœ‰æ“”ä¿' ? 'æœ‰' : (r._guarantee === 'ç„¡æ“”ä¿' || r._guarantee === '0' ? 'ç„¡' : r._guarantee || '');
                    const guarClass = r._guarantee === 'æœ‰æ“”ä¿' ? 'guar-yes' : '';
                    const multiple = parseFloat(r['æŠ•æ¨™å€æ•¸']) || 0;
                    html += `<tr>
                        <td class="code sticky-col sticky-col-1" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                        <td class="sticky-col sticky-col-2">${r._name || ''}</td>
                        <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode || ''}</td>
                        <td class="${guarClass}">${guarText}</td>
                        <td>${fmtNum(r['ç«¶æ‹å¼µæ•¸'], 0)}</td>
                        <td>${fmtNum(r['æŠ•æ¨™å¼µæ•¸'], 0)}</td>
                        <td style="font-weight:700;color:#1565c0">${fmtNum(multiple, 2)}x</td>
                        <td>${fmtNum(r['åˆæ ¼ä»¶æ•¸'], 0)}</td>
                        <td>${fmtNum(r['åº•æ¨™åƒ¹'], 2)}</td>
                        <td>${r['æˆªæ¨™æ”¶ç›¤'] ? fmtNum(r['æˆªæ¨™æ”¶ç›¤'], 2) : '-'}</td>
                        <td>${fmtNum(r['æˆªæ¨™ç†è«–'], 2)}</td>
                    </tr>`;
                });
            } else if(AUCTION_TAB === 'result') {
                // å¾—æ¨™çµæœï¼šCBä»£è™Ÿã€ç°¡ç¨±ã€è‚¡ç¥¨ã€æ“”ä¿ã€æœ€ä½å¾—æ¨™ã€æœ€ä½æº¢åƒ¹ã€å¹³å‡å¾—æ¨™ã€å¹³å‡æº¢åƒ¹ã€è¨‚åƒ¹æº¢åƒ¹ç‡
                html += `<thead><tr>
                    <th class="sortable sticky-col sticky-col-1" data-col="_cbCode" data-type="string">CBä»£è™Ÿ</th>
                    <th class="sticky-col sticky-col-2">CBç°¡ç¨±</th>
                    <th class="sortable" data-col="_stockCode" data-type="string">è‚¡ç¥¨</th>
                    <th class="sortable" data-col="_guarantee" data-type="string">æ“”ä¿</th>
                    <th class="sortable" data-col="æˆªæ¨™ç†è«–" data-type="num">ç†è«–åƒ¹</th>
                    <th class="sortable" data-col="æœ€ä½å¾—æ¨™" data-type="num">æœ€ä½å¾—æ¨™</th>
                    <th class="sortable" data-col="æœ€ä½æº¢åƒ¹" data-type="num">æœ€ä½æº¢åƒ¹</th>
                    <th class="sortable" data-col="å¹³å‡å¾—æ¨™" data-type="num">å¹³å‡å¾—æ¨™</th>
                    <th class="sortable" data-col="å¹³å‡æº¢åƒ¹" data-type="num">å¹³å‡æº¢åƒ¹</th>
                    <th class="sortable" data-col="è¨‚åƒ¹æº¢åƒ¹ç‡" data-type="num">è¨‚åƒ¹æº¢åƒ¹ç‡</th>
                </tr></thead><tbody>`;
                validFiltered.slice(0, 150).forEach(r => {
                    const guarText = r._guarantee === 'æœ‰æ“”ä¿' ? 'æœ‰' : (r._guarantee === 'ç„¡æ“”ä¿' || r._guarantee === '0' ? 'ç„¡' : r._guarantee || '');
                    const guarClass = r._guarantee === 'æœ‰æ“”ä¿' ? 'guar-yes' : '';
                    const lowestPrem = parseFloat(r['æœ€ä½æº¢åƒ¹']) || 0;
                    const avgPrem = parseFloat(r['å¹³å‡æº¢åƒ¹']) || 0;
                    const pricingPrem = parseFloat(r['è¨‚åƒ¹æº¢åƒ¹ç‡']) || 0;
                    html += `<tr>
                        <td class="code sticky-col sticky-col-1" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                        <td class="sticky-col sticky-col-2">${r._name || ''}</td>
                        <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode || ''}</td>
                        <td class="${guarClass}">${guarText}</td>
                        <td>${fmtNum(r['æˆªæ¨™ç†è«–'], 2)}</td>
                        <td style="font-weight:700;color:#c62828">${fmtNum(r['æœ€ä½å¾—æ¨™'], 2)}</td>
                        <td>${fmtNum(lowestPrem * 100, 2)}%</td>
                        <td style="font-weight:700">${fmtNum(r['å¹³å‡å¾—æ¨™'], 2)}</td>
                        <td>${fmtNum(avgPrem * 100, 2)}%</td>
                        <td>${fmtNum(pricingPrem * 100, 2)}%</td>
                    </tr>`;
                });
            } else if(AUCTION_TAB === 'list') {
                // æ›ç‰Œè¡Œæƒ…ï¼šCBä»£è™Ÿã€ç°¡ç¨±ã€è‚¡ç¥¨ã€æ“”ä¿ã€æœ€ä½å¾—æ¨™ã€å¹³å‡å¾—æ¨™ã€æ›ç‰Œé«˜ã€æ›ç‰Œä½ã€æœ€æ–°åƒ¹ã€æŒ¯å¹…
                html += `<thead><tr>
                    <th class="sortable sticky-col sticky-col-1" data-col="_cbCode" data-type="string">CBä»£è™Ÿ</th>
                    <th class="sticky-col sticky-col-2">CBç°¡ç¨±</th>
                    <th class="sortable" data-col="_stockCode" data-type="string">è‚¡ç¥¨</th>
                    <th class="sortable" data-col="_guarantee" data-type="string">æ“”ä¿</th>
                    <th class="sortable" data-col="æœ€ä½å¾—æ¨™" data-type="num">æœ€ä½å¾—æ¨™</th>
                    <th class="sortable" data-col="å¹³å‡å¾—æ¨™" data-type="num">å¹³å‡å¾—æ¨™</th>
                    <th class="sortable" data-col="_high" data-type="num">æ›ç‰Œæœ€é«˜</th>
                    <th class="sortable" data-col="_low" data-type="num">æ›ç‰Œæœ€ä½</th>
                    <th class="sortable" data-col="_latestPrice" data-type="num">æœ€æ–°æ”¶ç›¤</th>
                    <th class="sortable" data-col="_range" data-type="num">æŒ¯å¹…%</th>
                    <th>æœ€ä½vsæ›ä½</th>
                </tr></thead><tbody>`;
                validFiltered.slice(0, 150).forEach(r => {
                    const guarText = r._guarantee === 'æœ‰æ“”ä¿' ? 'æœ‰' : (r._guarantee === 'ç„¡æ“”ä¿' || r._guarantee === '0' ? 'ç„¡' : r._guarantee || '');
                    const guarClass = r._guarantee === 'æœ‰æ“”ä¿' ? 'guar-yes' : '';
                    const lowBid = parseFloat(r['æœ€ä½å¾—æ¨™']) || 0;
                    const listLow = parseFloat(r._low) || 0;
                    const diff = listLow > 0 && lowBid > 0 ? (listLow - lowBid) : null;
                    const diffColor = diff !== null ? (diff >= 0 ? '#c62828' : '#2e7d32') : '';
                    html += `<tr>
                        <td class="code sticky-col sticky-col-1" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                        <td class="sticky-col sticky-col-2">${r._name || ''}</td>
                        <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode || ''}</td>
                        <td class="${guarClass}">${guarText}</td>
                        <td style="font-weight:600">${fmtNum(lowBid, 2)}</td>
                        <td style="font-weight:600">${fmtNum(r['å¹³å‡å¾—æ¨™'], 2)}</td>
                        <td style="font-weight:700;color:#c62828">${r._high > 0 ? fmtNum(r._high, 2) : '-'}</td>
                        <td style="font-weight:700;color:#2e7d32">${listLow > 0 ? fmtNum(listLow, 2) : '-'}</td>
                        <td>${r._latestPrice > 0 ? fmtNum(r._latestPrice, 2) : '-'}</td>
                        <td class="${colorClass(r._range)}">${fmtNum(r._range, 1)}%</td>
                        <td style="font-weight:700;color:${diffColor}">${diff !== null ? (diff >= 0 ? '+' : '') + fmtNum(diff, 2) : '-'}</td>
                    </tr>`;
                });
            } else if(AUCTION_TAB === 'detail') {
                // å¾—æ¨™æ˜ç´°ï¼šå¾ auctionDetail å–å¾—è³‡æ–™
                // ç¯©é¸æœ‰å¾—æ¨™æ˜ç´°çš„CB
                const detailFiltered = validFiltered.filter(r => DB.auctionDetail[r._cbCode]);
                html += `<thead><tr>
                    <th class="sortable sticky-col sticky-col-1" data-col="_cbCode" data-type="string">CBä»£è™Ÿ</th>
                    <th class="sticky-col sticky-col-2">CBç°¡ç¨±</th>
                    <th class="sortable" data-col="_stockCode" data-type="string">è‚¡ç¥¨</th>
                    <th class="sortable" data-col="_guarantee" data-type="string">æ“”ä¿</th>
                    <th class="sortable" data-col="å¾—æ¨™ç­†æ•¸" data-type="num">ç­†æ•¸</th>
                    <th class="sortable" data-col="å¾—æ¨™å¼µæ•¸" data-type="num">å¼µæ•¸</th>
                    <th class="sortable" data-col="å¾—æ¨™å‡å¼µ" data-type="num">å‡å¼µ</th>
                    <th class="sortable" data-col="top10Ratio" data-type="num">å‰10å¤§å æ¯”</th>
                    <th class="sortable" data-col="mainForceRatio" data-type="num">ä¸»åŠ›é›†ä¸­åº¦</th>
                    <th class="sortable" data-col="over30Ratio" data-type="num">30å¼µâ†‘</th>
                    <th class="sortable" data-col="over100Ratio" data-type="num">100å¼µâ†‘</th>
                    <th class="sortable" data-col="æœ€ä½æ›è‚¡æˆæœ¬" data-type="num">æœ€ä½æ›è‚¡</th>
                    <th>æ˜ç´°</th>
                </tr></thead><tbody>`;
                detailFiltered.slice(0, 150).forEach(r => {
                    const guarText = r._guarantee === 'æœ‰æ“”ä¿' ? 'æœ‰' : (r._guarantee === 'ç„¡æ“”ä¿' || r._guarantee === '0' ? 'ç„¡' : r._guarantee || '');
                    const guarClass = r._guarantee === 'æœ‰æ“”ä¿' ? 'guar-yes' : '';
                    const detail = DB.auctionDetail[r._cbCode];
                    const stats = detail?.stats || {};
                    const cost = detail?.cost || {};
                    const details = detail?.details || [];
                    const top10 = detail?.top10 || [];
                    
                    // ç”¨æ˜ç´°çš„ç¸½å¼µæ•¸ä½œç‚ºåˆ†æ¯ï¼Œç¢ºä¿ä½”æ¯”ä¸æœƒè¶…é100%
                    const totalQty = details.reduce((s, d) => s + (d.qty || 0), 0);
                    const over30Qty = details.filter(d => d.qty >= 30).reduce((s, d) => s + d.qty, 0);
                    const over100Qty = details.filter(d => d.qty >= 100).reduce((s, d) => s + d.qty, 0);
                    const over30Ratio = totalQty > 0 ? (over30Qty / totalQty * 100) : 0;
                    const over100Ratio = totalQty > 0 ? (over100Qty / totalQty * 100) : 0;
                    
                    // å‰åå¤§é‡å æ¯”
                    const top10Qty = top10.reduce((s, t) => s + (t.qty || 0), 0);
                    const top10Ratio = totalQty > 0 ? (top10Qty / totalQty * 100) : 0;
                    
                    // ä¸»åŠ›ç±Œç¢¼é›†ä¸­åº¦ï¼š50å¼µä»¥ä¸Šå¾—æ¨™è€…ä½”æ¯”
                    const over50Qty = details.filter(d => d.qty >= 50).reduce((s, d) => s + d.qty, 0);
                    const mainForceRatio = totalQty > 0 ? (over50Qty / totalQty * 100) : 0;
                    
                    html += `<tr>
                        <td class="code sticky-col sticky-col-1" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                        <td class="sticky-col sticky-col-2">${r._name || ''}</td>
                        <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode || ''}</td>
                        <td class="${guarClass}">${guarText}</td>
                        <td>${fmtNum(stats['å¾—æ¨™ç­†æ•¸'], 0)}</td>
                        <td>${fmtNum(stats['å¾—æ¨™æ•¸é‡'], 0)}</td>
                        <td>${fmtNum(stats['å¾—æ¨™å‡å¼µ'], 1)}</td>
                        <td style="color:${top10Ratio >= 40 ? '#1565c0' : '#333'};font-weight:${top10Ratio >= 40 ? '700' : '500'}">${fmtNum(top10Ratio, 1)}%</td>
                        <td style="color:${mainForceRatio >= 60 ? '#7b1fa2' : '#333'};font-weight:${mainForceRatio >= 60 ? '700' : '500'}">${fmtNum(mainForceRatio, 1)}%</td>
                        <td style="color:${over30Ratio >= 50 ? '#e65100' : '#333'};font-weight:${over30Ratio >= 50 ? '700' : '500'}">${fmtNum(over30Ratio, 1)}%</td>
                        <td style="color:${over100Ratio >= 30 ? '#c62828' : '#333'};font-weight:${over100Ratio >= 30 ? '700' : '500'}">${fmtNum(over100Ratio, 1)}%</td>
                        <td style="color:#c62828;font-weight:600">${fmtNum(cost['æœ€ä½æ›è‚¡æˆæœ¬'], 2)}</td>
                        <td><button onclick="openCbInfo('${r._cbCode}');setTimeout(()=>document.querySelector('[data-tab=auction]')?.click(),100)" style="background:#e65100;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px">ğŸ”</button></td>
                    </tr>`;
                });
                // é¡¯ç¤ºç„¡æ˜ç´°è³‡æ–™çš„æç¤º
                if(detailFiltered.length === 0) {
                    html += `<tr><td colspan="13" style="text-align:center;padding:30px;color:#888">ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹æ²’æœ‰å¾—æ¨™æ˜ç´°è³‡æ–™</td></tr>`;
                }
            }
            
            html += `</tbody></table></div></div>`;
        } else if(CB_MODE === 'primary') {
            // åˆç´šå¸‚å ´è¡¨æ ¼
            if(PRIMARY_MODE === 'auction') {
                // è¿‘æœŸç«¶æ‹æ¨¡å¼ - ä¸é¡¯ç¤ºè¡¨æ ¼ï¼Œç”±çµ±è¨ˆå€å¡Šé¡¯ç¤ºåˆ†æå¡ç‰‡
                html = '';
            } else if(PRIMARY_MODE === 'underwriting') {
                html = `<div class="cb-table-wrap"><table class="cb-table sticky-2cols" id="cbTable">
                    <thead><tr>
                        <th class="sticky-col sticky-col-1">è‚¡ç¥¨ä»£è™Ÿ</th>
                        <th class="sticky-col sticky-col-2">CBä»£è™Ÿ</th>
                        <th>ç™¼è¡Œæ¨™çš„</th>
                        <th class="hide-mobile">è©¢åœˆ/ç«¶æ‹</th>
                        <th class="hide-mobile">TCRI</th>
                        <th>ç™¼è¡Œé‡(å„„)</th>
                        <th class="hide-mobile">ç™¼è¡Œåˆ¸å•†</th>
                        <th class="hide-mobile">æŠ•æ¨™æœŸé–“</th>
                        <th>è½‰æ›åƒ¹</th>
                        <th class="hide-mobile">æº¢åƒ¹ç‡</th>
                        <th class="hide-mobile">æ›ç‰Œæ—¥</th>
                    </tr></thead><tbody>`;
                
                validFiltered.slice(0, 100).forEach(r => {
                    html += `<tr>
                        <td class="code sticky-col sticky-col-1" onclick="openStock('${r._stockCode}')">${r._stockCode}</td>
                        <td class="code sticky-col sticky-col-2" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                        <td>${r._name}</td>
                        <td class="hide-mobile">${r._method}</td>
                        <td class="hide-mobile">${r._tcri}</td>
                        <td>${fmtNum(r._amount, 0)}</td>
                        <td class="hide-mobile">${r._broker}</td>
                        <td class="hide-mobile">${r._bidPeriod}</td>
                        <td>${fmtNum(r._convPrice, 2)}</td>
                        <td class="hide-mobile">${fmtNum(parseFloat(r._premium)*100, 1)}%</td>
                        <td class="hide-mobile">${fmtDate(r._listDate)}</td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            } else {
                // è‘£äº‹æœƒå…¬å‘Š
                html = `<div class="cb-table-wrap"><table class="cb-table sticky-2cols" id="cbTable">
                    <thead><tr>
                        <th class="sticky-col sticky-col-1">è‚¡ç¥¨ä»£è™Ÿ</th>
                        <th class="sticky-col sticky-col-2">CBä»£ç¢¼</th>
                        <th>ç™¼è¡Œæ¨™çš„</th>
                        <th class="hide-mobile">è©¢åœˆ/ç«¶åƒ¹</th>
                        <th class="hide-mobile">TCRI</th>
                        <th>ç™¼è¡Œé‡(å„„)</th>
                        <th class="hide-mobile">ä¸»è¾¦åˆ¸å•†</th>
                        <th>è‘£äº‹æœƒé€šé</th>
                        <th class="hide-mobile">è‚¡æœ¬(å„„)</th>
                        <th class="hide-mobile">å‚™è¨»</th>
                    </tr></thead><tbody>`;
                
                validFiltered.slice(0, 100).forEach(r => {
                    html += `<tr>
                        <td class="code sticky-col sticky-col-1" onclick="openStock('${r._stockCode}')">${r._stockCode}</td>
                        <td class="code sticky-col sticky-col-2" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                        <td>${r._name}</td>
                        <td class="hide-mobile">${r._method}</td>
                        <td class="hide-mobile">${r._tcri}</td>
                        <td>${fmtNum(r._amount, 0)}</td>
                        <td class="hide-mobile">${r._broker}</td>
                        <td>${fmtDate(r._boardDate)}</td>
                        <td class="hide-mobile">${fmtNum(r._capital, 1)}</td>
                        <td class="hide-mobile">${r._note || ''}</td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            }
        } else if(CB_MODE === 'balance') {
            // æµé€šé¤˜é¡è¡¨æ ¼
            html = `<div class="cb-table-wrap"><table class="cb-table sticky-2cols balance-table" id="cbTable">
                <thead><tr>
                    <th class="sortable sticky-col sticky-col-1" data-col="_cbCode" data-type="string">ä»£è™Ÿ</th>
                    <th class="sticky-col sticky-col-2">åç¨±</th>
                    <th class="sortable" data-col="_thisWeek" data-type="num">æœ¬é€±</th>
                    <th class="sortable" data-col="_lastWeek" data-type="num">ä¸Šé€±</th>
                    <th class="sortable" data-col="_change" data-type="num">å¢æ¸›</th>
                    <th class="sortable" data-col="_changeRate" data-type="num">æ¯”ç‡%</th>
                    <th class="sortable" data-col="_remainRate" data-type="num">å‰©é¤˜%</th>
                </tr></thead><tbody>`;
            
            validFiltered.slice(0, 150).forEach(r => {
                const change = parseFloat(r._change) || 0;
                const changeRate = parseFloat(r._changeRate) || 0;
                html += `<tr>
                    <td class="code sticky-col sticky-col-1" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                    <td class="name-col sticky-col sticky-col-2">${r._name}</td>
                    <td>${fmtNum(r._thisWeek, 0)}</td>
                    <td>${fmtNum(r._lastWeek, 0)}</td>
                    <td class="${change > 0 ? 'up' : change < 0 ? 'down' : ''}">${change !== 0 ? fmtNum(change, 0) : '-'}</td>
                    <td class="${changeRate > 0 ? 'up' : changeRate < 0 ? 'down' : ''}">${changeRate !== 0 ? fmtNum(changeRate, 2)+'%' : '-'}</td>
                    <td>${fmtNum(r._remainRate, 0)}%</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else if(CB_MODE === 'cbas') {
            // CBASå ±åƒ¹è¡¨æ ¼
            html = `<div class="cb-table-wrap"><table class="cb-table sticky-2cols" id="cbTable">
                <thead><tr>
                    <th class="sortable sticky-col sticky-col-1" data-col="_cbCode" data-type="string">ä»£è™Ÿ</th>
                    <th class="sticky-col sticky-col-2">åç¨±</th>
                    <th class="sortable" data-col="_guarantee" data-type="string">æ“”ä¿</th>
                    <th class="sortable" data-col="_remainYears" data-type="num">å‰©é¤˜å¹´</th>
                    <th class="sortable" data-col="_premium" data-type="num">æ¬Šåˆ©é‡‘</th>
                    <th class="sortable" data-col="_optExpiry" data-type="date">åˆ°æœŸæ—¥</th>
                    <th class="sortable hide-mobile" data-col="_putPrice" data-type="num">è³£å›åƒ¹</th>
                    <th class="sortable hide-mobile" data-col="_putDate" data-type="date">è³£å›æ—¥</th>
                    <th class="sortable" data-col="_stockPrice" data-type="num">è‚¡åƒ¹</th>
                    <th class="sortable" data-col="_convPrice" data-type="num">è½‰æ›åƒ¹</th>
                    <th class="sortable" data-col="_convValue" data-type="num">ç†è«–åƒ¹</th>
                    <th class="sortable" data-col="_cbPrice" data-type="num">CBåƒ¹æ ¼</th>
                    <th class="sortable" data-col="_premiumPct" data-type="num">æº¢æŠ˜åƒ¹%</th>
                </tr></thead><tbody>`;
            
            validFiltered.slice(0, 150).forEach(r => {
                const premPct = parseFloat(r._premiumPct) || 0;
                const isAuction = r._method === 'ç«¶æ‹';
                const rowClass = isAuction ? 'auction-row' : '';
                html += `<tr class="${rowClass}">
                    <td class="code sticky-col sticky-col-1" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                    <td class="name-col sticky-col sticky-col-2">${r._name}</td>
                    <td><span class="${r._guarantee === 'æœ‰' ? 'guarantee-yes' : ''}">${r._guarantee}</span></td>
                    <td>${fmtNum(r._remainYears, 2)}</td>
                    <td>${fmtNum(r._premium, 2)}</td>
                    <td>${fmtDate(r._optExpiry)}</td>
                    <td class="hide-mobile">${fmtNum(r._putPrice, 2)}</td>
                    <td class="hide-mobile">${fmtDate(r._putDate)}</td>
                    <td>${fmtNum(r._stockPrice, 2)}</td>
                    <td>${fmtNum(r._convPrice, 2)}</td>
                    <td>${fmtNum(r._convValue, 2)}</td>
                    <td>${fmtNum(r._cbPrice, 2)}</td>
                    <td class="${colorClass(premPct)}">${fmtNum(premPct, 1)}%</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else if(CB_MODE === 'redeem') {
            // å¼·åˆ¶è´–å›è¡¨æ ¼
            html = `<div class="cb-table-wrap"><table class="cb-table sticky-2cols" id="cbTable">
                <thead><tr>
                    <th class="sticky-col sticky-col-1">CBä»£è™Ÿ</th>
                    <th class="sticky-col sticky-col-2">CBç°¡ç¨±</th>
                    <th>ç”³å ±æ—¥æœŸ</th>
                    <th>çµ‚æ­¢è²·è³£æ—¥</th>
                    <th>æ›ç‰Œæœ€é«˜</th>
                    <th>æ›ç‰Œæœ€ä½</th>
                    <th>CBæ”¶ç›¤</th>
                    <th class="hide-mobile">ä¸»æ—¨</th>
                </tr></thead><tbody>`;
            
            validFiltered.forEach(r => {
                html += `<tr>
                    <td class="code sticky-col sticky-col-1" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                    <td class="sticky-col sticky-col-2">${r._cbName}</td>
                    <td>${r._reportDate}</td>
                    <td>${r._endDate}</td>
                    <td>${fmtNum(r._high, 2)}</td>
                    <td>${fmtNum(r._low, 2)}</td>
                    <td>${fmtNum(r._cbPrice, 2)}</td>
                    <td class="hide-mobile subject-col">${r._subject}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else if(CB_MODE === 'stopconv') {
            // åœæ­¢è½‰æ›è¡¨æ ¼
            html = `<div class="cb-table-wrap"><table class="cb-table sticky-2cols" id="cbTable">
                <thead><tr>
                    <th class="sticky-col sticky-col-1">å‚µåˆ¸ä»£ç¢¼</th>
                    <th class="sticky-col sticky-col-2">å‚µåˆ¸ç°¡ç¨±</th>
                    <th>åœæ­¢èµ·æ—¥</th>
                    <th>åœæ­¢è¿„æ—¥</th>
                    <th>äº‹ç”±</th>
                </tr></thead><tbody>`;
            
            validFiltered.forEach(r => {
                html += `<tr>
                    <td class="code sticky-col sticky-col-1" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                    <td class="sticky-col sticky-col-2">${r._name}</td>
                    <td>${r._startDate}</td>
                    <td>${r._endDate}</td>
                    <td>${r._reason}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else if(CB_MODE === 'priceadj') {
            // è½‰æ›åƒ¹æ ¼èª¿æ•´è¡¨æ ¼
            html = `<div class="cb-table-wrap"><table class="cb-table sticky-2cols" id="cbTable">
                <thead><tr>
                    <th class="sticky-col sticky-col-1">CBä»£è™Ÿ</th>
                    <th class="sticky-col sticky-col-2">CBç°¡ç¨±</th>
                    <th>èª¿æ•´æ—¥æœŸ</th>
                    <th>åŸå§‹åƒ¹æ ¼</th>
                    <th>èª¿æ•´å¾Œåƒ¹æ ¼</th>
                    <th class="hide-mobile">ä¸»æ—¨</th>
                </tr></thead><tbody>`;
            
            validFiltered.forEach(r => {
                const origPrice = parseFloat(r._origPrice) || 0;
                const newPrice = parseFloat(r._newPrice) || 0;
                const priceChange = newPrice - origPrice;
                html += `<tr>
                    <td class="code sticky-col sticky-col-1" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                    <td class="sticky-col sticky-col-2">${r._cbName}</td>
                    <td>${r._adjDate}</td>
                    <td>${r._origPrice}</td>
                    <td class="${priceChange < 0 ? 'down' : priceChange > 0 ? 'up' : ''}">${r._newPrice}</td>
                    <td class="hide-mobile subject-col">${r._subject}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else {
            // æ›ç‰Œä¸­ / æ­·å² æ¨¡å¼è¡¨æ ¼
            // è¨ˆç®—å¹³å‡å€¼
            const validData = validFiltered.filter(r => r['_premium'] !== null && r['_premium'] !== undefined);
            const avgConvPrice = validData.reduce((s, r) => s + (parseFloat(r['è½‰æ›åƒ¹æ ¼(å…ƒ)']) || 0), 0) / (validData.length || 1);
            const avgStockPrice = validData.reduce((s, r) => s + (parseFloat(r['_stockPrice']) || 0), 0) / (validData.length || 1);
            const avgConvValue = validData.reduce((s, r) => s + (parseFloat(r['_convValue']) || 0), 0) / (validData.length || 1);
            const avgPremium = validData.reduce((s, r) => s + (parseFloat(r['_premium']) || 0), 0) / (validData.length || 1);
            const avgHigh = validFiltered.reduce((s, r) => s + (parseFloat(r['_high']) || 0), 0) / (validFiltered.length || 1);
            const avgLow = validFiltered.reduce((s, r) => s + (parseFloat(r['_low']) || 0), 0) / (validFiltered.length || 1);
            const avgRange = validFiltered.reduce((s, r) => s + (parseFloat(r['_range']) || 0), 0) / (validFiltered.length || 1);
            
            html = `<div class="cb-table-wrap"><table class="cb-table sticky-2cols" id="cbTable">
                <thead><tr>
                    <th class="sortable sticky-col sticky-col-1" data-col="_cbCode" data-type="string">CBä»£è™Ÿ <span class="sort-icon">â‡…</span></th>
                    <th class="sticky-col sticky-col-2">CBç°¡ç¨±</th>
                    <th class="hide-mobile">æ¨™çš„è‚¡ç¥¨</th>
                    <th class="sortable hide-mobile" data-col="_industry" data-type="string">ç”¢æ¥­ <span class="sort-icon">â‡…</span></th>
                    <th class="sortable hide-mobile" data-col="convPrice" data-type="num">è½‰æ›åƒ¹ <span class="sort-icon">â‡…</span></th>
                    <th class="sortable hide-mobile" data-col="_stockPrice" data-type="num">è‚¡åƒ¹ <span class="sort-icon">â‡…</span></th>
                    <th class="sortable hide-mobile" data-col="_convValue" data-type="num">è½‰æ›åƒ¹å€¼ <span class="sort-icon">â‡…</span></th>
                    <th class="sortable hide-mobile" data-col="_premium" data-type="num">æº¢æŠ˜åƒ¹% <span class="sort-icon">â‡…</span></th>
                    <th class="sortable" data-col="_high" data-type="num">æ›ç‰Œæœ€é«˜ <span class="sort-icon">â‡…</span></th>
                    <th class="sortable" data-col="_low" data-type="num">æ›ç‰Œæœ€ä½ <span class="sort-icon">â‡…</span></th>
                    <th class="sortable" data-col="_cbPrice" data-type="num">CBæ”¶ç›¤ <span class="sort-icon">â‡…</span></th>
                    <th class="sortable" data-col="_range" data-type="num">æŒ¯å¹…% <span class="sort-icon">â‡…</span></th>
                    <th class="sortable" data-col="expDate" data-type="date">åˆ°æœŸæ—¥ <span class="sort-icon">â‡…</span></th>
                </tr></thead><tbody>`;
            
            validFiltered.slice(0, 100).forEach(r => {
            const cbCode = r['_cbCode'] || safe(r['ä»£è™Ÿ']);
            const cbName = r['_name'] || safe(r['åç¨±']);
            const stockCode = r['_stockCode'] || '';
            const stockName = r['_stockName'] || safe(r['è½‰æ›æ¨™çš„åç¨±']);
            const ind = r['_industry'] || '';
            const convPrice = r['è½‰æ›åƒ¹æ ¼(å…ƒ)'];
            const stockPrice = r['_stockPrice'];
            const convValue = r['_convValue'];
            const premium = r['_premium'];
            const high = r['_high'];
            const low = r['_low'];
            const cbPrice = r['_cbPrice'];
            const range = r['_range'];
            const expDate = fmtDate(r['åˆ°æœŸæ—¥']);
            
            html += `<tr>
                <td class="code sticky-col sticky-col-1" onclick="openCbInfo('${cbCode}')">${cbCode}</td>
                <td class="sticky-col sticky-col-2">${cbName}</td>
                <td class="stock hide-mobile" onclick="openStock('${stockCode}')">${stockName} ${stockCode}</td>
                <td class="hide-mobile">${ind}</td>
                <td class="hide-mobile">${fmtNum(convPrice, 1)}</td>
                <td class="hide-mobile">${fmtNum(stockPrice, 2)}</td>
                <td class="hide-mobile ${colorClass(convValue)}">${fmtNum(convValue, 2)}</td>
                <td class="hide-mobile ${colorClass(premium)}">${premium ? fmtNum(premium, 1)+'%' : '-'}</td>
                <td>${fmtNum(high, 1)}</td>
                <td>${fmtNum(low, 1)}</td>
                <td>${fmtNum(cbPrice, 2)}</td>
                <td class="${colorClass(range)}">${fmtNum(range, 1)}%</td>
                <td>${expDate}</td>
            </tr>`;
        });
        
        // åˆè¨ˆåˆ—
        html += `</tbody><tfoot><tr class="summary-row">
            <td colspan="2"><b>å¹³å‡å€¼ (${validFiltered.length} ç­†)</b></td>
            <td class="hide-mobile"></td>
            <td class="hide-mobile"></td>
            <td class="hide-mobile"><b>${fmtNum(avgConvPrice, 1)}</b></td>
            <td class="hide-mobile"><b>${fmtNum(avgStockPrice, 2)}</b></td>
            <td class="hide-mobile"><b>${fmtNum(avgConvValue, 2)}</b></td>
            <td class="hide-mobile ${colorClass(avgPremium)}"><b>${fmtNum(avgPremium, 1)}%</b></td>
            <td><b>${fmtNum(avgHigh, 1)}</b></td>
            <td><b>${fmtNum(avgLow, 1)}</b></td>
            <td><b>${fmtNum(avgRange, 1)}%</b></td>
            <td></td>
        </tr></tfoot></table></div>`;
        }
    } else {
        // å…¶ä»–åˆ†é ç”¨å¡ç‰‡
        filtered.slice(0, 100).forEach(i => {
            let title='', sub='', date='', code='', tagClass='brk', body='', click='', cardClass='card';
            
            if(CURR_DB==='stocks') {
                if(STOCK_MODE === 'all') {
                    title = i['å…¬å¸åç¨±']; code = i['ä»£è™Ÿ']; sub = i['ç”¢æ¥­åˆ†é¡']; 
                    body = i['æ¥­å‹™æ‘˜è¦'] || i['ç”¢æ¥­ç´°åˆ†'] || '';
                    click = `openStock('${code}')`;
                } else if(STOCK_MODE === 'concept') {
                    // æ¦‚å¿µè‚¡æ¨¡å¼
                    title = i['_name']; code = i['_code']; 
                    sub = i['_concept']; tagClass = 'concept';
                    body = `${i['_subCat'] ? 'ã€'+i['_subCat']+'ã€‘' : ''}${i['_desc'] || ''}`;
                    click = `openStock('${code}')`;
                }
                // æŸ¥è©¢è©²è‚¡ç¥¨æ˜¯å¦æœ‰æ›ç‰Œä¸­çš„ CB
                const cbList = META.cbMap[code] || [];
                if(cbList.length > 0) {
                    const cbTags = cbList.map(cb => `<span class="tag cb-tag">${cb._name || cb['åç¨±']}</span>`).join('');
                    i._cbTags = cbTags;
                }
            }
            else if(CURR_DB==='news') {
                const dataType = i['è³‡æ–™é¡å‹'] || '';
                const isIndustry = dataType === 'ç”¢æ¥­è¶¨å‹¢';
                title = i['å…¬å¸']; 
                code = i['è‚¡è™Ÿ']; 
                sub = isIndustry ? 'ç”¢æ¥­è¶¨å‹¢' : i['å ±å°é‡é»åˆ†é¡']; 
                date = i['æ—¥æœŸ']; 
                tagClass = isIndustry ? 'trend-ind' : 'ind';
                body = safe(i['å®Œæ•´å ±å°å…§å®¹']).substring(0, 150);
                click = `openNews('${i['ç·¨è™Ÿ']}')`;
                // ç”¢æ¥­è¶¨å‹¢å¡ç‰‡åŠ ä¸Šç‰¹æ®Šæ¨£å¼
                if(isIndustry) cardClass = 'card industry-card';
            }
            else if(CURR_DB==='memo') {
                title = i['å…¬å¸']; code = i['è‚¡è™Ÿ']; sub = i['å ±å‘Šé¡å‹']; date = i['æ—¥æœŸ'];
                const d = META.memoDetail[i['ç·¨è™Ÿ']];
                body = d ? (safe(d['ç‡Ÿé‹é‡é»']).substring(0,100) + '...') : 'é»æ“ŠæŸ¥çœ‹è©³æƒ…';
                click = `openMemo('${i['ç·¨è™Ÿ']}')`;
                // ç”¢æ¥­ç›¸é—œçš„ Memo ç”¨ç´«è‰²
                const reportType = i['å ±å‘Šé¡å‹'] || '';
                if(reportType.includes('ç”¢æ¥­')) {
                    tagClass = 'trend-ind';
                    cardClass = 'card industry-card';
                }
            }
            else if(CURR_DB==='reports') {
                title = i['å ±å‘Šæ¨™é¡Œ']; sub = i['åˆ¸å•†åç¨±'] + ' - ' + safe(i['ç”¢æ¥­åç¨±']); 
                date = i['å ±å‘Šæ—¥æœŸ']; tagClass = 'ind';
                body = i['å‰¯æ¨™é¡Œ'] || '';
                click = `openReport('${i['å ±å‘Šç·¨è™Ÿ']}')`;
            }
            else if(CURR_DB==='strategy') {
                // è¶¨å‹¢å±•æœ›æ–°æ ¼å¼
                title = i['å ±å‘Šä¸»é¡Œ']; 
                sub = i['ä¸»è¬›å–®ä½']; 
                date = i['å ±å‘Šæ—¥æœŸ'];
                tagClass = 'ind';
                const secData = META.stratSections?.[i['å ±å‘Šç·¨è™Ÿ']];
                const coreView = secData?.basic?.['æ ¸å¿ƒè§€é»'] || '';
                const speaker = i['è¬›è€…'] || '';
                body = `${speaker ? 'è¬›è€…: '+speaker+' | ' : ''}${coreView.substring(0, 80)}${coreView.length > 80 ? '...' : ''}`;
                click = `openStrategy('${i['å ±å‘Šç·¨è™Ÿ']}')`;
            }
            else if(CURR_DB==='trends') {
                title = i['ç”¢æ¥­']; sub = i['è¶¨å‹¢åˆ¤æ–·']; tagClass = 'trend-up';
                code = i['è‚¡è™Ÿ']; 
                body = `ä»£è¡¨:${i['ä»£è¡¨å…¬å¸']} | ä½ç½®:${i['æ™¯æ°£ä½ç½®']}`;
                click = `openTrend('${i['ç”¢æ¥­']}')`;
            }

            html += `<div class="${cardClass}" onclick="${click}">
                <div class="card-head"><div class="card-title">${title} ${code?`<span style="color:#999;font-weight:400">${code}</span>`:''}</div>${i._cbTags ? `<div class="cb-tags">${i._cbTags}</div>` : ''}</div>
                <div class="card-meta"><span class="tag ${tagClass}">${sub||'ä¸€èˆ¬'}</span>${date?`<span class="tag dt">${fmtDate(date)}</span>`:''}</div>
                <div class="card-body">${body}</div>
            </div>`;
        });
    }
    
    $('list').innerHTML = html || '<div style="text-align:center;padding:30px;color:#999">ç„¡ç›¸ç¬¦è³‡æ–™</div>';
    
    // CB æ¨¡å¼æ™‚åŠ ä¸Š class è®“è¡¨æ ¼æ»¿ç‰ˆ
    if(CURR_DB === 'cb') {
        $('list').classList.add('cb-mode');
        setTimeout(initCbSort, 50);
    } else {
        $('list').classList.remove('cb-mode');
    }
}

// Modal ç›¸é—œ
function showModal(infoHtml, navItems) {
    $('m-info').innerHTML = infoHtml;
    $('navGrid').innerHTML = navItems.map((n,i) => 
        `<button class="nav-btn ${i===0?'active':''}" onclick="swTab('${n.id}', this)">${n.icon} ${n.label}</button>`
    ).join('');
    $('navGrid').style.display = navItems.length > 1 ? 'flex' : 'none';
    // é è¨­æ¸…ç©ºåº•éƒ¨æ¨™ç±¤ï¼ˆMemoæœƒè‡ªå·±è¨­å®šï¼‰
    const tagsEl = $('m-tags');
    if(tagsEl && !tagsEl.innerHTML) {
        tagsEl.classList.remove('show');
    }
    $('modal').classList.add('show');
}

window.swTab = (id, el) => {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    if(el) el.classList.add('active');
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    const pane = document.getElementById('tab-'+id);
    if(pane) pane.classList.add('active');
};

window.swFin = idx => {
    document.querySelectorAll('.fin-btn').forEach((b,i) => b.classList.toggle('active', i===idx));
    document.querySelectorAll('.fin-sub-pane').forEach((p,i) => p.classList.toggle('active', i===idx));
};

window.closeModal = e => {
    if(!e || e.target.id==='modal' || e.target.classList.contains('m-close')) {
        $('modal').classList.remove('show');
        // æ¸…ç©ºåº•éƒ¨æ¨™ç±¤
        const tagsEl = $('m-tags');
        if(tagsEl) {
            tagsEl.innerHTML = '';
            tagsEl.classList.remove('show');
        }
    }
};

// CB è¡¨æ ¼æ’åº
let cbSortCol = null;
let cbSortDir = 'asc';

window.initCbSort = () => {
    document.querySelectorAll('.cb-table th.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const col = th.dataset.col;
            const type = th.dataset.type;
            
            // åˆ‡æ›æ’åºæ–¹å‘
            if(cbSortCol === col) {
                cbSortDir = cbSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                cbSortCol = col;
                cbSortDir = 'desc'; // é è¨­ç”±å¤§åˆ°å°
            }
            
            // æ›´æ–°æ¨£å¼
            document.querySelectorAll('.cb-table th.sortable').forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });
            th.classList.add(cbSortDir === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // å–å¾— tbody ä¸¦æ’åº
            const tbody = document.querySelector('.cb-table tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                let aVal, bVal;
                const aIndex = Array.from(th.parentNode.children).indexOf(th);
                
                // å–å¾—å°æ‡‰æ¬„ä½çš„å€¼
                aVal = a.children[aIndex]?.textContent?.trim() || '';
                bVal = b.children[aIndex]?.textContent?.trim() || '';
                
                // ç§»é™¤ % å’Œ x ç¬¦è™Ÿï¼Œä»¥åŠé€—è™Ÿ
                aVal = aVal.replace(/%/g, '').replace(/x/g, '').replace(/,/g, '');
                bVal = bVal.replace(/%/g, '').replace(/x/g, '').replace(/,/g, '');
                
                // è™•ç† - ç¬¦è™Ÿï¼ˆè¡¨ç¤ºç„¡è³‡æ–™ï¼‰
                if(aVal === '-') aVal = type === 'num' ? '-999999999' : '';
                if(bVal === '-') bVal = type === 'num' ? '-999999999' : '';
                
                if(type === 'num') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else if(type === 'date') {
                    aVal = aVal.replace(/\//g, '');
                    bVal = bVal.replace(/\//g, '');
                }
                
                if(aVal < bVal) return cbSortDir === 'asc' ? -1 : 1;
                if(aVal > bVal) return cbSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            // é‡æ–°æ’åˆ—
            rows.forEach(row => tbody.appendChild(row));
        });
    });
};

// é–‹å•Ÿå€‹è‚¡
// é–‹å•Ÿ CB åŸºæœ¬è³‡æ–™è©³æƒ…
window.openCbInfo = cbCode => {
    if(!cbCode) { alert('ç„¡CBä»£è™Ÿ'); return; }
    
    // å˜—è©¦å¤šç¨®æ–¹å¼æŸ¥æ‰¾
    let cb = DB.cbAll.find(c => c._cbCode === cbCode);
    if(!cb) cb = DB.cbAll.find(c => String(c._cbCode) === String(cbCode));
    if(!cb) cb = DB.cbAll.find(c => c._cbCode == cbCode);
    
    if(!cb) {
        alert('æ‰¾ä¸åˆ°CBè³‡æ–™: ' + cbCode + '\nDB.cbAllæœ‰ ' + DB.cbAll.length + ' ç­†');
        return;
    }
    
    const isActive = DB.cb.find(c => c._cbCode === cbCode);
    const statusTag = isActive ? '<span class="tag trend-up">æ›ç‰Œä¸­</span>' : '<span class="tag dt">å·²ä¸‹å¸‚</span>';
    
    // å–å¾—CBç¾åƒ¹ï¼ˆå¾æ›ç‰Œä¸­è³‡æ–™æˆ–CBASï¼‰
    const activeCb = DB.cb.find(c => c._cbCode === cbCode);
    const cbasCb = DB.cbCBAS.find(c => c._cbCode === cbCode);
    const cbPrice = activeCb?._cbPrice || cbasCb?._cbPrice || 0;
    
    // è¨ˆç®—å¼·åˆ¶è´–å›å€’æ•¸å¤©æ•¸
    const redeemInfo = DB.cbRedeem.find(r => r._cbCode === cbCode);
    let redeemCountdown = null;
    if(redeemInfo && redeemInfo._endDate) {
        const endDate = new Date(redeemInfo._endDate.replace(/\//g, '-'));
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0);
        redeemCountdown = Math.ceil((endDate - todayDate) / (1000 * 60 * 60 * 24));
    }
    
    // è¨ˆç®—YTP (è³£å›æ®–åˆ©ç‡) å’Œ YTM (åˆ°æœŸæ®–åˆ©ç‡)
    let ytpInfo = { ytp1: null, ytp2: null, days1: null, days2: null, price1: null, price2: null };
    let ytmInfo = { ytm: null, days: null };
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if(cbPrice > 0) {
        // è¨ˆç®—è³£å›æ®–åˆ©ç‡
        const putInfo = parsePutbackCondition(cb._putCondition);
        
        if(cb._putDate1) {
            const putDate1 = new Date(getDateVal(cb._putDate1));
            const days1 = Math.ceil((putDate1 - today) / (1000 * 60 * 60 * 24));
            if(days1 > 0 && putInfo.prices[0]) {
                ytpInfo.days1 = days1;
                ytpInfo.price1 = putInfo.prices[0];
                ytpInfo.ytp1 = (Math.pow(putInfo.prices[0] / cbPrice, 365 / days1) - 1) * 100;
            }
        }
        if(cb._putDate2) {
            const putDate2 = new Date(getDateVal(cb._putDate2));
            const days2 = Math.ceil((putDate2 - today) / (1000 * 60 * 60 * 24));
            if(days2 > 0 && putInfo.prices[1]) {
                ytpInfo.days2 = days2;
                ytpInfo.price2 = putInfo.prices[1];
                ytpInfo.ytp2 = (Math.pow(putInfo.prices[1] / cbPrice, 365 / days2) - 1) * 100;
            }
        }
        
        // è¨ˆç®—åˆ°æœŸæ®–åˆ©ç‡
        if(cb._expDate && cb._expPrice) {
            const expDate = new Date(getDateVal(cb._expDate));
            const expDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
            const expPrice = parseFloat(cb._expPrice) || 100;
            if(expDays > 0) {
                ytmInfo.days = expDays;
                ytmInfo.ytm = (Math.pow(expPrice / cbPrice, 365 / expDays) - 1) * 100;
            }
        }
    }
    
    const infoHtml = `
        <div style="font-size:22px;font-weight:700;margin-bottom:5px">${cb._name} <span style="color:#999;font-size:16px">${cbCode}</span></div>
        <div class="card-meta">
            ${statusTag}
            <span class="tag brk">${cb._industry || 'æœªåˆ†é¡'}</span>
            <span class="tag ind">${cb._method || ''}</span>
            <span class="tag ${cb._guarantee === 'æœ‰æ“”ä¿' ? 'trend-up' : 'dt'}">${cb._guarantee || ''}</span>
        </div>
    `;

    // Tab 1: ç™¼è¡Œæ¢ä»¶ - ä¹å®®æ ¼è¨­è¨ˆ
    const guarClass = cb._guarantee === 'æœ‰æ“”ä¿' ? 'highlight' : '';
    let tIssue = `
        <div class="modal-card-grid">
            <div class="modal-card highlight">
                <div class="val">${fmtNum(cb._convPrice, 2)}</div>
                <div class="lbl">è½‰æ›åƒ¹æ ¼</div>
            </div>
            <div class="modal-card highlight">
                <div class="val">${cb._scale || '-'}</div>
                <div class="lbl">ç™¼è¡Œè¦æ¨¡(å„„)</div>
            </div>
            <div class="modal-card">
                <div class="val">${cb._years || '-'}å¹´</div>
                <div class="lbl">ç™¼è¡Œå¹´æœŸ</div>
            </div>
            <div class="modal-card">
                <div class="val">${cb._issuePrice || '100'}</div>
                <div class="lbl">ç™¼è¡Œåƒ¹æ ¼</div>
            </div>
            <div class="modal-card">
                <div class="val">${cb._expPrice || '100'}</div>
                <div class="lbl">åˆ°æœŸé‚„æœ¬åƒ¹</div>
            </div>
            <div class="modal-card">
                <div class="val">${cb._premium ? fmtNum(cb._premium * 100, 1) + '%' : '-'}</div>
                <div class="lbl">è¨‚åƒ¹æº¢åƒ¹ç‡</div>
            </div>
        </div>
        
        <div class="modal-info-block">
            <div class="title">ğŸ“‹ åŸºæœ¬è³‡è¨Š</div>
            <div class="content">
                <div class="item"><span class="label">CBä»£è™Ÿ</span><span class="value">${cbCode}</span></div>
                <div class="item"><span class="label">è‚¡ç¥¨ä»£è™Ÿ</span><span class="value" style="color:var(--primary);cursor:pointer" onclick="openStock('${cb._stockCode}');closeModal()">${cb._stockCode}</span></div>
                <div class="item"><span class="label">è©¢åœˆ/ç«¶æ‹</span><span class="value">${cb._method || '-'}</span></div>
                <div class="item"><span class="label">æ“”ä¿</span><span class="value ${cb._guarantee === 'æœ‰æ“”ä¿' ? 't-up' : ''}">${cb._guarantee || '-'}</span></div>
                <div class="item"><span class="label">ä¿¡ç”¨è©•ç­‰</span><span class="value">${cb._rating || '-'}</span></div>
                <div class="item"><span class="label">ç™¼è¡Œåˆ¸å•†</span><span class="value">${cb._issuer || '-'}</span></div>
            </div>
        </div>
        
        <div class="modal-info-block">
            <div class="title">ğŸ¢ å…¬å¸è³‡è¨Š</div>
            <div class="content">
                <div class="item"><span class="label">ç”¢æ¥­åˆ†é¡</span><span class="value">${cb._industry || '-'}</span></div>
                <div class="item"><span class="label">ç”¢æ¥­åœ°ä½</span><span class="value">${cb._position || '-'}</span></div>
                <div class="item"><span class="label">è‚¡æœ¬è¦æ¨¡</span><span class="value">${cb._capital || '-'}</span></div>
            </div>
        </div>
    `;
    
    // è³‡é‡‘ç”¨é€”ï¼ˆå¦‚æœæœ‰ï¼‰
    if(cb._fundUse) {
        tIssue += `
            <div class="modal-info-block" style="background:linear-gradient(135deg, #f0f9ff 0%, #fff 100%)">
                <div class="title">ğŸ’° è³‡é‡‘ç”¨é€”</div>
                <div style="font-size:13px;color:#333;line-height:1.6">${cb._fundUse}</div>
            </div>
        `;
    }
    
    // Tab 2: æ™‚ç¨‹è³‡è¨Š - å„ªåŒ–å‘ˆç¾
    let tTimeline = `
        <div class="modal-info-block">
            <div class="title">ğŸ“… ç™¼è¡Œæ™‚ç¨‹</div>
            <div class="content">
                <div class="item"><span class="label">è‘£äº‹æœƒå…¬å‘Š</span><span class="value">${fmtDate(cb._boardDate)}</span></div>
                <div class="item"><span class="label">é€ä»¶æ—¥æœŸ</span><span class="value">${fmtDate(cb._sendDate)}</span></div>
                <div class="item"><span class="label">ç”Ÿæ•ˆæ—¥æœŸ</span><span class="value">${fmtDate(cb._effectDate)}</span></div>
                <div class="item"><span class="label">è©¢åœˆ/ç«¶æ‹</span><span class="value">${cb._bidDate || '-'}</span></div>
                <div class="item"><span class="label">æ›ç‰Œæ—¥æœŸ</span><span class="value" style="color:var(--primary);font-weight:700">${fmtDate(cb._listDate)}</span></div>
                <div class="item"><span class="label">åˆ°æœŸæ—¥æœŸ</span><span class="value" style="color:#e74c3c;font-weight:700">${fmtDate(cb._expDate)}</span></div>
                <div class="item"><span class="label">CBASæ‹†è§£æ—¥</span><span class="value">${fmtDate(cb._cbasDate)}</span></div>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:linear-gradient(135deg, #e8f5e9 0%, #fff 100%)">
            <div class="title" style="color:#27ae60">ğŸ”„ è½‰æ›æœŸé–“</div>
            <div class="content">
                <div class="item"><span class="label">è½‰æ›é–‹å§‹</span><span class="value" style="color:#27ae60;font-weight:700">${fmtDate(cb._convStart)}</span></div>
                <div class="item"><span class="label">è½‰æ›çµæŸ</span><span class="value" style="color:#e74c3c;font-weight:700">${fmtDate(cb._convEnd)}</span></div>
            </div>
        </div>
    `;
    
    // åœæ­¢è½‰æ›æœŸé–“ï¼ˆå¦‚æœæœ‰ï¼‰
    if(cb._stopConvStart || cb._stopConvEnd) {
        tTimeline += `
            <div class="modal-info-block" style="background:linear-gradient(135deg, #fff3e0 0%, #fff 100%)">
                <div class="title" style="color:#e65100">â¸ï¸ åœæ­¢è½‰æ›æœŸé–“</div>
                <div class="content">
                    <div class="item"><span class="label">åœæ­¢èµ·å§‹æ—¥</span><span class="value">${fmtDate(cb._stopConvStart)}</span></div>
                    <div class="item"><span class="label">åœæ­¢çµ‚è¿„æ—¥</span><span class="value">${fmtDate(cb._stopConvEnd)}</span></div>
                </div>
            </div>
        `;
    }
    
    // æ›ç‰ŒæœŸé–“è¡¨ç¾
    if(cb._high > 0 && cb._low > 0) {
        const range = ((cb._high - cb._low) / cb._low * 100);
        tTimeline += `
            <div class="modal-card-grid" style="grid-template-columns: repeat(3, 1fr)">
                <div class="modal-card">
                    <div class="val">${fmtNum(cb._high, 1)}</div>
                    <div class="lbl">æ›ç‰Œæœ€é«˜</div>
                </div>
                <div class="modal-card">
                    <div class="val">${fmtNum(cb._low, 1)}</div>
                    <div class="lbl">æ›ç‰Œæœ€ä½</div>
                </div>
                <div class="modal-card">
                    <div class="val ${colorClass(range)}">${fmtNum(range, 1)}%</div>
                    <div class="lbl">æŒ¯å¹…</div>
                </div>
            </div>
        `;
    }
    
    // å¼·åˆ¶è´–å›å€’æ•¸å¤©æ•¸
    if(redeemCountdown !== null) {
        const urgentClass = redeemCountdown <= 30 ? 't-down' : (redeemCountdown <= 60 ? 't-up' : '');
        const bgColor = redeemCountdown <= 30 ? '#fff0f0' : (redeemCountdown <= 60 ? '#fff8e1' : '#f5f5f5');
        tTimeline += `
            <div class="modal-info-block" style="background:linear-gradient(135deg, ${bgColor} 0%, #fff 100%);border:1px solid ${redeemCountdown <= 30 ? '#ffcccc' : '#e0e0e0'}">
                <div class="title" style="color:#c0392b">ğŸ”” å¼·åˆ¶è´–å›å€’æ•¸</div>
                <div style="display:flex;align-items:center;gap:20px">
                    <div style="text-align:center;min-width:80px">
                        <div style="font-size:36px;font-weight:800;line-height:1" class="${urgentClass}">${redeemCountdown}</div>
                        <div style="font-size:12px;color:#888">å¤©</div>
                    </div>
                    <div style="flex:1">
                        <div style="font-weight:600;color:#c0392b;margin-bottom:4px">âš ï¸ å…¬å¸å·²å®£å¸ƒåŸ·è¡Œè´–å›æ¬Š</div>
                        <div style="font-size:13px;color:#666">çµ‚æ­¢è²·è³£æ—¥ï¼š<b>${redeemInfo._endDate}</b></div>
                        ${redeemCountdown <= 30 ? '<div style="font-size:12px;color:#e74c3c;margin-top:6px;padding:4px 8px;background:#fff;border-radius:4px;display:inline-block">âš¡ å‰©é¤˜ä¸åˆ°30å¤©ï¼Œè«‹æ³¨æ„è½‰æ›æœŸé™ï¼</div>' : ''}
                    </div>
                </div>
            </div>
        `;
    }
    
    // Tab 3: è³£å›æ¢ä»¶ - å„ªåŒ–å‘ˆç¾
    let tPutback = `
        <div class="modal-info-block">
            <div class="title">ğŸ’° è³£å›æ¢ä»¶</div>
            <div class="content">
                <div class="item"><span class="label">è³£å›æ—¥æœŸ1</span><span class="value" style="color:var(--primary)">${fmtDate(cb._putDate1)}</span></div>
                <div class="item"><span class="label">è³£å›æ—¥æœŸ2</span><span class="value" style="color:var(--primary)">${fmtDate(cb._putDate2)}</span></div>
                <div class="item"><span class="label">è³£å›æ™‚æ©Ÿ</span><span class="value">${cb._putTiming || '-'}</span></div>
            </div>
            ${cb._putCondition ? `<div style="font-size:12px;color:#666;margin-top:10px;padding-top:10px;border-top:1px dashed #ddd"><span style="color:#888">è³£å›æ¢ä»¶ï¼š</span>${cb._putCondition}</div>` : ''}
        </div>
    `;
    
    // åŠ å…¥æ®–åˆ©ç‡è¨ˆç®—å€å¡Š
    if(cbPrice > 0) {
        tPutback += `
            <div class="modal-card-grid" style="grid-template-columns: 1fr">
                <div class="modal-card highlight" style="text-align:center">
                    <div class="lbl" style="margin-bottom:5px">CB ç¾åƒ¹</div>
                    <div class="val" style="font-size:28px">${fmtNum(cbPrice, 2)} å…ƒ</div>
                </div>
            </div>
        `;
        
        // YTP è³£å›æ®–åˆ©ç‡
        if(ytpInfo.ytp1 !== null || ytpInfo.ytp2 !== null) {
            tPutback += `<div class="modal-info-block" style="background:linear-gradient(135deg, #fff8e1 0%, #fff 100%)">
                <div class="title" style="color:#f57c00">ğŸ“ˆ è³£å›æ®–åˆ©ç‡ (YTP)</div>`;
            
            if(ytpInfo.ytp1 !== null) {
                const ytpClass = ytpInfo.ytp1 >= 0 ? 't-up' : 't-down';
                tPutback += `
                    <div style="display:flex;align-items:center;gap:15px;padding:10px 0;border-bottom:1px solid #f0f0f0">
                        <div style="flex:1">
                            <div style="font-size:12px;color:#888">ç¬¬ä¸€æ¬¡è³£å›</div>
                            <div style="font-weight:600">${fmtDate(cb._putDate1)}</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:12px;color:#888">è³£å›åƒ¹ ${fmtNum(ytpInfo.price1, 2)} / ${ytpInfo.days1}å¤©</div>
                            <div style="font-size:20px;font-weight:700" class="${ytpClass}">${ytpInfo.ytp1 >= 0 ? '+' : ''}${fmtNum(ytpInfo.ytp1, 2)}%</div>
                        </div>
                    </div>
                `;
            }
            if(ytpInfo.ytp2 !== null) {
                const ytpClass = ytpInfo.ytp2 >= 0 ? 't-up' : 't-down';
                tPutback += `
                    <div style="display:flex;align-items:center;gap:15px;padding:10px 0">
                        <div style="flex:1">
                            <div style="font-size:12px;color:#888">ç¬¬äºŒæ¬¡è³£å›</div>
                            <div style="font-weight:600">${fmtDate(cb._putDate2)}</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:12px;color:#888">è³£å›åƒ¹ ${fmtNum(ytpInfo.price2, 2)} / ${ytpInfo.days2}å¤©</div>
                            <div style="font-size:20px;font-weight:700" class="${ytpClass}">${ytpInfo.ytp2 >= 0 ? '+' : ''}${fmtNum(ytpInfo.ytp2, 2)}%</div>
                        </div>
                    </div>
                `;
            }
            tPutback += `</div>`;
        }
        
        // YTM åˆ°æœŸæ®–åˆ©ç‡
        if(ytmInfo.ytm !== null) {
            const ytmClass = ytmInfo.ytm >= 0 ? 't-up' : 't-down';
            tPutback += `
                <div class="modal-info-block" style="background:linear-gradient(135deg, #e3f2fd 0%, #fff 100%)">
                    <div class="title" style="color:#1976d2">ğŸ åˆ°æœŸæ®–åˆ©ç‡ (YTM)</div>
                    <div style="display:flex;align-items:center;gap:15px;padding:10px 0">
                        <div style="flex:1">
                            <div style="font-size:12px;color:#888">åˆ°æœŸæ—¥</div>
                            <div style="font-weight:600">${fmtDate(cb._expDate)}</div>
                        </div>
                        <div style="text-align:right">
                            <div style="font-size:12px;color:#888">åˆ°æœŸåƒ¹ ${fmtNum(cb._expPrice, 2)} / ${ytmInfo.days}å¤©</div>
                            <div style="font-size:20px;font-weight:700" class="${ytmClass}">${ytmInfo.ytm >= 0 ? '+' : ''}${fmtNum(ytmInfo.ytm, 2)}%</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if(ytpInfo.ytp1 === null && ytpInfo.ytp2 === null && ytmInfo.ytm === null) {
            tPutback += `<div style="color:#999;font-size:13px;padding:10px 0;text-align:center">ç„¡æ³•è¨ˆç®—æ®–åˆ©ç‡ï¼ˆç¼ºå°‘è³£å›/åˆ°æœŸæ—¥æœŸè³‡æ–™ï¼‰</div>`;
        }
    } else {
        tPutback += `
            <div class="modal-info-block" style="background:#f5f5f5">
                <div style="color:#999;font-size:13px;text-align:center;padding:10px 0">ğŸ“Š ç„¡CBç¾åƒ¹è³‡æ–™ï¼Œç„¡æ³•è¨ˆç®—æ®–åˆ©ç‡</div>
            </div>
        `;
    }
    
    // é€£çµåˆ°è‚¡ç¥¨åŸºæœ¬è³‡æ–™ - å„ªåŒ–å‘ˆç¾
    let tStock = `
        <div class="modal-info-block" style="cursor:pointer" onclick="openStock('${cb._stockCode}');closeModal()">
            <div class="title">ğŸ¢ ç™¼è¡Œå…¬å¸</div>
            <div style="display:flex;align-items:center;gap:15px">
                <div style="width:60px;height:60px;background:var(--primary);border-radius:10px;display:flex;align-items:center;justify-content:center">
                    <span style="font-size:24px;color:#fff;font-weight:700">${cb._stockCode?.substring(0, 2) || ''}</span>
                </div>
                <div style="flex:1">
                    <div style="font-size:18px;font-weight:700;color:var(--primary)">${cb._stockCode}</div>
                    <div style="font-size:13px;color:#666;margin-top:2px">é»æ“ŠæŸ¥çœ‹å…¬å¸åŸºæœ¬è³‡æ–™ â†’</div>
                </div>
            </div>
        </div>
        
        <div class="modal-info-block">
            <div class="title">ğŸ“Š å¿«é€Ÿè³‡è¨Š</div>
            <div class="content">
                <div class="item"><span class="label">CBç°¡ç¨±</span><span class="value">${cb._name}</span></div>
                <div class="item"><span class="label">ç”¢æ¥­</span><span class="value">${cb._industry || '-'}</span></div>
                <div class="item"><span class="label">è½‰æ›åƒ¹</span><span class="value">${fmtNum(cb._convPrice, 2)}</span></div>
                <div class="item"><span class="label">ç™¼è¡Œè¦æ¨¡</span><span class="value">${cb._scale || '-'} å„„</span></div>
            </div>
        </div>
    `;

    // Tab 5: è½‰æ›åˆ†æ
    // è¨ˆç®—è½‰æ›ç›¸é—œæ•¸æ“š
    const convPrice = parseFloat(cb._convPrice) || 0;
    const scale = parseFloat(cb._scale) || 0;
    // è§£æè‚¡æœ¬ï¼ˆå¯èƒ½æ˜¯ "10.5" æˆ– "10.5å„„" æ ¼å¼ï¼‰
    const capitalStr = String(cb._capital || '').replace(/[å„„,]/g, '');
    const capital = parseFloat(capitalStr) || 0;
    
    // è¨ˆç®—å…¬å¼ï¼ˆå…¨éƒ¨ç”¨æ•´æ•¸ï¼‰
    const convRatio = convPrice > 0 ? Math.round(100000 / convPrice) : 0;  // è½‰æ›æ¯”ç‡
    const issueLots = Math.round(scale * 1000);  // ç™¼è¡Œå¼µæ•¸
    const stockLots = Math.round(convRatio * issueLots / 1000);  // ç´„ç•¶è‚¡ç¥¨å¼µæ•¸
    const capitalLots = Math.round(capital * 10000);  // è‚¡æœ¬å¼µæ•¸
    const dilutionPct = capitalLots > 0 ? (stockLots / capitalLots * 100) : 0;  // ä½”è‚¡æœ¬%
    
    // å¾æµé€šé¤˜é¡è³‡æ–™ä¸­æ‰¾åˆ°è©²CBçš„é¤˜é¡
    const balanceData = DB.cbBalance.find(b => b._cbCode === cb._cbCode);
    const remainLots = balanceData ? Math.round(parseFloat(balanceData._thisWeek) || 0) : 0;
    const remainPct = issueLots > 0 ? (remainLots / issueLots * 100) : 0;  // æµé€šé¤˜é¡%
    const remainStock = Math.round(convRatio * remainLots / 1000);  // æµé€šç´„ç•¶è‚¡ç¥¨
    const convertedLots = issueLots - remainLots;  // å·²è½‰æ›CBå¼µæ•¸
    const convertedStock = Math.round(convRatio * convertedLots / 1000);  // å·²è½‰æ›ç´„ç•¶è‚¡ç¥¨
    
    let tConversion = `
        <div class="modal-info-block" style="background:linear-gradient(135deg, #e8f5e9 0%, #fff 100%)">
            <div class="title" style="color:#2e7d32">ğŸ”„ è½‰æ›æ¯”ç‡</div>
            <div class="modal-card-grid">
                <div class="modal-card">
                    <div class="val">${fmtNum(convPrice, 2)}</div>
                    <div class="lbl">è½‰æ›åƒ¹</div>
                </div>
                <div class="modal-card highlight">
                    <div class="val" style="color:#2e7d32">${fmtNum(convRatio, 0)}</div>
                    <div class="lbl">è½‰æ›æ¯”ç‡(è‚¡)</div>
                </div>
            </div>
            <div style="margin-top:10px;padding:10px;background:#fff;border-radius:8px;font-size:12px;color:#666">
                ğŸ“ ç¥¨é¢ 10è¬ Ã· è½‰æ›åƒ¹ ${fmtNum(convPrice, 2)} = ${fmtNum(convRatio, 0)} è‚¡
            </div>
        </div>
        
        <div class="modal-info-block">
            <div class="title">ğŸ“Š ç™¼è¡Œèˆ‡ç´„ç•¶è‚¡ç¥¨</div>
            <div class="modal-card-grid">
                <div class="modal-card">
                    <div class="val">${fmtNum(issueLots, 0)}</div>
                    <div class="lbl">ç™¼è¡Œå¼µæ•¸</div>
                </div>
                <div class="modal-card highlight">
                    <div class="val">${fmtNum(stockLots, 0)}</div>
                    <div class="lbl">ç´„ç•¶è‚¡ç¥¨(å¼µ)</div>
                </div>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:linear-gradient(135deg, #fff8e1 0%, #fff 100%)">
            <div class="title" style="color:#f57c00">ğŸ“¤ å·²è½‰æ›åˆ†æ</div>
            <div class="modal-card-grid">
                <div class="modal-card">
                    <div class="val">${fmtNum(convertedLots, 0)}</div>
                    <div class="lbl">å·²è½‰æ›CB(å¼µ)</div>
                </div>
                <div class="modal-card">
                    <div class="val">${fmtNum(convertedStock, 0)}</div>
                    <div class="lbl">å·²è½‰ç´„ç•¶è‚¡ç¥¨</div>
                </div>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:linear-gradient(135deg, #e3f2fd 0%, #fff 100%)">
            <div class="title" style="color:#1565c0">ğŸ’¹ æµé€šé¤˜é¡åˆ†æ</div>
            <div class="modal-card-grid">
                <div class="modal-card">
                    <div class="val">${fmtNum(remainLots, 0)}</div>
                    <div class="lbl">æµé€šé¤˜é¡(å¼µ)</div>
                </div>
                <div class="modal-card">
                    <div class="val">${fmtNum(remainPct, 1)}%</div>
                    <div class="lbl">é¤˜é¡%</div>
                </div>
                <div class="modal-card">
                    <div class="val">${fmtNum(remainStock, 0)}</div>
                    <div class="lbl">é¤˜é¡ç´„ç•¶è‚¡ç¥¨</div>
                </div>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:linear-gradient(135deg, #fff3e0 0%, #fff 100%)">
            <div class="title" style="color:#e65100">ğŸ“ˆ è‚¡æœ¬ç¨€é‡‹åˆ†æ</div>
            <div class="modal-card-grid">
                <div class="modal-card">
                    <div class="val">${fmtNum(capital, 1)}</div>
                    <div class="lbl">è‚¡æœ¬(å„„)</div>
                </div>
                <div class="modal-card highlight">
                    <div class="val" style="color:#e65100">${fmtNum(dilutionPct, 2)}%</div>
                    <div class="lbl">ä½”è‚¡æœ¬%</div>
                </div>
            </div>
            <div style="margin-top:10px;padding:10px;background:#fff;border-radius:8px;font-size:12px;color:#666">
                ğŸ“ è‚¡æœ¬ ${fmtNum(capital, 1)}å„„ = ${fmtNum(capitalLots, 0)} å¼µ<br>
                ğŸ“ ä½”è‚¡æœ¬ = ${fmtNum(stockLots, 0)} Ã· ${fmtNum(capitalLots, 0)} Ã— 100% = ${fmtNum(dilutionPct, 2)}%
            </div>
        </div>
    `;
    
    // è£œå……èªªæ˜
    tConversion += `
        <div class="modal-info-block" style="background:#fafafa">
            <div class="title">ğŸ“– åè©èªªæ˜</div>
            <div style="font-size:12px;color:#666;line-height:1.8">
                <div><b>è½‰æ›æ¯”ç‡</b>ï¼šæ¯å¼µCBï¼ˆç¥¨é¢10è¬ï¼‰å¯æ›å¾—çš„è‚¡æ•¸</div>
                <div><b>ç´„ç•¶è‚¡ç¥¨</b>ï¼šå…¨éƒ¨CBè½‰æ›å¾Œå°æ‡‰çš„è‚¡ç¥¨å¼µæ•¸</div>
                <div><b>å·²è½‰æ›CB</b>ï¼šç™¼è¡Œå¼µæ•¸ - æµé€šé¤˜é¡å¼µæ•¸</div>
                <div><b>ä½”è‚¡æœ¬%</b>ï¼šç´„ç•¶è‚¡ç¥¨å¼µæ•¸ä½”å…¬å¸ç¸½è‚¡æœ¬çš„æ¯”ä¾‹</div>
            </div>
        </div>
    `;

    // Tab 6: åƒ¹å€¼åˆ†æ
    // å¾æ›ç‰Œ CB æˆ– CBAS å–å¾—å³æ™‚åƒ¹æ ¼è³‡è¨Šï¼ˆä½¿ç”¨å·²å®šç¾©çš„ activeCb è®Šæ•¸ï¼‰
    const cbasData = DB.cbCBAS.find(c => c._cbCode === cb._cbCode);
    
    // å–å¾—åƒ¹æ ¼è³‡è¨Šï¼ˆå„ªå…ˆä½¿ç”¨æ›ç‰Œ CB è³‡æ–™ï¼‰
    const stockPriceVal = parseFloat(activeCb?._stockPrice || cbasData?._stockPrice) || 0;
    const cbPriceVal = parseFloat(activeCb?._cbPrice || cbasData?._cbPrice) || 0;
    const convPriceVal = parseFloat(cb._convPrice) || 0;
    
    // è¨ˆç®—è½‰æ›åƒ¹å€¼ï¼ˆç†è«–åƒ¹å€¼ï¼‰= 100 Ã— (è‚¡åƒ¹ Ã· è½‰æ›åƒ¹)
    const convValueCalc = convPriceVal > 0 ? (100 * stockPriceVal / convPriceVal) : 0;
    
    // è¨ˆç®—æº¢åƒ¹ç‡ = (CBåƒ¹æ ¼ - è½‰æ›åƒ¹å€¼) Ã· è½‰æ›åƒ¹å€¼ Ã— 100%
    const premiumRateCalc = convValueCalc > 0 ? ((cbPriceVal - convValueCalc) / convValueCalc * 100) : 0;
    
    // ç¥¨é¢æŒè‚¡æˆæœ¬ = è½‰æ›åƒ¹ Ã— CBåƒ¹æ ¼ Ã· 100
    const stockCostCalc = cbPriceVal > 0 ? (convPriceVal * cbPriceVal / 100) : 0;
    
    // åˆ¤æ–·æ˜¯å¦æœ‰è½‰æ›åƒ¹å€¼
    const hasConvValue = convValueCalc >= 100;
    const valueStatus = hasConvValue ? 'æœ‰è½‰æ›åƒ¹å€¼' : 'é‚„æ²’æœ‰è½‰æ›çš„åƒ¹å€¼';
    const valueStatusColor = hasConvValue ? '#27ae60' : '#e74c3c';
    const valueStatusBg = hasConvValue ? '#e8f5e9' : '#ffebee';
    
    let tValue = `
        <div class="modal-info-block" style="background:linear-gradient(135deg, #1a237e 0%, #283593 100%);color:#fff;padding:20px;border-radius:12px">
            <div style="text-align:center;margin-bottom:15px">
                <div style="font-size:14px;opacity:0.8">${cb._name}</div>
                <div style="font-size:28px;font-weight:800;margin:5px 0">å¯è½‰æ›å…¬å¸å‚µåƒ¹å€¼åˆ†æ</div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:15px;background:rgba(255,255,255,0.1);border-radius:8px">
                <div>
                    <div style="font-size:12px;opacity:0.7">è½‰æ›åƒ¹ç‚º</div>
                    <div style="font-size:24px;font-weight:700">${fmtNum(convPriceVal, 1)} å…ƒ</div>
                </div>
                <div style="font-size:12px;opacity:0.7">${fmtDate(new Date())}</div>
                <div>
                    <div style="font-size:12px;opacity:0.7">${cb._stockCode} çš„æ”¶ç›¤ç‚º</div>
                    <div style="font-size:24px;font-weight:700;color:#ffeb3b">${fmtNum(stockPriceVal, 2)}</div>
                </div>
                <div style="padding:8px 16px;background:${valueStatusBg};color:${valueStatusColor};border-radius:20px;font-weight:600;font-size:13px">
                    ${valueStatus}
                </div>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:#fff3e0;border:1px solid #ffe0b2;margin-top:15px">
            <div style="font-size:13px;color:#e65100;line-height:1.8">
                ğŸ“Œ å¯è½‰å‚µçš„æ¼²è·Œå°‡ä¸èˆ‡æ¨™çš„è‚¡ç¥¨åŒæ­¥ï¼Œæ›´å¤šæ˜¯<b>å‚µåˆ¸çš„æŠ—è·Œæ€§</b>åŠ<b>åˆ°æœŸçš„ä¿æœ¬ç‰¹æ€§</b>
            </div>
        </div>
        
        <div class="modal-info-block" style="margin-top:15px">
            <div class="title" style="color:#1565c0">ğŸ“Š ç†è«–åƒ¹å€¼èˆ‡æº¢åƒ¹åˆ†æ</div>
            <div class="modal-card-grid" style="grid-template-columns:repeat(3, 1fr)">
                <div class="modal-card">
                    <div class="val">${fmtNum(convValueCalc, 1)}</div>
                    <div class="lbl">ç†è«–åƒ¹å€¼</div>
                    <div style="font-size:10px;color:#888;margin-top:4px">å¸‚å ´ä¸Šçš„</div>
                </div>
                <div class="modal-card highlight" style="background:linear-gradient(135deg, #fff8e1 0%, #fff 100%)">
                    <div class="val" style="color:#f57c00">${fmtNum(cbPriceVal, 2)}</div>
                    <div class="lbl">å¯è½‰å‚µæ”¶ç›¤åƒ¹æ ¼</div>
                    <div style="font-size:10px;color:#888;margin-top:4px">ä»£è¡¨è²·é€²çš„CB</div>
                </div>
                <div class="modal-card" style="background:${premiumRateCalc > 0 ? '#fff3e0' : '#e8f5e9'}">
                    <div class="val" style="color:${premiumRateCalc > 0 ? '#e65100' : '#27ae60'}">${fmtNum(Math.abs(premiumRateCalc), 2)}%</div>
                    <div class="lbl">${premiumRateCalc > 0 ? 'æº¢åƒ¹(è²´äº†?)' : 'æŠ˜åƒ¹(ä¾¿å®œ?)'}</div>
                </div>
            </div>
            <div style="margin-top:12px;padding:12px;background:#f5f5f5;border-radius:8px;font-size:12px;color:#666">
                ğŸ“ ç†è«–åƒ¹å€¼ = 100 Ã— (è‚¡åƒ¹ ${fmtNum(stockPriceVal, 2)} Ã· è½‰æ›åƒ¹ ${fmtNum(convPriceVal, 1)}) = <b>${fmtNum(convValueCalc, 2)}</b><br>
                ğŸ“ æº¢åƒ¹ç‡ = (CBåƒ¹ ${fmtNum(cbPriceVal, 2)} - ç†è«–åƒ¹å€¼ ${fmtNum(convValueCalc, 2)}) Ã· ${fmtNum(convValueCalc, 2)} Ã— 100% = <b>${fmtNum(premiumRateCalc, 2)}%</b>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:#e8f5e9;border:1px solid #c8e6c9;margin-top:15px">
            <div style="font-size:13px;color:#2e7d32;line-height:1.8">
                ğŸ’¡ <b>æº¢åƒ¹</b>é€šå¸¸æ˜¯æŒ‡è²·å¯è½‰å‚µè¦è²´å¤šå°‘%ï¼Œé€šå¸¸è¶Šçœ‹å¥½è©²æ¨™çš„æœªä¾†çš„<b>çˆ†ç™¼æ€§</b>ï¼Œè¶Šèƒ½æ¥å—è¶Šé«˜çš„æº¢åƒ¹ç‡ã€‚<br>
                ğŸ’¡ æ›å¥è©±èªªï¼Œé€šå¸¸è¶Šæ²’æœ‰è½‰æ›åƒ¹å€¼çš„æ¨™çš„æº¢åƒ¹ç‡å°±è¶Šé«˜ï¼Œç›¸å°çš„<b>é¸æ“‡æ¬Šçš„æ¬Šåˆ©é‡‘çš„æå¤±ä¹Ÿæ˜¯æœ€å°çš„</b>ã€‚
            </div>
        </div>
        
        <div class="modal-info-block" style="background:linear-gradient(135deg, #e3f2fd 0%, #fff 100%);margin-top:15px">
            <div class="title" style="color:#1565c0">ğŸ’° ç¥¨é¢æŒè‚¡æˆæœ¬åˆ†æ</div>
            <div style="display:flex;align-items:center;justify-content:center;gap:15px;padding:20px;flex-wrap:wrap">
                <div style="text-align:center">
                    <div style="font-size:12px;color:#666">å¦‚æœè²·é€²</div>
                    <div style="font-size:11px;color:#888">æº¢åƒ¹ç‡</div>
                    <div style="font-size:22px;font-weight:700;color:#e65100">${fmtNum(premiumRateCalc, 2)}%</div>
                </div>
                <div style="text-align:center">
                    <div style="font-size:12px;color:#666">çš„å¯è½‰å‚µ</div>
                    <div style="font-size:22px;font-weight:700;color:#1565c0">${fmtNum(cbPriceVal, 1)} å…ƒ</div>
                </div>
                <div style="font-size:24px;color:#999">â†’</div>
                <div style="text-align:center">
                    <div style="font-size:12px;color:#666">ç­‰æ–¼ç¥¨é¢æŒè‚¡æˆæœ¬</div>
                    <div style="font-size:11px;color:#888">è½‰æ›åƒ¹</div>
                    <div style="font-size:18px;font-weight:600;color:#666">${fmtNum(convPriceVal, 1)} å…ƒ</div>
                </div>
                <div style="font-size:24px;color:#999">â†’</div>
                <div style="text-align:center;padding:15px 20px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1)">
                    <div style="font-size:12px;color:#666">æœƒè®Šæˆäº†</div>
                    <div style="font-size:28px;font-weight:800;color:#e74c3c">${fmtNum(stockCostCalc, 1)} å…ƒ</div>
                </div>
            </div>
            <div style="margin-top:12px;padding:12px;background:#fff;border-radius:8px;font-size:12px;color:#666">
                ğŸ“ ç¥¨é¢æŒè‚¡æˆæœ¬ = è½‰æ›åƒ¹ ${fmtNum(convPriceVal, 1)} Ã— CBåƒ¹æ ¼ ${fmtNum(cbPriceVal, 2)} Ã· 100 = <b>${fmtNum(stockCostCalc, 2)} å…ƒ</b>
            </div>
        </div>
    `;
    
    // å¦‚æœæ²’æœ‰å³æ™‚åƒ¹æ ¼è³‡è¨Šï¼Œé¡¯ç¤ºæç¤º
    if(!stockPriceVal || !cbPriceVal) {
        tValue = `
            <div class="modal-info-block" style="background:#fff3e0;text-align:center;padding:40px">
                <div style="font-size:48px;margin-bottom:15px">ğŸ“Š</div>
                <div style="font-size:16px;font-weight:600;color:#e65100;margin-bottom:10px">æš«ç„¡å³æ™‚åƒ¹æ ¼è³‡è¨Š</div>
                <div style="font-size:13px;color:#666">
                    æ­¤CBç›®å‰æ²’æœ‰å³æ™‚è‚¡åƒ¹æˆ–CBåƒ¹æ ¼è³‡è¨Šï¼Œ<br>
                    å¯èƒ½æ˜¯å·²ä¸‹å¸‚æˆ–å°šæœªé–‹å§‹äº¤æ˜“ã€‚
                </div>
            </div>
        `;
    }
    
    // ========== æƒ…å¢ƒåˆ†æå…±ç”¨è¨ˆç®— ==========
    // äº¤å‰²é‡‘é¡ = CBåƒ¹æ ¼ Ã— 1000
    const settlementAmt = cbPriceVal * 1000;
    // åˆ°æœŸé‚„æœ¬åƒ¹æ ¼ï¼ˆé è¨­100ï¼Œè‹¥æœ‰è³‡æ–™å‰‡ç”¨å¯¦éš›å€¼ï¼‰
    const maturityPrice = parseFloat(cb._expPrice) || 100;
    // æœ€å¤§æå¤± = (CBåƒ¹æ ¼ - åˆ°æœŸé‚„æœ¬åƒ¹æ ¼) Ã— 1000
    const maxLoss = (cbPriceVal - maturityPrice) * 1000;
    // å‰©é¤˜å¤©æ•¸å’Œå¹´æ•¸
    const expDateVal = getDateVal(cb._expDate);
    const todayTime = new Date().getTime();
    const remainDays = Math.max(0, Math.ceil((expDateVal - todayTime) / (1000 * 60 * 60 * 24)));
    const remainYears = (remainDays / 365).toFixed(2);
    
    // CBAS è³‡æ–™
    const cbasPremium = parseFloat(cbasData?._premium) || 0; // æ¬Šåˆ©é‡‘(ç™¾å…ƒå ±åƒ¹)
    const cbasOptExpiry = cbasData?._optExpiry || cb._expDate; // é¸æ“‡æ¬Šåˆ°æœŸæ—¥
    const cbasRemainYears = parseFloat(cbasData?._remainYears) || parseFloat(remainYears);
    // é¸æ“‡æ¬Šåƒ¹å€¼ = CBåƒ¹æ ¼ - 100 (å‚µåˆ¸é¢é¡)
    const optionValue = Math.max(0, cbPriceVal - 100);
    // CBASäº¤å‰²é‡‘é¡ = (æ¬Šåˆ©é‡‘ + é¸æ“‡æ¬Šåƒ¹å€¼) Ã— 1000
    const cbasSettlement = (cbasPremium + optionValue) * 1000;
    
    // ========== æƒ…å¢ƒåˆ†æ(ä¸€) - ä¸Šæ¼²æƒ…å¢ƒ ==========
    // è¨ˆç®—ä¸åŒæ¼²å¹…ä¸‹çš„é æœŸåƒ¹æ ¼
    const calcUpScenario = (pct) => {
        const targetPrice = stockCostCalc * (1 + pct/100);
        const cbReturn = pct; // è¶…éè½‰æ›åƒ¹å¾Œï¼ŒCBå ±é…¬ç‡èˆ‡è‚¡ç¥¨åŒæ­¥
        const cbTargetPrice = cbPriceVal * (1 + cbReturn/100);
        return { stockPrice: targetPrice, cbPrice: cbTargetPrice, returnPct: pct };
    };
    const up20 = calcUpScenario(20);
    const up50 = calcUpScenario(50);
    const up100 = calcUpScenario(100);
    
    let tScenario1 = `
        <div class="modal-info-block" style="background:linear-gradient(135deg, #1565c0 0%, #1976d2 100%);color:#fff;padding:20px;border-radius:12px">
            <div style="text-align:center;margin-bottom:15px">
                <div style="font-size:14px;opacity:0.8">${cb._name}</div>
                <div style="font-size:24px;font-weight:800;margin:5px 0">æƒ…å¢ƒåˆ†æ(ä¸€) ä¸Šæ¼²æƒ…å¢ƒ</div>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:#e3f2fd;border:1px solid #90caf9;margin-top:15px">
            <div style="font-size:14px;font-weight:600;color:#1565c0;margin-bottom:12px">ğŸ“ˆ å¦‚æœè²·é€²</div>
            <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;font-size:13px">
                <span style="background:#fff;padding:6px 12px;border-radius:6px">æº¢åƒ¹ç‡ <b style="color:#e74c3c">${fmtNum(premiumRateCalc, 2)}%</b></span>
                <span>çš„å¯è½‰å‚µ</span>
                <span style="background:#fff3e0;padding:6px 12px;border-radius:6px;font-weight:700;color:#e65100">${fmtNum(cbPriceVal, 1)} å…ƒ</span>
                <span>ç­‰æ–¼ç¥¨é¢æŒè‚¡æˆæœ¬</span>
                <span style="background:#fff;padding:6px 12px;border-radius:6px"><b>${fmtNum(convPriceVal, 1)}</b> å…ƒ</span>
                <span>æœƒè®Šæˆäº†</span>
                <span style="background:#ffeb3b;padding:6px 12px;border-radius:6px;font-weight:700">${fmtNum(stockCostCalc, 1)} å…ƒ</span>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:#f5f5f5;margin-top:12px">
            <div style="font-size:13px;color:#666">
                ğŸ’¡ è²·é€²å¯è½‰å‚µçš„äº¤å‰²æ–¹å¼èˆ‡ä¸€èˆ¬è²·è³£è‚¡ç¥¨ä¸€æ¨£ï¼ŒT+2å…¨é¡äº¤å‰²ï¼š
                <span style="background:#fff;padding:4px 8px;border-radius:4px;margin:0 4px">${fmtNum(cbPriceVal, 1)} å…ƒ</span> Ã—
                <span style="background:#fff;padding:4px 8px;border-radius:4px;margin:0 4px">1,000 è‚¡</span> =
                <span style="background:#e8f5e9;padding:4px 8px;border-radius:4px;font-weight:600">äº¤å‰² ${fmtNum(settlementAmt, 0)} å…ƒ</span>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:#e8f5e9;border:1px solid #a5d6a7;margin-top:15px">
            <div style="font-size:14px;font-weight:600;color:#2e7d32;margin-bottom:10px">ğŸ“Š ç²åˆ©æƒ…å¢ƒåˆ†æ</div>
            <div style="font-size:12px;color:#666;margin-bottom:12px">ç•¶ç¾è‚¡æ”¶ç›¤åƒ¹æ ¼è¶…éè½‰æ›åƒ¹æ ¼ <b>${fmtNum(convPriceVal, 1)}</b> å…ƒï¼Œå¯è½‰å‚µèˆ‡ç¾è‚¡è‚¡åƒ¹å°‡æœƒåŒæ­¥ï¼Œå…·æœ‰<span style="color:#2e7d32;font-weight:600">è‚¡ç¥¨ç‰¹æ€§</span></div>
            <table style="width:100%;border-collapse:collapse;font-size:12px;background:#fff;border-radius:8px;overflow:hidden">
                <thead>
                    <tr style="background:#2e7d32;color:#fff">
                        <th style="padding:10px;text-align:center">æƒ…å¢ƒ</th>
                        <th style="padding:10px;text-align:right">é æœŸè‚¡åƒ¹</th>
                        <th style="padding:10px;text-align:right">å¯è½‰å‚µåƒ¹æ ¼</th>
                        <th style="padding:10px;text-align:right">å¯è½‰å‚µå ±é…¬%</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td style="padding:10px;text-align:center;background:#f1f8e9">é è¨ˆä¸Šæ¼² 20%</td><td style="padding:10px;text-align:right">${fmtNum(up20.stockPrice, 1)} å…ƒ</td><td style="padding:10px;text-align:right">${fmtNum(up20.cbPrice, 1)} å…ƒ</td><td style="padding:10px;text-align:right;color:#2e7d32;font-weight:600">+${fmtNum(up20.returnPct, 2)}%</td></tr>
                    <tr style="background:#f5f5f5"><td style="padding:10px;text-align:center;background:#c8e6c9">é è¨ˆä¸Šæ¼² 50%</td><td style="padding:10px;text-align:right">${fmtNum(up50.stockPrice, 1)} å…ƒ</td><td style="padding:10px;text-align:right">${fmtNum(up50.cbPrice, 1)} å…ƒ</td><td style="padding:10px;text-align:right;color:#2e7d32;font-weight:600">+${fmtNum(up50.returnPct, 2)}%</td></tr>
                    <tr><td style="padding:10px;text-align:center;background:#a5d6a7">é è¨ˆä¸Šæ¼² 100%</td><td style="padding:10px;text-align:right">${fmtNum(up100.stockPrice, 1)} å…ƒ</td><td style="padding:10px;text-align:right">${fmtNum(up100.cbPrice, 1)} å…ƒ</td><td style="padding:10px;text-align:right;color:#2e7d32;font-weight:600">+${fmtNum(up100.returnPct, 2)}%</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="modal-info-block" style="background:linear-gradient(90deg, #4caf50, #81c784);color:#fff;margin-top:15px;padding:15px;border-radius:8px">
            <div style="font-size:14px;font-weight:700">ğŸ“Œ çµè«–</div>
            <div style="font-size:13px;margin-top:8px;line-height:1.8">
                ç•¶è‚¡åƒ¹è¶…éè½‰æ›åƒ¹ï¼Œå¯è½‰å‚µå°‡æœƒç™¼æ®<b>è‚¡ç¥¨çš„ç‰¹æ€§</b>ï¼Œæ¼²è¶Šå¤šç²åˆ©è¶Šå¤šã€‚
            </div>
        </div>
    `;
    
    // ========== æƒ…å¢ƒåˆ†æ(äºŒ) - ä¸‹è·Œæƒ…å¢ƒ ==========
    // ä¸‹è·Œæ™‚CBæœ€å¤šè·Œåˆ°åˆ°æœŸé‚„æœ¬åƒ¹(ç´„100å…ƒ)
    const calcDownScenario = (pct) => {
        const targetPrice = stockCostCalc * (1 - pct/100);
        const cbFloor = maturityPrice; // CBåƒ¹æ ¼åº•éƒ¨ç‚ºåˆ°æœŸé‚„æœ¬åƒ¹
        const cbLoss = (cbPriceVal - cbFloor) / cbPriceVal * 100;
        return { stockPrice: targetPrice, cbPrice: cbFloor, returnPct: -cbLoss };
    };
    const down20 = calcDownScenario(20);
    const down40 = calcDownScenario(40);
    const down80 = calcDownScenario(80);
    const maxLossDisplay = Math.max(0, maxLoss);
    
    let tScenario2 = `
        <div class="modal-info-block" style="background:linear-gradient(135deg, #c62828 0%, #d32f2f 100%);color:#fff;padding:20px;border-radius:12px">
            <div style="text-align:center;margin-bottom:15px">
                <div style="font-size:14px;opacity:0.8">${cb._name}</div>
                <div style="font-size:24px;font-weight:800;margin:5px 0">æƒ…å¢ƒåˆ†æ(äºŒ) ä¸‹è·Œæƒ…å¢ƒ</div>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:#ffebee;border:1px solid #ef9a9a;margin-top:15px">
            <div style="font-size:14px;font-weight:600;color:#c62828;margin-bottom:10px">ğŸ“‰ è™§ææƒ…å¢ƒåˆ†æ</div>
            <div style="font-size:12px;color:#666;margin-bottom:12px">ç•¶ç¾è‚¡æ”¶ç›¤åƒ¹æ ¼ä½æ–¼è½‰æ›åƒ¹æ ¼ <b>${fmtNum(convPriceVal, 1)}</b> å…ƒï¼Œå¯è½‰å‚µèˆ‡ç¾è‚¡è‚¡åƒ¹å°‡<b>ä¸æœƒåŒæ­¥</b>ï¼Œå…·æœ‰<span style="color:#1565c0;font-weight:600">å‚µåˆ¸ç‰¹æ€§</span></div>
            <table style="width:100%;border-collapse:collapse;font-size:12px;background:#fff;border-radius:8px;overflow:hidden">
                <thead>
                    <tr style="background:#c62828;color:#fff">
                        <th style="padding:10px;text-align:center">æƒ…å¢ƒ</th>
                        <th style="padding:10px;text-align:right">é æœŸè‚¡åƒ¹</th>
                        <th style="padding:10px;text-align:right">å¯è½‰å‚µåƒ¹æ ¼</th>
                        <th style="padding:10px;text-align:right">å¯è½‰å‚µå ±é…¬%</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td style="padding:10px;text-align:center;background:#ffcdd2">é è¨ˆä¸‹è·Œ 20%</td><td style="padding:10px;text-align:right">${fmtNum(down20.stockPrice, 1)} å…ƒ</td><td style="padding:10px;text-align:right">${fmtNum(down20.cbPrice, 1)} å…ƒ</td><td style="padding:10px;text-align:right;color:#c62828;font-weight:600">${fmtNum(down20.returnPct, 2)}%</td></tr>
                    <tr style="background:#f5f5f5"><td style="padding:10px;text-align:center;background:#ef9a9a">é è¨ˆä¸‹è·Œ 40%</td><td style="padding:10px;text-align:right">${fmtNum(down40.stockPrice, 1)} å…ƒ</td><td style="padding:10px;text-align:right">${fmtNum(down40.cbPrice, 1)} å…ƒ</td><td style="padding:10px;text-align:right;color:#c62828;font-weight:600">${fmtNum(down40.returnPct, 2)}%</td></tr>
                    <tr><td style="padding:10px;text-align:center;background:#e57373">é è¨ˆä¸‹è·Œ 80%</td><td style="padding:10px;text-align:right">${fmtNum(down80.stockPrice, 1)} å…ƒ</td><td style="padding:10px;text-align:right">${fmtNum(down80.cbPrice, 1)} å…ƒ</td><td style="padding:10px;text-align:right;color:#c62828;font-weight:600">${fmtNum(down80.returnPct, 2)}%</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="modal-info-block" style="background:#e3f2fd;border:1px solid #90caf9;margin-top:15px">
            <div style="font-size:14px;font-weight:600;color:#1565c0;margin-bottom:10px">ğŸ’¡ å‚µåˆ¸ä¿è­·ç‰¹æ€§</div>
            <div style="font-size:13px;color:#444;line-height:1.8">
                åœ¨å…¬å¸æ²’æœ‰å€’é–‰çš„å‰æä¸‹ï¼Œç•¶è‚¡åƒ¹è·Œç ´è½‰æ›åƒ¹æ™‚ï¼Œå¯è½‰å‚µå°±æœƒå……åˆ†çš„ç™¼æ®<b>å‚µåˆ¸åˆ°æœŸé‚„æœ¬ç‰¹æ€§</b>ï¼Œå°‡æœ¬é‡‘é‚„çµ¦å‚µæ¬Šäººã€‚<br>
                <span style="color:#666">â€¢ ç„¡æ“”ä¿æ™‚ï¼šç‚ºç¬¬ä¸€é †ä½æ±‚å„Ÿäºº</span><br>
                <span style="color:#666">â€¢ æœ‰æ“”ä¿æ™‚ï¼šæœ‰å…¬å¸å¯¦é«”è³‡ç”¢ç•¶åšæŠµæŠ¼æ“”ä¿</span>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:#fff3e0;border:2px solid #ffb74d;margin-top:15px">
            <div style="font-size:14px;font-weight:700;color:#e65100;margin-bottom:10px">âš ï¸ é¢¨éšªæ§åˆ¶</div>
            <div style="font-size:15px;color:#333;line-height:1.8">
                åœ¨æœ€å¤šæå¤± <span style="font-size:20px;font-weight:800;color:#c62828">${fmtNum(maxLossDisplay, 0)}</span> å…ƒçš„æƒ…æ³ä¸‹......<br>
                <span style="color:#666;font-size:13px">(æŠŠé¢¨éšªæ§åˆ¶åœ¨å¯ä»¥æ¥å—çš„ç¯„åœå…§ï¼Œå…ˆæ±‚å°‘è¼¸)</span>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:linear-gradient(90deg, #1565c0, #42a5f5);color:#fff;margin-top:15px;padding:15px;border-radius:8px">
            <div style="font-size:14px;font-weight:700">ğŸ“Œ çµè«–</div>
            <div style="font-size:13px;margin-top:8px;line-height:1.8">
                ~å†è²·ä¸€å€‹æœªä¾†è‚¡åƒ¹ä¸Šæ¼²çš„å¤¢æƒ³ï¼Œåªè¦æœªä¾†çš„<br>
                <span style="font-size:18px;font-weight:700">${fmtNum(remainDays, 0)} å¤© / ${remainYears} å¹´</span>å…§
                è‚¡åƒ¹å¤§æ–¼ <span style="font-size:18px;font-weight:700">${fmtNum(convPriceVal, 1)}</span> å…ƒ
            </div>
        </div>
    `;
    
    // ========== æƒ…å¢ƒåˆ†æ(ä¸‰) - CBASæ‹†è§£ ==========
    let tScenario3 = '';
    
    if(cbasData || cbasPremium > 0) {
        tScenario3 = `
        <div class="modal-info-block" style="background:linear-gradient(135deg, #6a1b9a 0%, #8e24aa 100%);color:#fff;padding:20px;border-radius:12px">
            <div style="text-align:center;margin-bottom:15px">
                <div style="font-size:14px;opacity:0.8">${cb._name}</div>
                <div style="font-size:24px;font-weight:800;margin:5px 0">æƒ…å¢ƒåˆ†æ(ä¸‰) CBASæ‹†è§£</div>
                <div style="font-size:13px;opacity:0.8">é€éæ‹†è§£è²·é€²å¯è½‰å‚µé¸æ“‡æ¬Š CBAS 1å¼µ</div>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:#f3e5f5;border:1px solid #ce93d8;margin-top:15px">
            <div style="font-size:14px;font-weight:600;color:#6a1b9a;margin-bottom:12px">ğŸ“ˆ å¦‚æœè²·é€²</div>
            <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;font-size:13px">
                <span style="background:#fff;padding:6px 12px;border-radius:6px">æŠ˜åƒ¹ç‡ <b style="color:#6a1b9a">${fmtNum(Math.abs(premiumRateCalc), 2)}%</b></span>
                <span>çš„å¯è½‰å‚µ</span>
                <span style="background:#fff3e0;padding:6px 12px;border-radius:6px;font-weight:700;color:#e65100">${fmtNum(cbPriceVal, 1)} å…ƒ</span>
                <span>ç­‰æ–¼ç¥¨é¢æŒè‚¡æˆæœ¬</span>
                <span style="background:#fff;padding:6px 12px;border-radius:6px"><b>${fmtNum(convPriceVal, 1)}</b> å…ƒ</span>
                <span>æœƒè®Šæˆäº†</span>
                <span style="background:#ffeb3b;padding:6px 12px;border-radius:6px;font-weight:700">${fmtNum(stockCostCalc, 1)} å…ƒ</span>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:#e8f5e9;border:1px solid #a5d6a7;margin-top:12px">
            <div style="font-size:13px;color:#2e7d32;line-height:1.8">
                ğŸ’¡ é¦–å…ˆæœƒå…ˆå°‡å¯è½‰å‚µæˆäº¤åƒ¹æ‹†è§£æˆ <b>å‚µåˆ¸ + é¸æ“‡æ¬Š</b>ï¼š<br>
                <div style="display:flex;align-items:center;gap:8px;margin-top:8px;flex-wrap:wrap">
                    <span style="background:#fff;padding:6px 12px;border-radius:6px;font-weight:700">${fmtNum(cbPriceVal, 1)} å…ƒ</span>
                    <span>=</span>
                    <span style="background:#e3f2fd;padding:6px 12px;border-radius:6px">å‚µåˆ¸ <b>100</b> å…ƒ</span>
                    <span>+</span>
                    <span style="background:#fff3e0;padding:6px 12px;border-radius:6px">é¸æ“‡æ¬Š <b>${fmtNum(optionValue, 1)}</b> å…ƒ</span>
                </div>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:#f5f5f5;margin-top:15px">
            <div style="font-size:14px;font-weight:600;color:#333;margin-bottom:10px">ğŸ“š æ‹†è§£èªªæ˜</div>
            <div style="font-size:13px;color:#555;line-height:1.8">
                æœƒæ‹†è§£çš„ä¸»è¦ç”¨æ„åœ¨æ–¼ï¼Œ<b style="color:#6a1b9a">ç©æ¥µçœ‹å¥½çš„å®¢æˆ¶åªæƒ³åƒèˆ‡è‚¡ç¥¨ä¸Šæ¼²æ©Ÿæœƒ</b>ï¼Œæ‰€ä»¥æœƒé¸æ“‡åªä»˜å‡ºæ¬Šåˆ©é‡‘ï¼ŒåªæŒæœ‰è‚¡ç¥¨ä¸Šæ¼²é¸æ“‡æ¬Šéƒ¨ä½ã€‚<br><br>
                è€Œå‚µåˆ¸æœ¬é‡‘å°‡ç”±åˆ¸å•†å°‹æ‰¾é¡˜æ„æä¾›å‚µåˆ¸æœ¬é‡‘ç•¶å–å¾—ç©©ç•¶åˆ©æ¯çš„å®¢æˆ¶é€²è¡Œæ‹†è§£äº¤å‰²ã€‚å¯¦å‹™ä¸Šä»¥æŠ˜ç¾ç‡è¨ˆç®—å‡ºæ¬Šåˆ©é‡‘ç™¾å…ƒå ±åƒ¹ï¼Œç°¡å–®èªªå°±æ˜¯<b>æŒæœ‰åˆ°å¯è½‰å‚µé¸æ“‡æ¬Šåˆ°æœŸæ—¥çš„åˆ©æ¯æˆæœ¬</b>ã€‚
            </div>
        </div>
        
        <div class="modal-info-block" style="background:#fff;border:2px solid #6a1b9a;margin-top:15px">
            <table style="width:100%;border-collapse:collapse;font-size:13px">
                <tr style="background:#f3e5f5">
                    <td style="padding:12px;font-weight:600">${cb._name}</td>
                    <td style="padding:12px;text-align:center">æ¬Šåˆ©é‡‘(ä½°å…ƒå ±åƒ¹)</td>
                    <td style="padding:12px;text-align:center;font-weight:700;color:#6a1b9a">${fmtNum(cbasPremium, 2)} å…ƒ</td>
                    <td style="padding:12px;text-align:center">é¸æ“‡æ¬Šåˆ°æœŸæ—¥</td>
                    <td style="padding:12px;text-align:center">${fmtDate(cbasOptExpiry)}</td>
                    <td style="padding:12px;text-align:center">å‰©é¤˜å¹´æœŸ</td>
                    <td style="padding:12px;text-align:center;font-weight:600">${fmtNum(cbasRemainYears, 2)} å¹´</td>
                </tr>
            </table>
        </div>
        
        <div class="modal-info-block" style="background:#e8f5e9;margin-top:12px">
            <div style="font-size:13px;color:#2e7d32">
                ğŸ’° è²·é€²1å¼µ <b>${cb._name}</b> å¯è½‰å‚µé¸æ“‡æ¬Šçš„äº¤å‰²é‡‘é¡è¨ˆç®— = æ¬Šåˆ©é‡‘(åˆ©æ¯) <b>${fmtNum(cbasPremium, 2)}</b> å…ƒ + é¸æ“‡æ¬Š <b>${fmtNum(optionValue, 1)}</b> å…ƒ
            </div>
        </div>
        
        <div class="modal-info-block" style="background:#f5f5f5;margin-top:12px">
            <div style="font-size:13px;color:#666">
                ğŸ“‹ äº¤å‰²é‡‘é¡ï¼š
                <span style="background:#fff;padding:4px 8px;border-radius:4px;margin:0 4px">${fmtNum(cbasPremium + optionValue, 2)} å…ƒ</span> Ã—
                <span style="background:#fff;padding:4px 8px;border-radius:4px;margin:0 4px">1,000 è‚¡</span> =
                <span style="background:#ffeb3b;padding:4px 8px;border-radius:4px;font-weight:600">äº¤å‰² ${fmtNum(cbasSettlement, 0)} å…ƒ</span>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:#fff3e0;border:2px solid #ffb74d;margin-top:15px">
            <div style="font-size:14px;font-weight:700;color:#e65100;margin-bottom:10px">âš ï¸ é¢¨éšªæ§åˆ¶</div>
            <div style="font-size:15px;color:#333;line-height:1.8">
                åœ¨æœ€å¤šæå¤± <span style="font-size:20px;font-weight:800;color:#c62828">${fmtNum(cbasSettlement, 0)}</span> å…ƒçš„æƒ…æ³ä¸‹......<br>
                <span style="color:#666;font-size:13px">(æŠŠé¢¨éšªæ§åˆ¶åœ¨å¯ä»¥æ¥å—çš„ç¯„åœå…§ï¼Œå…ˆæ±‚å°‘è¼¸)</span>
            </div>
        </div>
        
        <div class="modal-info-block" style="background:linear-gradient(90deg, #6a1b9a, #ab47bc);color:#fff;margin-top:15px;padding:15px;border-radius:8px">
            <div style="font-size:14px;font-weight:700">ğŸ“Œ çµè«–</div>
            <div style="font-size:13px;margin-top:8px;line-height:1.8">
                ~å†è²·ä¸€å€‹æœªä¾†è‚¡åƒ¹ä¸Šæ¼²çš„å¤¢æƒ³ï¼Œåªè¦æœªä¾†çš„<br>
                <span style="font-size:18px;font-weight:700">${fmtNum(remainDays, 0)} å¤© / ${remainYears} å¹´</span>å…§
                è‚¡åƒ¹å¤§æ–¼ <span style="font-size:18px;font-weight:700">${fmtNum(convPriceVal, 1)}</span> å…ƒ
            </div>
        </div>
        `;
    } else {
        tScenario3 = `
            <div class="modal-info-block" style="background:#f5f5f5;text-align:center;padding:40px">
                <div style="font-size:48px;margin-bottom:15px">ğŸ”’</div>
                <div style="font-size:16px;font-weight:600;color:#666;margin-bottom:10px">æš«ç„¡ CBAS è³‡è¨Š</div>
                <div style="font-size:13px;color:#999">
                    æ­¤CBç›®å‰æ²’æœ‰ CBAS æ‹†è§£å ±åƒ¹è³‡è¨Šï¼Œ<br>
                    å¯èƒ½å°šæœªé–‹æ”¾æ‹†è§£äº¤æ˜“æˆ–å·²ä¸‹å¸‚ã€‚
                </div>
            </div>
        `;
    }

    // ========== ç«¶æ‹æ˜ç´°æ¨™ç±¤é  ==========
    const auctionData = DB.auctionDetail[cbCode];
    // å¾ cbAuction å–å¾—é¡å¤–çš„ç«¶æ‹è³‡æ–™ï¼ˆæˆªæ¨™åƒ¹ã€ç†è«–åƒ¹ã€åº•æ¨™åƒ¹ã€æ›ç‰Œé«˜ä½ç­‰ï¼‰
    const cbAuctionData = DB.cbAuction.find(a => a._cbCode === cbCode) || {};
    let tAuction = '';
    
    if(auctionData) {
        const { basic, price, cost, stats, corpStats, top10, intervals, details } = auctionData;
        
        // å¾ cbAuction å–å¾—æˆªæ¨™èˆ‡æ›ç‰Œè³‡æ–™
        const closePrice = parseFloat(cbAuctionData['æˆªæ¨™æ”¶ç›¤']) || 0;  // æˆªæ¨™æ—¥è‚¡åƒ¹
        const convPrice = parseFloat(cbAuctionData['è½‰æ›åƒ¹']) || parseFloat(cb._convPrice) || 0;  // è½‰æ›åƒ¹
        const theoryPrice = parseFloat(cbAuctionData['æˆªæ¨™ç†è«–']) || 0;  // ç†è«–åƒ¹
        const basePrice = parseFloat(cbAuctionData['åº•æ¨™åƒ¹']) || 0;  // åº•æ¨™åƒ¹
        const lowPremium = parseFloat(cbAuctionData['æœ€ä½æº¢åƒ¹']) || 0;  // æœ€ä½æº¢åƒ¹
        const avgPremium = parseFloat(cbAuctionData['å¹³å‡æº¢åƒ¹']) || 0;  // å¹³å‡æº¢åƒ¹
        const listHigh = parseFloat(cbAuctionData._high) || 0;  // æ›ç‰Œæœ€é«˜
        const listLow = parseFloat(cbAuctionData._low) || 0;  // æ›ç‰Œæœ€ä½
        const latestPrice = parseFloat(cbAuctionData._latestPrice) || 0;  // æœ€æ–°åƒ¹
        const convRatio = convPrice > 0 ? Math.round(100000 / convPrice) : 0;  // è½‰æ›æ¯”ç‡
        
        // è¨ˆç®—æç›Šï¼ˆå°ç£ï¼šç´…è‰²=è³ºã€ç¶ è‰²=è³ ï¼‰
        const lowBid = price['æœ€ä½å¾—æ¨™'] || 0;
        const avgBid = price['åŠ æ¬Šå¹³å‡'] || 0;
        const lowVsListLow = listLow > 0 && lowBid > 0 ? (listLow - lowBid) : null;
        const avgVsListLow = listLow > 0 && avgBid > 0 ? (listLow - avgBid) : null;
        
        // è¨ˆç®—30å¼µä»¥ä¸Šå’Œ100å¼µä»¥ä¸Šçš„ç±Œç¢¼é›†ä¸­åº¦
        const over30 = details.filter(d => d.qty >= 30);
        const over100 = details.filter(d => d.qty >= 100);
        // ç”¨æ˜ç´°çš„ç¸½å¼µæ•¸ä½œç‚ºåˆ†æ¯ï¼Œç¢ºä¿ä½”æ¯”ä¸æœƒè¶…é100%
        const totalQty = details.reduce((s, d) => s + (d.qty || 0), 0);
        const over30Qty = over30.reduce((s, d) => s + d.qty, 0);
        const over100Qty = over100.reduce((s, d) => s + d.qty, 0);
        const over30Ratio = totalQty > 0 ? (over30Qty / totalQty * 100) : 0;
        const over100Ratio = totalQty > 0 ? (over100Qty / totalQty * 100) : 0;
        
        // æ³•äººçµ±è¨ˆå€å¡Šï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        const corpHtml = corpStats ? `
            <div class="modal-info-block" style="background:linear-gradient(135deg, #fce4ec 0%, #fff 100%);margin-top:15px">
                <div class="title" style="color:#c2185b">ğŸ›ï¸ æ³•äººæŠ•æ¨™çµ±è¨ˆ</div>
                <div class="modal-card-grid" style="grid-template-columns:repeat(2, 1fr)">
                    <div class="modal-card">
                        <div class="val" style="font-weight:700">${fmtNum(corpStats['æ³•äººæŠ•æ¨™ç­†æ•¸'], 0)}</div>
                        <div class="lbl" style="font-weight:500">æ³•äººæŠ•æ¨™ç­†æ•¸</div>
                    </div>
                    <div class="modal-card">
                        <div class="val" style="font-weight:700">${fmtNum(corpStats['æ³•äººæŠ•æ¨™æ•¸é‡'], 0)}</div>
                        <div class="lbl" style="font-weight:500">æ³•äººæŠ•æ¨™æ•¸é‡</div>
                    </div>
                </div>
                <div class="modal-card-grid" style="grid-template-columns:repeat(2, 1fr);margin-top:10px">
                    <div class="modal-card">
                        <div class="val" style="font-weight:700;color:#c2185b">${fmtNum(corpStats['æ³•äººå¾—æ¨™ç­†æ•¸'], 0)}</div>
                        <div class="lbl" style="font-weight:500">æ³•äººå¾—æ¨™ç­†æ•¸</div>
                    </div>
                    <div class="modal-card">
                        <div class="val" style="font-weight:700;color:#c2185b">${fmtNum(corpStats['æ³•äººå¾—æ¨™æ•¸é‡'], 0)}</div>
                        <div class="lbl" style="font-weight:500">æ³•äººå¾—æ¨™æ•¸é‡</div>
                    </div>
                </div>
                ${totalQty > 0 && corpStats['æ³•äººå¾—æ¨™æ•¸é‡'] ? `
                <div style="text-align:center;margin-top:10px;padding:8px;background:#fce4ec;border-radius:8px">
                    <span style="font-size:13px;color:#c2185b;font-weight:600">æ³•äººä½”æ¯”ï¼š${fmtNum(corpStats['æ³•äººå¾—æ¨™æ•¸é‡'] / totalQty * 100, 1)}%</span>
                </div>` : ''}
            </div>
        ` : '';
        
        tAuction = `
            <div class="modal-info-block" style="background:linear-gradient(135deg, #e65100 0%, #ff8f00 100%);color:#fff;padding:20px;border-radius:12px">
                <div style="text-align:center">
                    <div style="font-size:14px;opacity:0.9;font-weight:500">${basic['æ¨™çš„åç¨±'] || cb._name}</div>
                    <div style="font-size:24px;font-weight:800;margin:5px 0">ğŸ”¨ ç«¶æ‹æ˜ç´°åˆ†æ</div>
                    <div style="font-size:13px;opacity:0.9;font-weight:500">é–‹æ¨™æ—¥æœŸï¼š${basic['é–‹æ¨™æ—¥æœŸ'] || '-'} ï½œ ä¸»è¾¦ï¼š${basic['ä¸»è¾¦æ‰¿éŠ·å•†'] || '-'}</div>
                </div>
            </div>
            
            <div class="modal-info-block" style="margin-top:15px">
                <div class="title" style="font-weight:700">ğŸ“Š å¾—æ¨™åƒ¹æ ¼èˆ‡æ›è‚¡æˆæœ¬</div>
                <div class="modal-card-grid" style="grid-template-columns:repeat(3, 1fr)">
                    <div class="modal-card">
                        <div class="val" style="color:#c62828;font-weight:700">${fmtNum(price['æœ€ä½å¾—æ¨™'], 2)}</div>
                        <div class="lbl" style="font-weight:500">æœ€ä½å¾—æ¨™</div>
                    </div>
                    <div class="modal-card highlight">
                        <div class="val" style="font-weight:700">${fmtNum(price['åŠ æ¬Šå¹³å‡'], 2)}</div>
                        <div class="lbl" style="font-weight:500">åŠ æ¬Šå¹³å‡</div>
                    </div>
                    <div class="modal-card">
                        <div class="val" style="color:#2e7d32;font-weight:700">${fmtNum(price['æœ€é«˜å¾—æ¨™'], 2)}</div>
                        <div class="lbl" style="font-weight:500">æœ€é«˜å¾—æ¨™</div>
                    </div>
                </div>
                <div class="modal-card-grid" style="grid-template-columns:repeat(3, 1fr);margin-top:10px">
                    <div class="modal-card">
                        <div class="val" style="color:#c62828;font-weight:700">${fmtNum(cost['æœ€ä½æ›è‚¡æˆæœ¬'], 2)}</div>
                        <div class="lbl" style="font-weight:500">æœ€ä½æ›è‚¡æˆæœ¬</div>
                    </div>
                    <div class="modal-card">
                        <div class="val" style="font-weight:700">${fmtNum(cost['å¹³å‡æ›è‚¡æˆæœ¬'], 2)}</div>
                        <div class="lbl" style="font-weight:500">å¹³å‡æ›è‚¡æˆæœ¬</div>
                    </div>
                    <div class="modal-card">
                        <div class="val" style="color:#2e7d32;font-weight:700">${fmtNum(cost['æœ€é«˜æ›è‚¡æˆæœ¬'], 2)}</div>
                        <div class="lbl" style="font-weight:500">æœ€é«˜æ›è‚¡æˆæœ¬</div>
                    </div>
                </div>
                <div style="text-align:center;margin-top:10px;padding:8px;background:#fff3e0;border-radius:8px">
                    <span style="font-size:13px;color:#e65100;font-weight:600">æ›è‚¡æº¢åƒ¹ç‡ï¼š${fmtNum(cost['æ›è‚¡æº¢åƒ¹ç‡'], 2)}%</span>
                </div>
            </div>
            
            <div class="modal-info-block" style="background:linear-gradient(135deg, #f3e5f5 0%, #fff 100%);margin-top:15px">
                <div class="title" style="color:#7b1fa2;font-weight:700">ğŸ“Š æˆªæ¨™èˆ‡æ›ç‰Œè¡Œæƒ…å°ç…§</div>
                <div class="modal-card-grid" style="grid-template-columns:repeat(4, 1fr)">
                    <div class="modal-card">
                        <div class="val" style="font-weight:700">${closePrice > 0 ? fmtNum(closePrice, 2) : '-'}</div>
                        <div class="lbl" style="font-weight:500">æˆªæ¨™æ—¥è‚¡åƒ¹</div>
                    </div>
                    <div class="modal-card">
                        <div class="val" style="font-weight:700">${convPrice > 0 ? fmtNum(convPrice, 2) : '-'}</div>
                        <div class="lbl" style="font-weight:500">è½‰æ›åƒ¹</div>
                    </div>
                    <div class="modal-card">
                        <div class="val" style="font-weight:700;color:#7b1fa2">${convRatio > 0 ? fmtNum(convRatio, 0) : '-'}</div>
                        <div class="lbl" style="font-weight:500">è½‰æ›æ¯”ç‡</div>
                    </div>
                    <div class="modal-card">
                        <div class="val" style="font-weight:700">${theoryPrice > 0 ? fmtNum(theoryPrice, 2) : '-'}</div>
                        <div class="lbl" style="font-weight:500">ç†è«–åƒ¹</div>
                    </div>
                </div>
                <div class="modal-card-grid" style="grid-template-columns:repeat(3, 1fr);margin-top:10px">
                    <div class="modal-card">
                        <div class="val" style="font-weight:700">${basePrice > 0 ? fmtNum(basePrice, 2) : '-'}</div>
                        <div class="lbl" style="font-weight:500">åº•æ¨™åƒ¹</div>
                    </div>
                    <div class="modal-card">
                        <div class="val" style="font-weight:700">${lowPremium !== 0 ? fmtNum(lowPremium, 2) : '-'}</div>
                        <div class="lbl" style="font-weight:500">æœ€ä½æº¢åƒ¹</div>
                    </div>
                    <div class="modal-card">
                        <div class="val" style="font-weight:700">${avgPremium !== 0 ? fmtNum(avgPremium, 2) : '-'}</div>
                        <div class="lbl" style="font-weight:500">å¹³å‡æº¢åƒ¹</div>
                    </div>
                </div>
                <div class="modal-card-grid" style="grid-template-columns:repeat(3, 1fr);margin-top:10px">
                    <div class="modal-card" style="background:${listHigh > 0 ? '#fce4ec' : '#fff'}">
                        <div class="val" style="font-weight:700;color:#c62828">${listHigh > 0 ? fmtNum(listHigh, 2) : '-'}</div>
                        <div class="lbl" style="font-weight:500">æ›ç‰Œæœ€é«˜</div>
                    </div>
                    <div class="modal-card" style="background:${listLow > 0 ? '#e8f5e9' : '#fff'}">
                        <div class="val" style="font-weight:700;color:#2e7d32">${listLow > 0 ? fmtNum(listLow, 2) : '-'}</div>
                        <div class="lbl" style="font-weight:500">æ›ç‰Œæœ€ä½</div>
                    </div>
                    <div class="modal-card">
                        <div class="val" style="font-weight:700">${latestPrice > 0 ? fmtNum(latestPrice, 2) : '-'}</div>
                        <div class="lbl" style="font-weight:500">æœ€æ–°æ”¶ç›¤</div>
                    </div>
                </div>
                ${(lowVsListLow !== null || avgVsListLow !== null) ? `
                <div style="margin-top:12px;padding:10px;background:#fff;border-radius:8px;border:1px solid #e0e0e0">
                    <div style="font-size:12px;color:#666;margin-bottom:8px;font-weight:600">ğŸ’° å¾—æ¨™åƒ¹èˆ‡æ›ç‰Œä½åƒ¹å°ç…§</div>
                    <div style="display:flex;gap:15px;justify-content:center">
                        ${lowVsListLow !== null ? `
                        <div style="text-align:center">
                            <div style="font-size:11px;color:#888;font-weight:500">æœ€ä½å¾—æ¨™ vs æ›ç‰Œä½</div>
                            <div style="font-size:16px;font-weight:700;color:${lowVsListLow >= 0 ? '#c62828' : '#2e7d32'}">${lowVsListLow >= 0 ? '+' : ''}${fmtNum(lowVsListLow, 2)}</div>
                        </div>` : ''}
                        ${avgVsListLow !== null ? `
                        <div style="text-align:center">
                            <div style="font-size:11px;color:#888;font-weight:500">å¹³å‡å¾—æ¨™ vs æ›ç‰Œä½</div>
                            <div style="font-size:16px;font-weight:700;color:${avgVsListLow >= 0 ? '#c62828' : '#2e7d32'}">${avgVsListLow >= 0 ? '+' : ''}${fmtNum(avgVsListLow, 2)}</div>
                        </div>` : ''}
                    </div>
                </div>` : ''}
            </div>
            
            <div class="modal-info-block" style="background:linear-gradient(135deg, #e3f2fd 0%, #fff 100%);margin-top:15px">
                <div class="title" style="color:#1565c0;font-weight:700">ğŸ“ˆ æŠ•æ¨™å¾—æ¨™çµ±è¨ˆ</div>
                <div class="modal-card-grid" style="grid-template-columns:repeat(3, 1fr)">
                    <div class="modal-card">
                        <div class="val" style="font-weight:700">${fmtNum(stats['åˆæ ¼æŠ•æ¨™ç­†æ•¸'], 0)}</div>
                        <div class="lbl" style="font-weight:500">æŠ•æ¨™ç­†æ•¸</div>
                    </div>
                    <div class="modal-card">
                        <div class="val" style="font-weight:700">${fmtNum(stats['å¾—æ¨™ç­†æ•¸'], 0)}</div>
                        <div class="lbl" style="font-weight:500">å¾—æ¨™ç­†æ•¸</div>
                    </div>
                    <div class="modal-card highlight">
                        <div class="val" style="color:#e65100;font-weight:700">${fmtNum(stats['æŠ•æ¨™å¾—æ¨™å€æ•¸'], 2)}x</div>
                        <div class="lbl" style="font-weight:500">æŠ•æ¨™å€æ•¸</div>
                    </div>
                </div>
                <div class="modal-card-grid" style="grid-template-columns:repeat(3, 1fr);margin-top:10px">
                    <div class="modal-card">
                        <div class="val" style="font-weight:700">${fmtNum(stats['æŠ•æ¨™æ•¸é‡'], 0)}</div>
                        <div class="lbl" style="font-weight:500">æŠ•æ¨™å¼µæ•¸</div>
                    </div>
                    <div class="modal-card">
                        <div class="val" style="font-weight:700">${fmtNum(stats['å¾—æ¨™æ•¸é‡'], 0)}</div>
                        <div class="lbl" style="font-weight:500">å¾—æ¨™å¼µæ•¸</div>
                    </div>
                    <div class="modal-card">
                        <div class="val" style="font-weight:700">${fmtNum(stats['å¾—æ¨™å‡å¼µ'], 1)}</div>
                        <div class="lbl" style="font-weight:500">å¾—æ¨™å‡å¼µ</div>
                    </div>
                </div>
            </div>
            
            ${corpHtml}
            
            <div class="modal-info-block" style="background:linear-gradient(135deg, #fff8e1 0%, #fff 100%);margin-top:15px">
                <div class="title" style="color:#f57c00;font-weight:700">ğŸ¯ ä¸»åŠ›ç±Œç¢¼é›†ä¸­åº¦</div>
                <div class="modal-card-grid" style="grid-template-columns:repeat(2, 1fr)">
                    <div class="modal-card" style="background:${over30Ratio >= 50 ? '#fff3e0' : '#fff'}">
                        <div class="val" style="color:${over30Ratio >= 50 ? '#e65100' : '#333'};font-weight:700">${fmtNum(over30Ratio, 1)}%</div>
                        <div class="lbl" style="font-weight:500">30å¼µä»¥ä¸Šä½”æ¯”</div>
                        <div style="font-size:11px;color:#666;margin-top:4px;font-weight:500">${over30.length}ç­† / ${fmtNum(over30Qty, 0)}å¼µ</div>
                    </div>
                    <div class="modal-card" style="background:${over100Ratio >= 30 ? '#ffebee' : '#fff'}">
                        <div class="val" style="color:${over100Ratio >= 30 ? '#c62828' : '#333'};font-weight:700">${fmtNum(over100Ratio, 1)}%</div>
                        <div class="lbl" style="font-weight:500">100å¼µä»¥ä¸Šä½”æ¯”</div>
                        <div style="font-size:11px;color:#666;margin-top:4px;font-weight:500">${over100.length}ç­† / ${fmtNum(over100Qty, 0)}å¼µ</div>
                    </div>
                </div>
            </div>
            
            <div class="modal-info-block" style="margin-top:15px">
                <div class="title" style="font-weight:700">ğŸ“Š å¾—æ¨™å€é–“åˆ†æ</div>
                <div style="overflow-x:auto">
                    <table style="width:100%;border-collapse:collapse;font-size:12px;background:#fff;border-radius:8px;overflow:hidden">
                        <thead>
                            <tr style="background:#f5f5f5">
                                <th style="padding:10px 6px;text-align:left;font-weight:700">å€é–“</th>
                                <th style="padding:10px 6px;text-align:right;font-weight:700">ç­†æ•¸</th>
                                <th style="padding:10px 6px;text-align:right;font-weight:700">æ•¸é‡</th>
                                <th style="padding:10px 6px;text-align:right;font-weight:700">å‡åƒ¹</th>
                                <th style="padding:10px 6px;text-align:right;font-weight:700">æ›è‚¡æˆæœ¬</th>
                                <th style="padding:10px 6px;text-align:right;font-weight:700">ä½”æ¯”</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${intervals.map((inv, idx) => {
                                const isLarge = inv.interval.includes('å¤§æ–¼100') || inv.interval.includes('50-100');
                                const bgColor = inv.interval.includes('å¤§æ–¼100') ? '#fff3e0' : (inv.interval.includes('50-100') ? '#fffde7' : (idx % 2 === 0 ? '#fff' : '#fafafa'));
                                return `<tr style="background:${bgColor}">
                                    <td style="padding:8px 6px;font-weight:${isLarge ? '700' : '500'}">${inv.interval}</td>
                                    <td style="padding:8px 6px;text-align:right;font-weight:500">${fmtNum(inv.count, 0)}</td>
                                    <td style="padding:8px 6px;text-align:right;font-weight:${isLarge ? '700' : '500'}">${fmtNum(inv.qty, 0)}</td>
                                    <td style="padding:8px 6px;text-align:right;font-weight:500">${fmtNum(inv.avgPrice, 2)}</td>
                                    <td style="padding:8px 6px;text-align:right;font-weight:500">${fmtNum(inv.avgCost, 2)}</td>
                                    <td style="padding:8px 6px;text-align:right;color:${isLarge ? '#e65100' : '#333'};font-weight:700">${fmtNum(inv.ratio * 100, 1)}%</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="modal-info-block" style="margin-top:15px">
                <div class="title" style="font-weight:700">ğŸ† å‰åå¤§å¾—æ¨™é‡</div>
                <div style="overflow-x:auto">
                    <table style="width:100%;border-collapse:collapse;font-size:12px;background:#fff;border-radius:8px;overflow:hidden">
                        <thead>
                            <tr style="background:linear-gradient(90deg, #e65100, #ff8f00);color:#fff">
                                <th style="padding:10px 6px;text-align:center;font-weight:700">æ’å</th>
                                <th style="padding:10px 6px;text-align:right;font-weight:700">æ•¸é‡</th>
                                <th style="padding:10px 6px;text-align:right;font-weight:700">åƒ¹æ ¼</th>
                                <th style="padding:10px 6px;text-align:right;font-weight:700">é‡‘é¡</th>
                                <th style="padding:10px 6px;text-align:right;font-weight:700">æ›è‚¡æˆæœ¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${top10.map((t, idx) => `<tr style="background:${idx % 2 === 0 ? '#fff' : '#fff8f0'}">
                                <td style="padding:8px 6px;text-align:center;font-weight:700;color:#e65100">${t.rank}</td>
                                <td style="padding:8px 6px;text-align:right;font-weight:700">${fmtNum(t.qty, 0)}</td>
                                <td style="padding:8px 6px;text-align:right;font-weight:500">${fmtNum(t.price, 2)}</td>
                                <td style="padding:8px 6px;text-align:right;font-weight:500">${fmtNum(t.amount, 0)}</td>
                                <td style="padding:8px 6px;text-align:right;font-weight:500">${fmtNum(t.cost, 2)}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="modal-info-block" style="margin-top:15px">
                <div class="title" style="font-weight:700">ğŸ“‹ å®Œæ•´å¾—æ¨™æ˜ç´° <span style="font-size:12px;color:#888;font-weight:500">(å…±${details.length}ç­†)</span></div>
                <div style="font-size:11px;color:#555;margin-bottom:10px;font-weight:500">
                    <span style="display:inline-block;width:12px;height:12px;background:#fff3e0;border:1px solid #ffcc80;border-radius:2px;vertical-align:middle;margin-right:4px"></span>30å¼µä»¥ä¸Š
                    <span style="display:inline-block;width:12px;height:12px;background:#ffebee;border:1px solid #ef9a9a;border-radius:2px;vertical-align:middle;margin-left:12px;margin-right:4px"></span>100å¼µä»¥ä¸Š
                    <span style="margin-left:15px;color:#999">ğŸ“Œ é»æ“Šè¡¨é ­å¯æ’åº</span>
                </div>
                <div style="overflow-x:auto;max-height:400px;overflow-y:auto">
                    <table style="width:100%;border-collapse:collapse;font-size:11px;background:#fff;border-radius:8px;overflow:hidden">
                        <thead style="position:sticky;top:0;z-index:1">
                            <tr style="background:#f5f5f5">
                                <th class="auction-sort-th" data-field="seq" onclick="sortAuctionDetail('seq')" style="padding:8px 4px;text-align:center;font-weight:700;cursor:pointer;user-select:none">åº<span class="sort-arrow" style="opacity:1"> â†‘</span></th>
                                <th class="auction-sort-th" data-field="price" onclick="sortAuctionDetail('price')" style="padding:8px 4px;text-align:right;font-weight:700;cursor:pointer;user-select:none">åƒ¹æ ¼<span class="sort-arrow" style="opacity:0.4"> â†•</span></th>
                                <th class="auction-sort-th" data-field="qty" onclick="sortAuctionDetail('qty')" style="padding:8px 4px;text-align:right;font-weight:700;cursor:pointer;user-select:none">æ•¸é‡<span class="sort-arrow" style="opacity:0.4"> â†•</span></th>
                                <th class="auction-sort-th" data-field="amount" onclick="sortAuctionDetail('amount')" style="padding:8px 4px;text-align:right;font-weight:700;cursor:pointer;user-select:none">é‡‘é¡<span class="sort-arrow" style="opacity:0.4"> â†•</span></th>
                                <th class="auction-sort-th" data-field="cost" onclick="sortAuctionDetail('cost')" style="padding:8px 4px;text-align:right;font-weight:700;cursor:pointer;user-select:none">æ›è‚¡æˆæœ¬<span class="sort-arrow" style="opacity:0.4"> â†•</span></th>
                                <th style="padding:8px 4px;text-align:left;font-weight:700">å€é–“</th>
                                <th class="auction-sort-th" data-field="cumRatio" onclick="sortAuctionDetail('cumRatio')" style="padding:8px 4px;text-align:right;font-weight:700;cursor:pointer;user-select:none">ç´¯è¨ˆä½”æ¯”<span class="sort-arrow" style="opacity:0.4"> â†•</span></th>
                            </tr>
                        </thead>
                        <tbody id="auction-detail-tbody">
                            ${details.map((d, idx) => {
                                let bgColor = idx % 2 === 0 ? '#fff' : '#fafafa';
                                let fontWeight = '500';
                                if(d.qty >= 100) {
                                    bgColor = '#ffebee';
                                    fontWeight = '700';
                                } else if(d.qty >= 30) {
                                    bgColor = '#fff3e0';
                                    fontWeight = '600';
                                }
                                return `<tr style="background:${bgColor}">
                                    <td style="padding:6px 4px;text-align:center;font-weight:500">${d.seq}</td>
                                    <td style="padding:6px 4px;text-align:right;font-weight:500">${fmtNum(d.price, 2)}</td>
                                    <td style="padding:6px 4px;text-align:right;font-weight:${fontWeight};color:${d.qty >= 100 ? '#c62828' : (d.qty >= 30 ? '#e65100' : '#333')}">${fmtNum(d.qty, 0)}</td>
                                    <td style="padding:6px 4px;text-align:right;font-weight:500">${fmtNum(d.amount, 0)}</td>
                                    <td style="padding:6px 4px;text-align:right;font-weight:500">${fmtNum(d.cost, 2)}</td>
                                    <td style="padding:6px 4px;text-align:left;font-size:10px;font-weight:500">${d.intervalType}</td>
                                    <td style="padding:6px 4px;text-align:right;font-weight:500">${fmtNum(d.cumRatio * 100, 1)}%</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        // å­˜å„²è³‡æ–™ä¾›æ’åºä½¿ç”¨
        AUCTION_DETAIL_DATA = details;
        AUCTION_DETAIL_SORT = { field: 'seq', dir: 'asc' };
    } else {
        tAuction = `
            <div class="modal-info-block" style="background:#f5f5f5;text-align:center;padding:40px">
                <div style="font-size:48px;margin-bottom:15px">ğŸ”¨</div>
                <div style="font-size:16px;font-weight:700;color:#666;margin-bottom:10px">æš«ç„¡ç«¶æ‹æ˜ç´°è³‡æ–™</div>
                <div style="font-size:13px;color:#999;font-weight:500">
                    æ­¤CBç›®å‰æ²’æœ‰ç«¶æ‹æ˜ç´°è³‡æ–™ï¼Œ<br>
                    å¯èƒ½å°šæœªç´å…¥ç«¶æ‹è³‡æ–™åº«æˆ–æ¡ç”¨è©¢åœˆæ–¹å¼ç™¼è¡Œã€‚
                </div>
            </div>
        `;
        AUCTION_DETAIL_DATA = [];
    }

    const navItems = [
        {id:'issue', icon:'ğŸ“', label:'ç™¼è¡Œæ¢ä»¶'},
        {id:'timeline', icon:'ğŸ“…', label:'æ™‚ç¨‹'},
        {id:'putback', icon:'ğŸ’°', label:'è³£å›'},
        {id:'conversion', icon:'ğŸ”„', label:'è½‰æ›åˆ†æ'},
        {id:'value', icon:'ğŸ“Š', label:'åƒ¹å€¼åˆ†æ'},
        {id:'up', icon:'ğŸ“ˆ', label:'ä¸Šæ¼²æƒ…å¢ƒ'},
        {id:'down', icon:'ğŸ“‰', label:'ä¸‹è·Œæƒ…å¢ƒ'},
        {id:'cbas', icon:'ğŸ”€', label:'CBASæ‹†è§£'},
        {id:'auction', icon:'ğŸ”¨', label:'ç«¶æ‹æ˜ç´°'},
        {id:'stock', icon:'ğŸ¢', label:'å…¬å¸'}
    ];

    $('m-body').innerHTML = `
        <div id="tab-issue" class="tab-pane active">${tIssue}</div>
        <div id="tab-timeline" class="tab-pane">${tTimeline}</div>
        <div id="tab-putback" class="tab-pane">${tPutback}</div>
        <div id="tab-conversion" class="tab-pane">${tConversion}</div>
        <div id="tab-value" class="tab-pane">${tValue}</div>
        <div id="tab-up" class="tab-pane">${tScenario1}</div>
        <div id="tab-down" class="tab-pane">${tScenario2}</div>
        <div id="tab-cbas" class="tab-pane">${tScenario3}</div>
        <div id="tab-auction" class="tab-pane">${tAuction}</div>
        <div id="tab-stock" class="tab-pane">${tStock}</div>
    `;
    showModal(infoHtml, navItems);
};

window.openStock = code => {
    if(!code || code==='-') return;
    code = normalizeCode(code);
    const s = DB.stocks[code] || { 'å…¬å¸åç¨±': code, 'ä»£è™Ÿ': code };
    const name = s['å…¬å¸åç¨±'] || code;
    const concepts = META.concepts[code] || [];
    const cbs = META.cbMap[code] || [];
    const memos = META.relatedMemo[code] || [];
    const news = META.relatedNews[code] || [];
    const fin = META.finance[name] || {};
    const prod = META.products[name] || {};
    const track = META.tracking[name] || {};
    const revM = META.revData.month[code] || [];
    const revQ = META.revData.quarter[code] || [];
    const revY = META.revData.year[code] || [];
    const revH = META.revData.highlights[code] || {};

    const infoHtml = `
        <div style="font-size:22px;font-weight:700;margin-bottom:5px">${name} <span style="color:#999;font-size:16px">${code}</span></div>
        <div class="card-meta">
            <span class="tag ind">${s['ç”¢æ¥­åˆ†é¡']||'æœªåˆ†é¡'}</span>
            ${concepts.slice(0,3).map(c=>`<span class="tag concept">#${c.concept}</span>`).join('')}
        </div>
        <div style="font-size:13px;color:#666;margin-top:5px;line-height:1.5">${s['æ¥­å‹™æ‘˜è¦']||''}</div>
    `;

    const navItems = [
        {id:'basic', icon:'ğŸ“Š', label:'ç¸½è¦½'},
        {id:'fin', icon:'ğŸ’°', label:'ç‡Ÿæ”¶'},
        {id:'prod', icon:'ğŸ“¦', label:'ç”¢å“'},
        {id:'rep', icon:'ğŸ“°', label:'å ±å‘Š'},
        {id:'rate', icon:'â­', label:'è©•åƒ¹'}
    ];

    // Tab 1: åŸºæœ¬è³‡æ–™
    let tBasic = `
        <div class="grid-2">
            <div class="stat-box"><div class="num">${s['æˆäº¤']||'-'}</div><div class="lbl">æ”¶ç›¤åƒ¹</div></div>
            <div class="stat-box"><div class="num ${colorClass(s['æ¼²è·Œå¹…'])}">${s['æ¼²è·Œå¹…']||'-'}%</div><div class="lbl">æ¼²è·Œå¹…</div></div>
        </div>
    `;
    if(concepts.length) {
        tBasic += `<div class="section-head">ğŸ’¡ æ¦‚å¿µè‚¡åˆ†é¡</div>`;
        tBasic += concepts.map(c => `<div class="list-item" onclick="setSearch('#${c.concept}');closeModal()"><div class="list-title">#${c.concept}</div><div class="list-sub">${c.sub||''}</div></div>`).join('');
    }
    if(cbs.length) {
        tBasic += `<div class="section-head">ğŸ« å¯è½‰å‚µ (${cbs.length})</div>`;
        tBasic += cbs.map(c => `<div class="hl-block"><b>${c['åç¨±']}</b><br>è½‰åƒ¹: ${c['è½‰æ›åƒ¹æ ¼(å…ƒ)']} | é¤˜é¡: ${c['æœ€æ–°é¤˜é¡(ç™¾è¬)']}M | åˆ°æœŸ: ${fmtDate(c['åˆ°æœŸæ—¥'])}</div>`).join('');
    }

    // Tab 2: ç‡Ÿæ”¶
    let tFin = '';
    
    // Debug info
    console.log('ç‡Ÿæ”¶è³‡æ–™:', code, 'æœˆ:', revM.length, 'å­£:', revQ.length, 'å¹´:', revY.length);
    
    // ç‡Ÿæ”¶äº®é»
    if(revH['å–®æœˆç‡Ÿæ”¶å‰µç´€éŒ„æœˆæ•¸']) {
        tFin += `<div style="margin-bottom:15px"><span class="tag trend-up">ğŸ”¥ æ­·å²æ–°é«˜ ${revH['å–®æœˆç‡Ÿæ”¶å‰µç´€éŒ„æœˆæ•¸']} æ¬¡</span></div>`;
    }
    
    if(revM.length > 0 || revQ.length > 0 || revY.length > 0) {
        // åªå–è¿‘12æœŸ
        const recent12M = revM.slice(0, 12);
        const recent12Q = revQ.slice(0, 12);
        const recent12Y = revY.slice(0, 12);
        
        // è¨ˆç®—æœˆå¢ç‡å’Œå¹´å¢ç‡
        const revWithGrowth = recent12M.map((r, idx) => {
            const prevMonth = revM.find(p => p.month === r.month && p.year === r.year - 1);
            const lastMonth = revM.find(p => {
                if(r.month === 1) return p.year === r.year - 1 && p.month === 12;
                return p.year === r.year && p.month === r.month - 1;
            });
            return {
                ...r,
                yoy: prevMonth ? ((r.rev - prevMonth.rev) / prevMonth.rev * 100) : null,
                mom: lastMonth ? ((r.rev - lastMonth.rev) / lastMonth.rev * 100) : null,
                prevYearRev: prevMonth ? prevMonth.rev : null
            };
        });
        
        // å¹´åº¦æ¯”è¼ƒè¡¨ - å»ºç«‹è³‡æ–™çµæ§‹ï¼ˆåªå–è¿‘4å¹´ï¼‰
        const years = [...new Set(revM.map(r => r.year))].sort((a,b) => b-a).slice(0, 4);
        const monthlyByYear = {};
        years.forEach(y => { monthlyByYear[y] = {}; });
        revM.forEach(r => {
            if(monthlyByYear[r.year]) monthlyByYear[r.year][r.month] = r.rev;
        });
        
        // è¨ˆç®—å¹´åº¦åŠ ç¸½å’Œå¹´å¢ç‡
        const yearTotals = years.map(y => {
            const total = Object.values(monthlyByYear[y] || {}).reduce((a,b) => a+b, 0);
            return { year: y, total };
        });
        const yearGrowth = yearTotals.map((yt, idx) => {
            const prev = yearTotals[idx + 1];
            return { ...yt, yoy: prev ? ((yt.total - prev.total) / prev.total * 100) : null };
        });
        
        tFin += `
            <div class="fin-switcher">
                <div class="fin-btn active" onclick="swFin(0)">æœˆç‡Ÿæ”¶</div>
                <div class="fin-btn" onclick="swFin(1)">å¹´ç‡Ÿæ”¶</div>
            </div>
            
            <div id="ft-0" class="fin-sub-pane active">
                ${revWithGrowth.length > 0 ? `
                <div class="rev-unit">ğŸ’° å–®ä½ï¼šå„„å…ƒ</div>
                <div class="table-wrap"><table class="fin-table">
                    <thead><tr>
                        <th>æœŸåˆ¥</th>
                        <th>ç‡Ÿæ¥­æ”¶å…¥</th>
                        <th>æœˆå¢ç‡</th>
                        <th>å»å¹´åŒæœŸ</th>
                        <th>å¹´å¢ç‡</th>
                    </tr></thead>
                    <tbody>${revWithGrowth.map(r => {
                        const momClass = r.mom > 0 ? '' : (r.mom < 0 ? 't-down' : '');
                        const yoyClass = r.yoy > 0 ? '' : (r.yoy < 0 ? 't-down' : '');
                        return `<tr>
                            <td>${r.d}</td>
                            <td>${fmtNum(r.rev, 1)}</td>
                            <td class="${momClass}">${r.mom !== null ? (r.mom >= 0 ? '+' : '') + fmtNum(r.mom, 2) + '%' : '-'}</td>
                            <td>${r.prevYearRev ? fmtNum(r.prevYearRev, 1) : '-'}</td>
                            <td class="${yoyClass}">${r.yoy !== null ? (r.yoy >= 0 ? '+' : '') + fmtNum(r.yoy, 2) + '%' : '-'}</td>
                        </tr>`;
                    }).join('')}</tbody>
                </table></div>
                ` : '<div style="text-align:center;padding:20px;color:#999">ç„¡æœˆç‡Ÿæ”¶è³‡æ–™</div>'}
            </div>
            
            <div id="ft-1" class="fin-sub-pane">
                ${years.length > 0 ? `
                <div class="rev-unit">ğŸ’° å–®ä½ï¼šå„„å…ƒ</div>
                <div class="table-wrap"><table class="fin-table">
                    <thead><tr>
                        <th>æœŸåˆ¥</th>
                        ${years.map(y => `<th>${y}</th>`).join('')}
                    </tr></thead>
                    <tbody>
                        <tr class="highlight-row">
                            <td>å¹´åº¦åŠ ç¸½</td>
                            ${yearGrowth.map(yg => `<td>${fmtNum(yg.total, 1)}</td>`).join('')}
                        </tr>
                        <tr class="highlight-row">
                            <td>å¹´å¢ç‡</td>
                            ${yearGrowth.map(yg => {
                                const cls = yg.yoy > 0 ? '' : (yg.yoy < 0 ? 't-down' : '');
                                return `<td class="${cls}">${yg.yoy !== null ? (yg.yoy >= 0 ? '+' : '') + fmtNum(yg.yoy, 2) + '%' : '-'}</td>`;
                            }).join('')}
                        </tr>
                        ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `
                            <tr>
                                <td>${m}æœˆ</td>
                                ${years.map(y => `<td>${monthlyByYear[y]?.[m] ? fmtNum(monthlyByYear[y][m], 1) : ''}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table></div>
                ` : '<div style="text-align:center;padding:20px;color:#999">ç„¡å¹´ç‡Ÿæ”¶è³‡æ–™</div>'}
            </div>
        `;
    } else {
        tFin = '<div style="text-align:center;padding:30px;color:#999">ç„¡ç‡Ÿæ”¶è³‡æ–™<br><small>è«‹ç¢ºèª 06_revenue.xlsx å·²æ­£ç¢ºè¼‰å…¥</small></div>';
    }
    
    if(fin['4Q25æŒ‡å¼•']) tFin += `<div class="hl-block" style="margin-top:15px"><b>ğŸ”® æœªä¾†æŒ‡å¼•</b><br>${fmtTxt(fin['4Q25æŒ‡å¼•'])}</div>`;

    // Tab 3: ç”¢å“çµæ§‹
    let tProd = '';
    if(prod['ä¸»è¦ç”¢å“1']) {
        tProd += `<div class="section-head">ğŸ“¦ ç”¢å“çµ„åˆ</div>`;
        [1,2,3].forEach(n => {
            if(prod[`ä¸»è¦ç”¢å“${n}`]) {
                tProd += `<div class="info-row"><span class="info-label">${prod[`ä¸»è¦ç”¢å“${n}`]}</span><span class="info-val">${prod[`ä½”æ¯”/è¡¨ç¾${n}`]||''}</span></div>`;
            }
        });
    }
    if(prod['é—œéµæˆé•·å‹•èƒ½']) tProd += `<div class="hl-block"><b>ğŸš€ æˆé•·å‹•èƒ½</b><br>${fmtTxt(prod['é—œéµæˆé•·å‹•èƒ½'])}</div>`;
    if(prod['2026å±•æœ›']) tProd += `<div class="hl-block"><b>ğŸ”® 2026å±•æœ›</b><br>${fmtTxt(prod['2026å±•æœ›'])}</div>`;
    if(!tProd) tProd = '<div style="text-align:center;padding:30px;color:#999">ç„¡ç”¢å“è³‡æ–™</div>';

    // Tab 4: ç›¸é—œå ±å‘Š
    let tRep = '';
    if(memos.length) {
        tRep += `<div class="section-head">ğŸ“‹ Call Memo (${memos.length})</div>`;
        memos.forEach(m => {
            tRep += `<div class="list-item" onclick="openMemo('${m['ç·¨è™Ÿ']}')">
                <div class="list-title">${m['åˆ¸å•†']} - ${m['å ±å‘Šé¡å‹']}</div>
                <div class="list-sub">${fmtDate(m['æ—¥æœŸ'])} | ${m['é‡è¦æ€§']||''}</div>
            </div>`;
        });
    }
    if(news.length) {
        tRep += `<div class="section-head">âš¡ å¤–é›»å ±å° (${news.length})</div>`;
        news.slice(0,5).forEach(n => {
            tRep += `<div class="list-item" onclick="openNews('${n['ç·¨è™Ÿ']}')">
                <div class="list-title">${n['å ±å°é‡é»åˆ†é¡']}</div>
                <div class="list-sub">${fmtDate(n['æ—¥æœŸ'])}</div>
            </div>`;
        });
    }
    if(!tRep) tRep = '<div style="text-align:center;padding:30px;color:#999">ç„¡ç›¸é—œå ±å‘Š</div>';

    // Tab 5: è©•åƒ¹è©•ç­‰
    let tRate = '';
    if(track['æŠ•è³‡è©•ç­‰']) {
        tRate += `<div class="rating-card"><div class="label">æŠ•è³‡è©•ç­‰</div><div class="big-num">${track['æŠ•è³‡è©•ç­‰']}</div></div>`;
        tRate += `<div class="info-row"><span class="info-label">ç›®æ¨™åƒ¹</span><span class="info-val" style="color:var(--primary);font-size:18px">${track['ç›®æ¨™åƒ¹']||'-'}</span></div>`;
        tRate += `<div class="info-row"><span class="info-label">è¿½è¹¤ç‹€æ…‹</span><span class="info-val">${track['è¿½è¹¤ç‹€æ…‹']||'-'}</span></div>`;
    }
    if(!tRate) tRate = '<div style="text-align:center;padding:30px;color:#999">ç„¡è©•åƒ¹è³‡æ–™</div>';

    $('m-body').innerHTML = `
        <div id="tab-basic" class="tab-pane active">${tBasic}</div>
        <div id="tab-fin" class="tab-pane">${tFin}</div>
        <div id="tab-prod" class="tab-pane">${tProd}</div>
        <div id="tab-rep" class="tab-pane">${tRep}</div>
        <div id="tab-rate" class="tab-pane">${tRate}</div>
    `;
    showModal(infoHtml, navItems);
};

// é–‹å•Ÿ Memo
window.openMemo = id => {
    const m = DB.memo.find(i => String(i['ç·¨è™Ÿ']) === String(id));
    if(!m) return;
    const d = META.memoDetail[id] || {};

    const infoHtml = `
        <div style="font-size:20px;font-weight:700;margin-bottom:5px">${m['å…¬å¸']} <span style="color:#999;font-size:14px">${m['è‚¡è™Ÿ']}</span></div>
        <div class="card-meta">
            <span class="tag brk">${m['åˆ¸å•†']}</span>
            <span class="tag ind">${m['å ±å‘Šé¡å‹']}</span>
            <span class="tag dt">${fmtDate(m['æ—¥æœŸ'])}</span>
        </div>
        <div style="font-size:12px;color:#666;margin-top:5px">åˆ†æå¸«: ${m['åˆ†æå¸«']||'-'} | ${m['é‡è¦æ€§']||''}</div>
    `;

    // 6 å€‹ç¨ç«‹åˆ†é ï¼ˆæ¨™ç±¤ç§»åˆ°åº•éƒ¨å›ºå®šå€ï¼‰
    const navItems = [
        {id:'op', icon:'ğŸ¯', label:'ç‡Ÿé‹é‡é»'},
        {id:'strat', icon:'ğŸš€', label:'ç­–ç•¥æ–¹å‘'},
        {id:'qa', icon:'â“', label:'QAæ‘˜è¦'},
        {id:'rex', icon:'ğŸ‘€', label:'Rexè§€å¯Ÿ'},
        {id:'follow', icon:'ğŸ“Œ', label:'å¾ŒçºŒè¿½è¹¤'},
        {id:'timeline', icon:'ğŸ“…', label:'é—œéµæ™‚ç¨‹'}
    ];

    // Tab 1: ç‡Ÿé‹é‡é»
    const tOp = d['ç‡Ÿé‹é‡é»'] ? `<div class="hl-block">${fmtTxt(d['ç‡Ÿé‹é‡é»'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ç„¡è³‡æ–™</div>';
    
    // Tab 2: ç­–ç•¥æ–¹å‘
    const tStrat = d['ç­–ç•¥æ–¹å‘'] ? `<div class="hl-block">${fmtTxt(d['ç­–ç•¥æ–¹å‘'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ç„¡è³‡æ–™</div>';
    
    // Tab 3: QAæ‘˜è¦
    let tQA = '';
    if(d['é‡è¦QAæ‘˜è¦']) {
        const qaText = safe(d['é‡è¦QAæ‘˜è¦']);
        const lines = qaText.split('\n');
        let currentQ = '', currentA = '';
        lines.forEach(line => {
            if(line.match(/^Q\d*[ï¼š:]/i)) {
                if(currentQ && currentA) {
                    tQA += `<div class="qa-item"><div class="qa-q">${currentQ}</div><div class="qa-a">${currentA}</div></div>`;
                }
                currentQ = line.replace(/^Q\d*[ï¼š:]\s*/i, '');
                currentA = '';
            } else if(line.match(/^A\d*[ï¼š:]/i)) {
                currentA = line.replace(/^A\d*[ï¼š:]\s*/i, '');
            } else if(currentA) {
                currentA += '\n' + line;
            }
        });
        if(currentQ && currentA) {
            tQA += `<div class="qa-item"><div class="qa-q">${currentQ}</div><div class="qa-a">${currentA}</div></div>`;
        }
    }
    if(!tQA) tQA = '<div style="color:#999;text-align:center;padding:20px">ç„¡QAè³‡æ–™</div>';

    // Tab 4: Rexè§€å¯Ÿ
    const tRex = d['Rexè§€å¯Ÿ'] ? `<div class="hl-block">${fmtTxt(d['Rexè§€å¯Ÿ'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ç„¡è§€å¯Ÿè¨˜éŒ„</div>';

    // Tab 5: å¾ŒçºŒè¿½è¹¤
    const tFollow = d['å¾ŒçºŒè¿½è¹¤'] ? `<div class="hl-block">${fmtTxt(d['å¾ŒçºŒè¿½è¹¤'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ç„¡è¿½è¹¤é …ç›®</div>';

    // Tab 6: é—œéµæ™‚ç¨‹
    let tTimeline = '';
    if(d['é—œéµæ™‚ç¨‹']) {
        safe(d['é—œéµæ™‚ç¨‹']).split('\n').filter(l=>l.trim()).forEach(line => {
            const match = line.match(/^\[([^\]]+)\]\s*(.+)/);
            if(match) {
                tTimeline += `<div class="timeline-item"><div class="timeline-date">${match[1]}</div><div class="timeline-text">${match[2]}</div></div>`;
            } else {
                tTimeline += `<div class="timeline-item"><div class="timeline-text">${line}</div></div>`;
            }
        });
    }
    if(!tTimeline) tTimeline = '<div style="color:#999;text-align:center;padding:20px">ç„¡æ™‚ç¨‹è³‡æ–™</div>';

    // åº•éƒ¨å›ºå®šæ¨™ç±¤å€
    let tagsHtml = '';
    if(d['æ¨™ç±¤']) {
        const tags = safe(d['æ¨™ç±¤']).split(/[,ï¼Œ\s]+/).filter(t=>t);
        if(tags.length > 0) {
            tagsHtml = `<div class="tags-wrap">${tags.map(tag => 
                `<span class="tag concept" onclick="setSearch('${tag}');closeModal()">${tag}</span>`
            ).join('')}</div>`;
        }
    }

    $('m-body').innerHTML = `
        <div id="tab-op" class="tab-pane active">${tOp}</div>
        <div id="tab-strat" class="tab-pane">${tStrat}</div>
        <div id="tab-qa" class="tab-pane">${tQA}</div>
        <div id="tab-rex" class="tab-pane">${tRex}</div>
        <div id="tab-follow" class="tab-pane">${tFollow}</div>
        <div id="tab-timeline" class="tab-pane">${tTimeline}</div>
    `;
    
    // è¨­å®šåº•éƒ¨æ¨™ç±¤
    const tagsEl = $('m-tags');
    if(tagsHtml) {
        tagsEl.innerHTML = tagsHtml;
        tagsEl.classList.add('show');
    } else {
        tagsEl.innerHTML = '';
        tagsEl.classList.remove('show');
    }
    
    showModal(infoHtml, navItems);
};

// é–‹å•Ÿç”¢æ¥­å ±å‘Š
window.openReport = rid => {
    const r = DB.reports.find(i => i['å ±å‘Šç·¨è™Ÿ'] === rid);
    if(!r) return;
    
    const focus = META.reportFocus[rid] || [];
    const views = META.reportViews[rid] || {};
    const ratings = META.reportRatings[rid] || [];

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;color:var(--primary);margin-bottom:5px">${r['å ±å‘Šæ¨™é¡Œ']}</div>
        <div class="card-meta">
            <span class="tag brk">${r['åˆ¸å•†åç¨±']}</span>
            <span class="tag ind">${r['ç”¢æ¥­åç¨±']||''}</span>
            <span class="tag dt">${fmtDate(r['å ±å‘Šæ—¥æœŸ'])}</span>
        </div>
    `;

    const navItems = [
        {id:'sum', icon:'ğŸ“Š', label:'ç¸½è¦½'},
        {id:'focus', icon:'ğŸ”', label:'ç„¦é»åˆ†æ'},
        {id:'view', icon:'ğŸ’¡', label:'åˆ¸å•†è§€é»'},
        {id:'pick', icon:'â­', label:'å€‹è‚¡è©•åƒ¹'}
    ];

    let tSum = '';
    ['æ ¸å¿ƒé‡é»1','æ ¸å¿ƒé‡é»2','æ ¸å¿ƒé‡é»3','æ ¸å¿ƒé‡é»4','æ ¸å¿ƒé‡é»5'].forEach((k,i) => {
        if(r[k]) tSum += `<div class="hl-block"><b>${i+1}.</b> ${r[k]}</div>`;
    });
    if(r['ç”¢æ¥­è©•ç­‰']) tSum += `<div class="info-row"><span class="info-label">ç”¢æ¥­è©•ç­‰</span><span class="info-val" style="color:var(--primary)">${r['ç”¢æ¥­è©•ç­‰']}</span></div>`;

    let tFocus = '';
    if(focus.length) {
        focus.forEach(f => {
            tFocus += `<div class="section-head">${f['æ®µè½æ¨™é¡Œ']||`æ®µè½${f['æ®µè½ç·¨è™Ÿ']}`}</div>`;
            tFocus += `<div class="hl-block">${fmtTxt(f['æ®µè½å…§å®¹'])}</div>`;
            if(f['å¸‚å ´è¦æ¨¡æ•¸æ“š']) tFocus += `<div class="info-row"><span class="info-label">å¸‚å ´è¦æ¨¡</span><span class="info-val">${f['å¸‚å ´è¦æ¨¡æ•¸æ“š']}</span></div>`;
        });
    } else tFocus = '<div style="color:#999;text-align:center;padding:20px">ç„¡ç„¦é»åˆ†æ</div>';

    let tView = '';
    if(views['è§€é»å…§å®¹']) tView += `<div class="hl-block">${fmtTxt(views['è§€é»å…§å®¹'])}</div>`;
    [1,2,3].forEach(n => {
        if(views[`é¦–é¸å€‹è‚¡${n}`]) tView += `<div class="list-item"><div class="list-title">ğŸŒŸ ${views[`é¦–é¸å€‹è‚¡${n}`]}</div><div class="list-sub">${views[`é¦–é¸ç†ç”±${n}`]||''}</div></div>`;
    });
    if(views['é¢¨éšªæé†’']) tView += `<div class="hl-block" style="border-left-color:#e74c3c"><b>âš ï¸ é¢¨éšªæé†’</b><br>${views['é¢¨éšªæé†’']}</div>`;
    if(!tView) tView = '<div style="color:#999;text-align:center;padding:20px">ç„¡åˆ¸å•†è§€é»</div>';

    let tPick = '';
    if(ratings.length) {
        ratings.forEach(rt => {
            const stockCode = normalizeCode(rt['è‚¡ç¥¨ä»£è™Ÿ']);
            tPick += `<div class="list-item" onclick="openStock('${stockCode}')">
                <div class="list-title">${rt['å…¬å¸åç¨±']} <span style="color:#999">${stockCode}</span></div>
                <div style="display:flex;gap:15px;margin-top:8px;font-size:12px">
                    <div><span style="color:#888">è©•ç­‰</span> <b style="color:var(--primary)">${rt['è©•ç­‰']||'-'}</b></div>
                    <div><span style="color:#888">ç›®æ¨™åƒ¹</span> <b>${rt['ç›®æ¨™åƒ¹']||'-'}</b></div>
                    <div><span style="color:#888">25F EPS</span> <b>${rt['EPS_FY25F']||'-'}</b></div>
                </div>
                ${rt['æŠ•è³‡äº®é»']?`<div style="font-size:12px;color:#666;margin-top:5px">${rt['æŠ•è³‡äº®é»']}</div>`:''}
            </div>`;
        });
    } else tPick = '<div style="color:#999;text-align:center;padding:20px">ç„¡å€‹è‚¡è©•åƒ¹</div>';

    $('m-body').innerHTML = `
        <div id="tab-sum" class="tab-pane active">${tSum}</div>
        <div id="tab-focus" class="tab-pane">${tFocus}</div>
        <div id="tab-view" class="tab-pane">${tView}</div>
        <div id="tab-pick" class="tab-pane">${tPick}</div>
    `;
    showModal(infoHtml, navItems);
};

// é–‹å•Ÿè¶¨å‹¢å±•æœ›å ±å‘Š (æ–°æ ¼å¼)
window.openStrategy = rid => {
    const r = DB.strategy.find(i => i['å ±å‘Šç·¨è™Ÿ'] === rid);
    if(!r) return;
    
    const secData = META.stratSections?.[rid];
    if(!secData) return;
    
    const basic = secData.basic || {};
    const sections = secData.sections || [];

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;color:var(--primary);margin-bottom:5px">${basic['å ±å‘Šä¸»é¡Œ'] || r['å ±å‘Šä¸»é¡Œ']}</div>
        ${basic['å‰¯æ¨™é¡Œ'] ? `<div style="font-size:13px;color:#666;margin-bottom:8px;font-style:italic">${basic['å‰¯æ¨™é¡Œ']}</div>` : ''}
        <div class="card-meta">
            <span class="tag brk">${basic['ç™¼å¸ƒå–®ä½'] || r['ä¸»è¬›å–®ä½']}</span>
            ${basic['ä¸»è¬›äºº'] ? `<span class="tag ind">${basic['ä¸»è¬›äºº']}</span>` : ''}
            <span class="tag dt">${fmtDate(basic['ç™¼å¸ƒæ—¥æœŸ'] || r['å ±å‘Šæ—¥æœŸ'])}</span>
            ${basic['å ±å‘Šé æ•¸'] ? `<span class="tag dt">${basic['å ±å‘Šé æ•¸']}</span>` : ''}
        </div>
    `;

    // å»ºç«‹é ç±¤ - ç¬¬ä¸€å€‹æ˜¯ç¸½è¦½ï¼Œå…¶é¤˜æ˜¯å„åˆ†é¡
    const navItems = [{id:'overview', icon:'ğŸ“‹', label:'ç¸½è¦½'}];
    sections.forEach((sec, idx) => {
        // å¾æ¨™é¡Œä¸­æå–ç°¡çŸ­åç¨±
        let label = sec.title.replace(/ã€|ã€‘/g, '').split(' ')[0];
        if(label.length > 6) label = label.substring(0, 6);
        const icons = ['ğŸŒ', 'ğŸ¦', 'ğŸ‡ºğŸ‡¸', 'ğŸ‡¨ğŸ‡³', 'ğŸ‡ªğŸ‡º', 'ğŸ‡¹ğŸ‡¼', 'ğŸ’±', 'ğŸ¤–', 'ğŸ’»', 'ğŸ­', 'ğŸ“ˆ', 'â­', 'ğŸ”—', 'ğŸ’¡', 'ğŸ“Š', 'ğŸ¯'];
        navItems.push({id: `sec${idx}`, icon: icons[idx % icons.length], label: label});
    });

    // ç¸½è¦½å…§å®¹
    let tOverview = '';
    if(basic['æ ¸å¿ƒè§€é»']) {
        tOverview += `<div class="hl-block"><b>ğŸ“Œ æ ¸å¿ƒè§€é»</b><br>${fmtTxt(basic['æ ¸å¿ƒè§€é»'])}</div>`;
    }
    if(basic['æ¨™ç±¤åˆ†é¡']) {
        const tags = basic['æ¨™ç±¤åˆ†é¡'].split('#').filter(t => t.trim());
        tOverview += `<div style="margin:15px 0;display:flex;flex-wrap:wrap;gap:6px">`;
        tags.forEach(tag => {
            tOverview += `<span style="background:#f0f0f0;padding:4px 10px;border-radius:15px;font-size:12px;color:#666">#${tag.trim()}</span>`;
        });
        tOverview += `</div>`;
    }
    
    // åœ¨ç¸½è¦½é¡¯ç¤ºå„åˆ†é¡æ‘˜è¦
    sections.forEach(sec => {
        tOverview += `<div class="section-head">${sec.title}</div>`;
        const preview = sec.items.slice(0, 3);
        preview.forEach(item => {
            const val = item.value ? String(item.value).substring(0, 100) : '';
            tOverview += `<div class="list-item" style="padding:8px 0;border-bottom:1px solid #f0f0f0">
                <span style="font-weight:600;color:#333">${item.label}</span>: 
                <span style="color:#666">${val}${String(item.value || '').length > 100 ? '...' : ''}</span>
            </div>`;
        });
        if(sec.items.length > 3) {
            tOverview += `<div style="font-size:11px;color:#999;padding:5px 0">é‚„æœ‰ ${sec.items.length - 3} é …...</div>`;
        }
    });

    // å„åˆ†é¡è©³ç´°å…§å®¹
    let tabPanes = `<div id="tab-overview" class="tab-pane active">${tOverview}</div>`;
    
    sections.forEach((sec, idx) => {
        let content = `<div class="section-head">${sec.title}</div>`;
        sec.items.forEach(item => {
            const val = item.value ? String(item.value) : '';
            // æª¢æŸ¥æ˜¯å¦æ˜¯è‚¡ç¥¨ä»£è™Ÿ (4ä½æ•¸å­—)
            const isStockCode = /^\d{4}$/.test(item.label);
            
            if(isStockCode) {
                // è‚¡ç¥¨é …ç›® - å¯é»æ“Š
                content += `<div class="list-item" onclick="openStock('${item.label}')" style="cursor:pointer">
                    <div class="list-title">${val} <span style="color:#999">${item.label}</span></div>
                </div>`;
            } else if(val.length > 100) {
                // é•·å…§å®¹ - ç”¨å€å¡Šé¡¯ç¤º
                content += `<div class="hl-block"><b>${item.label}</b><br>${fmtTxt(val)}</div>`;
            } else {
                // çŸ­å…§å®¹ - è¡¨æ ¼å¼é¡¯ç¤º
                content += `<div class="list-item" style="display:flex;padding:10px 0;border-bottom:1px solid #f0f0f0">
                    <div style="font-weight:600;color:#333;min-width:120px">${item.label}</div>
                    <div style="color:#555;flex:1">${val}</div>
                </div>`;
            }
        });
        tabPanes += `<div id="tab-sec${idx}" class="tab-pane">${content}</div>`;
    });

    $('m-body').innerHTML = tabPanes;
    showModal(infoHtml, navItems);
};

// é–‹å•Ÿç”¢æ¥­è¶¨å‹¢
window.openTrend = indName => {
    const t = DB.trends.find(i => i['ç”¢æ¥­'] === indName);
    if(!t) return;

    const infoHtml = `
        <div style="font-size:20px;font-weight:700;margin-bottom:5px">${t['ç”¢æ¥­']}</div>
        <div class="card-meta">
            <span class="tag trend-up">${t['è¶¨å‹¢åˆ¤æ–·']}</span>
            <span class="tag ind">${t['æ™¯æ°£ä½ç½®']}</span>
        </div>
    `;

    const stockCode = normalizeCode(t['è‚¡è™Ÿ']);
    const content = `
        <div class="info-row"><span class="info-label">ä»£è¡¨å…¬å¸</span><span class="info-val tag-link" onclick="openStock('${stockCode}')">${t['ä»£è¡¨å…¬å¸']} ${stockCode}</span></div>
        <div class="section-head">ğŸš€ é—œéµé©…å‹•å› ç´ </div>
        <div class="hl-block">${fmtTxt(t['é—œéµé©…å‹•å› ç´ '])}</div>
        <div class="section-head">âš ï¸ é¢¨éšªå› ç´ </div>
        <div class="hl-block" style="border-left-color:#e74c3c">${fmtTxt(t['é¢¨éšªå› ç´ '])}</div>
        <div class="section-head">ğŸ”® 2026å±•æœ›</div>
        <div class="hl-block">${fmtTxt(t['2026å±•æœ›'])}</div>
        <div class="section-head">ğŸ’¡ æŠ•è³‡å»ºè­°</div>
        <div class="hl-block">${fmtTxt(t['æŠ•è³‡å»ºè­°'])}</div>
    `;

    $('m-body').innerHTML = `<div id="tab-main" class="tab-pane active">${content}</div>`;
    showModal(infoHtml, []);
};

// é–‹å•Ÿå¤–é›»
window.openNews = id => {
    const n = DB.news.find(i => String(i['ç·¨è™Ÿ']) === String(id));
    if(!n) return;

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;margin-bottom:5px">${n['å…¬å¸']} <span style="color:#999;font-size:14px">${n['è‚¡è™Ÿ']}</span></div>
        <div class="card-meta">
            <span class="tag ind">${n['å ±å°é‡é»åˆ†é¡']}</span>
            <span class="tag dt">${fmtDate(n['æ—¥æœŸ'])}</span>
        </div>
    `;

    let content = `<div class="hl-block">${fmtTxt(n['å®Œæ•´å ±å°å…§å®¹'])}</div>`;
    if(n['æ¨™ç±¤']) {
        content += `<div style="margin-top:15px;display:flex;flex-wrap:wrap;gap:5px">`;
        safe(n['æ¨™ç±¤']).split(/[,ï¼Œ\s]+/).forEach(tag => {
            if(tag) content += `<span class="tag concept" style="cursor:pointer" onclick="setSearch('${tag}');closeModal()">${tag}</span>`;
        });
        content += `</div>`;
    }

    $('m-body').innerHTML = `<div id="tab-main" class="tab-pane active">${content}</div>`;
    showModal(infoHtml, []);
};

window.onload = init;
</script>

</body>
</html>
