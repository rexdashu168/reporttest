<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤ (Ultimate Link)</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>if(typeof XLSX==='undefined'){document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>');}</script>
    <style>
        /* ===== åŸºç¤è¨­å®š ===== */
        :root { --primary: #c96442; --bg: #f5f4ef; --text: #333; --gray: #666; --border: #e0e0e0; --link: #2980b9; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Heiti TC", sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 12px; }

        /* Loading */
        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .splash-icon { font-size: 48px; animation: bounce 2s infinite; margin-bottom: 15px; }
        .splash-bar { width: 200px; height: 4px; background: #ddd; border-radius: 2px; overflow: hidden; margin-top: 15px; }
        .splash-progress { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

        /* Header & Search */
        .header { text-align: center; padding: 20px 0; border-bottom: 1px solid var(--border); }
        .header h1 { color: var(--primary); font-size: 22px; margin-bottom: 5px; font-weight: 800; }
        .db-switcher { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin: 15px 0; }
        .db-tab { padding: 6px 14px; background: #fff; border: 1px solid var(--border); border-radius: 20px; font-size: 13px; color: var(--gray); cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
        .db-tab:hover { background: #fafafa; }
        .db-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 5px rgba(201, 100, 66, 0.3); }
        .count { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 10px; font-size: 10px; }
        .search-box { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 12px 12px 40px; border-radius: 25px; border: 2px solid var(--border); background: #fff; font-size: 15px; outline: none; transition: border 0.2s; }
        .search-input:focus { border-color: var(--primary); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #999; }

        /* Card List */
        .card-list { display: flex; flex-direction: column; gap: 12px; }
        .card { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; transition: transform 0.1s; position: relative; }
        .card:active { transform: scale(0.98); }
        .card-head { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: flex-start; }
        .card-title { font-weight: 700; font-size: 16px; color: #2c3e50; }
        .stock-code { color: #999; font-weight: 400; font-size: 14px; margin-left: 5px; }
        .card-meta { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .tag { font-size: 11px; padding: 2px 8px; border-radius: 6px; color: #fff; font-weight: 500; }
        .tag.brk { background: var(--primary); }
        .tag.ind { background: #2980b9; }
        .tag.dt { background: #e0e0e0; color: #666; }
        .tag.st { background: #27ae60; }
        .tag.concept { background: #8e44ad; }
        
        /* New Link Styles */
        .tag-link { color: var(--link); cursor: pointer; font-weight: 600; text-decoration: none; margin: 0 2px; padding: 0 2px; }
        .tag-link:hover { text-decoration: underline; background: #eaf6ff; border-radius: 4px; }
        .stock-link { color: #c0392b; font-weight: 700; cursor: pointer; border-bottom: 1px dashed #c0392b; }
        .clickable-area { cursor: pointer; transition: opacity 0.2s; }
        .clickable-area:hover { opacity: 0.7; }

        /* ===== Modal ===== */
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: flex-end; backdrop-filter: blur(2px); }
        .modal.show { display: flex; }
        .modal-inner { background: #fff; width: 100%; max-width: 600px; height: 92vh; border-radius: 16px 16px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; box-shadow: 0 -5px 20px rgba(0,0,0,0.15); }
        .m-head { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: flex-start; background: #fafafa; border-radius: 16px 16px 0 0; }
        .m-close { width: 30px; height: 30px; border-radius: 50%; border: none; background: #e0e0e0; font-size: 20px; color: #666; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        /* Navigation & Tabs */
        .nav-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; }
        .nav-btn { 
            padding: 8px 5px; border-radius: 8px; border: none; background: #f5f5f5; 
            font-size: 13px; font-weight: 600; color: #666; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 5px; transition: all 0.2s;
        }
        .nav-btn:hover { opacity: 0.8; }
        .nav-btn.active.b-basic { background: #e3f2fd; color: #1565c0; } 
        .nav-btn.active.b-fin { background: #fff8e1; color: #f57f17; } 
        .nav-btn.active.b-prod { background: #efebe9; color: #5d4037; } 
        .nav-btn.active.b-rep { background: #f3e5f5; color: #7b1fa2; } 
        .nav-btn.active.b-time { background: #ffebee; color: #c62828; } 
        .nav-btn.active.b-rate { background: #e0f2f1; color: #00695c; } 

        .m-body { flex: 1; overflow-y: auto; padding: 15px; background: #fff; scroll-behavior: smooth; }
        .tab-pane { display: none; animation: fadeIn 0.3s; }
        .tab-pane.active { display: block; }

        /* Content Blocks */
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .info-label { color: #888; }
        .info-val { font-weight: 600; color: #333; text-align: right; max-width: 70%; }
        
        .hl-block { background: #fafaf8; padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary); margin-bottom: 10px; font-size: 13px; line-height: 1.6; }
        .hl-orange { border-color: #f39c12; background: #fef9e7; }
        .hl-green { border-color: #27ae60; background: #eafaf1; }
        .hl-blue { border-color: #2980b9; background: #ebf5fb; }
        .hl-gray { border-color: #95a5a6; background: #f4f6f6; }
        
        .section-head { font-size: 14px; font-weight: 700; color: #555; margin: 20px 0 10px; padding-left: 8px; border-left: 4px solid #ccc; display: flex; align-items: center; }
        
        .list-item { padding: 12px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 8px; transition: background 0.1s; }
        .list-item.actionable { cursor: pointer; }
        .list-item.actionable:hover { background: #fafafa; border-color: #ddd; }
        .list-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; color: #2c3e50; }
        .list-sub { font-size: 11px; color: #888; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        
        .memo-content { font-size: 13px; color: #444; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #e0e0e0; line-height: 1.6; }
        .memo-tag { display: inline-block; background: #eee; color: #666; font-size: 10px; padding: 1px 5px; border-radius: 4px; margin-right: 5px; cursor: pointer; }
        .memo-tag:hover { background: #ddd; }

        .grid-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
        .stat-label { font-size: 11px; color: #888; margin-bottom: 3px; }
        .stat-val { font-size: 15px; font-weight: 700; color: #2c3e50; }
        .rev-table td { padding: 6px 4px; font-size: 12px; border: 1px solid #eee; text-align: center; }
        .rev-table .rev-h { font-size: 10px; color: #888; margin-bottom: 2px; }
        .rev-table .rev-v { font-weight: 600; color: #333; }

        /* Report Modal Specifics */
        .rep-stock-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 10px; }
        .rep-stock-btn { border: 1px solid #eee; padding: 8px; text-align: center; border-radius: 6px; font-size: 13px; cursor: pointer; background: #fff; }
        .rep-stock-btn:hover { background: #e3f2fd; border-color: #2980b9; color: #2980b9; }

        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @media(min-width: 768px) { .modal { align-items: center; } .modal-inner { height: 85vh; border-radius: 16px; } }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="splash-icon">ğŸ“Š</div>
    <div style="font-weight:700;font-size:18px;margin-bottom:5px" id="loadTitle">ç³»çµ±å•Ÿå‹•ä¸­...</div>
    <div style="font-size:13px;color:#888" id="loadSub">æ­£åœ¨é€£çµè³‡æ–™åº«èˆ‡åˆ†æé—œè¯</div>
    <div class="splash-bar"><div class="splash-progress" id="loadBar"></div></div>
</div>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
        <p style="font-size:12px;color:#666">å…¨æ–¹ä½å°è‚¡æŠ•è³‡æ±ºç­–ç³»çµ±</p>
    </div>

    <div class="db-switcher">
        <div class="db-tab active" onclick="setDB('news')">âš¡ å¤–é›» <span class="count" id="c-news">0</span></div>
        <div class="db-tab" onclick="setDB('memo')">ğŸ“‹ Memo <span class="count" id="c-memo">0</span></div>
        <div class="db-tab" onclick="setDB('reports')">ğŸ“‘ å ±å‘Š <span class="count" id="c-reports">0</span></div>
        <div class="db-tab" onclick="setDB('strategy')">ğŸ¯ ç­–ç•¥ <span class="count" id="c-strategy">0</span></div>
        <div class="db-tab" onclick="setDB('stocks')">ğŸ¢ å€‹è‚¡ <span class="count" id="c-stocks">0</span></div>
        <div class="db-tab" onclick="setDB('cb')">ğŸ« CB <span class="count" id="c-cb">0</span></div>
    </div>

    <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" class="search-input" id="search" placeholder="æœå°‹å…¬å¸ã€ä»£è™Ÿã€#Tag...">
    </div>

    <div style="font-size:12px;color:#666;margin-bottom:10px;">æ‰¾åˆ° <b id="resCount" style="color:var(--primary)">0</b> ç­†è³‡æ–™</div>
    <div class="card-list" id="list"></div>
</div>

<div class="modal" id="modal" onclick="closeModal(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">
        <div class="m-head">
            <div id="m-info" style="flex:1"></div>
            <button class="m-close" onclick="closeModal()">Ã—</button>
        </div>
        
        <div class="nav-grid">
            <button class="nav-btn active b-basic" onclick="swTab('basic', this)">ğŸ“Š åŸºæœ¬è³‡æ–™</button>
            <button class="nav-btn b-fin" onclick="swTab('fin', this)">ğŸ’° è²¡å‹™æ•¸æ“š</button>
            <button class="nav-btn b-prod" onclick="swTab('prod', this)">ğŸ“¦ ç”¢å“çµæ§‹</button>
            <button class="nav-btn b-rep" onclick="swTab('rep', this)">ğŸ“° ç›¸é—œå ±å°</button>
            <button class="nav-btn b-time" onclick="swTab('time', this)">ğŸ“… é—œéµæ™‚ç¨‹</button>
            <button class="nav-btn b-rate" onclick="swTab('rate', this)">â­ è©•åƒ¹è©•ç­‰</button>
        </div>

        <div class="m-body" id="m-body"></div>
    </div>
</div>

<div class="modal" id="repModal" onclick="closeRepModal(event)">
    <div class="modal-inner" style="height:70vh;" onclick="event.stopPropagation()">
        <div class="m-head">
            <div style="font-size:16px;font-weight:700">ğŸ“„ å ±å‘Šè©³æƒ…èˆ‡é¸è‚¡</div>
            <button class="m-close" onclick="closeRepModal()">Ã—</button>
        </div>
        <div class="m-body" id="rep-body"></div>
    </div>
</div>

<script>
// --- Data & Config ---
const FILES = {
    NEWS: '01_news.xlsx', 
    MEMO: '02_memo.xlsx', 
    REPORTS: '03_reports.xlsx',
    MASTER: '04_master.xlsx', 
    STRAT: '05_Strategy.xlsx', 
    CB: '00_CB.xlsx', 
    REV: '06_revenue.xlsx'
};

const DB = { news:[], memo:[], reports:[], strategy:[], stocks:{}, cb:[] };
const META = { 
    memoDetail:{}, tracking:{}, finance:{}, products:{}, timeline:[], ratings:{},
    revenue:{}, cbMap:{}, relatedNews:{}, relatedMemo:{}, 
    reportPicks:{}, stockInReports:{},
    concepts: {} // StockCode -> Array of Concepts
};
let CURR_DB = 'news';

// --- Utils ---
const $ = id => document.getElementById(id);
const safe = v => (v==null||v==undefined?'':String(v).trim());
const fmtDate = v => {
    if(!v) return '';
    if(typeof v === 'number' && v > 20000) {
        const d = new Date((v-25569)*86400000);
        return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
    }
    const s = String(v);
    if(s.match(/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}/)) return s.split(' ')[0];
    return v;
};

// --- Ultimate Text Formatter: Links Tags AND Stock Codes ---
const fmtTxt = (t) => {
    if(!t) return '';
    let html = safe(t).replace(/\n/g, '<br>').replace(/â€¢/g, '<br>â€¢ ');
    
    // 1. Link Hashtags (#Tag)
    html = html.replace(/#(\S+)/g, '<span class="tag-link" onclick="setSearch(\'#$1\'); event.stopPropagation();">#$1</span>');
    
    // 2. Link Stock Codes (4 digits) -> Only if they exist in DB.stocks
    // We use a regex to find 4-digit numbers, then check if they are valid stock codes
    html = html.replace(/(\d{4})/g, (match) => {
        if(DB.stocks[match]) {
            return `<span class="stock-link" onclick="openStock('${match}'); event.stopPropagation();">${match}</span>`;
        }
        return match;
    });
    
    return html;
};

const loadStep = (t,s,p) => { $('loadTitle').innerText=t; $('loadSub').innerText=s; $('loadBar').style.width=p+'%'; };

// --- Loaders ---
async function fetchXlsx(url) {
    try {
        const res = await fetch(url);
        if(!res.ok) throw new Error();
        return XLSX.read(await res.arrayBuffer(), {type:'array'});
    } catch(e) { console.warn('Load fail:', url); return null; }
}

async function init() {
    // 1. Master DB First (to build stock index for linking)
    loadStep('å»ºç«‹ä¸»ç´¢å¼•...', FILES.MASTER, 10);
    let wb = await fetchXlsx(FILES.MASTER);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['ä¸»è³‡æ–™åº«']||[]).forEach(r=>{ 
            if(r['ä»£è™Ÿ']) DB.stocks[safe(r['ä»£è™Ÿ'])]=r; 
        });
        // NEW: Load Concepts (04_master)
        XLSX.utils.sheet_to_json(wb.Sheets['ğŸ’¡æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«']||[]).forEach(r => {
            const code = safe(r['è‚¡ç¥¨ä»£è™Ÿ']);
            const concept = safe(r['æ¦‚å¿µåˆ†é¡']);
            if(code && concept) {
                if(!META.concepts[code]) META.concepts[code] = [];
                // Avoid duplicates
                if(!META.concepts[code].includes(concept)) META.concepts[code].push(concept);
            }
        });
    }

    // 2. News
    loadStep('è®€å–å¤–é›»...', FILES.NEWS, 30);
    wb = await fetchXlsx(FILES.NEWS);
    if(wb) XLSX.utils.sheet_to_json(wb.Sheets['å¤–é›»ç¶œåˆå ±å°']||[]).forEach(r => {
        if(safe(r['è³‡æ–™é¡å‹'])==='å€‹è‚¡å ±å°') {
            DB.news.push(r);
            const k = safe(r['è‚¡è™Ÿ']); if(k){ if(!META.relatedNews[k]) META.relatedNews[k]=[]; META.relatedNews[k].push(r); }
        }
    });

    // 3. CB
    loadStep('è®€å–CBè³‡æ–™...', FILES.CB, 45);
    wb = await fetchXlsx(FILES.CB);
    if(wb) XLSX.utils.sheet_to_json(wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™']||[]).forEach(r => {
        DB.cb.push(r);
        const k = safe(r['è½‰æ›æ¨™çš„ä»£ç¢¼']); if(k){ if(!META.cbMap[k]) META.cbMap[k]=[]; META.cbMap[k].push(r); }
    });

    // 4. Memo
    loadStep('è§£æ Call Memo...', FILES.MEMO, 60);
    wb = await fetchXlsx(FILES.MEMO);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¡¨']||[]).forEach(r => {
            DB.memo.push(r);
            const k = safe(r['è‚¡è™Ÿ']); if(k){ if(!META.relatedMemo[k]) META.relatedMemo[k]=[]; META.relatedMemo[k].push(r); }
        });
        XLSX.utils.sheet_to_json(wb.Sheets['è©³ç´°å…§å®¹åº«']||[]).forEach(r => META.memoDetail[safe(r['ç·¨è™Ÿ'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['å…¬å¸è¿½è¹¤è¡¨']||[]).forEach(r=>META.tracking[safe(r['å…¬å¸'])]=r);
        XLSX.utils.sheet_to_json(wb.Sheets['è²¡å‹™æ•¸æ“šå½™ç¸½']||[]).forEach(r=>META.finance[safe(r['å…¬å¸'])]=r);
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢å“çµæ§‹åˆ†æ']||[]).forEach(r=>META.products[safe(r['å…¬å¸'])]=r);
    }

    // 5. Reports & Strategy
    loadStep('æ•´åˆç­–ç•¥å ±å‘Š...', FILES.REPORTS, 75);
    wb = await fetchXlsx(FILES.REPORTS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r=>DB.reports.push(r));
        XLSX.utils.sheet_to_json(wb.Sheets['å€‹è‚¡è©•åƒ¹è¡¨']||[]).forEach(r=>{
             let code = safe(r['è‚¡ç¥¨ä»£è™Ÿ']).split(' ')[0];
             if(code) META.ratings[code] = r;
        });
        XLSX.utils.sheet_to_json(wb.Sheets['åˆ¸å•†è§€é»çµè«–']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            [1,2,3].forEach(n => {
                const stock = safe(r[`é¦–é¸å€‹è‚¡${n}`]);
                if(stock) {
                    if(!META.reportPicks[rid]) META.reportPicks[rid] = [];
                    META.reportPicks[rid].push({name:stock, reason:safe(r[`é¦–é¸ç†ç”±${n}`])});
                }
            });
        });
    }
    
    wb = await fetchXlsx(FILES.STRAT);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r=>DB.strategy.push(r));
        XLSX.utils.sheet_to_json(wb.Sheets['é¸è‚¡ç­–ç•¥']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            const code = safe(r['è‚¡ç¥¨ä»£è™Ÿ']);
            const name = safe(r['å…¬å¸åç¨±']);
            
            if(rid && code) {
                if(!META.reportPicks[rid]) META.reportPicks[rid] = [];
                META.reportPicks[rid].push({code:code, name:name, note:safe(r['å‚™è¨»'])});
                if(!META.stockInReports[code]) META.stockInReports[code] = [];
                META.stockInReports[code].push(rid);
            }
        });
    }
    
    // 6. Revenue
    loadStep('è¨ˆç®—ç‡Ÿæ”¶è¶¨å‹¢...', FILES.REV, 90);
    wb = await fetchXlsx(FILES.REV);
    if(wb) {
        const sheet = wb.Sheets['000_æœˆç‡Ÿæ”¶'] || wb.Sheets[wb.SheetNames[0]];
        if(sheet) {
            const rows = XLSX.utils.sheet_to_json(sheet);
            if(rows.length > 0) {
                const h = Object.keys(rows[0]).filter(k=>k.includes('å–®æœˆç‡Ÿæ”¶'));
                const recentH = h.slice(-6); 
                rows.forEach(r => { 
                    META.revenue[safe(r['ä»£è™Ÿ'])] = recentH.map(k=>({
                        p: k.match(/\d+M\d+/)?.[0] || 'æœˆ', 
                        v: r[k]
                    })); 
                });
            }
        }
    }

    loadStep('å®Œæˆ', 'Ready', 100);
    updateCounts();
    renderList();
    $('search').addEventListener('input', renderList);
    setTimeout(()=>$('loader').classList.add('hidden'), 500);
}

// --- Main Interactions ---
function setDB(db) {
    CURR_DB = db;
    document.querySelectorAll('.db-tab').forEach(t=>t.classList.remove('active'));
    event.currentTarget.classList.add('active');
    renderList();
}

window.setSearch = (term) => {
    $('search').value = term;
    renderList();
    $('modal').classList.remove('show');
    $('repModal').classList.remove('show');
}

function updateCounts() {
    $('c-news').innerText = DB.news.length; $('c-memo').innerText = DB.memo.length;
    $('c-reports').innerText = DB.reports.length; $('c-strategy').innerText = DB.strategy.length;
    $('c-stocks').innerText = Object.keys(DB.stocks).length; $('c-cb').innerText = DB.cb.length;
}

function renderList() {
    const q = $('search').value.toLowerCase().trim();
    let list = [], html = '';
    
    if(CURR_DB==='news') list = DB.news;
    else if(CURR_DB==='memo') list = DB.memo;
    else if(CURR_DB==='reports') list = DB.reports;
    else if(CURR_DB==='strategy') list = DB.strategy;
    else if(CURR_DB==='stocks') list = Object.values(DB.stocks);
    else if(CURR_DB==='cb') list = DB.cb;

    // Enhanced Search including tags
    const filtered = list.filter(i => {
        // Also check if detailed tags (not in main object) match for Memo
        if(CURR_DB==='memo' && i['ç·¨è™Ÿ']) {
             const d = META.memoDetail[i['ç·¨è™Ÿ']];
             if(d && JSON.stringify(d).toLowerCase().includes(q)) return true;
        }
        const str = JSON.stringify(i).toLowerCase();
        return str.includes(q);
    });
    $('resCount').innerText = filtered.length;

    filtered.slice(0, 100).forEach(i => {
        let title='', sub='', date='', code='', tagClass='brk';
        let body = '';
        let onClick = '';
        
        if(CURR_DB==='stocks') { 
            title = i['å…¬å¸åç¨±']; code = i['ä»£è™Ÿ']; sub = i['ç”¢æ¥­åˆ†é¡']; 
            body = i['æ¥­å‹™æ‘˜è¦'];
            onClick = `openStock('${code}')`; 
        }
        else if(CURR_DB==='cb') { 
            title = i['åç¨±']; code = i['è½‰æ›æ¨™çš„ä»£ç¢¼']; sub = `è½‰åƒ¹:${i['è½‰æ›åƒ¹æ ¼(å…ƒ)']}`; 
            body = `æœ€æ–°é¤˜é¡:${i['æœ€æ–°é¤˜é¡(ç™¾è¬)']}M | åˆ°æœŸæ—¥:${fmtDate(i['åˆ°æœŸæ—¥'])}`;
            onClick = `openStock('${code}')`; 
        }
        else if(CURR_DB==='news') { 
            title = i['å…¬å¸']; code = i['è‚¡è™Ÿ']; sub = i['å ±å°é‡é»åˆ†é¡']; date=i['æ—¥æœŸ']; tagClass='ind';
            body = fmtTxt(i['å®Œæ•´å ±å°å…§å®¹']);
            onClick = `openStock('${code}')`; 
        }
        else if(CURR_DB==='memo') { 
            title = i['å…¬å¸']; code = i['è‚¡è™Ÿ']; sub = i['å ±å‘Šé¡å‹']; date=i['æ—¥æœŸ']; 
            // FIX: Show Tags from Detail Library in the card
            const d = META.memoDetail[i['ç·¨è™Ÿ']];
            body = d ? (d['ç‡Ÿé‹é‡é»']||d['Rexè§€å¯Ÿ']||'é»æ“ŠæŸ¥çœ‹è©³ç´°åˆ†æ...') : 'æš«ç„¡è©³ç´°å…§å®¹';
            if(d && d['æ¨™ç±¤']) {
                // Pre-process tags for the card view
                const tags = d['æ¨™ç±¤'].split(' ').map(t=>t.startsWith('#')?t:'#'+t).map(t=>`<span class="tag-link" onclick="setSearch('${t}'); event.stopPropagation();" style="font-size:11px;color:#2980b9;">${t}</span>`).join(' ');
                body += `<div style="margin-top:5px;border-top:1px dashed #eee;padding-top:4px">${tags}</div>`;
            }
            onClick = `openStock('${code}')`; 
        }
        else if(CURR_DB==='reports' || CURR_DB==='strategy') {
            title = i['å ±å‘Šæ¨™é¡Œ']; sub = i['åˆ¸å•†åç¨±']; date=i['å ±å‘Šæ—¥æœŸ'];
            const rid = i['å ±å‘Šç·¨è™Ÿ'];
            body = i['å‰¯æ¨™é¡Œ'] || i['å¤§ç›¤è§€é»'] || 'é»æ“ŠæŸ¥çœ‹å ±å‘Šè©³æƒ…èˆ‡æ¨è–¦å€‹è‚¡';
            onClick = `openReport('${rid}', '${CURR_DB}')`;
        }

        html += `<div class="card" onclick="${onClick}">
            <div class="card-head">
                <div class="card-title">${title} ${code ? `<span class="stock-code">${code}</span>` : ''}</div>
            </div>
            <div class="card-meta">
                <span class="tag ${tagClass} clickable-area" onclick="setSearch('${sub}'); event.stopPropagation();">${sub||'ä¸€èˆ¬'}</span>
                ${date ? `<span class="tag dt">${fmtDate(date)}</span>` : ''}
            </div>
            <div class="card-body" style="overflow:visible;max-height:none;display:block;">${CURR_DB==='news'?body: (body.length>100 && !body.includes('tag-link') ? body.substring(0,100)+'...' : body)}</div>
        </div>`;
    });
    $('list').innerHTML = html || '<div style="text-align:center;padding:20px;color:#999">ç„¡ç›¸ç¬¦è³‡æ–™</div>';
}

// ===== REPORT MODAL =====
window.openReport = (rid, type) => {
    let report = (type === 'strategy' ? DB.strategy : DB.reports).find(r => r['å ±å‘Šç·¨è™Ÿ'] === rid);
    if (!report) return;

    const picks = META.reportPicks[rid] || [];

    let html = `
        <div style="padding:10px 0;border-bottom:1px solid #eee;">
            <h2 style="color:var(--primary);margin-bottom:5px;">${report['å ±å‘Šæ¨™é¡Œ']}</h2>
            <div style="font-size:13px;color:#666;">${report['åˆ¸å•†åç¨±']} | ${fmtDate(report['å ±å‘Šæ—¥æœŸ'])}</div>
        </div>
        <div class="hl-block" style="margin-top:15px;">
            <b>ğŸ’¡ æ ¸å¿ƒè§€é» / å‰¯æ¨™é¡Œ</b><br>
            ${fmtTxt(report['å‰¯æ¨™é¡Œ'] || report['å¤§ç›¤è§€é»'] || 'ç„¡è©³ç´°æ‘˜è¦')}
        </div>
        
        <div class="section-head">ç›¸é—œç²¾é¸å€‹è‚¡ (${picks.length})</div>
    `;

    if (picks.length > 0) {
        html += `<div class="rep-stock-grid">`;
        picks.forEach(p => {
            let code = p.code;
            if(!code) {
                const s = Object.values(DB.stocks).find(s => s['å…¬å¸åç¨±'] === p.name);
                if(s) code = s['ä»£è™Ÿ'];
            }
            const clickAttr = code ? `onclick="openStock('${code}'); event.stopPropagation();"` : '';
            html += `<div class="rep-stock-btn" ${clickAttr}>
                <div style="font-weight:700">${p.name}</div>
                ${code ? `<div style="font-size:11px;color:#999">${code}</div>` : ''}
                ${p.reason ? `<div style="font-size:10px;color:#666;margin-top:2px">${p.reason}</div>` : ''}
            </div>`;
        });
        html += `</div>`;
    } else {
        html += `<div style="color:#999;font-size:13px;">æ­¤å ±å‘Šæœªæ¨™è¨˜ç‰¹å®šå€‹è‚¡</div>`;
    }
    
    if(report['ç¸½ç¶“è§€é»æ‘˜è¦']) {
         html += `<div class="section-head">ç¸½ç¶“è§€é»</div><div style="font-size:13px;color:#444;line-height:1.6">${fmtTxt(report['ç¸½ç¶“è§€é»æ‘˜è¦'])}</div>`;
    }

    $('rep-body').innerHTML = html;
    $('repModal').classList.add('show');
};
window.closeRepModal = (e) => { if(!e || e.target.id==='repModal' || e.target.classList.contains('m-close')) $('repModal').classList.remove('show'); };


// ===== SUPER STOCK MODAL =====
window.openStock = (code) => {
    if(!code || code==='-') return;
    const s = DB.stocks[code] || { 'å…¬å¸åç¨±': code, 'ä»£è™Ÿ': code, 'ç”¢æ¥­åˆ†é¡':'æœªçŸ¥', 'æ¥­å‹™æ‘˜è¦':'æš«ç„¡ä¸»è³‡æ–™åº«æ•¸æ“š' };
    const name = s['å…¬å¸åç¨±'];
    
    // Aggregation
    const cbs = META.cbMap[code];
    const rev = META.revenue[code];
    const memos = META.relatedMemo[code] || [];
    const news = META.relatedNews[code] || [];
    const fin = META.finance[name] || {};
    const prod = META.products[name] || {};
    const track = META.tracking[name] || {};
    const rate = META.ratings[code] || {};
    const concepts = META.concepts[code] || []; // New Concept Integration
    
    // Header (Added Concepts Display)
    let conceptHtml = concepts.map(c => `<span class="tag concept clickable-area" onclick="setSearch('${c}')">#${c}</span>`).join(' ');
    
    $('m-info').innerHTML = `
        <div style="font-size:20px;font-weight:700;margin-bottom:5px;color:#2c3e50;">${name} (${code})</div>
        <div class="card-meta">
            <span class="tag ind clickable-area" onclick="setSearch('${s['ç”¢æ¥­åˆ†é¡']}')">${s['ç”¢æ¥­åˆ†é¡']}</span>
            ${conceptHtml}
            ${s['å¸‚å€¼(å„„)'] ? `<span class="tag dt">å¸‚å€¼:${s['å¸‚å€¼(å„„)']}å„„</span>` : ''}
        </div>
        <div style="font-size:13px;color:#666;margin-top:8px;line-height:1.4">${s['æ¥­å‹™æ‘˜è¦'].substring(0,80)}${s['æ¥­å‹™æ‘˜è¦'].length>80?'...':''}</div>
    `;

    // 1. Basic Tab
    let tBasic = `<div class="section-head">åŸºæœ¬æ¦‚æ³</div>
                  <div class="info-row"><span class="info-label">æ”¶ç›¤åƒ¹</span><span class="info-val" style="color:var(--primary)">${s['æˆäº¤']||'-'}</span></div>
                  <div class="info-row"><span class="info-label">æ¼²è·Œå¹…</span><span class="info-val">${s['æ¼²è·Œå¹…']||'-'}%</span></div>
                  <div class="info-row"><span class="info-label">æˆç«‹/æ›ç‰Œ</span><span class="info-val">${s['æˆç«‹å¹´æ•¸']||'-'}å¹´ / ${s['æ›ç‰Œå¹´æ•¸']||'-'}å¹´</span></div>`;
    
    // Show Strategy Mentions
    const relatedReports = META.stockInReports[code];
    if(relatedReports && relatedReports.length > 0) {
        tBasic += `<div class="section-head">ğŸ¯ æ”¶éŒ„æ–¼ç­–ç•¥å ±å‘Š</div><div class="rep-stock-grid">`;
        relatedReports.forEach(rid => {
            const r = DB.strategy.find(i=>i['å ±å‘Šç·¨è™Ÿ']===rid);
            if(r) {
                tBasic += `<div class="rep-stock-btn" onclick="openReport('${rid}', 'strategy')">
                    <div style="font-size:12px;font-weight:700">${r['åˆ¸å•†åç¨±']}</div>
                    <div style="font-size:10px;color:#666">${fmtDate(r['å ±å‘Šæ—¥æœŸ'])}</div>
                </div>`;
            }
        });
        tBasic += `</div>`;
    }

    if(cbs) {
        tBasic += `<div class="section-head">ğŸ« å¯è½‰å‚µ (CB)</div>` + cbs.map(c=>`
            <div class="hl-block hl-orange">
                <div style="display:flex;justify-content:space-between;font-weight:700;margin-bottom:4px">
                    <span>${c['åç¨±']} (${c['CBä»£è™Ÿ']})</span>
                    <span>$${c['CBæ”¶ç›¤åƒ¹']||'-'}</span>
                </div>
                <div style="font-size:12px;color:#666">
                    è½‰åƒ¹: ${c['è½‰æ›åƒ¹æ ¼(å…ƒ)']} | é¤˜é¡: ${c['æœ€æ–°é¤˜é¡(ç™¾è¬)']}M<br>
                    åˆ°æœŸæ—¥: ${fmtDate(c['åˆ°æœŸæ—¥'])}
                </div>
            </div>`).join('');
    }

    // 2. Finance Tab
    let tFin = `<div class="grid-stats">
        <div class="stat-box"><div class="stat-label">3Q25ç‡Ÿæ”¶</div><div class="stat-val">${fin['3Q25ç‡Ÿæ”¶']||'-'}</div></div>
        <div class="stat-box"><div class="stat-label">ç‡Ÿæ”¶YoY</div><div class="stat-val" style="color:${(fin['ç‡Ÿæ”¶YoY']||'').includes('-')?'green':'#e74c3c'}">${fin['ç‡Ÿæ”¶YoY']||'-'}</div></div>
        <div class="stat-box"><div class="stat-label">æ¯›åˆ©ç‡</div><div class="stat-val">${fin['æ¯›åˆ©ç‡']||'-'}</div></div>
        <div class="stat-box"><div class="stat-label">EPS</div><div class="stat-val">${fin['EPS']||'-'}</div></div>
    </div>`;
    
    if(rev) {
        tFin += `<div class="section-head">è¿‘æœŸæœˆç‡Ÿæ”¶è¶¨å‹¢</div>
        <table class="rev-table" style="width:100%;border-collapse:collapse;">
            <tr>${rev.map(r=>`<td><div class="rev-h">${r.p}</div><div class="rev-v">${r.v}</div></td>`).join('')}</tr>
        </table>`;
    }
    if(fin['4Q25æŒ‡å¼•']) tFin += `<div class="hl-block hl-blue" style="margin-top:15px"><b>ğŸ”® æœªä¾†æŒ‡å¼•</b><br>${fmtTxt(fin['4Q25æŒ‡å¼•'])}</div>`;

    // 3. Product Tab
    let tProd = '';
    if(prod['ä¸»è¦ç”¢å“1']) {
        tProd += `<div class="section-head">ç”¢å“çµ„åˆ</div>`;
        [1,2,3].forEach(n => {
            if(prod[`ä¸»è¦ç”¢å“${n}`]) {
                tProd += `<div class="list-item">
                    <div class="list-title">${prod[`ä¸»è¦ç”¢å“${n}`]}</div>
                    <div class="list-sub">${prod[`ä½”æ¯”/è¡¨ç¾${n}`] || 'ç„¡è©³ç´°ä½”æ¯”'}</div>
                </div>`;
            }
        });
    }
    if(prod['é—œéµæˆé•·å‹•èƒ½']) tProd += `<div class="hl-block hl-green"><b>ğŸš€ æˆé•·å‹•èƒ½</b><br>${fmtTxt(prod['é—œéµæˆé•·å‹•èƒ½'])}</div>`;
    if(prod['2026å±•æœ›']) tProd += `<div class="hl-block hl-blue"><b>ğŸ“… 2026å±•æœ›</b><br>${fmtTxt(prod['2026å±•æœ›'])}</div>`;

    // 4. Reports Tab
    let tRep = '';
    let timelineEvents = [];

    if(memos.length) {
        tRep += `<div class="section-head">åˆ¸å•†è¨ªè«‡å ±å‘Š (${memos.length})</div>`;
        memos.forEach(m => {
            const detailId = safe(m['ç·¨è™Ÿ']);
            const detail = META.memoDetail[detailId];
            if(detail && detail['é—œéµæ™‚ç¨‹']) timelineEvents.push({date: m['æ—¥æœŸ'], event: detail['é—œéµæ™‚ç¨‹']});

            tRep += `<div class="list-item">
                <div style="display:flex;justify-content:space-between;">
                    <div class="list-title">${m['åˆ¸å•†']} - ${m['å ±å‘Šé¡å‹']}</div>
                    <div style="font-size:12px;color:#c96442;">${m['é‡è¦æ€§']||''}</div>
                </div>
                <div class="list-sub">${fmtDate(m['æ—¥æœŸ'])} | åˆ†æå¸«: ${m['åˆ†æå¸«']||'-'}</div>
                ${detail ? `
                    <div class="memo-content">
                        ${detail['ç‡Ÿé‹é‡é»'] ? `<div><span class="memo-tag">ç‡Ÿé‹é‡é»</span>${fmtTxt(detail['ç‡Ÿé‹é‡é»'])}</div>` : ''}
                        ${detail['Rexè§€å¯Ÿ'] ? `<div style="margin-top:8px;"><span class="memo-tag" style="background:#e3f2fd;color:#1565c0">Rexè§€å¯Ÿ</span>${fmtTxt(detail['Rexè§€å¯Ÿ'])}</div>` : ''}
                    </div>` : '<div style="font-size:12px;color:#999;margin-top:5px;">(ç„¡è©³ç´°è¨ªè«‡å…§å®¹)</div>'}
            </div>`;
        });
    }
    
    if(news.length) tRep += `<div class="section-head">å¤–é›»ç¶œåˆå ±å° (${news.length})</div>` + news.map(n=>`
        <div class="list-item">
            <div class="list-title">${n['å ±å°é‡é»åˆ†é¡']}</div>
            <div class="list-sub">${fmtDate(n['æ—¥æœŸ'])} | ${n['åˆ¸å•†ä¾†æº']}</div>
            <div class="memo-content">${fmtTxt(n['å®Œæ•´å ±å°å…§å®¹'])}</div>
        </div>`).join('');

    // 5. Timeline Tab
    let tTime = '';
    if(timelineEvents.length > 0) {
        tTime = timelineEvents.map(e => `<div class="hl-block hl-blue"><b>ğŸ“… ${fmtDate(e.date)} æ›´æ–°</b><br>${fmtTxt(e.event)}</div>`).join('');
    } else {
        tTime = '<div style="padding:20px;text-align:center;color:#999">ç„¡æ˜ç¢ºæ™‚ç¨‹è³‡æ–™</div>';
    }

    // 6. Ratings Tab
    let tRate = '';
    if(track['æŠ•è³‡è©•ç­‰']) {
         tRate += `<div class="section-head">è¿½è¹¤ç‹€æ…‹</div>
         <div class="info-row"><span class="info-label">æŠ•è³‡è©•ç­‰</span><span class="info-val">${track['æŠ•è³‡è©•ç­‰']}</span></div>
         <div class="info-row"><span class="info-label">ç›®æ¨™åƒ¹</span><span class="info-val" style="color:var(--primary)">${track['ç›®æ¨™åƒ¹']}</span></div>
         <div class="info-row"><span class="info-label">è¿½è¹¤ç‹€æ…‹</span><span class="info-val">${track['è¿½è¹¤ç‹€æ…‹']}</span></div>`;
    }
    if(rate['è©•ç­‰']) {
        tRate += `<div class="section-head">æœ€æ–°å€‹è‚¡å ±å‘Šè©•åƒ¹</div>
        <div class="grid-stats">
            <div class="stat-box"><div class="stat-label">FY25 EPS</div><div class="stat-val">${rate['EPS_FY25F']||'-'}</div></div>
            <div class="stat-box"><div class="stat-label">FY26 EPS</div><div class="stat-val">${rate['EPS_FY26F']||'-'}</div></div>
            <div class="stat-box"><div class="stat-label">ç›®æ¨™åƒ¹</div><div class="stat-val" style="color:#c0392b">${rate['ç›®æ¨™åƒ¹']||'-'}</div></div>
            <div class="stat-box"><div class="stat-label">è©•ç­‰</div><div class="stat-val">${rate['è©•ç­‰']||'-'}</div></div>
        </div>
        <div class="hl-block hl-green"><b>ğŸ’¡ æŠ•è³‡äº®é»</b><br>${rate['æŠ•è³‡äº®é»']||'ç„¡'}</div>`;
    }
    if(!tRate) tRate = '<div style="padding:20px;text-align:center;color:#999">å°šç„¡è©•ç­‰è³‡æ–™</div>';

    // Render Tabs
    $('m-body').innerHTML = `
        <div id="tab-basic" class="tab-pane active">${tBasic}</div>
        <div id="tab-fin" class="tab-pane">${tFin}</div>
        <div id="tab-prod" class="tab-pane">${tProd||'<div style="padding:20px;text-align:center;color:#999">æš«ç„¡ç”¢å“è³‡æ–™</div>'}</div>
        <div id="tab-rep" class="tab-pane">${tRep||'<div style="padding:20px;text-align:center;color:#999">æš«ç„¡å ±å‘Š</div>'}</div>
        <div id="tab-time" class="tab-pane">${tTime}</div>
        <div id="tab-rate" class="tab-pane">${tRate}</div>
    `;
    
    // Reset buttons
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector('.b-basic').classList.add('active');
    
    $('modal').classList.add('show');
};

window.swTab = (id, el) => {
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
    $('tab-'+id).classList.add('active');
};

window.closeModal = (e) => { if(!e || e.target.id==='modal' || e.target.classList.contains('m-close')) $('modal').classList.remove('show'); };
window.onload = init;
</script>
</body>
</html>
