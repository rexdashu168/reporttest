<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>if(typeof XLSX==='undefined'){document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>');}</script>

    <style>
        /* =========================================
           1. è¦–è¦ºæ ¸å¿ƒ (å®Œå…¨é‚„åŸä½ çš„æˆªåœ–é¢¨æ ¼)
           ========================================= */
        :root { --primary: #c96442; --bg: #f5f4ef; --text: #333; --gray: #666; --border: #e0e0e0; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 60px; }
        
        /* è§£æ±ºé‡ç–Šå•é¡Œçš„ç½®é ‚å€ */
        .sticky-header { position: sticky; top: 0; z-index: 100; background: var(--bg); padding: 10px 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 10px; }
        .header h1 { color: var(--primary); font-size: 20px; margin: 0; }
        .header p { font-size: 11px; color: #888; margin: 2px 0 0; }

        /* æŒ‰éˆ•åˆ— (å¯æ»‘å‹•) */
        .db-switcher { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .db-tab { flex: 0 0 auto; padding: 6px 14px; background: #fff; border: 1px solid #ccc; border-radius: 20px; font-size: 13px; color: #555; display: flex; align-items: center; gap: 5px; cursor: pointer; transition: 0.2s; }
        .db-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: bold; transform: scale(1.02); }
        .count { background: rgba(0,0,0,0.15); padding: 1px 6px; border-radius: 10px; font-size: 10px; }

        /* æœå°‹æ¡† */
        .search-box { position: relative; margin-top: 10px; }
        .search-input { width: 100%; padding: 10px 12px 10px 38px; border-radius: 20px; border: 2px solid #ddd; background: #fff; font-size: 14px; outline: none; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999; }

        /* åˆ—è¡¨å¡ç‰‡ */
        .card-list { padding: 12px; display: flex; flex-direction: column; gap: 10px; }
        .card { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #e0e0e0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); cursor: pointer; }
        .card-head { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .card-title { font-weight: 700; font-size: 16px; color: #333; }
        .card-meta { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px; }
        .tag { font-size: 10px; padding: 2px 8px; border-radius: 6px; color: #fff; font-weight: 500; }
        .tag.brk { background: var(--primary); }
        .tag.dt { background: #e0e0e0; color: #666; }
        .tag.ind { background: #2980b9; }
        .card-body { font-size: 13px; color: #555; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* ===== Modal (é‚„åŸä½ çš„æˆªåœ–è¨­è¨ˆ) ===== */
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-inner { background: #fff; width: 100%; max-width: 600px; height: 90vh; border-radius: 16px 16px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        .m-head { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .m-title { font-size: 18px; font-weight: 700; }
        .m-close { width: 30px; height: 30px; border-radius: 50%; border: none; background: #f0f0f0; font-size: 20px; color: #666; cursor: pointer; }
        
        /* å½©è‰²æ¨™ç±¤å°èˆª (æˆªåœ–é‡é») */
        .nav-scroll { display: flex; gap: 8px; padding: 10px 15px; overflow-x: auto; border-bottom: 1px solid #eee; -webkit-overflow-scrolling: touch; }
        .nav-btn { 
            flex: 0 0 auto; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600; 
            background: #f5f5f5; color: #666; cursor: pointer; display: flex; align-items: center; gap: 4px; border: 1px solid transparent;
        }
        /* é‚„åŸæˆªåœ–ä¸­çš„å½©è‰²æŒ‰éˆ• */
        .nav-btn.active.t-basic { background: #eef2ff; color: #4f46e5; border-color: #4f46e5; } /* è— */
        .nav-btn.active.t-op { background: #fef2f2; color: #dc2626; border-color: #dc2626; } /* ç´… */
        .nav-btn.active.t-strat { background: #fff7ed; color: #ea580c; border-color: #ea580c; } /* æ©˜ */
        .nav-btn.active.t-fin { background: #f0fdf4; color: #16a34a; border-color: #16a34a; } /* ç¶  */
        .nav-btn.active.t-prod { background: #fafaf9; color: #57534e; border-color: #57534e; } /* æ£• */

        .m-body { flex: 1; overflow-y: auto; padding: 15px; background: #fff; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* 6æ ¼è³‡è¨Šå¡ (æˆªåœ–é‡é») */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .stat-label { font-size: 12px; color: #888; margin-bottom: 4px; }
        .stat-val { font-size: 15px; font-weight: 700; color: #333; }
        .stat-val.up { color: #d32f2f; } /* å°è‚¡ç´…æ¼² */
        .stat-val.down { color: #388e3c; } /* å°è‚¡ç¶ è·Œ */

        /* é‡é»å€å¡Š (å·¦å´è‰²æ¢) */
        .hl-block { padding: 12px; background: #fff; border: 1px solid #eee; border-left: 4px solid #ccc; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .hl-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; color: #333; }
        .hl-text { font-size: 13px; color: #555; line-height: 1.6; white-space: pre-wrap; }
        .hl-blue { border-left-color: #2196f3; }
        .hl-orange { border-left-color: #ff9800; }
        .hl-green { border-left-color: #4caf50; }

        /* Loading */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f5f4ef; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .splash-icon { font-size: 48px; animation: bounce 2s infinite; margin-bottom: 15px; }
        .splash-bar { width: 200px; height: 4px; background: #ddd; border-radius: 2px; overflow: hidden; margin-top: 15px; }
        .splash-progress { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @media(min-width: 768px) { .modal { align-items: center; } .modal-inner { height: 85vh; border-radius: 16px; } }
    </style>
</head>
<body>

    <div class="loading-overlay" id="loader">
        <div class="splash-icon">ğŸ“Š</div>
        <div style="font-weight:700;font-size:18px;margin-bottom:5px" id="loadTitle">ç³»çµ±å•Ÿå‹•ä¸­...</div>
        <div style="font-size:13px;color:#888" id="loadSub">æ­£åœ¨åŒæ­¥ Rexå¤§å”è³‡æ–™åº«</div>
        <div class="splash-bar"><div class="splash-progress" id="loadBar"></div></div>
    </div>

    <div class="container">
        <div class="sticky-header">
            <div class="header">
                <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
                <p>åˆ¸å•†ç ”ç©¶å ±å‘Š Ã— å¤–é›»å¿«å ± Ã— Call Memo Ã— æŠ•è³‡ç­–ç•¥</p>
            </div>

            <div class="db-switcher">
                <div class="db-tab active" onclick="setDB('news')">âš¡ å¤–é›» <span class="count" id="c-news">0</span></div>
                <div class="db-tab" onclick="setDB('memo')">ğŸ“‹ Memo <span class="count" id="c-memo">0</span></div>
                <div class="db-tab" onclick="setDB('reports')">ğŸ“‘ å ±å‘Š <span class="count" id="c-reports">0</span></div>
                <div class="db-tab" onclick="setDB('strategy')">ğŸ¯ ç­–ç•¥ <span class="count" id="c-strategy">0</span></div>
                <div class="db-tab" onclick="setDB('stocks')">ğŸ¢ å€‹è‚¡ <span class="count" id="c-stocks">0</span></div>
                <div class="db-tab" onclick="setDB('cb')">ğŸ« CB <span class="count" id="c-cb">0</span></div>
            </div>

            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="search-input" id="search" placeholder="æœå°‹å…¬å¸ã€è‚¡è™Ÿã€é—œéµå­—...">
            </div>
            <div style="text-align:right;font-size:11px;color:#888;margin-top:5px">æ‰¾åˆ° <b id="resCount" style="color:var(--primary)">0</b> ç­†</div>
        </div>

        <div class="card-list" id="list"></div>
    </div>

    <div class="modal" id="modal" onclick="closeModal(event)">
        <div class="modal-inner" onclick="event.stopPropagation()">
            <div class="m-head">
                <div id="m-info"></div>
                <button class="m-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="nav-scroll" id="m-nav"></div>
            <div class="m-body" id="m-body"></div>
        </div>
    </div>

<script>
// ===== 1. è³‡æ–™èˆ‡è¨­å®š =====
const FILES = {
    NEWS: '01_news.xlsx', MEMO: '02_memo.xlsx', REPORTS: '03_reports.xlsx',
    MASTER: '04_master.xlsx', STRAT: '05_Strategy.xlsx', CB: '00_CB.xlsx', REV: '06_revenue.xlsx'
};

const DB = { news:[], memo:[], reports:[], strategy:[], stocks:{}, cb:[] };
const META = { 
    memoDetail:{}, tracking:{}, finance:{}, products:{}, timeline:[], 
    reportDetail:{}, reportStocks:[], revenue:{}, cbMap:{}, relatedNews:{}, relatedMemo:{}
};
let CURR_DB = 'news';

// ===== 2. å·¥å…·å‡½æ•¸ =====
const $ = id => document.getElementById(id);
const safe = v => (v==null || v==='undefined') ? '' : String(v).trim();
const fmtDate = v => {
    if(!v) return '';
    if(typeof v === 'number') {
        const d = new Date((v-25569)*86400000);
        return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
    }
    return v;
};
const fmtTxt = t => safe(t).replace(/\n/g, '<br>').replace(/â€¢/g, '<br>â€¢ ');
const loadStep = (t,s,p) => { $('loadTitle').innerText=t; $('loadSub').innerText=s; $('loadBar').style.width=p+'%'; };

// ===== 3. è¼‰å…¥é‚è¼¯ (ä¿ç•™ä½ ç¢ºèªéçš„æ­£ç¢ºè·¯å¾‘) =====
async function fetchFile(url) {
    try {
        const res = await fetch(url);
        if(!res.ok) throw new Error();
        return XLSX.read(await res.arrayBuffer(), {type:'array'});
    } catch(e) { console.warn('File not found:', url); return null; }
}

async function init() {
    loadStep('å•Ÿå‹•ä¸­...', 'News, CB, Master', 10);
    let [wbNews, wbCB, wbMaster] = await Promise.all([fetchFile(FILES.NEWS), fetchFile(FILES.CB), fetchFile(FILES.MASTER)]);

    if(wbNews) XLSX.utils.sheet_to_json(wbNews.Sheets['å¤–é›»ç¶œåˆå ±å°']||[]).forEach(r => {
        if(safe(r['è³‡æ–™é¡å‹'])==='å€‹è‚¡å ±å°') {
            DB.news.push(r);
            const k = safe(r['è‚¡è™Ÿ']); if(k) { if(!META.relatedNews[k]) META.relatedNews[k]=[]; META.relatedNews[k].push(r); }
        }
    });

    if(wbCB) XLSX.utils.sheet_to_json(wbCB.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™']||[]).forEach(r => {
        DB.cb.push(r);
        const k = safe(r['è½‰æ›æ¨™çš„ä»£ç¢¼']); if(k) { if(!META.cbMap[k]) META.cbMap[k]=[]; META.cbMap[k].push(r); }
    });

    if(wbMaster) XLSX.utils.sheet_to_json(wbMaster.Sheets['ä¸»è³‡æ–™åº«']||[]).forEach(r=>{ if(r['ä»£è™Ÿ']) DB.stocks[safe(r['ä»£è™Ÿ'])]=r; });

    loadStep('è§£æå ±å‘Š...', 'Memo, Reports', 50);
    let [wbMemo, wbRep] = await Promise.all([fetchFile(FILES.MEMO), fetchFile(FILES.REPORTS)]);

    if(wbMemo) {
        XLSX.utils.sheet_to_json(wbMemo.Sheets['å ±å‘Šç¸½è¡¨']||[]).forEach(r => {
            DB.memo.push(r);
            const k = safe(r['è‚¡è™Ÿ']); if(k) { if(!META.relatedMemo[k]) META.relatedMemo[k]=[]; META.relatedMemo[k].push(r); }
        });
        XLSX.utils.sheet_to_json(wbMemo.Sheets['è©³ç´°å…§å®¹åº«']||[]).forEach(r=>META.memoDetail[safe(r['ç·¨è™Ÿ'])]=r);
        XLSX.utils.sheet_to_json(wbMemo.Sheets['å…¬å¸è¿½è¹¤è¡¨']||[]).forEach(r=>META.tracking[safe(r['å…¬å¸'])]=r);
        XLSX.utils.sheet_to_json(wbMemo.Sheets['è²¡å‹™æ•¸æ“šå½™ç¸½']||[]).forEach(r=>META.finance[safe(r['å…¬å¸'])]=r);
        XLSX.utils.sheet_to_json(wbMemo.Sheets['ç”¢å“çµæ§‹åˆ†æ']||[]).forEach(r=>META.products[safe(r['å…¬å¸'])]=r);
    }

    if(wbRep) {
        XLSX.utils.sheet_to_json(wbRep.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r=>DB.reports.push(r));
        XLSX.utils.sheet_to_json(wbRep.Sheets['ç„¦é»åˆ†æå…§å®¹']||[]).forEach(r=>{ 
            const id=safe(r['å ±å‘Šç·¨è™Ÿ']); if(!META.reportDetail[id]) META.reportDetail[id]=[]; META.reportDetail[id].push(r); 
        });
    }

    loadStep('æ•´åˆæ•¸æ“š...', 'Strategy, Revenue', 80);
    let [wbStrat, wbRev] = await Promise.all([fetchFile(FILES.STRAT), fetchFile(FILES.REV)]);
    
    if(wbStrat) XLSX.utils.sheet_to_json(wbStrat.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r=>DB.strategy.push(r));
    
    if(wbRev) {
        const rows = XLSX.utils.sheet_to_json(wbRev.Sheets['000_æœˆç‡Ÿæ”¶']||[]);
        const h = Object.keys(rows[0]||{}).filter(k=>k.includes('å–®æœˆç‡Ÿæ”¶'));
        rows.forEach(r => { META.revenue[safe(r['ä»£è™Ÿ'])] = h.slice(-12).map(k=>({p:k.replace('å–®æœˆç‡Ÿæ”¶(å„„)',''), v:r[k]})); });
    }

    loadStep('å®Œæˆ', 'Ready', 100);
    updateCounts();
    renderList();
    $('search').addEventListener('input', renderList);
    setTimeout(()=>$('loader').classList.add('hidden'), 500);
}

// ===== 4. åˆ—è¡¨æ¸²æŸ“ (Card Renderer) =====
function setDB(db) {
    CURR_DB = db;
    document.querySelectorAll('.db-tab').forEach(t=>t.classList.remove('active'));
    event.currentTarget.classList.add('active');
    renderList();
}

function updateCounts() {
    $('c-news').innerText = DB.news.length; $('c-memo').innerText = DB.memo.length;
    $('c-reports').innerText = DB.reports.length; $('c-strategy').innerText = DB.strategy.length;
    $('c-stocks').innerText = Object.keys(DB.stocks).length; $('c-cb').innerText = DB.cb.length;
}

function renderList() {
    const q = $('search').value.toLowerCase();
    let list = [], html = '';
    
    if(CURR_DB==='news') list = DB.news;
    else if(CURR_DB==='memo') list = DB.memo;
    else if(CURR_DB==='reports') list = DB.reports;
    else if(CURR_DB==='strategy') list = DB.strategy;
    else if(CURR_DB==='stocks') list = Object.values(DB.stocks);
    else if(CURR_DB==='cb') list = DB.cb;

    const filtered = list.filter(i => JSON.stringify(i).toLowerCase().includes(q));
    $('resCount').innerText = filtered.length;

    filtered.slice(0,50).forEach(i => {
        let title, sub, date, content, id;
        
        if(CURR_DB==='news') { id=i['ç·¨è™Ÿ']; title=i['å…¬å¸']; sub=i['åˆ¸å•†ä¾†æº']; date=i['æ—¥æœŸ']; content=i['å®Œæ•´å ±å°å…§å®¹']; }
        else if(CURR_DB==='memo') { id=i['ç·¨è™Ÿ']; title=`${i['å…¬å¸']} (${i['è‚¡è™Ÿ']})`; sub=i['åˆ¸å•†']; date=i['æ—¥æœŸ']; content=META.memoDetail[id]?.['ç‡Ÿé‹é‡é»']; }
        else if(CURR_DB==='reports') { id=i['å ±å‘Šç·¨è™Ÿ']; title=i['å ±å‘Šæ¨™é¡Œ']; sub=i['åˆ¸å•†åç¨±']; date=i['å ±å‘Šæ—¥æœŸ']; content=i['æ ¸å¿ƒé‡é»1']; }
        else if(CURR_DB==='strategy') { id=i['å ±å‘Šç·¨è™Ÿ']; title=i['å ±å‘Šæ¨™é¡Œ']; sub=i['å ±å‘Šé¡å‹']; date=i['å ±å‘Šæ—¥æœŸ']; content=i['ç¸½ç¶“è§€é»æ‘˜è¦']; }
        else if(CURR_DB==='stocks') { id=i['ä»£è™Ÿ']; title=`${i['å…¬å¸åç¨±']} ${i['ä»£è™Ÿ']}`; sub=i['ç”¢æ¥­åˆ†é¡']; content=i['æ¥­å‹™æ‘˜è¦']; }
        else if(CURR_DB==='cb') { id=i['ä»£è™Ÿ']; title=`${i['åç¨±']} (${i['ä»£è™Ÿ']})`; sub=`è½‰åƒ¹:${i['è½‰æ›åƒ¹æ ¼(å…ƒ)']}`; content=`æ¨™çš„:${i['è½‰æ›æ¨™çš„åç¨±']} | é¤˜é¡:${i['æœ€æ–°é¤˜é¡(ç™¾è¬)']}`; }

        html += `<div class="card" onclick="openSmartModal('${CURR_DB}', '${id}')">
            <div class="card-head"><div class="card-title">${title}</div></div>
            <div class="card-meta"><span class="tag brk">${sub||'ä¸€èˆ¬'}</span>${date?`<span class="tag dt">${fmtDate(date)}</span>`:''}</div>
            <div class="card-body">${safe(content).substring(0,80)}...</div>
        </div>`;
    });
    $('list').innerHTML = html;
}

// ===== 5. æ™ºæ…§å½ˆçª— (é‚„åŸ UI) =====
function openSmartModal(type, id) {
    let mergedData = {}, title = '', tags = '';
    
    // å®šç¾©å½©è‰²æŒ‰éˆ• (Tabs)
    let tabs = []; 
    // å®šç¾©å…§å®¹ (HTML)
    let content = {};

    if(type === 'memo') {
        const m = DB.memo.find(x=>x['ç·¨è™Ÿ']==id);
        const detail = META.memoDetail[id]||{};
        const track = META.tracking[m['å…¬å¸']]||{};
        const fin = META.finance[m['å…¬å¸']]||{};
        const prod = META.products[m['å…¬å¸']]||{};
        
        title = `${m['å…¬å¸']} (${m['è‚¡è™Ÿ']})`;
        tags = `<span class="tag brk">${m['åˆ¸å•†']}</span><span class="tag dt">${fmtDate(m['æ—¥æœŸ'])}</span>`;
        
        tabs = [
            {id:'t-basic', name:'ğŸ“Š ç¸½è¦½', class:'t-basic'},
            {id:'t-op', name:'ğŸ¯ ç‡Ÿé‹', class:'t-op'},
            {id:'t-strat', name:'ğŸš€ ç­–ç•¥', class:'t-strat'},
            {id:'t-fin', name:'ğŸ’° è²¡å‹™', class:'t-fin'},
            {id:'t-prod', name:'ğŸ“¦ ç”¢å“', class:'t-prod'}
        ];

        // 1. ç¸½è¦½ (é‚„åŸ 6æ ¼ + é‡é»)
        content['t-basic'] = `
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">ç‡Ÿæ”¶YoY</div><div class="stat-val ${safe(m['ç‡Ÿæ”¶YoY']).includes('+')?'up':''}">${m['ç‡Ÿæ”¶YoY']||'-'}</div></div>
                <div class="stat-card"><div class="stat-label">æ¯›åˆ©ç‡</div><div class="stat-val">${m['æ¯›åˆ©ç‡']||'-'}</div></div>
                <div class="stat-card"><div class="stat-label">EPS</div><div class="stat-val">${m['EPS']||'-'}</div></div>
                <div class="stat-card"><div class="stat-label">è©•ç­‰</div><div class="stat-val">${track['æŠ•è³‡è©•ç­‰']||'-'}</div></div>
                <div class="stat-card"><div class="stat-label">ç›®æ¨™åƒ¹</div><div class="stat-val up">${track['ç›®æ¨™åƒ¹']||'-'}</div></div>
                <div class="stat-card"><div class="stat-label">ç‹€æ…‹</div><div class="stat-val">${track['è¿½è¹¤ç‹€æ…‹']||'-'}</div></div>
            </div>
            ${detail['å¾ŒçºŒè¿½è¹¤'] ? `<div class="hl-block hl-orange"><div class="hl-title">ğŸ”” å¾ŒçºŒè¿½è¹¤</div><div class="hl-text">${fmtTxt(detail['å¾ŒçºŒè¿½è¹¤'])}</div></div>` : ''}
        `;

        // 2. ç‡Ÿé‹
        content['t-op'] = `<div class="hl-block hl-blue"><div class="hl-title">ç‡Ÿé‹é‡é»</div><div class="hl-text">${fmtTxt(detail['ç‡Ÿé‹é‡é»'])}</div></div>`;
        
        // 3. ç­–ç•¥
        content['t-strat'] = `<div class="hl-block hl-green"><div class="hl-title">ç­–ç•¥æ–¹å‘</div><div class="hl-text">${fmtTxt(detail['ç­–ç•¥æ–¹å‘'])}</div></div>`;
        
        // 4. è²¡å‹™
        content['t-fin'] = `
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">3Q25ç‡Ÿæ”¶</div><div class="stat-val">${fin['3Q25ç‡Ÿæ”¶']||'-'}</div></div>
                <div class="stat-card"><div class="stat-label">ç¨…å¾Œæ·¨åˆ©</div><div class="stat-val">${fin['ç¨…å¾Œæ·¨åˆ©']||'-'}</div></div>
            </div>
            <div class="hl-block hl-blue"><div class="hl-title">4Q25 æŒ‡å¼•</div><div class="hl-text">${fin['4Q25æŒ‡å¼•']||'ç„¡'}</div></div>
        `;

        // 5. ç”¢å“
        content['t-prod'] = `
            ${prod['ä¸»è¦ç”¢å“1'] ? `<div class="hl-block hl-green"><b>${prod['ä¸»è¦ç”¢å“1']}</b><br>${prod['ä½”æ¯”/è¡¨ç¾1']}</div>` : ''}
            ${prod['ä¸»è¦ç”¢å“2'] ? `<div class="hl-block hl-green"><b>${prod['ä¸»è¦ç”¢å“2']}</b><br>${prod['ä½”æ¯”/è¡¨ç¾2']}</div>` : ''}
            <div class="hl-block hl-orange"><div class="hl-title">é—œéµå‹•èƒ½</div><div class="hl-text">${prod['é—œéµæˆé•·å‹•èƒ½']||'-'}</div></div>
        `;
    }
    
    else if(type === 'stocks') {
        const s = DB.stocks[id];
        const code = s['ä»£è™Ÿ'];
        title = `${s['å…¬å¸åç¨±']} (${code})`;
        tags = `<span class="tag ind">${s['ç”¢æ¥­åˆ†é¡']}</span>`;
        
        const rev = META.revenue[code];
        const cbs = META.cbMap[code];
        const memos = META.relatedMemo[code] || [];
        
        tabs = [
            {id:'t-base', name:'ğŸ“Š åŸºæœ¬', class:'t-basic'},
            {id:'t-rev', name:'ğŸ’° ç‡Ÿæ”¶', class:'t-fin'},
            {id:'t-rep', name:'ğŸ“‘ å ±å‘Š', class:'t-strat'}
        ];

        content['t-base'] = `
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">è‚¡åƒ¹</div><div class="stat-val" style="font-size:18px">${s['æˆäº¤']}</div></div>
                <div class="stat-card"><div class="stat-label">æ¼²è·Œå¹…</div><div class="stat-val ${safe(s['æ¼²è·Œå¹…']).includes('-')?'down':'up'}">${s['æ¼²è·Œå¹…']}</div></div>
                <div class="stat-card"><div class="stat-label">å¸‚å€¼</div><div class="stat-val">${s['å¸‚å€¼(å„„)']}å„„</div></div>
                <div class="stat-card"><div class="stat-label">ç”¢æ¥­</div><div class="stat-val">${s['ç”¢æ¥­åˆ†é¡']}</div></div>
            </div>
            <div class="hl-block hl-blue"><div class="hl-title">æ¥­å‹™æ‘˜è¦</div><div class="hl-text">${s['æ¥­å‹™æ‘˜è¦']}</div></div>
            ${cbs ? `<div class="hl-block hl-orange"><div class="hl-title">ğŸ« å¯è½‰å‚µ</div>${cbs.map(c=>`<div>${c['åç¨±']} (è½‰:${c['è½‰æ›åƒ¹æ ¼(å…ƒ)']})</div>`).join('')}</div>` : ''}
        `;

        content['t-rev'] = rev ? `<table style="width:100%;font-size:13px;border-collapse:collapse"><tr><th style="text-align:left;padding:8px;background:#f5f5f5">æœˆä»½</th><th style="text-align:right;padding:8px;background:#f5f5f5">ç‡Ÿæ”¶(å„„)</th></tr>${rev.map(r=>`<tr><td style="padding:8px;border-bottom:1px solid #eee">${r.p}</td><td style="padding:8px;border-bottom:1px solid #eee;text-align:right">${r.v}</td></tr>`).join('')}</table>` : 'ç„¡ç‡Ÿæ”¶è³‡æ–™';

        content['t-rep'] = memos.length ? memos.map(m=>`<div class="hl-block hl-blue" onclick="openSmartModal('memo','${m['ç·¨è™Ÿ']}')"><b>${m['å ±å‘Šé¡å‹']}</b> - ${fmtDate(m['æ—¥æœŸ'])}<br>${m['åˆ¸å•†']}</div>`).join('') : 'æš«ç„¡å ±å‘Š';
    }
    
    // å…¶ä»–é¡åˆ¥ (News, Strategy) ä½¿ç”¨ç°¡å–®ç‰ˆé¢
    else {
        let mainContent = '';
        if(type==='news') {
            const n = DB.news.find(x=>x['ç·¨è™Ÿ']==id); title=n['å…¬å¸']; tags=`<span class="tag brk">${n['åˆ¸å•†ä¾†æº']}</span>`;
            mainContent = `<div class="hl-block hl-blue"><div class="hl-text">${fmtTxt(n['å®Œæ•´å ±å°å…§å®¹'])}</div></div>`;
        }
        else if(type==='strategy') {
            const s = DB.strategy.find(x=>x['å ±å‘Šç·¨è™Ÿ']==id); title=s['å ±å‘Šæ¨™é¡Œ'];
            mainContent = `<div class="hl-block hl-orange"><div class="hl-text">${fmtTxt(s['ç¸½ç¶“è§€é»æ‘˜è¦'])}</div></div>`;
        }
        tabs = [{id:'t-main', name:'å…§å®¹', class:'t-basic'}];
        content['t-main'] = mainContent;
    }

    // Render Modal
    $('m-header').innerHTML = `<div class="m-title">${title}</div><div class="card-meta">${tags}</div>`;
    
    // Render Tabs
    $('m-nav').innerHTML = tabs.map((t,i) => 
        `<div class="nav-btn ${t.class} ${i===0?'active':''}" onclick="swTab('${t.id}', this)">${t.name}</div>`
    ).join('');

    // Render Body
    $('m-body').innerHTML = tabs.map((t,i) => 
        `<div id="${t.id}" class="tab-pane ${i===0?'active':''}">${content[t.id]}</div>`
    ).join('');

    $('modal').classList.add('show');
}

window.swTab = (id, el) => {
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
    $(id).classList.add('active');
}

window.closeModal = (e) => { if(!e || e.target.id==='modal') $('modal').classList.remove('show'); };
window.onload = init;
</script>
</body>
</html>
