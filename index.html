<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤ v11.0</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #c96442; --bg: #f5f4ef; --text: #333; --gray: #666; --border: #e0e0e0; --link: #2980b9; --up: #e74c3c; --down: #27ae60; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; }
        .container { max-width: 800px; margin: 0 auto; padding: 12px; }

        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #e0e0e0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .header { text-align: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .header h1 { color: var(--primary); font-size: 22px; margin-bottom: 5px; font-weight: 800; }
        .db-switcher { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin: 15px 0; }
        .db-tab { padding: 6px 14px; background: #fff; border: 1px solid var(--border); border-radius: 20px; font-size: 13px; color: var(--gray); cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
        .db-tab:hover { border-color: var(--primary); }
        .db-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .count { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 10px; font-size: 10px; }

        .search-box { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 35px 12px 40px; border-radius: 25px; border: 2px solid var(--border); background: #fff; font-size: 15px; outline: none; transition: border-color 0.2s; }
        .search-input:focus { border-color: var(--primary); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #999; }
        .clear-btn { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; background: #ccc; color: #fff; border-radius: 50%; font-size: 12px; line-height: 20px; text-align: center; cursor: pointer; display: none; }

        .card-list { display: flex; flex-direction: column; gap: 12px; }
        .card { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; transition: all 0.2s; }
        .card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .card-head { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .card-title { font-weight: 700; font-size: 16px; color: #2c3e50; }
        .card-meta { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .tag { font-size: 11px; padding: 2px 8px; border-radius: 6px; color: #fff; font-weight: 500; }
        .tag.brk { background: var(--primary); }
        .tag.ind { background: #2980b9; }
        .tag.dt { background: #e0e0e0; color: #666; }
        .tag.concept { background: #8e44ad; }
        .tag.trend-up { background: #27ae60; }
        .tag.trend-down { background: #e74c3c; }
        .card-body { font-size: 13px; color: #555; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        /* Modal */
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-inner { background: #fff; width: 100%; max-width: 650px; height: 92vh; border-radius: 16px 16px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        
        .m-head { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: flex-start; }
        .m-close { width: 32px; height: 32px; border-radius: 50%; border: none; background: #f0f0f0; font-size: 20px; color: #666; cursor: pointer; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .m-close:hover { background: #e0e0e0; }
        
        .nav-grid { display: flex; gap: 6px; padding: 10px 15px; background: #fafafa; border-bottom: 1px solid #eee; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .nav-btn { padding: 8px 12px; border-radius: 8px; border: none; background: #f0f0f0; font-size: 12px; font-weight: 600; color: #666; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .nav-btn.active { background: var(--primary); color: #fff; }

        .m-body { flex: 1; overflow-y: auto; padding: 15px; background: #fff; -webkit-overflow-scrolling: touch; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* å…§å®¹æ¨£å¼ */
        .section-head { font-size: 14px; font-weight: 700; color: #444; margin: 20px 0 10px; padding: 8px 12px; background: linear-gradient(90deg, #f8f9fa, transparent); border-left: 4px solid var(--primary); border-radius: 0 8px 8px 0; }
        .section-head:first-child { margin-top: 0; }
        .hl-block { background: #fafaf8; padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary); margin-bottom: 10px; font-size: 13px; line-height: 1.7; white-space: pre-wrap; }
        .hl-block b { color: var(--primary); }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .info-label { color: #666; }
        .info-val { font-weight: 600; color: #333; }
        
        .list-item { padding: 12px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 8px; background: #fff; cursor: pointer; transition: all 0.2s; }
        .list-item:hover { border-color: var(--primary); background: #fffaf8; }
        .list-title { font-weight: 700; font-size: 14px; color: #2c3e50; margin-bottom: 4px; }
        .list-sub { font-size: 12px; color: #888; margin-bottom: 6px; }
        .list-content { font-size: 13px; color: #555; line-height: 1.6; white-space: pre-wrap; }

        .tag-link { color: var(--link); cursor: pointer; font-weight: 600; }
        .tag-link:hover { text-decoration: underline; }
        
        /* è²¡å‹™è¡¨æ ¼ */
        .fin-switcher { display: flex; margin-bottom: 10px; border: 1px solid var(--primary); border-radius: 6px; overflow: hidden; }
        .fin-btn { flex: 1; padding: 8px; text-align: center; font-size: 13px; color: var(--primary); background: #fff; cursor: pointer; font-weight: 600; border-right: 1px solid var(--primary); transition: all 0.2s; }
        .fin-btn:last-child { border-right: none; }
        .fin-btn.active { background: var(--primary); color: #fff; }
        .fin-sub-pane { display: none; }
        .fin-sub-pane.active { display: block; }

        .table-wrap { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .fin-table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
        .fin-table th { background: #f8f9fa; padding: 10px 8px; border-bottom: 2px solid #ddd; text-align: right; color: #555; position: sticky; top: 0; }
        .fin-table td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: right; color: #333; }
        .fin-table th:first-child, .fin-table td:first-child { position: sticky; left: 0; background: #fff; border-right: 1px solid #eee; text-align: left; z-index: 2; font-weight: 700; }
        .fin-table tr:nth-child(even) td { background: #fcfcfc; }
        .fin-table tr:nth-child(even) td:first-child { background: #fcfcfc; }
        
        .t-up { color: var(--up); font-weight: 700; }
        .t-down { color: var(--down); font-weight: 700; }

        /* è©•åƒ¹å¡ç‰‡ */
        .rating-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .rating-card .big-num { font-size: 28px; font-weight: 800; }
        .rating-card .label { font-size: 12px; opacity: 0.8; }

        /* Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #f8f9fa; padding: 12px; text-align: center; border-radius: 8px; }
        .stat-box .num { font-size: 18px; font-weight: 700; color: var(--primary); }
        .stat-box .lbl { font-size: 11px; color: #888; margin-top: 2px; }

        /* QA æ¨£å¼ */
        .qa-item { margin-bottom: 15px; }
        .qa-q { background: #e3f2fd; padding: 10px 12px; border-radius: 8px 8px 0 0; font-weight: 600; color: #1565c0; font-size: 13px; }
        .qa-a { background: #f5f5f5; padding: 10px 12px; border-radius: 0 0 8px 8px; font-size: 13px; line-height: 1.6; color: #444; }

        /* æ™‚ç¨‹ */
        .timeline-item { position: relative; padding-left: 20px; margin-bottom: 12px; }
        .timeline-item::before { content: ''; position: absolute; left: 0; top: 8px; width: 10px; height: 10px; background: var(--primary); border-radius: 50%; }
        .timeline-item::after { content: ''; position: absolute; left: 4px; top: 20px; width: 2px; height: calc(100% + 4px); background: #e0e0e0; }
        .timeline-item:last-child::after { display: none; }
        .timeline-date { font-size: 12px; font-weight: 700; color: var(--primary); }
        .timeline-text { font-size: 13px; color: #444; margin-top: 2px; }

        @media(min-width: 768px) { .modal { align-items: center; } .modal-inner { height: 85vh; border-radius: 16px; } }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="loading-spinner"></div>
    <div style="font-weight:700;font-size:18px">Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</div>
    <div style="font-size:12px;color:#888;margin-top:8px" id="loadStatus">æ­£åœ¨è¼‰å…¥è³‡æ–™åº«...</div>
</div>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
        <p style="font-size:12px;color:#666">å…¨æ–¹ä½å°è‚¡æŠ•è³‡æ±ºç­–ç³»çµ± v11.0</p>
    </div>

    <div class="db-switcher">
        <div class="db-tab active" data-db="news">âš¡ å¤–é›» <span class="count" id="c-news">0</span></div>
        <div class="db-tab" data-db="memo">ğŸ“‹ Memo <span class="count" id="c-memo">0</span></div>
        <div class="db-tab" data-db="reports">ğŸ“‘ ç”¢æ¥­ <span class="count" id="c-reports">0</span></div>
        <div class="db-tab" data-db="strategy">ğŸ¯ ç­–ç•¥ <span class="count" id="c-strategy">0</span></div>
        <div class="db-tab" data-db="stocks">ğŸ¢ å€‹è‚¡ <span class="count" id="c-stocks">0</span></div>
        <div class="db-tab" data-db="trends">ğŸ“ˆ è¶¨å‹¢ <span class="count" id="c-trends">0</span></div>
        <div class="db-tab" data-db="cb">ğŸ« CB <span class="count" id="c-cb">0</span></div>
    </div>

    <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" class="search-input" id="search" placeholder="æœå°‹å…¬å¸ã€ä»£è™Ÿã€ç”¢æ¥­ã€#Tag..." oninput="handleInput(this)">
        <div class="clear-btn" id="clearBtn" onclick="clearSearch()">âœ•</div>
    </div>

    <div style="font-size:12px;color:#666;margin-bottom:10px;">æ‰¾åˆ° <b id="resCount" style="color:var(--primary)">0</b> ç­†è³‡æ–™</div>
    <div class="card-list" id="list"></div>
</div>

<div class="modal" id="modal" onclick="closeModal(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">
        <div class="m-head">
            <div id="m-info" style="flex:1"></div>
            <button class="m-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="nav-grid" id="navGrid"></div>
        <div class="m-body" id="m-body"></div>
    </div>
</div>

<script>
// ============ è³‡æ–™çµæ§‹ ============
const FILES = {
    NEWS: '01_news.xlsx', MEMO: '02_memo.xlsx', REPORTS: '03_reports.xlsx',
    MASTER: '04_master.xlsx', STRAT: '05_Strategy.xlsx', CB: '00_CB.xlsx', REV: '06_revenue.xlsx'
};

const DB = { news:[], memo:[], reports:[], strategy:[], stocks:{}, cb:[], trends:[] };
const META = { 
    memoDetail:{}, tracking:{}, finance:{}, products:{}, 
    concepts:{}, cbMap:{}, relatedNews:{}, relatedMemo:{},
    // 03_reports ç›¸é—œ
    reportFocus:{}, reportViews:{}, reportRatings:{},
    // 05_Strategy ç›¸é—œ
    stratMacro:{}, stratFundamental:{}, stratTheme:{}, stratChip:{}, stratTech:{}, stratQuarter:{}, stratPicks:{},
    // ç‡Ÿæ”¶
    revData: { month:{}, quarter:{}, year:{}, highlights:{} }
};

let CURR_DB = 'news';
const $ = id => document.getElementById(id);
const safe = v => (v==null||v==undefined?'':String(v).trim());
const fmtDate = v => {
    if(!v) return '';
    if(typeof v === 'number' && v > 20000) { const d=new Date((v-25569)*86400000); return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`; }
    return String(v).split(' ')[0];
};
const getDateVal = v => { if(!v) return 0; if(typeof v === 'number') return (v-25569)*86400000; return new Date(v).getTime(); };
const fmtNum = (v, pct=false) => {
    if(v===undefined||v===null||v==='') return '-';
    let n = parseFloat(String(v).replace(/,/g,''));
    if(isNaN(n)) return v;
    return pct ? n.toFixed(2)+'%' : n.toLocaleString();
};
const colorClass = v => {
    if(!v||v==='-') return '';
    let n = parseFloat(String(v).replace(/[%$,]/g,''));
    return n>0?'t-up':n<0?'t-down':'';
};
const getCode = row => {
    const keys = ['ä»£è™Ÿ','è‚¡ç¥¨ä»£è™Ÿ','è‚¡è™Ÿ','Code','è½‰æ›æ¨™çš„ä»£ç¢¼'];
    for(let k of keys) {
        const found = Object.keys(row).find(key => key.includes(k));
        if(found && row[found]) return String(row[found]).trim();
    }
    return null;
};

// æ ¼å¼åŒ–æ–‡å­—å…§å®¹ï¼ˆæ”¯æ´æ›è¡Œã€æ¨™ç±¤é€£çµï¼‰
const fmtTxt = t => {
    if(!t) return '';
    let html = safe(t).replace(/\n/g, '<br>');
    html = html.replace(/#(\S+)/g, '<span class="tag-link" onclick="setSearch(\'#$1\');closeModal()">#$1</span>');
    html = html.replace(/\b(\d{4})\b/g, (m) => DB.stocks[m] ? `<span class="tag-link" onclick="openStock('${m}')">${m}</span>` : m);
    return html;
};

// ============ æœå°‹ ============
function handleInput(el) { 
    $('clearBtn').style.display = el.value.length > 0 ? 'block' : 'none'; 
    renderList(); 
}
function clearSearch() { 
    $('search').value=''; 
    $('search').focus(); 
    $('clearBtn').style.display='none'; 
    renderList(); 
}
window.setSearch = term => { $('search').value = term; handleInput($('search')); };

// ============ è¼‰å…¥è³‡æ–™ ============
async function fetchXlsx(url) {
    try {
        $('loadStatus').innerText = `è¼‰å…¥ ${url}...`;
        const res = await fetch(url);
        if(!res.ok) throw new Error();
        return XLSX.read(await res.arrayBuffer(), {type:'array'});
    } catch(e) { console.warn('Load Error:', url); return null; }
}

async function init() {
    let wb;
    
    // 1. Master + æ¦‚å¿µè‚¡
    wb = await fetchXlsx(FILES.MASTER);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['ä¸»è³‡æ–™åº«']||[]).forEach(r => {
            if(r['ä»£è™Ÿ']) DB.stocks[safe(r['ä»£è™Ÿ'])] = r;
        });
        // æ¦‚å¿µè‚¡ï¼ˆæ¨™é¡Œåœ¨ç¬¬3è¡Œï¼‰
        const csSheet = wb.Sheets['ğŸ’¡æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«'];
        if(csSheet) {
            const range = XLSX.utils.decode_range(csSheet['!ref']);
            for(let R=3; R<=range.e.r; R++) {
                const code = csSheet[XLSX.utils.encode_cell({r:R,c:0})]?.v;
                const concept = csSheet[XLSX.utils.encode_cell({r:R,c:2})]?.v;
                const subCat = csSheet[XLSX.utils.encode_cell({r:R,c:3})]?.v;
                if(code && concept) {
                    const c = String(code).trim();
                    if(!META.concepts[c]) META.concepts[c] = [];
                    META.concepts[c].push({ concept: safe(concept), sub: safe(subCat) });
                }
            }
        }
    }

    // 2. Revenue
    wb = await fetchXlsx(FILES.REV);
    if(wb) {
        // æœˆç‡Ÿæ”¶
        const sheetM = wb.Sheets['000_æœˆç‡Ÿæ”¶'];
        if(sheetM) {
            const rows = XLSX.utils.sheet_to_json(sheetM);
            const cols = Object.keys(rows[0]||{}).filter(h=>h.includes('å–®æœˆç‡Ÿæ”¶')).sort();
            rows.forEach(r => {
                const c = getCode(r); if(!c) return;
                META.revData.month[c] = cols.slice(-12).map(col => {
                    const m = col.match(/(\d+M\d+)/);
                    return m ? { d: m[0], rev: r[col] } : null;
                }).filter(i=>i).reverse();
            });
        }
        // å­£ç‡Ÿæ”¶
        const sheetQ = wb.Sheets['000_å­£ç‡Ÿæ”¶'];
        if(sheetQ) {
            const rows = XLSX.utils.sheet_to_json(sheetQ);
            const cols = Object.keys(rows[0]||{}).filter(h=>h.includes('å–®å­£ç‡Ÿæ”¶')).sort();
            rows.forEach(r => {
                const c = getCode(r); if(!c) return;
                META.revData.quarter[c] = cols.slice(-12).map(col => {
                    const m = col.match(/(\d+Q\d)/);
                    return m ? { d: m[0], rev: r[col] } : null;
                }).filter(i=>i).reverse();
            });
        }
        // å¹´ç‡Ÿæ”¶
        const sheetY = wb.Sheets['000_å¹´ç‡Ÿæ”¶'];
        if(sheetY) {
            const rows = XLSX.utils.sheet_to_json(sheetY);
            const cols = Object.keys(rows[0]||{}).filter(h=>h.includes('å¹´åº¦ç‡Ÿæ”¶')).sort();
            rows.forEach(r => {
                const c = getCode(r); if(!c) return;
                META.revData.year[c] = cols.slice(-10).map(col => {
                    const m = col.match(/(\d{4})/);
                    return m ? { d: m[0], rev: r[col] } : null;
                }).filter(i=>i).reverse();
            });
        }
        // è²¡å ±å‚™è¨»
        const sheetH = wb.Sheets['10_è²¡å ±å‚™è¨»'];
        if(sheetH) XLSX.utils.sheet_to_json(sheetH).forEach(r => {
            const c = getCode(r);
            if(c) META.revData.highlights[c] = r;
        });
    }

    // 3. News
    wb = await fetchXlsx(FILES.NEWS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å¤–é›»ç¶œåˆå ±å°']||[]).forEach(r => {
            if(safe(r['è³‡æ–™é¡å‹'])==='å€‹è‚¡å ±å°') {
                DB.news.push(r);
                const k = getCode(r);
                if(k) { if(!META.relatedNews[k]) META.relatedNews[k]=[]; META.relatedNews[k].push(r); }
            }
        });
        DB.news.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
    }

    // 4. Memo
    wb = await fetchXlsx(FILES.MEMO);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¡¨']||[]).forEach(r => {
            DB.memo.push(r);
            const k = getCode(r);
            if(k) { if(!META.relatedMemo[k]) META.relatedMemo[k]=[]; META.relatedMemo[k].push(r); }
        });
        DB.memo.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
        
        XLSX.utils.sheet_to_json(wb.Sheets['è©³ç´°å…§å®¹åº«']||[]).forEach(r => META.memoDetail[safe(r['ç·¨è™Ÿ'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['è²¡å‹™æ•¸æ“šå½™ç¸½']||[]).forEach(r => META.finance[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢å“çµæ§‹åˆ†æ']||[]).forEach(r => META.products[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['å…¬å¸è¿½è¹¤è¡¨']||[]).forEach(r => META.tracking[safe(r['å…¬å¸'])] = r);
        
        // ç”¢æ¥­è¶¨å‹¢ç¸½è¦½
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢æ¥­è¶¨å‹¢ç¸½è¦½']||[]).forEach(r => {
            if(r['ç”¢æ¥­']) DB.trends.push(r);
        });
    }

    // 5. Reports (ç”¢æ¥­å ±å‘Š)
    wb = await fetchXlsx(FILES.REPORTS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r => DB.reports.push(r));
        DB.reports.sort((a,b) => getDateVal(b['å ±å‘Šæ—¥æœŸ'])-getDateVal(a['å ±å‘Šæ—¥æœŸ']));
        
        // ç„¦é»åˆ†æå…§å®¹ (å¤šæ®µè½)
        XLSX.utils.sheet_to_json(wb.Sheets['ç„¦é»åˆ†æå…§å®¹']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.reportFocus[rid]) META.reportFocus[rid]=[]; META.reportFocus[rid].push(r); }
        });
        // åˆ¸å•†è§€é»çµè«–
        XLSX.utils.sheet_to_json(wb.Sheets['åˆ¸å•†è§€é»çµè«–']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) META.reportViews[rid] = r;
        });
        // å€‹è‚¡è©•åƒ¹è¡¨
        XLSX.utils.sheet_to_json(wb.Sheets['å€‹è‚¡è©•åƒ¹è¡¨']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.reportRatings[rid]) META.reportRatings[rid]=[]; META.reportRatings[rid].push(r); }
        });
    }

    // 6. Strategy
    wb = await fetchXlsx(FILES.STRAT);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r => DB.strategy.push(r));
        DB.strategy.sort((a,b) => getDateVal(b['å ±å‘Šæ—¥æœŸ'])-getDateVal(a['å ±å‘Šæ—¥æœŸ']));
        
        // å„åˆ†æå·¥ä½œè¡¨
        XLSX.utils.sheet_to_json(wb.Sheets['ç¸½ç¶“åˆ†æ']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.stratMacro[rid]) META.stratMacro[rid]=[]; META.stratMacro[rid].push(r); }
        });
        XLSX.utils.sheet_to_json(wb.Sheets['åŸºæœ¬é¢åˆ†æ']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.stratFundamental[rid]) META.stratFundamental[rid]=[]; META.stratFundamental[rid].push(r); }
        });
        XLSX.utils.sheet_to_json(wb.Sheets['é¡Œæèˆ‡è¶¨å‹¢']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.stratTheme[rid]) META.stratTheme[rid]=[]; META.stratTheme[rid].push(r); }
        });
        XLSX.utils.sheet_to_json(wb.Sheets['ç±Œç¢¼åˆ†æ']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.stratChip[rid]) META.stratChip[rid]=[]; META.stratChip[rid].push(r); }
        });
        XLSX.utils.sheet_to_json(wb.Sheets['æŠ€è¡“åˆ†æ']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.stratTech[rid]) META.stratTech[rid]=[]; META.stratTech[rid].push(r); }
        });
        XLSX.utils.sheet_to_json(wb.Sheets['å­£åº¦è¡Œæƒ…è¦åŠƒ']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.stratQuarter[rid]) META.stratQuarter[rid]=[]; META.stratQuarter[rid].push(r); }
        });
        XLSX.utils.sheet_to_json(wb.Sheets['é¸è‚¡ç­–ç•¥']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.stratPicks[rid]) META.stratPicks[rid]=[]; META.stratPicks[rid].push(r); }
        });
    }

    // 7. CB
    wb = await fetchXlsx(FILES.CB);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™']||[]).forEach(r => {
            DB.cb.push(r);
            const k = safe(r['è½‰æ›æ¨™çš„ä»£ç¢¼']);
            if(k) { if(!META.cbMap[k]) META.cbMap[k]=[]; META.cbMap[k].push(r); }
        });
    }

    // æ›´æ–°è¨ˆæ•¸
    $('c-news').innerText = DB.news.length;
    $('c-memo').innerText = DB.memo.length;
    $('c-reports').innerText = DB.reports.length;
    $('c-strategy').innerText = DB.strategy.length;
    $('c-stocks').innerText = Object.keys(DB.stocks).length;
    $('c-trends').innerText = DB.trends.length;
    $('c-cb').innerText = DB.cb.length;

    $('loader').classList.add('hidden');
    
    // ç¶å®š Tab åˆ‡æ›
    document.querySelectorAll('.db-tab').forEach(tab => {
        tab.onclick = () => {
            CURR_DB = tab.dataset.db;
            document.querySelectorAll('.db-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            renderList();
        };
    });
    
    renderList();
}

// ============ æ¸²æŸ“åˆ—è¡¨ ============
function renderList() {
    const q = $('search').value.toLowerCase().trim();
    let list = [];
    
    if(CURR_DB==='news') list = DB.news;
    else if(CURR_DB==='memo') list = DB.memo;
    else if(CURR_DB==='reports') list = DB.reports;
    else if(CURR_DB==='strategy') list = DB.strategy;
    else if(CURR_DB==='stocks') list = Object.values(DB.stocks);
    else if(CURR_DB==='trends') list = DB.trends;
    else if(CURR_DB==='cb') list = DB.cb;

    const filtered = list.filter(i => {
        const str = JSON.stringify(i).toLowerCase();
        if(str.includes(q)) return true;
        // Memo æœå°‹è©³ç´°å…§å®¹
        if(CURR_DB==='memo' && i['ç·¨è™Ÿ']) {
            const d = META.memoDetail[i['ç·¨è™Ÿ']];
            if(d && JSON.stringify(d).toLowerCase().includes(q)) return true;
        }
        return false;
    });
    
    $('resCount').innerText = filtered.length;

    let html = '';
    filtered.slice(0, 100).forEach(i => {
        let title='', sub='', date='', code='', tagClass='brk', body='', click='';
        
        if(CURR_DB==='stocks') {
            title = i['å…¬å¸åç¨±']; code = i['ä»£è™Ÿ']; sub = i['ç”¢æ¥­åˆ†é¡']; 
            body = i['æ¥­å‹™æ‘˜è¦'] || '';
            click = `openStock('${code}')`;
        }
        else if(CURR_DB==='cb') {
            title = i['åç¨±']; code = i['è½‰æ›æ¨™çš„ä»£ç¢¼']; 
            sub = `è½‰åƒ¹:${i['è½‰æ›åƒ¹æ ¼(å…ƒ)']}`; 
            body = `é¤˜é¡:${i['æœ€æ–°é¤˜é¡(ç™¾è¬)']}M | åˆ°æœŸ:${fmtDate(i['åˆ°æœŸæ—¥'])}`;
            click = `openStock('${code}')`;
        }
        else if(CURR_DB==='news') {
            title = i['å…¬å¸']; code = i['è‚¡è™Ÿ']; sub = i['å ±å°é‡é»åˆ†é¡']; 
            date = i['æ—¥æœŸ']; tagClass = 'ind';
            body = safe(i['å®Œæ•´å ±å°å…§å®¹']).substring(0, 150);
            click = `openNews('${i['ç·¨è™Ÿ']}')`;
        }
        else if(CURR_DB==='memo') {
            title = i['å…¬å¸']; code = i['è‚¡è™Ÿ']; sub = i['å ±å‘Šé¡å‹']; date = i['æ—¥æœŸ'];
            const d = META.memoDetail[i['ç·¨è™Ÿ']];
            body = d ? (safe(d['ç‡Ÿé‹é‡é»']).substring(0,100) + '...') : 'é»æ“ŠæŸ¥çœ‹è©³æƒ…';
            click = `openMemo('${i['ç·¨è™Ÿ']}')`;
        }
        else if(CURR_DB==='reports') {
            title = i['å ±å‘Šæ¨™é¡Œ']; sub = i['åˆ¸å•†åç¨±'] + ' - ' + safe(i['ç”¢æ¥­åç¨±']); 
            date = i['å ±å‘Šæ—¥æœŸ']; tagClass = 'ind';
            body = i['å‰¯æ¨™é¡Œ'] || '';
            click = `openReport('${i['å ±å‘Šç·¨è™Ÿ']}')`;
        }
        else if(CURR_DB==='strategy') {
            title = i['å ±å‘Šæ¨™é¡Œ']; sub = i['åˆ¸å•†åç¨±']; date = i['å ±å‘Šæ—¥æœŸ'];
            body = i['å¤§ç›¤è§€é»'] || i['å‰¯æ¨™é¡Œ'] || '';
            click = `openStrategy('${i['å ±å‘Šç·¨è™Ÿ']}')`;
        }
        else if(CURR_DB==='trends') {
            title = i['ç”¢æ¥­']; sub = i['è¶¨å‹¢åˆ¤æ–·']; tagClass = 'trend-up';
            code = i['è‚¡è™Ÿ']; 
            body = `ä»£è¡¨:${i['ä»£è¡¨å…¬å¸']} | ä½ç½®:${i['æ™¯æ°£ä½ç½®']}`;
            click = `openTrend('${i['ç”¢æ¥­']}')`;
        }

        html += `<div class="card" onclick="${click}">
            <div class="card-head"><div class="card-title">${title} ${code?`<span style="color:#999;font-weight:400">${code}</span>`:''}</div></div>
            <div class="card-meta"><span class="tag ${tagClass}">${sub||'ä¸€èˆ¬'}</span>${date?`<span class="tag dt">${fmtDate(date)}</span>`:''}</div>
            <div class="card-body">${body}</div>
        </div>`;
    });
    
    $('list').innerHTML = html || '<div style="text-align:center;padding:30px;color:#999">ç„¡ç›¸ç¬¦è³‡æ–™</div>';
}

// ============ Modal ç›¸é—œ ============
function showModal(infoHtml, navItems, defaultTab) {
    $('m-info').innerHTML = infoHtml;
    $('navGrid').innerHTML = navItems.map((n,i) => 
        `<button class="nav-btn ${i===0?'active':''}" onclick="swTab('${n.id}', this)">${n.icon} ${n.label}</button>`
    ).join('');
    $('navGrid').style.display = navItems.length > 1 ? 'flex' : 'none';
    $('modal').classList.add('show');
}

window.swTab = (id, el) => {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    if(el) el.classList.add('active');
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    const pane = document.getElementById('tab-'+id);
    if(pane) pane.classList.add('active');
};

window.swFin = idx => {
    document.querySelectorAll('.fin-btn').forEach((b,i) => b.classList.toggle('active', i===idx));
    document.querySelectorAll('.fin-sub-pane').forEach((p,i) => p.classList.toggle('active', i===idx));
};

window.closeModal = e => {
    if(!e || e.target.id==='modal' || e.target.classList.contains('m-close')) {
        $('modal').classList.remove('show');
    }
};

// ============ é–‹å•Ÿå€‹è‚¡ ============
window.openStock = code => {
    if(!code || code==='-') return;
    const s = DB.stocks[code] || { 'å…¬å¸åç¨±': code, 'ä»£è™Ÿ': code };
    const name = s['å…¬å¸åç¨±'];
    const concepts = META.concepts[code] || [];
    const cbs = META.cbMap[code] || [];
    const memos = META.relatedMemo[code] || [];
    const news = META.relatedNews[code] || [];
    const fin = META.finance[name] || {};
    const prod = META.products[name] || {};
    const track = META.tracking[name] || {};
    const revM = META.revData.month[code] || [];
    const revQ = META.revData.quarter[code] || [];
    const revY = META.revData.year[code] || [];
    const revH = META.revData.highlights[code] || {};

    const infoHtml = `
        <div style="font-size:22px;font-weight:700;margin-bottom:5px">${name} <span style="color:#999;font-size:16px">${code}</span></div>
        <div class="card-meta">
            <span class="tag ind">${s['ç”¢æ¥­åˆ†é¡']||'æœªåˆ†é¡'}</span>
            ${concepts.slice(0,3).map(c=>`<span class="tag concept">#${c.concept}</span>`).join('')}
        </div>
        <div style="font-size:13px;color:#666;margin-top:5px;line-height:1.5">${s['æ¥­å‹™æ‘˜è¦']||''}</div>
    `;

    const navItems = [
        {id:'basic', icon:'ğŸ“Š', label:'ç¸½è¦½'},
        {id:'fin', icon:'ğŸ’°', label:'ç‡Ÿæ”¶'},
        {id:'prod', icon:'ğŸ“¦', label:'ç”¢å“'},
        {id:'rep', icon:'ğŸ“°', label:'å ±å‘Š'},
        {id:'rate', icon:'â­', label:'è©•åƒ¹'}
    ];

    // Tab 1: åŸºæœ¬è³‡æ–™
    let tBasic = `
        <div class="grid-2">
            <div class="stat-box"><div class="num">${s['æˆäº¤']||'-'}</div><div class="lbl">æ”¶ç›¤åƒ¹</div></div>
            <div class="stat-box"><div class="num ${colorClass(s['æ¼²è·Œå¹…'])}">${s['æ¼²è·Œå¹…']||'-'}%</div><div class="lbl">æ¼²è·Œå¹…</div></div>
        </div>
    `;
    if(concepts.length) {
        tBasic += `<div class="section-head">ğŸ’¡ æ¦‚å¿µè‚¡åˆ†é¡</div>`;
        tBasic += concepts.map(c => `<div class="list-item" onclick="setSearch('#${c.concept}');closeModal()"><div class="list-title">#${c.concept}</div><div class="list-sub">${c.sub||''}</div></div>`).join('');
    }
    if(cbs.length) {
        tBasic += `<div class="section-head">ğŸ« å¯è½‰å‚µ</div>`;
        tBasic += cbs.map(c => `<div class="hl-block"><b>${c['åç¨±']}</b><br>è½‰åƒ¹: ${c['è½‰æ›åƒ¹æ ¼(å…ƒ)']} | é¤˜é¡: ${c['æœ€æ–°é¤˜é¡(ç™¾è¬)']}M | åˆ°æœŸ: ${fmtDate(c['åˆ°æœŸæ—¥'])}</div>`).join('');
    }

    // Tab 2: ç‡Ÿæ”¶
    let tFin = '';
    if(revH['å–®æœˆç‡Ÿæ”¶å‰µç´€éŒ„æœˆæ•¸']) {
        tFin += `<div style="margin-bottom:15px"><span class="tag trend-up">ğŸ”¥ æ­·å²æ–°é«˜ ${revH['å–®æœˆç‡Ÿæ”¶å‰µç´€éŒ„æœˆæ•¸']} æ¬¡</span></div>`;
    }
    tFin += `
        <div class="fin-switcher">
            <div class="fin-btn active" onclick="swFin(0)">æœˆç‡Ÿæ”¶</div>
            <div class="fin-btn" onclick="swFin(1)">å­£ç‡Ÿæ”¶</div>
            <div class="fin-btn" onclick="swFin(2)">å¹´ç‡Ÿæ”¶</div>
        </div>
        <div id="ft-0" class="fin-sub-pane active"><div class="table-wrap"><table class="fin-table">
            <thead><tr><th>æœˆä»½</th><th>ç‡Ÿæ”¶(å„„)</th></tr></thead>
            <tbody>${revM.map(r=>`<tr><td>${r.d}</td><td>${fmtNum(r.rev)}</td></tr>`).join('')}</tbody>
        </table></div></div>
        <div id="ft-1" class="fin-sub-pane"><div class="table-wrap"><table class="fin-table">
            <thead><tr><th>å­£åº¦</th><th>ç‡Ÿæ”¶(å„„)</th></tr></thead>
            <tbody>${revQ.map(r=>`<tr><td>${r.d}</td><td>${fmtNum(r.rev)}</td></tr>`).join('')}</tbody>
        </table></div></div>
        <div id="ft-2" class="fin-sub-pane"><div class="table-wrap"><table class="fin-table">
            <thead><tr><th>å¹´åº¦</th><th>ç‡Ÿæ”¶(å„„)</th></tr></thead>
            <tbody>${revY.map(r=>`<tr><td>${r.d}</td><td>${fmtNum(r.rev)}</td></tr>`).join('')}</tbody>
        </table></div></div>
    `;
    if(fin['4Q25æŒ‡å¼•']) tFin += `<div class="hl-block" style="margin-top:15px"><b>ğŸ”® æœªä¾†æŒ‡å¼•</b><br>${fmtTxt(fin['4Q25æŒ‡å¼•'])}</div>`;

    // Tab 3: ç”¢å“çµæ§‹
    let tProd = '';
    if(prod['ä¸»è¦ç”¢å“1']) {
        tProd += `<div class="section-head">ğŸ“¦ ç”¢å“çµ„åˆ</div>`;
        [1,2,3].forEach(n => {
            if(prod[`ä¸»è¦ç”¢å“${n}`]) {
                tProd += `<div class="info-row"><span class="info-label">${prod[`ä¸»è¦ç”¢å“${n}`]}</span><span class="info-val">${prod[`ä½”æ¯”/è¡¨ç¾${n}`]||''}</span></div>`;
            }
        });
    }
    if(prod['é—œéµæˆé•·å‹•èƒ½']) tProd += `<div class="hl-block"><b>ğŸš€ æˆé•·å‹•èƒ½</b><br>${fmtTxt(prod['é—œéµæˆé•·å‹•èƒ½'])}</div>`;
    if(prod['2026å±•æœ›']) tProd += `<div class="hl-block"><b>ğŸ”® 2026å±•æœ›</b><br>${fmtTxt(prod['2026å±•æœ›'])}</div>`;
    if(!tProd) tProd = '<div style="text-align:center;padding:30px;color:#999">ç„¡ç”¢å“è³‡æ–™</div>';

    // Tab 4: ç›¸é—œå ±å‘Š
    let tRep = '';
    if(memos.length) {
        tRep += `<div class="section-head">ğŸ“‹ Call Memo (${memos.length})</div>`;
        memos.forEach(m => {
            tRep += `<div class="list-item" onclick="openMemo('${m['ç·¨è™Ÿ']}')">
                <div class="list-title">${m['åˆ¸å•†']} - ${m['å ±å‘Šé¡å‹']}</div>
                <div class="list-sub">${fmtDate(m['æ—¥æœŸ'])} | ${m['é‡è¦æ€§']||''}</div>
            </div>`;
        });
    }
    if(news.length) {
        tRep += `<div class="section-head">âš¡ å¤–é›»å ±å° (${news.length})</div>`;
        news.slice(0,5).forEach(n => {
            tRep += `<div class="list-item" onclick="openNews('${n['ç·¨è™Ÿ']}')">
                <div class="list-title">${n['å ±å°é‡é»åˆ†é¡']}</div>
                <div class="list-sub">${fmtDate(n['æ—¥æœŸ'])}</div>
            </div>`;
        });
    }
    if(!tRep) tRep = '<div style="text-align:center;padding:30px;color:#999">ç„¡ç›¸é—œå ±å‘Š</div>';

    // Tab 5: è©•åƒ¹è©•ç­‰
    let tRate = '';
    if(track['æŠ•è³‡è©•ç­‰']) {
        tRate += `<div class="rating-card"><div class="label">æŠ•è³‡è©•ç­‰</div><div class="big-num">${track['æŠ•è³‡è©•ç­‰']}</div></div>`;
        tRate += `<div class="info-row"><span class="info-label">ç›®æ¨™åƒ¹</span><span class="info-val" style="color:var(--primary);font-size:18px">${track['ç›®æ¨™åƒ¹']||'-'}</span></div>`;
        tRate += `<div class="info-row"><span class="info-label">è¿½è¹¤ç‹€æ…‹</span><span class="info-val">${track['è¿½è¹¤ç‹€æ…‹']||'-'}</span></div>`;
    }
    if(!tRate) tRate = '<div style="text-align:center;padding:30px;color:#999">ç„¡è©•åƒ¹è³‡æ–™</div>';

    $('m-body').innerHTML = `
        <div id="tab-basic" class="tab-pane active">${tBasic}</div>
        <div id="tab-fin" class="tab-pane">${tFin}</div>
        <div id="tab-prod" class="tab-pane">${tProd}</div>
        <div id="tab-rep" class="tab-pane">${tRep}</div>
        <div id="tab-rate" class="tab-pane">${tRate}</div>
    `;
    showModal(infoHtml, navItems);
};

// ============ é–‹å•Ÿ Memo ============
window.openMemo = id => {
    const m = DB.memo.find(i => String(i['ç·¨è™Ÿ']) === String(id));
    if(!m) return;
    const d = META.memoDetail[id] || {};
    const name = m['å…¬å¸'];
    const code = m['è‚¡è™Ÿ'];

    const infoHtml = `
        <div style="font-size:20px;font-weight:700;margin-bottom:5px">${name} <span style="color:#999;font-size:14px">${code}</span></div>
        <div class="card-meta">
            <span class="tag brk">${m['åˆ¸å•†']}</span>
            <span class="tag ind">${m['å ±å‘Šé¡å‹']}</span>
            <span class="tag dt">${fmtDate(m['æ—¥æœŸ'])}</span>
        </div>
        <div style="font-size:12px;color:#666;margin-top:5px">åˆ†æå¸«: ${m['åˆ†æå¸«']||'-'} | ${m['é‡è¦æ€§']||''}</div>
    `;

    const navItems = [
        {id:'op', icon:'ğŸ¯', label:'ç‡Ÿé‹é‡é»'},
        {id:'strat', icon:'ğŸš€', label:'ç­–ç•¥æ–¹å‘'},
        {id:'qa', icon:'â“', label:'QAæ‘˜è¦'},
        {id:'rex', icon:'ğŸ‘€', label:'Rexè§€å¯Ÿ'},
        {id:'track', icon:'ğŸ“…', label:'è¿½è¹¤æ™‚ç¨‹'}
    ];

    // Tab 1: ç‡Ÿé‹é‡é»
    const tOp = d['ç‡Ÿé‹é‡é»'] ? `<div class="hl-block">${fmtTxt(d['ç‡Ÿé‹é‡é»'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ç„¡è³‡æ–™</div>';

    // Tab 2: ç­–ç•¥æ–¹å‘
    const tStrat = d['ç­–ç•¥æ–¹å‘'] ? `<div class="hl-block">${fmtTxt(d['ç­–ç•¥æ–¹å‘'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ç„¡è³‡æ–™</div>';

    // Tab 3: QAæ‘˜è¦
    let tQA = '';
    if(d['é‡è¦QAæ‘˜è¦']) {
        const qaText = safe(d['é‡è¦QAæ‘˜è¦']);
        const qaPairs = qaText.split(/\n(?=Q\d|Qï¼š|Q:)/i);
        qaPairs.forEach(pair => {
            const match = pair.match(/^(Q\d?[ï¼š:]?\s*)([\s\S]*?)\n?(A\d?[ï¼š:]?\s*)([\s\S]*)$/i);
            if(match) {
                tQA += `<div class="qa-item"><div class="qa-q">${match[2].trim()}</div><div class="qa-a">${match[4].trim()}</div></div>`;
            } else if(pair.trim()) {
                tQA += `<div class="hl-block">${fmtTxt(pair)}</div>`;
            }
        });
    }
    if(!tQA) tQA = '<div style="color:#999;text-align:center;padding:20px">ç„¡QAè³‡æ–™</div>';

    // Tab 4: Rexè§€å¯Ÿ
    const tRex = d['Rexè§€å¯Ÿ'] ? `<div class="hl-block">${fmtTxt(d['Rexè§€å¯Ÿ'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ç„¡è§€å¯Ÿè¨˜éŒ„</div>';

    // Tab 5: è¿½è¹¤æ™‚ç¨‹
    let tTrack = '';
    if(d['å¾ŒçºŒè¿½è¹¤']) {
        tTrack += `<div class="section-head">ğŸ“Œ å¾ŒçºŒè¿½è¹¤</div><div class="hl-block">${fmtTxt(d['å¾ŒçºŒè¿½è¹¤'])}</div>`;
    }
    if(d['é—œéµæ™‚ç¨‹']) {
        tTrack += `<div class="section-head">ğŸ“… é—œéµæ™‚ç¨‹</div>`;
        const lines = safe(d['é—œéµæ™‚ç¨‹']).split('\n').filter(l=>l.trim());
        lines.forEach(line => {
            const match = line.match(/^\[([^\]]+)\]\s*(.+)/);
            if(match) {
                tTrack += `<div class="timeline-item"><div class="timeline-date">${match[1]}</div><div class="timeline-text">${match[2]}</div></div>`;
            } else {
                tTrack += `<div class="timeline-item"><div class="timeline-text">${line}</div></div>`;
            }
        });
    }
    if(d['æ¨™ç±¤']) {
        tTrack += `<div class="section-head">ğŸ·ï¸ æ¨™ç±¤</div><div style="display:flex;flex-wrap:wrap;gap:5px">`;
        safe(d['æ¨™ç±¤']).split(/[,ï¼Œ\s]+/).forEach(tag => {
            if(tag) tTrack += `<span class="tag concept" style="cursor:pointer" onclick="setSearch('${tag}');closeModal()">${tag}</span>`;
        });
        tTrack += `</div>`;
    }
    if(!tTrack) tTrack = '<div style="color:#999;text-align:center;padding:20px">ç„¡è¿½è¹¤è³‡æ–™</div>';

    $('m-body').innerHTML = `
        <div id="tab-op" class="tab-pane active">${tOp}</div>
        <div id="tab-strat" class="tab-pane">${tStrat}</div>
        <div id="tab-qa" class="tab-pane">${tQA}</div>
        <div id="tab-rex" class="tab-pane">${tRex}</div>
        <div id="tab-track" class="tab-pane">${tTrack}</div>
    `;
    showModal(infoHtml, navItems);
};

// ============ é–‹å•Ÿç”¢æ¥­å ±å‘Š ============
window.openReport = rid => {
    const r = DB.reports.find(i => i['å ±å‘Šç·¨è™Ÿ'] === rid);
    if(!r) return;
    
    const focus = META.reportFocus[rid] || [];
    const views = META.reportViews[rid] || {};
    const ratings = META.reportRatings[rid] || [];

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;color:var(--primary);margin-bottom:5px">${r['å ±å‘Šæ¨™é¡Œ']}</div>
        <div class="card-meta">
            <span class="tag brk">${r['åˆ¸å•†åç¨±']}</span>
            <span class="tag ind">${r['ç”¢æ¥­åç¨±']||''}</span>
            <span class="tag dt">${fmtDate(r['å ±å‘Šæ—¥æœŸ'])}</span>
        </div>
        <div style="font-size:12px;color:#666;margin-top:5px">${r['å‰¯æ¨™é¡Œ']||''}</div>
    `;

    const navItems = [
        {id:'sum', icon:'ğŸ“Š', label:'ç¸½è¦½'},
        {id:'focus', icon:'ğŸ”', label:'ç„¦é»åˆ†æ'},
        {id:'view', icon:'ğŸ’¡', label:'åˆ¸å•†è§€é»'},
        {id:'pick', icon:'â­', label:'å€‹è‚¡è©•åƒ¹'}
    ];

    // Tab 1: ç¸½è¦½
    let tSum = '';
    ['æ ¸å¿ƒé‡é»1','æ ¸å¿ƒé‡é»2','æ ¸å¿ƒé‡é»3','æ ¸å¿ƒé‡é»4','æ ¸å¿ƒé‡é»5'].forEach((k,i) => {
        if(r[k]) tSum += `<div class="hl-block"><b>${i+1}.</b> ${r[k]}</div>`;
    });
    if(r['ç”¢æ¥­è©•ç­‰']) tSum += `<div class="info-row"><span class="info-label">ç”¢æ¥­è©•ç­‰</span><span class="info-val" style="color:var(--primary)">${r['ç”¢æ¥­è©•ç­‰']}</span></div>`;
    if(r['åˆ†æå¸«å§“å']) tSum += `<div class="info-row"><span class="info-label">åˆ†æå¸«</span><span class="info-val">${r['åˆ†æå¸«å§“å']}</span></div>`;

    // Tab 2: ç„¦é»åˆ†æ
    let tFocus = '';
    if(focus.length) {
        focus.forEach(f => {
            tFocus += `<div class="section-head">${f['æ®µè½æ¨™é¡Œ']||`æ®µè½${f['æ®µè½ç·¨è™Ÿ']}`}</div>`;
            tFocus += `<div class="hl-block">${fmtTxt(f['æ®µè½å…§å®¹'])}</div>`;
            if(f['å¸‚å ´è¦æ¨¡æ•¸æ“š']) tFocus += `<div class="info-row"><span class="info-label">å¸‚å ´è¦æ¨¡</span><span class="info-val">${f['å¸‚å ´è¦æ¨¡æ•¸æ“š']}</span></div>`;
            if(f['æˆé•·ç‡æ•¸æ“š']) tFocus += `<div class="info-row"><span class="info-label">æˆé•·ç‡</span><span class="info-val">${f['æˆé•·ç‡æ•¸æ“š']}</span></div>`;
        });
    } else {
        tFocus = '<div style="color:#999;text-align:center;padding:20px">ç„¡ç„¦é»åˆ†æ</div>';
    }

    // Tab 3: åˆ¸å•†è§€é»
    let tView = '';
    if(views['è§€é»å…§å®¹']) {
        tView += `<div class="hl-block">${fmtTxt(views['è§€é»å…§å®¹'])}</div>`;
    }
    [1,2,3].forEach(n => {
        if(views[`é¦–é¸å€‹è‚¡${n}`]) {
            tView += `<div class="list-item"><div class="list-title">ğŸŒŸ ${views[`é¦–é¸å€‹è‚¡${n}`]}</div><div class="list-sub">${views[`é¦–é¸ç†ç”±${n}`]||''}</div></div>`;
        }
    });
    if(views['é¢¨éšªæé†’']) tView += `<div class="hl-block" style="border-left-color:#e74c3c"><b>âš ï¸ é¢¨éšªæé†’</b><br>${views['é¢¨éšªæé†’']}</div>`;
    if(!tView) tView = '<div style="color:#999;text-align:center;padding:20px">ç„¡åˆ¸å•†è§€é»</div>';

    // Tab 4: å€‹è‚¡è©•åƒ¹
    let tPick = '';
    if(ratings.length) {
        ratings.forEach(rt => {
            const stockCode = safe(rt['è‚¡ç¥¨ä»£è™Ÿ']).replace(/\s*TT$/i,'');
            tPick += `<div class="list-item" onclick="openStock('${stockCode}')">
                <div class="list-title">${rt['å…¬å¸åç¨±']} <span style="color:#999">${stockCode}</span></div>
                <div style="display:flex;gap:15px;margin-top:8px;font-size:12px">
                    <div><span style="color:#888">è©•ç­‰</span> <b style="color:var(--primary)">${rt['è©•ç­‰']||'-'}</b></div>
                    <div><span style="color:#888">ç›®æ¨™åƒ¹</span> <b>${rt['ç›®æ¨™åƒ¹']||'-'}</b></div>
                    <div><span style="color:#888">25F EPS</span> <b>${rt['EPS_FY25F']||'-'}</b></div>
                </div>
                ${rt['æŠ•è³‡äº®é»']?`<div style="font-size:12px;color:#666;margin-top:5px">${rt['æŠ•è³‡äº®é»']}</div>`:''}
            </div>`;
        });
    } else {
        tPick = '<div style="color:#999;text-align:center;padding:20px">ç„¡å€‹è‚¡è©•åƒ¹</div>';
    }

    $('m-body').innerHTML = `
        <div id="tab-sum" class="tab-pane active">${tSum}</div>
        <div id="tab-focus" class="tab-pane">${tFocus}</div>
        <div id="tab-view" class="tab-pane">${tView}</div>
        <div id="tab-pick" class="tab-pane">${tPick}</div>
    `;
    showModal(infoHtml, navItems);
};

// ============ é–‹å•Ÿç­–ç•¥å ±å‘Š ============
window.openStrategy = rid => {
    const r = DB.strategy.find(i => i['å ±å‘Šç·¨è™Ÿ'] === rid);
    if(!r) return;

    const macro = META.stratMacro[rid] || [];
    const fund = META.stratFundamental[rid] || [];
    const theme = META.stratTheme[rid] || [];
    const chip = META.stratChip[rid] || [];
    const tech = META.stratTech[rid] || [];
    const quarter = META.stratQuarter[rid] || [];
    const picks = META.stratPicks[rid] || [];

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;color:var(--primary);margin-bottom:5px">${r['å ±å‘Šæ¨™é¡Œ']}</div>
        <div class="card-meta">
            <span class="tag brk">${r['åˆ¸å•†åç¨±']}</span>
            <span class="tag dt">${fmtDate(r['å ±å‘Šæ—¥æœŸ'])}</span>
        </div>
        <div style="font-size:13px;color:#666;margin-top:5px">${r['å‰¯æ¨™é¡Œ']||''}</div>
    `;

    const navItems = [
        {id:'over', icon:'ğŸ“Š', label:'ç¸½è¦½'},
        {id:'macro', icon:'ğŸŒ', label:'ç¸½ç¶“'},
        {id:'fund', icon:'ğŸ“ˆ', label:'åŸºæœ¬é¢'},
        {id:'theme', icon:'ğŸ¯', label:'é¡Œæ'},
        {id:'pick', icon:'â­', label:'é¸è‚¡'}
    ];

    // Tab 1: ç¸½è¦½
    let tOver = '';
    if(r['å¤§ç›¤è§€é»']) tOver += `<div class="hl-block"><b>ğŸ“Š å¤§ç›¤è§€é»</b><br>${fmtTxt(r['å¤§ç›¤è§€é»'])}</div>`;
    if(r['æŒ‡æ•¸é æ¸¬å€é–“_ä½'] && r['æŒ‡æ•¸é æ¸¬å€é–“_é«˜']) {
        tOver += `<div class="rating-card"><div class="label">æŒ‡æ•¸é æ¸¬å€é–“</div><div class="big-num">${r['æŒ‡æ•¸é æ¸¬å€é–“_ä½']} ~ ${r['æŒ‡æ•¸é æ¸¬å€é–“_é«˜']}</div></div>`;
    }
    if(r['ç¸½ç¶“è§€é»æ‘˜è¦']) tOver += `<div class="hl-block"><b>ğŸŒ ç¸½ç¶“è§€é»</b><br>${fmtTxt(r['ç¸½ç¶“è§€é»æ‘˜è¦'])}</div>`;
    if(r['åŸºæœ¬é¢è§€é»']) tOver += `<div class="hl-block"><b>ğŸ“ˆ åŸºæœ¬é¢è§€é»</b><br>${fmtTxt(r['åŸºæœ¬é¢è§€é»'])}</div>`;
    if(r['é¡Œæé¢è§€é»']) tOver += `<div class="hl-block"><b>ğŸ¯ é¡Œæé¢è§€é»</b><br>${fmtTxt(r['é¡Œæé¢è§€é»'])}</div>`;

    // Tab 2: ç¸½ç¶“åˆ†æ
    let tMacro = '';
    macro.forEach(m => {
        tMacro += `<div class="section-head">${m['åˆ†æä¸»é¡Œ']||'ç¸½ç¶“åˆ†æ'}</div>`;
        tMacro += `<div class="hl-block">${fmtTxt(m['åˆ†æå…§å®¹'])}</div>`;
        if(m['æ•¸æ“šæŒ‡æ¨™']) tMacro += `<div class="info-row"><span class="info-label">${m['æ•¸æ“šæŒ‡æ¨™']}</span><span class="info-val">${m['æ•¸æ“šå€¼']} ${m['æ•¸æ“šå–®ä½']||''}</span></div>`;
    });
    if(!tMacro) tMacro = '<div style="color:#999;text-align:center;padding:20px">ç„¡ç¸½ç¶“åˆ†æ</div>';

    // Tab 3: åŸºæœ¬é¢
    let tFund = '';
    fund.forEach(f => {
        tFund += `<div class="section-head">${f['åˆ†æä¸»é¡Œ']||'åŸºæœ¬é¢åˆ†æ'}</div>`;
        tFund += `<div class="hl-block">${fmtTxt(f['åˆ†æå…§å®¹'])}</div>`;
    });
    if(!tFund) tFund = '<div style="color:#999;text-align:center;padding:20px">ç„¡åŸºæœ¬é¢åˆ†æ</div>';

    // Tab 4: é¡Œæ
    let tTheme = '';
    theme.forEach(t => {
        tTheme += `<div class="section-head">${t['é¡Œæä¸»é¡Œ']||'é¡Œæè¶¨å‹¢'}</div>`;
        tTheme += `<div class="hl-block">${fmtTxt(t['é¡Œæå…§å®¹'])}</div>`;
    });
    // åŠ å…¥å­£åº¦è¡Œæƒ…
    if(quarter.length) {
        tTheme += `<div class="section-head">ğŸ“… å­£åº¦è¡Œæƒ…è¦åŠƒ</div>`;
        quarter.forEach(q => {
            tTheme += `<div class="list-item">
                <div class="list-title">${q['å­£åº¦']}</div>
                <div style="font-size:12px;color:#666">æŒ‡æ•¸é æ¸¬: ${q['æŒ‡æ•¸é æ¸¬_ä½']} ~ ${q['æŒ‡æ•¸é æ¸¬_é«˜']}</div>
                <div style="font-size:12px;margin-top:5px"><span style="color:#27ae60">åˆ©å¤š:</span> ${[q['åˆ©å¤šå› ç´ 1'],q['åˆ©å¤šå› ç´ 2'],q['åˆ©å¤šå› ç´ 3']].filter(i=>i).join('ã€')}</div>
                <div style="font-size:12px"><span style="color:#e74c3c">åˆ©ç©º:</span> ${[q['åˆ©ç©ºå› ç´ 1'],q['åˆ©ç©ºå› ç´ 2'],q['åˆ©ç©ºå› ç´ 3']].filter(i=>i).join('ã€')}</div>
            </div>`;
        });
    }
    if(!tTheme) tTheme = '<div style="color:#999;text-align:center;padding:20px">ç„¡é¡Œæåˆ†æ</div>';

    // Tab 5: é¸è‚¡
    let tPick = '';
    if(picks.length) {
        // æŒ‰ç”¢æ¥­åˆ†é¡
        const byInd = {};
        picks.forEach(p => {
            const cat = p['ç”¢æ¥­é¡åˆ¥'] + '/' + p['ç”¢æ¥­åˆ†é¡'];
            if(!byInd[cat]) byInd[cat] = [];
            byInd[cat].push(p);
        });
        Object.keys(byInd).forEach(cat => {
            tPick += `<div class="section-head">${cat}</div>`;
            byInd[cat].forEach(p => {
                tPick += `<div class="list-item" onclick="openStock('${p['è‚¡ç¥¨ä»£è™Ÿ']}')">
                    <div class="list-title">${p['å…¬å¸åç¨±']} <span style="color:#999">${p['è‚¡ç¥¨ä»£è™Ÿ']}</span></div>
                    <div class="list-sub">${p['æŠ•è³‡é¡Œæ']||''}</div>
                    ${p['å‚™è¨»']?`<div style="font-size:12px;color:#666">${p['å‚™è¨»']}</div>`:''}
                </div>`;
            });
        });
    } else {
        tPick = '<div style="color:#999;text-align:center;padding:20px">ç„¡é¸è‚¡ç­–ç•¥</div>';
    }

    $('m-body').innerHTML = `
        <div id="tab-over" class="tab-pane active">${tOver}</div>
        <div id="tab-macro" class="tab-pane">${tMacro}</div>
        <div id="tab-fund" class="tab-pane">${tFund}</div>
        <div id="tab-theme" class="tab-pane">${tTheme}</div>
        <div id="tab-pick" class="tab-pane">${tPick}</div>
    `;
    showModal(infoHtml, navItems);
};

// ============ é–‹å•Ÿç”¢æ¥­è¶¨å‹¢ ============
window.openTrend = indName => {
    const t = DB.trends.find(i => i['ç”¢æ¥­'] === indName);
    if(!t) return;

    const infoHtml = `
        <div style="font-size:20px;font-weight:700;margin-bottom:5px">${t['ç”¢æ¥­']}</div>
        <div class="card-meta">
            <span class="tag trend-up">${t['è¶¨å‹¢åˆ¤æ–·']}</span>
            <span class="tag ind">${t['æ™¯æ°£ä½ç½®']}</span>
        </div>
    `;

    let content = `
        <div class="info-row"><span class="info-label">ä»£è¡¨å…¬å¸</span><span class="info-val tag-link" onclick="openStock('${t['è‚¡è™Ÿ']}')">${t['ä»£è¡¨å…¬å¸']} ${t['è‚¡è™Ÿ']}</span></div>
        <div class="section-head">ğŸš€ é—œéµé©…å‹•å› ç´ </div>
        <div class="hl-block">${fmtTxt(t['é—œéµé©…å‹•å› ç´ '])}</div>
        <div class="section-head">âš ï¸ é¢¨éšªå› ç´ </div>
        <div class="hl-block" style="border-left-color:#e74c3c">${fmtTxt(t['é¢¨éšªå› ç´ '])}</div>
        <div class="section-head">ğŸ”® 2026å±•æœ›</div>
        <div class="hl-block">${fmtTxt(t['2026å±•æœ›'])}</div>
        <div class="section-head">ğŸ’¡ æŠ•è³‡å»ºè­°</div>
        <div class="hl-block">${fmtTxt(t['æŠ•è³‡å»ºè­°'])}</div>
    `;

    $('m-body').innerHTML = `<div id="tab-main" class="tab-pane active">${content}</div>`;
    showModal(infoHtml, []);
};

// ============ é–‹å•Ÿå¤–é›» ============
window.openNews = id => {
    const n = DB.news.find(i => String(i['ç·¨è™Ÿ']) === String(id));
    if(!n) return;

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;margin-bottom:5px">${n['å…¬å¸']} <span style="color:#999;font-size:14px">${n['è‚¡è™Ÿ']}</span></div>
        <div class="card-meta">
            <span class="tag ind">${n['å ±å°é‡é»åˆ†é¡']}</span>
            <span class="tag dt">${fmtDate(n['æ—¥æœŸ'])}</span>
        </div>
        <div style="font-size:12px;color:#666;margin-top:5px">ä¾†æº: ${n['åˆ¸å•†ä¾†æº']||'-'} | ${n['é‡è¦æ€§']||''}</div>
    `;

    const content = `<div class="hl-block">${fmtTxt(n['å®Œæ•´å ±å°å…§å®¹'])}</div>`;
    if(n['æ¨™ç±¤']) {
        content += `<div style="margin-top:15px;display:flex;flex-wrap:wrap;gap:5px">`;
        safe(n['æ¨™ç±¤']).split(/[,ï¼Œ\s]+/).forEach(tag => {
            if(tag) content += `<span class="tag concept" style="cursor:pointer" onclick="setSearch('${tag}');closeModal()">${tag}</span>`;
        });
        content += `</div>`;
    }

    $('m-body').innerHTML = `<div id="tab-main" class="tab-pane active">${content}</div>`;
    showModal(infoHtml, []);
};

window.onload = init;
</script>
</body>
</html>
