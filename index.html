<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</title>
    
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        if (typeof XLSX === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>');
        }
    </script>

    <style>
        /* ===== å…¨åŸŸè¨­å®š ===== */
        :root {
            --primary: #c96442;
            --bg: #f5f4ef;
            --card-bg: #ffffff;
            --text-main: #2d2d2d;
            --text-sub: #6b6b6b;
            --border: #e5e3dc;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text-main); padding-bottom: 50px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 12px; }
        
        /* Loading Screen */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .splash-icon { font-size: 48px; margin-bottom: 20px; animation: bounce 2s infinite; }
        .splash-title { font-size: 18px; font-weight: 700; margin-bottom: 5px; }
        .splash-subtitle { font-size: 13px; color: var(--text-sub); margin-bottom: 20px; }
        .splash-progress-track { width: 200px; height: 4px; background: #ddd; border-radius: 2px; overflow: hidden; }
        .splash-progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* Header */
        .header { text-align: center; padding: 20px 0; border-bottom: 1px solid var(--border); margin-bottom: 15px; }
        .header h1 { font-size: 22px; color: var(--primary); }
        .header .subtitle { font-size: 12px; color: var(--text-sub); }

        /* Tabs */
        .db-switcher { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: 15px; }
        .db-tab { padding: 6px 14px; border: 1px solid var(--border); background: #fff; border-radius: 20px; font-size: 13px; color: var(--text-sub); cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .db-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .db-tab .count { font-size: 10px; background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 10px; }

        /* Search */
        .search-section { background: #fff; border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .main-search input { width: 100%; padding: 12px 12px 12px 40px; border: 2px solid var(--border); border-radius: 25px; background: #fafaf8; font-size: 15px; }
        .main-search { position: relative; margin-bottom: 10px; }
        .main-search::before { content: "ğŸ”"; position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #999; }
        
        /* Filters */
        .hot-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
        .hot-tag { padding: 4px 10px; background: #fff3e6; color: #c96442; border-radius: 8px; font-size: 12px; border: none; cursor: pointer; }
        .filter-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        .filter-select select { padding: 8px; border-radius: 10px; border: 1px solid var(--border); background: #fff; font-size: 12px; }
        .clear-btn { color: #d64545; background: none; border: 1px solid #d64545; padding: 8px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; white-space: nowrap; }

        /* Card List */
        .card-base { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; transition: transform 0.2s; }
        .card-base:active { transform: scale(0.98); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .company-name { font-size: 16px; font-weight: 700; color: #333; }
        .stock-code { font-size: 12px; color: #888; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        .rating-stars { color: #f39c12; font-size: 12px; letter-spacing: 1px; }
        
        .card-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
        .tag { font-size: 11px; padding: 3px 8px; border-radius: 6px; color: #fff; font-weight: 500; }
        .tag.broker { background: #c96442; }
        .tag.ind { background: #5a9e6f; }
        .tag.date { background: #e0e0e0; color: #555; }
        .tag.rating { background: #9b59b6; }
        .tag.trend { background: #e67e22; }

        .card-content { font-size: 13px; color: #555; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* Modal Style (é‚„åŸæˆªåœ–é¢¨æ ¼) */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: flex-end; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #fff; width: 100%; max-width: 600px; height: 90vh; margin: 0 auto; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: flex-start; }
        .modal-close { background: #f0f0f0; border: none; width: 30px; height: 30px; border-radius: 50%; font-size: 20px; color: #666; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .modal-body { flex: 1; overflow-y: auto; padding: 15px; background: #fafaf8; }
        
        /* Modal Tabs */
        .modal-tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .m-tab { padding: 6px 12px; background: #fff; border: 1px solid #eee; border-radius: 8px; font-size: 13px; font-weight: 600; color: #666; white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .m-tab.active { background: #fff3e6; color: #c96442; border-color: #c96442; }
        .m-tab-icon { font-size: 14px; }

        /* 6æ ¼è³‡è¨Šæ–¹å¡Š (æˆªåœ–2) */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: #fff; padding: 12px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .stat-label { font-size: 12px; color: #888; margin-bottom: 4px; }
        .stat-value { font-size: 14px; font-weight: 700; color: #333; }
        .stat-value.large { font-size: 18px; }
        .stat-value.green { color: #27ae60; }
        .stat-value.red { color: #e74c3c; }

        /* å½©è‰²å€å¡Šé‡é» (æˆªåœ–1) */
        .highlight-block { background: #fff; border-radius: 10px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .hb-title { font-weight: 700; font-size: 15px; margin-bottom: 6px; color: #333; }
        .hb-content { font-size: 13px; color: #555; line-height: 1.6; }
        .hb-orange { border-left-color: #e67e22; }
        .hb-green { border-left-color: #27ae60; }
        .hb-blue { border-left-color: #3498db; }
        
        /* åˆ—è¡¨é …ç›® (æˆªåœ–3) */
        .list-row { background: #fff; padding: 12px; border-radius: 10px; margin-bottom: 8px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .lr-main { font-weight: 600; font-size: 14px; }
        .lr-sub { font-size: 11px; color: #888; margin-top: 2px; }
        
        .section-header { font-size: 14px; font-weight: 700; margin: 20px 0 10px; color: #c96442; display: flex; align-items: center; gap: 5px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        @media (min-width: 768px) {
            .modal-overlay.active { align-items: center; justify-content: center; }
            .modal-content { height: 80vh; border-radius: 20px; }
        }
    </style>
</head>
<body>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="splash-content">
            <div class="splash-icon">ğŸ“Š</div>
            <h2 class="splash-title" id="loadingMain">ç³»çµ±å•Ÿå‹•ä¸­...</h2>
            <p class="splash-subtitle" id="loadingSub">æ­£åœ¨åŒæ­¥ Rexå¤§å”è³‡æ–™åº«</p>
            <div class="splash-progress-track"><div class="splash-progress-bar" id="loadingProgressBar"></div></div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
            <p class="subtitle">åˆ¸å•†ç ”ç©¶å ±å‘Š Ã— å¤–é›»å¿«å ± Ã— Call Memo Ã— æŠ•è³‡ç­–ç•¥</p>
        </div>

        <div class="db-switcher">
            <button class="db-tab active" onclick="switchDB('news')">âš¡ å¤–é›»å ±å° <span class="count" id="cnt-news">0</span></button>
            <button class="db-tab" onclick="switchDB('memo')">ğŸ“‹ å ±å‘ŠMemo <span class="count" id="cnt-memo">0</span></button>
            <button class="db-tab" onclick="switchDB('reports')">ğŸ“‘ ç”¢æ¥­å ±å‘Š <span class="count" id="cnt-rep">0</span></button>
            <button class="db-tab" onclick="switchDB('strategy')">ğŸ¯ æŠ•è³‡å±•æœ› <span class="count" id="cnt-strat">0</span></button>
            <button class="db-tab" onclick="switchDB('trends')">ğŸ“ˆ ç”¢æ¥­è¶¨å‹¢ <span class="count" id="cnt-trend">0</span></button>
            <button class="db-tab" onclick="switchDB('industry')">ğŸ­ ç”¢æ¥­å‹•æ…‹ <span class="count" id="cnt-ind">0</span></button>
            <button class="db-tab" onclick="switchDB('stocks')">ğŸ¢ å€‹è‚¡æŸ¥è©¢ <span class="count" id="cnt-stk">0</span></button>
            <button class="db-tab" onclick="switchDB('cb')">ğŸ« CBçµ±è¨ˆ <span class="count" id="cnt-cb">0</span></button>
        </div>

        <div class="search-section">
            <div class="main-search">
                <input type="text" id="searchInput" placeholder="æœå°‹å…¬å¸åç¨±ã€è‚¡è™Ÿã€æ¨™ç±¤...">
                <div class="search-suggestions" id="suggestions"></div>
            </div>
            <div class="hot-tags" id="hotTags"></div>
            <div class="filter-row">
                <div class="filter-select"><select id="f-broker"><option value="">æ‰€æœ‰åˆ¸å•†</option></select></div>
                <div class="filter-select"><select id="f-cat"><option value="">æ‰€æœ‰åˆ†é¡</option></select></div>
                <button class="clear-btn" onclick="resetFilters()">æ¸…é™¤ç¯©é¸</button>
            </div>
        </div>

        <div class="stats-bar">
            <span>æ‰¾åˆ° <strong id="res-count">0</strong> ç­†çµæœ</span>
        </div>

        <div class="reports-list" id="mainList"></div>
    </div>

    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div id="m-header-info"></div>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body" id="m-body"></div>
        </div>
    </div>

    <script>
    // Config
    const FILES = {
        NEWS: '01_news.xlsx', MEMO: '02_memo.xlsx', REPORTS: '03_reports.xlsx',
        MASTER: '04_master.xlsx', STRATEGY: '05_Strategy.xlsx', CB: '00_CB.xlsx', REV: '06_revenue.xlsx'
    };

    // Data Stores
    let dataStore = { news: [], memo: [], reports: [], strategy: [], trends: [], industry: [], stocks: {}, cb: [] };
    let details = { memo: {}, reports: {}, strategy: {} };
    let meta = { tracking: {}, finance: {}, products: {}, timeline: [], revenue: {}, cbs: {} };
    let currentDB = 'news';
    let filters = { search: '', broker: '', cat: '' };

    // --- Helpers ---
    const $ = id => document.getElementById(id);
    const safe = v => (v === undefined || v === null) ? '' : String(v).trim();
    const dateFmt = v => {
        if(!v) return '';
        if(typeof v === 'number') {
            const d = new Date((v-25569)*86400000);
            return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
        }
        return v;
    };
    const updateLoad = (t, s, p) => {
        $('loadingMain').innerText = t; $('loadingSub').innerText = s; $('loadingProgressBar').style.width = p+'%';
    };

    // --- Loaders ---
    async function loadAll() {
        try {
            updateLoad('è®€å–å¤–é›»å¿«å ±...', 'åŒæ­¥åœ‹éš›é‡‘èè³‡è¨Š', 10);
            await loadNews();
            
            updateLoad('è§£æç ”ç©¶å ±å‘Š...', 'å½™æ•´åˆ¸å•† Memo', 30);
            await loadMemo();
            await loadReports();
            
            updateLoad('è¼‰å…¥å¸‚å ´è³‡æ–™...', 'å»ºç«‹å€‹è‚¡ç´¢å¼•', 60);
            await loadMaster();
            await loadStrategy();
            await loadCB();
            await loadRevenue();

            updateLoad('å®Œæˆ', 'å•Ÿå‹•ä¸­...', 100);
            initUI();
            
            setTimeout(() => {
                $('loadingOverlay').classList.add('hidden');
                renderList();
            }, 500);
        } catch(e) {
            console.error(e);
            $('loadingMain').innerText = 'è¼‰å…¥å¤±æ•—';
            $('loadingSub').innerText = e.message;
            $('loadingProgressBar').style.background = '#e74c3c';
        }
    }

    async function fetchXlsx(url) {
        const res = await fetch(url);
        if(!res.ok) throw new Error(url + ' not found');
        return XLSX.read(await res.arrayBuffer(), {type:'array'});
    }

    async function loadNews() {
        const wb = await fetchXlsx(FILES.NEWS);
        XLSX.utils.sheet_to_json(wb.Sheets['å¤–é›»ç¶œåˆå ±å°']||[]).forEach(r => {
            if(safe(r['è³‡æ–™é¡å‹']) === 'å€‹è‚¡å ±å°') {
                dataStore.news.push({ id:safe(r['ç·¨è™Ÿ']), date:safe(r['æ—¥æœŸ']), company:safe(r['å…¬å¸']), code:safe(r['è‚¡è™Ÿ']), broker:safe(r['åˆ¸å•†ä¾†æº']), cat:safe(r['å ±å°é‡é»åˆ†é¡']), imp:safe(r['é‡è¦æ€§']), tags:safe(r['æ¨™ç±¤']), content:safe(r['å®Œæ•´å ±å°å…§å®¹']) });
            } else if(safe(r['è³‡æ–™é¡å‹']) === 'ç”¢æ¥­è¶¨å‹¢') {
                dataStore.trends.push({ id:safe(r['ç·¨è™Ÿ']), date:safe(r['æ—¥æœŸ']), topic:safe(r['å…¬å¸']), broker:safe(r['åˆ¸å•†ä¾†æº']), content:safe(r['å®Œæ•´å ±å°å…§å®¹']), rel:safe(r['è‚¡è™Ÿ']) });
            }
        });
    }

    async function loadMemo() {
        const wb = await fetchXlsx(FILES.MEMO);
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¡¨']||[]).forEach(r => {
            dataStore.memo.push({ id:safe(r['ç·¨è™Ÿ']), date:safe(r['æ—¥æœŸ']), company:safe(r['å…¬å¸']), code:safe(r['è‚¡è™Ÿ']), broker:safe(r['åˆ¸å•†']), type:safe(r['å ±å‘Šé¡å‹']), imp:safe(r['é‡è¦æ€§']), ind:safe(r['ç”¢æ¥­']), revY:safe(r['ç‡Ÿæ”¶YoY']), gm:safe(r['æ¯›åˆ©ç‡']), eps:safe(r['EPS']) });
        });
        XLSX.utils.sheet_to_json(wb.Sheets['è©³ç´°å…§å®¹åº«']||[]).forEach(r => details.memo[safe(r['ç·¨è™Ÿ'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['å…¬å¸è¿½è¹¤è¡¨']||[]).forEach(r => meta.tracking[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['è²¡å‹™æ•¸æ“šå½™ç¸½']||[]).forEach(r => meta.finance[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢å“çµæ§‹åˆ†æ']||[]).forEach(r => meta.products[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['é—œéµæ™‚ç¨‹è¿½è¹¤']||[]).forEach(r => meta.timeline.push(r));
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢æ¥­è¶¨å‹¢ç¸½è¦½']||[]).forEach(r => dataStore.industry.push(r));
    }

    async function loadReports() {
        const wb = await fetchXlsx(FILES.REPORTS);
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r => {
            dataStore.reports.push({ id:safe(r['å ±å‘Šç·¨è™Ÿ']), broker:safe(r['åˆ¸å•†åç¨±']), date:dateFmt(r['å ±å‘Šæ—¥æœŸ']), title:safe(r['å ±å‘Šæ¨™é¡Œ']), ind:safe(r['ç”¢æ¥­åç¨±']), highlights:[r['æ ¸å¿ƒé‡é»1'],r['æ ¸å¿ƒé‡é»2']] });
        });
        XLSX.utils.sheet_to_json(wb.Sheets['ç„¦é»åˆ†æå…§å®¹']||[]).forEach(r => {
            const id = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(!details.reports[id]) details.reports[id] = [];
            details.reports[id].push(r);
        });
    }

    async function loadMaster() {
        const wb = await fetchXlsx(FILES.MASTER);
        XLSX.utils.sheet_to_json(wb.Sheets['ä¸»è³‡æ–™åº«']||[]).forEach(r => {
            if(r['ä»£è™Ÿ']) {
                const c = safe(r['ä»£è™Ÿ']);
                dataStore.stocks[c] = { code:c, name:safe(r['å…¬å¸åç¨±']), price:safe(r['æˆäº¤']), chg:safe(r['æ¼²è·Œå¹…']), ind:safe(r['ç”¢æ¥­åˆ†é¡']), sub:safe(r['ç”¢æ¥­ç´°åˆ†']), mkt:safe(r['å¸‚å ´åˆ†é¡']), cap:safe(r['å¸‚å€¼(å„„)']), biz:safe(r['æ¥­å‹™æ‘˜è¦']) };
                // Also index by name
                dataStore.stocks[safe(r['å…¬å¸åç¨±'])] = dataStore.stocks[c];
            }
        });
    }

    async function loadStrategy() {
        const wb = await fetchXlsx(FILES.STRATEGY);
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r => dataStore.strategy.push(r));
        XLSX.utils.sheet_to_json(wb.Sheets['é¡Œæèˆ‡è¶¨å‹¢']||[]).forEach(r => {
            const id = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(!details.strategy[id]) details.strategy[id] = [];
            details.strategy[id].push(r);
        });
    }

    async function loadCB() {
        const wb = await fetchXlsx(FILES.CB);
        XLSX.utils.sheet_to_json(wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™']||[]).forEach(r => {
            const sc = safe(r['è½‰æ›æ¨™çš„ä»£ç¢¼']);
            const item = { code:safe(r['ä»£è™Ÿ']), name:safe(r['åç¨±']), sc:sc, sn:safe(r['è½‰æ›æ¨™çš„åç¨±']), price:r['è½‰æ›åƒ¹æ ¼(å…ƒ)'], remain:r['æœ€æ–°é¤˜é¡(ç™¾è¬)'], date:dateFmt(r['åˆ°æœŸæ—¥']) };
            dataStore.cb.push(item);
            if(!meta.cbs[sc]) meta.cbs[sc] = [];
            meta.cbs[sc].push(item);
        });
    }

    async function loadRevenue() {
        const wb = await fetchXlsx(FILES.REV);
        const rows = XLSX.utils.sheet_to_json(wb.Sheets['000_æœˆç‡Ÿæ”¶']||[]);
        const headers = Object.keys(rows[0]||{}).filter(k=>k.includes('å–®æœˆç‡Ÿæ”¶'));
        rows.forEach(r => {
            const c = safe(r['ä»£è™Ÿ']);
            meta.revenue[c] = headers.slice(-12).map(h => ({ period:h.replace('å–®æœˆç‡Ÿæ”¶(å„„)',''), val:r[h] }));
        });
    }

    // --- UI Logic ---
    function initUI() {
        // Build filters and counts
        const updateCount = (id, arr) => $(id).innerText = arr.length || Object.keys(arr).length;
        updateCount('cnt-news', dataStore.news);
        updateCount('cnt-memo', dataStore.memo);
        updateCount('cnt-rep', dataStore.reports);
        updateCount('cnt-strat', dataStore.strategy);
        updateCount('cnt-trend', dataStore.trends);
        updateCount('cnt-ind', dataStore.industry);
        updateCount('cnt-stk', Object.keys(dataStore.stocks));
        updateCount('cnt-cb', dataStore.cb);

        // Simple Broker Filter
        const brokers = [...new Set([...dataStore.news.map(x=>x.broker), ...dataStore.memo.map(x=>x.broker)])].sort();
        $('f-broker').innerHTML = '<option value="">æ‰€æœ‰åˆ¸å•†</option>' + brokers.map(b=>`<option value="${b}">${b}</option>`).join('');
        
        $('searchInput').addEventListener('input', (e) => { filters.search = e.target.value.toLowerCase(); renderList(); });
    }

    function switchDB(db) {
        currentDB = db;
        document.querySelectorAll('.db-tab').forEach(t => t.classList.remove('active'));
        event.currentTarget.classList.add('active');
        renderList();
    }

    function renderList() {
        const list = $('mainList');
        list.innerHTML = '';
        let items = [];
        
        // Data Selection
        if(currentDB === 'news') items = dataStore.news;
        else if(currentDB === 'memo') items = dataStore.memo;
        else if(currentDB === 'reports') items = dataStore.reports;
        else if(currentDB === 'stocks') items = Object.values(dataStore.stocks);
        // ... (add other DBs logic as needed)

        // Filtering
        let filtered = items.filter(i => {
            const str = JSON.stringify(i).toLowerCase();
            return !filters.search || str.includes(filters.search);
        });

        $('res-count').innerText = filtered.length;

        // Rendering Cards
        list.innerHTML = filtered.slice(0, 50).map(item => {
            if(currentDB === 'news') {
                return createCard(item.id, item.company, item.broker, item.date, item.cat, item.imp, item.content, 'news');
            } else if(currentDB === 'memo') {
                const tr = meta.tracking[item.company] || {};
                return createCard(item.id, `${item.company} (${item.code})`, item.broker, item.date, item.type, item.imp, 
                    `${tr.rating || ''} ${tr.targetPrice ? 'ç›®æ¨™:'+tr.targetPrice : ''} | ç‡Ÿæ”¶YoY: ${item.revY||'-'}`, 'memo');
            } else if(currentDB === 'stocks') {
                return `<div class="card-base" onclick="openStockModal('${item.code}')">
                    <div class="card-header"><span class="company-name">${item.name} <span class="stock-code">${item.code}</span></span><span style="font-weight:bold">${item.price}</span></div>
                    <div class="card-tags"><span class="tag ind">${item.ind}</span><span class="tag date">${item.mkt}</span></div>
                    <div class="card-content">${item.biz || ''}</div>
                </div>`;
            }
            return '';
        }).join('');
    }

    function createCard(id, title, broker, date, tag1, stars, content, type) {
        return `<div class="card-base" onclick="open${type==='news'?'News':'Memo'}Modal('${id}')">
            <div class="card-header">
                <span class="company-name">${title}</span>
                <span class="rating-stars">${stars||''}</span>
            </div>
            <div class="card-tags">
                <span class="tag broker">${broker}</span>
                <span class="tag date">${date}</span>
                ${tag1 ? `<span class="tag ind">${tag1}</span>` : ''}
            </div>
            <div class="card-content">${content}</div>
        </div>`;
    }

    // ===== MODAL LOGIC (The Visual Upgrade) =====
    
    // Helper for highlighted blocks (Image 1 Style)
    function parseHighlights(text) {
        if(!text) return '<p style="color:#999">æš«ç„¡è³‡æ–™</p>';
        const lines = text.split(/[;ï¼›]/);
        let html = '';
        lines.forEach(line => {
            const parts = line.split(/[:ï¼š]/);
            if(parts.length > 1 && parts[0].length < 20) {
                // Determine color based on keyword
                let colorClass = 'hb-blue';
                if(parts[0].includes('æˆé•·') || parts[0].includes('ç‡Ÿæ”¶')) colorClass = 'hb-green';
                if(parts[0].includes('é¢¨éšª') || parts[0].includes('å±•æœ›')) colorClass = 'hb-orange';
                
                html += `<div class="highlight-block ${colorClass}">
                    <div class="hb-title">${parts[0].trim()}</div>
                    <div class="hb-content">${parts[1].trim()}</div>
                </div>`;
            } else {
                if(line.trim()) html += `<div style="margin-bottom:8px;padding:8px;background:#fff;border-radius:8px;">${line.trim()}</div>`;
            }
        });
        return html;
    }

    // 1. Call Memo Modal (Refined to match Image 2)
    window.openMemoModal = (id) => {
        const item = dataStore.memo.find(x => x.id === id);
        if(!item) return;
        const det = details.memo[id] || {};
        const tr = meta.tracking[item.company] || {};
        const fin = meta.finance[item.company] || {};
        
        const title = `${item.company} <span style="font-size:14px;color:#666">(${item.code})</span>`;
        const tagsHtml = `<span class="tag broker">${item.broker}</span> <span class="tag ind">${item.ind}</span> <span class="tag date">${item.date}</span> <span class="tag rating">${tr.rating||'æœªè©•ç­‰'}</span>`;
        
        $('m-header-info').innerHTML = `<div style="font-size:20px;font-weight:700;margin-bottom:5px;">${title}</div><div>${tagsHtml}</div>`;
        
        let html = `
        <div class="modal-tabs">
            <div class="m-tab active" onclick="setTab(this, 't-total')">ğŸ“Š ç¸½è¦½</div>
            <div class="m-tab" onclick="setTab(this, 't-op')">ğŸ¯ ç‡Ÿé‹é‡é»</div>
            <div class="m-tab" onclick="setTab(this, 't-fin')">ğŸ’° è²¡å‹™æ•¸æ“š</div>
        </div>

        <div id="t-total" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-label">ç‡Ÿæ”¶YoY</div><div class="stat-value ${item.revY.includes('+')?'green':''}">${item.revY||'-'}</div></div>
                <div class="stat-box"><div class="stat-label">æ¯›åˆ©ç‡</div><div class="stat-value">${item.gm||'-'}</div></div>
                <div class="stat-box"><div class="stat-label">EPS</div><div class="stat-value">${item.eps||'-'}</div></div>
                <div class="stat-box"><div class="stat-label">æŠ•è³‡è©•ç­‰</div><div class="stat-value">${tr.rating||'-'}</div></div>
                <div class="stat-box"><div class="stat-label">ç›®æ¨™åƒ¹</div><div class="stat-value large green">${tr.targetPrice||'-'}</div></div>
                <div class="stat-box"><div class="stat-label">è¿½è¹¤ç‹€æ…‹</div><div class="stat-value">${tr.trackStatus||'-'}</div></div>
            </div>
            
            ${det.tags ? `<div class="section-header">ğŸ·ï¸ æ¨™ç±¤</div><div class="hot-tags">${det.tags.split('#').filter(t=>t).map(t=>`<span class="hot-tag">#${t.trim()}</span>`).join('')}</div>` : ''}
            
            ${det.followUp ? `<div class="section-header">ğŸ”” å¾ŒçºŒè¿½è¹¤</div><div style="background:#fff8e1;padding:15px;border-radius:10px;border-left:4px solid #ffc107;">${det.followUp.replace(/\n/g,'<br>')}</div>` : ''}
        </div>

        <div id="t-op" class="tab-content">
            ${parseHighlights(det.operation)}
            ${det.strategy ? `<div class="section-header">ğŸš€ ç­–ç•¥æ–¹å‘</div>${parseHighlights(det.strategy)}` : ''}
        </div>

        <div id="t-fin" class="tab-content">
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-label">3Q25ç‡Ÿæ”¶</div><div class="stat-value">${fin['3Q25ç‡Ÿæ”¶']||'-'}</div></div>
                <div class="stat-box"><div class="stat-label">ç¨…å¾Œæ·¨åˆ©</div><div class="stat-value">${fin['ç¨…å¾Œæ·¨åˆ©']||'-'}</div></div>
            </div>
            ${fin['4Q25æŒ‡å¼•'] ? `<div class="section-header">ğŸ“ˆ 4Q25æŒ‡å¼•</div><div class="highlight-block hb-blue"><div class="hb-content">${fin['4Q25æŒ‡å¼•']}</div></div>` : ''}
        </div>
        `;
        
        $('m-body').innerHTML = html;
        $('modalOverlay').classList.add('active');
    };

    // 2. Stock Modal (Refined to match Image 3)
    window.openStockModal = (code) => {
        const stock = dataStore.stocks[code] || dataStore.stocks[Object.keys(dataStore.stocks).find(k => dataStore.stocks[k].name === code)];
        if(!stock) return alert('ç„¡æ­¤å€‹è‚¡è³‡æ–™');
        
        // Find related reports
        const relatedMemo = dataStore.memo.filter(m => m.code === stock.code || m.company === stock.name);
        const relatedNews = dataStore.news.filter(n => n.code === stock.code || n.company === stock.name);
        
        $('m-header-info').innerHTML = `
            <div style="font-size:20px;font-weight:700;margin-bottom:5px;">${stock.name} (${stock.code})</div>
            <div class="card-tags"><span class="tag ind">${stock.ind}</span><span class="tag date">${stock.mkt}</span></div>
            <div style="font-size:13px;color:#666;margin-top:5px;">${stock.biz.substring(0,60)}...</div>
        `;

        let html = `
        <div class="modal-tabs">
            <div class="m-tab active" onclick="setTab(this, 's-base')">ğŸ“Š åŸºæœ¬è³‡æ–™</div>
            <div class="m-tab" onclick="setTab(this, 's-rev')">ğŸ’° è²¡å‹™æ•¸æ“š</div>
            <div class="m-tab" onclick="setTab(this, 's-rep')">ğŸ“‘ ç›¸é—œå ±å‘Š (${relatedMemo.length + relatedNews.length})</div>
        </div>

        <div id="s-base" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-label">è‚¡åƒ¹</div><div class="stat-value large">${stock.price}</div></div>
                <div class="stat-box"><div class="stat-label">æ¼²è·Œå¹…</div><div class="stat-value ${stock.chg.includes('-')?'green':'red'}">${stock.chg}</div></div>
                <div class="stat-box"><div class="stat-label">å¸‚å€¼</div><div class="stat-value">${stock.cap}å„„</div></div>
            </div>
            
            ${meta.cbs[stock.code] ? `
                <div class="section-header">ğŸ« å¯è½‰å‚µ</div>
                ${meta.cbs[stock.code].map(cb => `
                    <div class="list-row" style="border-left:3px solid #e74c3c;">
                        <div>
                            <div class="lr-main">${cb.name} (${cb.code})</div>
                            <div class="lr-sub">åˆ°æœŸæ—¥: ${cb.date}</div>
                        </div>
                        <div style="text-align:right">
                            <div class="lr-main">è½‰${cb.price}</div>
                            <div class="lr-sub">é¤˜${cb.remain}</div>
                        </div>
                    </div>
                `).join('')}
            ` : ''}
        </div>

        <div id="s-rev" class="tab-content">
            ${meta.revenue[stock.code] ? `
                <table style="width:100%;font-size:13px;border-collapse:collapse;margin-top:10px;">
                    <tr style="background:#f8f8f8;text-align:left;"><th style="padding:8px;">æœˆä»½</th><th style="padding:8px;text-align:right;">ç‡Ÿæ”¶(å„„)</th></tr>
                    ${meta.revenue[stock.code].map(r => `<tr><td style="padding:8px;border-bottom:1px solid #eee;">${r.period}</td><td style="padding:8px;border-bottom:1px solid #eee;text-align:right;font-weight:bold;">${r.val}</td></tr>`).join('')}
                </table>
            ` : '<div style="text-align:center;padding:20px;color:#999;">æš«ç„¡ç‡Ÿæ”¶è³‡æ–™</div>'}
        </div>

        <div id="s-rep" class="tab-content">
            <div class="section-header">Call Memo</div>
            ${relatedMemo.map(m => `
                <div class="list-row" onclick="openMemoModal('${m.id}')">
                    <div><div class="lr-main">${m.type}</div><div class="lr-sub">${m.date} | ${m.broker}</div></div>
                    <div style="font-size:20px;color:#ddd;">â€º</div>
                </div>
            `).join('')}
            
            <div class="section-header" style="margin-top:20px;">å¤–é›»å ±å°</div>
            ${relatedNews.map(n => `
                <div class="list-row" onclick="openNewsModal('${n.id}')">
                    <div><div class="lr-main">${n.cat}</div><div class="lr-sub">${n.date} | ${n.broker}</div></div>
                    <div style="font-size:20px;color:#ddd;">â€º</div>
                </div>
            `).join('')}
        </div>
        `;
        
        $('m-body').innerHTML = html;
        $('modalOverlay').classList.add('active');
    };

    window.openNewsModal = (id) => {
        const item = dataStore.news.find(x => x.id === id);
        $('m-header-info').innerHTML = `<div style="font-size:18px;font-weight:700;">${item.company}</div><div style="font-size:12px;color:#666;">${item.date} | ${item.broker}</div>`;
        $('m-body').innerHTML = `<div class="content-block" style="line-height:1.8">${item.content}</div>`;
        $('modalOverlay').classList.add('active');
    };

    // UI Utilities
    window.setTab = (el, targetId) => {
        el.parentElement.querySelectorAll('.m-tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        el.parentElement.parentElement.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        $(targetId).classList.add('active');
    };
    
    window.closeModal = (e) => {
        if(!e || e.target.id === 'modalOverlay' || e.target.classList.contains('modal-close')) {
            $('modalOverlay').classList.remove('active');
        }
    };

    // Start
    window.onload = loadAll;

    </script>
</body>
</html>
