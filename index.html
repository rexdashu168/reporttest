<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤ (Pro)</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>if(typeof XLSX==='undefined'){document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>');}</script>
    <style>
        :root { --primary: #c96442; --bg: #f5f4ef; --text: #2d2d2d; --gray: #6b6b6b; --border: #e5e3dc; --green: #27ae60; --red: #e74c3c; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; }
        .container { max-width: 1000px; margin: 0 auto; padding: 12px; }
        
        /* Loading */
        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .splash-icon { font-size: 48px; animation: bounce 2s infinite; margin-bottom: 15px; }
        .splash-bar { width: 200px; height: 4px; background: #ddd; border-radius: 2px; overflow: hidden; margin-top: 15px; }
        .splash-progress { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

        /* Components */
        .header { text-align: center; padding: 20px 0; border-bottom: 1px solid var(--border); }
        .header h1 { color: var(--primary); font-size: 22px; margin-bottom: 5px; }
        
        .db-switcher { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; -webkit-overflow-scrolling: touch; }
        .db-tab { padding: 6px 14px; background: #fff; border: 1px solid var(--border); border-radius: 20px; font-size: 13px; color: var(--gray); white-space: nowrap; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; gap: 5px; }
        .db-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .count { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 10px; font-size: 10px; }

        .search-box { position: relative; margin: 15px 0; }
        .search-input { width: 100%; padding: 12px 12px 12px 40px; border-radius: 25px; border: 2px solid var(--border); background: #fff; font-size: 15px; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #999; }

        .card-list { display: flex; flex-direction: column; gap: 12px; }
        .card { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; }
        .card:active { transform: scale(0.98); transition: transform 0.1s; }
        .card-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .card-title { font-weight: 700; font-size: 16px; color: #333; line-height: 1.4; }
        .card-meta { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px; }
        .tag { font-size: 11px; padding: 2px 8px; border-radius: 6px; color: #fff; font-weight: 500; }
        .tag.brk { background: var(--primary); }
        .tag.ind { background: #2980b9; }
        .tag.dt { background: #e0e0e0; color: #666; }
        .tag.rt { background: #9b59b6; }
        .tag.tr { background: #f39c12; }
        .card-body { font-size: 13px; color: #555; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        /* 6-Grid Stats */
        .grid-6 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .stat-box { background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .stat-label { font-size: 11px; color: #888; }
        .stat-val { font-size: 14px; font-weight: 700; margin-top: 2px; }
        .stat-val.up { color: var(--red); }
        .stat-val.down { color: var(--green); }

        /* Left-Border Highlights */
        .hl-box { background: #fff; padding: 12px; border-radius: 8px; border-left: 4px solid #ddd; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .hl-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; color: #333; }
        .hl-content { font-size: 13px; color: #555; line-height: 1.6; white-space: pre-wrap; }
        .hl-blue { border-left-color: #3498db; }
        .hl-orange { border-left-color: #e67e22; }
        .hl-green { border-left-color: var(--green); }

        /* Modal */
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-inner { background: #fff; width: 100%; max-width: 600px; height: 92vh; border-radius: 16px 16px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        .m-head { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .m-close { width: 30px; height: 30px; border-radius: 50%; border: none; background: #f0f0f0; font-size: 20px; color: #666; }
        .m-tabs { display: flex; gap: 10px; padding: 10px 15px; border-bottom: 1px solid #eee; overflow-x: auto; }
        .m-tab { padding: 6px 12px; background: #f5f5f5; border-radius: 20px; font-size: 13px; color: #666; white-space: nowrap; cursor: pointer; }
        .m-tab.active { background: var(--primary); color: #fff; }
        .m-body { flex: 1; overflow-y: auto; padding: 15px; background: #fafaf8; }
        .m-section { margin-bottom: 20px; }
        .m-stitle { font-size: 14px; font-weight: 700; color: var(--primary); margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; background: #fff; }
        th, td { padding: 8px; border: 1px solid #eee; text-align: left; }
        th { background: #f9f9f9; font-weight: 600; white-space: nowrap; }
        
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        @media(min-width: 768px) { .modal { align-items: center; } .modal-inner { height: 85vh; border-radius: 16px; } }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="splash-icon">ğŸ“Š</div>
    <div style="font-weight:700;font-size:18px;margin-bottom:5px" id="loadTitle">ç³»çµ±å•Ÿå‹•ä¸­...</div>
    <div style="font-size:13px;color:#888" id="loadSub">æ­£åœ¨åŒæ­¥ Rexå¤§å”è³‡æ–™åº«</div>
    <div class="splash-bar"><div class="splash-progress" id="loadBar"></div></div>
</div>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
        <p style="font-size:12px;color:#666">å…¨æ–¹ä½å°è‚¡æŠ•è³‡æ±ºç­–ç³»çµ± (Pro)</p>
    </div>

    <div class="db-switcher">
        <div class="db-tab active" onclick="setDB('news')">âš¡ å¤–é›» <span class="count" id="c-news">0</span></div>
        <div class="db-tab" onclick="setDB('memo')">ğŸ“‹ Memo <span class="count" id="c-memo">0</span></div>
        <div class="db-tab" onclick="setDB('reports')">ğŸ“‘ å ±å‘Š <span class="count" id="c-reports">0</span></div>
        <div class="db-tab" onclick="setDB('strategy')">ğŸ¯ ç­–ç•¥ <span class="count" id="c-strategy">0</span></div>
        <div class="db-tab" onclick="setDB('trends')">ğŸ“ˆ è¶¨å‹¢ <span class="count" id="c-trends">0</span></div>
        <div class="db-tab" onclick="setDB('industry')">ğŸ­ ç”¢æ¥­ <span class="count" id="c-industry">0</span></div>
        <div class="db-tab" onclick="setDB('stocks')">ğŸ¢ å€‹è‚¡ <span class="count" id="c-stocks">0</span></div>
        <div class="db-tab" onclick="setDB('cb')">ğŸ« CB <span class="count" id="c-cb">0</span></div>
    </div>

    <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" class="search-input" id="search" placeholder="æœå°‹å…¬å¸ã€ä»£è™Ÿã€é—œéµå­—...">
    </div>

    <div style="font-size:12px;color:#666;margin-bottom:10px;display:flex;justify-content:space-between;">
        <span>æ‰¾åˆ° <b id="resCount" style="color:var(--primary)">0</b> ç­†è³‡æ–™</span>
        <span id="updateTime"></span>
    </div>

    <div class="card-list" id="list"></div>
</div>

<div class="modal" id="modal" onclick="closeModal(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">
        <div class="m-head">
            <div id="m-info"></div>
            <button class="m-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="m-tabs" id="m-tabs"></div>
        <div class="m-body" id="m-body"></div>
    </div>
</div>

<script>
// --- Files & Data ---
const FILES = {
    NEWS: '01_news.xlsx', MEMO: '02_memo.xlsx', REPORTS: '03_reports.xlsx',
    MASTER: '04_master.xlsx', STRAT: '05_Strategy.xlsx', CB: '00_CB.xlsx', REV: '06_revenue.xlsx'
};

const DB = { news:[], memo:[], reports:[], strategy:[], trends:[], industry:[], stocks:{}, cb:[] };
const META = { 
    memoDetail:{}, tracking:{}, finance:{}, products:{}, timeline:[], 
    reportDetail:{}, reportStocks:[], reportConc:{},
    stratThemes:[], stratQuarters:[], stratPicks:[], stratViews:{},
    revenue:{}, cbMap:{}
};
let CURR_DB = 'news';

// --- Utils ---
const $ = id => document.getElementById(id);
const safe = v => (v==null?'':String(v).trim());
const fmtDate = v => {
    if(!v) return '';
    if(typeof v === 'number') {
        const d = new Date((v-25569)*86400000);
        return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
    }
    return v;
};
const loadStep = (t,s,p) => {
    $('loadTitle').innerText=t; $('loadSub').innerText=s; $('loadBar').style.width=p+'%';
};

// --- Loaders (Deep Parsing) ---
async function fetchXlsx(url) {
    try {
        const res = await fetch(url);
        if(!res.ok) throw new Error();
        return XLSX.read(await res.arrayBuffer(), {type:'array'});
    } catch(e) { console.error('Load fail:', url); return null; }
}

async function init() {
    loadStep('è®€å–å¤–é›»èˆ‡CB...', 'æ­£åœ¨åŒæ­¥å¸‚å ´å¿«è¨Š', 10);
    
    // 1. News
    let wb = await fetchXlsx(FILES.NEWS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å¤–é›»ç¶œåˆå ±å°']||[]).forEach(r => {
            if(safe(r['è³‡æ–™é¡å‹'])==='å€‹è‚¡å ±å°') DB.news.push(r);
            if(safe(r['è³‡æ–™é¡å‹'])==='ç”¢æ¥­è¶¨å‹¢') DB.trends.push(r);
        });
    }

    // 2. CB
    wb = await fetchXlsx(FILES.CB);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™']||[]).forEach(r => {
            const sc = safe(r['è½‰æ›æ¨™çš„ä»£ç¢¼']);
            DB.cb.push(r);
            if(!META.cbMap[sc]) META.cbMap[sc]=[]; META.cbMap[sc].push(r);
        });
    }

    loadStep('è§£æç ”ç©¶å ±å‘Š...', 'å½™æ•´ Call Memo èˆ‡æ·±åº¦å ±å‘Š', 40);

    // 3. Memo
    wb = await fetchXlsx(FILES.MEMO);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¡¨']||[]).forEach(r=>DB.memo.push(r));
        XLSX.utils.sheet_to_json(wb.Sheets['è©³ç´°å…§å®¹åº«']||[]).forEach(r=>META.memoDetail[safe(r['ç·¨è™Ÿ'])]=r);
        XLSX.utils.sheet_to_json(wb.Sheets['å…¬å¸è¿½è¹¤è¡¨']||[]).forEach(r=>META.tracking[safe(r['å…¬å¸'])]=r);
        XLSX.utils.sheet_to_json(wb.Sheets['è²¡å‹™æ•¸æ“šå½™ç¸½']||[]).forEach(r=>META.finance[safe(r['å…¬å¸'])]=r);
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢å“çµæ§‹åˆ†æ']||[]).forEach(r=>META.products[safe(r['å…¬å¸'])]=r);
        XLSX.utils.sheet_to_json(wb.Sheets['é—œéµæ™‚ç¨‹è¿½è¹¤']||[]).forEach(r=>META.timeline.push(r));
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢æ¥­è¶¨å‹¢ç¸½è¦½']||[]).forEach(r=>DB.industry.push(r));
    }

    // 4. Reports
    wb = await fetchXlsx(FILES.REPORTS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r=>DB.reports.push(r));
        XLSX.utils.sheet_to_json(wb.Sheets['ç„¦é»åˆ†æå…§å®¹']||[]).forEach(r=>{
            const id=safe(r['å ±å‘Šç·¨è™Ÿ']); if(!META.reportDetail[id]) META.reportDetail[id]=[]; META.reportDetail[id].push(r);
        });
        XLSX.utils.sheet_to_json(wb.Sheets['å€‹è‚¡è©•åƒ¹è¡¨']||[]).forEach(r=>META.reportStocks.push(r));
        XLSX.utils.sheet_to_json(wb.Sheets['åˆ¸å•†è§€é»çµè«–']||[]).forEach(r=>META.reportConc[safe(r['å ±å‘Šç·¨è™Ÿ'])]=r);
    }

    loadStep('è¼‰å…¥ç­–ç•¥èˆ‡ç‡Ÿæ”¶...', 'å»ºç«‹å°è‚¡ä¸»è³‡æ–™åº«', 70);

    // 5. Strategy
    wb = await fetchXlsx(FILES.STRAT);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r=>DB.strategy.push(r));
        XLSX.utils.sheet_to_json(wb.Sheets['é¡Œæèˆ‡è¶¨å‹¢']||[]).forEach(r=>META.stratThemes.push(r));
        XLSX.utils.sheet_to_json(wb.Sheets['å­£åº¦è¡Œæƒ…è¦åŠƒ']||[]).forEach(r=>META.stratQuarters.push(r));
        XLSX.utils.sheet_to_json(wb.Sheets['é¸è‚¡ç­–ç•¥']||[]).forEach(r=>META.stratPicks.push(r));
        ['ç¸½ç¶“åˆ†æ','åŸºæœ¬é¢åˆ†æ','ç±Œç¢¼åˆ†æ','æŠ€è¡“åˆ†æ'].forEach(s => {
            XLSX.utils.sheet_to_json(wb.Sheets[s]||[]).forEach(r=> {
                const id=safe(r['å ±å‘Šç·¨è™Ÿ']); if(!META.stratViews[id]) META.stratViews[id]=[]; META.stratViews[id].push(r);
            });
        });
    }

    // 6. Master & Revenue
    wb = await fetchXlsx(FILES.MASTER);
    if(wb) XLSX.utils.sheet_to_json(wb.Sheets['ä¸»è³‡æ–™åº«']||[]).forEach(r=>{ if(r['ä»£è™Ÿ']) DB.stocks[safe(r['ä»£è™Ÿ'])]=r; });

    wb = await fetchXlsx(FILES.REV);
    if(wb) {
        const rows = XLSX.utils.sheet_to_json(wb.Sheets['000_æœˆç‡Ÿæ”¶']||[]);
        const headers = Object.keys(rows[0]||{}).filter(k=>k.includes('å–®æœˆç‡Ÿæ”¶'));
        rows.forEach(r => {
            const c = safe(r['ä»£è™Ÿ']);
            META.revenue[c] = headers.slice(-12).map(h => ({ p:h.replace('å–®æœˆç‡Ÿæ”¶(å„„)',''), v:r[h] }));
        });
    }

    loadStep('å®Œæˆ', 'å•Ÿå‹• Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤', 100);
    updateCounts();
    renderList();
    $('search').addEventListener('input', renderList);
    
    setTimeout(()=>$('loader').classList.add('hidden'), 500);
}

// --- Rendering ---
function setDB(db) {
    CURR_DB = db;
    document.querySelectorAll('.db-tab').forEach(t=>t.classList.remove('active'));
    event.currentTarget.classList.add('active');
    renderList();
}

function updateCounts() {
    $('c-news').innerText = DB.news.length; $('c-memo').innerText = DB.memo.length;
    $('c-reports').innerText = DB.reports.length; $('c-strategy').innerText = DB.strategy.length;
    $('c-trends').innerText = DB.trends.length; $('c-industry').innerText = DB.industry.length;
    $('c-stocks').innerText = Object.keys(DB.stocks).length; $('c-cb').innerText = DB.cb.length;
}

function renderList() {
    const q = $('search').value.toLowerCase();
    let list = [], html = '';
    
    if(CURR_DB==='news') list = DB.news;
    else if(CURR_DB==='memo') list = DB.memo;
    else if(CURR_DB==='reports') list = DB.reports;
    else if(CURR_DB==='strategy') list = DB.strategy;
    else if(CURR_DB==='trends') list = DB.trends;
    else if(CURR_DB==='industry') list = DB.industry;
    else if(CURR_DB==='stocks') list = Object.values(DB.stocks);
    else if(CURR_DB==='cb') list = DB.cb;

    const filtered = list.filter(i => JSON.stringify(i).toLowerCase().includes(q));
    $('resCount').innerText = filtered.length;

    filtered.slice(0,50).forEach(i => {
        if(CURR_DB==='news') html += makeCard(i.id, i['å…¬å¸'], i['åˆ¸å•†ä¾†æº'], i['æ—¥æœŸ'], i['å ±å°é‡é»åˆ†é¡'], 'news', i['å®Œæ•´å ±å°å…§å®¹']);
        else if(CURR_DB==='memo') html += makeCard(i['ç·¨è™Ÿ'], `${i['å…¬å¸']} (${i['è‚¡è™Ÿ']})`, i['åˆ¸å•†'], i['æ—¥æœŸ'], i['å ±å‘Šé¡å‹'], 'memo', META.memoDetail[i['ç·¨è™Ÿ']]?.['ç‡Ÿé‹é‡é»']);
        else if(CURR_DB==='reports') html += makeCard(i['å ±å‘Šç·¨è™Ÿ'], i['å ±å‘Šæ¨™é¡Œ'], i['åˆ¸å•†åç¨±'], i['å ±å‘Šæ—¥æœŸ'], i['ç”¢æ¥­åç¨±'], 'report', i['æ ¸å¿ƒé‡é»1']);
        else if(CURR_DB==='strategy') html += makeCard(i['å ±å‘Šç·¨è™Ÿ'], i['å ±å‘Šæ¨™é¡Œ'], i['åˆ¸å•†åç¨±'], i['å ±å‘Šæ—¥æœŸ'], i['å ±å‘Šé¡å‹'], 'strat', i['ç¸½ç¶“è§€é»æ‘˜è¦']);
        else if(CURR_DB==='stocks') html += `<div class="card" onclick="openStock('${i['ä»£è™Ÿ']}')"><div class="card-head"><div class="card-title">${i['å…¬å¸åç¨±']} ${i['ä»£è™Ÿ']}</div><div style="font-weight:700">${i['æˆäº¤']||'-'}</div></div><div class="card-meta"><span class="tag ind">${i['ç”¢æ¥­åˆ†é¡']}</span></div></div>`;
        else if(CURR_DB==='industry') html += `<div class="card" onclick="openInd(${DB.industry.indexOf(i)})"><div class="card-head"><div class="card-title">${i['ç”¢æ¥­']}</div><span class="tag rt">${i['è¶¨å‹¢åˆ¤æ–·']}</span></div><div class="card-body">é©…å‹•: ${i['é—œéµé©…å‹•å› ç´ ']}</div></div>`;
        else if(CURR_DB==='cb') html += `<div class="card" onclick="openStock('${i['è½‰æ›æ¨™çš„ä»£ç¢¼']}')"><div class="card-head"><div class="card-title">${i['åç¨±']} (${i['ä»£è™Ÿ']})</div></div><div class="card-body">æ¨™çš„: ${i['è½‰æ›æ¨™çš„åç¨±']} | è½‰åƒ¹: ${i['è½‰æ›åƒ¹æ ¼(å…ƒ)']} | é¤˜é¡: ${i['æœ€æ–°é¤˜é¡(ç™¾è¬)']}</div></div>`;
        else if(CURR_DB==='trends') html += `<div class="card" onclick="openTrend('${i['ç·¨è™Ÿ']}')"><div class="card-head"><div class="card-title">${i['ç”¢æ¥­ä¸»é¡Œ']}</div></div><div class="card-body">${i['å®Œæ•´å…§å®¹']}</div></div>`;
    });
    $('list').innerHTML = html;
}

function makeCard(id, title, broker, date, tag, type, content) {
    return `<div class="card" onclick="open${type.charAt(0).toUpperCase()+type.slice(1)}('${id}')">
        <div class="card-head"><div class="card-title">${title}</div></div>
        <div class="card-meta"><span class="tag brk">${broker}</span><span class="tag dt">${fmtDate(date)}</span>${tag?`<span class="tag ind">${tag}</span>`:''}</div>
        <div class="card-body">${safe(content)}</div>
    </div>`;
}

// ===== Modals (The Magic) =====
function showModal(title, tabs, body) {
    $('m-info').innerHTML = `<div style="font-size:18px;font-weight:700">${title}</div>`;
    $('m-tabs').innerHTML = tabs.map((t,i)=>`<div class="m-tab ${i==0?'active':''}" onclick="swTab(${i})">${t}</div>`).join('');
    $('m-body').innerHTML = body.map((b,i)=>`<div class="m-content ${i==0?'':'hidden'}" id="mc-${i}">${b}</div>`).join('');
    $('modal').classList.add('show');
}

window.swTab = (i) => {
    document.querySelectorAll('.m-tab').forEach(t=>t.classList.remove('active'));
    event.target.classList.add('active');
    document.querySelectorAll('.m-content').forEach(c=>c.classList.add('hidden'));
    $('mc-'+i).classList.remove('hidden');
};

window.closeModal = (e) => { if(!e || e.target.id==='modal') $('modal').classList.remove('show'); };

// 1. Memo Modal
window.openMemo = (id) => {
    const m = DB.memo.find(x=>x['ç·¨è™Ÿ']==id);
    const d = META.memoDetail[id]||{};
    const t = META.tracking[m['å…¬å¸']]||{};
    const f = META.finance[m['å…¬å¸']]||{};
    
    // Tab 1: ç¸½è¦½ (6æ ¼ + ç‡Ÿé‹)
    const t1 = `
    <div class="grid-6">
        <div class="stat-box"><div class="stat-label">ç‡Ÿæ”¶YoY</div><div class="stat-val ${safe(m['ç‡Ÿæ”¶YoY']).includes('+')?'up':''}">${m['ç‡Ÿæ”¶YoY']||'-'}</div></div>
        <div class="stat-box"><div class="stat-label">æ¯›åˆ©ç‡</div><div class="stat-val">${m['æ¯›åˆ©ç‡']||'-'}</div></div>
        <div class="stat-box"><div class="stat-label">EPS</div><div class="stat-val">${m['EPS']||'-'}</div></div>
        <div class="stat-box"><div class="stat-label">è©•ç­‰</div><div class="stat-val">${t['æŠ•è³‡è©•ç­‰']||'-'}</div></div>
        <div class="stat-box"><div class="stat-label">ç›®æ¨™åƒ¹</div><div class="stat-val up">${t['ç›®æ¨™åƒ¹']||'-'}</div></div>
        <div class="stat-box"><div class="stat-label">è¿½è¹¤</div><div class="stat-val">${t['è¿½è¹¤ç‹€æ…‹']||'-'}</div></div>
    </div>
    <div class="m-section"><div class="m-stitle">ğŸ¯ ç‡Ÿé‹é‡é»</div><div class="hl-content">${fmtTxt(d['ç‡Ÿé‹é‡é»'])}</div></div>
    ${d['å¾ŒçºŒè¿½è¹¤']?`<div class="hl-box hl-orange"><div class="hl-title">ğŸ”” å¾ŒçºŒè¿½è¹¤</div><div class="hl-content">${fmtTxt(d['å¾ŒçºŒè¿½è¹¤'])}</div></div>`:''}
    `;

    // Tab 2: ç­–ç•¥
    const t2 = `<div class="m-section"><div class="hl-content">${fmtTxt(d['ç­–ç•¥æ–¹å‘']||'ç„¡è³‡æ–™')}</div></div>`;

    // Tab 3: è²¡å‹™
    const t3 = `
    <div class="grid-6">
        <div class="stat-box"><div class="stat-label">3Q25ç‡Ÿæ”¶</div><div class="stat-val">${f['3Q25ç‡Ÿæ”¶']||'-'}</div></div>
        <div class="stat-box"><div class="stat-label">ç¨…å¾Œæ·¨åˆ©</div><div class="stat-val">${f['ç¨…å¾Œæ·¨åˆ©']||'-'}</div></div>
    </div>
    ${f['4Q25æŒ‡å¼•']?`<div class="hl-box hl-blue"><div class="hl-title">ğŸ“ˆ 4Q25æŒ‡å¼•</div><div class="hl-content">${fmtTxt(f['4Q25æŒ‡å¼•'])}</div></div>`:''}
    `;

    showModal(`${m['å…¬å¸']} (${m['è‚¡è™Ÿ']})`, ['ğŸ“Š ç¸½è¦½','ğŸš€ ç­–ç•¥','ğŸ’° è²¡å‹™'], [t1,t2,t3]);
};

// 2. Stock Modal (The Hub)
window.openStock = (code) => {
    const s = DB.stocks[code];
    if(!s) return alert('ç„¡æ­¤å€‹è‚¡è³‡æ–™');
    const name = s['å…¬å¸åç¨±'];
    
    // Find related
    const relMemo = DB.memo.filter(x=>x['è‚¡è™Ÿ']==code || x['å…¬å¸']==name);
    const relNews = DB.news.filter(x=>x['è‚¡è™Ÿ']==code || x['å…¬å¸']==name);
    const rev = META.revenue[code];
    const cbs = META.cbMap[code];

    // Tab 1: åŸºæœ¬
    const t1 = `
    <div class="grid-6">
        <div class="stat-box"><div class="stat-label">è‚¡åƒ¹</div><div class="stat-val" style="font-size:20px">${s['æˆäº¤']}</div></div>
        <div class="stat-box"><div class="stat-label">æ¼²è·Œå¹…</div><div class="stat-val ${safe(s['æ¼²è·Œå¹…']).includes('-')?'down':'up'}">${s['æ¼²è·Œå¹…']}</div></div>
        <div class="stat-box"><div class="stat-label">å¸‚å€¼</div><div class="stat-val">${s['å¸‚å€¼(å„„)']}å„„</div></div>
        <div class="stat-box"><div class="stat-label">ç”¢æ¥­</div><div class="stat-val">${s['ç”¢æ¥­åˆ†é¡']}</div></div>
    </div>
    <div class="m-section"><div class="m-stitle">ğŸ’¼ æ¥­å‹™</div><div class="hl-content">${s['æ¥­å‹™æ‘˜è¦']}</div></div>
    ${cbs?`<div class="m-section"><div class="m-stitle">ğŸ« å¯è½‰å‚µ</div>${cbs.map(c=>`<div class="hl-box hl-orange"><div class="hl-title">${c['åç¨±']}</div>è½‰æ›åƒ¹:${c['è½‰æ›åƒ¹æ ¼(å…ƒ)']} | é¤˜é¡:${c['æœ€æ–°é¤˜é¡(ç™¾è¬)']} | åˆ°æœŸ:${fmtDate(c['åˆ°æœŸæ—¥'])}</div>`).join('')}</div>`:''}
    `;

    // Tab 2: ç‡Ÿæ”¶
    const t2 = rev ? `<table><thead><tr><th>æœˆä»½</th><th>ç‡Ÿæ”¶(å„„)</th></tr></thead><tbody>${rev.map(r=>`<tr><td>${r.p}</td><td>${r.v}</td></tr>`).join('')}</tbody></table>` : 'ç„¡ç‡Ÿæ”¶è³‡æ–™';

    // Tab 3: å ±å‘Š
    const t3 = `
    <div class="m-stitle">Call Memo (${relMemo.length})</div>
    ${relMemo.map(m=>`<div class="hl-box hl-blue" onclick="openMemo('${m['ç·¨è™Ÿ']}')"><div class="hl-title">${m['åˆ¸å•†']} - ${m['å ±å‘Šé¡å‹']}</div><div style="font-size:12px;color:#666">${fmtDate(m['æ—¥æœŸ'])}</div></div>`).join('')}
    <div class="m-stitle" style="margin-top:20px">å¤–é›»å ±å° (${relNews.length})</div>
    ${relNews.map(n=>`<div class="hl-box hl-green" onclick="openNews('${n['ç·¨è™Ÿ']}')"><div class="hl-title">${n['å ±å°é‡é»åˆ†é¡']}</div><div style="font-size:12px;color:#666">${fmtDate(n['æ—¥æœŸ'])}</div></div>`).join('')}
    `;

    showModal(`${name} (${code})`, ['ğŸ“Š åŸºæœ¬','ğŸ’° ç‡Ÿæ”¶','ğŸ“‘ å ±å‘Š'], [t1,t2,t3]);
};

// 3. News Modal
window.openNews = (id) => {
    const n = DB.news.find(x=>x['ç·¨è™Ÿ']==id);
    showModal(n['å…¬å¸'], ['å ±å°å…§å®¹'], [`<div class="hl-content" style="font-size:15px;line-height:1.8">${fmtTxt(n['å®Œæ•´å ±å°å…§å®¹'])}</div>`]);
};

// 4. Report Modal
window.openReport = (id) => {
    const r = DB.reports.find(x=>x['å ±å‘Šç·¨è™Ÿ']==id);
    const d = META.reportDetail[id]||[];
    const s = META.reportStocks.filter(x=>x['å ±å‘Šç·¨è™Ÿ']==id);
    
    const t1 = `<div class="m-section"><div class="m-stitle">æ ¸å¿ƒé‡é»</div><div class="hl-content">${r['æ ¸å¿ƒé‡é»1']}<br><br>${r['æ ¸å¿ƒé‡é»2']}</div></div>`;
    const t2 = d.map(x=>`<div class="hl-box hl-blue"><div class="hl-title">${x['æ®µè½æ¨™é¡Œ']}</div><div class="hl-content">${fmtTxt(x['æ®µè½å…§å®¹'])}</div></div>`).join('');
    const t3 = `<table><thead><tr><th>è‚¡è™Ÿ</th><th>å…¬å¸</th><th>è©•ç­‰</th><th>ç›®æ¨™åƒ¹</th></tr></thead><tbody>${s.map(x=>`<tr onclick="openStock('${x['è‚¡ç¥¨ä»£è™Ÿ']}')"><td>${x['è‚¡ç¥¨ä»£è™Ÿ']}</td><td>${x['å…¬å¸åç¨±']}</td><td>${x['è©•ç­‰']}</td><td>${x['ç›®æ¨™åƒ¹']}</td></tr>`).join('')}</tbody></table>`;
    
    showModal(r['å ±å‘Šæ¨™é¡Œ'], ['é‡é»','åˆ†æ','å€‹è‚¡'], [t1,t2,t3]);
};

// 5. Strategy Modal
window.openStrat = (id) => {
    const s = DB.strategy.find(x=>x['å ±å‘Šç·¨è™Ÿ']==id);
    const th = META.stratThemes.filter(x=>x['å ±å‘Šç·¨è™Ÿ']==id);
    const pi = META.stratPicks.filter(x=>x['å ±å‘Šç·¨è™Ÿ']==id);
    
    const t1 = `<div class="m-section"><div class="m-stitle">è§€é»æ‘˜è¦</div><div class="hl-content">${fmtTxt(s['ç¸½ç¶“è§€é»æ‘˜è¦'])}</div></div>
    <div class="grid-6"><div class="stat-box"><div class="stat-label">æŒ‡æ•¸ä½é»</div><div class="stat-val">${s['æŒ‡æ•¸é æ¸¬å€é–“_ä½']}</div></div><div class="stat-box"><div class="stat-label">æŒ‡æ•¸é«˜é»</div><div class="stat-val up">${s['æŒ‡æ•¸é æ¸¬å€é–“_é«˜']}</div></div></div>`;
    
    const t2 = th.map(t=>`<div class="hl-box hl-orange"><div class="hl-title">${t['é¡Œæä¸»é¡Œ']}</div><div class="hl-content">${fmtTxt(t['é¡Œæå…§å®¹'])}</div></div>`).join('');
    const t3 = `<table><thead><tr><th>ä»£è™Ÿ</th><th>å…¬å¸</th><th>é¡Œæ</th></tr></thead><tbody>${pi.map(p=>`<tr onclick="openStock('${p['è‚¡ç¥¨ä»£è™Ÿ']}')"><td>${p['è‚¡ç¥¨ä»£è™Ÿ']}</td><td>${p['å…¬å¸åç¨±']}</td><td>${p['æŠ•è³‡é¡Œæ']}</td></tr>`).join('')}</tbody></table>`;
    
    showModal(s['å ±å‘Šæ¨™é¡Œ'], ['è§€é»','é¡Œæ','é¸è‚¡'], [t1,t2,t3]);
};

window.openTrend = (id) => {
    const t = DB.trends.find(x=>x['ç·¨è™Ÿ']==id);
    showModal(t['ç”¢æ¥­ä¸»é¡Œ'], ['å…§å®¹'], [`<div class="hl-content">${fmtTxt(t['å®Œæ•´å…§å®¹'])}</div>`]);
};

window.openInd = (idx) => {
    const i = DB.industry[idx];
    showModal(i['ç”¢æ¥­'], ['å‹•æ…‹'], [`
        <div class="grid-6"><div class="stat-box"><div class="stat-label">è¶¨å‹¢</div><div class="stat-val">${i['è¶¨å‹¢åˆ¤æ–·']}</div></div><div class="stat-box"><div class="stat-label">ä½ç½®</div><div class="stat-val">${i['æ™¯æ°£ä½ç½®']}</div></div></div>
        <div class="m-section"><div class="m-stitle">é—œéµé©…å‹•</div><div class="hl-content">${fmtTxt(i['é—œéµé©…å‹•å› ç´ '])}</div></div>
        <div class="m-section"><div class="m-stitle">æŠ•è³‡å»ºè­°</div><div class="hl-content">${fmtTxt(i['æŠ•è³‡å»ºè­°'])}</div></div>
    `]);
};

function fmtTxt(t) { return safe(t).replace(/\n/g, '<br>').replace(/â€¢/g, '<br>â€¢ '); }

// Start
window.onload = init;
</script>
</body>
</html>
