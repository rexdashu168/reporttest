<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤ v11.4</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #c96442; --bg: #f5f4ef; --text: #333; --gray: #666; --border: #e0e0e0; --link: #2980b9; --up: #e74c3c; --down: #27ae60; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; }
        .container { max-width: 800px; margin: 0 auto; padding: 12px; }

        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #e0e0e0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .header { text-align: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .header h1 { color: var(--primary); font-size: 22px; margin-bottom: 5px; font-weight: 800; }
        .db-switcher { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin: 15px 0; }
        .db-tab { padding: 6px 14px; background: #fff; border: 1px solid var(--border); border-radius: 20px; font-size: 13px; color: var(--gray); cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
        .db-tab:hover { border-color: var(--primary); }
        .db-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .count { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 10px; font-size: 10px; }

        .search-box { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 35px 12px 40px; border-radius: 25px; border: 2px solid var(--border); background: #fff; font-size: 15px; outline: none; transition: border-color 0.2s; }
        .search-input:focus { border-color: var(--primary); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #999; }
        .clear-btn { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; background: #ccc; color: #fff; border-radius: 50%; font-size: 12px; line-height: 20px; text-align: center; cursor: pointer; display: none; }

        /* CB çµ±è¨ˆå€å¡Š */
        .cb-stats { background: #fff5f5; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #ffe0e0; }
        .cb-stats-title { color: var(--primary); font-weight: 700; margin-bottom: 12px; font-size: 14px; }
        .cb-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .cb-stat-item { background: #fff; padding: 12px 8px; border-radius: 8px; text-align: center; }
        .cb-stat-num { font-size: 22px; font-weight: 800; color: var(--primary); }
        .cb-stat-label { font-size: 11px; color: #888; margin-top: 2px; }
        .cb-ind-title { font-size: 13px; font-weight: 600; color: #666; margin-bottom: 10px; }
        .cb-ind-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .cb-ind-tag { padding: 6px 12px; background: #fff; border-radius: 20px; font-size: 12px; color: #666; cursor: pointer; transition: all 0.2s; border: 1px solid #eee; }
        .cb-ind-tag:hover { border-color: var(--primary); color: var(--primary); }
        .cb-ind-tag .num { background: var(--primary); color: #fff; padding: 1px 6px; border-radius: 10px; font-size: 10px; margin-left: 4px; }

        .card-list { display: flex; flex-direction: column; gap: 12px; }
        .card { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; transition: all 0.2s; }
        .card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .card-head { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .card-title { font-weight: 700; font-size: 16px; color: #2c3e50; }
        .card-meta { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .tag { font-size: 11px; padding: 2px 8px; border-radius: 6px; color: #fff; font-weight: 500; }
        .tag.brk { background: var(--primary); }
        .tag.ind { background: #2980b9; }
        .tag.dt { background: #e0e0e0; color: #666; }
        .tag.concept { background: #8e44ad; }
        .tag.trend-up { background: #27ae60; }
        .tag.trend-down { background: #e74c3c; }
        .card-body { font-size: 13px; color: #555; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        /* CB åˆ—è¡¨è¡¨æ ¼ */
        .cb-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .cb-table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; background: #fff; border-radius: 8px; overflow: hidden; }
        .cb-table th { background: #f8f9fa; padding: 10px 8px; text-align: left; color: #666; font-weight: 600; border-bottom: 2px solid #eee; position: sticky; top: 0; }
        .cb-table td { padding: 10px 8px; border-bottom: 1px solid #f0f0f0; }
        .cb-table tr:hover td { background: #fffaf8; }
        .cb-table .code { color: var(--primary); font-weight: 600; cursor: pointer; }
        .cb-table .stock { color: var(--link); cursor: pointer; }

        /* Modal */
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-inner { background: #fff; width: 100%; max-width: 650px; height: 92vh; border-radius: 16px 16px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        
        .m-head { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: flex-start; }
        .m-close { width: 32px; height: 32px; border-radius: 50%; border: none; background: #f0f0f0; font-size: 20px; color: #666; cursor: pointer; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .m-close:hover { background: #e0e0e0; }
        
        .nav-grid { display: flex; gap: 4px; padding: 10px 15px; background: #fafafa; border-bottom: 1px solid #eee; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .nav-btn { padding: 6px 10px; border-radius: 8px; border: none; background: #f0f0f0; font-size: 11px; font-weight: 600; color: #666; cursor: pointer; white-space: nowrap; transition: all 0.2s; flex-shrink: 0; }
        .nav-btn.active { background: var(--primary); color: #fff; }

        .m-body { flex: 1; overflow-y: auto; padding: 15px; background: #fff; -webkit-overflow-scrolling: touch; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        .section-head { font-size: 14px; font-weight: 700; color: #444; margin: 20px 0 10px; padding: 8px 12px; background: linear-gradient(90deg, #f8f9fa, transparent); border-left: 4px solid var(--primary); border-radius: 0 8px 8px 0; }
        .section-head:first-child { margin-top: 0; }
        .hl-block { background: #fafaf8; padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary); margin-bottom: 10px; font-size: 13px; line-height: 1.7; white-space: pre-wrap; }
        .hl-block b { color: var(--primary); }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .info-label { color: #666; }
        .info-val { font-weight: 600; color: #333; }
        
        .list-item { padding: 12px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 8px; background: #fff; cursor: pointer; transition: all 0.2s; }
        .list-item:hover { border-color: var(--primary); background: #fffaf8; }
        .list-title { font-weight: 700; font-size: 14px; color: #2c3e50; margin-bottom: 4px; }
        .list-sub { font-size: 12px; color: #888; margin-bottom: 6px; }
        .list-content { font-size: 13px; color: #555; line-height: 1.6; white-space: pre-wrap; }

        .tag-link { color: var(--link); cursor: pointer; font-weight: 600; }
        .tag-link:hover { text-decoration: underline; }
        
        .fin-switcher { display: flex; margin-bottom: 10px; border: 1px solid var(--primary); border-radius: 6px; overflow: hidden; }
        .fin-btn { flex: 1; padding: 8px; text-align: center; font-size: 13px; color: var(--primary); background: #fff; cursor: pointer; font-weight: 600; border-right: 1px solid var(--primary); transition: all 0.2s; }
        .fin-btn:last-child { border-right: none; }
        .fin-btn.active { background: var(--primary); color: #fff; }
        .fin-sub-pane { display: none; }
        .fin-sub-pane.active { display: block; }
        
        .rev-unit { text-align: right; font-size: 11px; color: #888; margin-bottom: 8px; }

        .table-wrap { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .fin-table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
        .fin-table th { background: #f8f9fa; padding: 10px 8px; border-bottom: 2px solid #ddd; text-align: right; color: #555; position: sticky; top: 0; }
        .fin-table td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: right; color: #333; }
        .fin-table th:first-child, .fin-table td:first-child { position: sticky; left: 0; background: #fff; border-right: 1px solid #eee; text-align: left; z-index: 2; font-weight: 700; }
        .fin-table tr:nth-child(even) td { background: #fcfcfc; }
        .fin-table tr:nth-child(even) td:first-child { background: #fcfcfc; }
        .fin-table .highlight-row td { background: #fff3e0; font-weight: 700; }
        .fin-table .highlight-row td:first-child { background: #fff3e0; color: var(--primary); }
        
        .t-up { color: var(--up); font-weight: 700; }
        .t-down { color: var(--down); font-weight: 700; }

        .rating-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .rating-card .big-num { font-size: 28px; font-weight: 800; }
        .rating-card .label { font-size: 12px; opacity: 0.8; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #f8f9fa; padding: 12px; text-align: center; border-radius: 8px; }
        .stat-box .num { font-size: 18px; font-weight: 700; color: var(--primary); }
        .stat-box .lbl { font-size: 11px; color: #888; margin-top: 2px; }

        .qa-item { margin-bottom: 15px; }
        .qa-q { background: #e3f2fd; padding: 10px 12px; border-radius: 8px 8px 0 0; font-weight: 600; color: #1565c0; font-size: 13px; }
        .qa-a { background: #f5f5f5; padding: 10px 12px; border-radius: 0 0 8px 8px; font-size: 13px; line-height: 1.6; color: #444; }

        .timeline-item { position: relative; padding-left: 20px; margin-bottom: 12px; }
        .timeline-item::before { content: ''; position: absolute; left: 0; top: 8px; width: 10px; height: 10px; background: var(--primary); border-radius: 50%; }
        .timeline-item::after { content: ''; position: absolute; left: 4px; top: 20px; width: 2px; height: calc(100% + 4px); background: #e0e0e0; }
        .timeline-item:last-child::after { display: none; }
        .timeline-date { font-size: 12px; font-weight: 700; color: var(--primary); }
        .timeline-text { font-size: 13px; color: #444; margin-top: 2px; }

        @media(min-width: 768px) { .modal { align-items: center; } .modal-inner { height: 85vh; border-radius: 16px; } }
        @media(max-width: 480px) { .cb-stats-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="loading-spinner"></div>
    <div style="font-weight:700;font-size:18px">Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</div>
    <div style="font-size:12px;color:#888;margin-top:8px" id="loadStatus">æ­£åœ¨è¼‰å…¥è³‡æ–™åº«...</div>
</div>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
        <p style="font-size:12px;color:#666">å…¨æ–¹ä½å°è‚¡æŠ•è³‡æ±ºç­–ç³»çµ± v11.4</p>
    </div>

    <div class="db-switcher">
        <div class="db-tab active" data-db="news">âš¡ å¤–é›» <span class="count" id="c-news">0</span></div>
        <div class="db-tab" data-db="memo">ğŸ“‹ Memo <span class="count" id="c-memo">0</span></div>
        <div class="db-tab" data-db="reports">ğŸ“‘ ç”¢æ¥­ <span class="count" id="c-reports">0</span></div>
        <div class="db-tab" data-db="strategy">ğŸ¯ ç­–ç•¥ <span class="count" id="c-strategy">0</span></div>
        <div class="db-tab" data-db="stocks">ğŸ¢ å€‹è‚¡ <span class="count" id="c-stocks">0</span></div>
        <div class="db-tab" data-db="trends">ğŸ“ˆ è¶¨å‹¢ <span class="count" id="c-trends">0</span></div>
        <div class="db-tab" data-db="cb">ğŸ« CB <span class="count" id="c-cb">0</span></div>
    </div>

    <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" class="search-input" id="search" placeholder="æœå°‹å…¬å¸ã€ä»£è™Ÿã€ç”¢æ¥­ã€#Tag..." oninput="handleInput(this)">
        <div class="clear-btn" id="clearBtn" onclick="clearSearch()">âœ•</div>
    </div>

    <!-- CB çµ±è¨ˆå€å¡Š (åªåœ¨ CB åˆ†é é¡¯ç¤º) -->
    <div id="cbStatsArea" style="display:none"></div>

    <div style="font-size:12px;color:#666;margin-bottom:10px;">æ‰¾åˆ° <b id="resCount" style="color:var(--primary)">0</b> ç­†è³‡æ–™</div>
    <div class="card-list" id="list"></div>
</div>

<div class="modal" id="modal" onclick="closeModal(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">
        <div class="m-head">
            <div id="m-info" style="flex:1"></div>
            <button class="m-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="nav-grid" id="navGrid"></div>
        <div class="m-body" id="m-body"></div>
    </div>
</div>

<script>
const FILES = {
    NEWS: '01_news.xlsx', MEMO: '02_memo.xlsx', REPORTS: '03_reports.xlsx',
    MASTER: '04_master.xlsx', STRAT: '05_Strategy.xlsx', CB: '00_CB.xlsx', REV: '06_revenue.xlsx'
};

const DB = { news:[], memo:[], reports:[], strategy:[], stocks:{}, cb:[], trends:[] };
const META = { 
    memoDetail:{}, tracking:{}, finance:{}, products:{}, 
    concepts:{}, cbMap:{}, relatedNews:{}, relatedMemo:{},
    reportFocus:{}, reportViews:{}, reportRatings:{},
    stratMacro:{}, stratFundamental:{}, stratTheme:{}, stratChip:{}, stratTech:{}, stratQuarter:{}, stratPicks:{},
    revData: { month:{}, quarter:{}, year:{}, highlights:{} },
    cbStats: { total: 0, companies: 0, industries: {}, totalBalance: 0 }
};

let CURR_DB = 'news';
const $ = id => document.getElementById(id);
const safe = v => (v==null||v==undefined?'':String(v).trim());

// çµ±ä¸€ä»£ç¢¼è™•ç†å‡½æ•¸
const normalizeCode = v => {
    if(!v) return '';
    let s = String(v).trim();
    // ç§»é™¤ .0 (Excel æ•¸å­—æ ¼å¼)
    if(s.match(/^\d+\.0$/)) s = s.replace('.0', '');
    // ç§»é™¤ TT å¾Œç¶´
    s = s.replace(/\s*TT$/i, '');
    // è£œé›¶åˆ°4ä½
    if(s.match(/^\d{1,4}$/) && s.length < 4) s = s.padStart(4, '0');
    return s;
};

const fmtDate = v => {
    if(!v) return '';
    if(typeof v === 'number' && v > 20000) { 
        const d = new Date((v-25569)*86400000); 
        return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`; 
    }
    return String(v).split(' ')[0].split('T')[0];
};
const getDateVal = v => { if(!v) return 0; if(typeof v === 'number') return (v-25569)*86400000; return new Date(v).getTime(); };
const fmtNum = (v, decimal=0) => {
    if(v===undefined||v===null||v==='') return '-';
    let n = parseFloat(String(v).replace(/,/g,''));
    if(isNaN(n)) return v;
    return decimal > 0 ? n.toFixed(decimal) : n.toLocaleString();
};
const colorClass = v => {
    if(!v||v==='-') return '';
    let n = parseFloat(String(v).replace(/[%$,]/g,''));
    return n>0?'t-up':n<0?'t-down':'';
};

const fmtTxt = t => {
    if(!t) return '';
    let html = safe(t).replace(/\n/g, '<br>');
    html = html.replace(/#(\S+)/g, '<span class="tag-link" onclick="setSearch(\'#$1\');closeModal()">#$1</span>');
    return html;
};

function handleInput(el) { 
    $('clearBtn').style.display = el.value.length > 0 ? 'block' : 'none'; 
    renderList(); 
}
function clearSearch() { 
    $('search').value=''; 
    $('search').focus(); 
    $('clearBtn').style.display='none'; 
    renderList(); 
}
window.setSearch = term => { $('search').value = term; handleInput($('search')); };

async function fetchXlsx(url) {
    try {
        $('loadStatus').innerText = `è¼‰å…¥ ${url}...`;
        const res = await fetch(url);
        if(!res.ok) throw new Error();
        return XLSX.read(await res.arrayBuffer(), {type:'array'});
    } catch(e) { console.warn('Load Error:', url); return null; }
}

async function init() {
    let wb;
    
    // 1. Master + æ¦‚å¿µè‚¡
    wb = await fetchXlsx(FILES.MASTER);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['ä¸»è³‡æ–™åº«']||[]).forEach(r => {
            const code = normalizeCode(r['ä»£è™Ÿ']);
            if(code) DB.stocks[code] = {...r, 'ä»£è™Ÿ': code};
        });
        const csSheet = wb.Sheets['ğŸ’¡æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«'];
        if(csSheet) {
            const range = XLSX.utils.decode_range(csSheet['!ref']);
            for(let R=3; R<=range.e.r; R++) {
                const code = normalizeCode(csSheet[XLSX.utils.encode_cell({r:R,c:0})]?.v);
                const concept = csSheet[XLSX.utils.encode_cell({r:R,c:2})]?.v;
                const subCat = csSheet[XLSX.utils.encode_cell({r:R,c:3})]?.v;
                if(code && concept) {
                    if(!META.concepts[code]) META.concepts[code] = [];
                    META.concepts[code].push({ concept: safe(concept), sub: safe(subCat) });
                }
            }
        }
    }

    // 2. Revenue - å®Œæ•´è®€å–
    wb = await fetchXlsx(FILES.REV);
    if(wb) {
        // æœˆç‡Ÿæ”¶ - æ”¶é›†å®Œæ•´è³‡æ–™
        const sheetM = wb.Sheets['000_æœˆç‡Ÿæ”¶'];
        if(sheetM) {
            const rows = XLSX.utils.sheet_to_json(sheetM, {defval: null});
            if(rows.length > 0) {
                const headers = Object.keys(rows[0]);
                const mCols = headers.filter(h => h.includes('å–®æœˆç‡Ÿæ”¶')).sort();
                const accCols = headers.filter(h => h.includes('ç´¯æœˆç‡Ÿæ”¶(å„„)') && !h.includes('å–®æœˆ')).sort();
                
                console.log('æœˆç‡Ÿæ”¶æ¬„ä½:', mCols.length, 'ç´¯è¨ˆæ¬„ä½:', accCols.length);
                
                rows.forEach(r => {
                    const code = normalizeCode(r['ä»£è™Ÿ']);
                    if(!code || code.length > 5 || code.startsWith('0')) return;
                    
                    const data = [];
                    mCols.forEach(col => {
                        const m = col.match(/(\d+)M(\d+)/);
                        if(m && r[col] !== null && r[col] !== undefined) {
                            // 25M08 = 2025å¹´8æœˆ (å‰å…©ä½å°±æ˜¯è¥¿å…ƒå¹´å¾Œå…©ä½)
                            const year = 2000 + parseInt(m[1]);
                            const month = parseInt(m[2]);
                            const period = `${year}/${month.toString().padStart(2, '0')}`;
                            const accCol = accCols.find(c => c.includes(m[0]));
                            data.push({ 
                                d: period,
                                period: m[0],
                                year: year,
                                month: month,
                                rev: r[col],
                                acc: accCol ? r[accCol] : null
                            });
                        }
                    });
                    
                    if(data.length > 0) {
                        // æŒ‰æ—¥æœŸæ’åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
                        data.sort((a, b) => b.d.localeCompare(a.d));
                        META.revData.month[code] = data;
                    }
                });
                console.log('æœˆç‡Ÿæ”¶è¼‰å…¥å…¬å¸æ•¸:', Object.keys(META.revData.month).length);
            }
        }
        
        // å­£ç‡Ÿæ”¶
        const sheetQ = wb.Sheets['000_å­£ç‡Ÿæ”¶'];
        if(sheetQ) {
            const rows = XLSX.utils.sheet_to_json(sheetQ, {defval: null});
            if(rows.length > 0) {
                const headers = Object.keys(rows[0]);
                const qCols = headers.filter(h => h.includes('å–®å­£ç‡Ÿæ”¶')).sort();
                
                rows.forEach(r => {
                    const code = normalizeCode(r['ä»£è™Ÿ']);
                    if(!code || code.length > 5 || code.startsWith('0')) return;
                    
                    const data = [];
                    qCols.forEach(col => {
                        const m = col.match(/(\d+)Q(\d)/);
                        if(m && r[col] !== null && r[col] !== undefined) {
                            const year = 2000 + parseInt(m[1]);
                            data.push({ 
                                d: `${year}Q${m[2]}`, 
                                year: year,
                                q: parseInt(m[2]),
                                rev: r[col] 
                            });
                        }
                    });
                    
                    if(data.length > 0) {
                        data.sort((a, b) => b.d.localeCompare(a.d));
                        META.revData.quarter[code] = data;
                    }
                });
                console.log('å­£ç‡Ÿæ”¶è¼‰å…¥å…¬å¸æ•¸:', Object.keys(META.revData.quarter).length);
            }
        }
        
        // å¹´ç‡Ÿæ”¶
        const sheetY = wb.Sheets['000_å¹´ç‡Ÿæ”¶'];
        if(sheetY) {
            const rows = XLSX.utils.sheet_to_json(sheetY, {defval: null});
            if(rows.length > 0) {
                const headers = Object.keys(rows[0]);
                const yCols = headers.filter(h => h.includes('å¹´åº¦ç‡Ÿæ”¶')).sort();
                
                rows.forEach(r => {
                    const code = normalizeCode(r['ä»£è™Ÿ']);
                    if(!code || code.length > 5 || code.startsWith('0')) return;
                    
                    const data = [];
                    yCols.forEach(col => {
                        const m = col.match(/(\d{4})/);
                        if(m && r[col] !== null && r[col] !== undefined) {
                            data.push({ 
                                d: m[0], 
                                year: parseInt(m[0]),
                                rev: r[col] 
                            });
                        }
                    });
                    
                    if(data.length > 0) {
                        data.sort((a, b) => b.year - a.year);
                        META.revData.year[code] = data;
                    }
                });
                console.log('å¹´ç‡Ÿæ”¶è¼‰å…¥å…¬å¸æ•¸:', Object.keys(META.revData.year).length);
            }
        }
        
        // è²¡å ±å‚™è¨»
        const sheetH = wb.Sheets['10_è²¡å ±å‚™è¨»'];
        if(sheetH) {
            XLSX.utils.sheet_to_json(sheetH, {defval: null}).forEach(r => {
                const code = normalizeCode(r['ä»£è™Ÿ']);
                if(code) META.revData.highlights[code] = r;
            });
        }
    }

    // 3. News
    wb = await fetchXlsx(FILES.NEWS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å¤–é›»ç¶œåˆå ±å°']||[]).forEach(r => {
            if(safe(r['è³‡æ–™é¡å‹'])==='å€‹è‚¡å ±å°') {
                const code = normalizeCode(r['è‚¡è™Ÿ']);
                DB.news.push({...r, 'è‚¡è™Ÿ': code});
                if(code) { 
                    if(!META.relatedNews[code]) META.relatedNews[code]=[]; 
                    META.relatedNews[code].push(r); 
                }
            }
        });
        DB.news.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
    }

    // 4. Memo
    wb = await fetchXlsx(FILES.MEMO);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¡¨']||[]).forEach(r => {
            const code = normalizeCode(r['è‚¡è™Ÿ']);
            DB.memo.push({...r, 'è‚¡è™Ÿ': code});
            if(code) { 
                if(!META.relatedMemo[code]) META.relatedMemo[code]=[]; 
                META.relatedMemo[code].push(r); 
            }
        });
        DB.memo.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
        
        XLSX.utils.sheet_to_json(wb.Sheets['è©³ç´°å…§å®¹åº«']||[]).forEach(r => META.memoDetail[safe(r['ç·¨è™Ÿ'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['è²¡å‹™æ•¸æ“šå½™ç¸½']||[]).forEach(r => META.finance[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢å“çµæ§‹åˆ†æ']||[]).forEach(r => META.products[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['å…¬å¸è¿½è¹¤è¡¨']||[]).forEach(r => META.tracking[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢æ¥­è¶¨å‹¢ç¸½è¦½']||[]).forEach(r => {
            if(r['ç”¢æ¥­']) DB.trends.push(r);
        });
    }

    // 5. Reports
    wb = await fetchXlsx(FILES.REPORTS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r => DB.reports.push(r));
        DB.reports.sort((a,b) => getDateVal(b['å ±å‘Šæ—¥æœŸ'])-getDateVal(a['å ±å‘Šæ—¥æœŸ']));
        
        XLSX.utils.sheet_to_json(wb.Sheets['ç„¦é»åˆ†æå…§å®¹']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.reportFocus[rid]) META.reportFocus[rid]=[]; META.reportFocus[rid].push(r); }
        });
        XLSX.utils.sheet_to_json(wb.Sheets['åˆ¸å•†è§€é»çµè«–']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) META.reportViews[rid] = r;
        });
        XLSX.utils.sheet_to_json(wb.Sheets['å€‹è‚¡è©•åƒ¹è¡¨']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.reportRatings[rid]) META.reportRatings[rid]=[]; META.reportRatings[rid].push(r); }
        });
    }

    // 6. Strategy
    wb = await fetchXlsx(FILES.STRAT);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r => DB.strategy.push(r));
        DB.strategy.sort((a,b) => getDateVal(b['å ±å‘Šæ—¥æœŸ'])-getDateVal(a['å ±å‘Šæ—¥æœŸ']));
        
        ['ç¸½ç¶“åˆ†æ', 'åŸºæœ¬é¢åˆ†æ', 'é¡Œæèˆ‡è¶¨å‹¢', 'ç±Œç¢¼åˆ†æ', 'æŠ€è¡“åˆ†æ', 'å­£åº¦è¡Œæƒ…è¦åŠƒ', 'é¸è‚¡ç­–ç•¥'].forEach(sn => {
            const target = {
                'ç¸½ç¶“åˆ†æ': META.stratMacro, 'åŸºæœ¬é¢åˆ†æ': META.stratFundamental,
                'é¡Œæèˆ‡è¶¨å‹¢': META.stratTheme, 'ç±Œç¢¼åˆ†æ': META.stratChip,
                'æŠ€è¡“åˆ†æ': META.stratTech, 'å­£åº¦è¡Œæƒ…è¦åŠƒ': META.stratQuarter,
                'é¸è‚¡ç­–ç•¥': META.stratPicks
            }[sn];
            XLSX.utils.sheet_to_json(wb.Sheets[sn]||[]).forEach(r => {
                const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
                if(rid) { if(!target[rid]) target[rid]=[]; target[rid].push(r); }
            });
        });
    }

    // 7. CB - å®Œæ•´è®€å–
    wb = await fetchXlsx(FILES.CB);
    if(wb) {
        // æ—¥è¡Œæƒ… (æœ‰ç”¢æ¥­è³‡è¨Š) - å…ˆè®€å–å»ºç«‹ç”¢æ¥­å°ç…§
        const dailyMap = {};
        XLSX.utils.sheet_to_json(wb.Sheets['09_æœ€æ–°å‹•æ…‹æ¯é€±æ—¥è¡Œæƒ…']||[]).forEach(r => {
            // è™•ç†æ¬„ä½åç¨±æœ‰ç©ºæ ¼çš„å•é¡Œ
            const code = safe(r['ä»£ç¢¼']);
            const name = safe(Object.values(r)[1]); // åç¨±æ¬„ä½æœ‰ç©ºæ ¼ï¼Œç”¨ç´¢å¼•å–
            const ind = safe(r['ç”¢æ¥­']);
            
            if(code) {
                dailyMap[code] = {
                    name: name,
                    industry: ind,
                    cbPrice: r['CBæ”¶ç›¤åƒ¹'],
                    stockPrice: r['è‚¡åƒ¹'],
                    convPrice: r['è½‰æ›åƒ¹æ ¼'],
                    convValue: r['è½‰æ›åƒ¹å€¼'],
                    premium: r['æº¢(æŠ˜)åƒ¹%'],
                    expDate: r['åˆ°æœŸæ—¥']
                };
                
                if(ind) {
                    META.cbStats.industries[ind] = (META.cbStats.industries[ind] || 0) + 1;
                }
            }
        });
        
        // åŸºæœ¬è³‡æ–™ - åˆä½µæ—¥è¡Œæƒ…è³‡æ–™
        XLSX.utils.sheet_to_json(wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™']||[]).forEach(r => {
            const cbCode = safe(r['ä»£è™Ÿ']);
            const stockCode = normalizeCode(r['è½‰æ›æ¨™çš„ä»£ç¢¼']);
            const daily = dailyMap[cbCode] || {};
            
            const cbData = {
                ...r,
                '_stockCode': stockCode,
                '_cbCode': cbCode,
                '_name': safe(r['åç¨±']),
                '_stockName': safe(r['è½‰æ›æ¨™çš„åç¨±']),
                '_industry': daily.industry || '',
                '_cbPrice': daily.cbPrice,
                '_stockPrice': daily.stockPrice,
                '_convValue': daily.convValue,
                '_premium': daily.premium
            };
            
            DB.cb.push(cbData);
            if(stockCode) { 
                if(!META.cbMap[stockCode]) META.cbMap[stockCode]=[]; 
                META.cbMap[stockCode].push(cbData); 
            }
        });
        
        // è¨ˆç®—çµ±è¨ˆ
        META.cbStats.total = DB.cb.length;
        const companies = new Set();
        let totalBal = 0;
        DB.cb.forEach(c => {
            if(c['_stockCode']) companies.add(c['_stockCode']);
            const bal = parseFloat(c['æœ€æ–°é¤˜é¡(ç™¾è¬)']) || 0;
            totalBal += bal;
        });
        META.cbStats.companies = companies.size;
        META.cbStats.totalBalance = totalBal;
        
        console.log('CBè¼‰å…¥:', DB.cb.length, 'ç”¢æ¥­æ•¸:', Object.keys(META.cbStats.industries).length);
    }

    // æ›´æ–°è¨ˆæ•¸
    $('c-news').innerText = DB.news.length;
    $('c-memo').innerText = DB.memo.length;
    $('c-reports').innerText = DB.reports.length;
    $('c-strategy').innerText = DB.strategy.length;
    $('c-stocks').innerText = Object.keys(DB.stocks).length;
    $('c-trends').innerText = DB.trends.length;
    $('c-cb').innerText = DB.cb.length;

    $('loader').classList.add('hidden');
    
    document.querySelectorAll('.db-tab').forEach(tab => {
        tab.onclick = () => {
            CURR_DB = tab.dataset.db;
            document.querySelectorAll('.db-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            renderList();
        };
    });
    
    renderList();
}

// CB çµ±è¨ˆå€å¡Š
function renderCBStats() {
    const stats = META.cbStats;
    const industries = Object.entries(stats.industries).sort((a,b) => b[1]-a[1]);
    
    return `
        <div class="cb-stats">
            <div class="cb-stats-title">ğŸ« å¯è½‰å‚µå¸‚å ´çµ±è¨ˆ</div>
            <div class="cb-stats-grid">
                <div class="cb-stat-item">
                    <div class="cb-stat-num">${stats.total}</div>
                    <div class="cb-stat-label">æ›ç‰Œä¸­CBç¸½æ•¸</div>
                </div>
                <div class="cb-stat-item">
                    <div class="cb-stat-num">${stats.companies}</div>
                    <div class="cb-stat-label">ç™¼è¡ŒCBå…¬å¸æ•¸</div>
                </div>
                <div class="cb-stat-item">
                    <div class="cb-stat-num">${Object.keys(stats.industries).length}</div>
                    <div class="cb-stat-label">æ¶µè“‹ç”¢æ¥­æ•¸</div>
                </div>
                <div class="cb-stat-item">
                    <div class="cb-stat-num">${fmtNum(stats.totalBalance/1000, 1)}</div>
                    <div class="cb-stat-label">ç¸½é¤˜é¡(åå„„)</div>
                </div>
            </div>
            <div class="cb-ind-title">ğŸ“Š å„ç”¢æ¥­CBåˆ†ä½ˆ</div>
            <div class="cb-ind-grid">
                ${industries.slice(0, 20).map(([ind, cnt]) => 
                    `<div class="cb-ind-tag" onclick="setSearch('${ind}')">${ind}<span class="num">${cnt}</span></div>`
                ).join('')}
            </div>
        </div>
    `;
}

function renderList() {
    const q = $('search').value.toLowerCase().trim();
    let list = [];
    
    // é¡¯ç¤º/éš±è— CB çµ±è¨ˆ
    if(CURR_DB === 'cb') {
        $('cbStatsArea').innerHTML = renderCBStats();
        $('cbStatsArea').style.display = 'block';
    } else {
        $('cbStatsArea').style.display = 'none';
    }
    
    if(CURR_DB==='news') list = DB.news;
    else if(CURR_DB==='memo') list = DB.memo;
    else if(CURR_DB==='reports') list = DB.reports;
    else if(CURR_DB==='strategy') list = DB.strategy;
    else if(CURR_DB==='stocks') list = Object.values(DB.stocks);
    else if(CURR_DB==='trends') list = DB.trends;
    else if(CURR_DB==='cb') list = DB.cb;

    const filtered = list.filter(i => {
        const str = JSON.stringify(i).toLowerCase();
        if(str.includes(q)) return true;
        if(CURR_DB==='memo' && i['ç·¨è™Ÿ']) {
            const d = META.memoDetail[i['ç·¨è™Ÿ']];
            if(d && JSON.stringify(d).toLowerCase().includes(q)) return true;
        }
        return false;
    });
    
    $('resCount').innerText = filtered.length;

    let html = '';
    
    // CB ç”¨è¡¨æ ¼å½¢å¼
    if(CURR_DB === 'cb') {
        html = `<div class="cb-table-wrap"><table class="cb-table">
            <thead><tr>
                <th>CBä»£è™Ÿ</th><th>CBç°¡ç¨±</th><th>æ¨™çš„è‚¡ç¥¨</th><th>ç”¢æ¥­</th>
                <th>è½‰æ›åƒ¹</th><th>è‚¡åƒ¹</th><th>è½‰æ›åƒ¹å€¼</th><th>æº¢æŠ˜åƒ¹%</th><th>åˆ°æœŸæ—¥</th>
            </tr></thead><tbody>`;
        
        filtered.slice(0, 100).forEach(r => {
            const cbCode = r['_cbCode'] || safe(r['ä»£è™Ÿ']);
            const cbName = r['_name'] || safe(r['åç¨±']);
            const stockCode = r['_stockCode'] || '';
            const stockName = r['_stockName'] || safe(r['è½‰æ›æ¨™çš„åç¨±']);
            const ind = r['_industry'] || '';
            const convPrice = r['è½‰æ›åƒ¹æ ¼(å…ƒ)'];
            const stockPrice = r['_stockPrice'];
            const convValue = r['_convValue'];
            const premium = r['_premium'];
            const expDate = fmtDate(r['åˆ°æœŸæ—¥']);
            const premClass = colorClass(premium);
            
            html += `<tr>
                <td class="code">${cbCode}</td>
                <td>${cbName}</td>
                <td class="stock" onclick="openStock('${stockCode}')">${stockName} ${stockCode}</td>
                <td>${ind}</td>
                <td>${fmtNum(convPrice, 1)}</td>
                <td>${fmtNum(stockPrice, 2)}</td>
                <td class="${colorClass(convValue)}">${fmtNum(convValue, 2)}</td>
                <td class="${premClass}">${premium ? fmtNum(premium, 1)+'%' : '-'}</td>
                <td>${expDate}</td>
            </tr>`;
        });
        
        html += `</tbody></table></div>`;
    } else {
        // å…¶ä»–åˆ†é ç”¨å¡ç‰‡
        filtered.slice(0, 100).forEach(i => {
            let title='', sub='', date='', code='', tagClass='brk', body='', click='';
            
            if(CURR_DB==='stocks') {
                title = i['å…¬å¸åç¨±']; code = i['ä»£è™Ÿ']; sub = i['ç”¢æ¥­åˆ†é¡']; 
                body = i['æ¥­å‹™æ‘˜è¦'] || '';
                click = `openStock('${code}')`;
            }
            else if(CURR_DB==='news') {
                title = i['å…¬å¸']; code = i['è‚¡è™Ÿ']; sub = i['å ±å°é‡é»åˆ†é¡']; 
                date = i['æ—¥æœŸ']; tagClass = 'ind';
                body = safe(i['å®Œæ•´å ±å°å…§å®¹']).substring(0, 150);
                click = `openNews('${i['ç·¨è™Ÿ']}')`;
            }
            else if(CURR_DB==='memo') {
                title = i['å…¬å¸']; code = i['è‚¡è™Ÿ']; sub = i['å ±å‘Šé¡å‹']; date = i['æ—¥æœŸ'];
                const d = META.memoDetail[i['ç·¨è™Ÿ']];
                body = d ? (safe(d['ç‡Ÿé‹é‡é»']).substring(0,100) + '...') : 'é»æ“ŠæŸ¥çœ‹è©³æƒ…';
                click = `openMemo('${i['ç·¨è™Ÿ']}')`;
            }
            else if(CURR_DB==='reports') {
                title = i['å ±å‘Šæ¨™é¡Œ']; sub = i['åˆ¸å•†åç¨±'] + ' - ' + safe(i['ç”¢æ¥­åç¨±']); 
                date = i['å ±å‘Šæ—¥æœŸ']; tagClass = 'ind';
                body = i['å‰¯æ¨™é¡Œ'] || '';
                click = `openReport('${i['å ±å‘Šç·¨è™Ÿ']}')`;
            }
            else if(CURR_DB==='strategy') {
                title = i['å ±å‘Šæ¨™é¡Œ']; sub = i['åˆ¸å•†åç¨±']; date = i['å ±å‘Šæ—¥æœŸ'];
                body = i['å¤§ç›¤è§€é»'] || i['å‰¯æ¨™é¡Œ'] || '';
                click = `openStrategy('${i['å ±å‘Šç·¨è™Ÿ']}')`;
            }
            else if(CURR_DB==='trends') {
                title = i['ç”¢æ¥­']; sub = i['è¶¨å‹¢åˆ¤æ–·']; tagClass = 'trend-up';
                code = i['è‚¡è™Ÿ']; 
                body = `ä»£è¡¨:${i['ä»£è¡¨å…¬å¸']} | ä½ç½®:${i['æ™¯æ°£ä½ç½®']}`;
                click = `openTrend('${i['ç”¢æ¥­']}')`;
            }

            html += `<div class="card" onclick="${click}">
                <div class="card-head"><div class="card-title">${title} ${code?`<span style="color:#999;font-weight:400">${code}</span>`:''}</div></div>
                <div class="card-meta"><span class="tag ${tagClass}">${sub||'ä¸€èˆ¬'}</span>${date?`<span class="tag dt">${fmtDate(date)}</span>`:''}</div>
                <div class="card-body">${body}</div>
            </div>`;
        });
    }
    
    $('list').innerHTML = html || '<div style="text-align:center;padding:30px;color:#999">ç„¡ç›¸ç¬¦è³‡æ–™</div>';
}

// Modal ç›¸é—œ
function showModal(infoHtml, navItems) {
    $('m-info').innerHTML = infoHtml;
    $('navGrid').innerHTML = navItems.map((n,i) => 
        `<button class="nav-btn ${i===0?'active':''}" onclick="swTab('${n.id}', this)">${n.icon} ${n.label}</button>`
    ).join('');
    $('navGrid').style.display = navItems.length > 1 ? 'flex' : 'none';
    $('modal').classList.add('show');
}

window.swTab = (id, el) => {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    if(el) el.classList.add('active');
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    const pane = document.getElementById('tab-'+id);
    if(pane) pane.classList.add('active');
};

window.swFin = idx => {
    document.querySelectorAll('.fin-btn').forEach((b,i) => b.classList.toggle('active', i===idx));
    document.querySelectorAll('.fin-sub-pane').forEach((p,i) => p.classList.toggle('active', i===idx));
};

window.closeModal = e => {
    if(!e || e.target.id==='modal' || e.target.classList.contains('m-close')) {
        $('modal').classList.remove('show');
    }
};

// é–‹å•Ÿå€‹è‚¡
window.openStock = code => {
    if(!code || code==='-') return;
    code = normalizeCode(code);
    const s = DB.stocks[code] || { 'å…¬å¸åç¨±': code, 'ä»£è™Ÿ': code };
    const name = s['å…¬å¸åç¨±'] || code;
    const concepts = META.concepts[code] || [];
    const cbs = META.cbMap[code] || [];
    const memos = META.relatedMemo[code] || [];
    const news = META.relatedNews[code] || [];
    const fin = META.finance[name] || {};
    const prod = META.products[name] || {};
    const track = META.tracking[name] || {};
    const revM = META.revData.month[code] || [];
    const revQ = META.revData.quarter[code] || [];
    const revY = META.revData.year[code] || [];
    const revH = META.revData.highlights[code] || {};

    const infoHtml = `
        <div style="font-size:22px;font-weight:700;margin-bottom:5px">${name} <span style="color:#999;font-size:16px">${code}</span></div>
        <div class="card-meta">
            <span class="tag ind">${s['ç”¢æ¥­åˆ†é¡']||'æœªåˆ†é¡'}</span>
            ${concepts.slice(0,3).map(c=>`<span class="tag concept">#${c.concept}</span>`).join('')}
        </div>
        <div style="font-size:13px;color:#666;margin-top:5px;line-height:1.5">${s['æ¥­å‹™æ‘˜è¦']||''}</div>
    `;

    const navItems = [
        {id:'basic', icon:'ğŸ“Š', label:'ç¸½è¦½'},
        {id:'fin', icon:'ğŸ’°', label:'ç‡Ÿæ”¶'},
        {id:'prod', icon:'ğŸ“¦', label:'ç”¢å“'},
        {id:'rep', icon:'ğŸ“°', label:'å ±å‘Š'},
        {id:'rate', icon:'â­', label:'è©•åƒ¹'}
    ];

    // Tab 1: åŸºæœ¬è³‡æ–™
    let tBasic = `
        <div class="grid-2">
            <div class="stat-box"><div class="num">${s['æˆäº¤']||'-'}</div><div class="lbl">æ”¶ç›¤åƒ¹</div></div>
            <div class="stat-box"><div class="num ${colorClass(s['æ¼²è·Œå¹…'])}">${s['æ¼²è·Œå¹…']||'-'}%</div><div class="lbl">æ¼²è·Œå¹…</div></div>
        </div>
    `;
    if(concepts.length) {
        tBasic += `<div class="section-head">ğŸ’¡ æ¦‚å¿µè‚¡åˆ†é¡</div>`;
        tBasic += concepts.map(c => `<div class="list-item" onclick="setSearch('#${c.concept}');closeModal()"><div class="list-title">#${c.concept}</div><div class="list-sub">${c.sub||''}</div></div>`).join('');
    }
    if(cbs.length) {
        tBasic += `<div class="section-head">ğŸ« å¯è½‰å‚µ (${cbs.length})</div>`;
        tBasic += cbs.map(c => `<div class="hl-block"><b>${c['åç¨±']}</b><br>è½‰åƒ¹: ${c['è½‰æ›åƒ¹æ ¼(å…ƒ)']} | é¤˜é¡: ${c['æœ€æ–°é¤˜é¡(ç™¾è¬)']}M | åˆ°æœŸ: ${fmtDate(c['åˆ°æœŸæ—¥'])}</div>`).join('');
    }

    // Tab 2: ç‡Ÿæ”¶
    let tFin = '';
    
    // Debug info
    console.log('ç‡Ÿæ”¶è³‡æ–™:', code, 'æœˆ:', revM.length, 'å­£:', revQ.length, 'å¹´:', revY.length);
    
    // ç‡Ÿæ”¶äº®é»
    if(revH['å–®æœˆç‡Ÿæ”¶å‰µç´€éŒ„æœˆæ•¸']) {
        tFin += `<div style="margin-bottom:15px"><span class="tag trend-up">ğŸ”¥ æ­·å²æ–°é«˜ ${revH['å–®æœˆç‡Ÿæ”¶å‰µç´€éŒ„æœˆæ•¸']} æ¬¡</span></div>`;
    }
    
    if(revM.length > 0 || revQ.length > 0 || revY.length > 0) {
        // åªå–è¿‘12æœŸ
        const recent12M = revM.slice(0, 12);
        const recent12Q = revQ.slice(0, 12);
        const recent12Y = revY.slice(0, 12);
        
        // è¨ˆç®—æœˆå¢ç‡å’Œå¹´å¢ç‡
        const revWithGrowth = recent12M.map((r, idx) => {
            const prevMonth = revM.find(p => p.month === r.month && p.year === r.year - 1);
            const lastMonth = revM.find(p => {
                if(r.month === 1) return p.year === r.year - 1 && p.month === 12;
                return p.year === r.year && p.month === r.month - 1;
            });
            return {
                ...r,
                yoy: prevMonth ? ((r.rev - prevMonth.rev) / prevMonth.rev * 100) : null,
                mom: lastMonth ? ((r.rev - lastMonth.rev) / lastMonth.rev * 100) : null,
                prevYearRev: prevMonth ? prevMonth.rev : null
            };
        });
        
        // å¹´åº¦æ¯”è¼ƒè¡¨ - å»ºç«‹è³‡æ–™çµæ§‹ï¼ˆåªå–è¿‘4å¹´ï¼‰
        const years = [...new Set(revM.map(r => r.year))].sort((a,b) => b-a).slice(0, 4);
        const monthlyByYear = {};
        years.forEach(y => { monthlyByYear[y] = {}; });
        revM.forEach(r => {
            if(monthlyByYear[r.year]) monthlyByYear[r.year][r.month] = r.rev;
        });
        
        // è¨ˆç®—å¹´åº¦åŠ ç¸½å’Œå¹´å¢ç‡
        const yearTotals = years.map(y => {
            const total = Object.values(monthlyByYear[y] || {}).reduce((a,b) => a+b, 0);
            return { year: y, total };
        });
        const yearGrowth = yearTotals.map((yt, idx) => {
            const prev = yearTotals[idx + 1];
            return { ...yt, yoy: prev ? ((yt.total - prev.total) / prev.total * 100) : null };
        });
        
        tFin += `
            <div class="fin-switcher">
                <div class="fin-btn active" onclick="swFin(0)">æœˆç‡Ÿæ”¶</div>
                <div class="fin-btn" onclick="swFin(1)">å¹´ç‡Ÿæ”¶</div>
            </div>
            
            <div id="ft-0" class="fin-sub-pane active">
                ${revWithGrowth.length > 0 ? `
                <div class="rev-unit">ğŸ’° å–®ä½ï¼šå„„å…ƒ</div>
                <div class="table-wrap"><table class="fin-table">
                    <thead><tr>
                        <th>æœŸåˆ¥</th>
                        <th>ç‡Ÿæ¥­æ”¶å…¥</th>
                        <th>æœˆå¢ç‡</th>
                        <th>å»å¹´åŒæœŸ</th>
                        <th>å¹´å¢ç‡</th>
                    </tr></thead>
                    <tbody>${revWithGrowth.map(r => {
                        const momClass = r.mom > 0 ? '' : (r.mom < 0 ? 't-down' : '');
                        const yoyClass = r.yoy > 0 ? '' : (r.yoy < 0 ? 't-down' : '');
                        return `<tr>
                            <td>${r.d}</td>
                            <td>${fmtNum(r.rev, 1)}</td>
                            <td class="${momClass}">${r.mom !== null ? (r.mom >= 0 ? '+' : '') + fmtNum(r.mom, 2) + '%' : '-'}</td>
                            <td>${r.prevYearRev ? fmtNum(r.prevYearRev, 1) : '-'}</td>
                            <td class="${yoyClass}">${r.yoy !== null ? (r.yoy >= 0 ? '+' : '') + fmtNum(r.yoy, 2) + '%' : '-'}</td>
                        </tr>`;
                    }).join('')}</tbody>
                </table></div>
                ` : '<div style="text-align:center;padding:20px;color:#999">ç„¡æœˆç‡Ÿæ”¶è³‡æ–™</div>'}
            </div>
            
            <div id="ft-1" class="fin-sub-pane">
                ${years.length > 0 ? `
                <div class="rev-unit">ğŸ’° å–®ä½ï¼šå„„å…ƒ</div>
                <div class="table-wrap"><table class="fin-table">
                    <thead><tr>
                        <th>æœŸåˆ¥</th>
                        ${years.map(y => `<th>${y}</th>`).join('')}
                    </tr></thead>
                    <tbody>
                        <tr class="highlight-row">
                            <td>å¹´åº¦åŠ ç¸½</td>
                            ${yearGrowth.map(yg => `<td>${fmtNum(yg.total, 1)}</td>`).join('')}
                        </tr>
                        <tr class="highlight-row">
                            <td>å¹´å¢ç‡</td>
                            ${yearGrowth.map(yg => {
                                const cls = yg.yoy > 0 ? '' : (yg.yoy < 0 ? 't-down' : '');
                                return `<td class="${cls}">${yg.yoy !== null ? (yg.yoy >= 0 ? '+' : '') + fmtNum(yg.yoy, 2) + '%' : '-'}</td>`;
                            }).join('')}
                        </tr>
                        ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `
                            <tr>
                                <td>${m}æœˆ</td>
                                ${years.map(y => `<td>${monthlyByYear[y]?.[m] ? fmtNum(monthlyByYear[y][m], 1) : ''}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table></div>
                ` : '<div style="text-align:center;padding:20px;color:#999">ç„¡å¹´ç‡Ÿæ”¶è³‡æ–™</div>'}
            </div>
        `;
    } else {
        tFin = '<div style="text-align:center;padding:30px;color:#999">ç„¡ç‡Ÿæ”¶è³‡æ–™<br><small>è«‹ç¢ºèª 06_revenue.xlsx å·²æ­£ç¢ºè¼‰å…¥</small></div>';
    }
    
    if(fin['4Q25æŒ‡å¼•']) tFin += `<div class="hl-block" style="margin-top:15px"><b>ğŸ”® æœªä¾†æŒ‡å¼•</b><br>${fmtTxt(fin['4Q25æŒ‡å¼•'])}</div>`;

    // Tab 3: ç”¢å“çµæ§‹
    let tProd = '';
    if(prod['ä¸»è¦ç”¢å“1']) {
        tProd += `<div class="section-head">ğŸ“¦ ç”¢å“çµ„åˆ</div>`;
        [1,2,3].forEach(n => {
            if(prod[`ä¸»è¦ç”¢å“${n}`]) {
                tProd += `<div class="info-row"><span class="info-label">${prod[`ä¸»è¦ç”¢å“${n}`]}</span><span class="info-val">${prod[`ä½”æ¯”/è¡¨ç¾${n}`]||''}</span></div>`;
            }
        });
    }
    if(prod['é—œéµæˆé•·å‹•èƒ½']) tProd += `<div class="hl-block"><b>ğŸš€ æˆé•·å‹•èƒ½</b><br>${fmtTxt(prod['é—œéµæˆé•·å‹•èƒ½'])}</div>`;
    if(prod['2026å±•æœ›']) tProd += `<div class="hl-block"><b>ğŸ”® 2026å±•æœ›</b><br>${fmtTxt(prod['2026å±•æœ›'])}</div>`;
    if(!tProd) tProd = '<div style="text-align:center;padding:30px;color:#999">ç„¡ç”¢å“è³‡æ–™</div>';

    // Tab 4: ç›¸é—œå ±å‘Š
    let tRep = '';
    if(memos.length) {
        tRep += `<div class="section-head">ğŸ“‹ Call Memo (${memos.length})</div>`;
        memos.forEach(m => {
            tRep += `<div class="list-item" onclick="openMemo('${m['ç·¨è™Ÿ']}')">
                <div class="list-title">${m['åˆ¸å•†']} - ${m['å ±å‘Šé¡å‹']}</div>
                <div class="list-sub">${fmtDate(m['æ—¥æœŸ'])} | ${m['é‡è¦æ€§']||''}</div>
            </div>`;
        });
    }
    if(news.length) {
        tRep += `<div class="section-head">âš¡ å¤–é›»å ±å° (${news.length})</div>`;
        news.slice(0,5).forEach(n => {
            tRep += `<div class="list-item" onclick="openNews('${n['ç·¨è™Ÿ']}')">
                <div class="list-title">${n['å ±å°é‡é»åˆ†é¡']}</div>
                <div class="list-sub">${fmtDate(n['æ—¥æœŸ'])}</div>
            </div>`;
        });
    }
    if(!tRep) tRep = '<div style="text-align:center;padding:30px;color:#999">ç„¡ç›¸é—œå ±å‘Š</div>';

    // Tab 5: è©•åƒ¹è©•ç­‰
    let tRate = '';
    if(track['æŠ•è³‡è©•ç­‰']) {
        tRate += `<div class="rating-card"><div class="label">æŠ•è³‡è©•ç­‰</div><div class="big-num">${track['æŠ•è³‡è©•ç­‰']}</div></div>`;
        tRate += `<div class="info-row"><span class="info-label">ç›®æ¨™åƒ¹</span><span class="info-val" style="color:var(--primary);font-size:18px">${track['ç›®æ¨™åƒ¹']||'-'}</span></div>`;
        tRate += `<div class="info-row"><span class="info-label">è¿½è¹¤ç‹€æ…‹</span><span class="info-val">${track['è¿½è¹¤ç‹€æ…‹']||'-'}</span></div>`;
    }
    if(!tRate) tRate = '<div style="text-align:center;padding:30px;color:#999">ç„¡è©•åƒ¹è³‡æ–™</div>';

    $('m-body').innerHTML = `
        <div id="tab-basic" class="tab-pane active">${tBasic}</div>
        <div id="tab-fin" class="tab-pane">${tFin}</div>
        <div id="tab-prod" class="tab-pane">${tProd}</div>
        <div id="tab-rep" class="tab-pane">${tRep}</div>
        <div id="tab-rate" class="tab-pane">${tRate}</div>
    `;
    showModal(infoHtml, navItems);
};

// é–‹å•Ÿ Memo
window.openMemo = id => {
    const m = DB.memo.find(i => String(i['ç·¨è™Ÿ']) === String(id));
    if(!m) return;
    const d = META.memoDetail[id] || {};

    const infoHtml = `
        <div style="font-size:20px;font-weight:700;margin-bottom:5px">${m['å…¬å¸']} <span style="color:#999;font-size:14px">${m['è‚¡è™Ÿ']}</span></div>
        <div class="card-meta">
            <span class="tag brk">${m['åˆ¸å•†']}</span>
            <span class="tag ind">${m['å ±å‘Šé¡å‹']}</span>
            <span class="tag dt">${fmtDate(m['æ—¥æœŸ'])}</span>
        </div>
        <div style="font-size:12px;color:#666;margin-top:5px">åˆ†æå¸«: ${m['åˆ†æå¸«']||'-'} | ${m['é‡è¦æ€§']||''}</div>
    `;

    // 7 å€‹ç¨ç«‹åˆ†é ï¼šç‡Ÿé‹é‡é»ã€ç­–ç•¥æ–¹å‘ã€QAæ‘˜è¦ã€Rexè§€å¯Ÿã€å¾ŒçºŒè¿½è¹¤ã€é—œéµæ™‚ç¨‹ã€æ¨™ç±¤
    const navItems = [
        {id:'op', icon:'ğŸ¯', label:'ç‡Ÿé‹é‡é»'},
        {id:'strat', icon:'ğŸš€', label:'ç­–ç•¥æ–¹å‘'},
        {id:'qa', icon:'â“', label:'QAæ‘˜è¦'},
        {id:'rex', icon:'ğŸ‘€', label:'Rexè§€å¯Ÿ'},
        {id:'follow', icon:'ğŸ“Œ', label:'å¾ŒçºŒè¿½è¹¤'},
        {id:'timeline', icon:'ğŸ“…', label:'é—œéµæ™‚ç¨‹'},
        {id:'tags', icon:'ğŸ·ï¸', label:'æ¨™ç±¤'}
    ];

    // Tab 1: ç‡Ÿé‹é‡é»
    const tOp = d['ç‡Ÿé‹é‡é»'] ? `<div class="hl-block">${fmtTxt(d['ç‡Ÿé‹é‡é»'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ç„¡è³‡æ–™</div>';
    
    // Tab 2: ç­–ç•¥æ–¹å‘
    const tStrat = d['ç­–ç•¥æ–¹å‘'] ? `<div class="hl-block">${fmtTxt(d['ç­–ç•¥æ–¹å‘'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ç„¡è³‡æ–™</div>';
    
    // Tab 3: QAæ‘˜è¦
    let tQA = '';
    if(d['é‡è¦QAæ‘˜è¦']) {
        const qaText = safe(d['é‡è¦QAæ‘˜è¦']);
        const lines = qaText.split('\n');
        let currentQ = '', currentA = '';
        lines.forEach(line => {
            if(line.match(/^Q\d*[ï¼š:]/i)) {
                if(currentQ && currentA) {
                    tQA += `<div class="qa-item"><div class="qa-q">${currentQ}</div><div class="qa-a">${currentA}</div></div>`;
                }
                currentQ = line.replace(/^Q\d*[ï¼š:]\s*/i, '');
                currentA = '';
            } else if(line.match(/^A\d*[ï¼š:]/i)) {
                currentA = line.replace(/^A\d*[ï¼š:]\s*/i, '');
            } else if(currentA) {
                currentA += '\n' + line;
            }
        });
        if(currentQ && currentA) {
            tQA += `<div class="qa-item"><div class="qa-q">${currentQ}</div><div class="qa-a">${currentA}</div></div>`;
        }
    }
    if(!tQA) tQA = '<div style="color:#999;text-align:center;padding:20px">ç„¡QAè³‡æ–™</div>';

    // Tab 4: Rexè§€å¯Ÿ
    const tRex = d['Rexè§€å¯Ÿ'] ? `<div class="hl-block">${fmtTxt(d['Rexè§€å¯Ÿ'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ç„¡è§€å¯Ÿè¨˜éŒ„</div>';

    // Tab 5: å¾ŒçºŒè¿½è¹¤
    const tFollow = d['å¾ŒçºŒè¿½è¹¤'] ? `<div class="hl-block">${fmtTxt(d['å¾ŒçºŒè¿½è¹¤'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ç„¡è¿½è¹¤é …ç›®</div>';

    // Tab 6: é—œéµæ™‚ç¨‹
    let tTimeline = '';
    if(d['é—œéµæ™‚ç¨‹']) {
        safe(d['é—œéµæ™‚ç¨‹']).split('\n').filter(l=>l.trim()).forEach(line => {
            const match = line.match(/^\[([^\]]+)\]\s*(.+)/);
            if(match) {
                tTimeline += `<div class="timeline-item"><div class="timeline-date">${match[1]}</div><div class="timeline-text">${match[2]}</div></div>`;
            } else {
                tTimeline += `<div class="timeline-item"><div class="timeline-text">${line}</div></div>`;
            }
        });
    }
    if(!tTimeline) tTimeline = '<div style="color:#999;text-align:center;padding:20px">ç„¡æ™‚ç¨‹è³‡æ–™</div>';

    // Tab 7: æ¨™ç±¤
    let tTags = '';
    if(d['æ¨™ç±¤']) {
        tTags = `<div style="display:flex;flex-wrap:wrap;gap:8px;padding:10px 0">`;
        safe(d['æ¨™ç±¤']).split(/[,ï¼Œ\s]+/).filter(t=>t).forEach(tag => {
            tTags += `<span class="tag concept" style="cursor:pointer;padding:8px 15px;font-size:13px" onclick="setSearch('${tag}');closeModal()">${tag}</span>`;
        });
        tTags += `</div>`;
    }
    if(!tTags) tTags = '<div style="color:#999;text-align:center;padding:20px">ç„¡æ¨™ç±¤</div>';

    $('m-body').innerHTML = `
        <div id="tab-op" class="tab-pane active">${tOp}</div>
        <div id="tab-strat" class="tab-pane">${tStrat}</div>
        <div id="tab-qa" class="tab-pane">${tQA}</div>
        <div id="tab-rex" class="tab-pane">${tRex}</div>
        <div id="tab-follow" class="tab-pane">${tFollow}</div>
        <div id="tab-timeline" class="tab-pane">${tTimeline}</div>
        <div id="tab-tags" class="tab-pane">${tTags}</div>
    `;
    showModal(infoHtml, navItems);
};

// é–‹å•Ÿç”¢æ¥­å ±å‘Š
window.openReport = rid => {
    const r = DB.reports.find(i => i['å ±å‘Šç·¨è™Ÿ'] === rid);
    if(!r) return;
    
    const focus = META.reportFocus[rid] || [];
    const views = META.reportViews[rid] || {};
    const ratings = META.reportRatings[rid] || [];

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;color:var(--primary);margin-bottom:5px">${r['å ±å‘Šæ¨™é¡Œ']}</div>
        <div class="card-meta">
            <span class="tag brk">${r['åˆ¸å•†åç¨±']}</span>
            <span class="tag ind">${r['ç”¢æ¥­åç¨±']||''}</span>
            <span class="tag dt">${fmtDate(r['å ±å‘Šæ—¥æœŸ'])}</span>
        </div>
    `;

    const navItems = [
        {id:'sum', icon:'ğŸ“Š', label:'ç¸½è¦½'},
        {id:'focus', icon:'ğŸ”', label:'ç„¦é»åˆ†æ'},
        {id:'view', icon:'ğŸ’¡', label:'åˆ¸å•†è§€é»'},
        {id:'pick', icon:'â­', label:'å€‹è‚¡è©•åƒ¹'}
    ];

    let tSum = '';
    ['æ ¸å¿ƒé‡é»1','æ ¸å¿ƒé‡é»2','æ ¸å¿ƒé‡é»3','æ ¸å¿ƒé‡é»4','æ ¸å¿ƒé‡é»5'].forEach((k,i) => {
        if(r[k]) tSum += `<div class="hl-block"><b>${i+1}.</b> ${r[k]}</div>`;
    });
    if(r['ç”¢æ¥­è©•ç­‰']) tSum += `<div class="info-row"><span class="info-label">ç”¢æ¥­è©•ç­‰</span><span class="info-val" style="color:var(--primary)">${r['ç”¢æ¥­è©•ç­‰']}</span></div>`;

    let tFocus = '';
    if(focus.length) {
        focus.forEach(f => {
            tFocus += `<div class="section-head">${f['æ®µè½æ¨™é¡Œ']||`æ®µè½${f['æ®µè½ç·¨è™Ÿ']}`}</div>`;
            tFocus += `<div class="hl-block">${fmtTxt(f['æ®µè½å…§å®¹'])}</div>`;
            if(f['å¸‚å ´è¦æ¨¡æ•¸æ“š']) tFocus += `<div class="info-row"><span class="info-label">å¸‚å ´è¦æ¨¡</span><span class="info-val">${f['å¸‚å ´è¦æ¨¡æ•¸æ“š']}</span></div>`;
        });
    } else tFocus = '<div style="color:#999;text-align:center;padding:20px">ç„¡ç„¦é»åˆ†æ</div>';

    let tView = '';
    if(views['è§€é»å…§å®¹']) tView += `<div class="hl-block">${fmtTxt(views['è§€é»å…§å®¹'])}</div>`;
    [1,2,3].forEach(n => {
        if(views[`é¦–é¸å€‹è‚¡${n}`]) tView += `<div class="list-item"><div class="list-title">ğŸŒŸ ${views[`é¦–é¸å€‹è‚¡${n}`]}</div><div class="list-sub">${views[`é¦–é¸ç†ç”±${n}`]||''}</div></div>`;
    });
    if(views['é¢¨éšªæé†’']) tView += `<div class="hl-block" style="border-left-color:#e74c3c"><b>âš ï¸ é¢¨éšªæé†’</b><br>${views['é¢¨éšªæé†’']}</div>`;
    if(!tView) tView = '<div style="color:#999;text-align:center;padding:20px">ç„¡åˆ¸å•†è§€é»</div>';

    let tPick = '';
    if(ratings.length) {
        ratings.forEach(rt => {
            const stockCode = normalizeCode(rt['è‚¡ç¥¨ä»£è™Ÿ']);
            tPick += `<div class="list-item" onclick="openStock('${stockCode}')">
                <div class="list-title">${rt['å…¬å¸åç¨±']} <span style="color:#999">${stockCode}</span></div>
                <div style="display:flex;gap:15px;margin-top:8px;font-size:12px">
                    <div><span style="color:#888">è©•ç­‰</span> <b style="color:var(--primary)">${rt['è©•ç­‰']||'-'}</b></div>
                    <div><span style="color:#888">ç›®æ¨™åƒ¹</span> <b>${rt['ç›®æ¨™åƒ¹']||'-'}</b></div>
                    <div><span style="color:#888">25F EPS</span> <b>${rt['EPS_FY25F']||'-'}</b></div>
                </div>
                ${rt['æŠ•è³‡äº®é»']?`<div style="font-size:12px;color:#666;margin-top:5px">${rt['æŠ•è³‡äº®é»']}</div>`:''}
            </div>`;
        });
    } else tPick = '<div style="color:#999;text-align:center;padding:20px">ç„¡å€‹è‚¡è©•åƒ¹</div>';

    $('m-body').innerHTML = `
        <div id="tab-sum" class="tab-pane active">${tSum}</div>
        <div id="tab-focus" class="tab-pane">${tFocus}</div>
        <div id="tab-view" class="tab-pane">${tView}</div>
        <div id="tab-pick" class="tab-pane">${tPick}</div>
    `;
    showModal(infoHtml, navItems);
};

// é–‹å•Ÿç­–ç•¥å ±å‘Š
window.openStrategy = rid => {
    const r = DB.strategy.find(i => i['å ±å‘Šç·¨è™Ÿ'] === rid);
    if(!r) return;

    const macro = META.stratMacro[rid] || [];
    const fund = META.stratFundamental[rid] || [];
    const theme = META.stratTheme[rid] || [];
    const quarter = META.stratQuarter[rid] || [];
    const picks = META.stratPicks[rid] || [];

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;color:var(--primary);margin-bottom:5px">${r['å ±å‘Šæ¨™é¡Œ']}</div>
        <div class="card-meta">
            <span class="tag brk">${r['åˆ¸å•†åç¨±']}</span>
            <span class="tag dt">${fmtDate(r['å ±å‘Šæ—¥æœŸ'])}</span>
        </div>
    `;

    const navItems = [
        {id:'over', icon:'ğŸ“Š', label:'ç¸½è¦½'},
        {id:'macro', icon:'ğŸŒ', label:'ç¸½ç¶“'},
        {id:'theme', icon:'ğŸ¯', label:'é¡Œæ'},
        {id:'pick', icon:'â­', label:'é¸è‚¡'}
    ];

    let tOver = '';
    if(r['å¤§ç›¤è§€é»']) tOver += `<div class="hl-block"><b>ğŸ“Š å¤§ç›¤è§€é»</b><br>${fmtTxt(r['å¤§ç›¤è§€é»'])}</div>`;
    if(r['æŒ‡æ•¸é æ¸¬å€é–“_ä½'] && r['æŒ‡æ•¸é æ¸¬å€é–“_é«˜']) {
        tOver += `<div class="rating-card"><div class="label">æŒ‡æ•¸é æ¸¬å€é–“</div><div class="big-num">${r['æŒ‡æ•¸é æ¸¬å€é–“_ä½']} ~ ${r['æŒ‡æ•¸é æ¸¬å€é–“_é«˜']}</div></div>`;
    }
    if(r['ç¸½ç¶“è§€é»æ‘˜è¦']) tOver += `<div class="hl-block"><b>ğŸŒ ç¸½ç¶“è§€é»</b><br>${fmtTxt(r['ç¸½ç¶“è§€é»æ‘˜è¦'])}</div>`;
    if(r['åŸºæœ¬é¢è§€é»']) tOver += `<div class="hl-block"><b>ğŸ“ˆ åŸºæœ¬é¢è§€é»</b><br>${fmtTxt(r['åŸºæœ¬é¢è§€é»'])}</div>`;

    let tMacro = '';
    macro.forEach(m => {
        tMacro += `<div class="section-head">${m['åˆ†æä¸»é¡Œ']||'ç¸½ç¶“åˆ†æ'}</div>`;
        tMacro += `<div class="hl-block">${fmtTxt(m['åˆ†æå…§å®¹'])}</div>`;
    });
    fund.forEach(f => {
        tMacro += `<div class="section-head">${f['åˆ†æä¸»é¡Œ']||'åŸºæœ¬é¢åˆ†æ'}</div>`;
        tMacro += `<div class="hl-block">${fmtTxt(f['åˆ†æå…§å®¹'])}</div>`;
    });
    if(!tMacro) tMacro = '<div style="color:#999;text-align:center;padding:20px">ç„¡åˆ†æå…§å®¹</div>';

    let tTheme = '';
    theme.forEach(t => {
        tTheme += `<div class="section-head">${t['é¡Œæä¸»é¡Œ']||'é¡Œæè¶¨å‹¢'}</div>`;
        tTheme += `<div class="hl-block">${fmtTxt(t['é¡Œæå…§å®¹'])}</div>`;
    });
    if(quarter.length) {
        tTheme += `<div class="section-head">ğŸ“… å­£åº¦è¡Œæƒ…è¦åŠƒ</div>`;
        quarter.forEach(q => {
            tTheme += `<div class="list-item">
                <div class="list-title">${q['å­£åº¦']}</div>
                <div style="font-size:12px;color:#666">æŒ‡æ•¸é æ¸¬: ${q['æŒ‡æ•¸é æ¸¬_ä½']} ~ ${q['æŒ‡æ•¸é æ¸¬_é«˜']}</div>
                <div style="font-size:12px;margin-top:5px"><span style="color:#27ae60">åˆ©å¤š:</span> ${[q['åˆ©å¤šå› ç´ 1'],q['åˆ©å¤šå› ç´ 2'],q['åˆ©å¤šå› ç´ 3']].filter(i=>i).join('ã€')}</div>
                <div style="font-size:12px"><span style="color:#e74c3c">åˆ©ç©º:</span> ${[q['åˆ©ç©ºå› ç´ 1'],q['åˆ©ç©ºå› ç´ 2'],q['åˆ©ç©ºå› ç´ 3']].filter(i=>i).join('ã€')}</div>
            </div>`;
        });
    }
    if(!tTheme) tTheme = '<div style="color:#999;text-align:center;padding:20px">ç„¡é¡Œæåˆ†æ</div>';

    let tPick = '';
    if(picks.length) {
        const byInd = {};
        picks.forEach(p => {
            const cat = (p['ç”¢æ¥­é¡åˆ¥']||'å…¶ä»–') + '/' + (p['ç”¢æ¥­åˆ†é¡']||'');
            if(!byInd[cat]) byInd[cat] = [];
            byInd[cat].push(p);
        });
        Object.keys(byInd).forEach(cat => {
            tPick += `<div class="section-head">${cat}</div>`;
            byInd[cat].forEach(p => {
                const code = normalizeCode(p['è‚¡ç¥¨ä»£è™Ÿ']);
                tPick += `<div class="list-item" onclick="openStock('${code}')">
                    <div class="list-title">${p['å…¬å¸åç¨±']} <span style="color:#999">${code}</span></div>
                    <div class="list-sub">${p['æŠ•è³‡é¡Œæ']||''}</div>
                </div>`;
            });
        });
    } else tPick = '<div style="color:#999;text-align:center;padding:20px">ç„¡é¸è‚¡ç­–ç•¥</div>';

    $('m-body').innerHTML = `
        <div id="tab-over" class="tab-pane active">${tOver}</div>
        <div id="tab-macro" class="tab-pane">${tMacro}</div>
        <div id="tab-theme" class="tab-pane">${tTheme}</div>
        <div id="tab-pick" class="tab-pane">${tPick}</div>
    `;
    showModal(infoHtml, navItems);
};

// é–‹å•Ÿç”¢æ¥­è¶¨å‹¢
window.openTrend = indName => {
    const t = DB.trends.find(i => i['ç”¢æ¥­'] === indName);
    if(!t) return;

    const infoHtml = `
        <div style="font-size:20px;font-weight:700;margin-bottom:5px">${t['ç”¢æ¥­']}</div>
        <div class="card-meta">
            <span class="tag trend-up">${t['è¶¨å‹¢åˆ¤æ–·']}</span>
            <span class="tag ind">${t['æ™¯æ°£ä½ç½®']}</span>
        </div>
    `;

    const stockCode = normalizeCode(t['è‚¡è™Ÿ']);
    const content = `
        <div class="info-row"><span class="info-label">ä»£è¡¨å…¬å¸</span><span class="info-val tag-link" onclick="openStock('${stockCode}')">${t['ä»£è¡¨å…¬å¸']} ${stockCode}</span></div>
        <div class="section-head">ğŸš€ é—œéµé©…å‹•å› ç´ </div>
        <div class="hl-block">${fmtTxt(t['é—œéµé©…å‹•å› ç´ '])}</div>
        <div class="section-head">âš ï¸ é¢¨éšªå› ç´ </div>
        <div class="hl-block" style="border-left-color:#e74c3c">${fmtTxt(t['é¢¨éšªå› ç´ '])}</div>
        <div class="section-head">ğŸ”® 2026å±•æœ›</div>
        <div class="hl-block">${fmtTxt(t['2026å±•æœ›'])}</div>
        <div class="section-head">ğŸ’¡ æŠ•è³‡å»ºè­°</div>
        <div class="hl-block">${fmtTxt(t['æŠ•è³‡å»ºè­°'])}</div>
    `;

    $('m-body').innerHTML = `<div id="tab-main" class="tab-pane active">${content}</div>`;
    showModal(infoHtml, []);
};

// é–‹å•Ÿå¤–é›»
window.openNews = id => {
    const n = DB.news.find(i => String(i['ç·¨è™Ÿ']) === String(id));
    if(!n) return;

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;margin-bottom:5px">${n['å…¬å¸']} <span style="color:#999;font-size:14px">${n['è‚¡è™Ÿ']}</span></div>
        <div class="card-meta">
            <span class="tag ind">${n['å ±å°é‡é»åˆ†é¡']}</span>
            <span class="tag dt">${fmtDate(n['æ—¥æœŸ'])}</span>
        </div>
    `;

    let content = `<div class="hl-block">${fmtTxt(n['å®Œæ•´å ±å°å…§å®¹'])}</div>`;
    if(n['æ¨™ç±¤']) {
        content += `<div style="margin-top:15px;display:flex;flex-wrap:wrap;gap:5px">`;
        safe(n['æ¨™ç±¤']).split(/[,ï¼Œ\s]+/).forEach(tag => {
            if(tag) content += `<span class="tag concept" style="cursor:pointer" onclick="setSearch('${tag}');closeModal()">${tag}</span>`;
        });
        content += `</div>`;
    }

    $('m-body').innerHTML = `<div id="tab-main" class="tab-pane active">${content}</div>`;
    showModal(infoHtml, []);
};

window.onload = init;
</script>
</body>
</html>
