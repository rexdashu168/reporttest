<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤ (AI Mirror)</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>if(typeof XLSX==='undefined'){document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>');}</script>
    <style>
        /* ===== è¦–è¦ºé¢¨æ ¼ (Rex Style) ===== */
        :root { --primary: #c96442; --bg: #f5f4ef; --text: #333; --border: #e0e0e0; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 12px; }

        /* Loading */
        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .splash-icon { font-size: 48px; animation: bounce 2s infinite; margin-bottom: 15px; }
        .splash-bar { width: 200px; height: 4px; background: #ddd; border-radius: 2px; overflow: hidden; margin-top: 15px; }
        .splash-progress { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

        /* Header & Nav */
        .header { text-align: center; padding: 20px 0; border-bottom: 1px solid var(--border); }
        .header h1 { color: var(--primary); font-size: 22px; margin-bottom: 5px; }
        .db-switcher { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin: 15px 0; }
        .db-tab { padding: 6px 14px; background: #fff; border: 1px solid var(--border); border-radius: 20px; font-size: 13px; color: #666; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .db-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); transform: scale(1.05); }
        .count { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 10px; font-size: 10px; }

        /* Search */
        .search-box { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 12px 12px 40px; border-radius: 25px; border: 2px solid var(--border); background: #fff; font-size: 15px; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #999; }

        /* Card List */
        .card-list { display: flex; flex-direction: column; gap: 12px; }
        .card { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; }
        .card:active { transform: scale(0.98); }
        .card-head { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .card-title { font-weight: 700; font-size: 16px; }
        .card-meta { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .tag { font-size: 11px; padding: 2px 8px; border-radius: 6px; color: #fff; font-weight: 500; }
        .tag.brk { background: var(--primary); }
        .tag.ind { background: #2980b9; }
        .tag.dt { background: #e0e0e0; color: #666; }
        .card-body { font-size: 13px; color: #555; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* Modal (Smart Layout) */
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-inner { background: #fff; width: 100%; max-width: 600px; height: 90vh; border-radius: 16px 16px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        .m-head { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .m-close { width: 32px; height: 32px; border-radius: 50%; border: none; background: #f0f0f0; font-size: 20px; color: #666; cursor: pointer; }
        .m-body { flex: 1; overflow-y: auto; padding: 15px; background: #fafaf8; }

        /* è‡ªå‹•æ’ç‰ˆå…ƒä»¶ */
        .auto-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        .stat-label { font-size: 11px; color: #888; margin-bottom: 3px; }
        .stat-val { font-size: 14px; font-weight: 700; color: #333; }
        
        .section-block { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .section-title { font-size: 14px; font-weight: 700; color: var(--primary); margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .content-text { font-size: 13px; line-height: 1.7; color: #444; white-space: pre-wrap; }

        /* æ¨™ç±¤å®¹å™¨ */
        .tags-row { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 15px; }
        .smart-tag { background: #e3f2fd; color: #1565c0; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 500; }

        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        @media(min-width: 768px) { .modal { align-items: center; } .modal-inner { height: 85vh; border-radius: 16px; } }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="splash-icon">ğŸ“Š</div>
    <div style="font-weight:700;font-size:18px;margin-bottom:5px" id="loadTitle">ç³»çµ±å•Ÿå‹•ä¸­...</div>
    <div style="font-size:13px;color:#888" id="loadSub">æ­£åœ¨åŒæ­¥ Excel è³‡æ–™åº«çµæ§‹...</div>
    <div class="splash-bar"><div class="splash-progress" id="loadBar"></div></div>
</div>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
        <p style="font-size:12px;color:#666">è³‡æ–™æ™ºæ…§æ•´åˆç³»çµ±</p>
    </div>

    <div class="db-switcher">
        <div class="db-tab active" onclick="setDB('news')">âš¡ å¤–é›»å ±å° <span class="count" id="c-news">0</span></div>
        <div class="db-tab" onclick="setDB('memo')">ğŸ“‹ Call Memo <span class="count" id="c-memo">0</span></div>
        <div class="db-tab" onclick="setDB('reports')">ğŸ“‘ ç”¢æ¥­å ±å‘Š <span class="count" id="c-reports">0</span></div>
        <div class="db-tab" onclick="setDB('strategy')">ğŸ¯ æŠ•è³‡ç­–ç•¥ <span class="count" id="c-strategy">0</span></div>
        <div class="db-tab" onclick="setDB('stocks')">ğŸ¢ å€‹è‚¡æŸ¥è©¢ <span class="count" id="c-stocks">0</span></div>
        <div class="db-tab" onclick="setDB('cb')">ğŸ« CBçµ±è¨ˆ <span class="count" id="c-cb">0</span></div>
    </div>

    <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" class="search-input" id="search" placeholder="è¼¸å…¥é—œéµå­—è‡ªå‹•å¿«æœ...">
    </div>

    <div style="font-size:12px;color:#666;margin-bottom:10px;">æ‰¾åˆ° <b id="resCount" style="color:var(--primary)">0</b> ç­†è³‡æ–™</div>
    <div class="card-list" id="list"></div>
</div>

<div class="modal" id="modal" onclick="closeModal(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">
        <div class="m-head">
            <div id="m-header"></div>
            <button class="m-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="m-body" id="m-body"></div>
    </div>
</div>

<script>
// --- æª”æ¡ˆè¨­å®š (å®Œå…¨å°æ‡‰ä½ çš„æª”æ¡ˆ) ---
const FILES = {
    NEWS: '01_news.xlsx', MEMO: '02_memo.xlsx', REPORTS: '03_reports.xlsx',
    MASTER: '04_master.xlsx', STRAT: '05_Strategy.xlsx', CB: '00_CB.xlsx', REV: '06_revenue.xlsx'
};

// å…¨åŸŸè³‡æ–™å®¹å™¨
const DB = { news:[], memo:[], reports:[], strategy:[], stocks:{}, cb:[] };
// é—œè¯ç´¢å¼• (é€™æ˜¯å¤§è…¦)
const IDX = { 
    memoDetail:{}, tracking:{}, finance:{}, products:{}, timeline:[], 
    reportDetail:{}, reportStocks:[], 
    revenue:{}, cbMap:{}, relatedNews:{}, relatedMemo:{}
};
let CURR_DB = 'news';

// --- å·¥å…· ---
const $ = id => document.getElementById(id);
const safe = v => (v==null || v==='undefined') ? '' : String(v).trim();
const fmtDate = v => {
    if(!v) return '';
    if(typeof v === 'number') {
        const d = new Date((v-25569)*86400000);
        return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
    }
    return v;
};
const loadStep = (t,s,p) => { $('loadTitle').innerText=t; $('loadSub').innerText=s; $('loadBar').style.width=p+'%'; };

// --- è¼‰å…¥å¼•æ“ ---
async function fetchXlsx(url) {
    try {
        const res = await fetch(url);
        if(!res.ok) throw new Error();
        return XLSX.read(await res.arrayBuffer(), {type:'array'});
    } catch(e) { console.warn('File not found:', url); return null; }
}

async function init() {
    loadStep('å•Ÿå‹•æ™ºæ…§å¼•æ“...', 'å»ºç«‹è³‡æ–™é—œè¯æ¨¡å‹', 10);
    
    // å¹³è¡Œè¼‰å…¥æ‰€æœ‰æª”æ¡ˆï¼Œé€Ÿåº¦æœ€å¿«
    const promises = [
        fetchXlsx(FILES.NEWS).then(wb => processNews(wb)),
        fetchXlsx(FILES.MEMO).then(wb => processMemo(wb)),
        fetchXlsx(FILES.REPORTS).then(wb => processReports(wb)),
        fetchXlsx(FILES.STRAT).then(wb => processStrat(wb)),
        fetchXlsx(FILES.CB).then(wb => processCB(wb)),
        fetchXlsx(FILES.MASTER).then(wb => processMaster(wb)),
        fetchXlsx(FILES.REV).then(wb => processRev(wb))
    ];

    await Promise.all(promises);

    loadStep('å®Œæˆ', 'æ­¡è¿ä½¿ç”¨', 100);
    updateCounts();
    renderList();
    $('search').addEventListener('input', renderList);
    setTimeout(()=>$('loader').classList.add('hidden'), 500);
}

// --- è³‡æ–™è™•ç†å™¨ (Extract & Index) ---
function processNews(wb) {
    if(!wb) return;
    XLSX.utils.sheet_to_json(wb.Sheets['å¤–é›»ç¶œåˆå ±å°']||[]).forEach(r => {
        if(safe(r['è³‡æ–™é¡å‹'])==='å€‹è‚¡å ±å°') {
            DB.news.push(r);
            const k = safe(r['è‚¡è™Ÿ']); if(k) { if(!IDX.relatedNews[k]) IDX.relatedNews[k]=[]; IDX.relatedNews[k].push(r); }
        }
    });
}

function processCB(wb) {
    if(!wb) return;
    XLSX.utils.sheet_to_json(wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™']||[]).forEach(r => {
        DB.cb.push(r);
        const k = safe(r['è½‰æ›æ¨™çš„ä»£ç¢¼']); if(k) { if(!IDX.cbMap[k]) IDX.cbMap[k]=[]; IDX.cbMap[k].push(r); }
    });
}

function processMemo(wb) {
    if(!wb) return;
    XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¡¨']||[]).forEach(r => {
        DB.memo.push(r);
        const k = safe(r['è‚¡è™Ÿ']); if(k) { if(!IDX.relatedMemo[k]) IDX.relatedMemo[k]=[]; IDX.relatedMemo[k].push(r); }
    });
    // å»ºç«‹ç´¢å¼•ï¼Œä¾›å½ˆçª—ä½¿ç”¨
    XLSX.utils.sheet_to_json(wb.Sheets['è©³ç´°å…§å®¹åº«']||[]).forEach(r=>IDX.memoDetail[safe(r['ç·¨è™Ÿ'])]=r);
    XLSX.utils.sheet_to_json(wb.Sheets['å…¬å¸è¿½è¹¤è¡¨']||[]).forEach(r=>IDX.tracking[safe(r['å…¬å¸'])]=r);
    XLSX.utils.sheet_to_json(wb.Sheets['è²¡å‹™æ•¸æ“šå½™ç¸½']||[]).forEach(r=>IDX.finance[safe(r['å…¬å¸'])]=r);
    XLSX.utils.sheet_to_json(wb.Sheets['ç”¢å“çµæ§‹åˆ†æ']||[]).forEach(r=>IDX.products[safe(r['å…¬å¸'])]=r);
}

function processReports(wb) {
    if(!wb) return;
    XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r=>DB.reports.push(r));
    XLSX.utils.sheet_to_json(wb.Sheets['ç„¦é»åˆ†æå…§å®¹']||[]).forEach(r=>{ 
        const id=safe(r['å ±å‘Šç·¨è™Ÿ']); if(!IDX.reportDetail[id]) IDX.reportDetail[id]=[]; IDX.reportDetail[id].push(r); 
    });
    XLSX.utils.sheet_to_json(wb.Sheets['å€‹è‚¡è©•åƒ¹è¡¨']||[]).forEach(r=>IDX.reportStocks.push(r));
}

function processStrat(wb) {
    if(!wb) return;
    XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r=>DB.strategy.push(r));
}

function processMaster(wb) {
    if(!wb) return;
    XLSX.utils.sheet_to_json(wb.Sheets['ä¸»è³‡æ–™åº«']||[]).forEach(r=>{ if(r['ä»£è™Ÿ']) DB.stocks[safe(r['ä»£è™Ÿ'])]=r; });
}

function processRev(wb) {
    if(!wb) return;
    const rows = XLSX.utils.sheet_to_json(wb.Sheets['000_æœˆç‡Ÿæ”¶']||[]);
    const h = Object.keys(rows[0]||{}).filter(k=>k.includes('å–®æœˆç‡Ÿæ”¶'));
    rows.forEach(r => { IDX.revenue[safe(r['ä»£è™Ÿ'])] = h.slice(-12).map(k=>({p:k.replace('å–®æœˆç‡Ÿæ”¶(å„„)',''), v:r[k]})); });
}

// --- åˆ—è¡¨æ¸²æŸ“ (Card Renderer) ---
function setDB(db) {
    CURR_DB = db;
    document.querySelectorAll('.db-tab').forEach(t=>t.classList.remove('active'));
    event.currentTarget.classList.add('active');
    renderList();
}

function updateCounts() {
    $('c-news').innerText = DB.news.length; $('c-memo').innerText = DB.memo.length;
    $('c-reports').innerText = DB.reports.length; $('c-strategy').innerText = DB.strategy.length;
    $('c-stocks').innerText = Object.keys(DB.stocks).length; $('c-cb').innerText = DB.cb.length;
}

function renderList() {
    const q = $('search').value.toLowerCase();
    let list = [], html = '';
    
    // Select Data Source
    if(CURR_DB==='news') list = DB.news;
    else if(CURR_DB==='memo') list = DB.memo;
    else if(CURR_DB==='reports') list = DB.reports;
    else if(CURR_DB==='strategy') list = DB.strategy;
    else if(CURR_DB==='stocks') list = Object.values(DB.stocks);
    else if(CURR_DB==='cb') list = DB.cb;

    const filtered = list.filter(i => JSON.stringify(i).toLowerCase().includes(q));
    $('resCount').innerText = filtered.length;

    filtered.slice(0,50).forEach(i => {
        let title, sub, date, content, id;
        
        // Mapping Logic: Identify Key Fields based on DB Type
        if(CURR_DB==='news') { id=i['ç·¨è™Ÿ']; title=i['å…¬å¸']; sub=i['åˆ¸å•†ä¾†æº']; date=i['æ—¥æœŸ']; content=i['å®Œæ•´å ±å°å…§å®¹']; }
        else if(CURR_DB==='memo') { id=i['ç·¨è™Ÿ']; title=`${i['å…¬å¸']} (${i['è‚¡è™Ÿ']})`; sub=i['åˆ¸å•†']; date=i['æ—¥æœŸ']; content=IDX.memoDetail[id]?.['ç‡Ÿé‹é‡é»']; }
        else if(CURR_DB==='reports') { id=i['å ±å‘Šç·¨è™Ÿ']; title=i['å ±å‘Šæ¨™é¡Œ']; sub=i['åˆ¸å•†åç¨±']; date=i['å ±å‘Šæ—¥æœŸ']; content=i['æ ¸å¿ƒé‡é»1']; }
        else if(CURR_DB==='strategy') { id=i['å ±å‘Šç·¨è™Ÿ']; title=i['å ±å‘Šæ¨™é¡Œ']; sub=i['å ±å‘Šé¡å‹']; date=i['å ±å‘Šæ—¥æœŸ']; content=i['ç¸½ç¶“è§€é»æ‘˜è¦']; }
        else if(CURR_DB==='stocks') { id=i['ä»£è™Ÿ']; title=`${i['å…¬å¸åç¨±']} ${i['ä»£è™Ÿ']}`; sub=i['ç”¢æ¥­åˆ†é¡']; content=i['æ¥­å‹™æ‘˜è¦']; }
        else if(CURR_DB==='cb') { id=i['ä»£è™Ÿ']; title=i['åç¨±']; sub=`è½‰åƒ¹:${i['è½‰æ›åƒ¹æ ¼(å…ƒ)']}`; content=`æ¨™çš„:${i['è½‰æ›æ¨™çš„åç¨±']} | é¤˜é¡:${i['æœ€æ–°é¤˜é¡(ç™¾è¬)']}`; }

        html += `<div class="card" onclick="openSmartModal('${CURR_DB}', '${id}')">
            <div class="card-head"><div class="card-title">${title}</div></div>
            <div class="card-meta"><span class="tag brk">${sub||'ä¸€èˆ¬'}</span>${date?`<span class="tag dt">${fmtDate(date)}</span>`:''}</div>
            <div class="card-body">${safe(content).substring(0,80)}...</div>
        </div>`;
    });
    $('list').innerHTML = html;
}

// ===== æ™ºæ…§å½ˆçª—å¼•æ“ (Smart Modal Engine) =====
// é€™æ®µæ˜¯æ ¸å¿ƒï¼šè‡ªå‹•æŠŠ Excel çš„æ¬„ä½è®Šæˆ UI
function openSmartModal(type, id) {
    let rawData = {}, mergedData = {};
    let title = '', tags = '';

    // 1. æ ¹æ“šé¡å‹æŠ“å–ä¸»è³‡æ–™
    if(type === 'memo') {
        const m = DB.memo.find(x=>x['ç·¨è™Ÿ']==id);
        const detail = IDX.memoDetail[id]||{};
        const track = IDX.tracking[m['å…¬å¸']]||{};
        const fin = IDX.finance[m['å…¬å¸']]||{};
        // åˆä½µæ‰€æœ‰ç›¸é—œè³‡æ–™ï¼Œè®“å¼•æ“å»ç•«åœ–
        mergedData = { ...m, ...track, ...fin, ...detail };
        title = `${m['å…¬å¸']} (${m['è‚¡è™Ÿ']})`;
        tags = `<span class="tag brk">${m['åˆ¸å•†']}</span><span class="tag dt">${fmtDate(m['æ—¥æœŸ'])}</span>`;
    } 
    else if(type === 'news') {
        mergedData = DB.news.find(x=>x['ç·¨è™Ÿ']==id);
        title = mergedData['å…¬å¸'];
        tags = `<span class="tag brk">${mergedData['åˆ¸å•†ä¾†æº']}</span>`;
    }
    else if(type === 'stocks') {
        mergedData = DB.stocks[id];
        title = `${mergedData['å…¬å¸åç¨±']} (${mergedData['ä»£è™Ÿ']})`;
        tags = `<span class="tag ind">${mergedData['ç”¢æ¥­åˆ†é¡']}</span>`;
    }
    else if(type === 'cb') {
        mergedData = DB.cb.find(x=>x['ä»£è™Ÿ']==id);
        title = `${mergedData['åç¨±']} (${mergedData['ä»£è™Ÿ']})`;
    }
    else if(type === 'reports') {
        mergedData = DB.reports.find(x=>x['å ±å‘Šç·¨è™Ÿ']==id);
        title = mergedData['å ±å‘Šæ¨™é¡Œ'];
    }
    else if(type === 'strategy') {
        mergedData = DB.strategy.find(x=>x['å ±å‘Šç·¨è™Ÿ']==id);
        title = mergedData['å ±å‘Šæ¨™é¡Œ'];
    }

    // 2. æ¸²æŸ“ Header
    $('m-header').innerHTML = `
        <div style="font-size:18px;font-weight:700;margin-bottom:5px;">${title}</div>
        <div class="card-meta">${tags}</div>
    `;

    // 3. æ™ºæ…§æ¸²æŸ“ Body (é‡é»ä¾†äº†ï¼)
    // æˆ‘å€‘ä¸å¯«æ­»æ¬„ä½ï¼Œè€Œæ˜¯æƒæ Excel æœ‰ä»€éº¼æ¬„ä½ï¼Œå°±é¡¯ç¤ºä»€éº¼
    let gridHtml = '<div class="auto-grid">';
    let blocksHtml = '';
    
    // å®šç¾©å“ªäº›æ¬„ä½é©åˆæ”¾ "å°æ ¼å­" (æ•¸å€¼ã€çŸ­å­—ä¸²)
    const shortFields = ['EPS','ç‡Ÿæ”¶YoY','æ¯›åˆ©ç‡','æŠ•è³‡è©•ç­‰','ç›®æ¨™åƒ¹','è¿½è¹¤ç‹€æ…‹','è‚¡åƒ¹','æ¼²è·Œå¹…','å¸‚å€¼(å„„)','è½‰æ›åƒ¹æ ¼(å…ƒ)','æœ€æ–°é¤˜é¡(ç™¾è¬)','åˆ°æœŸæ—¥','æ”¶ç›¤åƒ¹','æœ¬ç›Šæ¯”','æ®–åˆ©ç‡','æˆäº¤','åˆ¸å•†'];
    
    // å®šç¾©å“ªäº›æ¬„ä½é©åˆæ”¾ "å¤§å€å¡Š" (é•·æ–‡ç« )
    const longFields = ['ç‡Ÿé‹é‡é»','ç­–ç•¥æ–¹å‘','å®Œæ•´å ±å°å…§å®¹','æ¥­å‹™æ‘˜è¦','æ ¸å¿ƒé‡é»1','ç¸½ç¶“è§€é»æ‘˜è¦','ç”¢æ¥­è¶¨å‹¢','ç«¶çˆ­å„ªå‹¢','é¢¨éšªæç¤º','å¾ŒçºŒè¿½è¹¤','é‡è¦QAæ‘˜è¦'];

    // éæ­·æ‰€æœ‰æ¬„ä½
    Object.keys(mergedData).forEach(key => {
        const val = safe(mergedData[key]);
        if(!val || key === 'id' || key === 'ç·¨è™Ÿ' || key === 'å…¬å¸' || key === 'è‚¡è™Ÿ') return; // è·³éç„¡ç”¨æ¬„ä½

        // è¦å‰‡ 1: å¦‚æœæ˜¯çŸ­æ¬„ä½ -> æ”¾å…¥ 2æ¬„ Grid
        if(shortFields.includes(key) || val.length < 15) {
            let colorClass = '';
            if(val.includes('+') || key.includes('æ¼²')) colorClass = 'style="color:#e74c3c"'; // ç´…å­—
            if(val.includes('-') || key.includes('è·Œ')) colorClass = 'style="color:#27ae60"'; // ç¶ å­—
            
            gridHtml += `
                <div class="stat-box">
                    <div class="stat-label">${key}</div>
                    <div class="stat-val" ${colorClass}>${val}</div>
                </div>`;
        } 
        // è¦å‰‡ 2: å¦‚æœæ˜¯é•·æ¬„ä½ -> æ”¾å…¥å€å¡Š
        else {
            let borderClass = 'border-left:4px solid #c96442'; // é è¨­æ©˜è‰²
            if(key.includes('è²¡å‹™') || key.includes('ç‡Ÿæ”¶')) borderClass = 'border-left:4px solid #3498db'; // è—è‰²
            if(key.includes('é¢¨éšª')) borderClass = 'border-left:4px solid #95a5a6'; // ç°è‰²
            
            blocksHtml += `
                <div class="section-block" style="${borderClass}">
                    <div class="section-title">ğŸ“Œ ${key}</div>
                    <div class="content-text">${safe(val).replace(/\n/g, '<br>').replace(/â€¢/g, '<br>â€¢ ')}</div>
                </div>`;
        }
    });
    gridHtml += '</div>';

    // 4. è£œå……é—œè¯è³‡æ–™ (å€‹è‚¡ç‰¹æœ‰)
    let relatedHtml = '';
    if(type === 'stocks') {
        const code = mergedData['ä»£è™Ÿ'];
        const rev = IDX.revenue[code];
        if(rev) {
            relatedHtml += `<div class="section-block" style="border-left-color:#3498db"><div class="section-title">ğŸ’° è¿‘ä¸€å¹´ç‡Ÿæ”¶</div><div style="overflow-x:auto"><table style="width:100%;font-size:12px;border-collapse:collapse"><tr>${rev.map(r=>`<td style="padding:5px;border:1px solid #eee;text-align:center">${r.p}<br><b>${r.v}</b></td>`).join('')}</tr></table></div></div>`;
        }
        // æŠ“ Memo
        const memos = IDX.relatedMemo[code];
        if(memos) {
            relatedHtml += `<div class="section-title" style="margin-top:20px">ğŸ“‘ ç›¸é—œ Memo (${memos.length})</div>`;
            relatedHtml += memos.map(m=>`<div class="list-item" onclick="openSmartModal('memo','${m['ç·¨è™Ÿ']}')"><div class="list-main">${m['å ±å‘Šé¡å‹']}</div><div class="list-sub">${fmtDate(m['æ—¥æœŸ'])} | ${m['åˆ¸å•†']}</div></div>`).join('');
        }
    }

    // çµ„åˆå…§å®¹
    $('m-body').innerHTML = gridHtml + blocksHtml + relatedHtml;
    $('modal').classList.add('show');
}

window.closeModal = (e) => { if(!e || e.target.id==='modal') $('modal').classList.remove('show'); };
window.onload = init;
</script>
</body>
</html>
