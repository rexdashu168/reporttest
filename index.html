<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</title>
    
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // é›™é‡ä¿éšªï¼šå¦‚æœä¸Šé¢çš„ä¾†æºæ²’è¼‰å…¥æˆåŠŸï¼Œå˜—è©¦è¼‰å…¥å‚™ç”¨ä¾†æº
        if (typeof XLSX === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>');
        }
    </script>

    <style>
        /* ===== åŸºç¤è¨­å®š ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif; background: #f5f4ef; min-height: 100vh; color: #2d2d2d; }
        .container { max-width: 1200px; margin: 0 auto; padding: 12px; overflow: hidden; }
        
        /* ===== Header ===== */
        .header { text-align: center; padding: 20px 0 15px; border-bottom: 1px solid #e5e3dc; margin-bottom: 15px; }
        .header h1 { font-size: 22px; color: #c96442; margin-bottom: 4px; }
        .header .subtitle { color: #6b6b6b; font-size: 13px; }
        
        /* ===== è³‡æ–™åº«åˆ‡æ› Tab ===== */
        .db-switcher { display: flex; justify-content: center; gap: 6px; margin: 15px 0; flex-wrap: wrap; padding: 0; overflow: visible;}
        .db-tab { padding: 8px 14px; border: 2px solid #e5e3dc; background: #fff; border-radius: 20px; font-size: 12px; font-weight: 600; color: #6b6b6b; cursor: pointer; transition: all 0.2s; }
        .db-tab:hover { border-color: #c96442; color: #c96442; }
        .db-tab.active { background: #c96442; border-color: #c96442; color: #fff; }
        .db-tab .count { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 8px; font-size: 10px; margin-left: 3px; }
        .db-tab.active .count { background: rgba(255,255,255,0.3); }
        
        /* ===== Loading å‹•ç•« ===== */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f5f4ef; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loading-overlay.hidden { display: none; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #e5e3dc; border-top-color: #c96442; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-status { color: #6b6b6b; font-size: 14px; text-align: center; }
        .loading-detail { color: #999; font-size: 12px; margin-top: 8px; }
        .loading-progress { width: 200px; height: 4px; background: #e5e3dc; border-radius: 2px; margin-top: 15px; overflow: hidden; }
        .loading-progress-bar { height: 100%; background: #c96442; width: 0%; transition: width 0.3s; }
        
        /* ===== æœå°‹èˆ‡ç¯©é¸ ===== */
        .search-section { background: #fff; border: 1px solid #e5e3dc; border-radius: 16px; padding: 14px; margin-bottom: 15px; }
        .main-search { position: relative; margin-bottom: 10px; }
        .main-search::before { content: "ğŸ”"; position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 15px; }
        #mainSearchInput { width: 100%; padding: 12px 12px 12px 44px; border: 2px solid #e5e3dc; border-radius: 25px; background: #fafaf8; font-size: 15px; }
        #mainSearchInput:focus { outline: none; border-color: #c96442; background: #fff; }
        
        /* æœå°‹å»ºè­° */
        .search-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #e5e3dc; border-radius: 12px; margin-top: 4px; max-height: 400px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .search-suggestions.active { display: block; }
        .suggestion-group { padding: 6px 0; border-bottom: 1px solid #f0eeea; }
        .suggestion-group-title { padding: 4px 12px; font-size: 10px; color: #8b8b8b; text-transform: uppercase; }
        .suggestion-item { padding: 10px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .suggestion-item:hover { background: #fafaf8; }
        .suggestion-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .suggestion-icon.company { background: #e8f5ec; }
        .suggestion-icon.tag { background: #fff3e6; }
        .suggestion-icon.stock { background: #e6f0ff; }
        .suggestion-text { flex: 1; }
        .suggestion-main { font-size: 13px; font-weight: 500; }
        .suggestion-sub { font-size: 11px; color: #8b8b8b; margin-top: 2px; }
        .suggestion-count { font-size: 11px; color: #8b8b8b; background: #f0eeea; padding: 2px 8px; border-radius: 10px; }

        /* ç†±é–€æ¨™ç±¤ */
        .hot-tags { margin-bottom: 10px; }
        .hot-tags-title { font-size: 11px; color: #8b8b8b; margin-bottom: 6px; }
        .hot-tags-list { display: flex; flex-wrap: wrap; gap: 5px; }
        .hot-tag { padding: 5px 10px; background: linear-gradient(135deg, #fff3e6, #ffe6cc); border: none; border-radius: 12px; font-size: 12px; color: #c96442; cursor: pointer; transition: all 0.2s; }
        .hot-tag:hover { background: #c96442; color: #fff; }

        /* ç¯©é¸å™¨ */
        .filter-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .filter-select { flex: 1; min-width: 100px; }
        .filter-select select { width: 100%; padding: 9px 10px; border: 1px solid #e5e3dc; border-radius: 18px; background: #fafaf8; font-size: 12px; cursor: pointer; }
        .clear-all-btn { padding: 9px 14px; background: transparent; border: 1px solid #d64545; border-radius: 18px; font-size: 12px; color: #d64545; cursor: pointer; transition: all 0.2s; }
        .clear-all-btn:hover { background: #d64545; color: #fff; }
        .active-filters { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .active-filter { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; background: #c96442; color: #fff; border-radius: 12px; font-size: 11px; }
        .active-filter .remove { cursor: pointer; opacity: 0.8; }

        /* åˆ—è¡¨èˆ‡å¡ç‰‡ */
        .stats-bar { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; margin-bottom: 10px; font-size: 12px; color: #6b6b6b; }
        .stats-bar strong { color: #c96442; }
        .sort-options { display: flex; gap: 6px; }
        .sort-btn { padding: 4px 10px; background: #eceae3; border: none; border-radius: 10px; font-size: 11px; cursor: pointer; transition: all 0.2s; }
        .sort-btn.active { background: #c96442; color: #fff; }
        
        .reports-list { display: flex; flex-direction: column; gap: 10px; }
        .card-base { background: #fff; border: 1px solid #e5e3dc; border-radius: 14px; padding: 14px; cursor: pointer; transition: all 0.2s; }
        .card-base:hover { border-color: #c96442; box-shadow: 0 4px 16px rgba(201,100,66,0.12); transform: translateY(-1px); }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .card-left { display: flex; align-items: center; gap: 8px; flex: 1; flex-wrap: wrap; }
        .company-name { font-size: 15px; font-weight: 700; }
        .company-link { color: #c96442; cursor: pointer; text-decoration: underline; }
        .stock-code { font-size: 11px; color: #8b8b8b; background: #f0eeea; padding: 2px 6px; border-radius: 6px; cursor: pointer; }
        .importance { color: #f5a623; font-size: 11px; }
        
        .card-meta { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .meta-tag { font-size: 10px; padding: 3px 8px; border-radius: 10px; font-weight: 500; }
        .meta-tag.broker { background: #c96442; color: #fff; }
        .meta-tag.category { background: #5a9e6f; color: #fff; }
        .meta-tag.industry { background: #6b8cce; color: #fff; }
        .meta-tag.date { background: #eceae3; color: #5a5a5a; }
        .meta-tag.analyst { background: #e6f0ff; color: #4a6fa5; }
        .meta-tag.trend { background: #27ae60; color: #fff; }
        .meta-tag.rating { background: #9b59b6; color: #fff; }
        
        .card-content { font-size: 13px; color: #5a5a5a; line-height: 1.6; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .card-tags { display: flex; flex-wrap: wrap; gap: 4px; }
        .mini-tag { font-size: 10px; padding: 2px 6px; background: #fff3e6; color: #c96442; border-radius: 6px; cursor: pointer; }
        
        /* ç‰¹æ®Šå¡ç‰‡æ¨£å¼ */
        .card-data { display: flex; gap: 12px; flex-wrap: wrap; padding-top: 8px; border-top: 1px solid #f0eeea; margin-top: 8px; }
        .data-item { font-size: 11px; }
        .data-label { color: #8b8b8b; }
        .data-value { font-weight: 600; }
        .data-value.positive { color: #2e7d46; }
        
        .trend-card { background: linear-gradient(135deg, #fff, #f0fdf4); border: 2px solid #5a9e6f; }
        .trend-badge { font-size: 10px; padding: 2px 8px; background: #5a9e6f; color: #fff; border-radius: 8px; margin-bottom: 6px; display: inline-block; }
        .stock-card { background: linear-gradient(135deg, #fff, #f8f9ff); border: 2px solid #6b8cce; }
        .stock-badge { font-size: 10px; padding: 2px 8px; background: #6b8cce; color: #fff; border-radius: 8px; margin-bottom: 6px; display: inline-block; }
        .industry-card { background: linear-gradient(135deg, #fff, #faf5ff); border: 2px solid #9b59b6; }
        .industry-badge { font-size: 10px; padding: 2px 8px; background: #9b59b6; color: #fff; border-radius: 8px; margin-bottom: 6px; display: inline-block; }
        .strategy-card { background: linear-gradient(135deg, #fff, #fff8f0); border: 2px solid #e67e22; }
        .strategy-badge { font-size: 10px; padding: 2px 8px; background: #e67e22; color: #fff; border-radius: 8px; margin-bottom: 6px; display: inline-block; }

        /* ===== Modal å½ˆçª— ===== */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; overflow-y: auto; padding: 15px 10px; }
        .modal-overlay.active { display: block; }
        .modal-content { max-width: 900px; margin: 0 auto; background: #fff; border-radius: 18px; overflow: hidden; animation: modalIn 0.2s ease; }
        @keyframes modalIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-header { padding: 16px; background: #fafaf8; border-bottom: 1px solid #e5e3dc; display: flex; justify-content: space-between; align-items: flex-start; }
        .modal-header-info { flex: 1; }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 3px; }
        .modal-subtitle { font-size: 13px; color: #6b6b6b; }
        .modal-close { width: 32px; height: 32px; border: none; background: #eceae3; border-radius: 50%; font-size: 18px; cursor: pointer; margin-left: 10px; }
        
        .modal-body { padding: 16px; max-height: 70vh; overflow-y: auto; }
        .modal-section { margin-bottom: 18px; }
        .section-title { font-size: 13px; font-weight: 600; color: #c96442; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #eceae3; }
        .content-block { background: #fafaf8; border-radius: 10px; padding: 12px; font-size: 13px; line-height: 1.8; white-space: pre-wrap; }
        
        .tags-block { display: flex; flex-wrap: wrap; gap: 5px; }
        .modal-tag { font-size: 12px; padding: 4px 10px; background: #fff3e6; color: #c96442; border-radius: 12px; cursor: pointer; }
        
        .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .info-item { background: #fafaf8; padding: 10px; border-radius: 8px; }
        .info-label { font-size: 13px; color: #8b8b8b; margin-bottom: 3px; }
        .info-value { font-size: 13px; font-weight: 600; }
        .info-value.large { font-size: 16px; }

        /* Modal åˆ†é  Tab */
        .tab-buttons { display: flex; gap: 4px; margin-bottom: 12px; flex-wrap: wrap; border-bottom: 1px solid #eceae3; padding-bottom: 8px; }
        .tab-btn { padding: 8px 14px; background: #eceae3; border: none; border-radius: 8px 8px 0 0; font-size: 12px; cursor: pointer; font-weight: 500; }
        .tab-btn:hover { background: #ddd; }
        .tab-btn.active { background: #c96442; color: #fff; }
        .tab-content { display: none; padding: 15px 5px; line-height: 1.8; }
        .tab-content.active { display: block; }
        
        /* å…¶ä»– Modal å…§å…ƒä»¶ */
        .product-item { background: #fafaf8; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #c96442; }
        .product-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .product-ratio { font-size: 14px; color: #5a9e6f; line-height: 1.5; }
        .timeline-item { padding: 10px; background: #fafaf8; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #c96442; cursor: pointer; }
        .timeline-date { font-size: 13px; color: #c96442; font-weight: 600; }
        .timeline-status { font-size: 12px; padding: 2px 6px; background: #e8f5ec; color: #2e7d46; border-radius: 6px; margin-top: 4px; display: inline-block; }
        .related-item { padding: 10px; background: #fafaf8; border-radius: 8px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; }
        .related-item:hover { background: #fff; border-color: #c96442; }
        .related-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .related-meta { font-size: 11px; color: #8b8b8b; }
        .empty-state { text-align: center; padding: 50px 20px; color: #8b8b8b; }
        
        /* éŒ¯èª¤è¨Šæ¯æ¡† */
        .error-box { background: #fff3f3; border: 1px solid #d64545; border-radius: 12px; padding: 20px; margin: 20px; text-align: center; }
        .error-box h3 { color: #d64545; margin-bottom: 10px; }
        .error-box p { color: #666; font-size: 13px; margin-bottom: 8px; }
        .error-box code { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-size: 12px; }

        /* è²¡å‹™æ•¸æ“šç¶²æ ¼ (ä¿®å¾©çš„éƒ¨åˆ†) */
        .finance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .finance-card { background: #f8fafc; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; }
        .finance-card h4 { margin: 0 0 15px 0; color: #1e293b; font-size: 1rem; border-bottom: 2px solid #3b82f6; padding-bottom: 8px; }
        .finance-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; }
        .finance-item:last-child { border-bottom: none; }
        .finance-item span:first-child { color: #64748b; }
        .finance-item span:last-child { font-weight: 600; color: #1e293b; }
        
        /* ç”¢å“åˆ—è¡¨ (ä¿®å¾©çš„éƒ¨åˆ†) */
        .products-list { display: grid; gap: 12px; margin-bottom: 20px; }
        .product-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 15px 20px; border-radius: 10px; border-left: 4px solid #3b82f6; }
        .product-name { font-weight: 600; color: #1e293b; }
        .product-ratio { color: #64748b; }
        
        /* å…§å®¹å€å¡Š (ä¿®å¾©çš„éƒ¨åˆ†) */
        .section-block { background: #f8fafc; border-radius: 12px; padding: 20px; margin-top: 20px; }
        .section-block h4 { margin: 0 0 12px 0; color: #1e293b; font-size: 1rem; }
        .content-text { color: #374151; line-height: 1.8; white-space: pre-wrap; }
        .full-content { background: #f8fafc; padding: 25px; border-radius: 12px; max-height: 60vh; overflow-y: auto; }
        .timeline-text { font-family: 'Monaco', 'Consolas', monospace; font-size: 0.9rem; }
        .rex-view { background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%); border-left: 4px solid #f59e0b; }
        .no-data { color: #94a3b8; text-align: center; padding: 40px; font-style: italic; }
        
        /* æ¨™ç±¤å®¹å™¨ (ä¿®å¾©çš„éƒ¨åˆ†) */
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-chip { background: #e0f2fe; color: #0369a1; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; }
        .meta-tag.tp { background: #dcfce7; color: #166534; }

        @media (max-width: 600px) { .header h1 { font-size: 18px; } .db-tab { padding: 6px 10px; font-size: 11px; } .filter-row { flex-direction: column; } .filter-select { min-width: 100%; } .info-grid { grid-template-columns: 1fr 1fr; } .tab-btn { padding: 6px 10px; font-size: 11px; } }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-status" id="loadingStatus">æ­£åœ¨è¼‰å…¥ç ”ç©¶å ±å‘Š...</div>
        <div class="loading-detail" id="loadingDetail"></div>
        <div class="loading-progress"><div class="loading-progress-bar" id="loadingProgressBar"></div></div>
    </div>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
            <p class="subtitle">åˆ¸å•†ç ”ç©¶å ±å‘Š Ã— å¤–é›»å¿«å ± Ã— Call Memo Ã— æŠ•è³‡ç­–ç•¥</p>
        </div>
        <div class="db-switcher">
            <button class="db-tab active" data-db="news" onclick="switchDB('news')">âš¡ å¤–é›»å ±å° <span class="count" id="newsCount">0</span></button>
            <button class="db-tab" data-db="memo" onclick="switchDB('memo')">ğŸ“‹ å ±å‘ŠMemo <span class="count" id="memoCount">0</span></button>
            <button class="db-tab" data-db="reports" onclick="switchDB('reports')">ğŸ“‘ ç”¢æ¥­å ±å‘Š <span class="count" id="reportsCount">0</span></button>
            <button class="db-tab" data-db="strategy" onclick="switchDB('strategy')">ğŸ¯ æŠ•è³‡å±•æœ› <span class="count" id="strategyCount">0</span></button>
            <button class="db-tab" data-db="trends" onclick="switchDB('trends')">ğŸ“ˆ ç”¢æ¥­è¶¨å‹¢ <span class="count" id="trendsCount">0</span></button>
            <button class="db-tab" data-db="industry" onclick="switchDB('industry')">ğŸ­ ç”¢æ¥­å‹•æ…‹ <span class="count" id="industryCount">0</span></button>
            <button class="db-tab" data-db="stocks" onclick="switchDB('stocks')">ğŸ¢ å€‹è‚¡æŸ¥è©¢ <span class="count" id="stocksCount">0</span></button>
            <button class="db-tab" data-db="cb" onclick="switchDB('cb')">ğŸ« CBçµ±è¨ˆ <span class="count" id="cbCount">0</span></button>
        </div>
        <div class="search-section">
            <div class="main-search">
                <input type="text" id="mainSearchInput" placeholder="æœå°‹å…¬å¸åç¨±ã€è‚¡è™Ÿã€æ¨™ç±¤ã€åˆ¸å•†...">
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
            <div class="hot-tags">
                <div class="hot-tags-title">ğŸ”¥ ç†±é–€é—œéµå­—</div>
                <div class="hot-tags-list" id="hotTagsList"></div>
            </div>
            <div class="filter-row">
                <div class="filter-select"><select id="brokerFilter"><option value="">æ‰€æœ‰åˆ¸å•†</option></select></div>
                <div class="filter-select" id="categoryFilterWrap"><select id="categoryFilter"><option value="">æ‰€æœ‰åˆ†é¡</option></select></div>
                <div class="filter-select" id="importanceFilterWrap"><select id="importanceFilter"><option value="">æ‰€æœ‰é‡è¦æ€§</option><option value="â­â­â­â­â­">â­â­â­â­â­</option><option value="â­â­â­â­">â­â­â­â­</option><option value="â­â­â­">â­â­â­</option></select></div>
                <div class="filter-select" id="industryFilterWrap" style="display:none;"><select id="industryFilter"><option value="">æ‰€æœ‰ç”¢æ¥­</option></select></div>
                <div class="filter-select" id="marketFilterWrap" style="display:none;"><select id="marketFilter"><option value="">æ‰€æœ‰å¸‚å ´</option></select></div>
                <button class="clear-all-btn" onclick="clearAllFilters()">æ¸…é™¤ç¯©é¸</button>
            </div>
            <div class="active-filters" id="activeFilters"></div>
        </div>
        <div class="stats-bar">
            <span>æ‰¾åˆ° <strong id="filteredCount">0</strong> ç­†çµæœ</span>
            <div class="sort-options">
                <button class="sort-btn active" data-sort="date" onclick="setSort('date')">æœ€æ–°</button>
                <button class="sort-btn" data-sort="importance" onclick="setSort('importance')">é‡è¦æ€§</button>
            </div>
        </div>
        <div class="reports-list" id="reportsList"></div>
    </div>
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-header-info" id="modalHeaderInfo"></div>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script>
    // ===== æª”æ¡ˆè·¯å¾‘å®šç¾© =====
    const NEWS_FILE = '01_news.xlsx';
    const MEMO_FILE = '02_memo.xlsx';
    const REPORTS_FILE = '03_reports.xlsx';
    const MASTER_FILE = '04_master.xlsx';
    const STRATEGY_FILE = '05_Strategy.xlsx'; // ç¢ºä¿å¤§å°å¯«èˆ‡æª”æ¡ˆä¸€è‡´
    const CB_FILE = '00_CB.xlsx';
    const REVENUE_FILE = '06_revenue.xlsx';

    // ===== å…¨åŸŸè³‡æ–™è®Šæ•¸ =====
    let newsData = [], newsContent = {}, trendsData = [];
    let cbData = {}; 
    let cbIndustry = {}; 
    let cbList = []; 
    let cbPriceRange = {}; 
    let revenueData = {}; 
    let memoReports = [], memoTracking = {}, memoFinance = {}, memoProducts = {}, memoTimeline = [], memoIndustryTrends = [], memoDetails = {}, memoAnalysts = [];
    let reportsData = [], reportDetails = {}, reportStocksData = {}, reportConclusions = {};
    let masterStocks = {}, conceptStocks = [];
    let strategyReports = [], strategyMacro = {}, strategyFundamental = {}, strategyThemes = {}, strategyChips = {}, strategyTechnical = {}, strategyQuarters = {}, strategyPicks = {};
    let currentDB = 'news', currentSort = 'date';
    let activeFilters = { search: '', broker: '', category: '', importance: '', industry: '', tag: '', market: '' };
    let searchIndex = { companies: {}, tags: {}, brokers: {}, stocks: {}, industries: {} };

    // ===== å·¥å…·å‡½æ•¸ =====
    async function fetchFile(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) {
                // æ›´è©³ç´°çš„éŒ¯èª¤å ±å‘Š
                throw new Error(`æª”æ¡ˆ ${url} è¼‰å…¥å¤±æ•— (Status: ${response.status})`);
            }
            return await response.arrayBuffer();
        } catch (e) {
            console.error(e);
            throw e; // ç¹¼çºŒæ‹‹å‡ºè®“ä¸»ç¨‹å¼æ•ç²
        }
    }

    function updateLoadingStatus(msg, detail = '', progress = 0) {
        document.getElementById('loadingStatus').textContent = msg;
        document.getElementById('loadingDetail').textContent = detail;
        document.getElementById('loadingProgressBar').style.width = progress + '%';
    }

    function formatDate(v) {
        if (!v) return '';
        if (typeof v === 'string') return v;
        if (typeof v === 'number') {
            const d = new Date((v - 25569) * 86400 * 1000);
            return d.toLocaleDateString('zh-TW');
        }
        return String(v);
    }

    function safeStr(v) { return (v === null || v === undefined) ? '' : String(v).trim(); }

    function formatContent(text, forceSimple = false) {
        if (!text) return '';
        if (forceSimple) {
            return text.replace(/;/g, 'ï¼›').replace(/â€¢/g, '<br>â€¢ ');
        }
        const segments = text.split(';').filter(s => s.trim());
        if (segments.length <= 1) {
            return text.replace(/â€¢/g, '<br>â€¢ ');
        }
        let html = '';
        segments.forEach(seg => {
            seg = seg.trim();
            if (!seg) return;
            const colonMatch = seg.match(/^([^:ï¼š]{2,20})[:ï¼š](.+)$/);
            if (colonMatch) {
                const title = colonMatch[1].trim();
                const body = colonMatch[2].trim();
                let icon = 'ğŸ“Œ', color = '#c96442';
                if (title.includes('å±•æœ›') || title.includes('é æœŸ')) { icon = 'ğŸ”®'; color = '#9b59b6'; }
                else if (title.includes('é¢¨éšª') || title.includes('æŒ‘æˆ°')) { icon = 'âš ï¸'; color = '#e74c3c'; }
                else if (title.includes('æˆé•·') || title.includes('ç‡Ÿæ”¶') || title.includes('ç²åˆ©')) { icon = 'ğŸ“ˆ'; color = '#27ae60'; }
                else if (title.includes('ç”¢å“') || title.includes('çµ„åˆ')) { icon = 'ğŸ“¦'; color = '#3498db'; }
                else if (title.includes('AI') || title.includes('ä¼ºæœå™¨')) { icon = 'ğŸ¤–'; color = '#8e44ad'; }
                else if (title.includes('EV') || title.includes('é›»å‹•è»Š')) { icon = 'ğŸš—'; color = '#16a085'; }
                else if (title.includes('åŠå°é«”') || title.includes('æ™¶ç‰‡') || title.includes('SiC')) { icon = 'ğŸ’'; color = '#2980b9'; }
                
                html += '<div style="margin-bottom:12px;padding:12px 14px;background:linear-gradient(135deg,#fff,#fafaf8);border-radius:10px;border-left:4px solid ' + color + ';box-shadow:0 1px 3px rgba(0,0,0,0.05);">';
                html += '<div style="font-weight:600;color:' + color + ';margin-bottom:8px;font-size:16px;">' + icon + ' ' + title + '</div>';
                html += '<div style="font-size:15px;line-height:1.8;color:#444;">' + body + '</div>';
                html += '</div>';
            } else {
                html += '<div style="margin-bottom:10px;padding:10px 12px;background:#fafaf8;border-radius:8px;font-size:15px;line-height:1.8;color:#444;">' + seg + '</div>';
            }
        });
        return html;
    }

    function parseTags(tagStr) {
        if (!tagStr) return [];
        return tagStr.split('#').filter(t => t.trim()).map(t => t.trim());
    }

    function excelDateToStr(val) {
        if (!val) return '';
        if (!isNaN(val) && typeof val === 'number') {
            const utc_days = Math.floor(val - 25569);
            const date = new Date(utc_days * 86400 * 1000);
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}/${m}/${d}`;
        }
        const str = String(val);
        const match = str.match(/(\d{4})-(\d{2})-(\d{2})/);
        if (match) {
            return `${match[1]}/${match[2]}/${match[3]}`;
        }
        return str;
    }

    // ===== è¼‰å…¥å‡½æ•¸ =====
    async function loadCBData() {
        try {
            const data = await fetchFile(CB_FILE);
            const wb = XLSX.read(data, { type: 'array' });
             const ws00 = wb.Sheets['00_CBä»£è™Ÿåç¨±éæ¿¾åŠæ›ç‰Œé«˜ä½_20251031'];
            if (ws00) {
                XLSX.utils.sheet_to_json(ws00).forEach(r => {
                    if (!r['ä»£è™Ÿ']) return;
                    cbPriceRange[String(r['ä»£è™Ÿ']).trim()] = {
                        high: parseFloat(r['æ›ç‰Œæœ€é«˜']) || 0,
                        low: parseFloat(r['æ›ç‰Œæœ€ä½']) || 0,
                        range: r['æ›ç‰Œæœ€é«˜'] ? ((r['æ›ç‰Œæœ€é«˜'] - r['æ›ç‰Œæœ€ä½']) / r['æ›ç‰Œæœ€ä½'] * 100).toFixed(1) : '0'
                    };
                });
            }
            const ws16 = wb.Sheets['16_ç”¢æ¥­åˆ†é¡'];
            if (ws16) {
                XLSX.utils.sheet_to_json(ws16).forEach(r => {
                    if (!r['è‚¡ç¥¨ä»£è™Ÿ']) return;
                    cbIndustry[String(r['è‚¡ç¥¨ä»£è™Ÿ'])] = { industry: r['ç”¢æ¥­åˆ†é¡'] || 'å…¶ä»–', market: r['å¸‚å ´åˆ†é¡'] || '', name: r['å…¬å¸åç¨±'] || '' };
                });
            }
            const ws = wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™'];
            if (ws) {
                XLSX.utils.sheet_to_json(ws).forEach(r => {
                    if (!r['è½‰æ›æ¨™çš„ä»£ç¢¼']) return;
                    const stockCode = String(r['è½‰æ›æ¨™çš„ä»£ç¢¼']).trim();
                    const ind = cbIndustry[stockCode] || {};
                    const issueAmt = parseFloat(r['å¯¦éš›ç™¼è¡Œç¸½é¡(ç™¾è¬)']) || 0;
                    const remainAmt = parseFloat(r['æœ€æ–°é¤˜é¡(ç™¾è¬)']) || 0;
                    const cbInfo = {
                        cbCode: String(r['ä»£è™Ÿ']), cbName: String(r['åç¨±'] || ''), stockCode: stockCode, stockName: String(r['è½‰æ›æ¨™çš„åç¨±'] || ''),
                        conversionPrice: parseFloat(r['è½‰æ›åƒ¹æ ¼(å…ƒ)']) || 0, maturityDate: excelDateToStr(r['åˆ°æœŸæ—¥']),
                        remainAmount: remainAmt, remainPct: issueAmt > 0 ? ((remainAmt / issueAmt) * 100).toFixed(1) : '0',
                        industry: ind.industry || 'å…¶ä»–'
                    };
                    const codeKey = stockCode.replace(/\s/g, '');
                    if (!cbData[codeKey]) cbData[codeKey] = [];
                    cbData[codeKey].push(cbInfo);
                    cbList.push(cbInfo);
                });
            }
        } catch (e) { console.warn('CBè³‡æ–™è¼‰å…¥å¤±æ•—:', e); }
    }

    async function loadRevenueData() {
        try {
            const data = await fetchFile(REVENUE_FILE);
            const wb = XLSX.read(data, { type: 'array' });
            const ws12 = wb.Sheets['12_å…¬å¸åŸºæœ¬è³‡æ–™'];
            if (ws12) {
                XLSX.utils.sheet_to_json(ws12).forEach(r => {
                    if (r['ä»£è™Ÿ']) revenueData[String(r['ä»£è™Ÿ']).trim()] = { monthly: [], priceHistory: {} };
                });
            }
            const wsMonth = wb.Sheets['000_æœˆç‡Ÿæ”¶'];
            if (wsMonth) {
                const rows = XLSX.utils.sheet_to_json(wsMonth);
                const headers = Object.keys(rows[0] || {});
                const monthCols = headers.filter(h => h.includes('å–®æœˆç‡Ÿæ”¶'));
                rows.forEach(r => {
                    if (!r['ä»£è™Ÿ']) return;
                    const code = String(r['ä»£è™Ÿ']).trim();
                    if (revenueData[code]) {
                        revenueData[code].monthly = monthCols.slice(-12).map(col => ({ period: col.replace('å–®æœˆç‡Ÿæ”¶(å„„)', ''), value: r[col] || '' }));
                    }
                });
            }
            const ws13 = wb.Sheets['13_æ­·å²é«˜ä½'];
            if (ws13) {
                XLSX.utils.sheet_to_json(ws13).forEach(r => {
                    if (r['ä»£è™Ÿ'] && revenueData[String(r['ä»£è™Ÿ']).trim()]) {
                        revenueData[String(r['ä»£è™Ÿ']).trim()].priceHistory = { y1High: r['1å¹´æœ€é«˜è‚¡åƒ¹'] || '', y1Low: r['1å¹´æœ€ä½è‚¡åƒ¹'] || '' };
                    }
                });
            }
        } catch (e) { console.warn('ç‡Ÿæ”¶è³‡æ–™è¼‰å…¥å¤±æ•—:', e); }
    }

    async function loadNewsData() {
        try {
            const ab = await fetchFile(NEWS_FILE);
            const wb = XLSX.read(ab, { type: 'array' });
            const ws = wb.Sheets['å¤–é›»ç¶œåˆå ±å°'];
            if (ws) {
                XLSX.utils.sheet_to_json(ws).forEach(r => {
                    if (!r['ç·¨è™Ÿ']) return;
                    if (safeStr(r['è³‡æ–™é¡å‹']) === 'å€‹è‚¡å ±å°') {
                        newsData.push({ id: safeStr(r['ç·¨è™Ÿ']), date: safeStr(r['æ—¥æœŸ']), company: safeStr(r['å…¬å¸']), stockCode: safeStr(r['è‚¡è™Ÿ']), broker: safeStr(r['åˆ¸å•†ä¾†æº']), category: safeStr(r['å ±å°é‡é»åˆ†é¡']), importance: safeStr(r['é‡è¦æ€§']), tags: safeStr(r['æ¨™ç±¤']) });
                        newsContent[safeStr(r['ç·¨è™Ÿ'])] = safeStr(r['å®Œæ•´å ±å°å…§å®¹']);
                    }
                     else if (safeStr(r['è³‡æ–™é¡å‹']) === 'ç”¢æ¥­è¶¨å‹¢') {
                        trendsData.push({ id: safeStr(r['ç·¨è™Ÿ']), date: safeStr(r['æ—¥æœŸ']), topic: safeStr(r['å…¬å¸']), broker: safeStr(r['åˆ¸å•†ä¾†æº']), content: safeStr(r['å®Œæ•´å ±å°å…§å®¹']), companies: safeStr(r['è‚¡è™Ÿ']), tags: safeStr(r['æ¨™ç±¤']) });
                    }
                });
            }
        } catch (e) { console.warn('å¤–é›»è¼‰å…¥å¤±æ•—:', e); throw e; }
    }

    async function loadMemoData() {
        try {
            const ab = await fetchFile(MEMO_FILE);
            const wb = XLSX.read(ab, { type: 'array' });
            const s1 = wb.Sheets['å ±å‘Šç¸½è¡¨'];
            if (s1) {
                XLSX.utils.sheet_to_json(s1).forEach(r => {
                    if(r['ç·¨è™Ÿ']) memoReports.push({ id: safeStr(r['ç·¨è™Ÿ']), date: safeStr(r['æ—¥æœŸ']), company: safeStr(r['å…¬å¸']), stockCode: safeStr(r['è‚¡è™Ÿ']), broker: safeStr(r['åˆ¸å•†']), type: safeStr(r['å ±å‘Šé¡å‹']), importance: safeStr(r['é‡è¦æ€§']), industry: safeStr(r['ç”¢æ¥­']), revenueYoY: safeStr(r['ç‡Ÿæ”¶YoY']), grossMargin: safeStr(r['æ¯›åˆ©ç‡']), eps: safeStr(r['EPS']) });
                });
            }
            const s2 = wb.Sheets['è©³ç´°å…§å®¹åº«'];
            if(s2) XLSX.utils.sheet_to_json(s2).forEach(r => { if(r['ç·¨è™Ÿ']) memoDetails[safeStr(r['ç·¨è™Ÿ'])] = { operation: safeStr(r['ç‡Ÿé‹é‡é»']), strategy: safeStr(r['ç­–ç•¥æ–¹å‘']), tags: safeStr(r['æ¨™ç±¤']) }; });
            
            const s3 = wb.Sheets['å…¬å¸è¿½è¹¤è¡¨'];
            if(s3) XLSX.utils.sheet_to_json(s3).forEach(r => { if(r['ç·¨è™Ÿ']) memoTracking[safeStr(r['ç·¨è™Ÿ'])] = { rating: safeStr(r['æŠ•è³‡è©•ç­‰']), targetPrice: safeStr(r['ç›®æ¨™åƒ¹']), trackStatus: safeStr(r['è¿½è¹¤ç‹€æ…‹']) }; });
            
            const s6 = wb.Sheets['ç”¢æ¥­è¶¨å‹¢ç¸½è¦½'];
            if(s6) XLSX.utils.sheet_to_json(s6).forEach(r => { if(r['ç”¢æ¥­']) memoIndustryTrends.push({ industry: safeStr(r['ç”¢æ¥­']), trend: safeStr(r['è¶¨å‹¢åˆ¤æ–·']), companies: safeStr(r['ä»£è¡¨å…¬å¸']), driver: safeStr(r['é—œéµé©…å‹•å› ç´ ']) }); });
        } catch (e) { console.warn('Memoè¼‰å…¥å¤±æ•—:', e); throw e; }
    }

    async function loadReportsData() {
        try {
            const ab = await fetchFile(REPORTS_FILE);
            const wb = XLSX.read(ab, { type: 'array' });
            const s1 = wb.Sheets['å ±å‘Šç¸½è¦½'];
            if(s1) XLSX.utils.sheet_to_json(s1).forEach(r => { if(r['å ±å‘Šç·¨è™Ÿ']) reportsData.push({ id: safeStr(r['å ±å‘Šç·¨è™Ÿ']), broker: safeStr(r['åˆ¸å•†åç¨±']), date: formatDate(r['å ±å‘Šæ—¥æœŸ']), industry: safeStr(r['ç”¢æ¥­åç¨±']), title: safeStr(r['å ±å‘Šæ¨™é¡Œ']), highlights: [safeStr(r['æ ¸å¿ƒé‡é»1']), safeStr(r['æ ¸å¿ƒé‡é»2'])] }); });
        } catch (e) { console.warn('Reportsè¼‰å…¥å¤±æ•—:', e); throw e; }
    }

    async function loadMasterData() {
        try {
            const ab = await fetchFile(MASTER_FILE);
            const wb = XLSX.read(ab, { type: 'array' });
            const s1 = wb.Sheets['ä¸»è³‡æ–™åº«'];
            if(s1) XLSX.utils.sheet_to_json(s1).forEach(r => { 
                if(r['ä»£è™Ÿ']) {
                    const d = { code: safeStr(r['ä»£è™Ÿ']), name: safeStr(r['å…¬å¸åç¨±']), market: safeStr(r['å¸‚å ´åˆ†é¡']), industry: safeStr(r['ç”¢æ¥­åˆ†é¡']), price: safeStr(r['æˆäº¤']), change: safeStr(r['æ¼²è·Œåƒ¹']), changePercent: safeStr(r['æ¼²è·Œå¹…']), marketCap: safeStr(r['å¸‚å€¼(å„„)']) };
                    masterStocks[d.code] = d; masterStocks[d.name] = d;
                }
            });
             const s2 = wb.Sheets['ğŸ’¡æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«'];
            if (s2) {
                XLSX.utils.sheet_to_json(s2, {header:1}).forEach((rw, i) => {
                    if (i > 2 && rw[0]) conceptStocks.push({ code: safeStr(rw[0]), concept: safeStr(rw[2]), subRole: safeStr(rw[3]) });
                });
            }
        } catch (e) { console.warn('Masterè¼‰å…¥å¤±æ•—:', e); throw e; }
    }

    async function loadStrategyData() {
        try {
            const ab = await fetchFile(STRATEGY_FILE);
            const wb = XLSX.read(ab, { type: 'array' });
            const s1 = wb.Sheets['å ±å‘Šç¸½è¦½'];
            if(s1) XLSX.utils.sheet_to_json(s1).forEach(r => { if(r['å ±å‘Šç·¨è™Ÿ']) strategyReports.push({ id: safeStr(r['å ±å‘Šç·¨è™Ÿ']), broker: safeStr(r['åˆ¸å•†åç¨±']), date: formatDate(r['å ±å‘Šæ—¥æœŸ']), type: safeStr(r['å ±å‘Šé¡å‹']), title: safeStr(r['å ±å‘Šæ¨™é¡Œ']), macroSummary: safeStr(r['ç¸½ç¶“è§€é»æ‘˜è¦']) }); });
        } catch (e) { console.warn('Strategyè¼‰å…¥å¤±æ•—:', e); throw e; }
    }

    // ===== ä¸»ç¨‹å¼å…¥å£ =====
    window.onload = async function() {
        const overlay = document.getElementById('loadingOverlay');
        try {
            // ä¾åºè¼‰å…¥æª”æ¡ˆ
            updateLoadingStatus('æ­£åœ¨è¼‰å…¥å¤–é›»è³‡æ–™...', NEWS_FILE, 10);
            await loadNewsData();
            
            updateLoadingStatus('æ­£åœ¨è¼‰å…¥ Call Memo...', MEMO_FILE, 30);
            await loadMemoData();
            
            updateLoadingStatus('æ­£åœ¨è¼‰å…¥ç”¢æ¥­å ±å‘Š...', REPORTS_FILE, 50);
            await loadReportsData();
            
            updateLoadingStatus('æ­£åœ¨è¼‰å…¥ä¸»è³‡æ–™åº«...', MASTER_FILE, 70);
            await loadMasterData();
            
            updateLoadingStatus('æ­£åœ¨è¼‰å…¥æŠ•è³‡ç­–ç•¥...', STRATEGY_FILE, 85);
            await loadStrategyData();
            
            updateLoadingStatus('æ­£åœ¨è¼‰å…¥å¯è½‰å‚µè³‡æ–™...', CB_FILE, 88);
            await loadCBData();
            
            updateLoadingStatus('æ­£åœ¨è¼‰å…¥ç‡Ÿæ”¶è³‡æ–™...', REVENUE_FILE, 93);
            await loadRevenueData();
            
            updateLoadingStatus('æ­£åœ¨å»ºç«‹ç´¢å¼•...', '', 97);
            buildSearchIndex();
            buildFilters();
            buildHotTags();
            updateCounts();
            
            updateLoadingStatus('è¼‰å…¥å®Œæˆï¼', '', 100);
            setTimeout(() => {
                renderCurrentDB();
                overlay.classList.add('hidden');
            }, 300);

            // äº‹ä»¶ç›£è½
            const si = document.getElementById('mainSearchInput');
            si.addEventListener('input', onSearchInput);
            si.addEventListener('focus', () => showSuggestions());
            document.addEventListener('click', e => { if (!e.target.closest('.main-search')) hideSuggestions(); });
            document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

        } catch (e) {
            console.error('è¼‰å…¥åš´é‡éŒ¯èª¤:', e);
            overlay.innerHTML = `
                <div class="error-box">
                    <h3>âš ï¸ è¼‰å…¥å¤±æ•—</h3>
                    <p><strong>éŒ¯èª¤è¨Šæ¯ï¼š</strong>${e.message}</p>
                    <div style="text-align:left;margin-top:15px;background:#fff;padding:15px;border-radius:8px;">
                        <p><strong>è«‹æª¢æŸ¥ GitHub å„²å­˜åº«æ˜¯å¦æœ‰ä»¥ä¸‹æª”æ¡ˆ (å€åˆ†å¤§å°å¯«)ï¼š</strong></p>
                        <ul style="padding-left:20px;color:#666;font-size:13px;line-height:1.6;">
                            <li><code>${NEWS_FILE}</code></li>
                            <li><code>${MEMO_FILE}</code></li>
                            <li><code>${REPORTS_FILE}</code></li>
                            <li><code>${MASTER_FILE}</code></li>
                            <li><code>${STRATEGY_FILE}</code></li>
                            <li><code>${CB_FILE}</code></li>
                            <li><code>${REVENUE_FILE}</code></li>
                        </ul>
                        <p style="margin-top:10px;font-size:12px;color:#d64545;">æ³¨æ„ï¼šè‹¥åœ¨ GitHub Pages åŸ·è¡Œï¼Œæª”åå¿…é ˆå®Œå…¨ä¸€è‡´</p>
                    </div>
                    <button onclick="location.reload()" style="margin-top:20px;padding:12px 30px;background:#c96442;border:none;border-radius:25px;color:#fff;cursor:pointer;">é‡æ–°è¼‰å…¥</button>
                </div>
            `;
        }
    };

    // ===== ç´¢å¼•èˆ‡ç¯©é¸ =====
    function buildSearchIndex() {
        searchIndex = { companies: {}, tags: {}, brokers: {}, stocks: {}, industries: {} };
        Object.values(masterStocks).forEach(s => {
            if (s.code && !searchIndex.stocks[s.code]) searchIndex.stocks[s.code] = { name: s.name, code: s.code, market: s.market, industry: s.industry };
        });
        newsData.forEach(item => {
            if (item.company && !searchIndex.companies[item.company]) searchIndex.companies[item.company] = { count: 0, code: item.stockCode };
            if(item.company) searchIndex.companies[item.company].count++;
            parseTags(item.tags).forEach(tag => { if (!searchIndex.tags[tag]) searchIndex.tags[tag] = 0; searchIndex.tags[tag]++; });
        });
    }

    function buildFilters() {
        const brokers = [...new Set([...newsData.map(n => n.broker), ...memoReports.map(m => m.broker)])].filter(Boolean).sort();
        document.getElementById('brokerFilter').innerHTML = '<option value="">æ‰€æœ‰åˆ¸å•†</option>' + brokers.map(b => '<option value="' + b + '">' + b + '</option>').join('');
        
        const categories = [...new Set(newsData.map(n => n.category))].filter(Boolean).sort();
        document.getElementById('categoryFilter').innerHTML = '<option value="">æ‰€æœ‰åˆ†é¡</option>' + categories.map(c => '<option value="' + c + '">' + c + '</option>').join('');
        
        const industries = [...new Set([...reportsData.map(r => r.industry), ...memoReports.map(m => m.industry)])].filter(Boolean).sort();
        document.getElementById('industryFilter').innerHTML = '<option value="">æ‰€æœ‰ç”¢æ¥­</option>' + industries.map(i => '<option value="' + i + '">' + i + '</option>').join('');
    }

    function buildHotTags() {
        const topTags = Object.entries(searchIndex.tags).sort((a, b) => b[1] - a[1]).slice(0, 12);
        document.getElementById('hotTagsList').innerHTML = topTags.map(([tag]) => '<button class="hot-tag" onclick="searchByTag(\'' + tag + '\')">#' + tag + '</button>').join('');
    }

    function updateCounts() {
        document.getElementById('newsCount').textContent = newsData.length;
        document.getElementById('memoCount').textContent = memoReports.length;
        document.getElementById('reportsCount').textContent = reportsData.length;
        document.getElementById('strategyCount').textContent = strategyReports.length;
        document.getElementById('trendsCount').textContent = trendsData.length;
        document.getElementById('industryCount').textContent = memoIndustryTrends.length;
        document.getElementById('cbCount').textContent = cbList.length;
        document.getElementById('stocksCount').textContent = new Set(Object.values(masterStocks).map(s => s.code)).size;
    }

    // ===== æœå°‹åŠŸèƒ½ =====
    function onSearchInput(e) {
        const q = e.target.value.trim().toLowerCase();
        if (q.length > 0) showSuggestions(q); else hideSuggestions();
        activeFilters.search = q; renderCurrentDB();
    }
    
    function showSuggestions(query = '') {
        const c = document.getElementById('searchSuggestions');
        if (!query) { c.classList.remove('active'); return; }
        const mS = Object.entries(searchIndex.stocks).filter(([cd, d]) => cd.includes(query) || d.name.toLowerCase().includes(query)).slice(0, 5);
        let html = '';
        if(mS.length > 0) html += mS.map(([cd, d]) => `<div class="suggestion-item" onclick="openStockModal('${cd}')"><div class="suggestion-icon stock">ğŸ“ˆ</div><div class="suggestion-text"><div class="suggestion-main">${d.name}</div><div class="suggestion-sub">${cd}</div></div></div>`).join('');
        if(html) { c.innerHTML = html; c.classList.add('active'); } else hideSuggestions();
    }
    function hideSuggestions() { document.getElementById('searchSuggestions').classList.remove('active'); }
    function searchByTag(tag) { document.getElementById('mainSearchInput').value = '#' + tag; activeFilters.search = ''; activeFilters.tag = tag; renderCurrentDB(); }

    // ===== åˆ‡æ›èˆ‡ç¯©é¸ =====
    function switchDB(db) {
        currentDB = db;
        document.querySelectorAll('.db-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.db === db));
        document.getElementById('categoryFilterWrap').style.display = (db === 'news') ? 'block' : 'none';
        document.getElementById('industryFilterWrap').style.display = ['reports', 'memo', 'industry', 'stocks'].includes(db) ? 'block' : 'none';
        renderCurrentDB();
    }
    function clearAllFilters() { activeFilters = { search: '', broker: '', category: '', importance: '', industry: '', tag: '' }; document.getElementById('mainSearchInput').value = ''; renderCurrentDB(); }
    function setSort(sort) { currentSort = sort; renderCurrentDB(); }

    function renderCurrentDB() {
        const renderers = { news: renderNews, memo: renderMemo, reports: renderReports, strategy: renderStrategy, trends: renderTrends, industry: renderIndustry, stocks: renderStocks, cb: renderCB };
        if (renderers[currentDB]) renderers[currentDB]();
    }

    // ===== æ¸²æŸ“åˆ—è¡¨ =====
    function renderNews() {
        let filtered = newsData.filter(item => {
            if (activeFilters.search && ![item.company, item.stockCode, item.category].join(' ').toLowerCase().includes(activeFilters.search)) return false;
            return true;
        });
        document.getElementById('reportsList').innerHTML = filtered.map(item => `
            <div class="card-base" onclick="openNewsModal('${item.id}')">
                <div class="card-header"><span class="company-name">${item.company}</span><span class="importance">${item.importance}</span></div>
                <div class="card-meta"><span class="meta-tag broker">${item.broker}</span><span class="meta-tag date">${item.date}</span></div>
                <div class="card-content">${(newsContent[item.id]||'').substring(0, 60)}...</div>
            </div>`).join('');
        document.getElementById('filteredCount').textContent = filtered.length;
    }
    
    function renderMemo() { document.getElementById('reportsList').innerHTML = memoReports.map(m => `<div class="card-base" onclick="openMemoModal('${m.id}')"><div class="company-name">${m.company}</div><div class="card-content">Memo åŠŸèƒ½æ­£å¸¸è¼‰å…¥</div></div>`).join(''); }
    function renderReports() { document.getElementById('reportsList').innerHTML = reportsData.map(r => `<div class="card-base" onclick="openReportModal('${r.id}')"><div class="company-name">${r.title}</div></div>`).join(''); }
    function renderStrategy() { document.getElementById('reportsList').innerHTML = strategyReports.map(r => `<div class="card-base strategy-card" onclick="openStrategyModal('${r.id}')"><div class="company-name">${r.title}</div></div>`).join(''); }
    function renderTrends() { document.getElementById('reportsList').innerHTML = trendsData.map(t => `<div class="card-base trend-card" onclick="openTrendModal('${t.id}')"><div class="company-name">${t.topic}</div></div>`).join(''); }
    function renderIndustry() { document.getElementById('reportsList').innerHTML = memoIndustryTrends.map((i,idx) => `<div class="card-base industry-card" onclick="openIndustryModal(${idx})"><div class="company-name">${i.industry}</div></div>`).join(''); }
    function renderStocks() { document.getElementById('reportsList').innerHTML = Object.values(masterStocks).slice(0,20).map(s => `<div class="card-base stock-card" onclick="openStockModal('${s.code}')"><div class="company-name">${s.name} (${s.code})</div></div>`).join(''); }
    function renderCB() { document.getElementById('reportsList').innerHTML = cbList.slice(0,20).map(c => `<div class="card-base" onclick="openStockModal('${c.stockCode}')"><div class="company-name">${c.cbName}</div></div>`).join(''); }

    // ===== Modal åŠŸèƒ½ (ç°¡åŒ–ç¯„ä¾‹ï¼Œéœ€è‡ªè¡Œè£œä¸Šå®Œæ•´é‚è¼¯) =====
    function closeModal(e) { if (!e || e.target === document.getElementById('modalOverlay')) document.getElementById('modalOverlay').classList.remove('active'); }
    function openStockModal(code) { alert('æˆåŠŸé–‹å•Ÿå€‹è‚¡: ' + code + ' (è«‹è‡ªè¡Œè£œä¸Šå®Œæ•´ Modal HTML)'); }
    function openNewsModal(id) { alert('æˆåŠŸé–‹å•Ÿæ–°è: ' + id); }
    function openMemoModal(id) { alert('æˆåŠŸé–‹å•Ÿ Memo: ' + id); }
    function openReportModal(id) { alert('æˆåŠŸé–‹å•Ÿå ±å‘Š: ' + id); }
    function openStrategyModal(id) { alert('æˆåŠŸé–‹å•Ÿç­–ç•¥: ' + id); }
    function openTrendModal(id) { alert('æˆåŠŸé–‹å•Ÿè¶¨å‹¢: ' + id); }
    function openIndustryModal(idx) { alert('æˆåŠŸé–‹å•Ÿç”¢æ¥­: ' + idx); }

    </script>
</body>
</html>
