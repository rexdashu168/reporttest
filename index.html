<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤ v11.7</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #c96442; --bg: #f5f4ef; --text: #333; --gray: #666; --border: #e0e0e0; --link: #2980b9; --up: #e74c3c; --down: #27ae60; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; }
        .container { max-width: 800px; margin: 0 auto; padding: 12px; }
        @media(min-width: 1024px) { .container { max-width: 1400px; padding: 20px; } }
        @media(min-width: 1600px) { .container { max-width: 1600px; } }

        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #e0e0e0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .header { text-align: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .header h1 { color: var(--primary); font-size: 22px; margin-bottom: 5px; font-weight: 800; }
        .db-switcher { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin: 15px 0; }
        .db-tab { padding: 6px 14px; background: #fff; border: 1px solid var(--border); border-radius: 20px; font-size: 13px; color: var(--gray); cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
        .db-tab:hover { border-color: var(--primary); }
        .db-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .count { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 10px; font-size: 10px; }

        /* CB å››åˆ—æ¨™ç±¤å€ */
        #cbTabsArea { margin: 15px 0; }
        .cb-main-title { text-align: center; font-size: 18px; font-weight: 700; color: var(--primary); padding: 12px; background: linear-gradient(135deg, #fff5f0 0%, #fff 100%); border-radius: 12px; margin-bottom: 12px; border: 2px solid #ffe0d5; }
        .cb-tabs-container { display: flex; flex-direction: column; gap: 8px; }
        .cb-tabs-row { display: flex; justify-content: center; gap: 6px; flex-wrap: wrap; }
        .cb-main-tab { padding: 8px 16px; background: #fff; border: 1px solid var(--border); border-radius: 20px; font-size: 13px; color: var(--gray); cursor: pointer; transition: all 0.2s; font-weight: 600; }
        .cb-main-tab:hover { border-color: var(--primary); transform: translateY(-1px); box-shadow: 0 2px 8px rgba(201,100,66,0.2); }
        .cb-main-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }

        .search-box { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 35px 12px 40px; border-radius: 25px; border: 2px solid var(--border); background: #fff; font-size: 15px; outline: none; transition: border-color 0.2s; }
        .search-input:focus { border-color: var(--primary); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #999; }
        .clear-btn { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; background: #ccc; color: #fff; border-radius: 50%; font-size: 12px; line-height: 20px; text-align: center; cursor: pointer; display: none; }

        /* CB çµ±è¨ˆå€å¡Š */
        .cb-stats { background: #fff5f5; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #ffe0e0; }
        .cb-mode-switcher { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .cb-mode-tab { padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid #ddd; background: #fff; color: #666; transition: all 0.2s; }
        .cb-mode-tab:hover { border-color: var(--primary); }
        .cb-mode-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .cb-sub-switcher { display: flex; gap: 6px; margin-bottom: 12px; padding-left: 10px; }
        .cb-sub-tab { padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer; border: 1px solid #ccc; background: #f9f9f9; color: #666; transition: all 0.2s; }
        .cb-sub-tab:hover { border-color: #e67e22; }
        .cb-sub-tab.active { background: #e67e22; color: #fff; border-color: #e67e22; }
        .cb-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .cb-stat-item { background: #fff; padding: 12px 8px; border-radius: 8px; text-align: center; }
        .cb-stat-item.clickable { cursor: pointer; transition: all 0.2s; }
        .cb-stat-item.clickable:hover { background: #fff8f0; border: 1px solid var(--primary); }
        .cb-stat-num { font-size: 22px; font-weight: 800; color: var(--primary); }
        .cb-stat-label { font-size: 11px; color: #888; margin-top: 2px; }
        .cb-ind-title { font-size: 13px; font-weight: 600; color: #666; margin-bottom: 10px; }
        .cb-ind-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .cb-ind-tag { padding: 6px 12px; background: #fff; border-radius: 20px; font-size: 12px; color: #666; cursor: pointer; transition: all 0.2s; border: 1px solid #eee; }
        .cb-ind-tag:hover { border-color: var(--primary); color: var(--primary); }
        .cb-ind-tag .num { background: var(--primary); color: #fff; padding: 1px 6px; border-radius: 10px; font-size: 10px; margin-left: 4px; }
        
        /* ç«¶æ‹å‰ååè¡¨æ ¼ */
        .auction-top10-table { overflow-x: auto; margin-bottom: 10px; }
        .auction-top10-table table { width: 100%; border-collapse: collapse; font-size: 12px; background: #fff; border-radius: 8px; overflow: hidden; }
        .auction-top10-table th { background: #f8f8f8; padding: 8px 6px; text-align: center; font-weight: 600; color: #555; border-bottom: 1px solid #eee; white-space: nowrap; }
        .auction-top10-table td { padding: 8px 6px; text-align: center; border-bottom: 1px solid #f5f5f5; }
        .auction-top10-table tr:hover { background: #fff8f0; }
        .auction-top10-table .code { color: var(--primary); font-weight: 600; }
        .auction-top10-table .highlight { color: var(--primary); font-weight: 700; }
        .auction-top10-table .highlight-red { color: #e74c3c; font-weight: 700; }
        
        /* æµé€šé¤˜é¡å‰ååè¡¨æ ¼ */
        .balance-top10-table { overflow-x: auto; margin-bottom: 10px; }
        .balance-top10-table table { width: 100%; border-collapse: collapse; font-size: 12px; background: #fff; border-radius: 8px; overflow: hidden; }
        .balance-top10-table th { background: #f8f8f8; padding: 8px 4px; text-align: center; font-weight: 600; color: #555; border-bottom: 1px solid #eee; white-space: nowrap; font-size: 11px; }
        .balance-top10-table td { padding: 6px 4px; text-align: center; border-bottom: 1px solid #f5f5f5; font-size: 11px; }
        .balance-top10-table tr:hover { background: #fff8f0; }
        .balance-top10-table .code { color: var(--primary); font-weight: 600; }
        .balance-top10-table .name-cell { text-align: left; min-width: 80px; max-width: 120px; white-space: normal; line-height: 1.3; }
        .balance-top10-table .highlight-red { color: #e74c3c; font-weight: 700; }
        
        /* æµé€šé¤˜é¡ä¸»è¡¨æ ¼æ¬„å¯¬ç¸®æ¸› */
        .cb-table.balance-table { font-size: 11px; }
        .cb-table.balance-table th, .cb-table.balance-table td { padding: 6px 4px; }
        .cb-table.balance-table .name-col { max-width: 90px; white-space: normal; line-height: 1.3; text-align: left; }
        
        /* ä¸»æ—¨æ¬„ä½ */
        .cb-table .subject-col { text-align: left; font-size: 11px; line-height: 1.4; max-width: 300px; white-space: normal; }
        .cb-table .name-col { max-width: 100px; white-space: normal; line-height: 1.3; text-align: left; }

        .card-list { display: flex; flex-direction: column; gap: 12px; }
        @media(min-width: 1024px) { .card-list:not(.cb-mode) { display: grid; grid-template-columns: repeat(2, 1fr); } }
        @media(min-width: 1400px) { .card-list:not(.cb-mode) { grid-template-columns: repeat(3, 1fr); } }
        .card-list.cb-mode { display: block; }
        .card { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; transition: all 0.2s; }
        .card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .card.industry-card { border-left: 4px solid #9b59b6; background: linear-gradient(135deg, #faf8fc 0%, #fff 100%); }
        .card-head { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .card-title { font-weight: 700; font-size: 16px; color: #2c3e50; }
        .card-meta { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .tag { font-size: 11px; padding: 2px 8px; border-radius: 6px; color: #fff; font-weight: 500; }
        .tag.brk { background: var(--primary); }
        .tag.ind { background: #2980b9; }
        .tag.trend-ind { background: #8e44ad; }
        .tag.dt { background: #e0e0e0; color: #666; }
        .tag.concept { background: #8e44ad; }
        .tag.trend-up { background: #27ae60; }
        .tag.trend-down { background: #e74c3c; }
        .tag.cb-tag { background: #e74c3c; font-size: 10px; padding: 1px 6px; }
        .cb-tags { display: flex; gap: 3px; flex-wrap: wrap; margin-left: auto; }
        .card-head { display: flex; align-items: center; gap: 8px; }
        .news-type { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 6px; font-weight: 600; }
        .news-type.ind-type { background: #9b59b6; color: #fff; }
        
        /* CB åŸºæœ¬è³‡æ–™å­æ¨™ç±¤ */
        .cb-info-tabs { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
        .cb-table tr.active-cb td { background: #e8f5e9; }
        .cb-table tr.active-cb:hover td { background: #c8e6c9; }
        
        /* çµæœåˆ—å’Œ CB ç¯©é¸æ¨™ç±¤ */
        .result-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px; }
        .cb-filter-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .cb-filter-tag { font-size: 11px; padding: 4px 10px; border-radius: 15px; cursor: pointer; border: 1px solid #ddd; background: #fff; transition: all 0.2s; }
        .cb-filter-tag:hover { border-color: var(--primary); }
        .cb-filter-tag.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .cb-filter-tag .cnt { margin-left: 4px; opacity: 0.7; }
        .card-body { font-size: 13px; color: #555; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        /* CB åˆ—è¡¨è¡¨æ ¼ */
        .cb-table-wrap { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .cb-table { width: 100%; border-collapse: collapse; font-size: 13px; background: #fff; border-radius: 8px; overflow: hidden; }
        .cb-table th { background: #f8f9fa; padding: 12px 8px; text-align: center; color: #666; font-weight: 600; border-bottom: 2px solid #eee; white-space: nowrap; }
        .cb-table td { padding: 10px 8px; border-bottom: 1px solid #f0f0f0; text-align: center; white-space: nowrap; }
        .cb-table tr:hover td { background: #fffaf8; }
        .cb-table .code { color: var(--primary); font-weight: 600; cursor: pointer; }
        .cb-table .stock { color: var(--link); cursor: pointer; }
        .cb-table th.sortable { cursor: pointer; user-select: none; }
        .cb-table th.sortable:hover { background: #eee; }
        .cb-table th .sort-icon { font-size: 10px; color: #999; margin-left: 2px; }
        .cb-table th.sort-asc .sort-icon { color: var(--primary); }
        .cb-table th.sort-desc .sort-icon { color: var(--primary); }
        .cb-table th.sort-asc .sort-icon::after { content: 'â†‘'; }
        .cb-table th.sort-desc .sort-icon::after { content: 'â†“'; }
        .cb-table tfoot { background: #f8f9fa; }
        .cb-table tfoot td { border-top: 2px solid #ddd; padding: 12px 8px; }
        
        /* æ‰‹æ©Ÿç‰ˆéš±è—éƒ¨åˆ†æ¬„ä½ */
        @media(max-width: 768px) {
            .cb-table { font-size: 12px; }
            .cb-table th, .cb-table td { padding: 8px 5px; }
            .cb-table .hide-mobile { display: none; }
        }
        
        /* æ¡Œæ©Ÿç‰ˆæ»¿ç‰ˆ */
        @media(min-width: 1024px) {
            .cb-table { font-size: 14px; }
            .cb-table th, .cb-table td { padding: 12px 10px; }
        }

        /* Modal */
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-inner { background: #fff; width: 100%; max-width: 650px; height: 92vh; border-radius: 16px 16px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        @media(min-width: 1024px) { .modal-inner { max-width: 900px; } }
        @media(min-width: 1400px) { .modal-inner { max-width: 1100px; } }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        
        .m-head { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: flex-start; }
        .m-close { width: 32px; height: 32px; border-radius: 50%; border: none; background: #f0f0f0; font-size: 20px; color: #666; cursor: pointer; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .m-close:hover { background: #e0e0e0; }
        
        .nav-grid { display: flex; gap: 4px; padding: 10px 15px; background: #fafafa; border-bottom: 1px solid #eee; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .nav-btn { padding: 6px 10px; border-radius: 8px; border: none; background: #f0f0f0; font-size: 11px; font-weight: 600; color: #666; cursor: pointer; white-space: nowrap; transition: all 0.2s; flex-shrink: 0; }
        .nav-btn.active { background: var(--primary); color: #fff; }

        .m-body { flex: 1; overflow-y: auto; padding: 15px; background: #fff; -webkit-overflow-scrolling: touch; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        
        .m-footer-tags { padding: 12px 15px; border-top: 1px solid #eee; background: #fafafa; display: none; }
        .m-footer-tags.show { display: block; }
        .m-footer-tags .tags-wrap { display: flex; flex-wrap: wrap; gap: 6px; }
        .m-footer-tags .tag { padding: 6px 12px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .m-footer-tags .tag:hover { transform: scale(1.05); }

        .section-head { font-size: 14px; font-weight: 700; color: #444; margin: 20px 0 10px; padding: 8px 12px; background: linear-gradient(90deg, #f8f9fa, transparent); border-left: 4px solid var(--primary); border-radius: 0 8px 8px 0; }
        .section-head:first-child { margin-top: 0; }
        .hl-block { background: #fafaf8; padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary); margin-bottom: 10px; font-size: 13px; line-height: 1.7; white-space: pre-wrap; }
        .hl-block b { color: var(--primary); }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .info-label { color: #666; }
        .info-val { font-weight: 600; color: #333; }
        
        .list-item { padding: 12px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 8px; background: #fff; cursor: pointer; transition: all 0.2s; }
        .list-item:hover { border-color: var(--primary); background: #fffaf8; }
        .list-title { font-weight: 700; font-size: 14px; color: #2c3e50; margin-bottom: 4px; }
        .list-sub { font-size: 12px; color: #888; margin-bottom: 6px; }
        .list-content { font-size: 13px; color: #555; line-height: 1.6; white-space: pre-wrap; }

        .tag-link { color: var(--link); cursor: pointer; font-weight: 600; }
        .tag-link:hover { text-decoration: underline; }
        
        .fin-switcher { display: flex; margin-bottom: 10px; border: 1px solid var(--primary); border-radius: 6px; overflow: hidden; }
        .fin-btn { flex: 1; padding: 8px; text-align: center; font-size: 13px; color: var(--primary); background: #fff; cursor: pointer; font-weight: 600; border-right: 1px solid var(--primary); transition: all 0.2s; }
        .fin-btn:last-child { border-right: none; }
        .fin-btn.active { background: var(--primary); color: #fff; }
        .fin-sub-pane { display: none; }
        .fin-sub-pane.active { display: block; }
        
        .rev-unit { text-align: right; font-size: 11px; color: #888; margin-bottom: 8px; }

        .table-wrap { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .fin-table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
        .fin-table th { background: #f8f9fa; padding: 10px 8px; border-bottom: 2px solid #ddd; text-align: right; color: #555; position: sticky; top: 0; }
        .fin-table td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: right; color: #333; }
        .fin-table th:first-child, .fin-table td:first-child { position: sticky; left: 0; background: #fff; border-right: 1px solid #eee; text-align: left; z-index: 2; font-weight: 700; }
        .fin-table tr:nth-child(even) td { background: #fcfcfc; }
        .fin-table tr:nth-child(even) td:first-child { background: #fcfcfc; }
        .fin-table .highlight-row td { background: #fff3e0; font-weight: 700; }
        .fin-table .highlight-row td:first-child { background: #fff3e0; color: var(--primary); }
        
        .t-up { color: var(--up); font-weight: 700; }
        .t-down { color: var(--down); font-weight: 700; }

        .rating-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .rating-card .big-num { font-size: 28px; font-weight: 800; }
        .rating-card .label { font-size: 12px; opacity: 0.8; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #f8f9fa; padding: 12px; text-align: center; border-radius: 8px; }
        .stat-box .num { font-size: 18px; font-weight: 700; color: var(--primary); }
        .stat-box .lbl { font-size: 11px; color: #888; margin-top: 2px; }

        .qa-item { margin-bottom: 15px; }
        .qa-q { background: #e3f2fd; padding: 10px 12px; border-radius: 8px 8px 0 0; font-weight: 600; color: #1565c0; font-size: 13px; }
        .qa-a { background: #f5f5f5; padding: 10px 12px; border-radius: 0 0 8px 8px; font-size: 13px; line-height: 1.6; color: #444; }

        .timeline-item { position: relative; padding-left: 20px; margin-bottom: 12px; }
        .timeline-item::before { content: ''; position: absolute; left: 0; top: 8px; width: 10px; height: 10px; background: var(--primary); border-radius: 50%; }
        .timeline-item::after { content: ''; position: absolute; left: 4px; top: 20px; width: 2px; height: calc(100% + 4px); background: #e0e0e0; }
        .timeline-item:last-child::after { display: none; }
        .timeline-date { font-size: 12px; font-weight: 700; color: var(--primary); }
        .timeline-text { font-size: 13px; color: #444; margin-top: 2px; }

        @media(min-width: 768px) { .modal { align-items: center; } .modal-inner { height: 85vh; border-radius: 16px; } }
        @media(max-width: 480px) { .cb-stats-grid { grid-template-columns: repeat(3, 1fr); } .cb-stat-num { font-size: 18px; } }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="loading-spinner"></div>
    <div style="font-weight:700;font-size:18px">Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</div>
    <div style="font-size:12px;color:#888;margin-top:8px" id="loadStatus">æ­£åœ¨è¼‰å…¥è³‡æ–™åº«...</div>
</div>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
        <p style="font-size:12px;color:#666">å…¨æ–¹ä½å°è‚¡æŠ•è³‡æ±ºç­–ç³»çµ± v11.7</p>
    </div>

    <div class="db-switcher">
        <div class="db-tab active" data-db="news">âš¡ å¤–é›» <span class="count" id="c-news">0</span></div>
        <div class="db-tab" data-db="memo">ğŸ“‹ Memo <span class="count" id="c-memo">0</span></div>
        <div class="db-tab" data-db="reports">ğŸ“‘ ç”¢æ¥­ <span class="count" id="c-reports">0</span></div>
        <div class="db-tab" data-db="strategy">ğŸ”® å±•æœ› <span class="count" id="c-strategy">0</span></div>
        <div class="db-tab" data-db="stocks">ğŸ¢ å€‹è‚¡ <span class="count" id="c-stocks">0</span></div>
        <div class="db-tab" data-db="trends">ğŸ“ˆ è¶¨å‹¢ <span class="count" id="c-trends">0</span></div>
        <div class="db-tab" data-db="cb">ğŸ« CB <span class="count" id="c-cb">0</span></div>
    </div>

    <!-- CB å°ˆå±¬å››åˆ—æ¨™ç±¤å€ -->
    <div id="cbTabsArea" style="display:none">
        <div class="cb-main-title">ğŸ« å¯è½‰å‚µå®Œæ•´è³‡è¨Š</div>
        <div class="cb-tabs-container">
            <!-- ç¬¬ä¸€åˆ— -->
            <div class="cb-tabs-row">
                <div class="cb-main-tab active" data-mode="info">ğŸ“‹ åŸºæœ¬è³‡æ–™</div>
                <div class="cb-main-tab" data-mode="history">ğŸ“œ æ­·å²é«˜ä½</div>
                <div class="cb-main-tab" data-mode="active">ğŸ« ç›®å‰æ›ç‰Œ</div>
            </div>
            <!-- ç¬¬äºŒåˆ— -->
            <div class="cb-tabs-row">
                <div class="cb-main-tab" data-mode="primary">ğŸ“ åˆç´šå¸‚å ´</div>
                <div class="cb-main-tab" data-mode="auction">ğŸ”¨ ç«¶æ‹è³‡è¨Š</div>
                <div class="cb-main-tab" data-mode="cbas">ğŸ’¹ CBASå ±åƒ¹</div>
            </div>
            <!-- ç¬¬ä¸‰åˆ— -->
            <div class="cb-tabs-row">
                <div class="cb-main-tab" data-mode="putback">ğŸ’° æå‰è³£å›</div>
                <div class="cb-main-tab" data-mode="redeem">ğŸ”” å¼·åˆ¶è´–å›</div>
                <div class="cb-main-tab" data-mode="stopconv">â¸ï¸ æš«åœè½‰æ›</div>
            </div>
            <!-- ç¬¬å››åˆ— -->
            <div class="cb-tabs-row">
                <div class="cb-main-tab" data-mode="balance">ğŸ“Š æµé€šé¤˜é¡</div>
                <div class="cb-main-tab" data-mode="price">ğŸ“ˆ åƒ¹æ ¼èµ°å‹¢</div>
                <div class="cb-main-tab" data-mode="concept">ğŸ’¡ æ¦‚å¿µè‚¡ç¥¨</div>
            </div>
        </div>
    </div>

    <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" class="search-input" id="search" placeholder="æœå°‹å…¬å¸ã€ä»£è™Ÿã€ç”¢æ¥­ã€#Tag..." oninput="handleInput(this)">
        <div class="clear-btn" id="clearBtn" onclick="clearSearch()">âœ•</div>
    </div>

    <!-- CB çµ±è¨ˆå€å¡Š (åªåœ¨ CB åˆ†é é¡¯ç¤º) -->
    <div id="cbStatsArea" style="display:none"></div>
    
    <!-- å€‹è‚¡çµ±è¨ˆå€å¡Š (åªåœ¨å€‹è‚¡åˆ†é é¡¯ç¤º) -->
    <div id="stockStatsArea" style="display:none"></div>
    
    <!-- Memo çµ±è¨ˆå€å¡Š (åªåœ¨ Memo åˆ†é é¡¯ç¤º) -->
    <div id="memoStatsArea" style="display:none"></div>

    <div class="result-bar">
        <div style="font-size:12px;color:#666;">æ‰¾åˆ° <b id="resCount" style="color:var(--primary)">0</b> ç­†è³‡æ–™</div>
        <div id="cbFilterTags" class="cb-filter-tags" style="display:none"></div>
    </div>
    <div class="card-list" id="list"></div>
</div>

<div class="modal" id="modal" onclick="closeModal(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">
        <div class="m-head">
            <div id="m-info" style="flex:1"></div>
            <button class="m-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="nav-grid" id="navGrid"></div>
        <div class="m-body" id="m-body"></div>
        <div class="m-footer-tags" id="m-tags"></div>
    </div>
</div>

<script>
const FILES = {
    NEWS: '01_news.xlsx', MEMO: '02_memo.xlsx', REPORTS: '03_reports.xlsx',
    MASTER: '04_master.xlsx', STRAT: '05_Strategy_01.xlsx', CB: '00_CB.xlsx', REV: '06_revenue.xlsx'
};

const DB = { 
    news:[], memo:[], memoStock:[], memoIndustry:[], reports:[], strategy:[], stocks:{}, 
    cb:[], cbHistory:[], cbAuction:[], cbPrimary:[], cbBoard:[], cbBalance:[], cbCBAS:[],
    cbRedeem:[], cbStopConv:[], cbPriceAdj:[], cbConcept:[], cbAll:[], cbPutback:[],
    conceptLists: {}, // å„æ¦‚å¿µè‚¡æ¸…å–® { 'NVDIAæ¦‚å¿µè‚¡': ['6579','2353',...], ... }
    trends:[], conceptStocks:[] 
};
let CB_MODE = 'info'; // 'info' åŸºæœ¬è³‡æ–™, 'active' ç›®å‰æ›ç‰Œ, 'history' æ­·å²é«˜ä½, 'auction' ç«¶æ‹è³‡è¨Š, 'primary' åˆç´šå¸‚å ´, 'balance' æµé€šé¤˜é¡, 'cbas' CBASå ±åƒ¹, 'putback' æå‰è³£å›, 'redeem' å¼·åˆ¶è´–å›, 'stopconv' æš«åœè½‰æ›, 'price' åƒ¹æ ¼èµ°å‹¢, 'concept' æ¦‚å¿µè‚¡ç¥¨
let CB_INFO_TAB = 'issue'; // 'issue' ç™¼è¡Œæ¢ä»¶, 'timeline' æ™‚ç¨‹è³‡è¨Š, 'putback' è³£å›æ¢ä»¶
let PRIMARY_MODE = 'underwriting'; // 'underwriting' æ‰¿éŠ·ä¸­, 'board' è‘£äº‹æœƒå…¬å‘Š
let STOCK_MODE = 'all'; // 'all' å…¨éƒ¨å€‹è‚¡, 'concept' æ¦‚å¿µè‚¡
let MEMO_MODE = 'all'; // 'all' å…¨éƒ¨, 'stock' å€‹è‚¡, 'industry' ç”¢æ¥­
const META = { 
    memoDetail:{}, tracking:{}, finance:{}, products:{}, 
    concepts:{}, cbMap:{}, relatedNews:{}, relatedMemo:{},
    reportFocus:{}, reportViews:{}, reportRatings:{},
    stratMacro:{}, stratFundamental:{}, stratTheme:{}, stratChip:{}, stratTech:{}, stratQuarter:{}, stratPicks:{},
    revData: { month:{}, quarter:{}, year:{}, highlights:{} },
    cbStats: { total: 0, companies: 0, industries: {}, totalBalance: 0 },
    cbPrimaryStats: { underwriting: 0, board: 0 },
    cbBalanceStats: { total: 0, totalBalance: 0 },
    cbCBASStats: { total: 0 },
    cbPutbackStats: { total: 0 },
    stockStats: { total: 0, conceptTotal: 0, markets: {}, industries: {}, conceptCategories: {} },
    memoStats: { total: 0, stockTotal: 0, industryTotal: 0, brokers: {}, types: {} }
};

let CURR_DB = 'news';
const $ = id => document.getElementById(id);
const safe = v => (v==null||v==undefined?'':String(v).trim());

// çµ±ä¸€ä»£ç¢¼è™•ç†å‡½æ•¸
const normalizeCode = v => {
    if(!v) return '';
    let s = String(v).trim();
    // ç§»é™¤ .0 (Excel æ•¸å­—æ ¼å¼)
    if(s.match(/^\d+\.0$/)) s = s.replace('.0', '');
    // ç§»é™¤ TT å¾Œç¶´
    s = s.replace(/\s*TT$/i, '');
    // è£œé›¶åˆ°4ä½
    if(s.match(/^\d{1,4}$/) && s.length < 4) s = s.padStart(4, '0');
    return s;
};

const fmtDate = v => {
    if(!v) return '';
    if(typeof v === 'number' && v > 20000) { 
        const d = new Date((v-25569)*86400000); 
        return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`; 
    }
    return String(v).split(' ')[0].split('T')[0];
};
const getDateVal = v => { if(!v) return 0; if(typeof v === 'number') return (v-25569)*86400000; return new Date(v).getTime(); };
const fmtNum = (v, decimal=0) => {
    if(v===undefined||v===null||v==='') return '-';
    let n = parseFloat(String(v).replace(/,/g,''));
    if(isNaN(n)) return v;
    return decimal > 0 ? n.toFixed(decimal) : n.toLocaleString();
};
const colorClass = v => {
    if(!v||v==='-') return '';
    let n = parseFloat(String(v).replace(/[%$,]/g,''));
    return n>0?'t-up':n<0?'t-down':'';
};

const fmtTxt = t => {
    if(!t) return '';
    let html = safe(t).replace(/\n/g, '<br>');
    html = html.replace(/#(\S+)/g, '<span class="tag-link" onclick="setSearch(\'#$1\');closeModal()">#$1</span>');
    return html;
};

function handleInput(el) { 
    $('clearBtn').style.display = el.value.length > 0 ? 'block' : 'none'; 
    renderList(); 
}
function clearSearch() { 
    $('search').value=''; 
    $('search').focus(); 
    $('clearBtn').style.display='none'; 
    renderList(); 
}
window.setSearch = term => { $('search').value = term; handleInput($('search')); };

async function fetchXlsx(url) {
    try {
        $('loadStatus').innerText = `è¼‰å…¥ ${url}...`;
        const res = await fetch(url);
        if(!res.ok) throw new Error();
        return XLSX.read(await res.arrayBuffer(), {type:'array'});
    } catch(e) { console.warn('Load Error:', url); return null; }
}

async function init() {
  try {
    let wb;
    
    // 1. Master + æ¦‚å¿µè‚¡
    wb = await fetchXlsx(FILES.MASTER);
    if(wb) {
        // ä¸»è³‡æ–™åº«
        XLSX.utils.sheet_to_json(wb.Sheets['ä¸»è³‡æ–™åº«']||[]).forEach(r => {
            const code = normalizeCode(r['ä»£è™Ÿ']);
            if(code) {
                DB.stocks[code] = {...r, 'ä»£è™Ÿ': code};
                // çµ±è¨ˆå¸‚å ´å’Œç”¢æ¥­
                const market = r['å¸‚å ´åˆ†é¡'] || 'å…¶ä»–';
                const industry = r['ç”¢æ¥­åˆ†é¡'] || 'å…¶ä»–';
                META.stockStats.markets[market] = (META.stockStats.markets[market] || 0) + 1;
                META.stockStats.industries[industry] = (META.stockStats.industries[industry] || 0) + 1;
            }
        });
        META.stockStats.total = Object.keys(DB.stocks).length;
        
        // æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«
        const csSheet = wb.Sheets['ğŸ’¡æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«'];
        if(csSheet) {
            const range = XLSX.utils.decode_range(csSheet['!ref']);
            for(let R=3; R<=range.e.r; R++) {
                const code = normalizeCode(csSheet[XLSX.utils.encode_cell({r:R,c:0})]?.v);
                const name = csSheet[XLSX.utils.encode_cell({r:R,c:1})]?.v;
                const concept = csSheet[XLSX.utils.encode_cell({r:R,c:2})]?.v;
                const subCat = csSheet[XLSX.utils.encode_cell({r:R,c:3})]?.v;
                const desc = csSheet[XLSX.utils.encode_cell({r:R,c:4})]?.v;
                const importance = csSheet[XLSX.utils.encode_cell({r:R,c:5})]?.v;
                
                if(code && concept) {
                    // åŸæœ‰çš„ META.concepts å°ç…§
                    if(!META.concepts[code]) META.concepts[code] = [];
                    META.concepts[code].push({ concept: safe(concept), sub: safe(subCat) });
                    
                    // æ–°å¢åˆ° conceptStocks é™£åˆ—
                    DB.conceptStocks.push({
                        '_code': code,
                        '_name': safe(name),
                        '_concept': safe(concept),
                        '_subCat': safe(subCat),
                        '_desc': safe(desc),
                        '_importance': safe(importance),
                        '_industry': DB.stocks[code]?.['ç”¢æ¥­åˆ†é¡'] || ''
                    });
                    
                    // çµ±è¨ˆæ¦‚å¿µåˆ†é¡
                    META.stockStats.conceptCategories[concept] = (META.stockStats.conceptCategories[concept] || 0) + 1;
                }
            }
        }
        META.stockStats.conceptTotal = DB.conceptStocks.length;
        console.log('å€‹è‚¡è¼‰å…¥:', META.stockStats.total, 'æ¦‚å¿µè‚¡:', META.stockStats.conceptTotal);
        
        // è¼‰å…¥å„æ¦‚å¿µè‚¡æ¸…å–®å·¥ä½œè¡¨
        const conceptSheets = ['å¯Œæ«ƒ50æˆä»½è‚¡', 'å°ç£50æˆä»½è‚¡', 'ä¸­å‹100æˆä»½è‚¡', 'NVDIAæ¦‚å¿µè‚¡', 'å°ç©é›»æ¦‚å¿µè‚¡'];
        conceptSheets.forEach(sheetName => {
            const sheet = wb.Sheets[sheetName];
            if(sheet) {
                const rows = XLSX.utils.sheet_to_json(sheet);
                DB.conceptLists[sheetName] = rows.map(r => normalizeCode(r['ä»£ç¢¼'])).filter(c => c);
                console.log(`${sheetName}: ${DB.conceptLists[sheetName].length} æª”`);
            }
        });
    }

    // 2. Revenue - å®Œæ•´è®€å–
    wb = await fetchXlsx(FILES.REV);
    if(wb) {
        // æœˆç‡Ÿæ”¶ - æ”¶é›†å®Œæ•´è³‡æ–™
        const sheetM = wb.Sheets['000_æœˆç‡Ÿæ”¶'];
        if(sheetM) {
            const rows = XLSX.utils.sheet_to_json(sheetM, {defval: null});
            if(rows.length > 0) {
                const headers = Object.keys(rows[0]);
                const mCols = headers.filter(h => h.includes('å–®æœˆç‡Ÿæ”¶')).sort();
                const accCols = headers.filter(h => h.includes('ç´¯æœˆç‡Ÿæ”¶(å„„)') && !h.includes('å–®æœˆ')).sort();
                
                console.log('æœˆç‡Ÿæ”¶æ¬„ä½:', mCols.length, 'ç´¯è¨ˆæ¬„ä½:', accCols.length);
                
                rows.forEach(r => {
                    const code = normalizeCode(r['ä»£è™Ÿ']);
                    if(!code || code.length > 5 || code.startsWith('0')) return;
                    
                    const data = [];
                    mCols.forEach(col => {
                        const m = col.match(/(\d+)M(\d+)/);
                        if(m && r[col] !== null && r[col] !== undefined) {
                            // 25M08 = 2025å¹´8æœˆ (å‰å…©ä½å°±æ˜¯è¥¿å…ƒå¹´å¾Œå…©ä½)
                            const year = 2000 + parseInt(m[1]);
                            const month = parseInt(m[2]);
                            const period = `${year}/${month.toString().padStart(2, '0')}`;
                            const accCol = accCols.find(c => c.includes(m[0]));
                            data.push({ 
                                d: period,
                                period: m[0],
                                year: year,
                                month: month,
                                rev: r[col],
                                acc: accCol ? r[accCol] : null
                            });
                        }
                    });
                    
                    if(data.length > 0) {
                        // æŒ‰æ—¥æœŸæ’åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
                        data.sort((a, b) => b.d.localeCompare(a.d));
                        META.revData.month[code] = data;
                    }
                });
                console.log('æœˆç‡Ÿæ”¶è¼‰å…¥å…¬å¸æ•¸:', Object.keys(META.revData.month).length);
            }
        }
        
        // å­£ç‡Ÿæ”¶
        const sheetQ = wb.Sheets['000_å­£ç‡Ÿæ”¶'];
        if(sheetQ) {
            const rows = XLSX.utils.sheet_to_json(sheetQ, {defval: null});
            if(rows.length > 0) {
                const headers = Object.keys(rows[0]);
                const qCols = headers.filter(h => h.includes('å–®å­£ç‡Ÿæ”¶')).sort();
                
                rows.forEach(r => {
                    const code = normalizeCode(r['ä»£è™Ÿ']);
                    if(!code || code.length > 5 || code.startsWith('0')) return;
                    
                    const data = [];
                    qCols.forEach(col => {
                        const m = col.match(/(\d+)Q(\d)/);
                        if(m && r[col] !== null && r[col] !== undefined) {
                            const year = 2000 + parseInt(m[1]);
                            data.push({ 
                                d: `${year}Q${m[2]}`, 
                                year: year,
                                q: parseInt(m[2]),
                                rev: r[col] 
                            });
                        }
                    });
                    
                    if(data.length > 0) {
                        data.sort((a, b) => b.d.localeCompare(a.d));
                        META.revData.quarter[code] = data;
                    }
                });
                console.log('å­£ç‡Ÿæ”¶è¼‰å…¥å…¬å¸æ•¸:', Object.keys(META.revData.quarter).length);
            }
        }
        
        // å¹´ç‡Ÿæ”¶
        const sheetY = wb.Sheets['000_å¹´ç‡Ÿæ”¶'];
        if(sheetY) {
            const rows = XLSX.utils.sheet_to_json(sheetY, {defval: null});
            if(rows.length > 0) {
                const headers = Object.keys(rows[0]);
                const yCols = headers.filter(h => h.includes('å¹´åº¦ç‡Ÿæ”¶')).sort();
                
                rows.forEach(r => {
                    const code = normalizeCode(r['ä»£è™Ÿ']);
                    if(!code || code.length > 5 || code.startsWith('0')) return;
                    
                    const data = [];
                    yCols.forEach(col => {
                        const m = col.match(/(\d{4})/);
                        if(m && r[col] !== null && r[col] !== undefined) {
                            data.push({ 
                                d: m[0], 
                                year: parseInt(m[0]),
                                rev: r[col] 
                            });
                        }
                    });
                    
                    if(data.length > 0) {
                        data.sort((a, b) => b.year - a.year);
                        META.revData.year[code] = data;
                    }
                });
                console.log('å¹´ç‡Ÿæ”¶è¼‰å…¥å…¬å¸æ•¸:', Object.keys(META.revData.year).length);
            }
        }
        
        // è²¡å ±å‚™è¨»
        const sheetH = wb.Sheets['10_è²¡å ±å‚™è¨»'];
        if(sheetH) {
            XLSX.utils.sheet_to_json(sheetH, {defval: null}).forEach(r => {
                const code = normalizeCode(r['ä»£è™Ÿ']);
                if(code) META.revData.highlights[code] = r;
            });
        }
    }

    // 3. News
    wb = await fetchXlsx(FILES.NEWS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å¤–é›»ç¶œåˆå ±å°']||[]).forEach(r => {
            const code = normalizeCode(r['è‚¡è™Ÿ']);
            DB.news.push({...r, 'è‚¡è™Ÿ': code});
            if(code) { 
                if(!META.relatedNews[code]) META.relatedNews[code]=[]; 
                META.relatedNews[code].push(r); 
            }
        });
        DB.news.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
        console.log('Newsè¼‰å…¥:', DB.news.length);
    }

    // 4. Memo
    wb = await fetchXlsx(FILES.MEMO);
    if(wb) {
        // ç”¢æ¥­é¡å ±å‘Šé—œéµå­—
        const industryKeywords = ['ç”¢æ¥­', 'TPCA', 'åœ‹éš›è‚¡å¸‚', 'ç¸½ç¶“', 'ç­–ç•¥'];
        
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¡¨']||[]).forEach(r => {
            const code = normalizeCode(r['è‚¡è™Ÿ']);
            const reportType = safe(r['å ±å‘Šé¡å‹']);
            const memoData = {...r, 'è‚¡è™Ÿ': code};
            
            DB.memo.push(memoData);
            
            // åˆ¤æ–·æ˜¯å€‹è‚¡é‚„æ˜¯ç”¢æ¥­
            const isIndustry = industryKeywords.some(kw => reportType.includes(kw));
            if(isIndustry) {
                DB.memoIndustry.push(memoData);
            } else {
                DB.memoStock.push(memoData);
            }
            
            // çµ±è¨ˆåˆ¸å•†å’Œå ±å‘Šé¡å‹
            const broker = safe(r['åˆ¸å•†']);
            if(broker) META.memoStats.brokers[broker] = (META.memoStats.brokers[broker] || 0) + 1;
            if(reportType) META.memoStats.types[reportType] = (META.memoStats.types[reportType] || 0) + 1;
            
            if(code) { 
                if(!META.relatedMemo[code]) META.relatedMemo[code]=[]; 
                META.relatedMemo[code].push(r); 
            }
        });
        DB.memo.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
        DB.memoStock.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
        DB.memoIndustry.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
        
        META.memoStats.total = DB.memo.length;
        META.memoStats.stockTotal = DB.memoStock.length;
        META.memoStats.industryTotal = DB.memoIndustry.length;
        console.log('Memoè¼‰å…¥:', META.memoStats.total, 'å€‹è‚¡:', META.memoStats.stockTotal, 'ç”¢æ¥­:', META.memoStats.industryTotal);
        
        XLSX.utils.sheet_to_json(wb.Sheets['è©³ç´°å…§å®¹åº«']||[]).forEach(r => META.memoDetail[safe(r['ç·¨è™Ÿ'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['è²¡å‹™æ•¸æ“šå½™ç¸½']||[]).forEach(r => META.finance[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢å“çµæ§‹åˆ†æ']||[]).forEach(r => META.products[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['å…¬å¸è¿½è¹¤è¡¨']||[]).forEach(r => META.tracking[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢æ¥­è¶¨å‹¢ç¸½è¦½']||[]).forEach(r => {
            if(r['ç”¢æ¥­']) DB.trends.push(r);
        });
    }

    // 5. Reports
    wb = await fetchXlsx(FILES.REPORTS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r => DB.reports.push(r));
        DB.reports.sort((a,b) => getDateVal(b['å ±å‘Šæ—¥æœŸ'])-getDateVal(a['å ±å‘Šæ—¥æœŸ']));
        
        XLSX.utils.sheet_to_json(wb.Sheets['ç„¦é»åˆ†æå…§å®¹']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.reportFocus[rid]) META.reportFocus[rid]=[]; META.reportFocus[rid].push(r); }
        });
        XLSX.utils.sheet_to_json(wb.Sheets['åˆ¸å•†è§€é»çµè«–']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) META.reportViews[rid] = r;
        });
        XLSX.utils.sheet_to_json(wb.Sheets['å€‹è‚¡è©•åƒ¹è¡¨']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.reportRatings[rid]) META.reportRatings[rid]=[]; META.reportRatings[rid].push(r); }
        });
    }

    // 6. Strategy (è¶¨å‹¢å±•æœ›) - æ–°æ ¼å¼
    wb = await fetchXlsx(FILES.STRAT);
    if(wb) {
        // è®€å–å ±å‘Šç´¢å¼•
        const indexSheet = wb.Sheets['å ±å‘Šç´¢å¼•'];
        if(indexSheet) {
            const indexData = XLSX.utils.sheet_to_json(indexSheet, {header: 1});
            // æ‰¾å ±å‘Šæ¸…å–®é–‹å§‹ä½ç½® (è·³éæ¨™é¡Œ)
            for(let i = 0; i < indexData.length; i++) {
                const row = indexData[i];
                if(row[0] === 'å ±å‘Šç·¨è™Ÿ') {
                    // æ¥ä¸‹ä¾†æ˜¯å ±å‘Šè³‡æ–™
                    for(let j = i+1; j < indexData.length; j++) {
                        const r = indexData[j];
                        if(r[0] && r[0].startsWith('RPT-')) {
                            const rptId = r[0];
                            const sheetName = wb.SheetNames.find(n => n.includes(rptId.replace('-', '')));
                            
                            DB.strategy.push({
                                'å ±å‘Šç·¨è™Ÿ': rptId,
                                'å ±å‘Šä¸»é¡Œ': r[1],
                                'ä¸»è¬›å–®ä½': r[2],
                                'è¬›è€…': r[3],
                                'å ±å‘Šæ—¥æœŸ': r[4],
                                'é æ•¸': r[5],
                                '_sheetName': sheetName
                            });
                        }
                    }
                    break;
                }
            }
        }
        
        // è®€å–æ¯å€‹å ±å‘Šçš„è©³ç´°å…§å®¹
        DB.strategy.forEach(report => {
            const sheetName = report._sheetName;
            if(sheetName && wb.Sheets[sheetName]) {
                const sheetData = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {header: 1});
                const sections = [];
                let currentSection = null;
                let basicInfo = {};
                
                for(let i = 1; i < sheetData.length; i++) {
                    const row = sheetData[i];
                    const tag = row[0];
                    const val = row[1];
                    
                    if(!tag) continue;
                    
                    // åŸºæœ¬è³‡è¨Šæ¬„ä½
                    if(['å ±å‘Šç·¨è™Ÿ', 'å ±å‘Šä¸»é¡Œ', 'å‰¯æ¨™é¡Œ', 'ç™¼å¸ƒå–®ä½', 'ä¸»è¬›äºº', 'ç™¼å¸ƒæ—¥æœŸ', 'å ±å‘Šé æ•¸', 'æ ¸å¿ƒè§€é»', 'æ¨™ç±¤åˆ†é¡', 'è³‡æ–™ä¾†æº'].includes(tag)) {
                        basicInfo[tag] = val;
                        continue;
                    }
                    
                    // åˆ†é¡æ¨™é¡Œ (ç”¨ã€ã€‘åŒ…èµ·ä¾†)
                    if(tag.startsWith('ã€') && tag.endsWith('ã€‘')) {
                        if(currentSection) sections.push(currentSection);
                        currentSection = { title: tag, items: [] };
                    } else if(currentSection) {
                        currentSection.items.push({ label: tag, value: val });
                    }
                }
                if(currentSection) sections.push(currentSection);
                
                // å„²å­˜åˆ° META
                META.stratSections = META.stratSections || {};
                META.stratSections[report['å ±å‘Šç·¨è™Ÿ']] = {
                    basic: basicInfo,
                    sections: sections
                };
            }
        });
        
        DB.strategy.sort((a,b) => getDateVal(b['å ±å‘Šæ—¥æœŸ'])-getDateVal(a['å ±å‘Šæ—¥æœŸ']));
        console.log('è¶¨å‹¢å±•æœ›è¼‰å…¥:', DB.strategy.length, 'ç¯‡å ±å‘Š');
    }

    // 7. CB - å®Œæ•´è®€å–
    wb = await fetchXlsx(FILES.CB);
    if(wb) {
        // å…ˆè®€å–æ›ç‰Œé«˜ä½è³‡æ–™ (00å·¥ä½œè¡¨)
        const cbHighLow = {};
        const sheet00Name = wb.SheetNames.find(n => n.startsWith('00_'));
        if(sheet00Name) {
            XLSX.utils.sheet_to_json(wb.Sheets[sheet00Name]||[]).forEach(r => {
                const cbCode = safe(r['ä»£è™Ÿ']);
                if(cbCode) {
                    const high = parseFloat(r['æ›ç‰Œæœ€é«˜']) || 0;
                    const low = parseFloat(r['æ›ç‰Œæœ€ä½']) || 0;
                    cbHighLow[cbCode] = {
                        high: high,
                        low: low,
                        range: low > 0 ? ((high - low) / low * 100) : 0,
                        avgVol: r['æœˆå‡æˆäº¤']
                    };
                }
            });
        }
        
        // è®€å– 09_æœ€æ–°å‹•æ…‹æ¯é€±æ—¥è¡Œæƒ… - å–å¾—æœ€æ–°æ”¶ç›¤åƒ¹
        const cbLatestPrice = {};
        XLSX.utils.sheet_to_json(wb.Sheets['09_æœ€æ–°å‹•æ…‹æ¯é€±æ—¥è¡Œæƒ…']||[]).forEach(r => {
            const cbCode = safe(r['ä»£ç¢¼']);
            if(cbCode) {
                cbLatestPrice[cbCode] = parseFloat(r['CBæ”¶ç›¤åƒ¹']) || 0;
            }
        });
        
        // è®€å– 05_CBç«¶æ‹ç¯©é¸æ¢ä»¶å€é–“ - å»ºç«‹ç”¢æ¥­ç°¡ç¨±å°ç…§è¡¨
        const industrySimpleMap = {
            'å…‰é›»æ¥­': 'å…‰é›»', 'å…¶ä»–æ¥­': 'å…¶ä»–', 'å…¶ä»–æ¥­é›»å­æ¥­': 'å…¶ä»–é›»å­',
            'åŒ–å­¸å·¥æ¥­': 'åŒ–å·¥', 'åŠå°é«”æ¥­': 'åŠå°é«”', 'å¡‘è† å·¥æ¥­': 'å¡‘è† ',
            'å±…å®¶ç”Ÿæ´»': 'å±…å®¶ç”Ÿæ´»', 'å»ºæç‡Ÿé€ æ¥­': 'å»ºæç‡Ÿé€ ', 'æ•¸ä½é›²ç«¯': 'æ•¸ä½é›²ç«¯',
            'æ–‡åŒ–å‰µæ„æ¥­': 'æ–‡åŒ–å‰µæ„', 'æ©¡è† å·¥æ¥­': 'å…¶ä»–', 'æ°´æ³¥å·¥æ¥­': 'æ°´æ³¥',
            'æ±½è»Šå·¥æ¥­': 'æ±½è»Š', 'æ²¹é›»ç‡ƒæ°£æ¥­': 'æ²¹é›»ç‡ƒæ°£', 'ç»ç’ƒé™¶ç“·': 'å…¶ä»–',
            'ç”ŸæŠ€é†«ç™‚æ¥­': 'ç”ŸæŠ€é†«ç™‚', 'ç´¡ç¹”çº–ç¶­': 'ç´¡ç¹”çº–ç¶­', 'ç¶ èƒ½ç’°ä¿': 'ç¶ èƒ½ç’°ä¿',
            'èˆªé‹æ¥­': 'èˆªé‹', 'è§€å…‰é¤æ—…': 'è§€å…‰é¤æ—…', 'è­‰åˆ¸æ¥­': 'é‡‘èä¿éšª',
            'è²¿æ˜“ç™¾è²¨æ¥­': 'è²¿æ˜“ç™¾è²¨', 'è³‡è¨Šæœå‹™æ¥­': 'è³‡è¨Šæœå‹™', 'è¾²æ¥­ç§‘æŠ€æ¥­': 'è¾²æ¥­ç§‘æŠ€',
            'é€šä¿¡ç¶²è·¯æ¥­': 'é€šä¿¡ç¶²è·¯', 'é€ ç´™å·¥æ¥­': 'é€ ç´™', 'é‹å‹•ä¼‘é–’': 'é‹å‹•ä¼‘é–’',
            'é‡‘æ§æ¥­': 'é‡‘èä¿éšª', 'éŠ€è¡Œæ¥­': 'é‡‘èä¿éšª', 'é‹¼éµå·¥æ¥­': 'é‹¼éµ',
            'é›»å™¨é›»çºœ': 'é›»å™¨é›»çºœ', 'é›»å­é€šè·¯æ¥­': 'é›»å­é€šè·¯', 'é›»å­é›¶çµ„ä»¶æ¥­': 'é›»å­é›¶çµ„ä»¶',
            'é›»æ©Ÿæ©Ÿæ¢°': 'é›»æ©Ÿæ©Ÿæ¢°', 'é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­': 'é›»è…¦åŠé€±é‚Š', 'é£Ÿå“å·¥æ¥­': 'é£Ÿå“'
        };
        const getSimpleIndustry = (ind) => industrySimpleMap[ind] || ind || 'å…¶ä»–';
        
        // è®€å– 01_ALLCBåŸºæœ¬è³‡æ–™ - å…¨éƒ¨CBï¼ˆå«æ­·å²ï¼‰
        const cbBasicInfo = {};
        const activeCodes = new Set(); // è¨˜éŒ„æ›ç‰Œä¸­çš„ä»£è™Ÿ
        
        XLSX.utils.sheet_to_json(wb.Sheets['01_ALLCBåŸºæœ¬è³‡æ–™']||[]).forEach(r => {
            const cbCode = safe(r['CBä»£è™Ÿ']);
            if(cbCode) {
                const hl = cbHighLow[cbCode] || {};
                const fullIndustry = safe(r['ç”¢æ¥­åˆ†é¡']);
                cbBasicInfo[cbCode] = {
                    stockCode: normalizeCode(r['è‚¡ç¥¨ä»£è™Ÿ']),
                    name: safe(r['åç¨±']),
                    method: safe(r['è©¢åœˆç«¶æ‹']),
                    guarantee: safe(r['æ“”ä¿']),
                    rating: r['ä¿¡è©•'],
                    issuer: safe(r['ç™¼è¡Œåˆ¸å•†']),
                    scale: r['ç™¼è¡Œè¦æ¨¡'],
                    convPrice: r['è½‰æ›åƒ¹æ ¼'],
                    years: r['ç™¼è¡Œå¹´æœŸ'],
                    issuePrice: r['ç™¼è¡Œåƒ¹æ ¼'],
                    expPrice: r['åˆ°æœŸé‚„æœ¬åƒ¹æ ¼'],
                    premium: r['è¨‚åƒ¹æº¢åƒ¹ç‡'],
                    position: safe(r['ç”¢æ¥­åœ°ä½']),
                    capital: r['è‚¡æœ¬å¤§å°'],
                    industry: getSimpleIndustry(fullIndustry),
                    listDate: r['æ›ç‰Œæ—¥æœŸ'],
                    expDate: r['åˆ°æœŸæ—¥æœŸ'],
                    high: hl.high || parseFloat(r['æ›ç‰Œæœ€é«˜']) || 0,
                    low: hl.low || parseFloat(r['æ›ç‰Œæœ€ä½']) || 0
                };
            }
        });
        
        // è®€å– 02_ALLCBç™¼è¡Œæ™‚ç¨‹
        const cbTimeline = {};
        XLSX.utils.sheet_to_json(wb.Sheets['02_ALLCBç™¼è¡Œæ™‚ç¨‹']||[]).forEach(r => {
            const cbCode = safe(r['CBä»£è™Ÿ']);
            if(cbCode) {
                cbTimeline[cbCode] = {
                    boardDate: r['è‘£äº‹æœƒå…¬å‘Š'],
                    sendDate: r['é€ä»¶æ—¥æœŸ'],
                    effectDate: r['ç”Ÿæ•ˆæ—¥æœŸ'],
                    bidDate: safe(r['è©¢åœˆç«¶æ‹æ—¥æœŸ']),
                    payDate: r['ä»£æ”¶åƒ¹æ¬¾å…¬å‘Š'],
                    listDate: r['æ›ç‰Œæ—¥æœŸ'],
                    cbasDate: r['CBASæ‹†è§£æ—¥']
                };
            }
        });
        
        // è®€å– 03_ALLCBè³£å›æ¢ä»¶
        const cbPutback = {};
        XLSX.utils.sheet_to_json(wb.Sheets['03_ALLCBè³£å›æ¢ä»¶']||[]).forEach(r => {
            const cbCode = safe(r['CBä»£è™Ÿ']);
            if(cbCode) {
                cbPutback[cbCode] = {
                    putDate1: r['è³£å›æ—¥æœŸ1'],
                    putDate2: r['è³£å›æ—¥æœŸ2'],
                    putTiming: safe(r['æŠ•è³‡äººæå‰è³£å›']),
                    putCondition: safe(r['è³£å›æ¢ä»¶'])
                };
            }
        });
        
        // æ•´åˆåˆ° DB.cbAll
        Object.entries(cbBasicInfo).forEach(([cbCode, info]) => {
            const timeline = cbTimeline[cbCode] || {};
            const putback = cbPutback[cbCode] || {};
            DB.cbAll.push({
                '_cbCode': cbCode,
                '_stockCode': info.stockCode,
                '_name': info.name,
                '_industry': info.industry,
                '_method': info.method,
                '_guarantee': info.guarantee,
                '_rating': info.rating,
                '_issuer': info.issuer,
                '_scale': info.scale,
                '_convPrice': info.convPrice,
                '_years': info.years,
                '_issuePrice': info.issuePrice,
                '_expPrice': info.expPrice,
                '_premium': info.premium,
                '_position': info.position,
                '_capital': info.capital,
                '_listDate': info.listDate,
                '_expDate': info.expDate,
                '_high': info.high,
                '_low': info.low,
                // æ™‚ç¨‹è³‡è¨Š
                '_boardDate': timeline.boardDate,
                '_sendDate': timeline.sendDate,
                '_effectDate': timeline.effectDate,
                '_bidDate': timeline.bidDate,
                '_payDate': timeline.payDate,
                '_cbasDate': timeline.cbasDate,
                // è³£å›æ¢ä»¶
                '_putDate1': putback.putDate1,
                '_putDate2': putback.putDate2,
                '_putTiming': putback.putTiming,
                '_putCondition': putback.putCondition
            });
        });
        console.log('CBåŸºæœ¬è³‡æ–™è¼‰å…¥:', DB.cbAll.length, 'ç­†');
        
        // æå‰è³£å›ï¼šæœªä¾†3å€‹æœˆå…§å¯æå‰è³£å›çš„CB
        const today = new Date();
        const threeMonthsLater = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);
        
        DB.cbAll.forEach(cb => {
            const date1 = cb._putDate1 ? getDateVal(cb._putDate1) : 0;
            const date2 = cb._putDate2 ? getDateVal(cb._putDate2) : 0;
            
            // æª¢æŸ¥æ˜¯å¦åœ¨æœªä¾†3å€‹æœˆå…§
            const isUpcoming1 = date1 > today.getTime() && date1 <= threeMonthsLater.getTime();
            const isUpcoming2 = date2 > today.getTime() && date2 <= threeMonthsLater.getTime();
            
            if(isUpcoming1 || isUpcoming2) {
                DB.cbPutback.push({
                    ...cb,
                    '_nearestDate': isUpcoming1 ? cb._putDate1 : cb._putDate2,
                    '_isDate1': isUpcoming1
                });
            }
        });
        META.cbPutbackStats.total = DB.cbPutback.length;
        console.log('æå‰è³£å›ï¼ˆæœªä¾†3å€‹æœˆï¼‰:', DB.cbPutback.length, 'ç­†');
        
        // å»ºç«‹æ­·å²CBè³‡æ–™åº«ï¼ˆå…ˆæ”¾å…¨éƒ¨ï¼Œå¾Œé¢æœƒæ’é™¤æ›ç‰Œä¸­çš„ï¼‰
        // éæ¿¾æ‰æ›ç‰Œæœ€é«˜æˆ–æœ€ä½ç‚º 0 çš„è³‡æ–™
        Object.entries(cbBasicInfo).forEach(([cbCode, info]) => {
            const high = info.high;
            const low = info.low;
            // åªåŠ å…¥æœ‰æ•ˆè³‡æ–™ï¼ˆhigh å’Œ low éƒ½ä¸ç‚º 0ï¼‰
            if(high > 0 && low > 0) {
                DB.cbHistory.push({
                    '_cbCode': cbCode,
                    '_stockCode': info.stockCode,
                    '_name': info.name,
                    '_industry': info.industry,
                    '_method': info.method,
                    '_guarantee': info.guarantee,
                    '_high': high,
                    '_low': low,
                    '_range': (high - low) / low * 100,
                    'è½‰æ›åƒ¹æ ¼(å…ƒ)': info.convPrice,
                    'åˆ°æœŸæ—¥': info.expDate,
                    'æ›ç‰Œæ—¥æœŸ': info.listDate,
                    'ç™¼è¡Œè¦æ¨¡': info.scale,
                    'ç™¼è¡Œåˆ¸å•†': info.issuer
                });
            }
        });
        
        // æ—¥è¡Œæƒ… (æœ‰ç”¢æ¥­è³‡è¨Š) - å…ˆè®€å–å»ºç«‹ç”¢æ¥­å°ç…§
        const dailyMap = {};
        XLSX.utils.sheet_to_json(wb.Sheets['09_æœ€æ–°å‹•æ…‹æ¯é€±æ—¥è¡Œæƒ…']||[]).forEach(r => {
            const code = safe(r['ä»£ç¢¼']);
            const name = safe(Object.values(r)[1]);
            const ind = getSimpleIndustry(safe(r['ç”¢æ¥­']));
            
            if(code) {
                dailyMap[code] = {
                    name: name,
                    industry: ind,
                    cbPrice: r['CBæ”¶ç›¤åƒ¹'],
                    stockPrice: r['è‚¡åƒ¹'],
                    convPrice: r['è½‰æ›åƒ¹æ ¼'],
                    convValue: r['è½‰æ›åƒ¹å€¼'],
                    premium: r['æº¢(æŠ˜)åƒ¹%'],
                    expDate: r['åˆ°æœŸæ—¥']
                };
            }
        });
        
        // æ›ç‰Œä¸­ CB - åˆä½µæ—¥è¡Œæƒ…è³‡æ–™å’Œæ›ç‰Œé«˜ä½
        const activeCbCodes = new Set();
        META.cbStats.industries = {}; // é‡ç½®ç”¢æ¥­çµ±è¨ˆ
        
        XLSX.utils.sheet_to_json(wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™']||[]).forEach(r => {
            const cbCode = safe(r['ä»£è™Ÿ']);
            const stockCode = normalizeCode(r['è½‰æ›æ¨™çš„ä»£ç¢¼']);
            const daily = dailyMap[cbCode] || {};
            const hl = cbHighLow[cbCode] || {};
            const basic = cbBasicInfo[cbCode] || {};
            
            activeCbCodes.add(cbCode); // è¨˜éŒ„æ›ç‰Œä¸­çš„ä»£è™Ÿ
            
            // ç”¢æ¥­å„ªå…ˆä½¿ç”¨ 01 å·¥ä½œè¡¨çš„è³‡æ–™ï¼ˆå·²è½‰æ›ç‚ºç°¡æ½”åç¨±ï¼‰
            const industry = basic.industry || daily.industry || 'å…¶ä»–';
            
            const cbData = {
                ...r,
                '_stockCode': stockCode,
                '_cbCode': cbCode,
                '_name': safe(r['åç¨±']),
                '_stockName': safe(r['è½‰æ›æ¨™çš„åç¨±']),
                '_industry': industry,
                '_cbPrice': daily.cbPrice,
                '_stockPrice': daily.stockPrice,
                '_convValue': daily.convValue,
                '_premium': daily.premium,
                '_high': hl.high || 0,
                '_low': hl.low || 0,
                '_range': hl.range || 0,
                '_method': basic.method || '',      // è©¢åœˆ or ç«¶æ‹
                '_guarantee': basic.guarantee || '' // æœ‰æ“”ä¿ or ç„¡æ“”ä¿
            };
            
            DB.cb.push(cbData);
            if(stockCode) { 
                if(!META.cbMap[stockCode]) META.cbMap[stockCode]=[]; 
                META.cbMap[stockCode].push(cbData); 
            }
            // çµ±è¨ˆç”¢æ¥­
            if(industry) {
                META.cbStats.industries[industry] = (META.cbStats.industries[industry] || 0) + 1;
            }
        });
        
        // å¾æ­·å² CB ä¸­æ’é™¤æ›ç‰Œä¸­çš„
        DB.cbHistory = DB.cbHistory.filter(c => !activeCbCodes.has(c._cbCode));
        
        // è®€å– 04_æ‰€æœ‰CBç«¶æ‹è³‡æ–™åº«
        XLSX.utils.sheet_to_json(wb.Sheets['04_æ‰€æœ‰CBç«¶æ‹è³‡æ–™åº«']||[]).forEach(r => {
            const cbCode = safe(r['CBä»£è™Ÿ']);
            if(!cbCode) return; // è·³éç©ºè³‡æ–™
            
            // å„ªå…ˆä½¿ç”¨ 00 å·¥ä½œè¡¨çš„æ›ç‰Œé«˜ä½ï¼Œè‹¥ç„¡å‰‡ç”¨ 04 å·¥ä½œè¡¨çš„
            const hl = cbHighLow[cbCode] || {};
            const high = hl.high || parseFloat(r['æ›ç‰Œæœ€é«˜']) || 0;
            const low = hl.low || parseFloat(r['æ›ç‰Œæœ€ä½']) || 0;
            // æœ€æ–°æ”¶ç›¤å¾ 09 å·¥ä½œè¡¨å–å¾—
            const latestPrice = cbLatestPrice[cbCode] || 0;
            
            DB.cbAuction.push({
                '_cbCode': cbCode,
                '_stockCode': normalizeCode(r['è‚¡ç¥¨ä»£è™Ÿ']),
                '_name': safe(r['åç¨±']),
                '_industry': getSimpleIndustry(safe(r['ç”¢æ¥­åˆ†é¡'])),
                '_guarantee': safe(r['æ“”ä¿']),
                '_high': high,
                '_low': low,
                '_latestPrice': latestPrice,
                '_range': low > 0 ? (high - low) / low * 100 : 0,
                'é–‹æ¨™æ—¥æœŸ': r['é–‹æ¨™æ—¥æœŸ'],
                'æˆªæ¨™æ—¥': r['æˆªæ¨™æ—¥'],
                'ç™¼è¡Œè¦æ¨¡': r['ç™¼è¡Œè¦æ¨¡'],
                'ç«¶æ‹å¼µæ•¸': r['ç«¶æ‹å¼µæ•¸'],
                'åº•æ¨™åƒ¹': r['åº•æ¨™åƒ¹'],
                'ç†è«–åƒ¹': r['ç†è«–åƒ¹'],
                'æœ€ä½å¾—æ¨™': r['æœ€ä½å¾—æ¨™'],
                'æœ€ä½æº¢åƒ¹': r['æœ€ä½æº¢åƒ¹'],
                'å¹³å‡å¾—æ¨™': r['å¹³å‡å¾—æ¨™'],
                'å¹³å‡æº¢åƒ¹': r['å¹³å‡æº¢åƒ¹'],
                'æŠ•æ¨™å€æ•¸': r['æŠ•æ¨™å€æ•¸'],
                'åˆæ ¼ä»¶æ•¸': r['åˆæ ¼ä»¶æ•¸'],
                'ç™¼è¡Œåˆ¸å•†': safe(r['ç™¼è¡Œåˆ¸å•†']),
                'è½‰æ›åƒ¹': r['è½‰æ›åƒ¹'],
                'è¨‚åƒ¹æº¢åƒ¹ç‡': r['è¨‚åƒ¹æº¢åƒ¹ç‡']
            });
        });
        
        // è®€å– 06_ç™¼è¡Œæ¡ˆä»¶ (æ‰¿éŠ·ä¸­)
        XLSX.utils.sheet_to_json(wb.Sheets['06_ç™¼è¡Œæ¡ˆä»¶']||[]).forEach(r => {
            DB.cbPrimary.push({
                '_stockCode': normalizeCode(r['è‚¡ç¥¨ä»£è™Ÿ']),
                '_cbCode': safe(r['æ¨™çš„ä»£è™Ÿ']),
                '_name': safe(r['ç™¼è¡Œæ¨™çš„']),
                '_method': safe(r['è©¢åœˆ/ç«¶æ‹']),
                '_tcri': safe(r['TCRI/æ“”ä¿']),
                '_amount': r['ç™¼è¡Œé‡'],
                '_broker': safe(r['ç™¼è¡Œåˆ¸å•†']),
                '_sendDate': r['é€ä»¶æ—¥'],
                '_effectDate': r['ç”Ÿæ•ˆæ—¥'],
                '_bidPeriod': safe(r['è©¢åœˆ/æŠ•æ¨™æœŸé–“']),
                '_premium': r['æº¢åƒ¹ç‡'],
                '_convPrice': r['è½‰æ›åƒ¹'],
                '_listDate': r['æ›ç‰Œæ—¥'],
                '_optionDate': r['å¯æ‹†è§£é¸æ“‡æ¬Šæ—¥'],
                '_price': r['æ‰¿éŠ·åƒ¹æ ¼'],
                '_years': r['å¹´æœŸ'],
                '_putback': safe(r['è³£å›æ¢ä»¶']),
                '_capital': r['è‚¡æœ¬'],
                '_stockPrice': r['è‚¡åƒ¹'],
                '_volatility': r['60å¤©æ³¢å‹•ç‡']
            });
        });
        META.cbPrimaryStats.underwriting = DB.cbPrimary.length;
        
        // è®€å– 07_è‘£äº‹æœƒæ±ºè­°
        XLSX.utils.sheet_to_json(wb.Sheets['07_è‘£äº‹æœƒæ±ºè­°']||[]).forEach(r => {
            DB.cbBoard.push({
                '_stockCode': normalizeCode(r['è‚¡é°¾ä»£è™Ÿ'] || r['è‚¡ç¥¨ä»£è™Ÿ']),
                '_cbCode': safe(r['CBä»£ç¢¼']),
                '_name': safe(r['ç™¼è¡Œæ¨™çš„']),
                '_method': safe(r['è©¢åœˆ/ç«¶åƒ¹']),
                '_tcri': safe(r['TCRI/æ“”ä¿']),
                '_amount': r['ç™¼è¡Œé‡'],
                '_broker': safe(r['ä¸»è¾¦åˆ¸å•†']),
                '_maturity': safe(r['åˆ°æœŸæ—¥']),
                '_boardDate': r['è‘£äº‹æœƒé€šé'],
                '_capital': r['è‚¡æœ¬(å„„)'],
                '_note': safe(r['å‚™è¨»'])
            });
        });
        META.cbPrimaryStats.board = DB.cbBoard.length;
        
        // è®€å– 10_æœ€æ–°å‹•æ…‹æ¯é€±é¤˜é¡è¡¨
        XLSX.utils.sheet_to_json(wb.Sheets['10_æœ€æ–°å‹•æ…‹æ¯é€±é¤˜é¡è¡¨']||[]).forEach(r => {
            DB.cbBalance.push({
                '_cbCode': safe(r['è­‰åˆ¸ä»£è™Ÿ']),
                '_name': safe(r['è­‰åˆ¸åç¨±']),
                '_thisWeek': r['æœ¬é€±è‚¡é¡'],
                '_lastWeek': r['ä¸Šé€±è‚¡é¡'],
                '_change': r['å¢æ¸›æ•¸é¡'],
                '_changeRate': r['å¢æ¸›æ¯”ç‡'],
                '_remainRate': r['ç™¼è¡Œæ¯”ç‡(å‰©é¤˜æ¯”ç‡)']
            });
        });
        META.cbBalanceStats.total = DB.cbBalance.length;
        
        // è®€å– 11_æœ€æ–°å‹•æ…‹CBASå ±åƒ¹è¡¨
        XLSX.utils.sheet_to_json(wb.Sheets['11_æœ€æ–°å‹•æ…‹CBASå ±åƒ¹è¡¨']||[]).forEach(r => {
            const tcriVal = safe(r['æ“”ä¿éŠ€è¡Œ/ä¿¡ç”¨è©•ç­‰(TCRI)']);
            // åˆ¤æ–·æ“”ä¿ï¼šå¦‚æœæ˜¯ç´”æ•¸å­—æˆ–å«æ•¸å­—çš„è©•ç­‰(å¦‚ twA+)å‰‡ç„¡æ“”ä¿ï¼Œæœ‰éŠ€è¡Œåç¨±å‰‡æœ‰æ“”ä¿
            const isGuaranteed = tcriVal && !/^\d+$/.test(tcriVal) && /éŠ€|å•†éŠ€|åˆåº«/.test(tcriVal);
            
            DB.cbCBAS.push({
                '_name': safe(r['å¯è½‰å‚µåç¨±']),
                '_cbCode': safe(r['å¯è½‰å‚µä»£ç¢¼']),
                '_tcri': tcriVal,
                '_guarantee': isGuaranteed ? 'æœ‰' : 'ç„¡',
                '_premium': r['æ¬Šåˆ©é‡‘(ä½°å…ƒå ±åƒ¹)'],
                '_optExpiry': r['é¸æ“‡æ¬Šåˆ°æœŸæ—¥'],
                '_putPrice': r['è³£å›åƒ¹æ ¼(A)'],
                '_putDate': r['è³£å›æ—¥æœŸ(B)'],
                '_remainYears': r['å‰©é¤˜å¹´æœŸ'],
                '_discountRate': r['æŠ˜ç¾ç‡(C)'],
                '_premiumRef': r['æ¬Šåˆ©é‡‘åƒè€ƒåƒ¹'],
                '_stockPrice': r['ç¾è‚¡åƒè€ƒåƒ¹'],
                '_convPrice': r['è½‰æ›åƒ¹æ ¼'],
                '_convValue': r['CBè½‰æ›åƒ¹å€¼'],
                '_cbPrice': r['CBåƒè€ƒåƒ¹'],
                '_premiumPct': r['æº¢(æŠ˜)åƒ¹%'],
                '_vol120': r['è‚¡åƒ¹æ³¢å‹•ç‡120å¤©%'],
                '_vol240': r['è‚¡åƒ¹æ³¢å‹•ç‡240å¤©%'],
                '_remainPct': r['æµé€šé¤˜é¡å ç™¼è¡Œç¸½é¡%'],
                '_origAmount': r['åŸå§‹ç™¼è¡Œé‡'],
                '_industry': safe(r['ç”¢æ¥­'])
            });
        });
        META.cbCBASStats.total = DB.cbCBAS.length;
        
        // è®€å– 12_å…¬å¸åŸ·è¡Œè´–å›æ¬Š
        XLSX.utils.sheet_to_json(wb.Sheets['12_å…¬å¸åŸ·è¡Œè´–å›æ¬Š']||[]).forEach(r => {
            const subject = safe(r['ä¸»æ—¨']);
            // å¾ä¸»æ—¨è§£æçµ‚æ­¢æ«ƒæª¯è²·è³£æ—¥æœŸ
            const endMatch = subject.match(/(\d{3})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥çµ‚æ­¢æ«ƒæª¯è²·è³£/);
            let endDate = '';
            if(endMatch) {
                const year = parseInt(endMatch[1]) + 1911;
                endDate = `${year}/${endMatch[2].padStart(2,'0')}/${endMatch[3].padStart(2,'0')}`;
            }
            // å¾ä¸»æ—¨è§£æCBä»£è™Ÿ
            const cbMatch = subject.match(/ä»£ç¢¼[ï¼š:](\d+)/);
            const cbCode = cbMatch ? cbMatch[1] : '';
            // å¾ä¸»æ—¨è§£æCBç°¡ç¨±
            const cbNameMatch = subject.match(/ç°¡ç¨±[ï¼š:]([^ï¼Œ,]+)[ï¼Œ,]/);
            const cbName = cbNameMatch ? cbNameMatch[1] : '';
            
            // å–å¾— CB æ”¶ç›¤åƒ¹å’Œæ›ç‰Œé«˜ä½
            const daily = dailyMap[cbCode] || {};
            const hl = cbHighLow[cbCode] || {};
            
            DB.cbRedeem.push({
                '_stockCode': normalizeCode(r['å…¬å¸ä»£è™Ÿ']),
                '_name': safe(r['å…¬å¸åç¨±']),
                '_cbCode': cbCode,
                '_cbName': cbName,
                '_reportDate': safe(r['ç”³å ±æ—¥æœŸ']),
                '_endDate': endDate,
                '_cbPrice': daily.cbPrice || 0,
                '_high': hl.high || 0,
                '_low': hl.low || 0,
                '_subject': subject,
                '_asoExpiry': r['ASOåˆ°æœŸæ—¥']
            });
        });
        
        // è®€å– 13_åœæ­¢è½‰æ›è³‡è¨Š
        XLSX.utils.sheet_to_json(wb.Sheets['13_åœæ­¢è½‰æ›è³‡è¨Š']||[]).forEach(r => {
            DB.cbStopConv.push({
                '_cbCode': safe(r['å‚µåˆ¸ä»£ç¢¼']),
                '_name': safe(r['å‚µåˆ¸ç°¡ç¨±']),
                '_startDate': safe(r['åœæ­¢è½‰(äº¤)æ›èµ·æ—¥']),
                '_endDate': safe(r['åœæ­¢è½‰(äº¤)æ›è¿„æ—¥']),
                '_reason': safe(r['åœæ­¢è½‰(äº¤)æ›äº‹ç”±'])
            });
        });
        
        // è®€å– 14_è½‰æ›åƒ¹æ ¼èª¿æ•´
        XLSX.utils.sheet_to_json(wb.Sheets['14_è½‰æ›åƒ¹æ ¼èª¿æ•´']||[]).forEach(r => {
            const subject = safe(r['ä¸»æ—¨']);
            
            // è§£æèª¿æ•´æ—¥æœŸ
            const dateMatch = subject.match(/è‡ª(\d{3})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥èµ·/);
            let adjDate = '';
            if(dateMatch) {
                const year = parseInt(dateMatch[1]) + 1911;
                adjDate = `${year}/${dateMatch[2].padStart(2,'0')}/${dateMatch[3].padStart(2,'0')}`;
            }
            
            // è§£æåŸå§‹åƒ¹æ ¼å’Œèª¿æ•´å¾Œåƒ¹æ ¼
            const priceMatch = subject.match(/è½‰æ›åƒ¹æ ¼è‡ª([\d.]+)å…ƒèª¿æ•´ç‚º([\d.]+)å…ƒ/);
            const origPrice = priceMatch ? priceMatch[1] : '';
            const newPrice = priceMatch ? priceMatch[2] : '';
            
            // è§£æ CB ä»£è™Ÿå’Œç°¡ç¨±
            const cbMatch = subject.match(/ä»£ç¢¼[ï¼š:](\d+)/);
            const cbCode = cbMatch ? cbMatch[1] : '';
            const nameMatch = subject.match(/ç°¡ç¨±[ï¼š:]([^ï¼Œ,]+)[ï¼Œ,]/);
            const cbName = nameMatch ? nameMatch[1] : '';
            
            DB.cbPriceAdj.push({
                '_stockCode': normalizeCode(r['å…¬å¸ä»£è™Ÿ']),
                '_name': safe(r['å…¬å¸åç¨±']),
                '_cbCode': cbCode,
                '_cbName': cbName,
                '_adjDate': adjDate,
                '_origPrice': origPrice,
                '_newPrice': newPrice,
                '_subject': subject
            });
        });
        
        // è¨ˆç®—çµ±è¨ˆ
        META.cbStats.total = DB.cb.length;
        META.cbStats.historyTotal = DB.cbHistory.length;
        META.cbStats.auctionTotal = DB.cbAuction.length;
        const companies = new Set();
        let totalBal = 0;
        DB.cb.forEach(c => {
            if(c['_stockCode']) companies.add(c['_stockCode']);
            const bal = parseFloat(c['æœ€æ–°é¤˜é¡(ç™¾è¬)']) || 0;
            totalBal += bal;
        });
        META.cbStats.companies = companies.size;
        META.cbStats.totalBalance = totalBal;
        
        console.log('CBè¼‰å…¥:', DB.cb.length, 'æ­·å²CB:', DB.cbHistory.length, 'ç«¶æ‹:', DB.cbAuction.length, 
                    'æ‰¿éŠ·ä¸­:', DB.cbPrimary.length, 'è‘£äº‹æœƒ:', DB.cbBoard.length, 
                    'é¤˜é¡:', DB.cbBalance.length, 'CBAS:', DB.cbCBAS.length,
                    'å¼·åˆ¶è´–å›:', DB.cbRedeem.length, 'åœæ­¢è½‰æ›:', DB.cbStopConv.length, 'åƒ¹æ ¼èª¿æ•´:', DB.cbPriceAdj.length,
                    'æå‰è³£å›:', DB.cbPutback.length);
    }

    // æ›´æ–°è¨ˆæ•¸
    $('c-news').innerText = DB.news.length;
    $('c-memo').innerText = DB.memo.length;
    $('c-reports').innerText = DB.reports.length;
    $('c-strategy').innerText = DB.strategy.length;
    $('c-stocks').innerText = Object.keys(DB.stocks).length;
    $('c-trends').innerText = DB.trends.length;
    $('c-cb').innerText = DB.cb.length;

    // ç¢ºä¿éš±è— loader
    setTimeout(() => { $('loader').classList.add('hidden'); }, 100);
    
    document.querySelectorAll('.db-tab').forEach(tab => {
        tab.onclick = () => {
            CURR_DB = tab.dataset.db;
            document.querySelectorAll('.db-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // é¡¯ç¤º/éš±è— CB å››åˆ—æ¨™ç±¤
            if(CURR_DB === 'cb') {
                $('cbTabsArea').style.display = 'block';
            } else {
                $('cbTabsArea').style.display = 'none';
            }
            
            renderList();
        };
    });
    
    // CB å››åˆ—æ¨™ç±¤é»æ“Šäº‹ä»¶
    document.querySelectorAll('.cb-main-tab').forEach(tab => {
        tab.onclick = () => {
            CB_MODE = tab.dataset.mode;
            document.querySelectorAll('.cb-main-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            $('search').value = '';
            renderList();
        };
    });
    
    renderList();
  } catch(e) {
    console.error('Init Error:', e);
    $('loader').classList.add('hidden');
    $('loadStatus').innerText = 'è¼‰å…¥ç™¼ç”ŸéŒ¯èª¤';
  }
}

// åˆ‡æ› CB æ¨¡å¼ï¼ˆä¿ç•™çµ¦çµ±è¨ˆå€ä½¿ç”¨ï¼‰
function setCbMode(mode) {
    CB_MODE = mode;
    $('search').value = '';
    
    // åŒæ­¥æ›´æ–°å››åˆ—æ¨™ç±¤çš„ active ç‹€æ…‹
    document.querySelectorAll('.cb-main-tab').forEach(tab => {
        if(tab.dataset.mode === mode) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });
    
    renderList();
}

// å…¶é¤˜ç¨‹å¼ç¢¼ç¹¼çºŒ...ï¼ˆç”±æ–¼å­—æ•¸é™åˆ¶ï¼Œæˆ‘å°‡åˆ†æ®µæä¾›ï¼‰
</script>
</body>
</html>
