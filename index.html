<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤ v11.7 (é™¤éŒ¯ç‰ˆ)</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #c96442; --bg: #f5f4ef; --text: #333; --gray: #666; --border: #e0e0e0; --link: #2980b9; --up: #e74c3c; --down: #27ae60; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; }
        .container { max-width: 800px; margin: 0 auto; padding: 12px; }
        @media(min-width: 1024px) { .container { max-width: 1400px; padding: 20px; } }
        @media(min-width: 1600px) { .container { max-width: 1600px; } }

        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #e0e0e0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .header { text-align: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .header h1 { color: var(--primary); font-size: 22px; margin-bottom: 5px; font-weight: 800; }
        .db-switcher { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin: 15px 0; }
        .db-tab { padding: 6px 14px; background: #fff; border: 1px solid var(--border); border-radius: 20px; font-size: 13px; color: var(--gray); cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
        .db-tab:hover { border-color: var(--primary); }
        .db-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .count { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 10px; font-size: 10px; }

        /* CB å››åˆ—æ¨™ç±¤å€ */
        #cbTabsArea { margin: 15px 0; }
        .cb-main-title { text-align: center; font-size: 18px; font-weight: 700; color: var(--primary); padding: 12px; background: linear-gradient(135deg, #fff5f0 0%, #fff 100%); border-radius: 12px; margin-bottom: 12px; border: 2px solid #ffe0d5; }
        .cb-tabs-container { display: flex; flex-direction: column; gap: 8px; }
        .cb-tabs-row { display: flex; justify-content: center; gap: 6px; flex-wrap: wrap; }
        .cb-main-tab { padding: 8px 16px; background: #fff; border: 1px solid var(--border); border-radius: 20px; font-size: 13px; color: var(--gray); cursor: pointer; transition: all 0.2s; font-weight: 600; }
        .cb-main-tab:hover { border-color: var(--primary); transform: translateY(-1px); box-shadow: 0 2px 8px rgba(201,100,66,0.2); }
        .cb-main-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }

        .search-box { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 35px 12px 40px; border-radius: 25px; border: 2px solid var(--border); background: #fff; font-size: 15px; outline: none; transition: border-color 0.2s; }
        .search-input:focus { border-color: var(--primary); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #999; }
        .clear-btn { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; background: #ccc; color: #fff; border-radius: 50%; font-size: 12px; line-height: 20px; text-align: center; cursor: pointer; display: none; }

        /* CB çµ±è¨ˆå€å¡Š */
        .cb-stats { background: #fff5f5; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #ffe0e0; }
        .cb-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .cb-stat-item { background: #fff; padding: 12px 8px; border-radius: 8px; text-align: center; }
        .cb-stat-num { font-size: 22px; font-weight: 800; color: var(--primary); }
        .cb-stat-label { font-size: 11px; color: #888; margin-top: 2px; }

        .card-list { display: flex; flex-direction: column; gap: 12px; }
        .result-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="loading-spinner"></div>
    <div style="font-weight:700;font-size:18px">Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</div>
    <div style="font-size:12px;color:#888;margin-top:8px" id="loadStatus">æ­£åœ¨è¼‰å…¥è³‡æ–™åº«...</div>
    <div style="font-size:11px;color:#999;margin-top:15px;max-width:400px;text-align:center" id="debugInfo">é™¤éŒ¯ç‰ˆæœ¬ - è«‹æŸ¥çœ‹ Console äº†è§£è©³ç´°è¼‰å…¥ç‹€æ…‹</div>
</div>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
        <p style="font-size:12px;color:#666">å…¨æ–¹ä½å°è‚¡æŠ•è³‡æ±ºç­–ç³»çµ± v11.7 (é™¤éŒ¯ç‰ˆ)</p>
    </div>

    <div class="db-switcher">
        <div class="db-tab active" data-db="news">âš¡ å¤–é›» <span class="count" id="c-news">0</span></div>
        <div class="db-tab" data-db="memo">ğŸ“‹ Memo <span class="count" id="c-memo">0</span></div>
        <div class="db-tab" data-db="cb">ğŸ« CB <span class="count" id="c-cb">0</span></div>
    </div>

    <!-- CB å°ˆå±¬å››åˆ—æ¨™ç±¤å€ -->
    <div id="cbTabsArea" style="display:none">
        <div class="cb-main-title">ğŸ« å¯è½‰å‚µå®Œæ•´è³‡è¨Š</div>
        <div class="cb-tabs-container">
            <!-- ç¬¬ä¸€åˆ— -->
            <div class="cb-tabs-row">
                <div class="cb-main-tab active" data-mode="info">ğŸ“‹ åŸºæœ¬è³‡æ–™</div>
                <div class="cb-main-tab" data-mode="history">ğŸ“œ æ­·å²é«˜ä½</div>
                <div class="cb-main-tab" data-mode="active">ğŸ« ç›®å‰æ›ç‰Œ</div>
            </div>
            <!-- ç¬¬äºŒåˆ— -->
            <div class="cb-tabs-row">
                <div class="cb-main-tab" data-mode="primary">ğŸ“ åˆç´šå¸‚å ´</div>
                <div class="cb-main-tab" data-mode="auction">ğŸ”¨ ç«¶æ‹è³‡è¨Š</div>
                <div class="cb-main-tab" data-mode="cbas">ğŸ’¹ CBASå ±åƒ¹</div>
            </div>
            <!-- ç¬¬ä¸‰åˆ— -->
            <div class="cb-tabs-row">
                <div class="cb-main-tab" data-mode="putback">ğŸ’° æå‰è³£å›</div>
                <div class="cb-main-tab" data-mode="redeem">ğŸ”” å¼·åˆ¶è´–å›</div>
                <div class="cb-main-tab" data-mode="stopconv">â¸ï¸ æš«åœè½‰æ›</div>
            </div>
            <!-- ç¬¬å››åˆ— -->
            <div class="cb-tabs-row">
                <div class="cb-main-tab" data-mode="balance">ğŸ“Š æµé€šé¤˜é¡</div>
                <div class="cb-main-tab" data-mode="price">ğŸ“ˆ åƒ¹æ ¼èµ°å‹¢</div>
                <div class="cb-main-tab" data-mode="concept">ğŸ’¡ æ¦‚å¿µè‚¡ç¥¨</div>
            </div>
        </div>
    </div>

    <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" class="search-input" id="search" placeholder="æœå°‹å…¬å¸ã€ä»£è™Ÿ...">
    </div>

    <div id="cbStatsArea" style="display:none"></div>

    <div class="result-bar">
        <div style="font-size:12px;color:#666;">æ‰¾åˆ° <b id="resCount" style="color:var(--primary)">0</b> ç­†è³‡æ–™</div>
    </div>
    <div class="card-list" id="list"></div>
</div>

<script>
console.log('===== ç¨‹å¼é–‹å§‹åŸ·è¡Œ =====');
console.log('ç€è¦½å™¨:', navigator.userAgent);
console.log('ç•¶å‰æ™‚é–“:', new Date().toLocaleString());

const FILES = {
    NEWS: '01_news.xlsx', 
    MEMO: '02_memo.xlsx', 
    CB: '00_CB.xlsx'
};

const DB = { 
    news:[], 
    memo:[], 
    cb:[], 
    cbAll:[], 
    cbPutback:[]
};

let CURR_DB = 'news';
let CB_MODE = 'info';

const $ = id => document.getElementById(id);
const safe = v => (v==null||v==undefined?'':String(v).trim());
const normalizeCode = v => {
    if(!v) return '';
    let s = String(v).trim();
    if(s.match(/^\d+\.0$/)) s = s.replace('.0', '');
    s = s.replace(/\s*TT$/i, '');
    if(s.match(/^\d{1,4}$/) && s.length < 4) s = s.padStart(4, '0');
    return s;
};

async function fetchXlsx(url) {
    const startTime = Date.now();
    console.log(`â³ é–‹å§‹è¼‰å…¥: ${url}`);
    
    try {
        $('loadStatus').innerText = `è¼‰å…¥ ${url}...`;
        const res = await fetch(url);
        
        if(!res.ok) {
            console.error(`âŒ HTTP éŒ¯èª¤: ${res.status} - ${url}`);
            throw new Error(`HTTP ${res.status}`);
        }
        
        const buffer = await res.arrayBuffer();
        console.log(`ğŸ“¦ æª”æ¡ˆå¤§å°: ${(buffer.byteLength / 1024).toFixed(2)} KB`);
        
        const wb = XLSX.read(buffer, {type:'array'});
        const elapsed = Date.now() - startTime;
        console.log(`âœ… è¼‰å…¥æˆåŠŸ: ${url} (${elapsed}ms)`);
        console.log(`   å·¥ä½œè¡¨æ•¸é‡: ${wb.SheetNames.length}`);
        console.log(`   å·¥ä½œè¡¨åç¨±:`, wb.SheetNames);
        
        return wb;
    } catch(e) {
        console.error(`âŒ è¼‰å…¥å¤±æ•—: ${url}`, e);
        $('debugInfo').innerHTML = `<span style="color:red">è¼‰å…¥ ${url} å¤±æ•—: ${e.message}</span>`;
        return null;
    }
}

async function init() {
    console.log('\n===== é–‹å§‹åˆå§‹åŒ– =====');
    console.log('1. æª¢æŸ¥ XLSX å‡½å¼åº«...');
    
    if(typeof XLSX === 'undefined') {
        console.error('âŒ XLSX å‡½å¼åº«æœªè¼‰å…¥ï¼');
        $('loadStatus').innerText = 'XLSX å‡½å¼åº«è¼‰å…¥å¤±æ•—';
        $('debugInfo').innerHTML = '<span style="color:red">XLSX å‡½å¼åº«æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š</span>';
        return;
    }
    
    console.log('âœ… XLSX ç‰ˆæœ¬:', XLSX.version);
    
    try {
        let wb;
        
        // æ¸¬è©¦è¼‰å…¥ News
        console.log('\n2. è¼‰å…¥ News...');
        wb = await fetchXlsx(FILES.NEWS);
        if(wb && wb.Sheets['å¤–é›»ç¶œåˆå ±å°']) {
            const rows = XLSX.utils.sheet_to_json(wb.Sheets['å¤–é›»ç¶œåˆå ±å°']||[]);
            DB.news = rows;
            console.log(`   News ç­†æ•¸: ${rows.length}`);
        }
        
        // æ¸¬è©¦è¼‰å…¥ CB
        console.log('\n3. è¼‰å…¥ CB...');
        wb = await fetchXlsx(FILES.CB);
        if(wb && wb.Sheets['01_ALLCBåŸºæœ¬è³‡æ–™']) {
            const rows = XLSX.utils.sheet_to_json(wb.Sheets['01_ALLCBåŸºæœ¬è³‡æ–™']||[]);
            rows.forEach(r => {
                const cbCode = safe(r['CBä»£è™Ÿ']);
                if(cbCode) {
                    DB.cbAll.push({
                        '_cbCode': cbCode,
                        '_name': safe(r['åç¨±']),
                        '_stockCode': normalizeCode(r['è‚¡ç¥¨ä»£è™Ÿ'])
                    });
                }
            });
            console.log(`   CB ç­†æ•¸: ${DB.cbAll.length}`);
        }
        
        // æ›´æ–°è¨ˆæ•¸
        $('c-news').innerText = DB.news.length;
        $('c-cb').innerText = DB.cbAll.length;
        
        console.log('\nâœ… åˆå§‹åŒ–å®Œæˆï¼');
        console.log('è³‡æ–™çµ±è¨ˆ:', {
            news: DB.news.length,
            cb: DB.cbAll.length
        });
        
        // éš±è— loader
        setTimeout(() => { 
            $('loader').classList.add('hidden'); 
            console.log('ğŸ‰ ç³»çµ±æº–å‚™å°±ç·’');
        }, 500);
        
        // è¨­å®šäº‹ä»¶ç›£è½
        setupEventListeners();
        renderList();
        
    } catch(e) {
        console.error('ğŸ’¥ åˆå§‹åŒ–éŒ¯èª¤:', e);
        $('loadStatus').innerText = 'åˆå§‹åŒ–ç™¼ç”ŸéŒ¯èª¤';
        $('debugInfo').innerHTML = `<span style="color:red">éŒ¯èª¤: ${e.message}</span>`;
    }
}

function setupEventListeners() {
    console.log('è¨­å®šäº‹ä»¶ç›£è½å™¨...');
    
    document.querySelectorAll('.db-tab').forEach(tab => {
        tab.onclick = () => {
            CURR_DB = tab.dataset.db;
            document.querySelectorAll('.db-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            if(CURR_DB === 'cb') {
                $('cbTabsArea').style.display = 'block';
            } else {
                $('cbTabsArea').style.display = 'none';
            }
            
            renderList();
        };
    });
    
    document.querySelectorAll('.cb-main-tab').forEach(tab => {
        tab.onclick = () => {
            CB_MODE = tab.dataset.mode;
            document.querySelectorAll('.cb-main-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            renderList();
        };
    });
}

function renderList() {
    console.log(`æ¸²æŸ“æ¸…å–®: ${CURR_DB}, CB_MODE: ${CB_MODE}`);
    
    let list = [];
    let html = '';
    
    if(CURR_DB === 'news') {
        list = DB.news;
        html = list.slice(0, 50).map(n => 
            `<div style="padding:12px;background:#fff;border-radius:8px;margin-bottom:8px">
                <div style="font-weight:700">${safe(n['å…¬å¸'])} ${normalizeCode(n['è‚¡è™Ÿ'])}</div>
                <div style="font-size:12px;color:#666;margin-top:4px">${safe(n['å®Œæ•´å ±å°å…§å®¹']).substring(0, 100)}...</div>
            </div>`
        ).join('');
    } else if(CURR_DB === 'cb') {
        list = DB.cbAll;
        html = list.slice(0, 50).map(c => 
            `<div style="padding:12px;background:#fff;border-radius:8px;margin-bottom:8px">
                <div style="font-weight:700">${c._name} (${c._cbCode})</div>
                <div style="font-size:12px;color:#666;margin-top:4px">è‚¡ç¥¨ä»£è™Ÿ: ${c._stockCode}</div>
            </div>`
        ).join('');
    }
    
    $('resCount').innerText = list.length;
    $('list').innerHTML = html || '<div style="text-align:center;padding:30px;color:#999">ç„¡è³‡æ–™</div>';
    
    console.log(`âœ… æ¸²æŸ“å®Œæˆ: ${list.length} ç­†`);
}

// å•Ÿå‹•
console.log('\n===== ç­‰å¾…é é¢è¼‰å…¥å®Œæˆ =====');
window.onload = () => {
    console.log('âœ… é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
    init();
};

console.log('===== ç¨‹å¼è¼‰å…¥å®Œæˆï¼Œç­‰å¾… window.onload =====\n');
</script>
</body>
</html>
