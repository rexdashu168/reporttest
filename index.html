<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RexÂ§ßÂèîÊäïË≥áÁ†îÁ©∂ÂÆ§ v11.6</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #c96442; --bg: #f5f4ef; --text: #333; --gray: #666; --border: #e0e0e0; --link: #2980b9; --up: #e74c3c; --down: #27ae60; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; }
        .container { max-width: 800px; margin: 0 auto; padding: 12px; }
        @media(min-width: 1024px) { .container { max-width: 1400px; padding: 20px; } }
        @media(min-width: 1600px) { .container { max-width: 1600px; } }

        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #e0e0e0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .header { text-align: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .header h1 { color: var(--primary); font-size: 22px; margin-bottom: 5px; font-weight: 800; }
        .db-switcher { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin: 15px 0; }
        .db-tab { padding: 6px 14px; background: #fff; border: 1px solid var(--border); border-radius: 20px; font-size: 13px; color: var(--gray); cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
        .db-tab:hover { border-color: var(--primary); }
        .db-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .count { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 10px; font-size: 10px; }

        .search-box { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 35px 12px 40px; border-radius: 25px; border: 2px solid var(--border); background: #fff; font-size: 15px; outline: none; transition: border-color 0.2s; }
        .search-input:focus { border-color: var(--primary); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #999; }
        .clear-btn { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; background: #ccc; color: #fff; border-radius: 50%; font-size: 12px; line-height: 20px; text-align: center; cursor: pointer; display: none; }

        /* CB Áµ±Ë®àÂçÄÂ°ä */
        .cb-stats { background: #fff5f5; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #ffe0e0; }
        
        /* CB Ê®°ÂºèÂ∞èÊñπÂ°ä */
        .cb-mode-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .cb-mode-block { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 8px 12px; text-align: center; cursor: pointer; transition: all 0.2s; min-width: 70px; }
        .cb-mode-block:hover { border-color: var(--primary); background: #fff8f5; }
        .cb-mode-block.active { background: var(--primary); border-color: var(--primary); }
        .cb-mode-block .icon { font-size: 16px; }
        .cb-mode-block .label { font-size: 11px; font-weight: 600; color: #555; margin-top: 2px; }
        .cb-mode-block.active .label { color: #fff; }
        .cb-mode-block .count { font-size: 10px; color: #999; }
        .cb-mode-block.active .count { color: rgba(255,255,255,0.8); }
        
        /* Â≠êÊ®ôÁ±§ÔºàÁôºË°åÊ¢ù‰ª∂„ÄÅÊôÇÁ®ãÁ≠âÔºâ */
        .cb-sub-grid { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .cb-sub-block { background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 6px 14px; text-align: center; cursor: pointer; transition: all 0.2s; font-size: 12px; font-weight: 600; color: #666; }
        .cb-sub-block:hover { border-color: #e67e22; color: #e67e22; }
        .cb-sub-block.active { background: #e67e22; color: #fff; border-color: #e67e22; }
        
        /* Áµ±Ë®àÊï∏Â≠óÂçÄ */
        .cb-stats-section { background: #fafafa; border-radius: 8px; padding: 12px; margin-bottom: 12px; border: 1px solid #eee; }
        .cb-stats-section .section-title { font-size: 12px; font-weight: 600; color: #888; margin-bottom: 10px; }
        .cb-stats-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .cb-stat-item { background: #fff; padding: 10px 12px; border-radius: 6px; text-align: center; border: 1px solid #eee; min-width: 70px; }
        .cb-stat-item.clickable { cursor: pointer; transition: all 0.2s; }
        .cb-stat-item.clickable:hover { border-color: var(--primary); background: #fff8f5; }
        .cb-stat-item.clickable.active { background: var(--primary); border-color: var(--primary); }
        .cb-stat-num { font-size: 18px; font-weight: 800; color: var(--primary); }
        .cb-stat-item.clickable.active .cb-stat-num { color: #fff; }
        .cb-stat-label { font-size: 10px; color: #888; margin-top: 2px; }
        .cb-stat-item.clickable.active .cb-stat-label { color: rgba(255,255,255,0.9); }
        
        /* Áî¢Ê•≠Â∞èÊñπÂ°ä */
        .cb-ind-section { background: #fafafa; border-radius: 8px; padding: 12px; margin-bottom: 12px; border: 1px solid #eee; }
        .cb-ind-title { font-size: 12px; font-weight: 600; color: #888; margin-bottom: 10px; }
        .cb-ind-grid { display: flex; flex-wrap: wrap; gap: 6px; }
        .cb-ind-block { background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; padding: 6px 10px; text-align: center; cursor: pointer; transition: all 0.2s; min-width: 60px; }
        .cb-ind-block:hover { border-color: var(--primary); background: #fff8f5; }
        .cb-ind-block.active { background: var(--primary); border-color: var(--primary); }
        .cb-ind-block .ind-name { font-size: 11px; font-weight: 600; color: #555; }
        .cb-ind-block.active .ind-name { color: #fff; }
        .cb-ind-block .ind-num { font-size: 13px; font-weight: 800; color: var(--primary); margin-top: 2px; }
        .cb-ind-block.active .ind-num { color: #fff; }
        
        /* ÁØ©ÈÅ∏ÁãÄÊÖãÂàó */
        .cb-filter-bar { background: #fff3e0; border: 1px solid #ffcc80; border-radius: 6px; padding: 8px 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .cb-filter-bar .filter-text { font-size: 12px; color: #e65100; font-weight: 600; }
        .cb-filter-bar .filter-clear { background: #e74c3c; border: none; border-radius: 4px; padding: 3px 10px; font-size: 11px; color: #fff; cursor: pointer; transition: all 0.2s; }
        .cb-filter-bar .filter-clear:hover { background: #c0392b; }
        
        /* ËàäÁöÑÊ®£Âºè‰øùÁïô */
        .cb-mode-switcher { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .cb-mode-tab { padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid #ddd; background: #fff; color: #666; transition: all 0.2s; }
        .cb-mode-tab:hover { border-color: var(--primary); }
        .cb-mode-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .cb-sub-switcher { display: flex; gap: 6px; margin-bottom: 12px; padding-left: 10px; }
        .cb-sub-tab { padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer; border: 1px solid #ccc; background: #f9f9f9; color: #666; transition: all 0.2s; }
        .cb-sub-tab:hover { border-color: #e67e22; }
        .cb-sub-tab.active { background: #e67e22; color: #fff; border-color: #e67e22; }
        .cb-ind-tag { padding: 6px 12px; background: #fff; border-radius: 20px; font-size: 12px; color: #666; cursor: pointer; transition: all 0.2s; border: 1px solid #eee; }
        .cb-ind-tag:hover { border-color: var(--primary); color: var(--primary); }
        .cb-ind-tag.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .cb-ind-tag .num { background: var(--primary); color: #fff; padding: 1px 6px; border-radius: 10px; font-size: 10px; margin-left: 4px; }
        .cb-ind-tag.active .num { background: rgba(255,255,255,0.3); }
        
        /* Á´∂ÊãçÂâçÂçÅÂêçË°®Ê†º */
        .auction-top10-table { overflow-x: auto; margin-bottom: 10px; }
        .auction-top10-table table { width: 100%; border-collapse: collapse; font-size: 12px; background: #fff; border-radius: 8px; overflow: hidden; }
        .auction-top10-table th { background: #f8f8f8; padding: 8px 6px; text-align: center; font-weight: 600; color: #555; border-bottom: 1px solid #eee; white-space: nowrap; }
        .auction-top10-table td { padding: 8px 6px; text-align: center; border-bottom: 1px solid #f5f5f5; }
        .auction-top10-table tr:hover { background: #fff8f0; }
        .auction-top10-table .code { color: var(--primary); font-weight: 600; }
        .auction-top10-table .highlight { color: var(--primary); font-weight: 700; }
        .auction-top10-table .highlight-red { color: #e74c3c; font-weight: 700; }
        
        /* ÊµÅÈÄöÈ§òÈ°çÂâçÂçÅÂêçË°®Ê†º */
        .balance-top10-table { overflow-x: auto; margin-bottom: 10px; }
        .balance-top10-table table { width: 100%; border-collapse: collapse; font-size: 12px; background: #fff; border-radius: 8px; overflow: hidden; }
        .balance-top10-table th { background: #f8f8f8; padding: 8px 4px; text-align: center; font-weight: 600; color: #555; border-bottom: 1px solid #eee; white-space: nowrap; font-size: 11px; }
        .balance-top10-table td { padding: 6px 4px; text-align: center; border-bottom: 1px solid #f5f5f5; font-size: 11px; }
        .balance-top10-table tr:hover { background: #fff8f0; }
        .balance-top10-table .code { color: var(--primary); font-weight: 600; }
        .balance-top10-table .name-cell { text-align: left; min-width: 80px; max-width: 120px; white-space: normal; line-height: 1.3; }
        .balance-top10-table .highlight-red { color: #e74c3c; font-weight: 700; }
        
        /* ÊµÅÈÄöÈ§òÈ°ç‰∏ªË°®Ê†ºÊ¨ÑÂØ¨Á∏ÆÊ∏õ */
        .cb-table.balance-table { font-size: 11px; }
        .cb-table.balance-table th, .cb-table.balance-table td { padding: 6px 4px; }
        .cb-table.balance-table .name-col { max-width: 90px; white-space: normal; line-height: 1.3; text-align: left; }
        
        /* ‰∏ªÊó®Ê¨Ñ‰Ωç */
        .cb-table .subject-col { text-align: left; font-size: 11px; line-height: 1.4; max-width: 300px; white-space: normal; }
        .cb-table .name-col { max-width: 100px; white-space: normal; line-height: 1.3; text-align: left; }

        .card-list { display: flex; flex-direction: column; gap: 12px; }
        @media(min-width: 1024px) { .card-list:not(.cb-mode) { display: grid; grid-template-columns: repeat(2, 1fr); } }
        @media(min-width: 1400px) { .card-list:not(.cb-mode) { grid-template-columns: repeat(3, 1fr); } }
        .card-list.cb-mode { display: block; }
        .card { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; transition: all 0.2s; }
        .card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .card.industry-card { border-left: 4px solid #9b59b6; background: linear-gradient(135deg, #faf8fc 0%, #fff 100%); }
        .card-head { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .card-title { font-weight: 700; font-size: 16px; color: #2c3e50; }
        .card-meta { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .tag { font-size: 11px; padding: 2px 8px; border-radius: 6px; color: #fff; font-weight: 500; }
        .tag.brk { background: var(--primary); }
        .tag.ind { background: #2980b9; }
        .tag.trend-ind { background: #8e44ad; }
        .tag.dt { background: #e0e0e0; color: #666; }
        .tag.concept { background: #8e44ad; }
        .tag.trend-up { background: #27ae60; }
        .tag.trend-down { background: #e74c3c; }
        .tag.cb-tag { background: #e74c3c; font-size: 10px; padding: 1px 6px; }
        .cb-tags { display: flex; gap: 3px; flex-wrap: wrap; margin-left: auto; }
        .card-head { display: flex; align-items: center; gap: 8px; }
        .news-type { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 6px; font-weight: 600; }
        .news-type.ind-type { background: #9b59b6; color: #fff; }
        
        /* CB Âü∫Êú¨Ë≥áÊñôÂ≠êÊ®ôÁ±§ */
        .cb-info-tabs { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
        .cb-table tr.active-cb td { background: #e8f5e9; }
        .cb-table tr.active-cb:hover td { background: #c8e6c9; }
        
        /* ÁµêÊûúÂàóÂíå CB ÁØ©ÈÅ∏Ê®ôÁ±§ */
        .result-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px; }
        .cb-filter-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .cb-filter-tag { font-size: 11px; padding: 4px 10px; border-radius: 15px; cursor: pointer; border: 1px solid #ddd; background: #fff; transition: all 0.2s; }
        .cb-filter-tag:hover { border-color: var(--primary); }
        .cb-filter-tag.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .cb-filter-tag .cnt { margin-left: 4px; opacity: 0.7; }
        .card-body { font-size: 13px; color: #555; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        /* CB ÂàóË°®Ë°®Ê†º */
        .cb-table-wrap { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .cb-table { width: 100%; border-collapse: collapse; font-size: 13px; background: #fff; border-radius: 8px; overflow: hidden; }
        .cb-table th { background: #f8f9fa; padding: 12px 8px; text-align: center; color: #666; font-weight: 600; border-bottom: 2px solid #eee; white-space: nowrap; }
        .cb-table td { padding: 10px 8px; border-bottom: 1px solid #f0f0f0; text-align: center; white-space: nowrap; }
        .cb-table tr:hover td { background: #fffaf8; }
        .cb-table .code { color: var(--primary); font-weight: 600; cursor: pointer; }
        .cb-table .stock { color: var(--link); cursor: pointer; }
        .cb-table th.sortable { cursor: pointer; user-select: none; }
        .cb-table th.sortable:hover { background: #eee; }
        .cb-table th .sort-icon { font-size: 10px; color: #999; margin-left: 2px; }
        .cb-table th.sort-asc .sort-icon { color: var(--primary); }
        .cb-table th.sort-desc .sort-icon { color: var(--primary); }
        .cb-table th.sort-asc .sort-icon::after { content: '‚Üë'; }
        .cb-table th.sort-desc .sort-icon::after { content: '‚Üì'; }
        .cb-table tfoot { background: #f8f9fa; }
        .cb-table tfoot td { border-top: 2px solid #ddd; padding: 12px 8px; }
        
        /* ÊâãÊ©üÁâàÈö±ËóèÈÉ®ÂàÜÊ¨Ñ‰Ωç */
        @media(max-width: 768px) {
            .cb-table { font-size: 12px; }
            .cb-table th, .cb-table td { padding: 8px 5px; }
            .cb-table .hide-mobile { display: none; }
        }
        
        /* Ê°åÊ©üÁâàÊªøÁâà */
        @media(min-width: 1024px) {
            .cb-table { font-size: 14px; }
            .cb-table th, .cb-table td { padding: 12px 10px; }
        }

        /* Modal */
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-inner { background: #fff; width: 100%; max-width: 650px; height: 92vh; border-radius: 16px 16px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        @media(min-width: 1024px) { .modal-inner { max-width: 900px; } }
        @media(min-width: 1400px) { .modal-inner { max-width: 1100px; } }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        
        .m-head { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: flex-start; }
        .m-close { width: 32px; height: 32px; border-radius: 50%; border: none; background: #f0f0f0; font-size: 20px; color: #666; cursor: pointer; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .m-close:hover { background: #e0e0e0; }
        
        .nav-grid { display: flex; gap: 4px; padding: 10px 15px; background: #fafafa; border-bottom: 1px solid #eee; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .nav-btn { padding: 6px 10px; border-radius: 8px; border: none; background: #f0f0f0; font-size: 11px; font-weight: 600; color: #666; cursor: pointer; white-space: nowrap; transition: all 0.2s; flex-shrink: 0; }
        .nav-btn.active { background: var(--primary); color: #fff; }

        .m-body { flex: 1; overflow-y: auto; padding: 15px; background: #fff; -webkit-overflow-scrolling: touch; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        
        .m-footer-tags { padding: 12px 15px; border-top: 1px solid #eee; background: #fafafa; display: none; }
        .m-footer-tags.show { display: block; }
        .m-footer-tags .tags-wrap { display: flex; flex-wrap: wrap; gap: 6px; }
        .m-footer-tags .tag { padding: 6px 12px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .m-footer-tags .tag:hover { transform: scale(1.05); }

        .section-head { font-size: 14px; font-weight: 700; color: #444; margin: 20px 0 10px; padding: 8px 12px; background: linear-gradient(90deg, #f8f9fa, transparent); border-left: 4px solid var(--primary); border-radius: 0 8px 8px 0; }
        .section-head:first-child { margin-top: 0; }
        .hl-block { background: #fafaf8; padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary); margin-bottom: 10px; font-size: 13px; line-height: 1.7; white-space: pre-wrap; }
        .hl-block b { color: var(--primary); }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .info-label { color: #666; }
        .info-val { font-weight: 600; color: #333; }
        
        .list-item { padding: 12px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 8px; background: #fff; cursor: pointer; transition: all 0.2s; }
        .list-item:hover { border-color: var(--primary); background: #fffaf8; }
        .list-title { font-weight: 700; font-size: 14px; color: #2c3e50; margin-bottom: 4px; }
        .list-sub { font-size: 12px; color: #888; margin-bottom: 6px; }
        .list-content { font-size: 13px; color: #555; line-height: 1.6; white-space: pre-wrap; }

        .tag-link { color: var(--link); cursor: pointer; font-weight: 600; }
        .tag-link:hover { text-decoration: underline; }
        
        .fin-switcher { display: flex; margin-bottom: 10px; border: 1px solid var(--primary); border-radius: 6px; overflow: hidden; }
        .fin-btn { flex: 1; padding: 8px; text-align: center; font-size: 13px; color: var(--primary); background: #fff; cursor: pointer; font-weight: 600; border-right: 1px solid var(--primary); transition: all 0.2s; }
        .fin-btn:last-child { border-right: none; }
        .fin-btn.active { background: var(--primary); color: #fff; }
        .fin-sub-pane { display: none; }
        .fin-sub-pane.active { display: block; }
        
        .rev-unit { text-align: right; font-size: 11px; color: #888; margin-bottom: 8px; }

        .table-wrap { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .fin-table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
        .fin-table th { background: #f8f9fa; padding: 10px 8px; border-bottom: 2px solid #ddd; text-align: right; color: #555; position: sticky; top: 0; }
        .fin-table td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: right; color: #333; }
        .fin-table th:first-child, .fin-table td:first-child { position: sticky; left: 0; background: #fff; border-right: 1px solid #eee; text-align: left; z-index: 2; font-weight: 700; }
        .fin-table tr:nth-child(even) td { background: #fcfcfc; }
        .fin-table tr:nth-child(even) td:first-child { background: #fcfcfc; }
        .fin-table .highlight-row td { background: #fff3e0; font-weight: 700; }
        .fin-table .highlight-row td:first-child { background: #fff3e0; color: var(--primary); }
        
        .t-up { color: var(--up); font-weight: 700; }
        .t-down { color: var(--down); font-weight: 700; }

        .rating-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .rating-card .big-num { font-size: 28px; font-weight: 800; }
        .rating-card .label { font-size: 12px; opacity: 0.8; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #f8f9fa; padding: 12px; text-align: center; border-radius: 8px; }
        .stat-box .num { font-size: 18px; font-weight: 700; color: var(--primary); }
        .stat-box .lbl { font-size: 11px; color: #888; margin-top: 2px; }

        .qa-item { margin-bottom: 15px; }
        .qa-q { background: #e3f2fd; padding: 10px 12px; border-radius: 8px 8px 0 0; font-weight: 600; color: #1565c0; font-size: 13px; }
        .qa-a { background: #f5f5f5; padding: 10px 12px; border-radius: 0 0 8px 8px; font-size: 13px; line-height: 1.6; color: #444; }

        .timeline-item { position: relative; padding-left: 20px; margin-bottom: 12px; }
        .timeline-item::before { content: ''; position: absolute; left: 0; top: 8px; width: 10px; height: 10px; background: var(--primary); border-radius: 50%; }
        .timeline-item::after { content: ''; position: absolute; left: 4px; top: 20px; width: 2px; height: calc(100% + 4px); background: #e0e0e0; }
        .timeline-item:last-child::after { display: none; }
        .timeline-date { font-size: 12px; font-weight: 700; color: var(--primary); }
        .timeline-text { font-size: 13px; color: #444; margin-top: 2px; }

        @media(min-width: 768px) { .modal { align-items: center; } .modal-inner { height: 85vh; border-radius: 16px; } }
        @media(max-width: 480px) { .cb-stats-grid { grid-template-columns: repeat(3, 1fr); } .cb-stat-num { font-size: 18px; } }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="loading-spinner"></div>
    <div style="font-weight:700;font-size:18px">RexÂ§ßÂèîÊäïË≥áÁ†îÁ©∂ÂÆ§</div>
    <div style="font-size:12px;color:#888;margin-top:8px" id="loadStatus">Ê≠£Âú®ËºâÂÖ•Ë≥áÊñôÂ∫´...</div>
</div>

<div class="container">
    <div class="header">
        <h1>üìä RexÂ§ßÂèîÊäïË≥áÁ†îÁ©∂ÂÆ§</h1>
        <p style="font-size:12px;color:#666">ÂÖ®Êñπ‰ΩçÂè∞ËÇ°ÊäïË≥áÊ±∫Á≠ñÁ≥ªÁµ± v11.6</p>
    </div>

    <div class="db-switcher">
        <div class="db-tab active" data-db="news">‚ö° Â§ñÈõª <span class="count" id="c-news">0</span></div>
        <div class="db-tab" data-db="memo">üìã Memo <span class="count" id="c-memo">0</span></div>
        <div class="db-tab" data-db="reports">üìë Áî¢Ê•≠ <span class="count" id="c-reports">0</span></div>
        <div class="db-tab" data-db="strategy">üîÆ Â±ïÊúõ <span class="count" id="c-strategy">0</span></div>
        <div class="db-tab" data-db="stocks">üè¢ ÂÄãËÇ° <span class="count" id="c-stocks">0</span></div>
        <div class="db-tab" data-db="trends">üìà Ë∂®Âã¢ <span class="count" id="c-trends">0</span></div>
        <div class="db-tab" data-db="cb">üé´ CB <span class="count" id="c-cb">0</span></div>
    </div>

    <div class="search-box">
        <span class="search-icon">üîç</span>
        <input type="text" class="search-input" id="search" placeholder="ÊêúÂ∞ãÂÖ¨Âè∏„ÄÅ‰ª£Ëôü„ÄÅÁî¢Ê•≠„ÄÅ#Tag..." oninput="handleInput(this)">
        <div class="clear-btn" id="clearBtn" onclick="clearSearch()">‚úï</div>
    </div>

    <!-- CB Áµ±Ë®àÂçÄÂ°ä (Âè™Âú® CB ÂàÜÈ†ÅÈ°ØÁ§∫) -->
    <div id="cbStatsArea" style="display:none"></div>
    
    <!-- ÂÄãËÇ°Áµ±Ë®àÂçÄÂ°ä (Âè™Âú®ÂÄãËÇ°ÂàÜÈ†ÅÈ°ØÁ§∫) -->
    <div id="stockStatsArea" style="display:none"></div>
    
    <!-- Memo Áµ±Ë®àÂçÄÂ°ä (Âè™Âú® Memo ÂàÜÈ†ÅÈ°ØÁ§∫) -->
    <div id="memoStatsArea" style="display:none"></div>

    <div class="result-bar">
        <div style="font-size:12px;color:#666;">ÊâæÂà∞ <b id="resCount" style="color:var(--primary)">0</b> Á≠ÜË≥áÊñô</div>
        <div id="cbFilterTags" class="cb-filter-tags" style="display:none"></div>
    </div>
    <div class="card-list" id="list"></div>
</div>

<div class="modal" id="modal" onclick="closeModal(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">
        <div class="m-head">
            <div id="m-info" style="flex:1"></div>
            <button class="m-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="nav-grid" id="navGrid"></div>
        <div class="m-body" id="m-body"></div>
        <div class="m-footer-tags" id="m-tags"></div>
    </div>
</div>

<script>
const FILES = {
    NEWS: '01_news.xlsx', MEMO: '02_memo.xlsx', REPORTS: '03_reports.xlsx',
    MASTER: '04_master.xlsx', STRAT: '05_Strategy_01.xlsx', CB: '00_CB.xlsx', REV: '06_revenue.xlsx'
};

const DB = { 
    news:[], memo:[], memoStock:[], memoIndustry:[], reports:[], strategy:[], stocks:{}, 
    cb:[], cbHistory:[], cbAuction:[], cbPrimary:[], cbBoard:[], cbBalance:[], cbCBAS:[],
    cbRedeem:[], cbStopConv:[], cbPriceAdj:[], cbConcept:[], cbAll:[],
    conceptLists: {}, // ÂêÑÊ¶ÇÂøµËÇ°Ê∏ÖÂñÆ { 'NVDIAÊ¶ÇÂøµËÇ°': ['6579','2353',...], ... }
    trends:[], conceptStocks:[] 
};
let CB_MODE = 'info'; // 'info' Âü∫Êú¨Ë≥áÊñô, 'active' ÊéõÁâå‰∏≠, 'history' Ê≠∑Âè≤, 'auction' Á´∂Êãç, 'primary' ÂàùÁ¥öÂ∏ÇÂ†¥, 'balance' ÊµÅÈÄöÈ§òÈ°ç, 'cbas' CBASÂ†±ÂÉπ
let CB_INFO_TAB = 'issue'; // 'issue' ÁôºË°åÊ¢ù‰ª∂, 'timeline' ÊôÇÁ®ãË≥áË®ä, 'putback' Ë≥£ÂõûÊ¢ù‰ª∂
let PRIMARY_MODE = 'underwriting'; // 'underwriting' ÊâøÈä∑‰∏≠, 'board' Ëë£‰∫ãÊúÉÂÖ¨Âëä
let STOCK_MODE = 'all'; // 'all' ÂÖ®ÈÉ®ÂÄãËÇ°, 'concept' Ê¶ÇÂøµËÇ°
let MEMO_MODE = 'all'; // 'all' ÂÖ®ÈÉ®, 'stock' ÂÄãËÇ°, 'industry' Áî¢Ê•≠

// CB ‰∫§ÈõÜÁØ©ÈÅ∏ÁãÄÊÖã
let CB_FILTER = {
    industry: '',   // Áî¢Ê•≠ÁØ©ÈÅ∏
    guarantee: ''   // Êìî‰øùÁØ©ÈÅ∏ ('ÊúâÊìî‰øù' / 'ÁÑ°Êìî‰øù')
};
const META = { 
    memoDetail:{}, tracking:{}, finance:{}, products:{}, 
    concepts:{}, cbMap:{}, relatedNews:{}, relatedMemo:{},
    reportFocus:{}, reportViews:{}, reportRatings:{},
    stratMacro:{}, stratFundamental:{}, stratTheme:{}, stratChip:{}, stratTech:{}, stratQuarter:{}, stratPicks:{},
    revData: { month:{}, quarter:{}, year:{}, highlights:{} },
    cbStats: { total: 0, companies: 0, industries: {}, totalBalance: 0 },
    cbPrimaryStats: { underwriting: 0, board: 0 },
    cbBalanceStats: { total: 0, totalBalance: 0 },
    cbCBASStats: { total: 0 },
    stockStats: { total: 0, conceptTotal: 0, markets: {}, industries: {}, conceptCategories: {} },
    memoStats: { total: 0, stockTotal: 0, industryTotal: 0, brokers: {}, types: {} }
};

let CURR_DB = 'news';
const $ = id => document.getElementById(id);
const safe = v => (v==null||v==undefined?'':String(v).trim());

// Áµ±‰∏Ä‰ª£Á¢ºËôïÁêÜÂáΩÊï∏
const normalizeCode = v => {
    if(!v) return '';
    let s = String(v).trim();
    // ÁßªÈô§ .0 (Excel Êï∏Â≠óÊ†ºÂºè)
    if(s.match(/^\d+\.0$/)) s = s.replace('.0', '');
    // ÁßªÈô§ TT ÂæåÁ∂¥
    s = s.replace(/\s*TT$/i, '');
    // Ë£úÈõ∂Âà∞4‰Ωç
    if(s.match(/^\d{1,4}$/) && s.length < 4) s = s.padStart(4, '0');
    return s;
};

const fmtDate = v => {
    if(!v) return '';
    if(typeof v === 'number' && v > 20000) { 
        const d = new Date((v-25569)*86400000); 
        return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`; 
    }
    return String(v).split(' ')[0].split('T')[0];
};
const getDateVal = v => { if(!v) return 0; if(typeof v === 'number') return (v-25569)*86400000; return new Date(v).getTime(); };
const fmtNum = (v, decimal=0) => {
    if(v===undefined||v===null||v==='') return '-';
    let n = parseFloat(String(v).replace(/,/g,''));
    if(isNaN(n)) return v;
    return decimal > 0 ? n.toFixed(decimal) : n.toLocaleString();
};
const colorClass = v => {
    if(!v||v==='-') return '';
    let n = parseFloat(String(v).replace(/[%$,]/g,''));
    return n>0?'t-up':n<0?'t-down':'';
};

const fmtTxt = t => {
    if(!t) return '';
    let html = safe(t).replace(/\n/g, '<br>');
    html = html.replace(/#(\S+)/g, '<span class="tag-link" onclick="setSearch(\'#$1\');closeModal()">#$1</span>');
    return html;
};

function handleInput(el) { 
    $('clearBtn').style.display = el.value.length > 0 ? 'block' : 'none'; 
    renderList(); 
}
function clearSearch() { 
    $('search').value=''; 
    $('search').focus(); 
    $('clearBtn').style.display='none'; 
    renderList(); 
}
window.setSearch = term => { $('search').value = term; handleInput($('search')); };

async function fetchXlsx(url) {
    try {
        $('loadStatus').innerText = `ËºâÂÖ• ${url}...`;
        const res = await fetch(url);
        if(!res.ok) throw new Error();
        return XLSX.read(await res.arrayBuffer(), {type:'array'});
    } catch(e) { console.warn('Load Error:', url); return null; }
}

async function init() {
  try {
    let wb;
    
    // 1. Master + Ê¶ÇÂøµËÇ°
    wb = await fetchXlsx(FILES.MASTER);
    if(wb) {
        // ‰∏ªË≥áÊñôÂ∫´
        XLSX.utils.sheet_to_json(wb.Sheets['‰∏ªË≥áÊñôÂ∫´']||[]).forEach(r => {
            const code = normalizeCode(r['‰ª£Ëôü']);
            if(code) {
                DB.stocks[code] = {...r, '‰ª£Ëôü': code};
                // Áµ±Ë®àÂ∏ÇÂ†¥ÂíåÁî¢Ê•≠
                const market = r['Â∏ÇÂ†¥ÂàÜÈ°û'] || 'ÂÖ∂‰ªñ';
                const industry = r['Áî¢Ê•≠ÂàÜÈ°û'] || 'ÂÖ∂‰ªñ';
                META.stockStats.markets[market] = (META.stockStats.markets[market] || 0) + 1;
                META.stockStats.industries[industry] = (META.stockStats.industries[industry] || 0) + 1;
            }
        });
        META.stockStats.total = Object.keys(DB.stocks).length;
        
        // Ê¶ÇÂøµËÇ°ÊóèÁæ§Ë≥áÊñôÂ∫´
        const csSheet = wb.Sheets['üí°Ê¶ÇÂøµËÇ°ÊóèÁæ§Ë≥áÊñôÂ∫´'];
        if(csSheet) {
            const range = XLSX.utils.decode_range(csSheet['!ref']);
            for(let R=3; R<=range.e.r; R++) {
                const code = normalizeCode(csSheet[XLSX.utils.encode_cell({r:R,c:0})]?.v);
                const name = csSheet[XLSX.utils.encode_cell({r:R,c:1})]?.v;
                const concept = csSheet[XLSX.utils.encode_cell({r:R,c:2})]?.v;
                const subCat = csSheet[XLSX.utils.encode_cell({r:R,c:3})]?.v;
                const desc = csSheet[XLSX.utils.encode_cell({r:R,c:4})]?.v;
                const importance = csSheet[XLSX.utils.encode_cell({r:R,c:5})]?.v;
                
                if(code && concept) {
                    // ÂéüÊúâÁöÑ META.concepts Â∞çÁÖß
                    if(!META.concepts[code]) META.concepts[code] = [];
                    META.concepts[code].push({ concept: safe(concept), sub: safe(subCat) });
                    
                    // Êñ∞Â¢ûÂà∞ conceptStocks Èô£Âàó
                    DB.conceptStocks.push({
                        '_code': code,
                        '_name': safe(name),
                        '_concept': safe(concept),
                        '_subCat': safe(subCat),
                        '_desc': safe(desc),
                        '_importance': safe(importance),
                        '_industry': DB.stocks[code]?.['Áî¢Ê•≠ÂàÜÈ°û'] || ''
                    });
                    
                    // Áµ±Ë®àÊ¶ÇÂøµÂàÜÈ°û
                    META.stockStats.conceptCategories[concept] = (META.stockStats.conceptCategories[concept] || 0) + 1;
                }
            }
        }
        META.stockStats.conceptTotal = DB.conceptStocks.length;
        console.log('ÂÄãËÇ°ËºâÂÖ•:', META.stockStats.total, 'Ê¶ÇÂøµËÇ°:', META.stockStats.conceptTotal);
        
        // ËºâÂÖ•ÂêÑÊ¶ÇÂøµËÇ°Ê∏ÖÂñÆÂ∑•‰ΩúË°®
        const conceptSheets = ['ÂØåÊ´É50Êàê‰ªΩËÇ°', 'Âè∞ÁÅ£50Êàê‰ªΩËÇ°', '‰∏≠Âûã100Êàê‰ªΩËÇ°', 'NVDIAÊ¶ÇÂøµËÇ°', 'Âè∞Á©çÈõªÊ¶ÇÂøµËÇ°'];
        conceptSheets.forEach(sheetName => {
            const sheet = wb.Sheets[sheetName];
            if(sheet) {
                const rows = XLSX.utils.sheet_to_json(sheet);
                DB.conceptLists[sheetName] = rows.map(r => normalizeCode(r['‰ª£Á¢º'])).filter(c => c);
                console.log(`${sheetName}: ${DB.conceptLists[sheetName].length} Ê™î`);
            }
        });
    }

    // 2. Revenue - ÂÆåÊï¥ËÆÄÂèñ
    wb = await fetchXlsx(FILES.REV);
    if(wb) {
        // ÊúàÁáüÊî∂ - Êî∂ÈõÜÂÆåÊï¥Ë≥áÊñô
        const sheetM = wb.Sheets['000_ÊúàÁáüÊî∂'];
        if(sheetM) {
            const rows = XLSX.utils.sheet_to_json(sheetM, {defval: null});
            if(rows.length > 0) {
                const headers = Object.keys(rows[0]);
                const mCols = headers.filter(h => h.includes('ÂñÆÊúàÁáüÊî∂')).sort();
                const accCols = headers.filter(h => h.includes('Á¥ØÊúàÁáüÊî∂(ÂÑÑ)') && !h.includes('ÂñÆÊúà')).sort();
                
                console.log('ÊúàÁáüÊî∂Ê¨Ñ‰Ωç:', mCols.length, 'Á¥ØË®àÊ¨Ñ‰Ωç:', accCols.length);
                
                rows.forEach(r => {
                    const code = normalizeCode(r['‰ª£Ëôü']);
                    if(!code || code.length > 5 || code.startsWith('0')) return;
                    
                    const data = [];
                    mCols.forEach(col => {
                        const m = col.match(/(\d+)M(\d+)/);
                        if(m && r[col] !== null && r[col] !== undefined) {
                            // 25M08 = 2025Âπ¥8Êúà (ÂâçÂÖ©‰ΩçÂ∞±ÊòØË•øÂÖÉÂπ¥ÂæåÂÖ©‰Ωç)
                            const year = 2000 + parseInt(m[1]);
                            const month = parseInt(m[2]);
                            const period = `${year}/${month.toString().padStart(2, '0')}`;
                            const accCol = accCols.find(c => c.includes(m[0]));
                            data.push({ 
                                d: period,
                                period: m[0],
                                year: year,
                                month: month,
                                rev: r[col],
                                acc: accCol ? r[accCol] : null
                            });
                        }
                    });
                    
                    if(data.length > 0) {
                        // ÊåâÊó•ÊúüÊéíÂ∫èÔºàÊñ∞ÁöÑÂú®ÂâçÔºâ
                        data.sort((a, b) => b.d.localeCompare(a.d));
                        META.revData.month[code] = data;
                    }
                });
                console.log('ÊúàÁáüÊî∂ËºâÂÖ•ÂÖ¨Âè∏Êï∏:', Object.keys(META.revData.month).length);
            }
        }
        
        // Â≠£ÁáüÊî∂
        const sheetQ = wb.Sheets['000_Â≠£ÁáüÊî∂'];
        if(sheetQ) {
            const rows = XLSX.utils.sheet_to_json(sheetQ, {defval: null});
            if(rows.length > 0) {
                const headers = Object.keys(rows[0]);
                const qCols = headers.filter(h => h.includes('ÂñÆÂ≠£ÁáüÊî∂')).sort();
                
                rows.forEach(r => {
                    const code = normalizeCode(r['‰ª£Ëôü']);
                    if(!code || code.length > 5 || code.startsWith('0')) return;
                    
                    const data = [];
                    qCols.forEach(col => {
                        const m = col.match(/(\d+)Q(\d)/);
                        if(m && r[col] !== null && r[col] !== undefined) {
                            const year = 2000 + parseInt(m[1]);
                            data.push({ 
                                d: `${year}Q${m[2]}`, 
                                year: year,
                                q: parseInt(m[2]),
                                rev: r[col] 
                            });
                        }
                    });
                    
                    if(data.length > 0) {
                        data.sort((a, b) => b.d.localeCompare(a.d));
                        META.revData.quarter[code] = data;
                    }
                });
                console.log('Â≠£ÁáüÊî∂ËºâÂÖ•ÂÖ¨Âè∏Êï∏:', Object.keys(META.revData.quarter).length);
            }
        }
        
        // Âπ¥ÁáüÊî∂
        const sheetY = wb.Sheets['000_Âπ¥ÁáüÊî∂'];
        if(sheetY) {
            const rows = XLSX.utils.sheet_to_json(sheetY, {defval: null});
            if(rows.length > 0) {
                const headers = Object.keys(rows[0]);
                const yCols = headers.filter(h => h.includes('Âπ¥Â∫¶ÁáüÊî∂')).sort();
                
                rows.forEach(r => {
                    const code = normalizeCode(r['‰ª£Ëôü']);
                    if(!code || code.length > 5 || code.startsWith('0')) return;
                    
                    const data = [];
                    yCols.forEach(col => {
                        const m = col.match(/(\d{4})/);
                        if(m && r[col] !== null && r[col] !== undefined) {
                            data.push({ 
                                d: m[0], 
                                year: parseInt(m[0]),
                                rev: r[col] 
                            });
                        }
                    });
                    
                    if(data.length > 0) {
                        data.sort((a, b) => b.year - a.year);
                        META.revData.year[code] = data;
                    }
                });
                console.log('Âπ¥ÁáüÊî∂ËºâÂÖ•ÂÖ¨Âè∏Êï∏:', Object.keys(META.revData.year).length);
            }
        }
        
        // Ë≤°Â†±ÂÇôË®ª
        const sheetH = wb.Sheets['10_Ë≤°Â†±ÂÇôË®ª'];
        if(sheetH) {
            XLSX.utils.sheet_to_json(sheetH, {defval: null}).forEach(r => {
                const code = normalizeCode(r['‰ª£Ëôü']);
                if(code) META.revData.highlights[code] = r;
            });
        }
    }

    // 3. News
    wb = await fetchXlsx(FILES.NEWS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['Â§ñÈõªÁ∂úÂêàÂ†±Â∞é']||[]).forEach(r => {
            const code = normalizeCode(r['ËÇ°Ëôü']);
            DB.news.push({...r, 'ËÇ°Ëôü': code});
            if(code) { 
                if(!META.relatedNews[code]) META.relatedNews[code]=[]; 
                META.relatedNews[code].push(r); 
            }
        });
        DB.news.sort((a,b) => getDateVal(b['Êó•Êúü'])-getDateVal(a['Êó•Êúü']));
        console.log('NewsËºâÂÖ•:', DB.news.length);
    }

    // 4. Memo
    wb = await fetchXlsx(FILES.MEMO);
    if(wb) {
        // Áî¢Ê•≠È°ûÂ†±ÂëäÈóúÈçµÂ≠ó
        const industryKeywords = ['Áî¢Ê•≠', 'TPCA', 'ÂúãÈöõËÇ°Â∏Ç', 'Á∏ΩÁ∂ì', 'Á≠ñÁï•'];
        
        XLSX.utils.sheet_to_json(wb.Sheets['Â†±ÂëäÁ∏ΩË°®']||[]).forEach(r => {
            const code = normalizeCode(r['ËÇ°Ëôü']);
            const reportType = safe(r['Â†±ÂëäÈ°ûÂûã']);
            const memoData = {...r, 'ËÇ°Ëôü': code};
            
            DB.memo.push(memoData);
            
            // Âà§Êñ∑ÊòØÂÄãËÇ°ÈÇÑÊòØÁî¢Ê•≠
            const isIndustry = industryKeywords.some(kw => reportType.includes(kw));
            if(isIndustry) {
                DB.memoIndustry.push(memoData);
            } else {
                DB.memoStock.push(memoData);
            }
            
            // Áµ±Ë®àÂà∏ÂïÜÂíåÂ†±ÂëäÈ°ûÂûã
            const broker = safe(r['Âà∏ÂïÜ']);
            if(broker) META.memoStats.brokers[broker] = (META.memoStats.brokers[broker] || 0) + 1;
            if(reportType) META.memoStats.types[reportType] = (META.memoStats.types[reportType] || 0) + 1;
            
            if(code) { 
                if(!META.relatedMemo[code]) META.relatedMemo[code]=[]; 
                META.relatedMemo[code].push(r); 
            }
        });
        DB.memo.sort((a,b) => getDateVal(b['Êó•Êúü'])-getDateVal(a['Êó•Êúü']));
        DB.memoStock.sort((a,b) => getDateVal(b['Êó•Êúü'])-getDateVal(a['Êó•Êúü']));
        DB.memoIndustry.sort((a,b) => getDateVal(b['Êó•Êúü'])-getDateVal(a['Êó•Êúü']));
        
        META.memoStats.total = DB.memo.length;
        META.memoStats.stockTotal = DB.memoStock.length;
        META.memoStats.industryTotal = DB.memoIndustry.length;
        console.log('MemoËºâÂÖ•:', META.memoStats.total, 'ÂÄãËÇ°:', META.memoStats.stockTotal, 'Áî¢Ê•≠:', META.memoStats.industryTotal);
        
        XLSX.utils.sheet_to_json(wb.Sheets['Ë©≥Á¥∞ÂÖßÂÆπÂ∫´']||[]).forEach(r => META.memoDetail[safe(r['Á∑®Ëôü'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['Ë≤°ÂãôÊï∏ÊìöÂΩôÁ∏Ω']||[]).forEach(r => META.finance[safe(r['ÂÖ¨Âè∏'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['Áî¢ÂìÅÁµêÊßãÂàÜÊûê']||[]).forEach(r => META.products[safe(r['ÂÖ¨Âè∏'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['ÂÖ¨Âè∏ËøΩËπ§Ë°®']||[]).forEach(r => META.tracking[safe(r['ÂÖ¨Âè∏'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['Áî¢Ê•≠Ë∂®Âã¢Á∏ΩË¶Ω']||[]).forEach(r => {
            if(r['Áî¢Ê•≠']) DB.trends.push(r);
        });
    }

    // 5. Reports
    wb = await fetchXlsx(FILES.REPORTS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['Â†±ÂëäÁ∏ΩË¶Ω']||[]).forEach(r => DB.reports.push(r));
        DB.reports.sort((a,b) => getDateVal(b['Â†±ÂëäÊó•Êúü'])-getDateVal(a['Â†±ÂëäÊó•Êúü']));
        
        XLSX.utils.sheet_to_json(wb.Sheets['ÁÑ¶ÈªûÂàÜÊûêÂÖßÂÆπ']||[]).forEach(r => {
            const rid = safe(r['Â†±ÂëäÁ∑®Ëôü']);
            if(rid) { if(!META.reportFocus[rid]) META.reportFocus[rid]=[]; META.reportFocus[rid].push(r); }
        });
        XLSX.utils.sheet_to_json(wb.Sheets['Âà∏ÂïÜËßÄÈªûÁµêË´ñ']||[]).forEach(r => {
            const rid = safe(r['Â†±ÂëäÁ∑®Ëôü']);
            if(rid) META.reportViews[rid] = r;
        });
        XLSX.utils.sheet_to_json(wb.Sheets['ÂÄãËÇ°Ë©ïÂÉπË°®']||[]).forEach(r => {
            const rid = safe(r['Â†±ÂëäÁ∑®Ëôü']);
            if(rid) { if(!META.reportRatings[rid]) META.reportRatings[rid]=[]; META.reportRatings[rid].push(r); }
        });
    }

    // 6. Strategy (Ë∂®Âã¢Â±ïÊúõ) - Êñ∞Ê†ºÂºè
    wb = await fetchXlsx(FILES.STRAT);
    if(wb) {
        // ËÆÄÂèñÂ†±ÂëäÁ¥¢Âºï
        const indexSheet = wb.Sheets['Â†±ÂëäÁ¥¢Âºï'];
        if(indexSheet) {
            const indexData = XLSX.utils.sheet_to_json(indexSheet, {header: 1});
            // ÊâæÂ†±ÂëäÊ∏ÖÂñÆÈñãÂßã‰ΩçÁΩÆ (Ë∑≥ÈÅéÊ®ôÈ°å)
            for(let i = 0; i < indexData.length; i++) {
                const row = indexData[i];
                if(row[0] === 'Â†±ÂëäÁ∑®Ëôü') {
                    // Êé•‰∏ã‰æÜÊòØÂ†±ÂëäË≥áÊñô
                    for(let j = i+1; j < indexData.length; j++) {
                        const r = indexData[j];
                        if(r[0] && r[0].startsWith('RPT-')) {
                            const rptId = r[0];
                            const sheetName = wb.SheetNames.find(n => n.includes(rptId.replace('-', '')));
                            
                            DB.strategy.push({
                                'Â†±ÂëäÁ∑®Ëôü': rptId,
                                'Â†±Âëä‰∏ªÈ°å': r[1],
                                '‰∏ªË¨õÂñÆ‰Ωç': r[2],
                                'Ë¨õËÄÖ': r[3],
                                'Â†±ÂëäÊó•Êúü': r[4],
                                'È†ÅÊï∏': r[5],
                                '_sheetName': sheetName
                            });
                        }
                    }
                    break;
                }
            }
        }
        
        // ËÆÄÂèñÊØèÂÄãÂ†±ÂëäÁöÑË©≥Á¥∞ÂÖßÂÆπ
        DB.strategy.forEach(report => {
            const sheetName = report._sheetName;
            if(sheetName && wb.Sheets[sheetName]) {
                const sheetData = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {header: 1});
                const sections = [];
                let currentSection = null;
                let basicInfo = {};
                
                for(let i = 1; i < sheetData.length; i++) {
                    const row = sheetData[i];
                    const tag = row[0];
                    const val = row[1];
                    
                    if(!tag) continue;
                    
                    // Âü∫Êú¨Ë≥áË®äÊ¨Ñ‰Ωç
                    if(['Â†±ÂëäÁ∑®Ëôü', 'Â†±Âëä‰∏ªÈ°å', 'ÂâØÊ®ôÈ°å', 'ÁôºÂ∏ÉÂñÆ‰Ωç', '‰∏ªË¨õ‰∫∫', 'ÁôºÂ∏ÉÊó•Êúü', 'Â†±ÂëäÈ†ÅÊï∏', 'Ê†∏ÂøÉËßÄÈªû', 'Ê®ôÁ±§ÂàÜÈ°û', 'Ë≥áÊñô‰æÜÊ∫ê'].includes(tag)) {
                        basicInfo[tag] = val;
                        continue;
                    }
                    
                    // ÂàÜÈ°ûÊ®ôÈ°å (Áî®„Äê„ÄëÂåÖËµ∑‰æÜ)
                    if(tag.startsWith('„Äê') && tag.endsWith('„Äë')) {
                        if(currentSection) sections.push(currentSection);
                        currentSection = { title: tag, items: [] };
                    } else if(currentSection) {
                        currentSection.items.push({ label: tag, value: val });
                    }
                }
                if(currentSection) sections.push(currentSection);
                
                // ÂÑ≤Â≠òÂà∞ META
                META.stratSections = META.stratSections || {};
                META.stratSections[report['Â†±ÂëäÁ∑®Ëôü']] = {
                    basic: basicInfo,
                    sections: sections
                };
            }
        });
        
        DB.strategy.sort((a,b) => getDateVal(b['Â†±ÂëäÊó•Êúü'])-getDateVal(a['Â†±ÂëäÊó•Êúü']));
        console.log('Ë∂®Âã¢Â±ïÊúõËºâÂÖ•:', DB.strategy.length, 'ÁØáÂ†±Âëä');
    }

    // 7. CB - ÂÆåÊï¥ËÆÄÂèñ
    wb = await fetchXlsx(FILES.CB);
    if(wb) {
        // ÂÖàËÆÄÂèñÊéõÁâåÈ´ò‰ΩéË≥áÊñô (00Â∑•‰ΩúË°®)
        const cbHighLow = {};
        const sheet00Name = wb.SheetNames.find(n => n.startsWith('00_'));
        if(sheet00Name) {
            XLSX.utils.sheet_to_json(wb.Sheets[sheet00Name]||[]).forEach(r => {
                const cbCode = safe(r['‰ª£Ëôü']);
                if(cbCode) {
                    const high = parseFloat(r['ÊéõÁâåÊúÄÈ´ò']) || 0;
                    const low = parseFloat(r['ÊéõÁâåÊúÄ‰Ωé']) || 0;
                    cbHighLow[cbCode] = {
                        high: high,
                        low: low,
                        range: low > 0 ? ((high - low) / low * 100) : 0,
                        avgVol: r['ÊúàÂùáÊàê‰∫§']
                    };
                }
            });
        }
        
        // ËÆÄÂèñ 09_ÊúÄÊñ∞ÂãïÊÖãÊØèÈÄ±Êó•Ë°åÊÉÖ - ÂèñÂæóÊúÄÊñ∞Êî∂Áõ§ÂÉπ
        const cbLatestPrice = {};
        XLSX.utils.sheet_to_json(wb.Sheets['09_ÊúÄÊñ∞ÂãïÊÖãÊØèÈÄ±Êó•Ë°åÊÉÖ']||[]).forEach(r => {
            const cbCode = safe(r['‰ª£Á¢º']);
            if(cbCode) {
                cbLatestPrice[cbCode] = parseFloat(r['CBÊî∂Áõ§ÂÉπ']) || 0;
            }
        });
        
        // ËÆÄÂèñ 05_CBÁ´∂ÊãçÁØ©ÈÅ∏Ê¢ù‰ª∂ÂçÄÈñì - Âª∫Á´ãÁî¢Ê•≠Á∞°Á®±Â∞çÁÖßË°®
        const industrySimpleMap = {
            'ÂÖâÈõªÊ•≠': 'ÂÖâÈõª', 'ÂÖ∂‰ªñÊ•≠': 'ÂÖ∂‰ªñ', 'ÂÖ∂‰ªñÊ•≠ÈõªÂ≠êÊ•≠': 'ÂÖ∂‰ªñÈõªÂ≠ê',
            'ÂåñÂ≠∏Â∑•Ê•≠': 'ÂåñÂ∑•', 'ÂçäÂ∞éÈ´îÊ•≠': 'ÂçäÂ∞éÈ´î', 'Â°ëËÜ†Â∑•Ê•≠': 'Â°ëËÜ†',
            'Â±ÖÂÆ∂ÁîüÊ¥ª': 'Â±ÖÂÆ∂ÁîüÊ¥ª', 'Âª∫ÊùêÁáüÈÄ†Ê•≠': 'Âª∫ÊùêÁáüÈÄ†', 'Êï∏‰ΩçÈõ≤Á´Ø': 'Êï∏‰ΩçÈõ≤Á´Ø',
            'ÊñáÂåñÂâµÊÑèÊ•≠': 'ÊñáÂåñÂâµÊÑè', 'Ê©°ËÜ†Â∑•Ê•≠': 'ÂÖ∂‰ªñ', 'Ê∞¥Ê≥•Â∑•Ê•≠': 'Ê∞¥Ê≥•',
            'Ê±ΩËªäÂ∑•Ê•≠': 'Ê±ΩËªä', 'Ê≤πÈõªÁáÉÊ∞£Ê•≠': 'Ê≤πÈõªÁáÉÊ∞£', 'ÁéªÁíÉÈô∂Áì∑': 'ÂÖ∂‰ªñ',
            'ÁîüÊäÄÈÜ´ÁôÇÊ•≠': 'ÁîüÊäÄÈÜ´ÁôÇ', 'Á¥°ÁπîÁ∫ñÁ∂≠': 'Á¥°ÁπîÁ∫ñÁ∂≠', 'Á∂†ËÉΩÁí∞‰øù': 'Á∂†ËÉΩÁí∞‰øù',
            'Ëà™ÈÅãÊ•≠': 'Ëà™ÈÅã', 'ËßÄÂÖâÈ§êÊóÖ': 'ËßÄÂÖâÈ§êÊóÖ', 'Ë≠âÂà∏Ê•≠': 'ÈáëËûç‰øùÈö™',
            'Ë≤øÊòìÁôæË≤®Ê•≠': 'Ë≤øÊòìÁôæË≤®', 'Ë≥áË®äÊúçÂãôÊ•≠': 'Ë≥áË®äÊúçÂãô', 'Ëæ≤Ê•≠ÁßëÊäÄÊ•≠': 'Ëæ≤Ê•≠ÁßëÊäÄ',
            'ÈÄö‰ø°Á∂≤Ë∑ØÊ•≠': 'ÈÄö‰ø°Á∂≤Ë∑Ø', 'ÈÄ†Á¥ôÂ∑•Ê•≠': 'ÈÄ†Á¥ô', 'ÈÅãÂãï‰ºëÈñí': 'ÈÅãÂãï‰ºëÈñí',
            'ÈáëÊéßÊ•≠': 'ÈáëËûç‰øùÈö™', 'ÈäÄË°åÊ•≠': 'ÈáëËûç‰øùÈö™', 'ÈãºÈêµÂ∑•Ê•≠': 'ÈãºÈêµ',
            'ÈõªÂô®ÈõªÁ∫ú': 'ÈõªÂô®ÈõªÁ∫ú', 'ÈõªÂ≠êÈÄöË∑ØÊ•≠': 'ÈõªÂ≠êÈÄöË∑Ø', 'ÈõªÂ≠êÈõ∂ÁµÑ‰ª∂Ê•≠': 'ÈõªÂ≠êÈõ∂ÁµÑ‰ª∂',
            'ÈõªÊ©üÊ©üÊ¢∞': 'ÈõªÊ©üÊ©üÊ¢∞', 'ÈõªËÖ¶ÂèäÈÄ±ÈÇäË®≠ÂÇôÊ•≠': 'ÈõªËÖ¶ÂèäÈÄ±ÈÇä', 'È£üÂìÅÂ∑•Ê•≠': 'È£üÂìÅ'
        };
        const getSimpleIndustry = (ind) => industrySimpleMap[ind] || ind || 'ÂÖ∂‰ªñ';
        
        // ËÆÄÂèñ 01_ALLCBÂü∫Êú¨Ë≥áÊñô - ÂÖ®ÈÉ®CBÔºàÂê´Ê≠∑Âè≤Ôºâ
        const cbBasicInfo = {};
        const activeCodes = new Set(); // Ë®òÈåÑÊéõÁâå‰∏≠ÁöÑ‰ª£Ëôü
        
        XLSX.utils.sheet_to_json(wb.Sheets['01_ALLCBÂü∫Êú¨Ë≥áÊñô']||[]).forEach(r => {
            const cbCode = safe(r['CB‰ª£Ëôü']);
            if(cbCode) {
                const hl = cbHighLow[cbCode] || {};
                const fullIndustry = safe(r['Áî¢Ê•≠ÂàÜÈ°û']);
                cbBasicInfo[cbCode] = {
                    stockCode: normalizeCode(r['ËÇ°Á•®‰ª£Ëôü']),
                    name: safe(r['ÂêçÁ®±']),
                    method: safe(r['Ë©¢ÂúàÁ´∂Êãç']),
                    guarantee: safe(r['Êìî‰øù']),
                    rating: r['‰ø°Ë©ï'],
                    issuer: safe(r['ÁôºË°åÂà∏ÂïÜ']),
                    scale: r['ÁôºË°åË¶èÊ®°'],
                    convPrice: r['ËΩâÊèõÂÉπÊ†º'],
                    years: r['ÁôºË°åÂπ¥Êúü'],
                    issuePrice: r['ÁôºË°åÂÉπÊ†º'],
                    expPrice: r['Âà∞ÊúüÈÇÑÊú¨ÂÉπÊ†º'],
                    premium: r['Ë®ÇÂÉπÊ∫¢ÂÉπÁéá'],
                    position: safe(r['Áî¢Ê•≠Âú∞‰Ωç']),
                    capital: r['ËÇ°Êú¨Â§ßÂ∞è'],
                    industry: getSimpleIndustry(fullIndustry),
                    listDate: r['ÊéõÁâåÊó•Êúü'],
                    expDate: r['Âà∞ÊúüÊó•Êúü'],
                    high: hl.high || parseFloat(r['ÊéõÁâåÊúÄÈ´ò']) || 0,
                    low: hl.low || parseFloat(r['ÊéõÁâåÊúÄ‰Ωé']) || 0
                };
            }
        });
        
        // ËÆÄÂèñ 02_ALLCBÁôºË°åÊôÇÁ®ã
        const cbTimeline = {};
        XLSX.utils.sheet_to_json(wb.Sheets['02_ALLCBÁôºË°åÊôÇÁ®ã']||[]).forEach(r => {
            const cbCode = safe(r['CB‰ª£Ëôü']);
            if(cbCode) {
                cbTimeline[cbCode] = {
                    boardDate: r['Ëë£‰∫ãÊúÉÂÖ¨Âëä'],
                    sendDate: r['ÈÄÅ‰ª∂Êó•Êúü'],
                    effectDate: r['ÁîüÊïàÊó•Êúü'],
                    bidDate: safe(r['Ë©¢ÂúàÁ´∂ÊãçÊó•Êúü']),
                    payDate: r['‰ª£Êî∂ÂÉπÊ¨æÂÖ¨Âëä'],
                    listDate: r['ÊéõÁâåÊó•Êúü'],
                    cbasDate: r['CBASÊãÜËß£Êó•']
                };
            }
        });
        
        // ËÆÄÂèñ 03_ALLCBË≥£ÂõûÊ¢ù‰ª∂
        const cbPutback = {};
        XLSX.utils.sheet_to_json(wb.Sheets['03_ALLCBË≥£ÂõûÊ¢ù‰ª∂']||[]).forEach(r => {
            const cbCode = safe(r['CB‰ª£Ëôü']);
            if(cbCode) {
                cbPutback[cbCode] = {
                    putDate1: r['Ë≥£ÂõûÊó•Êúü1'],
                    putDate2: r['Ë≥£ÂõûÊó•Êúü2'],
                    putTiming: safe(r['ÊäïË≥á‰∫∫ÊèêÂâçË≥£Âõû']),
                    putCondition: safe(r['Ë≥£ÂõûÊ¢ù‰ª∂'])
                };
            }
        });
        
        // Êï¥ÂêàÂà∞ DB.cbAll
        Object.entries(cbBasicInfo).forEach(([cbCode, info]) => {
            const timeline = cbTimeline[cbCode] || {};
            const putback = cbPutback[cbCode] || {};
            DB.cbAll.push({
                '_cbCode': cbCode,
                '_stockCode': info.stockCode,
                '_name': info.name,
                '_industry': info.industry,
                '_method': info.method,
                '_guarantee': info.guarantee,
                '_rating': info.rating,
                '_issuer': info.issuer,
                '_scale': info.scale,
                '_convPrice': info.convPrice,
                '_years': info.years,
                '_issuePrice': info.issuePrice,
                '_expPrice': info.expPrice,
                '_premium': info.premium,
                '_position': info.position,
                '_capital': info.capital,
                '_listDate': info.listDate,
                '_expDate': info.expDate,
                '_high': info.high,
                '_low': info.low,
                // ÊôÇÁ®ãË≥áË®ä
                '_boardDate': timeline.boardDate,
                '_sendDate': timeline.sendDate,
                '_effectDate': timeline.effectDate,
                '_bidDate': timeline.bidDate,
                '_payDate': timeline.payDate,
                '_cbasDate': timeline.cbasDate,
                // Ë≥£ÂõûÊ¢ù‰ª∂
                '_putDate1': putback.putDate1,
                '_putDate2': putback.putDate2,
                '_putTiming': putback.putTiming,
                '_putCondition': putback.putCondition
            });
        });
        console.log('CBÂü∫Êú¨Ë≥áÊñôËºâÂÖ•:', DB.cbAll.length, 'Á≠Ü');
        
        // Âª∫Á´ãÊ≠∑Âè≤CBË≥áÊñôÂ∫´ÔºàÂÖàÊîæÂÖ®ÈÉ®ÔºåÂæåÈù¢ÊúÉÊéíÈô§ÊéõÁâå‰∏≠ÁöÑÔºâ
        // ÈÅéÊøæÊéâÊéõÁâåÊúÄÈ´òÊàñÊúÄ‰ΩéÁÇ∫ 0 ÁöÑË≥áÊñô
        Object.entries(cbBasicInfo).forEach(([cbCode, info]) => {
            const high = info.high;
            const low = info.low;
            // Âè™Âä†ÂÖ•ÊúâÊïàË≥áÊñôÔºàhigh Âíå low ÈÉΩ‰∏çÁÇ∫ 0Ôºâ
            if(high > 0 && low > 0) {
                DB.cbHistory.push({
                    '_cbCode': cbCode,
                    '_stockCode': info.stockCode,
                    '_name': info.name,
                    '_industry': info.industry,
                    '_method': info.method,
                    '_guarantee': info.guarantee,
                    '_high': high,
                    '_low': low,
                    '_range': (high - low) / low * 100,
                    'ËΩâÊèõÂÉπÊ†º(ÂÖÉ)': info.convPrice,
                    'Âà∞ÊúüÊó•': info.expDate,
                    'ÊéõÁâåÊó•Êúü': info.listDate,
                    'ÁôºË°åË¶èÊ®°': info.scale,
                    'ÁôºË°åÂà∏ÂïÜ': info.issuer
                });
            }
        });
        
        // Êó•Ë°åÊÉÖ (ÊúâÁî¢Ê•≠Ë≥áË®ä) - ÂÖàËÆÄÂèñÂª∫Á´ãÁî¢Ê•≠Â∞çÁÖß
        const dailyMap = {};
        XLSX.utils.sheet_to_json(wb.Sheets['09_ÊúÄÊñ∞ÂãïÊÖãÊØèÈÄ±Êó•Ë°åÊÉÖ']||[]).forEach(r => {
            const code = safe(r['‰ª£Á¢º']);
            const name = safe(Object.values(r)[1]);
            const ind = getSimpleIndustry(safe(r['Áî¢Ê•≠']));
            
            if(code) {
                dailyMap[code] = {
                    name: name,
                    industry: ind,
                    cbPrice: r['CBÊî∂Áõ§ÂÉπ'],
                    stockPrice: r['ËÇ°ÂÉπ'],
                    convPrice: r['ËΩâÊèõÂÉπÊ†º'],
                    convValue: r['ËΩâÊèõÂÉπÂÄº'],
                    premium: r['Ê∫¢(Êäò)ÂÉπ%'],
                    expDate: r['Âà∞ÊúüÊó•']
                };
            }
        });
        
        // ÊéõÁâå‰∏≠ CB - Âêà‰ΩµÊó•Ë°åÊÉÖË≥áÊñôÂíåÊéõÁâåÈ´ò‰Ωé
        const activeCbCodes = new Set();
        META.cbStats.industries = {}; // ÈáçÁΩÆÁî¢Ê•≠Áµ±Ë®à
        
        XLSX.utils.sheet_to_json(wb.Sheets['08_ÊúÄÊñ∞ÂãïÊÖãÊØèÈÄ±Âü∫Êú¨Ë≥áÊñô']||[]).forEach(r => {
            const cbCode = safe(r['‰ª£Ëôü']);
            const stockCode = normalizeCode(r['ËΩâÊèõÊ®ôÁöÑ‰ª£Á¢º']);
            const daily = dailyMap[cbCode] || {};
            const hl = cbHighLow[cbCode] || {};
            const basic = cbBasicInfo[cbCode] || {};
            
            activeCbCodes.add(cbCode); // Ë®òÈåÑÊéõÁâå‰∏≠ÁöÑ‰ª£Ëôü
            
            // Áî¢Ê•≠ÂÑ™ÂÖà‰ΩøÁî® 01 Â∑•‰ΩúË°®ÁöÑË≥áÊñôÔºàÂ∑≤ËΩâÊèõÁÇ∫Á∞°ÊΩîÂêçÁ®±Ôºâ
            const industry = basic.industry || daily.industry || 'ÂÖ∂‰ªñ';
            
            const cbData = {
                ...r,
                '_stockCode': stockCode,
                '_cbCode': cbCode,
                '_name': safe(r['ÂêçÁ®±']),
                '_stockName': safe(r['ËΩâÊèõÊ®ôÁöÑÂêçÁ®±']),
                '_industry': industry,
                '_cbPrice': daily.cbPrice,
                '_stockPrice': daily.stockPrice,
                '_convValue': daily.convValue,
                '_premium': daily.premium,
                '_high': hl.high || 0,
                '_low': hl.low || 0,
                '_range': hl.range || 0,
                '_method': basic.method || '',      // Ë©¢Âúà or Á´∂Êãç
                '_guarantee': basic.guarantee || '' // ÊúâÊìî‰øù or ÁÑ°Êìî‰øù
            };
            
            DB.cb.push(cbData);
            if(stockCode) { 
                if(!META.cbMap[stockCode]) META.cbMap[stockCode]=[]; 
                META.cbMap[stockCode].push(cbData); 
            }
            // Áµ±Ë®àÁî¢Ê•≠
            if(industry) {
                META.cbStats.industries[industry] = (META.cbStats.industries[industry] || 0) + 1;
            }
        });
        
        // ÂæûÊ≠∑Âè≤ CB ‰∏≠ÊéíÈô§ÊéõÁâå‰∏≠ÁöÑ
        DB.cbHistory = DB.cbHistory.filter(c => !activeCbCodes.has(c._cbCode));
        
        // ËÆÄÂèñ 04_ÊâÄÊúâCBÁ´∂ÊãçË≥áÊñôÂ∫´
        XLSX.utils.sheet_to_json(wb.Sheets['04_ÊâÄÊúâCBÁ´∂ÊãçË≥áÊñôÂ∫´']||[]).forEach(r => {
            const cbCode = safe(r['CB‰ª£Ëôü']);
            if(!cbCode) return; // Ë∑≥ÈÅéÁ©∫Ë≥áÊñô
            
            // ÂÑ™ÂÖà‰ΩøÁî® 00 Â∑•‰ΩúË°®ÁöÑÊéõÁâåÈ´ò‰ΩéÔºåËã•ÁÑ°ÂâáÁî® 04 Â∑•‰ΩúË°®ÁöÑ
            const hl = cbHighLow[cbCode] || {};
            const high = hl.high || parseFloat(r['ÊéõÁâåÊúÄÈ´ò']) || 0;
            const low = hl.low || parseFloat(r['ÊéõÁâåÊúÄ‰Ωé']) || 0;
            // ÊúÄÊñ∞Êî∂Áõ§Âæû 09 Â∑•‰ΩúË°®ÂèñÂæó
            const latestPrice = cbLatestPrice[cbCode] || 0;
            
            DB.cbAuction.push({
                '_cbCode': cbCode,
                '_stockCode': normalizeCode(r['ËÇ°Á•®‰ª£Ëôü']),
                '_name': safe(r['ÂêçÁ®±']),
                '_industry': getSimpleIndustry(safe(r['Áî¢Ê•≠ÂàÜÈ°û'])),
                '_guarantee': safe(r['Êìî‰øù']),
                '_high': high,
                '_low': low,
                '_latestPrice': latestPrice,
                '_range': low > 0 ? (high - low) / low * 100 : 0,
                'ÈñãÊ®ôÊó•Êúü': r['ÈñãÊ®ôÊó•Êúü'],
                'Êà™Ê®ôÊó•': r['Êà™Ê®ôÊó•'],
                'ÁôºË°åË¶èÊ®°': r['ÁôºË°åË¶èÊ®°'],
                'Á´∂ÊãçÂºµÊï∏': r['Á´∂ÊãçÂºµÊï∏'],
                'Â∫ïÊ®ôÂÉπ': r['Â∫ïÊ®ôÂÉπ'],
                'ÁêÜË´ñÂÉπ': r['ÁêÜË´ñÂÉπ'],
                'ÊúÄ‰ΩéÂæóÊ®ô': r['ÊúÄ‰ΩéÂæóÊ®ô'],
                'ÊúÄ‰ΩéÊ∫¢ÂÉπ': r['ÊúÄ‰ΩéÊ∫¢ÂÉπ'],
                'Âπ≥ÂùáÂæóÊ®ô': r['Âπ≥ÂùáÂæóÊ®ô'],
                'Âπ≥ÂùáÊ∫¢ÂÉπ': r['Âπ≥ÂùáÊ∫¢ÂÉπ'],
                'ÊäïÊ®ôÂÄçÊï∏': r['ÊäïÊ®ôÂÄçÊï∏'],
                'ÂêàÊ†º‰ª∂Êï∏': r['ÂêàÊ†º‰ª∂Êï∏'],
                'ÁôºË°åÂà∏ÂïÜ': safe(r['ÁôºË°åÂà∏ÂïÜ']),
                'ËΩâÊèõÂÉπ': r['ËΩâÊèõÂÉπ'],
                'Ë®ÇÂÉπÊ∫¢ÂÉπÁéá': r['Ë®ÇÂÉπÊ∫¢ÂÉπÁéá']
            });
        });
        
        // ËÆÄÂèñ 06_ÁôºË°åÊ°à‰ª∂ (ÊâøÈä∑‰∏≠)
        XLSX.utils.sheet_to_json(wb.Sheets['06_ÁôºË°åÊ°à‰ª∂']||[]).forEach(r => {
            DB.cbPrimary.push({
                '_stockCode': normalizeCode(r['ËÇ°Á•®‰ª£Ëôü']),
                '_cbCode': safe(r['Ê®ôÁöÑ‰ª£Ëôü']),
                '_name': safe(r['ÁôºË°åÊ®ôÁöÑ']),
                '_method': safe(r['Ë©¢Âúà/Á´∂Êãç']),
                '_tcri': safe(r['TCRI/Êìî‰øù']),
                '_amount': r['ÁôºË°åÈáè'],
                '_broker': safe(r['ÁôºË°åÂà∏ÂïÜ']),
                '_sendDate': r['ÈÄÅ‰ª∂Êó•'],
                '_effectDate': r['ÁîüÊïàÊó•'],
                '_bidPeriod': safe(r['Ë©¢Âúà/ÊäïÊ®ôÊúüÈñì']),
                '_premium': r['Ê∫¢ÂÉπÁéá'],
                '_convPrice': r['ËΩâÊèõÂÉπ'],
                '_listDate': r['ÊéõÁâåÊó•'],
                '_optionDate': r['ÂèØÊãÜËß£ÈÅ∏ÊìáÊ¨äÊó•'],
                '_price': r['ÊâøÈä∑ÂÉπÊ†º'],
                '_years': r['Âπ¥Êúü'],
                '_putback': safe(r['Ë≥£ÂõûÊ¢ù‰ª∂']),
                '_capital': r['ËÇ°Êú¨'],
                '_stockPrice': r['ËÇ°ÂÉπ'],
                '_volatility': r['60Â§©Ê≥¢ÂãïÁéá']
            });
        });
        META.cbPrimaryStats.underwriting = DB.cbPrimary.length;
        
        // ËÆÄÂèñ 07_Ëë£‰∫ãÊúÉÊ±∫Ë≠∞
        XLSX.utils.sheet_to_json(wb.Sheets['07_Ëë£‰∫ãÊúÉÊ±∫Ë≠∞']||[]).forEach(r => {
            DB.cbBoard.push({
                '_stockCode': normalizeCode(r['ËÇ°È∞æ‰ª£Ëôü'] || r['ËÇ°Á•®‰ª£Ëôü']),
                '_cbCode': safe(r['CB‰ª£Á¢º']),
                '_name': safe(r['ÁôºË°åÊ®ôÁöÑ']),
                '_method': safe(r['Ë©¢Âúà/Á´∂ÂÉπ']),
                '_tcri': safe(r['TCRI/Êìî‰øù']),
                '_amount': r['ÁôºË°åÈáè'],
                '_broker': safe(r['‰∏ªËæ¶Âà∏ÂïÜ']),
                '_maturity': safe(r['Âà∞ÊúüÊó•']),
                '_boardDate': r['Ëë£‰∫ãÊúÉÈÄöÈÅé'],
                '_capital': r['ËÇ°Êú¨(ÂÑÑ)'],
                '_note': safe(r['ÂÇôË®ª'])
            });
        });
        META.cbPrimaryStats.board = DB.cbBoard.length;
        
        // ËÆÄÂèñ 10_ÊúÄÊñ∞ÂãïÊÖãÊØèÈÄ±È§òÈ°çË°®
        XLSX.utils.sheet_to_json(wb.Sheets['10_ÊúÄÊñ∞ÂãïÊÖãÊØèÈÄ±È§òÈ°çË°®']||[]).forEach(r => {
            DB.cbBalance.push({
                '_cbCode': safe(r['Ë≠âÂà∏‰ª£Ëôü']),
                '_name': safe(r['Ë≠âÂà∏ÂêçÁ®±']),
                '_thisWeek': r['Êú¨ÈÄ±ËÇ°È°ç'],
                '_lastWeek': r['‰∏äÈÄ±ËÇ°È°ç'],
                '_change': r['Â¢ûÊ∏õÊï∏È°ç'],
                '_changeRate': r['Â¢ûÊ∏õÊØîÁéá'],
                '_remainRate': r['ÁôºË°åÊØîÁéá(Ââ©È§òÊØîÁéá)']
            });
        });
        META.cbBalanceStats.total = DB.cbBalance.length;
        
        // ËÆÄÂèñ 11_ÊúÄÊñ∞ÂãïÊÖãCBASÂ†±ÂÉπË°®
        XLSX.utils.sheet_to_json(wb.Sheets['11_ÊúÄÊñ∞ÂãïÊÖãCBASÂ†±ÂÉπË°®']||[]).forEach(r => {
            const tcriVal = safe(r['Êìî‰øùÈäÄË°å/‰ø°Áî®Ë©ïÁ≠â(TCRI)']);
            // Âà§Êñ∑Êìî‰øùÔºöÂ¶ÇÊûúÊòØÁ¥îÊï∏Â≠óÊàñÂê´Êï∏Â≠óÁöÑË©ïÁ≠â(Â¶Ç twA+)ÂâáÁÑ°Êìî‰øùÔºåÊúâÈäÄË°åÂêçÁ®±ÂâáÊúâÊìî‰øù
            const isGuaranteed = tcriVal && !/^\d+$/.test(tcriVal) && /ÈäÄ|ÂïÜÈäÄ|ÂêàÂ∫´/.test(tcriVal);
            
            DB.cbCBAS.push({
                '_name': safe(r['ÂèØËΩâÂÇµÂêçÁ®±']),
                '_cbCode': safe(r['ÂèØËΩâÂÇµ‰ª£Á¢º']),
                '_tcri': tcriVal,
                '_guarantee': isGuaranteed ? 'Êúâ' : 'ÁÑ°',
                '_premium': r['Ê¨äÂà©Èáë(‰Ω∞ÂÖÉÂ†±ÂÉπ)'],
                '_optExpiry': r['ÈÅ∏ÊìáÊ¨äÂà∞ÊúüÊó•'],
                '_putPrice': r['Ë≥£ÂõûÂÉπÊ†º(A)'],
                '_putDate': r['Ë≥£ÂõûÊó•Êúü(B)'],
                '_remainYears': r['Ââ©È§òÂπ¥Êúü'],
                '_discountRate': r['ÊäòÁèæÁéá(C)'],
                '_premiumRef': r['Ê¨äÂà©ÈáëÂèÉËÄÉÂÉπ'],
                '_stockPrice': r['ÁèæËÇ°ÂèÉËÄÉÂÉπ'],
                '_convPrice': r['ËΩâÊèõÂÉπÊ†º'],
                '_convValue': r['CBËΩâÊèõÂÉπÂÄº'],
                '_cbPrice': r['CBÂèÉËÄÉÂÉπ'],
                '_premiumPct': r['Ê∫¢(Êäò)ÂÉπ%'],
                '_vol120': r['ËÇ°ÂÉπÊ≥¢ÂãïÁéá120Â§©%'],
                '_vol240': r['ËÇ°ÂÉπÊ≥¢ÂãïÁéá240Â§©%'],
                '_remainPct': r['ÊµÅÈÄöÈ§òÈ°çÂç†ÁôºË°åÁ∏ΩÈ°ç%'],
                '_origAmount': r['ÂéüÂßãÁôºË°åÈáè'],
                '_industry': safe(r['Áî¢Ê•≠'])
            });
        });
        META.cbCBASStats.total = DB.cbCBAS.length;
        
        // ËÆÄÂèñ 12_ÂÖ¨Âè∏Âü∑Ë°åË¥ñÂõûÊ¨ä
        XLSX.utils.sheet_to_json(wb.Sheets['12_ÂÖ¨Âè∏Âü∑Ë°åË¥ñÂõûÊ¨ä']||[]).forEach(r => {
            const subject = safe(r['‰∏ªÊó®']);
            // Âæû‰∏ªÊó®Ëß£ÊûêÁµÇÊ≠¢Ê´ÉÊ™ØË≤∑Ë≥£Êó•Êúü
            const endMatch = subject.match(/(\d{3})Âπ¥(\d{1,2})Êúà(\d{1,2})Êó•ÁµÇÊ≠¢Ê´ÉÊ™ØË≤∑Ë≥£/);
            let endDate = '';
            if(endMatch) {
                const year = parseInt(endMatch[1]) + 1911;
                endDate = `${year}/${endMatch[2].padStart(2,'0')}/${endMatch[3].padStart(2,'0')}`;
            }
            // Âæû‰∏ªÊó®Ëß£ÊûêCB‰ª£Ëôü
            const cbMatch = subject.match(/‰ª£Á¢º[Ôºö:](\d+)/);
            const cbCode = cbMatch ? cbMatch[1] : '';
            // Âæû‰∏ªÊó®Ëß£ÊûêCBÁ∞°Á®±
            const cbNameMatch = subject.match(/Á∞°Á®±[Ôºö:]([^Ôºå,]+)[Ôºå,]/);
            const cbName = cbNameMatch ? cbNameMatch[1] : '';
            
            // ÂèñÂæó CB Êî∂Áõ§ÂÉπÂíåÊéõÁâåÈ´ò‰Ωé
            const daily = dailyMap[cbCode] || {};
            const hl = cbHighLow[cbCode] || {};
            
            DB.cbRedeem.push({
                '_stockCode': normalizeCode(r['ÂÖ¨Âè∏‰ª£Ëôü']),
                '_name': safe(r['ÂÖ¨Âè∏ÂêçÁ®±']),
                '_cbCode': cbCode,
                '_cbName': cbName,
                '_reportDate': safe(r['Áî≥Â†±Êó•Êúü']),
                '_endDate': endDate,
                '_cbPrice': daily.cbPrice || 0,
                '_high': hl.high || 0,
                '_low': hl.low || 0,
                '_subject': subject,
                '_asoExpiry': r['ASOÂà∞ÊúüÊó•']
            });
        });
        
        // ËÆÄÂèñ 13_ÂÅúÊ≠¢ËΩâÊèõË≥áË®ä
        XLSX.utils.sheet_to_json(wb.Sheets['13_ÂÅúÊ≠¢ËΩâÊèõË≥áË®ä']||[]).forEach(r => {
            DB.cbStopConv.push({
                '_cbCode': safe(r['ÂÇµÂà∏‰ª£Á¢º']),
                '_name': safe(r['ÂÇµÂà∏Á∞°Á®±']),
                '_startDate': safe(r['ÂÅúÊ≠¢ËΩâ(‰∫§)ÊèõËµ∑Êó•']),
                '_endDate': safe(r['ÂÅúÊ≠¢ËΩâ(‰∫§)ÊèõËøÑÊó•']),
                '_reason': safe(r['ÂÅúÊ≠¢ËΩâ(‰∫§)Êèõ‰∫ãÁî±'])
            });
        });
        
        // ËÆÄÂèñ 14_ËΩâÊèõÂÉπÊ†ºË™øÊï¥
        XLSX.utils.sheet_to_json(wb.Sheets['14_ËΩâÊèõÂÉπÊ†ºË™øÊï¥']||[]).forEach(r => {
            const subject = safe(r['‰∏ªÊó®']);
            
            // Ëß£ÊûêË™øÊï¥Êó•Êúü
            const dateMatch = subject.match(/Ëá™(\d{3})Âπ¥(\d{1,2})Êúà(\d{1,2})Êó•Ëµ∑/);
            let adjDate = '';
            if(dateMatch) {
                const year = parseInt(dateMatch[1]) + 1911;
                adjDate = `${year}/${dateMatch[2].padStart(2,'0')}/${dateMatch[3].padStart(2,'0')}`;
            }
            
            // Ëß£ÊûêÂéüÂßãÂÉπÊ†ºÂíåË™øÊï¥ÂæåÂÉπÊ†º
            const priceMatch = subject.match(/ËΩâÊèõÂÉπÊ†ºËá™([\d.]+)ÂÖÉË™øÊï¥ÁÇ∫([\d.]+)ÂÖÉ/);
            const origPrice = priceMatch ? priceMatch[1] : '';
            const newPrice = priceMatch ? priceMatch[2] : '';
            
            // Ëß£Êûê CB ‰ª£ËôüÂíåÁ∞°Á®±
            const cbMatch = subject.match(/‰ª£Á¢º[Ôºö:](\d+)/);
            const cbCode = cbMatch ? cbMatch[1] : '';
            const nameMatch = subject.match(/Á∞°Á®±[Ôºö:]([^Ôºå,]+)[Ôºå,]/);
            const cbName = nameMatch ? nameMatch[1] : '';
            
            DB.cbPriceAdj.push({
                '_stockCode': normalizeCode(r['ÂÖ¨Âè∏‰ª£Ëôü']),
                '_name': safe(r['ÂÖ¨Âè∏ÂêçÁ®±']),
                '_cbCode': cbCode,
                '_cbName': cbName,
                '_adjDate': adjDate,
                '_origPrice': origPrice,
                '_newPrice': newPrice,
                '_subject': subject
            });
        });
        
        // Ë®àÁÆóÁµ±Ë®à
        META.cbStats.total = DB.cb.length;
        META.cbStats.historyTotal = DB.cbHistory.length;
        META.cbStats.auctionTotal = DB.cbAuction.length;
        const companies = new Set();
        let totalBal = 0;
        DB.cb.forEach(c => {
            if(c['_stockCode']) companies.add(c['_stockCode']);
            const bal = parseFloat(c['ÊúÄÊñ∞È§òÈ°ç(ÁôæËê¨)']) || 0;
            totalBal += bal;
        });
        META.cbStats.companies = companies.size;
        META.cbStats.totalBalance = totalBal;
        
        console.log('CBËºâÂÖ•:', DB.cb.length, 'Ê≠∑Âè≤CB:', DB.cbHistory.length, 'Á´∂Êãç:', DB.cbAuction.length, 
                    'ÊâøÈä∑‰∏≠:', DB.cbPrimary.length, 'Ëë£‰∫ãÊúÉ:', DB.cbBoard.length, 
                    'È§òÈ°ç:', DB.cbBalance.length, 'CBAS:', DB.cbCBAS.length,
                    'Âº∑Âà∂Ë¥ñÂõû:', DB.cbRedeem.length, 'ÂÅúÊ≠¢ËΩâÊèõ:', DB.cbStopConv.length, 'ÂÉπÊ†ºË™øÊï¥:', DB.cbPriceAdj.length);
    }

    // Êõ¥Êñ∞Ë®àÊï∏
    $('c-news').innerText = DB.news.length;
    $('c-memo').innerText = DB.memo.length;
    $('c-reports').innerText = DB.reports.length;
    $('c-strategy').innerText = DB.strategy.length;
    $('c-stocks').innerText = Object.keys(DB.stocks).length;
    $('c-trends').innerText = DB.trends.length;
    $('c-cb').innerText = DB.cb.length;

    // Á¢∫‰øùÈö±Ëóè loader
    setTimeout(() => { $('loader').classList.add('hidden'); }, 100);
    
    document.querySelectorAll('.db-tab').forEach(tab => {
        tab.onclick = () => {
            CURR_DB = tab.dataset.db;
            document.querySelectorAll('.db-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            renderList();
        };
    });
    
    renderList();
  } catch(e) {
    console.error('Init Error:', e);
    $('loader').classList.add('hidden');
    $('loadStatus').innerText = 'ËºâÂÖ•ÁôºÁîüÈåØË™§';
  }
}

// ÂÄãËÇ°Áµ±Ë®àÂçÄÂ°ä
function renderStockStats() {
    const stats = META.stockStats;
    const industries = Object.entries(stats.industries).sort((a,b) => b[1]-a[1]);
    const concepts = Object.entries(stats.conceptCategories).sort((a,b) => b[1]-a[1]);
    const markets = Object.entries(stats.markets).sort((a,b) => b[1]-a[1]);
    
    // È†ÅÁ±§ HTML
    const tabsHtml = `
        <div class="cb-mode-switcher">
            <span class="cb-mode-tab ${STOCK_MODE==='all'?'active':''}" onclick="setStockMode('all')">üè¢ ÂÖ®ÈÉ®ÂÄãËÇ°</span>
            <span class="cb-mode-tab ${STOCK_MODE==='concept'?'active':''}" onclick="setStockMode('concept')">üí° Ê¶ÇÂøµËÇ°</span>
        </div>
    `;
    
    if(STOCK_MODE === 'all') {
        // ÂÖ®ÈÉ®ÂÄãËÇ°Áµ±Ë®à
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.total}</div>
                        <div class="cb-stat-label">‰∏äÂ∏ÇÊ´ÉÂÖ¨Âè∏</div>
                    </div>
                    ${markets.slice(0, 4).map(([m, cnt]) => 
                        `<div class="cb-stat-item clickable" onclick="setSearch('${m}')">
                            <div class="cb-stat-num">${cnt}</div>
                            <div class="cb-stat-label">${m}</div>
                        </div>`
                    ).join('')}
                </div>
                <div class="cb-ind-title">üìä ÂêÑÁî¢Ê•≠ÂàÜ‰Ωà</div>
                <div class="cb-ind-grid">
                    ${industries.slice(0, 25).map(([ind, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${ind}')">${ind}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    } else if(STOCK_MODE === 'concept') {
        // Ê¶ÇÂøµËÇ°Áµ±Ë®à
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.conceptTotal}</div>
                        <div class="cb-stat-label">Ê¶ÇÂøµËÇ°Á≠ÜÊï∏</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${concepts.length}</div>
                        <div class="cb-stat-label">Ê¶ÇÂøµÂàÜÈ°ûÊï∏</div>
                    </div>
                </div>
                <div class="cb-ind-title">üí° ÁÜ±ÈñÄÊ¶ÇÂøµÂàÜÈ°û</div>
                <div class="cb-ind-grid">
                    ${concepts.slice(0, 30).map(([c, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${c}')">${c}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    return '';
}

// ÂàáÊèõÂÄãËÇ°Ê®°Âºè
function setStockMode(mode) {
    STOCK_MODE = mode;
    $('search').value = '';
    renderList();
}

// Memo Áµ±Ë®àÂçÄÂ°ä
function renderMemoStats() {
    const stats = META.memoStats;
    const brokers = Object.entries(stats.brokers).sort((a,b) => b[1]-a[1]);
    const types = Object.entries(stats.types).sort((a,b) => b[1]-a[1]);
    
    // È†ÅÁ±§ HTML
    const tabsHtml = `
        <div class="cb-mode-switcher">
            <span class="cb-mode-tab ${MEMO_MODE==='all'?'active':''}" onclick="setMemoMode('all')">üìã ÂÖ®ÈÉ®</span>
            <span class="cb-mode-tab ${MEMO_MODE==='stock'?'active':''}" onclick="setMemoMode('stock')">üè¢ ÂÄãËÇ°</span>
            <span class="cb-mode-tab ${MEMO_MODE==='industry'?'active':''}" onclick="setMemoMode('industry')">üè≠ Áî¢Ê•≠</span>
        </div>
    `;
    
    if(MEMO_MODE === 'all') {
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.total}</div>
                        <div class="cb-stat-label">MemoÁ∏ΩÊï∏</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setMemoMode('stock')">
                        <div class="cb-stat-num">${stats.stockTotal}</div>
                        <div class="cb-stat-label">ÂÄãËÇ°Â†±Âëä</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setMemoMode('industry')">
                        <div class="cb-stat-num">${stats.industryTotal}</div>
                        <div class="cb-stat-label">Áî¢Ê•≠Â†±Âëä</div>
                    </div>
                </div>
                <div class="cb-ind-title">üìä Â†±ÂëäÈ°ûÂûãÂàÜ‰Ωà</div>
                <div class="cb-ind-grid">
                    ${types.slice(0, 15).map(([t, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${t}')">${t}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    } else if(MEMO_MODE === 'stock') {
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.stockTotal}</div>
                        <div class="cb-stat-label">ÂÄãËÇ°Â†±ÂëäÊï∏</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${brokers.length}</div>
                        <div class="cb-stat-label">Âà∏ÂïÜÊï∏</div>
                    </div>
                </div>
                <div class="cb-ind-title">üè¶ ÂêÑÂà∏ÂïÜÂ†±ÂëäÊï∏</div>
                <div class="cb-ind-grid">
                    ${brokers.slice(0, 15).map(([b, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${b}')">${b}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    } else if(MEMO_MODE === 'industry') {
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.industryTotal}</div>
                        <div class="cb-stat-label">Áî¢Ê•≠Â†±ÂëäÊï∏</div>
                    </div>
                </div>
                <div class="cb-ind-title">üìä Áî¢Ê•≠Â†±ÂëäÈ°ûÂûã</div>
                <div class="cb-ind-grid">
                    ${types.filter(([t]) => t.includes('Áî¢Ê•≠') || t.includes('TPCA')).map(([t, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${t}')">${t}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    return '';
}

// ÂàáÊèõ Memo Ê®°Âºè
function setMemoMode(mode) {
    MEMO_MODE = mode;
    $('search').value = '';
    renderList();
}

// Á´∂ÊãçÂâçÂçÅÂêçË°®Ê†º
function renderAuctionTop10() {
    if(DB.cbAuction.length === 0) return '';
    
    // ÊúâÊìî‰øù - ÊúÄ‰ΩéÂæóÊ®ôÁî±È´òÂà∞‰ΩéÂâçÂçÅ
    const guarLowest = DB.cbAuction
        .filter(c => c._guarantee === 'ÊúâÊìî‰øù' && parseFloat(c['ÊúÄ‰ΩéÂæóÊ®ô']) > 0)
        .sort((a, b) => parseFloat(b['ÊúÄ‰ΩéÂæóÊ®ô']) - parseFloat(a['ÊúÄ‰ΩéÂæóÊ®ô']))
        .slice(0, 10);
    
    // ÁÑ°Êìî‰øù - ÊúÄ‰ΩéÂæóÊ®ôÁî±È´òÂà∞‰ΩéÂâçÂçÅ
    const noGuarLowest = DB.cbAuction
        .filter(c => c._guarantee === 'ÁÑ°Êìî‰øù' && parseFloat(c['ÊúÄ‰ΩéÂæóÊ®ô']) > 0)
        .sort((a, b) => parseFloat(b['ÊúÄ‰ΩéÂæóÊ®ô']) - parseFloat(a['ÊúÄ‰ΩéÂæóÊ®ô']))
        .slice(0, 10);
    
    // ÊúâÊìî‰øù - Âπ≥ÂùáÂæóÊ®ôÁî±È´òÂà∞‰ΩéÂâçÂçÅ
    const guarAvg = DB.cbAuction
        .filter(c => c._guarantee === 'ÊúâÊìî‰øù' && parseFloat(c['Âπ≥ÂùáÂæóÊ®ô']) > 0)
        .sort((a, b) => parseFloat(b['Âπ≥ÂùáÂæóÊ®ô']) - parseFloat(a['Âπ≥ÂùáÂæóÊ®ô']))
        .slice(0, 10);
    
    // ÁÑ°Êìî‰øù - Âπ≥ÂùáÂæóÊ®ôÁî±È´òÂà∞‰ΩéÂâçÂçÅ
    const noGuarAvg = DB.cbAuction
        .filter(c => c._guarantee === 'ÁÑ°Êìî‰øù' && parseFloat(c['Âπ≥ÂùáÂæóÊ®ô']) > 0)
        .sort((a, b) => parseFloat(b['Âπ≥ÂùáÂæóÊ®ô']) - parseFloat(a['Âπ≥ÂùáÂæóÊ®ô']))
        .slice(0, 10);
    
    const renderTable = (list, title, valueField) => {
        if(list.length === 0) return '';
        return `<div class="cb-ind-title" style="margin-top:15px">${title}</div>
        <div class="auction-top10-table">
            <table>
                <thead><tr><th>ÊéíÂêç</th><th>CB‰ª£Ëôü</th><th>ÂêçÁ®±</th><th>ÈñãÊ®ôÊó•</th><th>ÊúÄ‰ΩéÂæóÊ®ô</th><th>Âπ≥ÂùáÂæóÊ®ô</th><th>ÊúÄÊñ∞Êî∂Áõ§</th><th>ÊéõÁâåÊúÄÈ´ò</th><th>ÊéõÁâåÊúÄ‰Ωé</th><th>ÊäïÊ®ôÂÄçÊï∏</th></tr></thead>
                <tbody>
                ${list.map((c, i) => `<tr>
                    <td>${i+1}</td>
                    <td class="code">${c._cbCode}</td>
                    <td>${c._name}</td>
                    <td>${fmtDate(c['ÈñãÊ®ôÊó•Êúü'])}</td>
                    <td class="${valueField === 'ÊúÄ‰ΩéÂæóÊ®ô' ? 'highlight' : ''}">${fmtNum(c['ÊúÄ‰ΩéÂæóÊ®ô'], 2)}</td>
                    <td class="${valueField === 'Âπ≥ÂùáÂæóÊ®ô' ? 'highlight' : ''}">${fmtNum(c['Âπ≥ÂùáÂæóÊ®ô'], 2)}</td>
                    <td>${c._latestPrice > 0 ? fmtNum(c._latestPrice, 2) : '-'}</td>
                    <td>${c._high > 0 ? fmtNum(c._high, 2) : '-'}</td>
                    <td>${c._low > 0 ? fmtNum(c._low, 2) : '-'}</td>
                    <td>${fmtNum(c['ÊäïÊ®ôÂÄçÊï∏'], 2)}x</td>
                </tr>`).join('')}
                </tbody>
            </table>
        </div>`;
    };
    
    let html = '';
    html += renderTable(guarLowest, 'üèÜ ÊúâÊìî‰øùÔΩúÊúÄ‰ΩéÂæóÊ®ô Top 10ÔºàÁî±È´òÂà∞‰ΩéÔºâ', 'ÊúÄ‰ΩéÂæóÊ®ô');
    html += renderTable(noGuarLowest, 'üèÜ ÁÑ°Êìî‰øùÔΩúÊúÄ‰ΩéÂæóÊ®ô Top 10ÔºàÁî±È´òÂà∞‰ΩéÔºâ', 'ÊúÄ‰ΩéÂæóÊ®ô');
    html += renderTable(guarAvg, 'üèÜ ÊúâÊìî‰øùÔΩúÂπ≥ÂùáÂæóÊ®ô Top 10ÔºàÁî±È´òÂà∞‰ΩéÔºâ', 'Âπ≥ÂùáÂæóÊ®ô');
    html += renderTable(noGuarAvg, 'üèÜ ÁÑ°Êìî‰øùÔΩúÂπ≥ÂùáÂæóÊ®ô Top 10ÔºàÁî±È´òÂà∞‰ΩéÔºâ', 'Âπ≥ÂùáÂæóÊ®ô');
    
    return html;
}

// CB Áµ±Ë®àÂçÄÂ°ä - ‰πùÂÆÆÊ†ºÊñπÂ°äÁâà
function renderCBStats() {
    const stats = META.cbStats;
    const industries = Object.entries(stats.industries).sort((a,b) => b[1]-a[1]);
    const q = $('search').value.toLowerCase().trim();
    
    // Ê®°ÂºèÊ®ôÁ±§ HTMLÔºàÂ∞èÊ®ôÁ±§È¢®Ê†ºÔºâ
    const tabsHtml = `
        <div class="cb-mode-switcher">
            <span class="cb-mode-tab ${CB_MODE==='info'?'active':''}" onclick="setCbMode('info')">üìã Âü∫Êú¨Ë≥áÊñô</span>
            <span class="cb-mode-tab ${CB_MODE==='active'?'active':''}" onclick="setCbMode('active')">üé´ ÊéõÁâå‰∏≠</span>
            <span class="cb-mode-tab ${CB_MODE==='history'?'active':''}" onclick="setCbMode('history')">üìú Ê≠∑Âè≤</span>
            <span class="cb-mode-tab ${CB_MODE==='auction'?'active':''}" onclick="setCbMode('auction')">üî® Á´∂Êãç</span>
            <span class="cb-mode-tab ${CB_MODE==='primary'?'active':''}" onclick="setCbMode('primary')">üìù ÂàùÁ¥öÂ∏ÇÂ†¥</span>
            <span class="cb-mode-tab ${CB_MODE==='balance'?'active':''}" onclick="setCbMode('balance')">üìä ÊµÅÈÄöÈ§òÈ°ç</span>
            <span class="cb-mode-tab ${CB_MODE==='cbas'?'active':''}" onclick="setCbMode('cbas')">üíπ CBASÂ†±ÂÉπ</span>
            <span class="cb-mode-tab ${CB_MODE==='redeem'?'active':''}" onclick="setCbMode('redeem')">üîî Âº∑Âà∂Ë¥ñÂõû</span>
            <span class="cb-mode-tab ${CB_MODE==='stopconv'?'active':''}" onclick="setCbMode('stopconv')">‚è∏Ô∏è ÂÅúÊ≠¢ËΩâÊèõ</span>
            <span class="cb-mode-tab ${CB_MODE==='priceadj'?'active':''}" onclick="setCbMode('priceadj')">üí∞ ÂÉπÊ†ºË™øÊï¥</span>
            <span class="cb-mode-tab ${CB_MODE==='concept'?'active':''}" onclick="setCbMode('concept')">üí° Ê¶ÇÂøµËÇ°</span>
        </div>
    `;
    
    // Ë®àÁÆóÁØ©ÈÅ∏Ê®ôÁ±§Êï∏ÈáèÔºàÊ†πÊìöÁï∂ÂâçÊ®°ÂºèÔºâ
    let cbList = [];
    if(CB_MODE === 'active') cbList = DB.cb;
    else if(CB_MODE === 'history') cbList = DB.cbHistory;
    else if(CB_MODE === 'auction') cbList = DB.cbAuction;
    else if(CB_MODE === 'primary') cbList = PRIMARY_MODE === 'underwriting' ? DB.cbPrimary : DB.cbBoard;
    else if(CB_MODE === 'balance') cbList = DB.cbBalance;
    else if(CB_MODE === 'cbas') cbList = DB.cbCBAS;
    
    const methodCnt = { 'Ë©¢Âúà': 0, 'Á´∂Êãç': 0 };
    const guarCnt = { 'ÊúâÊìî‰øù': 0, 'ÁÑ°Êìî‰øù': 0 };
    cbList.forEach(c => {
        if(c._method === 'Ë©¢Âúà') methodCnt['Ë©¢Âúà']++;
        else if(c._method === 'Á´∂Êãç') methodCnt['Á´∂Êãç']++;
        if(c._guarantee === 'ÊúâÊìî‰øù') guarCnt['ÊúâÊìî‰øù']++;
        else if(c._guarantee === 'ÁÑ°Êìî‰øù' || c._guarantee === '0') guarCnt['ÁÑ°Êìî‰øù']++;
    });
    
    // ÁØ©ÈÅ∏ÁãÄÊÖãÈ°ØÁ§∫
    const hasFilter = CB_FILTER.industry || CB_FILTER.guarantee;
    const renderFilterBar = (filteredCount) => {
        if(!hasFilter) return '';
        const filters = [];
        if(CB_FILTER.industry) filters.push(`Áî¢Ê•≠Ôºö${CB_FILTER.industry}`);
        if(CB_FILTER.guarantee) filters.push(`Êìî‰øùÔºö${CB_FILTER.guarantee}`);
        return `
            <div class="cb-filter-bar">
                <div class="filter-text">üîç ${filters.join(' + ')} ‚Üí ÂÖ± <b>${filteredCount}</b> Ê™î</div>
                <button class="filter-clear" onclick="clearCbFilter()">‚úï Ê∏ÖÈô§</button>
            </div>
        `;
    };
    
    if(CB_MODE === 'info') {
        // Âü∫Êú¨Ë≥áÊñôÊ®°Âºè - Áµ±Ë®àÊâÄÊúâCB
        const allInd = {};
        const allMethod = { 'Ë©¢Âúà': 0, 'Á´∂Êãç': 0 };
        const allGuar = { 'ÊúâÊìî‰øù': 0, 'ÁÑ°Êìî‰øù': 0 };
        DB.cbAll.forEach(c => {
            const ind = c._industry || 'ÂÖ∂‰ªñ';
            allInd[ind] = (allInd[ind] || 0) + 1;
            if(c._method === 'Ë©¢Âúà') allMethod['Ë©¢Âúà']++;
            else if(c._method === 'Á´∂Êãç') allMethod['Á´∂Êãç']++;
            if(c._guarantee === 'ÊúâÊìî‰øù') allGuar['ÊúâÊìî‰øù']++;
            else if(c._guarantee === 'ÁÑ°Êìî‰øù' || c._guarantee === '0') allGuar['ÁÑ°Êìî‰øù']++;
        });
        const sortedAllInd = Object.entries(allInd).sort((a,b) => b[1]-a[1]);
        
        // Ë®àÁÆóÊéõÁâå‰∏≠Êï∏Èáè
        const activeCnt = DB.cb.length;
        const historyCnt = DB.cbAll.length - activeCnt;
        
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-info-tabs">
                    <span class="cb-sub-tab ${CB_INFO_TAB==='issue'?'active':''}" onclick="setCbInfoTab('issue')">üìù ÁôºË°åÊ¢ù‰ª∂</span>
                    <span class="cb-sub-tab ${CB_INFO_TAB==='timeline'?'active':''}" onclick="setCbInfoTab('timeline')">üìÖ ÊôÇÁ®ãË≥áË®ä</span>
                    <span class="cb-sub-tab ${CB_INFO_TAB==='putback'?'active':''}" onclick="setCbInfoTab('putback')">üí∞ Ë≥£ÂõûÊ¢ù‰ª∂</span>
                </div>
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${DB.cbAll.length}</div>
                        <div class="cb-stat-label">ÂÖ®ÈÉ®CB</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${activeCnt}</div>
                        <div class="cb-stat-label">ÊéõÁâå‰∏≠</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${historyCnt}</div>
                        <div class="cb-stat-label">Â∑≤‰∏ãÂ∏Ç</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('Ë©¢Âúà')">
                        <div class="cb-stat-num">${allMethod['Ë©¢Âúà']}</div>
                        <div class="cb-stat-label">Ë©¢Âúà</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('Á´∂Êãç')">
                        <div class="cb-stat-num">${allMethod['Á´∂Êãç']}</div>
                        <div class="cb-stat-label">Á´∂Êãç</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('ÊúâÊìî‰øù')">
                        <div class="cb-stat-num">${allGuar['ÊúâÊìî‰øù']}</div>
                        <div class="cb-stat-label">ÊúâÊìî‰øù</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('ÁÑ°Êìî‰øù')">
                        <div class="cb-stat-num">${allGuar['ÁÑ°Êìî‰øù']}</div>
                        <div class="cb-stat-label">ÁÑ°Êìî‰øù</div>
                    </div>
                </div>
                <div class="cb-ind-title">üìä ÂêÑÁî¢Ê•≠CBÂàÜ‰Ωà</div>
                <div class="cb-ind-grid">
                    ${sortedAllInd.slice(0, 20).map(([ind, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${ind}')">${ind}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    } else if(CB_MODE === 'active') {
        // ÊéõÁâå‰∏≠ CB Áµ±Ë®à
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.total}</div>
                        <div class="cb-stat-label">ÊéõÁâå‰∏≠CB</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.companies}</div>
                        <div class="cb-stat-label">ÁôºË°åÂÖ¨Âè∏Êï∏</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${fmtNum(stats.totalBalance/100, 0)}</div>
                        <div class="cb-stat-label">Á∏ΩÈ§òÈ°ç(ÂÑÑ)</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('Ë©¢Âúà')">
                        <div class="cb-stat-num">${methodCnt['Ë©¢Âúà']}</div>
                        <div class="cb-stat-label">Ë©¢Âúà</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('Á´∂Êãç')">
                        <div class="cb-stat-num">${methodCnt['Á´∂Êãç']}</div>
                        <div class="cb-stat-label">Á´∂Êãç</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('ÊúâÊìî‰øù')">
                        <div class="cb-stat-num">${guarCnt['ÊúâÊìî‰øù']}</div>
                        <div class="cb-stat-label">ÊúâÊìî‰øù</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('ÁÑ°Êìî‰øù')">
                        <div class="cb-stat-num">${guarCnt['ÁÑ°Êìî‰øù']}</div>
                        <div class="cb-stat-label">ÁÑ°Êìî‰øù</div>
                    </div>
                </div>
                <div class="cb-ind-title">üìä ÂêÑÁî¢Ê•≠CBÂàÜ‰Ωà</div>
                <div class="cb-ind-grid">
                    ${industries.slice(0, 20).map(([ind, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${ind}')">${ind}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    } else if(CB_MODE === 'history') {
        // Ê≠∑Âè≤ CB
        const historyInd = {};
        DB.cbHistory.forEach(c => {
            const ind = c._industry || 'ÂÖ∂‰ªñ';
            historyInd[ind] = (historyInd[ind] || 0) + 1;
        });
        const sortedHistInd = Object.entries(historyInd).sort((a,b) => b[1]-a[1]);
        
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${DB.cbHistory.length}</div>
                        <div class="cb-stat-label">Ê≠∑Âè≤CBÁ∏ΩÊï∏</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('Ë©¢Âúà')">
                        <div class="cb-stat-num">${methodCnt['Ë©¢Âúà']}</div>
                        <div class="cb-stat-label">Ë©¢Âúà</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('Á´∂Êãç')">
                        <div class="cb-stat-num">${methodCnt['Á´∂Êãç']}</div>
                        <div class="cb-stat-label">Á´∂Êãç</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('ÊúâÊìî‰øù')">
                        <div class="cb-stat-num">${guarCnt['ÊúâÊìî‰øù']}</div>
                        <div class="cb-stat-label">ÊúâÊìî‰øù</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('ÁÑ°Êìî‰øù')">
                        <div class="cb-stat-num">${guarCnt['ÁÑ°Êìî‰øù']}</div>
                        <div class="cb-stat-label">ÁÑ°Êìî‰øù</div>
                    </div>
                </div>
                <div class="cb-ind-title">üìä ÂêÑÁî¢Ê•≠Ê≠∑Âè≤CBÂàÜ‰Ωà</div>
                <div class="cb-ind-grid">
                    ${sortedHistInd.slice(0, 20).map(([ind, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${ind}')">${ind}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    } else if(CB_MODE === 'auction') {
        // Á´∂ÊãçÁµ±Ë®à - ‰ΩøÁî®Áç®Á´ãË®àÊï∏Âô®
        const auctionInd = {};
        const auctionGuar = { 'ÊúâÊìî‰øù': 0, 'ÁÑ°Êìî‰øù': 0 };
        let totalHigh = 0, totalLow = 0, totalRange = 0, validHighLowCnt = 0;
        let totalLowestBid = 0, totalMultiple = 0, bidCnt = 0, multipleCnt = 0;
        
        DB.cbAuction.forEach(c => {
            const ind = c._industry || 'ÂÖ∂‰ªñ';
            auctionInd[ind] = (auctionInd[ind] || 0) + 1;
            
            if(c._high > 0 && c._low > 0) {
                totalHigh += c._high;
                totalLow += c._low;
                totalRange += c._range;
                validHighLowCnt++;
            }
            
            const lowestBid = parseFloat(c['ÊúÄ‰ΩéÂæóÊ®ô']) || 0;
            if(lowestBid > 0) { totalLowestBid += lowestBid; bidCnt++; }
            
            const multiple = parseFloat(c['ÊäïÊ®ôÂÄçÊï∏']) || 0;
            if(multiple > 0) { totalMultiple += multiple; multipleCnt++; }
            
            if(c._guarantee === 'ÊúâÊìî‰øù') auctionGuar['ÊúâÊìî‰øù']++;
            else if(c._guarantee === 'ÁÑ°Êìî‰øù') auctionGuar['ÁÑ°Êìî‰øù']++;
        });
        
        // ÁØ©ÈÅ∏ÂæåÁöÑË≥áÊñôÁµ±Ë®à
        const filteredAuction = DB.cbAuction.filter(c => {
            let matchIndustry = true;
            let matchGuarantee = true;
            if(CB_FILTER.industry) matchIndustry = (c._industry || '') === CB_FILTER.industry;
            if(CB_FILTER.guarantee) {
                const guar = c._guarantee || '';
                if(CB_FILTER.guarantee === 'ÊúâÊìî‰øù') matchGuarantee = guar === 'ÊúâÊìî‰øù';
                else if(CB_FILTER.guarantee === 'ÁÑ°Êìî‰øù') matchGuarantee = guar === 'ÁÑ°Êìî‰øù' || guar === '0';
            }
            return matchIndustry && matchGuarantee;
        });
        
        // Ë®àÁÆóÁØ©ÈÅ∏ÂæåÁöÑÂπ≥ÂùáÂÄº
        let fHigh = 0, fLow = 0, fValidCnt = 0, fLowestBid = 0, fMultiple = 0, fBidCnt = 0, fMultipleCnt = 0;
        const fGuar = { 'ÊúâÊìî‰øù': 0, 'ÁÑ°Êìî‰øù': 0 };
        filteredAuction.forEach(c => {
            if(c._high > 0 && c._low > 0) { fHigh += c._high; fLow += c._low; fValidCnt++; }
            const lowestBid = parseFloat(c['ÊúÄ‰ΩéÂæóÊ®ô']) || 0;
            if(lowestBid > 0) { fLowestBid += lowestBid; fBidCnt++; }
            const multiple = parseFloat(c['ÊäïÊ®ôÂÄçÊï∏']) || 0;
            if(multiple > 0) { fMultiple += multiple; fMultipleCnt++; }
            if(c._guarantee === 'ÊúâÊìî‰øù') fGuar['ÊúâÊìî‰øù']++;
            else if(c._guarantee === 'ÁÑ°Êìî‰øù') fGuar['ÁÑ°Êìî‰øù']++;
        });
        
        const displayCnt = hasFilter ? filteredAuction.length : DB.cbAuction.length;
        const avgHigh = hasFilter ? (fValidCnt > 0 ? fHigh / fValidCnt : 0) : (validHighLowCnt > 0 ? totalHigh / validHighLowCnt : 0);
        const avgLow = hasFilter ? (fValidCnt > 0 ? fLow / fValidCnt : 0) : (validHighLowCnt > 0 ? totalLow / validHighLowCnt : 0);
        const avgLowestBid = hasFilter ? (fBidCnt > 0 ? fLowestBid / fBidCnt : 0) : (bidCnt > 0 ? totalLowestBid / bidCnt : 0);
        const avgMultiple = hasFilter ? (fMultipleCnt > 0 ? fMultiple / fMultipleCnt : 0) : (multipleCnt > 0 ? totalMultiple / multipleCnt : 0);
        const sortedAuctionInd = Object.entries(auctionInd).sort((a,b) => b[1]-a[1]);
        
        return `
            <div class="cb-stats">
                ${tabsHtml}
                ${renderFilterBar(filteredAuction.length)}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${displayCnt}</div>
                        <div class="cb-stat-label">${hasFilter ? 'Á¨¶ÂêàÊ¢ù‰ª∂' : 'Á´∂ÊãçCBÁ∏ΩÊï∏'}</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${fmtNum(avgHigh, 1)}</div>
                        <div class="cb-stat-label">Âπ≥ÂùáÊéõÁâåÈ´òÈªû</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${fmtNum(avgLow, 1)}</div>
                        <div class="cb-stat-label">Âπ≥ÂùáÊéõÁâå‰ΩéÈªû</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${fmtNum(avgLowestBid, 1)}</div>
                        <div class="cb-stat-label">Âπ≥ÂùáÊúÄ‰ΩéÂæóÊ®ô</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${fmtNum(avgMultiple, 1)}x</div>
                        <div class="cb-stat-label">Âπ≥ÂùáÊäïÊ®ôÂÄçÊï∏</div>
                    </div>
                    <div class="cb-stat-item clickable ${CB_FILTER.guarantee === 'ÊúâÊìî‰øù' ? 'active' : ''}" onclick="setCbFilter('guarantee', 'ÊúâÊìî‰øù')">
                        <div class="cb-stat-num">${hasFilter ? fGuar['ÊúâÊìî‰øù'] : auctionGuar['ÊúâÊìî‰øù']}</div>
                        <div class="cb-stat-label">ÊúâÊìî‰øù</div>
                    </div>
                    <div class="cb-stat-item clickable ${CB_FILTER.guarantee === 'ÁÑ°Êìî‰øù' ? 'active' : ''}" onclick="setCbFilter('guarantee', 'ÁÑ°Êìî‰øù')">
                        <div class="cb-stat-num">${hasFilter ? fGuar['ÁÑ°Êìî‰øù'] : auctionGuar['ÁÑ°Êìî‰øù']}</div>
                        <div class="cb-stat-label">ÁÑ°Êìî‰øù</div>
                    </div>
                </div>
                <div class="cb-ind-title">üìä ÂêÑÁî¢Ê•≠Á´∂ÊãçCBÂàÜ‰Ωà</div>
                <div class="cb-ind-grid">
                    ${sortedAuctionInd.slice(0, 20).map(([ind, cnt]) => 
                        `<div class="cb-ind-tag ${CB_FILTER.industry === ind ? 'active' : ''}" onclick="setCbFilter('industry', '${ind}')">${ind}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
                <div class="cb-ind-title" style="margin-top:15px">üîç Êìî‰øùÁØ©ÈÅ∏</div>
                <div class="cb-ind-grid">
                    <div class="cb-ind-tag ${CB_FILTER.guarantee === 'ÊúâÊìî‰øù' ? 'active' : ''}" onclick="setCbFilter('guarantee', 'ÊúâÊìî‰øù')">ÊúâÊìî‰øù<span class="num">${auctionGuar['ÊúâÊìî‰øù']}</span></div>
                    <div class="cb-ind-tag ${CB_FILTER.guarantee === 'ÁÑ°Êìî‰øù' ? 'active' : ''}" onclick="setCbFilter('guarantee', 'ÁÑ°Êìî‰øù')">ÁÑ°Êìî‰øù<span class="num">${auctionGuar['ÁÑ°Êìî‰øù']}</span></div>
                </div>
                ${renderAuctionTop10()}
            </div>
        `;
    } else if(CB_MODE === 'primary') {
        // ÂàùÁ¥öÂ∏ÇÂ†¥ - ÊâøÈä∑‰∏≠/Ëë£‰∫ãÊúÉ
        const primaryTabsHtml = `
            <div class="cb-sub-switcher">
                <span class="cb-sub-tab ${PRIMARY_MODE==='underwriting'?'active':''}" onclick="setPrimaryMode('underwriting')">üìã ÊâøÈä∑‰∏≠Ê°à‰ª∂</span>
                <span class="cb-sub-tab ${PRIMARY_MODE==='board'?'active':''}" onclick="setPrimaryMode('board')">üìù Ëë£‰∫ãÊúÉÂÖ¨Âëä</span>
            </div>
        `;
        
        if(PRIMARY_MODE === 'underwriting') {
            const brokerCnt = {};
            DB.cbPrimary.forEach(c => {
                const broker = c._broker || 'ÂÖ∂‰ªñ';
                brokerCnt[broker] = (brokerCnt[broker] || 0) + 1;
            });
            const sortedBrokers = Object.entries(brokerCnt).sort((a,b) => b[1]-a[1]);
            
            return `
                <div class="cb-stats">
                    ${tabsHtml}
                    ${primaryTabsHtml}
                    <div class="cb-stats-grid">
                        <div class="cb-stat-item">
                            <div class="cb-stat-num">${META.cbPrimaryStats.underwriting}</div>
                            <div class="cb-stat-label">ÊâøÈä∑‰∏≠Ê°à‰ª∂</div>
                        </div>
                        <div class="cb-stat-item clickable" onclick="setSearch('Á´∂Êãç')">
                            <div class="cb-stat-num">${DB.cbPrimary.filter(c => c._method === 'Á´∂Êãç').length}</div>
                            <div class="cb-stat-label">Á´∂Êãç</div>
                        </div>
                        <div class="cb-stat-item clickable" onclick="setSearch('Ë©¢Âúà')">
                            <div class="cb-stat-num">${DB.cbPrimary.filter(c => c._method === 'Ë©¢Âúà').length}</div>
                            <div class="cb-stat-label">Ë©¢Âúà</div>
                        </div>
                    </div>
                    <div class="cb-ind-title">üè¶ ÁôºË°åÂà∏ÂïÜÂàÜ‰Ωà</div>
                    <div class="cb-ind-grid">
                        ${sortedBrokers.slice(0, 15).map(([b, cnt]) => 
                            `<div class="cb-ind-tag" onclick="setSearch('${b}')">${b}<span class="num">${cnt}</span></div>`
                        ).join('')}
                    </div>
                </div>
            `;
        } else {
            const brokerCnt = {};
            DB.cbBoard.forEach(c => {
                const broker = c._broker || 'ÂÖ∂‰ªñ';
                brokerCnt[broker] = (brokerCnt[broker] || 0) + 1;
            });
            const sortedBrokers = Object.entries(brokerCnt).sort((a,b) => b[1]-a[1]);
            
            return `
                <div class="cb-stats">
                    ${tabsHtml}
                    ${primaryTabsHtml}
                    <div class="cb-stats-grid">
                        <div class="cb-stat-item">
                            <div class="cb-stat-num">${META.cbPrimaryStats.board}</div>
                            <div class="cb-stat-label">Ëë£‰∫ãÊúÉÂÖ¨Âëä</div>
                        </div>
                        <div class="cb-stat-item clickable" onclick="setSearch('Á´∂Êãç')">
                            <div class="cb-stat-num">${DB.cbBoard.filter(c => c._method === 'Á´∂Êãç' || c._method === 'Á´∂ÂÉπ').length}</div>
                            <div class="cb-stat-label">Á´∂Êãç</div>
                        </div>
                        <div class="cb-stat-item clickable" onclick="setSearch('Ë©¢Âúà')">
                            <div class="cb-stat-num">${DB.cbBoard.filter(c => c._method === 'Ë©¢Âúà').length}</div>
                            <div class="cb-stat-label">Ë©¢Âúà</div>
                        </div>
                    </div>
                    <div class="cb-ind-title">üè¶ ‰∏ªËæ¶Âà∏ÂïÜÂàÜ‰Ωà</div>
                    <div class="cb-ind-grid">
                        ${sortedBrokers.slice(0, 15).map(([b, cnt]) => 
                            `<div class="cb-ind-tag" onclick="setSearch('${b}')">${b}<span class="num">${cnt}</span></div>`
                        ).join('')}
                    </div>
                </div>
            `;
        }
    } else if(CB_MODE === 'balance') {
        // ÊµÅÈÄöÈ§òÈ°ç
        // Ë®àÁÆóÊ∏õÂπÖÂâçÂçÅÂêçÔºàÂ¢ûÊ∏õÊØîÁéáÁî±Â∞èÂà∞Â§ßÔºåË≤†Êï∏Ë∂äÂ§ßÊ∏õË∂äÂ§öÔºâ
        const topDecreaseRate = [...DB.cbBalance]
            .filter(c => parseFloat(c._changeRate) < 0)
            .sort((a, b) => parseFloat(a._changeRate) - parseFloat(b._changeRate))
            .slice(0, 10);
        
        // Ë®àÁÆóÊ∏õÂ∞ëÊï∏È°çÂâçÂçÅÂêçÔºàÂ¢ûÊ∏õÊï∏È°çÁî±Â∞èÂà∞Â§ßÔºåË≤†Êï∏Ë∂äÂ§ßÊ∏õË∂äÂ§öÔºâ
        const topDecreaseAmount = [...DB.cbBalance]
            .filter(c => parseFloat(c._change) < 0)
            .sort((a, b) => parseFloat(a._change) - parseFloat(b._change))
            .slice(0, 10);
        
        const renderBalanceTop10 = (list, title, highlightField) => {
            if(list.length === 0) return '';
            return `<div class="cb-ind-title" style="margin-top:15px">${title}</div>
            <div class="balance-top10-table">
                <table>
                    <thead><tr><th>ÂêçÊ¨°</th><th>‰ª£Ëôü</th><th>ÂêçÁ®±</th><th>Êú¨ÈÄ±</th><th>‰∏äÈÄ±</th><th>Â¢ûÊ∏õ</th><th>ÊØîÁéá</th><th>Ââ©È§ò%</th></tr></thead>
                    <tbody>
                    ${list.map((c, i) => `<tr>
                        <td>${i+1}</td>
                        <td class="code">${c._cbCode}</td>
                        <td class="name-cell">${c._name}</td>
                        <td>${fmtNum(c._thisWeek, 0)}</td>
                        <td>${fmtNum(c._lastWeek, 0)}</td>
                        <td class="${highlightField === '_change' ? 'highlight-red' : ''}">${fmtNum(c._change, 0)}</td>
                        <td class="${highlightField === '_changeRate' ? 'highlight-red' : ''}">${fmtNum(c._changeRate, 2)}%</td>
                        <td>${fmtNum(c._remainRate, 1)}%</td>
                    </tr>`).join('')}
                    </tbody>
                </table>
            </div>`;
        };
        
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${META.cbBalanceStats.total}</div>
                        <div class="cb-stat-label">CBÊ™îÊï∏</div>
                    </div>
                </div>
                ${renderBalanceTop10(topDecreaseRate, 'üìâ Êú¨ÈÄ±Ê∏õÂπÖÂâç10Âêç', '_changeRate')}
                ${renderBalanceTop10(topDecreaseAmount, 'üìâ Ê∏õÂ∞ëÊï∏È°çÂâç10Âêç', '_change')}
            </div>
        `;
    } else if(CB_MODE === 'cbas') {
        // CBASÂ†±ÂÉπ
        const industryCnt = {};
        DB.cbCBAS.forEach(c => {
            const ind = c._industry || 'ÂÖ∂‰ªñ';
            industryCnt[ind] = (industryCnt[ind] || 0) + 1;
        });
        const sortedInd = Object.entries(industryCnt).sort((a,b) => b[1]-a[1]);
        
        // Ë®àÁÆóÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑÊï∏ÈáèÔºöÂπ¥Êúü>2 ‰∏î Ê¨äÂà©Èáë<5
        const filteredCnt = DB.cbCBAS.filter(c => {
            const years = parseFloat(c._remainYears) || 0;
            const premium = parseFloat(c._premium) || 0;
            return years > 2 && premium < 5;
        }).length;
        
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${META.cbCBASStats.total}</div>
                        <div class="cb-stat-label">CBASÂ†±ÂÉπÊ™îÊï∏</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('Âπ¥Êúü>2 Ê¨äÂà©Èáë<5')">
                        <div class="cb-stat-num">${filteredCnt}</div>
                        <div class="cb-stat-label">Âπ¥Êúü>2‰∏îÊ¨äÂà©Èáë<5</div>
                    </div>
                </div>
                <div class="cb-ind-title">üìä ÂêÑÁî¢Ê•≠ÂàÜ‰Ωà</div>
                <div class="cb-ind-grid">
                    ${sortedInd.slice(0, 20).map(([ind, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${ind}')">${ind}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
                <div class="cb-ind-title" style="margin-top:15px">üîç Ê¢ù‰ª∂ÁØ©ÈÅ∏</div>
                <div class="cb-ind-grid">
                    <div class="cb-ind-tag" onclick="setSearch('Âπ¥Êúü>2 Ê¨äÂà©Èáë<5')">Âπ¥Êúü>2 ‰∏î Ê¨äÂà©Èáë<5<span class="num">${filteredCnt}</span></div>
                </div>
            </div>
        `;
    } else if(CB_MODE === 'redeem') {
        // Âº∑Âà∂Ë¥ñÂõû
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${DB.cbRedeem.length}</div>
                        <div class="cb-stat-label">Âº∑Âà∂Ë¥ñÂõûÂÖ¨Âëä</div>
                    </div>
                </div>
            </div>
        `;
    } else if(CB_MODE === 'stopconv') {
        // ÂÅúÊ≠¢ËΩâÊèõ
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${DB.cbStopConv.length}</div>
                        <div class="cb-stat-label">ÂÅúÊ≠¢ËΩâÊèõ‰∏≠</div>
                    </div>
                </div>
            </div>
        `;
    } else if(CB_MODE === 'priceadj') {
        // ËΩâÊèõÂÉπÊ†ºË™øÊï¥
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${DB.cbPriceAdj.length}</div>
                        <div class="cb-stat-label">ÂÉπÊ†ºË™øÊï¥ÂÖ¨Âëä</div>
                    </div>
                </div>
            </div>
        `;
    } else if(CB_MODE === 'concept') {
        // Ê¶ÇÂøµËÇ° CB
        // Ë®àÁÆóÂêÑÊ¶ÇÂøµËÇ°Â∞çÊáâÁöÑÊéõÁâå‰∏≠ CB Êï∏Èáè
        const conceptCbCounts = {};
        const conceptNames = ['ÂØåÊ´É50Êàê‰ªΩËÇ°', 'Âè∞ÁÅ£50Êàê‰ªΩËÇ°', '‰∏≠Âûã100Êàê‰ªΩËÇ°', 'NVDIAÊ¶ÇÂøµËÇ°', 'Âè∞Á©çÈõªÊ¶ÇÂøµËÇ°'];
        
        conceptNames.forEach(cName => {
            const stockCodes = DB.conceptLists[cName] || [];
            const cbCount = DB.cb.filter(cb => stockCodes.includes(cb._stockCode)).length;
            conceptCbCounts[cName] = cbCount;
        });
        
        // ÂèñÂæóÂéüÂßãÊêúÂ∞ãÂ≠ó‰∏≤Ôºà‰∏çËΩâÂ∞èÂØ´Ôºâ
        const searchVal = $('search').value.trim();
        
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${DB.cb.length}</div>
                        <div class="cb-stat-label">ÊéõÁâå‰∏≠CB</div>
                    </div>
                </div>
                <div class="cb-ind-title">üí° Ê¶ÇÂøµËÇ°ÂàÜÈ°û</div>
                <div class="cb-ind-grid">
                    ${conceptNames.map(cName => 
                        `<div class="cb-ind-tag ${searchVal === cName ? 'active' : ''}" onclick="setSearch('${cName}')">${cName.replace('Êàê‰ªΩËÇ°','').replace('Ê¶ÇÂøµËÇ°','')}<span class="num">${conceptCbCounts[cName]}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    return '';
}

// ÂàáÊèõÂàùÁ¥öÂ∏ÇÂ†¥Â≠êÊ®°Âºè
function setPrimaryMode(mode) {
    PRIMARY_MODE = mode;
    $('search').value = '';
    CB_FILTER = { industry: '', guarantee: '' }; // Ê∏ÖÈô§ÁØ©ÈÅ∏
    renderList();
}

// ÂàáÊèõ CB Ê®°Âºè
function setCbMode(mode) {
    CB_MODE = mode;
    $('search').value = '';
    CB_FILTER = { industry: '', guarantee: '' }; // ÂàáÊèõÊ®°ÂºèÊôÇÊ∏ÖÈô§ÁØ©ÈÅ∏
    renderList();
}

// CB ‰∫§ÈõÜÁØ©ÈÅ∏ - ÈªûÊìäÁî¢Ê•≠ÊàñÊìî‰øùÊ®ôÁ±§
function setCbFilter(type, value) {
    if(type === 'industry') {
        // Â¶ÇÊûúÂ∑≤ÈÅ∏‰∏≠Áõ∏ÂêåÁî¢Ê•≠ÔºåÂâáÂèñÊ∂àÈÅ∏Êìá
        CB_FILTER.industry = (CB_FILTER.industry === value) ? '' : value;
    } else if(type === 'guarantee') {
        // Â¶ÇÊûúÂ∑≤ÈÅ∏‰∏≠Áõ∏ÂêåÊìî‰øùÔºåÂâáÂèñÊ∂àÈÅ∏Êìá
        CB_FILTER.guarantee = (CB_FILTER.guarantee === value) ? '' : value;
    }
    renderList();
}

// Ê∏ÖÈô§ÊâÄÊúâCBÁØ©ÈÅ∏
function clearCbFilter() {
    CB_FILTER = { industry: '', guarantee: '' };
    renderList();
}

function setCbInfoTab(tab) {
    CB_INFO_TAB = tab;
    renderList();
}

function renderList() {
    const q = $('search').value.toLowerCase().trim();
    const qOriginal = $('search').value.trim(); // ‰øùÁïôÂéüÂßãÂ§ßÂ∞èÂØ´
    let list = [];
    
    // È°ØÁ§∫/Èö±ËóèÁµ±Ë®àÂçÄÂ°ä
    if(CURR_DB === 'cb') {
        $('cbStatsArea').innerHTML = renderCBStats();
        $('cbStatsArea').style.display = 'block';
        $('stockStatsArea').style.display = 'none';
        $('memoStatsArea').style.display = 'none';
        $('cbFilterTags').style.display = 'none';
    } else if(CURR_DB === 'stocks') {
        $('stockStatsArea').innerHTML = renderStockStats();
        $('stockStatsArea').style.display = 'block';
        $('cbStatsArea').style.display = 'none';
        $('memoStatsArea').style.display = 'none';
        $('cbFilterTags').style.display = 'none';
    } else if(CURR_DB === 'memo') {
        $('memoStatsArea').innerHTML = renderMemoStats();
        $('memoStatsArea').style.display = 'block';
        $('cbStatsArea').style.display = 'none';
        $('stockStatsArea').style.display = 'none';
        $('cbFilterTags').style.display = 'none';
    } else {
        $('cbStatsArea').style.display = 'none';
        $('stockStatsArea').style.display = 'none';
        $('memoStatsArea').style.display = 'none';
        $('cbFilterTags').style.display = 'none';
    }
    
    if(CURR_DB==='news') list = DB.news;
    else if(CURR_DB==='memo') {
        if(MEMO_MODE === 'all') list = DB.memo;
        else if(MEMO_MODE === 'stock') list = DB.memoStock;
        else if(MEMO_MODE === 'industry') list = DB.memoIndustry;
    }
    else if(CURR_DB==='reports') list = DB.reports;
    else if(CURR_DB==='strategy') list = DB.strategy;
    else if(CURR_DB==='stocks') {
        if(STOCK_MODE === 'all') list = Object.values(DB.stocks);
        else if(STOCK_MODE === 'concept') list = DB.conceptStocks;
    }
    else if(CURR_DB==='trends') list = DB.trends;
    else if(CURR_DB==='cb') {
        if(CB_MODE === 'info') list = DB.cbAll;
        else if(CB_MODE === 'active') list = DB.cb;
        else if(CB_MODE === 'history') list = DB.cbHistory;
        else if(CB_MODE === 'auction') list = DB.cbAuction;
        else if(CB_MODE === 'primary') list = PRIMARY_MODE === 'underwriting' ? DB.cbPrimary : DB.cbBoard;
        else if(CB_MODE === 'balance') list = DB.cbBalance;
        else if(CB_MODE === 'cbas') list = DB.cbCBAS;
        else if(CB_MODE === 'redeem') list = DB.cbRedeem;
        else if(CB_MODE === 'stopconv') list = DB.cbStopConv;
        else if(CB_MODE === 'priceadj') list = DB.cbPriceAdj;
        else if(CB_MODE === 'concept') list = DB.cb; // Ê¶ÇÂøµËÇ°Áî®ÊéõÁâå‰∏≠ CB
    }

    const filtered = list.filter(i => {
        const str = JSON.stringify(i).toLowerCase();
        
        // CB ‰∫§ÈõÜÁØ©ÈÅ∏ÔºàÁî¢Ê•≠ + Êìî‰øùÔºâ
        if(CURR_DB === 'cb' && (CB_FILTER.industry || CB_FILTER.guarantee)) {
            let matchIndustry = true;
            let matchGuarantee = true;
            
            // Áî¢Ê•≠ÁØ©ÈÅ∏
            if(CB_FILTER.industry) {
                const itemIndustry = i._industry || '';
                matchIndustry = itemIndustry === CB_FILTER.industry;
            }
            
            // Êìî‰øùÁØ©ÈÅ∏
            if(CB_FILTER.guarantee) {
                const itemGuarantee = i._guarantee || '';
                if(CB_FILTER.guarantee === 'ÊúâÊìî‰øù') {
                    matchGuarantee = itemGuarantee === 'ÊúâÊìî‰øù';
                } else if(CB_FILTER.guarantee === 'ÁÑ°Êìî‰øù') {
                    matchGuarantee = itemGuarantee === 'ÁÑ°Êìî‰øù' || itemGuarantee === '0';
                }
            }
            
            // ‰∫§ÈõÜÔºöÂøÖÈ†àÂêåÊôÇÁ¨¶ÂêàÂÖ©ÂÄãÊ¢ù‰ª∂
            if(!matchIndustry || !matchGuarantee) return false;
            
            // Â¶ÇÊûúÊúâÈ°çÂ§ñÁöÑÊêúÂ∞ãÂ≠ó‰∏≤Ôºå‰πüË¶ÅÁ¨¶Âêà
            if(q && !str.includes(q)) return false;
            
            return true;
        }
        
        // CBAS ÁâπÊÆäÊ¢ù‰ª∂ÁØ©ÈÅ∏
        if(CURR_DB === 'cb' && CB_MODE === 'cbas' && q === 'Âπ¥Êúü>2 Ê¨äÂà©Èáë<5') {
            const years = parseFloat(i._remainYears) || 0;
            const premium = parseFloat(i._premium) || 0;
            return years > 2 && premium < 5;
        }
        
        // Ê¶ÇÂøµËÇ°ÁØ©ÈÅ∏
        if(CURR_DB === 'cb' && CB_MODE === 'concept') {
            const conceptNames = ['ÂØåÊ´É50Êàê‰ªΩËÇ°', 'Âè∞ÁÅ£50Êàê‰ªΩËÇ°', '‰∏≠Âûã100Êàê‰ªΩËÇ°', 'NVDIAÊ¶ÇÂøµËÇ°', 'Âè∞Á©çÈõªÊ¶ÇÂøµËÇ°'];
            // Áî®ÂéüÂßãÂ§ßÂ∞èÂØ´ÊØîÂ∞ç
            const matchedConcept = conceptNames.find(c => c === qOriginal || c.toLowerCase() === q);
            if(matchedConcept) {
                const stockCodes = DB.conceptLists[matchedConcept] || [];
                // Ê™¢Êü• CB ÁöÑËΩâÊèõÊ®ôÁöÑ‰ª£Á¢ºÊòØÂê¶Âú®Ê¶ÇÂøµËÇ°Ê∏ÖÂñÆ‰∏≠
                const cbStockCode = i._stockCode || '';
                return stockCodes.includes(cbStockCode);
            }
            // Ê≤íÊúâÈÅ∏ÊìáÊ¶ÇÂøµËÇ°ÊôÇÈ°ØÁ§∫ÊâÄÊúâÊéõÁâå‰∏≠ CB
            if(!q) return true;
            // Â¶ÇÊûúÊúâÊêúÂ∞ãÂ≠ó‰∏≤‰ΩÜ‰∏çÊòØÊ¶ÇÂøµËÇ°ÂêçÁ®±ÔºåÈÄ≤Ë°å‰∏ÄËà¨ÊêúÂ∞ã
        }
        
        if(str.includes(q)) return true;
        if(CURR_DB==='memo' && i['Á∑®Ëôü']) {
            const d = META.memoDetail[i['Á∑®Ëôü']];
            if(d && JSON.stringify(d).toLowerCase().includes(q)) return true;
        }
        return false;
    });
    
    $('resCount').innerText = filtered.length;

    let html = '';
    
    // CB Áî®Ë°®Ê†ºÂΩ¢Âºè
    if(CURR_DB === 'cb') {
        // ÂàùÁ¥öÂ∏ÇÂ†¥„ÄÅÊµÅÈÄöÈ§òÈ°ç„ÄÅCBAS„ÄÅÂº∑Âà∂Ë¥ñÂõû„ÄÅÂÅúÊ≠¢ËΩâÊèõ„ÄÅÂÉπÊ†ºË™øÊï¥„ÄÅÂü∫Êú¨Ë≥áÊñô ‰∏çÈúÄË¶ÅÈÅéÊøæÊéõÁâåÈ´ò‰Ωé
        let validFiltered = filtered;
        const noFilterModes = ['primary', 'balance', 'cbas', 'redeem', 'stopconv', 'priceadj', 'info'];
        if(!noFilterModes.includes(CB_MODE)) {
            // ÈÅéÊøæÊéâÊéõÁâåÊúÄÈ´òÊàñÊúÄ‰ΩéÁÇ∫ 0 ÁöÑË≥áÊñôÔºàÂÉÖÈÅ©Áî®ÊñºÊéõÁâå‰∏≠„ÄÅÊ≠∑Âè≤„ÄÅÁ´∂ÊãçÔºâ
            validFiltered = filtered.filter(r => {
                const high = parseFloat(r['_high']) || 0;
                const low = parseFloat(r['_low']) || 0;
                return high > 0 && low > 0;
            });
        }
        
        // Êõ¥Êñ∞È°ØÁ§∫Á≠ÜÊï∏
        $('resCount').innerText = validFiltered.length;
        
        if(CB_MODE === 'info') {
            // Âü∫Êú¨Ë≥áÊñôÊ®°Âºè - Ê†πÊìöÂ≠êÊ®ôÁ±§È°ØÁ§∫‰∏çÂêåÊ¨Ñ‰Ωç
            if(CB_INFO_TAB === 'issue') {
                // ÁôºË°åÊ¢ù‰ª∂
                html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                    <thead><tr>
                        <th class="sortable" data-col="_cbCode" data-type="string">CB‰ª£Ëôü</th>
                        <th>CBÁ∞°Á®±</th>
                        <th class="sortable" data-col="_stockCode" data-type="string">ËÇ°Á•®</th>
                        <th class="sortable hide-mobile" data-col="_industry" data-type="string">Áî¢Ê•≠</th>
                        <th class="sortable" data-col="_method" data-type="string">Ë©¢/Á´∂</th>
                        <th class="sortable" data-col="_guarantee" data-type="string">Êìî‰øù</th>
                        <th class="sortable" data-col="_rating" data-type="num">‰ø°Ë©ï</th>
                        <th class="sortable hide-mobile" data-col="_scale" data-type="num">Ë¶èÊ®°</th>
                        <th class="sortable" data-col="_convPrice" data-type="num">ËΩâÊèõÂÉπ</th>
                        <th class="sortable hide-mobile" data-col="_years" data-type="num">Âπ¥Êúü</th>
                        <th class="sortable hide-mobile" data-col="_issuer" data-type="string">ÁôºË°åÂà∏ÂïÜ</th>
                    </tr></thead><tbody>`;
                
                validFiltered.slice(0, 150).forEach(r => {
                    const isActive = DB.cb.find(c => c._cbCode === r._cbCode);
                    const statusClass = isActive ? 'active-cb' : '';
                    html += `<tr class="${statusClass}">
                        <td class="code" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                        <td>${r._name || ''}</td>
                        <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode}</td>
                        <td class="hide-mobile">${r._industry || ''}</td>
                        <td>${r._method || ''}</td>
                        <td>${r._guarantee || ''}</td>
                        <td>${r._rating || ''}</td>
                        <td class="hide-mobile">${r._scale || ''}</td>
                        <td>${fmtNum(r._convPrice, 2)}</td>
                        <td class="hide-mobile">${r._years || ''}</td>
                        <td class="hide-mobile">${r._issuer || ''}</td>
                    </tr>`;
                });
            } else if(CB_INFO_TAB === 'timeline') {
                // ÊôÇÁ®ãË≥áË®ä
                html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                    <thead><tr>
                        <th class="sortable" data-col="_cbCode" data-type="string">CB‰ª£Ëôü</th>
                        <th>CBÁ∞°Á®±</th>
                        <th class="sortable" data-col="_stockCode" data-type="string">ËÇ°Á•®</th>
                        <th class="sortable" data-col="_boardDate" data-type="date">Ëë£‰∫ãÊúÉ</th>
                        <th class="sortable hide-mobile" data-col="_sendDate" data-type="date">ÈÄÅ‰ª∂Êó•</th>
                        <th class="sortable hide-mobile" data-col="_effectDate" data-type="date">ÁîüÊïàÊó•</th>
                        <th class="sortable" data-col="_bidDate" data-type="string">Ë©¢/Á´∂Êó•Êúü</th>
                        <th class="sortable" data-col="_listDate" data-type="date">ÊéõÁâåÊó•</th>
                        <th class="sortable" data-col="_expDate" data-type="date">Âà∞ÊúüÊó•</th>
                        <th class="sortable hide-mobile" data-col="_cbasDate" data-type="date">CBASÊãÜËß£</th>
                    </tr></thead><tbody>`;
                
                validFiltered.slice(0, 150).forEach(r => {
                    const isActive = DB.cb.find(c => c._cbCode === r._cbCode);
                    const statusClass = isActive ? 'active-cb' : '';
                    html += `<tr class="${statusClass}">
                        <td class="code" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                        <td>${r._name || ''}</td>
                        <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode}</td>
                        <td>${fmtDate(r._boardDate)}</td>
                        <td class="hide-mobile">${fmtDate(r._sendDate)}</td>
                        <td class="hide-mobile">${fmtDate(r._effectDate)}</td>
                        <td>${r._bidDate || ''}</td>
                        <td>${fmtDate(r._listDate)}</td>
                        <td>${fmtDate(r._expDate)}</td>
                        <td class="hide-mobile">${fmtDate(r._cbasDate)}</td>
                    </tr>`;
                });
            } else if(CB_INFO_TAB === 'putback') {
                // Ë≥£ÂõûÊ¢ù‰ª∂
                html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                    <thead><tr>
                        <th class="sortable" data-col="_cbCode" data-type="string">CB‰ª£Ëôü</th>
                        <th>CBÁ∞°Á®±</th>
                        <th class="sortable" data-col="_stockCode" data-type="string">ËÇ°Á•®</th>
                        <th class="sortable" data-col="_listDate" data-type="date">ÊéõÁâåÊó•</th>
                        <th class="sortable" data-col="_expDate" data-type="date">Âà∞ÊúüÊó•</th>
                        <th class="sortable" data-col="_putDate1" data-type="date">Ë≥£ÂõûÊó•1</th>
                        <th class="sortable" data-col="_putDate2" data-type="date">Ë≥£ÂõûÊó•2</th>
                        <th class="sortable" data-col="_putTiming" data-type="string">Ë≥£ÂõûÊôÇÊ©ü</th>
                        <th>Ë≥£ÂõûÊ¢ù‰ª∂</th>
                    </tr></thead><tbody>`;
                
                validFiltered.slice(0, 150).forEach(r => {
                    const isActive = DB.cb.find(c => c._cbCode === r._cbCode);
                    const statusClass = isActive ? 'active-cb' : '';
                    html += `<tr class="${statusClass}">
                        <td class="code" onclick="openCbInfo('${r._cbCode}')">${r._cbCode}</td>
                        <td>${r._name || ''}</td>
                        <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode}</td>
                        <td>${fmtDate(r._listDate)}</td>
                        <td>${fmtDate(r._expDate)}</td>
                        <td>${fmtDate(r._putDate1)}</td>
                        <td>${fmtDate(r._putDate2)}</td>
                        <td>${r._putTiming || ''}</td>
                        <td style="max-width:150px;white-space:normal;text-align:left">${r._putCondition || ''}</td>
                    </tr>`;
                });
            }
            html += `</tbody></table></div>`;
        } else if(CB_MODE === 'auction') {
            // Á´∂ÊãçÊ®°ÂºèÂ∞àÂ±¨Ë°®Ê†º
            // Ë®àÁÆóÂπ≥ÂùáÂÄº
            const avgMultiple = validFiltered.reduce((s, r) => s + (parseFloat(r['ÊäïÊ®ôÂÄçÊï∏']) || 0), 0) / (validFiltered.length || 1);
            const avgTheory = validFiltered.reduce((s, r) => s + (parseFloat(r['ÁêÜË´ñÂÉπ']) || 0), 0) / (validFiltered.length || 1);
            const avgLowestBid = validFiltered.reduce((s, r) => s + (parseFloat(r['ÊúÄ‰ΩéÂæóÊ®ô']) || 0), 0) / (validFiltered.length || 1);
            const avgLowestPrem = validFiltered.reduce((s, r) => s + (parseFloat(r['ÊúÄ‰ΩéÊ∫¢ÂÉπ']) || 0), 0) / (validFiltered.length || 1);
            const avgAvgBid = validFiltered.reduce((s, r) => s + (parseFloat(r['Âπ≥ÂùáÂæóÊ®ô']) || 0), 0) / (validFiltered.length || 1);
            const avgAvgPrem = validFiltered.reduce((s, r) => s + (parseFloat(r['Âπ≥ÂùáÊ∫¢ÂÉπ']) || 0), 0) / (validFiltered.length || 1);
            const avgHigh = validFiltered.reduce((s, r) => s + (parseFloat(r['_high']) || 0), 0) / (validFiltered.length || 1);
            const avgLow = validFiltered.reduce((s, r) => s + (parseFloat(r['_low']) || 0), 0) / (validFiltered.length || 1);
            const avgRange = validFiltered.reduce((s, r) => s + (parseFloat(r['_range']) || 0), 0) / (validFiltered.length || 1);
            
            html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                <thead><tr>
                    <th class="sortable" data-col="_cbCode" data-type="string">CB‰ª£Ëôü</th>
                    <th>CBÁ∞°Á®±</th>
                    <th class="sortable hide-mobile" data-col="ÈñãÊ®ôÊó•Êúü" data-type="date">ÈñãÊ®ôÊó•</th>
                    <th class="sortable" data-col="ÊäïÊ®ôÂÄçÊï∏" data-type="num">ÊäïÊ®ôÂÄçÊï∏</th>
                    <th class="sortable hide-mobile" data-col="ÁêÜË´ñÂÉπ" data-type="num">ÁêÜË´ñÂÉπ</th>
                    <th class="sortable" data-col="ÊúÄ‰ΩéÂæóÊ®ô" data-type="num">ÊúÄ‰ΩéÂæóÊ®ô</th>
                    <th class="sortable hide-mobile" data-col="ÊúÄ‰ΩéÊ∫¢ÂÉπ" data-type="num">ÊúÄ‰ΩéÊ∫¢ÂÉπ</th>
                    <th class="sortable" data-col="Âπ≥ÂùáÂæóÊ®ô" data-type="num">Âπ≥ÂùáÂæóÊ®ô</th>
                    <th class="sortable hide-mobile" data-col="Âπ≥ÂùáÊ∫¢ÂÉπ" data-type="num">Âπ≥ÂùáÊ∫¢ÂÉπ</th>
                    <th class="sortable" data-col="_high" data-type="num">ÊéõÁâåÊúÄÈ´ò</th>
                    <th class="sortable" data-col="_low" data-type="num">ÊéõÁâåÊúÄ‰Ωé</th>
                    <th class="sortable" data-col="_range" data-type="num">ÈúáÂπÖ%</th>
                </tr></thead><tbody>`;
            
            validFiltered.slice(0, 100).forEach(r => {
                const cbCode = r['_cbCode'];
                const cbName = r['_name'];
                const openDate = fmtDate(r['ÈñãÊ®ôÊó•Êúü']);
                const multiple = r['ÊäïÊ®ôÂÄçÊï∏'];
                const theory = r['ÁêÜË´ñÂÉπ'];
                const lowestBid = r['ÊúÄ‰ΩéÂæóÊ®ô'];
                const lowestPrem = parseFloat(r['ÊúÄ‰ΩéÊ∫¢ÂÉπ']) || 0;
                const avgBid = r['Âπ≥ÂùáÂæóÊ®ô'];
                const avgPrem = parseFloat(r['Âπ≥ÂùáÊ∫¢ÂÉπ']) || 0;
                const high = r['_high'];
                const low = r['_low'];
                const range = r['_range'];
                
                html += `<tr>
                    <td class="code">${cbCode}</td>
                    <td>${cbName}</td>
                    <td class="hide-mobile">${openDate}</td>
                    <td>${fmtNum(multiple, 2)}x</td>
                    <td class="hide-mobile">${fmtNum(theory, 2)}</td>
                    <td>${fmtNum(lowestBid, 2)}</td>
                    <td class="hide-mobile ${colorClass(lowestPrem * 100)}">${fmtNum(lowestPrem * 100, 1)}%</td>
                    <td>${fmtNum(avgBid, 2)}</td>
                    <td class="hide-mobile ${colorClass(avgPrem * 100)}">${fmtNum(avgPrem * 100, 1)}%</td>
                    <td>${fmtNum(high, 1)}</td>
                    <td>${fmtNum(low, 1)}</td>
                    <td class="${colorClass(range)}">${fmtNum(range, 1)}%</td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr class="summary-row">
                <td colspan="2"><b>Âπ≥ÂùáÂÄº (${validFiltered.length} Á≠Ü)</b></td>
                <td class="hide-mobile"></td>
                <td><b>${fmtNum(avgMultiple, 2)}x</b></td>
                <td class="hide-mobile"><b>${fmtNum(avgTheory, 2)}</b></td>
                <td><b>${fmtNum(avgLowestBid, 2)}</b></td>
                <td class="hide-mobile"><b>${fmtNum(avgLowestPrem * 100, 1)}%</b></td>
                <td><b>${fmtNum(avgAvgBid, 2)}</b></td>
                <td class="hide-mobile"><b>${fmtNum(avgAvgPrem * 100, 1)}%</b></td>
                <td><b>${fmtNum(avgHigh, 1)}</b></td>
                <td><b>${fmtNum(avgLow, 1)}</b></td>
                <td><b>${fmtNum(avgRange, 1)}%</b></td>
            </tr></tfoot></table></div>`;
        } else if(CB_MODE === 'primary') {
            // ÂàùÁ¥öÂ∏ÇÂ†¥Ë°®Ê†º
            if(PRIMARY_MODE === 'underwriting') {
                html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                    <thead><tr>
                        <th>ËÇ°Á•®‰ª£Ëôü</th>
                        <th>CB‰ª£Ëôü</th>
                        <th>ÁôºË°åÊ®ôÁöÑ</th>
                        <th class="hide-mobile">Ë©¢Âúà/Á´∂Êãç</th>
                        <th class="hide-mobile">TCRI</th>
                        <th>ÁôºË°åÈáè(ÂÑÑ)</th>
                        <th class="hide-mobile">ÁôºË°åÂà∏ÂïÜ</th>
                        <th class="hide-mobile">ÊäïÊ®ôÊúüÈñì</th>
                        <th>ËΩâÊèõÂÉπ</th>
                        <th class="hide-mobile">Ê∫¢ÂÉπÁéá</th>
                        <th class="hide-mobile">ÊéõÁâåÊó•</th>
                    </tr></thead><tbody>`;
                
                validFiltered.slice(0, 100).forEach(r => {
                    html += `<tr>
                        <td class="code">${r._stockCode}</td>
                        <td>${r._cbCode}</td>
                        <td>${r._name}</td>
                        <td class="hide-mobile">${r._method}</td>
                        <td class="hide-mobile">${r._tcri}</td>
                        <td>${fmtNum(r._amount, 0)}</td>
                        <td class="hide-mobile">${r._broker}</td>
                        <td class="hide-mobile">${r._bidPeriod}</td>
                        <td>${fmtNum(r._convPrice, 2)}</td>
                        <td class="hide-mobile">${fmtNum(parseFloat(r._premium)*100, 1)}%</td>
                        <td class="hide-mobile">${fmtDate(r._listDate)}</td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            } else {
                // Ëë£‰∫ãÊúÉÂÖ¨Âëä
                html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                    <thead><tr>
                        <th>ËÇ°Á•®‰ª£Ëôü</th>
                        <th>CB‰ª£Á¢º</th>
                        <th>ÁôºË°åÊ®ôÁöÑ</th>
                        <th class="hide-mobile">Ë©¢Âúà/Á´∂ÂÉπ</th>
                        <th class="hide-mobile">TCRI</th>
                        <th>ÁôºË°åÈáè(ÂÑÑ)</th>
                        <th class="hide-mobile">‰∏ªËæ¶Âà∏ÂïÜ</th>
                        <th>Ëë£‰∫ãÊúÉÈÄöÈÅé</th>
                        <th class="hide-mobile">ËÇ°Êú¨(ÂÑÑ)</th>
                        <th class="hide-mobile">ÂÇôË®ª</th>
                    </tr></thead><tbody>`;
                
                validFiltered.slice(0, 100).forEach(r => {
                    html += `<tr>
                        <td class="code">${r._stockCode}</td>
                        <td>${r._cbCode}</td>
                        <td>${r._name}</td>
                        <td class="hide-mobile">${r._method}</td>
                        <td class="hide-mobile">${r._tcri}</td>
                        <td>${fmtNum(r._amount, 0)}</td>
                        <td class="hide-mobile">${r._broker}</td>
                        <td>${fmtDate(r._boardDate)}</td>
                        <td class="hide-mobile">${fmtNum(r._capital, 1)}</td>
                        <td class="hide-mobile">${r._note || ''}</td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            }
        } else if(CB_MODE === 'balance') {
            // ÊµÅÈÄöÈ§òÈ°çË°®Ê†º
            html = `<div class="cb-table-wrap"><table class="cb-table balance-table" id="cbTable">
                <thead><tr>
                    <th class="sortable" data-col="_cbCode" data-type="string">‰ª£Ëôü</th>
                    <th>ÂêçÁ®±</th>
                    <th class="sortable" data-col="_thisWeek" data-type="num">Êú¨ÈÄ±</th>
                    <th class="sortable" data-col="_lastWeek" data-type="num">‰∏äÈÄ±</th>
                    <th class="sortable" data-col="_change" data-type="num">Â¢ûÊ∏õ</th>
                    <th class="sortable" data-col="_changeRate" data-type="num">ÊØîÁéá%</th>
                    <th class="sortable" data-col="_remainRate" data-type="num">Ââ©È§ò%</th>
                </tr></thead><tbody>`;
            
            validFiltered.slice(0, 150).forEach(r => {
                const change = parseFloat(r._change) || 0;
                const changeRate = parseFloat(r._changeRate) || 0;
                html += `<tr>
                    <td class="code">${r._cbCode}</td>
                    <td class="name-col">${r._name}</td>
                    <td>${fmtNum(r._thisWeek, 0)}</td>
                    <td>${fmtNum(r._lastWeek, 0)}</td>
                    <td class="${change > 0 ? 'up' : change < 0 ? 'down' : ''}">${change !== 0 ? fmtNum(change, 0) : '-'}</td>
                    <td class="${changeRate > 0 ? 'up' : changeRate < 0 ? 'down' : ''}">${changeRate !== 0 ? fmtNum(changeRate, 2)+'%' : '-'}</td>
                    <td>${fmtNum(r._remainRate, 0)}%</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else if(CB_MODE === 'cbas') {
            // CBASÂ†±ÂÉπË°®Ê†º
            html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                <thead><tr>
                    <th class="sortable" data-col="_cbCode" data-type="string">‰ª£Ëôü</th>
                    <th>ÂêçÁ®±</th>
                    <th class="sortable" data-col="_guarantee" data-type="string">Êìî‰øù</th>
                    <th class="sortable" data-col="_remainYears" data-type="num">Âπ¥Êúü</th>
                    <th class="sortable" data-col="_premium" data-type="num">Ê¨äÂà©Èáë</th>
                    <th class="sortable" data-col="_convPrice" data-type="num">ËΩâÊèõÂÉπ</th>
                    <th class="sortable" data-col="_stockPrice" data-type="num">ËÇ°ÂÉπ</th>
                    <th class="sortable hide-mobile" data-col="_convValue" data-type="num">ËΩâÊèõÂÉπÂÄº</th>
                    <th class="sortable" data-col="_premiumPct" data-type="num">Ê∫¢ÊäòÂÉπ%</th>
                    <th class="sortable hide-mobile" data-col="_vol120" data-type="num">Ê≥¢ÂãïÁéá</th>
                    <th class="hide-mobile">Áî¢Ê•≠</th>
                </tr></thead><tbody>`;
            
            validFiltered.slice(0, 150).forEach(r => {
                const premPct = parseFloat(r._premiumPct) || 0;
                html += `<tr>
                    <td class="code">${r._cbCode}</td>
                    <td class="name-col">${r._name}</td>
                    <td>${r._guarantee}</td>
                    <td>${fmtNum(r._remainYears, 2)}</td>
                    <td>${fmtNum(r._premium, 2)}</td>
                    <td>${fmtNum(r._convPrice, 2)}</td>
                    <td>${fmtNum(r._stockPrice, 2)}</td>
                    <td class="hide-mobile">${fmtNum(r._convValue, 2)}</td>
                    <td class="${colorClass(premPct)}">${fmtNum(premPct, 1)}%</td>
                    <td class="hide-mobile">${fmtNum(parseFloat(r._vol120)*100, 1)}%</td>
                    <td class="hide-mobile">${r._industry || ''}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else if(CB_MODE === 'redeem') {
            // Âº∑Âà∂Ë¥ñÂõûË°®Ê†º
            html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                <thead><tr>
                    <th>CB‰ª£Ëôü</th>
                    <th>CBÁ∞°Á®±</th>
                    <th>Áî≥Â†±Êó•Êúü</th>
                    <th>ÁµÇÊ≠¢Ë≤∑Ë≥£Êó•</th>
                    <th>ÊéõÁâåÊúÄÈ´ò</th>
                    <th>ÊéõÁâåÊúÄ‰Ωé</th>
                    <th>CBÊî∂Áõ§</th>
                    <th class="hide-mobile">‰∏ªÊó®</th>
                </tr></thead><tbody>`;
            
            validFiltered.forEach(r => {
                html += `<tr>
                    <td class="code">${r._cbCode}</td>
                    <td>${r._cbName}</td>
                    <td>${r._reportDate}</td>
                    <td>${r._endDate}</td>
                    <td>${fmtNum(r._high, 2)}</td>
                    <td>${fmtNum(r._low, 2)}</td>
                    <td>${fmtNum(r._cbPrice, 2)}</td>
                    <td class="hide-mobile subject-col">${r._subject}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else if(CB_MODE === 'stopconv') {
            // ÂÅúÊ≠¢ËΩâÊèõË°®Ê†º
            html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                <thead><tr>
                    <th>ÂÇµÂà∏‰ª£Á¢º</th>
                    <th>ÂÇµÂà∏Á∞°Á®±</th>
                    <th>ÂÅúÊ≠¢Ëµ∑Êó•</th>
                    <th>ÂÅúÊ≠¢ËøÑÊó•</th>
                    <th>‰∫ãÁî±</th>
                </tr></thead><tbody>`;
            
            validFiltered.forEach(r => {
                html += `<tr>
                    <td class="code">${r._cbCode}</td>
                    <td>${r._name}</td>
                    <td>${r._startDate}</td>
                    <td>${r._endDate}</td>
                    <td>${r._reason}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else if(CB_MODE === 'priceadj') {
            // ËΩâÊèõÂÉπÊ†ºË™øÊï¥Ë°®Ê†º
            html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                <thead><tr>
                    <th>CB‰ª£Ëôü</th>
                    <th>CBÁ∞°Á®±</th>
                    <th>Ë™øÊï¥Êó•Êúü</th>
                    <th>ÂéüÂßãÂÉπÊ†º</th>
                    <th>Ë™øÊï¥ÂæåÂÉπÊ†º</th>
                    <th class="hide-mobile">‰∏ªÊó®</th>
                </tr></thead><tbody>`;
            
            validFiltered.forEach(r => {
                const origPrice = parseFloat(r._origPrice) || 0;
                const newPrice = parseFloat(r._newPrice) || 0;
                const priceChange = newPrice - origPrice;
                html += `<tr>
                    <td class="code">${r._cbCode}</td>
                    <td>${r._cbName}</td>
                    <td>${r._adjDate}</td>
                    <td>${r._origPrice}</td>
                    <td class="${priceChange < 0 ? 'down' : priceChange > 0 ? 'up' : ''}">${r._newPrice}</td>
                    <td class="hide-mobile subject-col">${r._subject}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else {
            // ÊéõÁâå‰∏≠ / Ê≠∑Âè≤ Ê®°ÂºèË°®Ê†º
            // Ë®àÁÆóÂπ≥ÂùáÂÄº
            const validData = validFiltered.filter(r => r['_premium'] !== null && r['_premium'] !== undefined);
            const avgConvPrice = validData.reduce((s, r) => s + (parseFloat(r['ËΩâÊèõÂÉπÊ†º(ÂÖÉ)']) || 0), 0) / (validData.length || 1);
            const avgStockPrice = validData.reduce((s, r) => s + (parseFloat(r['_stockPrice']) || 0), 0) / (validData.length || 1);
            const avgConvValue = validData.reduce((s, r) => s + (parseFloat(r['_convValue']) || 0), 0) / (validData.length || 1);
            const avgPremium = validData.reduce((s, r) => s + (parseFloat(r['_premium']) || 0), 0) / (validData.length || 1);
            const avgHigh = validFiltered.reduce((s, r) => s + (parseFloat(r['_high']) || 0), 0) / (validFiltered.length || 1);
            const avgLow = validFiltered.reduce((s, r) => s + (parseFloat(r['_low']) || 0), 0) / (validFiltered.length || 1);
            const avgRange = validFiltered.reduce((s, r) => s + (parseFloat(r['_range']) || 0), 0) / (validFiltered.length || 1);
            
            html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                <thead><tr>
                    <th class="sortable" data-col="_cbCode" data-type="string">CB‰ª£Ëôü <span class="sort-icon">‚áÖ</span></th>
                    <th>CBÁ∞°Á®±</th>
                    <th class="hide-mobile">Ê®ôÁöÑËÇ°Á•®</th>
                    <th class="sortable hide-mobile" data-col="_industry" data-type="string">Áî¢Ê•≠ <span class="sort-icon">‚áÖ</span></th>
                    <th class="sortable hide-mobile" data-col="convPrice" data-type="num">ËΩâÊèõÂÉπ <span class="sort-icon">‚áÖ</span></th>
                    <th class="sortable hide-mobile" data-col="_stockPrice" data-type="num">ËÇ°ÂÉπ <span class="sort-icon">‚áÖ</span></th>
                    <th class="sortable hide-mobile" data-col="_convValue" data-type="num">ËΩâÊèõÂÉπÂÄº <span class="sort-icon">‚áÖ</span></th>
                    <th class="sortable hide-mobile" data-col="_premium" data-type="num">Ê∫¢ÊäòÂÉπ% <span class="sort-icon">‚áÖ</span></th>
                    <th class="sortable" data-col="_high" data-type="num">ÊéõÁâåÊúÄÈ´ò <span class="sort-icon">‚áÖ</span></th>
                    <th class="sortable" data-col="_low" data-type="num">ÊéõÁâåÊúÄ‰Ωé <span class="sort-icon">‚áÖ</span></th>
                    <th class="sortable" data-col="_cbPrice" data-type="num">CBÊî∂Áõ§ <span class="sort-icon">‚áÖ</span></th>
                    <th class="sortable" data-col="_range" data-type="num">ÈúáÂπÖ% <span class="sort-icon">‚áÖ</span></th>
                    <th class="sortable" data-col="expDate" data-type="date">Âà∞ÊúüÊó• <span class="sort-icon">‚áÖ</span></th>
                </tr></thead><tbody>`;
            
            validFiltered.slice(0, 100).forEach(r => {
            const cbCode = r['_cbCode'] || safe(r['‰ª£Ëôü']);
            const cbName = r['_name'] || safe(r['ÂêçÁ®±']);
            const stockCode = r['_stockCode'] || '';
            const stockName = r['_stockName'] || safe(r['ËΩâÊèõÊ®ôÁöÑÂêçÁ®±']);
            const ind = r['_industry'] || '';
            const convPrice = r['ËΩâÊèõÂÉπÊ†º(ÂÖÉ)'];
            const stockPrice = r['_stockPrice'];
            const convValue = r['_convValue'];
            const premium = r['_premium'];
            const high = r['_high'];
            const low = r['_low'];
            const cbPrice = r['_cbPrice'];
            const range = r['_range'];
            const expDate = fmtDate(r['Âà∞ÊúüÊó•']);
            
            html += `<tr>
                <td class="code">${cbCode}</td>
                <td>${cbName}</td>
                <td class="stock hide-mobile" onclick="openStock('${stockCode}')">${stockName} ${stockCode}</td>
                <td class="hide-mobile">${ind}</td>
                <td class="hide-mobile">${fmtNum(convPrice, 1)}</td>
                <td class="hide-mobile">${fmtNum(stockPrice, 2)}</td>
                <td class="hide-mobile ${colorClass(convValue)}">${fmtNum(convValue, 2)}</td>
                <td class="hide-mobile ${colorClass(premium)}">${premium ? fmtNum(premium, 1)+'%' : '-'}</td>
                <td>${fmtNum(high, 1)}</td>
                <td>${fmtNum(low, 1)}</td>
                <td>${fmtNum(cbPrice, 2)}</td>
                <td class="${colorClass(range)}">${fmtNum(range, 1)}%</td>
                <td>${expDate}</td>
            </tr>`;
        });
        
        // ÂêàË®àÂàó
        html += `</tbody><tfoot><tr class="summary-row">
            <td colspan="2"><b>Âπ≥ÂùáÂÄº (${validFiltered.length} Á≠Ü)</b></td>
            <td class="hide-mobile"></td>
            <td class="hide-mobile"></td>
            <td class="hide-mobile"><b>${fmtNum(avgConvPrice, 1)}</b></td>
            <td class="hide-mobile"><b>${fmtNum(avgStockPrice, 2)}</b></td>
            <td class="hide-mobile"><b>${fmtNum(avgConvValue, 2)}</b></td>
            <td class="hide-mobile ${colorClass(avgPremium)}"><b>${fmtNum(avgPremium, 1)}%</b></td>
            <td><b>${fmtNum(avgHigh, 1)}</b></td>
            <td><b>${fmtNum(avgLow, 1)}</b></td>
            <td><b>${fmtNum(avgRange, 1)}%</b></td>
            <td></td>
        </tr></tfoot></table></div>`;
        }
    } else {
        // ÂÖ∂‰ªñÂàÜÈ†ÅÁî®Âç°Áâá
        filtered.slice(0, 100).forEach(i => {
            let title='', sub='', date='', code='', tagClass='brk', body='', click='', cardClass='card';
            
            if(CURR_DB==='stocks') {
                if(STOCK_MODE === 'all') {
                    title = i['ÂÖ¨Âè∏ÂêçÁ®±']; code = i['‰ª£Ëôü']; sub = i['Áî¢Ê•≠ÂàÜÈ°û']; 
                    body = i['Ê•≠ÂãôÊëòË¶Å'] || i['Áî¢Ê•≠Á¥∞ÂàÜ'] || '';
                    click = `openStock('${code}')`;
                } else if(STOCK_MODE === 'concept') {
                    // Ê¶ÇÂøµËÇ°Ê®°Âºè
                    title = i['_name']; code = i['_code']; 
                    sub = i['_concept']; tagClass = 'concept';
                    body = `${i['_subCat'] ? '„Äê'+i['_subCat']+'„Äë' : ''}${i['_desc'] || ''}`;
                    click = `openStock('${code}')`;
                }
                // Êü•Ë©¢Ë©≤ËÇ°Á•®ÊòØÂê¶ÊúâÊéõÁâå‰∏≠ÁöÑ CB
                const cbList = META.cbMap[code] || [];
                if(cbList.length > 0) {
                    const cbTags = cbList.map(cb => `<span class="tag cb-tag">${cb._name || cb['ÂêçÁ®±']}</span>`).join('');
                    i._cbTags = cbTags;
                }
            }
            else if(CURR_DB==='news') {
                const dataType = i['Ë≥áÊñôÈ°ûÂûã'] || '';
                const isIndustry = dataType === 'Áî¢Ê•≠Ë∂®Âã¢';
                title = i['ÂÖ¨Âè∏']; 
                code = i['ËÇ°Ëôü']; 
                sub = isIndustry ? 'Áî¢Ê•≠Ë∂®Âã¢' : i['Â†±Â∞éÈáçÈªûÂàÜÈ°û']; 
                date = i['Êó•Êúü']; 
                tagClass = isIndustry ? 'trend-ind' : 'ind';
                body = safe(i['ÂÆåÊï¥Â†±Â∞éÂÖßÂÆπ']).substring(0, 150);
                click = `openNews('${i['Á∑®Ëôü']}')`;
                // Áî¢Ê•≠Ë∂®Âã¢Âç°ÁâáÂä†‰∏äÁâπÊÆäÊ®£Âºè
                if(isIndustry) cardClass = 'card industry-card';
            }
            else if(CURR_DB==='memo') {
                title = i['ÂÖ¨Âè∏']; code = i['ËÇ°Ëôü']; sub = i['Â†±ÂëäÈ°ûÂûã']; date = i['Êó•Êúü'];
                const d = META.memoDetail[i['Á∑®Ëôü']];
                body = d ? (safe(d['ÁáüÈÅãÈáçÈªû']).substring(0,100) + '...') : 'ÈªûÊìäÊü•ÁúãË©≥ÊÉÖ';
                click = `openMemo('${i['Á∑®Ëôü']}')`;
                // Áî¢Ê•≠Áõ∏ÈóúÁöÑ Memo Áî®Á¥´Ëâ≤
                const reportType = i['Â†±ÂëäÈ°ûÂûã'] || '';
                if(reportType.includes('Áî¢Ê•≠')) {
                    tagClass = 'trend-ind';
                    cardClass = 'card industry-card';
                }
            }
            else if(CURR_DB==='reports') {
                title = i['Â†±ÂëäÊ®ôÈ°å']; sub = i['Âà∏ÂïÜÂêçÁ®±'] + ' - ' + safe(i['Áî¢Ê•≠ÂêçÁ®±']); 
                date = i['Â†±ÂëäÊó•Êúü']; tagClass = 'ind';
                body = i['ÂâØÊ®ôÈ°å'] || '';
                click = `openReport('${i['Â†±ÂëäÁ∑®Ëôü']}')`;
            }
            else if(CURR_DB==='strategy') {
                // Ë∂®Âã¢Â±ïÊúõÊñ∞Ê†ºÂºè
                title = i['Â†±Âëä‰∏ªÈ°å']; 
                sub = i['‰∏ªË¨õÂñÆ‰Ωç']; 
                date = i['Â†±ÂëäÊó•Êúü'];
                tagClass = 'ind';
                const secData = META.stratSections?.[i['Â†±ÂëäÁ∑®Ëôü']];
                const coreView = secData?.basic?.['Ê†∏ÂøÉËßÄÈªû'] || '';
                const speaker = i['Ë¨õËÄÖ'] || '';
                body = `${speaker ? 'Ë¨õËÄÖ: '+speaker+' | ' : ''}${coreView.substring(0, 80)}${coreView.length > 80 ? '...' : ''}`;
                click = `openStrategy('${i['Â†±ÂëäÁ∑®Ëôü']}')`;
            }
            else if(CURR_DB==='trends') {
                title = i['Áî¢Ê•≠']; sub = i['Ë∂®Âã¢Âà§Êñ∑']; tagClass = 'trend-up';
                code = i['ËÇ°Ëôü']; 
                body = `‰ª£Ë°®:${i['‰ª£Ë°®ÂÖ¨Âè∏']} | ‰ΩçÁΩÆ:${i['ÊôØÊ∞£‰ΩçÁΩÆ']}`;
                click = `openTrend('${i['Áî¢Ê•≠']}')`;
            }

            html += `<div class="${cardClass}" onclick="${click}">
                <div class="card-head"><div class="card-title">${title} ${code?`<span style="color:#999;font-weight:400">${code}</span>`:''}</div>${i._cbTags ? `<div class="cb-tags">${i._cbTags}</div>` : ''}</div>
                <div class="card-meta"><span class="tag ${tagClass}">${sub||'‰∏ÄËà¨'}</span>${date?`<span class="tag dt">${fmtDate(date)}</span>`:''}</div>
                <div class="card-body">${body}</div>
            </div>`;
        });
    }
    
    $('list').innerHTML = html || '<div style="text-align:center;padding:30px;color:#999">ÁÑ°Áõ∏Á¨¶Ë≥áÊñô</div>';
    
    // CB Ê®°ÂºèÊôÇÂä†‰∏ä class ËÆìË°®Ê†ºÊªøÁâà
    if(CURR_DB === 'cb') {
        $('list').classList.add('cb-mode');
        setTimeout(initCbSort, 50);
    } else {
        $('list').classList.remove('cb-mode');
    }
}

// Modal Áõ∏Èóú
function showModal(infoHtml, navItems) {
    $('m-info').innerHTML = infoHtml;
    $('navGrid').innerHTML = navItems.map((n,i) => 
        `<button class="nav-btn ${i===0?'active':''}" onclick="swTab('${n.id}', this)">${n.icon} ${n.label}</button>`
    ).join('');
    $('navGrid').style.display = navItems.length > 1 ? 'flex' : 'none';
    // È†êË®≠Ê∏ÖÁ©∫Â∫ïÈÉ®Ê®ôÁ±§ÔºàMemoÊúÉËá™Â∑±Ë®≠ÂÆöÔºâ
    const tagsEl = $('m-tags');
    if(tagsEl && !tagsEl.innerHTML) {
        tagsEl.classList.remove('show');
    }
    $('modal').classList.add('show');
}

window.swTab = (id, el) => {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    if(el) el.classList.add('active');
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    const pane = document.getElementById('tab-'+id);
    if(pane) pane.classList.add('active');
};

window.swFin = idx => {
    document.querySelectorAll('.fin-btn').forEach((b,i) => b.classList.toggle('active', i===idx));
    document.querySelectorAll('.fin-sub-pane').forEach((p,i) => p.classList.toggle('active', i===idx));
};

window.closeModal = e => {
    if(!e || e.target.id==='modal' || e.target.classList.contains('m-close')) {
        $('modal').classList.remove('show');
        // Ê∏ÖÁ©∫Â∫ïÈÉ®Ê®ôÁ±§
        const tagsEl = $('m-tags');
        if(tagsEl) {
            tagsEl.innerHTML = '';
            tagsEl.classList.remove('show');
        }
    }
};

// CB Ë°®Ê†ºÊéíÂ∫è
let cbSortCol = null;
let cbSortDir = 'asc';

window.initCbSort = () => {
    document.querySelectorAll('.cb-table th.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const col = th.dataset.col;
            const type = th.dataset.type;
            
            // ÂàáÊèõÊéíÂ∫èÊñπÂêë
            if(cbSortCol === col) {
                cbSortDir = cbSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                cbSortCol = col;
                cbSortDir = 'desc'; // È†êË®≠Áî±Â§ßÂà∞Â∞è
            }
            
            // Êõ¥Êñ∞Ê®£Âºè
            document.querySelectorAll('.cb-table th.sortable').forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });
            th.classList.add(cbSortDir === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // ÂèñÂæó tbody ‰∏¶ÊéíÂ∫è
            const tbody = document.querySelector('.cb-table tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                let aVal, bVal;
                const aIndex = Array.from(th.parentNode.children).indexOf(th);
                
                // ÂèñÂæóÂ∞çÊáâÊ¨Ñ‰ΩçÁöÑÂÄº
                aVal = a.children[aIndex]?.textContent?.trim() || '';
                bVal = b.children[aIndex]?.textContent?.trim() || '';
                
                // ÁßªÈô§ % Âíå x Á¨¶ËôüÔºå‰ª•ÂèäÈÄóËôü
                aVal = aVal.replace(/%/g, '').replace(/x/g, '').replace(/,/g, '');
                bVal = bVal.replace(/%/g, '').replace(/x/g, '').replace(/,/g, '');
                
                // ËôïÁêÜ - Á¨¶ËôüÔºàË°®Á§∫ÁÑ°Ë≥áÊñôÔºâ
                if(aVal === '-') aVal = type === 'num' ? '-999999999' : '';
                if(bVal === '-') bVal = type === 'num' ? '-999999999' : '';
                
                if(type === 'num') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else if(type === 'date') {
                    aVal = aVal.replace(/\//g, '');
                    bVal = bVal.replace(/\//g, '');
                }
                
                if(aVal < bVal) return cbSortDir === 'asc' ? -1 : 1;
                if(aVal > bVal) return cbSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            // ÈáçÊñ∞ÊéíÂàó
            rows.forEach(row => tbody.appendChild(row));
        });
    });
};

// ÈñãÂïüÂÄãËÇ°
// ÈñãÂïü CB Âü∫Êú¨Ë≥áÊñôË©≥ÊÉÖ
window.openCbInfo = cbCode => {
    if(!cbCode) { alert('ÁÑ°CB‰ª£Ëôü'); return; }
    
    // ÂòóË©¶Â§öÁ®ÆÊñπÂºèÊü•Êâæ
    let cb = DB.cbAll.find(c => c._cbCode === cbCode);
    if(!cb) cb = DB.cbAll.find(c => String(c._cbCode) === String(cbCode));
    if(!cb) cb = DB.cbAll.find(c => c._cbCode == cbCode);
    
    if(!cb) {
        alert('Êâæ‰∏çÂà∞CBË≥áÊñô: ' + cbCode + '\nDB.cbAllÊúâ ' + DB.cbAll.length + ' Á≠Ü');
        return;
    }
    
    const isActive = DB.cb.find(c => c._cbCode === cbCode);
    const statusTag = isActive ? '<span class="tag trend-up">ÊéõÁâå‰∏≠</span>' : '<span class="tag dt">Â∑≤‰∏ãÂ∏Ç</span>';
    
    const infoHtml = `
        <div style="font-size:22px;font-weight:700;margin-bottom:5px">${cb._name} <span style="color:#999;font-size:16px">${cbCode}</span></div>
        <div class="card-meta">
            ${statusTag}
            <span class="tag brk">${cb._industry || 'Êú™ÂàÜÈ°û'}</span>
            <span class="tag ind">${cb._method || ''}</span>
            <span class="tag ${cb._guarantee === 'ÊúâÊìî‰øù' ? 'trend-up' : 'dt'}">${cb._guarantee || ''}</span>
        </div>
    `;

    // Tab 1: ÁôºË°åÊ¢ù‰ª∂
    let tIssue = `
        <div class="section-head">üìù ÁôºË°åÊ¢ù‰ª∂</div>
        <div class="grid-2">
            <div class="stat-box"><div class="num">${fmtNum(cb._convPrice, 2)}</div><div class="lbl">ËΩâÊèõÂÉπÊ†º</div></div>
            <div class="stat-box"><div class="num">${cb._scale || '-'}</div><div class="lbl">ÁôºË°åË¶èÊ®°(ÂÑÑ)</div></div>
        </div>
        <div class="info-row"><span class="info-label">‰ø°Áî®Ë©ïÁ≠â</span><span class="info-val">${cb._rating || '-'}</span></div>
        <div class="info-row"><span class="info-label">ÁôºË°åÂπ¥Êúü</span><span class="info-val">${cb._years || '-'} Âπ¥</span></div>
        <div class="info-row"><span class="info-label">ÁôºË°åÂÉπÊ†º</span><span class="info-val">${cb._issuePrice || '-'}</span></div>
        <div class="info-row"><span class="info-label">Âà∞ÊúüÈÇÑÊú¨ÂÉπÊ†º</span><span class="info-val">${cb._expPrice || '-'}</span></div>
        <div class="info-row"><span class="info-label">Ë®ÇÂÉπÊ∫¢ÂÉπÁéá</span><span class="info-val">${cb._premium ? fmtNum(cb._premium * 100, 1) + '%' : '-'}</span></div>
        <div class="info-row"><span class="info-label">ÁôºË°åÂà∏ÂïÜ</span><span class="info-val">${cb._issuer || '-'}</span></div>
        <div class="info-row"><span class="info-label">Áî¢Ê•≠Âú∞‰Ωç</span><span class="info-val">${cb._position || '-'}</span></div>
        <div class="info-row"><span class="info-label">ËÇ°Êú¨Â§ßÂ∞è</span><span class="info-val">${cb._capital || '-'}</span></div>
    `;
    
    // Tab 2: ÊôÇÁ®ãË≥áË®ä
    let tTimeline = `
        <div class="section-head">üìÖ ÊôÇÁ®ãË≥áË®ä</div>
        <div class="info-row"><span class="info-label">Ëë£‰∫ãÊúÉÂÖ¨Âëä</span><span class="info-val">${fmtDate(cb._boardDate)}</span></div>
        <div class="info-row"><span class="info-label">ÈÄÅ‰ª∂Êó•Êúü</span><span class="info-val">${fmtDate(cb._sendDate)}</span></div>
        <div class="info-row"><span class="info-label">ÁîüÊïàÊó•Êúü</span><span class="info-val">${fmtDate(cb._effectDate)}</span></div>
        <div class="info-row"><span class="info-label">Ë©¢Âúà/Á´∂ÊãçÊó•Êúü</span><span class="info-val">${cb._bidDate || '-'}</span></div>
        <div class="info-row"><span class="info-label">ÊéõÁâåÊó•Êúü</span><span class="info-val">${fmtDate(cb._listDate)}</span></div>
        <div class="info-row"><span class="info-label">Âà∞ÊúüÊó•Êúü</span><span class="info-val">${fmtDate(cb._expDate)}</span></div>
        <div class="info-row"><span class="info-label">CBASÊãÜËß£Êó•</span><span class="info-val">${fmtDate(cb._cbasDate)}</span></div>
    `;
    if(cb._high > 0 && cb._low > 0) {
        const range = ((cb._high - cb._low) / cb._low * 100);
        tTimeline += `
            <div class="section-head">üìä ÊéõÁâåÊúüÈñìË°®Áèæ</div>
            <div class="grid-3">
                <div class="stat-box"><div class="num">${fmtNum(cb._high, 1)}</div><div class="lbl">ÊéõÁâåÊúÄÈ´ò</div></div>
                <div class="stat-box"><div class="num">${fmtNum(cb._low, 1)}</div><div class="lbl">ÊéõÁâåÊúÄ‰Ωé</div></div>
                <div class="stat-box"><div class="num ${colorClass(range)}">${fmtNum(range, 1)}%</div><div class="lbl">ÈúáÂπÖ</div></div>
            </div>
        `;
    }
    
    // Tab 3: Ë≥£ÂõûÊ¢ù‰ª∂
    let tPutback = `
        <div class="section-head">üí∞ Ë≥£ÂõûÊ¢ù‰ª∂</div>
        <div class="info-row"><span class="info-label">Ë≥£ÂõûÊó•Êúü1</span><span class="info-val">${fmtDate(cb._putDate1)}</span></div>
        <div class="info-row"><span class="info-label">Ë≥£ÂõûÊó•Êúü2</span><span class="info-val">${fmtDate(cb._putDate2)}</span></div>
        <div class="info-row"><span class="info-label">ÊäïË≥á‰∫∫ÊèêÂâçË≥£Âõû</span><span class="info-val">${cb._putTiming || '-'}</span></div>
        <div class="info-row"><span class="info-label">Ë≥£ÂõûÊ¢ù‰ª∂</span><span class="info-val">${cb._putCondition || '-'}</span></div>
    `;
    
    // ÈÄ£ÁµêÂà∞ËÇ°Á•®Âü∫Êú¨Ë≥áÊñô
    let tStock = `
        <div class="section-head">üè¢ ÁôºË°åÂÖ¨Âè∏</div>
        <div class="hl-block clickable" onclick="openStock('${cb._stockCode}');closeModal()">
            <b>${cb._stockCode}</b> - ÈªûÊìäÊü•ÁúãÂÖ¨Âè∏Âü∫Êú¨Ë≥áÊñô
        </div>
    `;

    const navItems = [
        {id:'issue', icon:'üìù', label:'ÁôºË°åÊ¢ù‰ª∂'},
        {id:'timeline', icon:'üìÖ', label:'ÊôÇÁ®ã'},
        {id:'putback', icon:'üí∞', label:'Ë≥£Âõû'},
        {id:'stock', icon:'üè¢', label:'ÂÖ¨Âè∏'}
    ];

    const fullHtml = `
        <div class="modal-info">${infoHtml}</div>
        <div class="modal-nav">${navItems.map(n => `<div class="nav-item" data-tab="${n.id}"><div class="nav-icon">${n.icon}</div><div class="nav-label">${n.label}</div></div>`).join('')}</div>
        <div class="modal-tabs">
            <div class="tab-pane" id="tab-issue">${tIssue}</div>
            <div class="tab-pane" id="tab-timeline">${tTimeline}</div>
            <div class="tab-pane" id="tab-putback">${tPutback}</div>
            <div class="tab-pane" id="tab-stock">${tStock}</div>
        </div>
    `;
    
    showModal(fullHtml, () => {
        document.querySelectorAll('.modal-nav .nav-item').forEach((item, idx) => {
            item.onclick = () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                document.getElementById('tab-' + item.dataset.tab).classList.add('active');
            };
            if(idx === 0) item.classList.add('active');
        });
        document.getElementById('tab-issue').classList.add('active');
    });
};

window.openStock = code => {
    if(!code || code==='-') return;
    code = normalizeCode(code);
    const s = DB.stocks[code] || { 'ÂÖ¨Âè∏ÂêçÁ®±': code, '‰ª£Ëôü': code };
    const name = s['ÂÖ¨Âè∏ÂêçÁ®±'] || code;
    const concepts = META.concepts[code] || [];
    const cbs = META.cbMap[code] || [];
    const memos = META.relatedMemo[code] || [];
    const news = META.relatedNews[code] || [];
    const fin = META.finance[name] || {};
    const prod = META.products[name] || {};
    const track = META.tracking[name] || {};
    const revM = META.revData.month[code] || [];
    const revQ = META.revData.quarter[code] || [];
    const revY = META.revData.year[code] || [];
    const revH = META.revData.highlights[code] || {};

    const infoHtml = `
        <div style="font-size:22px;font-weight:700;margin-bottom:5px">${name} <span style="color:#999;font-size:16px">${code}</span></div>
        <div class="card-meta">
            <span class="tag ind">${s['Áî¢Ê•≠ÂàÜÈ°û']||'Êú™ÂàÜÈ°û'}</span>
            ${concepts.slice(0,3).map(c=>`<span class="tag concept">#${c.concept}</span>`).join('')}
        </div>
        <div style="font-size:13px;color:#666;margin-top:5px;line-height:1.5">${s['Ê•≠ÂãôÊëòË¶Å']||''}</div>
    `;

    const navItems = [
        {id:'basic', icon:'üìä', label:'Á∏ΩË¶Ω'},
        {id:'fin', icon:'üí∞', label:'ÁáüÊî∂'},
        {id:'prod', icon:'üì¶', label:'Áî¢ÂìÅ'},
        {id:'rep', icon:'üì∞', label:'Â†±Âëä'},
        {id:'rate', icon:'‚≠ê', label:'Ë©ïÂÉπ'}
    ];

    // Tab 1: Âü∫Êú¨Ë≥áÊñô
    let tBasic = `
        <div class="grid-2">
            <div class="stat-box"><div class="num">${s['Êàê‰∫§']||'-'}</div><div class="lbl">Êî∂Áõ§ÂÉπ</div></div>
            <div class="stat-box"><div class="num ${colorClass(s['Êº≤Ë∑åÂπÖ'])}">${s['Êº≤Ë∑åÂπÖ']||'-'}%</div><div class="lbl">Êº≤Ë∑åÂπÖ</div></div>
        </div>
    `;
    if(concepts.length) {
        tBasic += `<div class="section-head">üí° Ê¶ÇÂøµËÇ°ÂàÜÈ°û</div>`;
        tBasic += concepts.map(c => `<div class="list-item" onclick="setSearch('#${c.concept}');closeModal()"><div class="list-title">#${c.concept}</div><div class="list-sub">${c.sub||''}</div></div>`).join('');
    }
    if(cbs.length) {
        tBasic += `<div class="section-head">üé´ ÂèØËΩâÂÇµ (${cbs.length})</div>`;
        tBasic += cbs.map(c => `<div class="hl-block"><b>${c['ÂêçÁ®±']}</b><br>ËΩâÂÉπ: ${c['ËΩâÊèõÂÉπÊ†º(ÂÖÉ)']} | È§òÈ°ç: ${c['ÊúÄÊñ∞È§òÈ°ç(ÁôæËê¨)']}M | Âà∞Êúü: ${fmtDate(c['Âà∞ÊúüÊó•'])}</div>`).join('');
    }

    // Tab 2: ÁáüÊî∂
    let tFin = '';
    
    // Debug info
    console.log('ÁáüÊî∂Ë≥áÊñô:', code, 'Êúà:', revM.length, 'Â≠£:', revQ.length, 'Âπ¥:', revY.length);
    
    // ÁáüÊî∂‰∫ÆÈªû
    if(revH['ÂñÆÊúàÁáüÊî∂ÂâµÁ¥ÄÈåÑÊúàÊï∏']) {
        tFin += `<div style="margin-bottom:15px"><span class="tag trend-up">üî• Ê≠∑Âè≤Êñ∞È´ò ${revH['ÂñÆÊúàÁáüÊî∂ÂâµÁ¥ÄÈåÑÊúàÊï∏']} Ê¨°</span></div>`;
    }
    
    if(revM.length > 0 || revQ.length > 0 || revY.length > 0) {
        // Âè™ÂèñËøë12Êúü
        const recent12M = revM.slice(0, 12);
        const recent12Q = revQ.slice(0, 12);
        const recent12Y = revY.slice(0, 12);
        
        // Ë®àÁÆóÊúàÂ¢ûÁéáÂíåÂπ¥Â¢ûÁéá
        const revWithGrowth = recent12M.map((r, idx) => {
            const prevMonth = revM.find(p => p.month === r.month && p.year === r.year - 1);
            const lastMonth = revM.find(p => {
                if(r.month === 1) return p.year === r.year - 1 && p.month === 12;
                return p.year === r.year && p.month === r.month - 1;
            });
            return {
                ...r,
                yoy: prevMonth ? ((r.rev - prevMonth.rev) / prevMonth.rev * 100) : null,
                mom: lastMonth ? ((r.rev - lastMonth.rev) / lastMonth.rev * 100) : null,
                prevYearRev: prevMonth ? prevMonth.rev : null
            };
        });
        
        // Âπ¥Â∫¶ÊØîËºÉË°® - Âª∫Á´ãË≥áÊñôÁµêÊßãÔºàÂè™ÂèñËøë4Âπ¥Ôºâ
        const years = [...new Set(revM.map(r => r.year))].sort((a,b) => b-a).slice(0, 4);
        const monthlyByYear = {};
        years.forEach(y => { monthlyByYear[y] = {}; });
        revM.forEach(r => {
            if(monthlyByYear[r.year]) monthlyByYear[r.year][r.month] = r.rev;
        });
        
        // Ë®àÁÆóÂπ¥Â∫¶Âä†Á∏ΩÂíåÂπ¥Â¢ûÁéá
        const yearTotals = years.map(y => {
            const total = Object.values(monthlyByYear[y] || {}).reduce((a,b) => a+b, 0);
            return { year: y, total };
        });
        const yearGrowth = yearTotals.map((yt, idx) => {
            const prev = yearTotals[idx + 1];
            return { ...yt, yoy: prev ? ((yt.total - prev.total) / prev.total * 100) : null };
        });
        
        tFin += `
            <div class="fin-switcher">
                <div class="fin-btn active" onclick="swFin(0)">ÊúàÁáüÊî∂</div>
                <div class="fin-btn" onclick="swFin(1)">Âπ¥ÁáüÊî∂</div>
            </div>
            
            <div id="ft-0" class="fin-sub-pane active">
                ${revWithGrowth.length > 0 ? `
                <div class="rev-unit">üí∞ ÂñÆ‰ΩçÔºöÂÑÑÂÖÉ</div>
                <div class="table-wrap"><table class="fin-table">
                    <thead><tr>
                        <th>ÊúüÂà•</th>
                        <th>ÁáüÊ•≠Êî∂ÂÖ•</th>
                        <th>ÊúàÂ¢ûÁéá</th>
                        <th>ÂéªÂπ¥ÂêåÊúü</th>
                        <th>Âπ¥Â¢ûÁéá</th>
                    </tr></thead>
                    <tbody>${revWithGrowth.map(r => {
                        const momClass = r.mom > 0 ? '' : (r.mom < 0 ? 't-down' : '');
                        const yoyClass = r.yoy > 0 ? '' : (r.yoy < 0 ? 't-down' : '');
                        return `<tr>
                            <td>${r.d}</td>
                            <td>${fmtNum(r.rev, 1)}</td>
                            <td class="${momClass}">${r.mom !== null ? (r.mom >= 0 ? '+' : '') + fmtNum(r.mom, 2) + '%' : '-'}</td>
                            <td>${r.prevYearRev ? fmtNum(r.prevYearRev, 1) : '-'}</td>
                            <td class="${yoyClass}">${r.yoy !== null ? (r.yoy >= 0 ? '+' : '') + fmtNum(r.yoy, 2) + '%' : '-'}</td>
                        </tr>`;
                    }).join('')}</tbody>
                </table></div>
                ` : '<div style="text-align:center;padding:20px;color:#999">ÁÑ°ÊúàÁáüÊî∂Ë≥áÊñô</div>'}
            </div>
            
            <div id="ft-1" class="fin-sub-pane">
                ${years.length > 0 ? `
                <div class="rev-unit">üí∞ ÂñÆ‰ΩçÔºöÂÑÑÂÖÉ</div>
                <div class="table-wrap"><table class="fin-table">
                    <thead><tr>
                        <th>ÊúüÂà•</th>
                        ${years.map(y => `<th>${y}</th>`).join('')}
                    </tr></thead>
                    <tbody>
                        <tr class="highlight-row">
                            <td>Âπ¥Â∫¶Âä†Á∏Ω</td>
                            ${yearGrowth.map(yg => `<td>${fmtNum(yg.total, 1)}</td>`).join('')}
                        </tr>
                        <tr class="highlight-row">
                            <td>Âπ¥Â¢ûÁéá</td>
                            ${yearGrowth.map(yg => {
                                const cls = yg.yoy > 0 ? '' : (yg.yoy < 0 ? 't-down' : '');
                                return `<td class="${cls}">${yg.yoy !== null ? (yg.yoy >= 0 ? '+' : '') + fmtNum(yg.yoy, 2) + '%' : '-'}</td>`;
                            }).join('')}
                        </tr>
                        ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `
                            <tr>
                                <td>${m}Êúà</td>
                                ${years.map(y => `<td>${monthlyByYear[y]?.[m] ? fmtNum(monthlyByYear[y][m], 1) : ''}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table></div>
                ` : '<div style="text-align:center;padding:20px;color:#999">ÁÑ°Âπ¥ÁáüÊî∂Ë≥áÊñô</div>'}
            </div>
        `;
    } else {
        tFin = '<div style="text-align:center;padding:30px;color:#999">ÁÑ°ÁáüÊî∂Ë≥áÊñô<br><small>Ë´ãÁ¢∫Ë™ç 06_revenue.xlsx Â∑≤Ê≠£Á¢∫ËºâÂÖ•</small></div>';
    }
    
    if(fin['4Q25ÊåáÂºï']) tFin += `<div class="hl-block" style="margin-top:15px"><b>üîÆ Êú™‰æÜÊåáÂºï</b><br>${fmtTxt(fin['4Q25ÊåáÂºï'])}</div>`;

    // Tab 3: Áî¢ÂìÅÁµêÊßã
    let tProd = '';
    if(prod['‰∏ªË¶ÅÁî¢ÂìÅ1']) {
        tProd += `<div class="section-head">üì¶ Áî¢ÂìÅÁµÑÂêà</div>`;
        [1,2,3].forEach(n => {
            if(prod[`‰∏ªË¶ÅÁî¢ÂìÅ${n}`]) {
                tProd += `<div class="info-row"><span class="info-label">${prod[`‰∏ªË¶ÅÁî¢ÂìÅ${n}`]}</span><span class="info-val">${prod[`‰ΩîÊØî/Ë°®Áèæ${n}`]||''}</span></div>`;
            }
        });
    }
    if(prod['ÈóúÈçµÊàêÈï∑ÂãïËÉΩ']) tProd += `<div class="hl-block"><b>üöÄ ÊàêÈï∑ÂãïËÉΩ</b><br>${fmtTxt(prod['ÈóúÈçµÊàêÈï∑ÂãïËÉΩ'])}</div>`;
    if(prod['2026Â±ïÊúõ']) tProd += `<div class="hl-block"><b>üîÆ 2026Â±ïÊúõ</b><br>${fmtTxt(prod['2026Â±ïÊúõ'])}</div>`;
    if(!tProd) tProd = '<div style="text-align:center;padding:30px;color:#999">ÁÑ°Áî¢ÂìÅË≥áÊñô</div>';

    // Tab 4: Áõ∏ÈóúÂ†±Âëä
    let tRep = '';
    if(memos.length) {
        tRep += `<div class="section-head">üìã Call Memo (${memos.length})</div>`;
        memos.forEach(m => {
            tRep += `<div class="list-item" onclick="openMemo('${m['Á∑®Ëôü']}')">
                <div class="list-title">${m['Âà∏ÂïÜ']} - ${m['Â†±ÂëäÈ°ûÂûã']}</div>
                <div class="list-sub">${fmtDate(m['Êó•Êúü'])} | ${m['ÈáçË¶ÅÊÄß']||''}</div>
            </div>`;
        });
    }
    if(news.length) {
        tRep += `<div class="section-head">‚ö° Â§ñÈõªÂ†±Â∞é (${news.length})</div>`;
        news.slice(0,5).forEach(n => {
            tRep += `<div class="list-item" onclick="openNews('${n['Á∑®Ëôü']}')">
                <div class="list-title">${n['Â†±Â∞éÈáçÈªûÂàÜÈ°û']}</div>
                <div class="list-sub">${fmtDate(n['Êó•Êúü'])}</div>
            </div>`;
        });
    }
    if(!tRep) tRep = '<div style="text-align:center;padding:30px;color:#999">ÁÑ°Áõ∏ÈóúÂ†±Âëä</div>';

    // Tab 5: Ë©ïÂÉπË©ïÁ≠â
    let tRate = '';
    if(track['ÊäïË≥áË©ïÁ≠â']) {
        tRate += `<div class="rating-card"><div class="label">ÊäïË≥áË©ïÁ≠â</div><div class="big-num">${track['ÊäïË≥áË©ïÁ≠â']}</div></div>`;
        tRate += `<div class="info-row"><span class="info-label">ÁõÆÊ®ôÂÉπ</span><span class="info-val" style="color:var(--primary);font-size:18px">${track['ÁõÆÊ®ôÂÉπ']||'-'}</span></div>`;
        tRate += `<div class="info-row"><span class="info-label">ËøΩËπ§ÁãÄÊÖã</span><span class="info-val">${track['ËøΩËπ§ÁãÄÊÖã']||'-'}</span></div>`;
    }
    if(!tRate) tRate = '<div style="text-align:center;padding:30px;color:#999">ÁÑ°Ë©ïÂÉπË≥áÊñô</div>';

    $('m-body').innerHTML = `
        <div id="tab-basic" class="tab-pane active">${tBasic}</div>
        <div id="tab-fin" class="tab-pane">${tFin}</div>
        <div id="tab-prod" class="tab-pane">${tProd}</div>
        <div id="tab-rep" class="tab-pane">${tRep}</div>
        <div id="tab-rate" class="tab-pane">${tRate}</div>
    `;
    showModal(infoHtml, navItems);
};

// ÈñãÂïü Memo
window.openMemo = id => {
    const m = DB.memo.find(i => String(i['Á∑®Ëôü']) === String(id));
    if(!m) return;
    const d = META.memoDetail[id] || {};

    const infoHtml = `
        <div style="font-size:20px;font-weight:700;margin-bottom:5px">${m['ÂÖ¨Âè∏']} <span style="color:#999;font-size:14px">${m['ËÇ°Ëôü']}</span></div>
        <div class="card-meta">
            <span class="tag brk">${m['Âà∏ÂïÜ']}</span>
            <span class="tag ind">${m['Â†±ÂëäÈ°ûÂûã']}</span>
            <span class="tag dt">${fmtDate(m['Êó•Êúü'])}</span>
        </div>
        <div style="font-size:12px;color:#666;margin-top:5px">ÂàÜÊûêÂ∏´: ${m['ÂàÜÊûêÂ∏´']||'-'} | ${m['ÈáçË¶ÅÊÄß']||''}</div>
    `;

    // 6 ÂÄãÁç®Á´ãÂàÜÈ†ÅÔºàÊ®ôÁ±§ÁßªÂà∞Â∫ïÈÉ®Âõ∫ÂÆöÂçÄÔºâ
    const navItems = [
        {id:'op', icon:'üéØ', label:'ÁáüÈÅãÈáçÈªû'},
        {id:'strat', icon:'üöÄ', label:'Á≠ñÁï•ÊñπÂêë'},
        {id:'qa', icon:'‚ùì', label:'QAÊëòË¶Å'},
        {id:'rex', icon:'üëÄ', label:'RexËßÄÂØü'},
        {id:'follow', icon:'üìå', label:'ÂæåÁ∫åËøΩËπ§'},
        {id:'timeline', icon:'üìÖ', label:'ÈóúÈçµÊôÇÁ®ã'}
    ];

    // Tab 1: ÁáüÈÅãÈáçÈªû
    const tOp = d['ÁáüÈÅãÈáçÈªû'] ? `<div class="hl-block">${fmtTxt(d['ÁáüÈÅãÈáçÈªû'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ÁÑ°Ë≥áÊñô</div>';
    
    // Tab 2: Á≠ñÁï•ÊñπÂêë
    const tStrat = d['Á≠ñÁï•ÊñπÂêë'] ? `<div class="hl-block">${fmtTxt(d['Á≠ñÁï•ÊñπÂêë'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ÁÑ°Ë≥áÊñô</div>';
    
    // Tab 3: QAÊëòË¶Å
    let tQA = '';
    if(d['ÈáçË¶ÅQAÊëòË¶Å']) {
        const qaText = safe(d['ÈáçË¶ÅQAÊëòË¶Å']);
        const lines = qaText.split('\n');
        let currentQ = '', currentA = '';
        lines.forEach(line => {
            if(line.match(/^Q\d*[Ôºö:]/i)) {
                if(currentQ && currentA) {
                    tQA += `<div class="qa-item"><div class="qa-q">${currentQ}</div><div class="qa-a">${currentA}</div></div>`;
                }
                currentQ = line.replace(/^Q\d*[Ôºö:]\s*/i, '');
                currentA = '';
            } else if(line.match(/^A\d*[Ôºö:]/i)) {
                currentA = line.replace(/^A\d*[Ôºö:]\s*/i, '');
            } else if(currentA) {
                currentA += '\n' + line;
            }
        });
        if(currentQ && currentA) {
            tQA += `<div class="qa-item"><div class="qa-q">${currentQ}</div><div class="qa-a">${currentA}</div></div>`;
        }
    }
    if(!tQA) tQA = '<div style="color:#999;text-align:center;padding:20px">ÁÑ°QAË≥áÊñô</div>';

    // Tab 4: RexËßÄÂØü
    const tRex = d['RexËßÄÂØü'] ? `<div class="hl-block">${fmtTxt(d['RexËßÄÂØü'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ÁÑ°ËßÄÂØüË®òÈåÑ</div>';

    // Tab 5: ÂæåÁ∫åËøΩËπ§
    const tFollow = d['ÂæåÁ∫åËøΩËπ§'] ? `<div class="hl-block">${fmtTxt(d['ÂæåÁ∫åËøΩËπ§'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ÁÑ°ËøΩËπ§È†ÖÁõÆ</div>';

    // Tab 6: ÈóúÈçµÊôÇÁ®ã
    let tTimeline = '';
    if(d['ÈóúÈçµÊôÇÁ®ã']) {
        safe(d['ÈóúÈçµÊôÇÁ®ã']).split('\n').filter(l=>l.trim()).forEach(line => {
            const match = line.match(/^\[([^\]]+)\]\s*(.+)/);
            if(match) {
                tTimeline += `<div class="timeline-item"><div class="timeline-date">${match[1]}</div><div class="timeline-text">${match[2]}</div></div>`;
            } else {
                tTimeline += `<div class="timeline-item"><div class="timeline-text">${line}</div></div>`;
            }
        });
    }
    if(!tTimeline) tTimeline = '<div style="color:#999;text-align:center;padding:20px">ÁÑ°ÊôÇÁ®ãË≥áÊñô</div>';

    // Â∫ïÈÉ®Âõ∫ÂÆöÊ®ôÁ±§ÂçÄ
    let tagsHtml = '';
    if(d['Ê®ôÁ±§']) {
        const tags = safe(d['Ê®ôÁ±§']).split(/[,Ôºå\s]+/).filter(t=>t);
        if(tags.length > 0) {
            tagsHtml = `<div class="tags-wrap">${tags.map(tag => 
                `<span class="tag concept" onclick="setSearch('${tag}');closeModal()">${tag}</span>`
            ).join('')}</div>`;
        }
    }

    $('m-body').innerHTML = `
        <div id="tab-op" class="tab-pane active">${tOp}</div>
        <div id="tab-strat" class="tab-pane">${tStrat}</div>
        <div id="tab-qa" class="tab-pane">${tQA}</div>
        <div id="tab-rex" class="tab-pane">${tRex}</div>
        <div id="tab-follow" class="tab-pane">${tFollow}</div>
        <div id="tab-timeline" class="tab-pane">${tTimeline}</div>
    `;
    
    // Ë®≠ÂÆöÂ∫ïÈÉ®Ê®ôÁ±§
    const tagsEl = $('m-tags');
    if(tagsHtml) {
        tagsEl.innerHTML = tagsHtml;
        tagsEl.classList.add('show');
    } else {
        tagsEl.innerHTML = '';
        tagsEl.classList.remove('show');
    }
    
    showModal(infoHtml, navItems);
};

// ÈñãÂïüÁî¢Ê•≠Â†±Âëä
window.openReport = rid => {
    const r = DB.reports.find(i => i['Â†±ÂëäÁ∑®Ëôü'] === rid);
    if(!r) return;
    
    const focus = META.reportFocus[rid] || [];
    const views = META.reportViews[rid] || {};
    const ratings = META.reportRatings[rid] || [];

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;color:var(--primary);margin-bottom:5px">${r['Â†±ÂëäÊ®ôÈ°å']}</div>
        <div class="card-meta">
            <span class="tag brk">${r['Âà∏ÂïÜÂêçÁ®±']}</span>
            <span class="tag ind">${r['Áî¢Ê•≠ÂêçÁ®±']||''}</span>
            <span class="tag dt">${fmtDate(r['Â†±ÂëäÊó•Êúü'])}</span>
        </div>
    `;

    const navItems = [
        {id:'sum', icon:'üìä', label:'Á∏ΩË¶Ω'},
        {id:'focus', icon:'üîç', label:'ÁÑ¶ÈªûÂàÜÊûê'},
        {id:'view', icon:'üí°', label:'Âà∏ÂïÜËßÄÈªû'},
        {id:'pick', icon:'‚≠ê', label:'ÂÄãËÇ°Ë©ïÂÉπ'}
    ];

    let tSum = '';
    ['Ê†∏ÂøÉÈáçÈªû1','Ê†∏ÂøÉÈáçÈªû2','Ê†∏ÂøÉÈáçÈªû3','Ê†∏ÂøÉÈáçÈªû4','Ê†∏ÂøÉÈáçÈªû5'].forEach((k,i) => {
        if(r[k]) tSum += `<div class="hl-block"><b>${i+1}.</b> ${r[k]}</div>`;
    });
    if(r['Áî¢Ê•≠Ë©ïÁ≠â']) tSum += `<div class="info-row"><span class="info-label">Áî¢Ê•≠Ë©ïÁ≠â</span><span class="info-val" style="color:var(--primary)">${r['Áî¢Ê•≠Ë©ïÁ≠â']}</span></div>`;

    let tFocus = '';
    if(focus.length) {
        focus.forEach(f => {
            tFocus += `<div class="section-head">${f['ÊÆµËêΩÊ®ôÈ°å']||`ÊÆµËêΩ${f['ÊÆµËêΩÁ∑®Ëôü']}`}</div>`;
            tFocus += `<div class="hl-block">${fmtTxt(f['ÊÆµËêΩÂÖßÂÆπ'])}</div>`;
            if(f['Â∏ÇÂ†¥Ë¶èÊ®°Êï∏Êìö']) tFocus += `<div class="info-row"><span class="info-label">Â∏ÇÂ†¥Ë¶èÊ®°</span><span class="info-val">${f['Â∏ÇÂ†¥Ë¶èÊ®°Êï∏Êìö']}</span></div>`;
        });
    } else tFocus = '<div style="color:#999;text-align:center;padding:20px">ÁÑ°ÁÑ¶ÈªûÂàÜÊûê</div>';

    let tView = '';
    if(views['ËßÄÈªûÂÖßÂÆπ']) tView += `<div class="hl-block">${fmtTxt(views['ËßÄÈªûÂÖßÂÆπ'])}</div>`;
    [1,2,3].forEach(n => {
        if(views[`È¶ñÈÅ∏ÂÄãËÇ°${n}`]) tView += `<div class="list-item"><div class="list-title">üåü ${views[`È¶ñÈÅ∏ÂÄãËÇ°${n}`]}</div><div class="list-sub">${views[`È¶ñÈÅ∏ÁêÜÁî±${n}`]||''}</div></div>`;
    });
    if(views['È¢®Èö™ÊèêÈÜí']) tView += `<div class="hl-block" style="border-left-color:#e74c3c"><b>‚ö†Ô∏è È¢®Èö™ÊèêÈÜí</b><br>${views['È¢®Èö™ÊèêÈÜí']}</div>`;
    if(!tView) tView = '<div style="color:#999;text-align:center;padding:20px">ÁÑ°Âà∏ÂïÜËßÄÈªû</div>';

    let tPick = '';
    if(ratings.length) {
        ratings.forEach(rt => {
            const stockCode = normalizeCode(rt['ËÇ°Á•®‰ª£Ëôü']);
            tPick += `<div class="list-item" onclick="openStock('${stockCode}')">
                <div class="list-title">${rt['ÂÖ¨Âè∏ÂêçÁ®±']} <span style="color:#999">${stockCode}</span></div>
                <div style="display:flex;gap:15px;margin-top:8px;font-size:12px">
                    <div><span style="color:#888">Ë©ïÁ≠â</span> <b style="color:var(--primary)">${rt['Ë©ïÁ≠â']||'-'}</b></div>
                    <div><span style="color:#888">ÁõÆÊ®ôÂÉπ</span> <b>${rt['ÁõÆÊ®ôÂÉπ']||'-'}</b></div>
                    <div><span style="color:#888">25F EPS</span> <b>${rt['EPS_FY25F']||'-'}</b></div>
                </div>
                ${rt['ÊäïË≥á‰∫ÆÈªû']?`<div style="font-size:12px;color:#666;margin-top:5px">${rt['ÊäïË≥á‰∫ÆÈªû']}</div>`:''}
            </div>`;
        });
    } else tPick = '<div style="color:#999;text-align:center;padding:20px">ÁÑ°ÂÄãËÇ°Ë©ïÂÉπ</div>';

    $('m-body').innerHTML = `
        <div id="tab-sum" class="tab-pane active">${tSum}</div>
        <div id="tab-focus" class="tab-pane">${tFocus}</div>
        <div id="tab-view" class="tab-pane">${tView}</div>
        <div id="tab-pick" class="tab-pane">${tPick}</div>
    `;
    showModal(infoHtml, navItems);
};

// ÈñãÂïüË∂®Âã¢Â±ïÊúõÂ†±Âëä (Êñ∞Ê†ºÂºè)
window.openStrategy = rid => {
    const r = DB.strategy.find(i => i['Â†±ÂëäÁ∑®Ëôü'] === rid);
    if(!r) return;
    
    const secData = META.stratSections?.[rid];
    if(!secData) return;
    
    const basic = secData.basic || {};
    const sections = secData.sections || [];

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;color:var(--primary);margin-bottom:5px">${basic['Â†±Âëä‰∏ªÈ°å'] || r['Â†±Âëä‰∏ªÈ°å']}</div>
        ${basic['ÂâØÊ®ôÈ°å'] ? `<div style="font-size:13px;color:#666;margin-bottom:8px;font-style:italic">${basic['ÂâØÊ®ôÈ°å']}</div>` : ''}
        <div class="card-meta">
            <span class="tag brk">${basic['ÁôºÂ∏ÉÂñÆ‰Ωç'] || r['‰∏ªË¨õÂñÆ‰Ωç']}</span>
            ${basic['‰∏ªË¨õ‰∫∫'] ? `<span class="tag ind">${basic['‰∏ªË¨õ‰∫∫']}</span>` : ''}
            <span class="tag dt">${fmtDate(basic['ÁôºÂ∏ÉÊó•Êúü'] || r['Â†±ÂëäÊó•Êúü'])}</span>
            ${basic['Â†±ÂëäÈ†ÅÊï∏'] ? `<span class="tag dt">${basic['Â†±ÂëäÈ†ÅÊï∏']}</span>` : ''}
        </div>
    `;

    // Âª∫Á´ãÈ†ÅÁ±§ - Á¨¨‰∏ÄÂÄãÊòØÁ∏ΩË¶ΩÔºåÂÖ∂È§òÊòØÂêÑÂàÜÈ°û
    const navItems = [{id:'overview', icon:'üìã', label:'Á∏ΩË¶Ω'}];
    sections.forEach((sec, idx) => {
        // ÂæûÊ®ôÈ°å‰∏≠ÊèêÂèñÁ∞°Áü≠ÂêçÁ®±
        let label = sec.title.replace(/„Äê|„Äë/g, '').split(' ')[0];
        if(label.length > 6) label = label.substring(0, 6);
        const icons = ['üåç', 'üè¶', 'üá∫üá∏', 'üá®üá≥', 'üá™üá∫', 'üáπüáº', 'üí±', 'ü§ñ', 'üíª', 'üè≠', 'üìà', '‚≠ê', 'üîó', 'üí°', 'üìä', 'üéØ'];
        navItems.push({id: `sec${idx}`, icon: icons[idx % icons.length], label: label});
    });

    // Á∏ΩË¶ΩÂÖßÂÆπ
    let tOverview = '';
    if(basic['Ê†∏ÂøÉËßÄÈªû']) {
        tOverview += `<div class="hl-block"><b>üìå Ê†∏ÂøÉËßÄÈªû</b><br>${fmtTxt(basic['Ê†∏ÂøÉËßÄÈªû'])}</div>`;
    }
    if(basic['Ê®ôÁ±§ÂàÜÈ°û']) {
        const tags = basic['Ê®ôÁ±§ÂàÜÈ°û'].split('#').filter(t => t.trim());
        tOverview += `<div style="margin:15px 0;display:flex;flex-wrap:wrap;gap:6px">`;
        tags.forEach(tag => {
            tOverview += `<span style="background:#f0f0f0;padding:4px 10px;border-radius:15px;font-size:12px;color:#666">#${tag.trim()}</span>`;
        });
        tOverview += `</div>`;
    }
    
    // Âú®Á∏ΩË¶ΩÈ°ØÁ§∫ÂêÑÂàÜÈ°ûÊëòË¶Å
    sections.forEach(sec => {
        tOverview += `<div class="section-head">${sec.title}</div>`;
        const preview = sec.items.slice(0, 3);
        preview.forEach(item => {
            const val = item.value ? String(item.value).substring(0, 100) : '';
            tOverview += `<div class="list-item" style="padding:8px 0;border-bottom:1px solid #f0f0f0">
                <span style="font-weight:600;color:#333">${item.label}</span>: 
                <span style="color:#666">${val}${String(item.value || '').length > 100 ? '...' : ''}</span>
            </div>`;
        });
        if(sec.items.length > 3) {
            tOverview += `<div style="font-size:11px;color:#999;padding:5px 0">ÈÇÑÊúâ ${sec.items.length - 3} È†Ö...</div>`;
        }
    });

    // ÂêÑÂàÜÈ°ûË©≥Á¥∞ÂÖßÂÆπ
    let tabPanes = `<div id="tab-overview" class="tab-pane active">${tOverview}</div>`;
    
    sections.forEach((sec, idx) => {
        let content = `<div class="section-head">${sec.title}</div>`;
        sec.items.forEach(item => {
            const val = item.value ? String(item.value) : '';
            // Ê™¢Êü•ÊòØÂê¶ÊòØËÇ°Á•®‰ª£Ëôü (4‰ΩçÊï∏Â≠ó)
            const isStockCode = /^\d{4}$/.test(item.label);
            
            if(isStockCode) {
                // ËÇ°Á•®È†ÖÁõÆ - ÂèØÈªûÊìä
                content += `<div class="list-item" onclick="openStock('${item.label}')" style="cursor:pointer">
                    <div class="list-title">${val} <span style="color:#999">${item.label}</span></div>
                </div>`;
            } else if(val.length > 100) {
                // Èï∑ÂÖßÂÆπ - Áî®ÂçÄÂ°äÈ°ØÁ§∫
                content += `<div class="hl-block"><b>${item.label}</b><br>${fmtTxt(val)}</div>`;
            } else {
                // Áü≠ÂÖßÂÆπ - Ë°®Ê†ºÂºèÈ°ØÁ§∫
                content += `<div class="list-item" style="display:flex;padding:10px 0;border-bottom:1px solid #f0f0f0">
                    <div style="font-weight:600;color:#333;min-width:120px">${item.label}</div>
                    <div style="color:#555;flex:1">${val}</div>
                </div>`;
            }
        });
        tabPanes += `<div id="tab-sec${idx}" class="tab-pane">${content}</div>`;
    });

    $('m-body').innerHTML = tabPanes;
    showModal(infoHtml, navItems);
};

// ÈñãÂïüÁî¢Ê•≠Ë∂®Âã¢
window.openTrend = indName => {
    const t = DB.trends.find(i => i['Áî¢Ê•≠'] === indName);
    if(!t) return;

    const infoHtml = `
        <div style="font-size:20px;font-weight:700;margin-bottom:5px">${t['Áî¢Ê•≠']}</div>
        <div class="card-meta">
            <span class="tag trend-up">${t['Ë∂®Âã¢Âà§Êñ∑']}</span>
            <span class="tag ind">${t['ÊôØÊ∞£‰ΩçÁΩÆ']}</span>
        </div>
    `;

    const stockCode = normalizeCode(t['ËÇ°Ëôü']);
    const content = `
        <div class="info-row"><span class="info-label">‰ª£Ë°®ÂÖ¨Âè∏</span><span class="info-val tag-link" onclick="openStock('${stockCode}')">${t['‰ª£Ë°®ÂÖ¨Âè∏']} ${stockCode}</span></div>
        <div class="section-head">üöÄ ÈóúÈçµÈ©ÖÂãïÂõ†Á¥†</div>
        <div class="hl-block">${fmtTxt(t['ÈóúÈçµÈ©ÖÂãïÂõ†Á¥†'])}</div>
        <div class="section-head">‚ö†Ô∏è È¢®Èö™Âõ†Á¥†</div>
        <div class="hl-block" style="border-left-color:#e74c3c">${fmtTxt(t['È¢®Èö™Âõ†Á¥†'])}</div>
        <div class="section-head">üîÆ 2026Â±ïÊúõ</div>
        <div class="hl-block">${fmtTxt(t['2026Â±ïÊúõ'])}</div>
        <div class="section-head">üí° ÊäïË≥áÂª∫Ë≠∞</div>
        <div class="hl-block">${fmtTxt(t['ÊäïË≥áÂª∫Ë≠∞'])}</div>
    `;

    $('m-body').innerHTML = `<div id="tab-main" class="tab-pane active">${content}</div>`;
    showModal(infoHtml, []);
};

// ÈñãÂïüÂ§ñÈõª
window.openNews = id => {
    const n = DB.news.find(i => String(i['Á∑®Ëôü']) === String(id));
    if(!n) return;

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;margin-bottom:5px">${n['ÂÖ¨Âè∏']} <span style="color:#999;font-size:14px">${n['ËÇ°Ëôü']}</span></div>
        <div class="card-meta">
            <span class="tag ind">${n['Â†±Â∞éÈáçÈªûÂàÜÈ°û']}</span>
            <span class="tag dt">${fmtDate(n['Êó•Êúü'])}</span>
        </div>
    `;

    let content = `<div class="hl-block">${fmtTxt(n['ÂÆåÊï¥Â†±Â∞éÂÖßÂÆπ'])}</div>`;
    if(n['Ê®ôÁ±§']) {
        content += `<div style="margin-top:15px;display:flex;flex-wrap:wrap;gap:5px">`;
        safe(n['Ê®ôÁ±§']).split(/[,Ôºå\s]+/).forEach(tag => {
            if(tag) content += `<span class="tag concept" style="cursor:pointer" onclick="setSearch('${tag}');closeModal()">${tag}</span>`;
        });
        content += `</div>`;
    }

    $('m-body').innerHTML = `<div id="tab-main" class="tab-pane active">${content}</div>`;
    showModal(infoHtml, []);
};

window.onload = init;
</script>
</body>
</html>
