<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rexå¤§å”çš„168å°è‚¡ç ”ç©¶å®¤ v11.6</title>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #c96442; --bg: #f5f4ef; --text: #333; --gray: #666; --border: #e0e0e0; --link: #2980b9; --up: #e74c3c; --down: #27ae60; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; }
        .container { max-width: 800px; margin: 0 auto; padding: 12px; }
        @media(min-width: 1024px) { .container { max-width: 1400px; padding: 20px; } }
        @media(min-width: 1600px) { .container { max-width: 1600px; } }

        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #e0e0e0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .header { text-align: center; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .header h1 { color: var(--primary); font-size: 22px; margin-bottom: 5px; font-weight: 800; }
        .db-switcher { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin: 15px 0; }
        .db-tab { padding: 6px 14px; background: #fff; border: 1px solid var(--border); border-radius: 20px; font-size: 13px; color: var(--gray); cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
        .db-tab:hover { border-color: var(--primary); }
        .db-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .count { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 10px; font-size: 10px; }

        .search-box { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 12px 35px 12px 40px; border-radius: 25px; border: 2px solid var(--border); background: #fff; font-size: 15px; outline: none; transition: border-color 0.2s; }
        .search-input:focus { border-color: var(--primary); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #999; }
        .clear-btn { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; background: #ccc; color: #fff; border-radius: 50%; font-size: 12px; line-height: 20px; text-align: center; cursor: pointer; display: none; }

        /* CB çµ±è¨ˆå€å¡Š */
        .cb-stats { background: #fff5f5; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #ffe0e0; }
        .cb-mode-header { background: linear-gradient(135deg, #e67e22, #d35400); color: #fff; padding: 10px 15px; border-radius: 10px 10px 0 0; font-weight: 700; font-size: 14px; text-align: center; margin-bottom: 0; }
        .cb-mode-switcher { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; background: #fff5f0; padding: 12px; border-radius: 0 0 10px 10px; border: 1px solid #f5d5c5; border-top: none; }
        .cb-mode-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        .cb-mode-tab { padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid #ddd; background: #fff; color: #666; transition: all 0.2s; }
        .cb-mode-tab:hover { border-color: var(--primary); }
        .cb-mode-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .cb-sub-switcher { display: flex; gap: 6px; margin-bottom: 12px; padding-left: 10px; }
        .cb-sub-tab { padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer; border: 1px solid #ccc; background: #f9f9f9; color: #666; transition: all 0.2s; }
        .cb-sub-tab:hover { border-color: #3498db; }
        .cb-sub-tab.active { background: #3498db; color: #fff; border-color: #3498db; }
        .cb-sub-tab.blue { border-color: #90caf9; background: #e3f2fd; color: #1976d2; }
        .cb-sub-tab.blue:hover { border-color: #1976d2; }
        .cb-sub-tab.blue.active { background: #1976d2; color: #fff; border-color: #1976d2; }
        .cb-sub-tabs { display: flex; gap: 8px; margin-bottom: 12px; padding: 10px; background: #e3f2fd; border-radius: 10px; flex-wrap: wrap; }
        .cb-info-tabs { display: flex; gap: 8px; margin-top: 12px; padding: 10px; background: #e8f5e9; border-radius: 10px; flex-wrap: wrap; }
        .cb-info-tab { padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: 600; cursor: pointer; border: 1px solid #a5d6a7; background: #e8f5e9; color: #2e7d32; transition: all 0.2s; }
        .cb-info-tab:hover { border-color: #4caf50; }
        .cb-info-tab.active { background: #4caf50; color: #fff; border-color: #4caf50; }
        .cb-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .cb-stat-item { background: #fff; padding: 12px 8px; border-radius: 8px; text-align: center; }
        .cb-stat-item.clickable { cursor: pointer; transition: all 0.2s; }
        .cb-stat-item.clickable:hover { background: #fff8f0; border: 1px solid var(--primary); }
        .cb-stat-num { font-size: 22px; font-weight: 800; color: var(--primary); }
        .cb-stat-label { font-size: 11px; color: #888; margin-top: 2px; }
        .cb-ind-title { font-size: 13px; font-weight: 600; color: #666; margin-bottom: 10px; }
        .cb-ind-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .cb-ind-tag { padding: 6px 12px; background: #fff; border-radius: 20px; font-size: 12px; color: #666; cursor: pointer; transition: all 0.2s; border: 1px solid #eee; }
        .cb-ind-tag:hover { border-color: var(--primary); color: var(--primary); }
        .cb-ind-tag .num { background: var(--primary); color: #fff; padding: 1px 6px; border-radius: 10px; font-size: 10px; margin-left: 4px; }
        
        /* ç«¶æ‹å‰ååè¡¨æ ¼ */
        .auction-top10-table { overflow-x: auto; margin-bottom: 10px; }
        .auction-top10-table table { width: 100%; border-collapse: collapse; font-size: 12px; background: #fff; border-radius: 8px; overflow: hidden; }
        .auction-top10-table th { background: #f8f8f8; padding: 8px 6px; text-align: center; font-weight: 600; color: #555; border-bottom: 1px solid #eee; white-space: nowrap; }
        .auction-top10-table td { padding: 8px 6px; text-align: center; border-bottom: 1px solid #f5f5f5; }
        .auction-top10-table tr:hover { background: #fff8f0; }
        .auction-top10-table .code { color: var(--primary); font-weight: 600; }
        .auction-top10-table .highlight { color: var(--primary); font-weight: 700; }
        .auction-top10-table .highlight-red { color: #e74c3c; font-weight: 700; }
        
        /* æµé€šé¤˜é¡å‰ååè¡¨æ ¼ */
        .balance-top10-table { overflow-x: auto; margin-bottom: 10px; }
        .balance-top10-table table { width: 100%; border-collapse: collapse; font-size: 12px; background: #fff; border-radius: 8px; overflow: hidden; }
        .balance-top10-table th { background: #f8f8f8; padding: 8px 4px; text-align: center; font-weight: 600; color: #555; border-bottom: 1px solid #eee; white-space: nowrap; font-size: 11px; }
        .balance-top10-table td { padding: 6px 4px; text-align: center; border-bottom: 1px solid #f5f5f5; font-size: 11px; }
        .balance-top10-table tr:hover { background: #fff8f0; }
        .balance-top10-table .code { color: var(--primary); font-weight: 600; }
        .balance-top10-table .name-cell { text-align: left; min-width: 80px; max-width: 120px; white-space: normal; line-height: 1.3; }
        .balance-top10-table .highlight-red { color: #e74c3c; font-weight: 700; }
        
        /* æµé€šé¤˜é¡ä¸»è¡¨æ ¼æ¬„å¯¬ç¸®æ¸› */
        .cb-table.balance-table { font-size: 11px; }
        .cb-table.balance-table th, .cb-table.balance-table td { padding: 6px 4px; }
        .cb-table.balance-table .name-col { max-width: 90px; white-space: normal; line-height: 1.3; text-align: left; }
        
        /* ä¸»æ—¨æ¬„ä½ */
        .cb-table .subject-col { text-align: left; font-size: 11px; line-height: 1.4; max-width: 300px; white-space: normal; }
        .cb-table .name-col { max-width: 100px; white-space: normal; line-height: 1.3; text-align: left; }

        .card-list { display: flex; flex-direction: column; gap: 12px; }
        @media(min-width: 1024px) { .card-list:not(.cb-mode) { display: grid; grid-template-columns: repeat(2, 1fr); } }
        @media(min-width: 1400px) { .card-list:not(.cb-mode) { grid-template-columns: repeat(3, 1fr); } }
        .card-list.cb-mode { display: block; }
        .card { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; transition: all 0.2s; }
        .card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .card.industry-card { border-left: 4px solid #9b59b6; background: linear-gradient(135deg, #faf8fc 0%, #fff 100%); }
        .card-head { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .card-title { font-weight: 700; font-size: 16px; color: #2c3e50; }
        .card-meta { display: flex; gap: 5px; margin-bottom: 8px; flex-wrap: wrap; }
        .tag { font-size: 11px; padding: 2px 8px; border-radius: 6px; color: #fff; font-weight: 500; }
        .tag.brk { background: var(--primary); }
        .tag.ind { background: #2980b9; }
        .tag.trend-ind { background: #8e44ad; }
        .tag.dt { background: #e0e0e0; color: #666; }
        .tag.concept { background: #8e44ad; }
        .tag.trend-up { background: #27ae60; }
        .tag.trend-down { background: #e74c3c; }
        .tag.trend-warning { background: #f39c12; }
        .trend-warning { color: #f39c12; }
        
        /* åˆ—è¡¨å…§ç¯©é¸æ¡† */
        .list-filter-bar { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .list-filter-input { flex: 1; min-width: 150px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px; font-size: 13px; outline: none; transition: border-color 0.2s; }
        .list-filter-input:focus { border-color: #e67e22; }
        .list-filter-count { font-size: 12px; color: #666; white-space: nowrap; }
        .list-filter-count b { color: #e67e22; }
        .tag.cb-tag { background: #e74c3c; font-size: 10px; padding: 1px 6px; }
        .cb-tags { display: flex; gap: 3px; flex-wrap: wrap; margin-left: auto; }
        .card-head { display: flex; align-items: center; gap: 8px; }
        .news-type { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 6px; font-weight: 600; }
        .news-type.ind-type { background: #9b59b6; color: #fff; }
        
        /* CB åŸºæœ¬è³‡æ–™å­æ¨™ç±¤ */
        .cb-info-tabs { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
        .cb-table tr.active-cb td { background: #e8f5e9; }
        .cb-table tr.active-cb:hover td { background: #c8e6c9; }
        
        /* çµæœåˆ—å’Œ CB ç¯©é¸æ¨™ç±¤ */
        .result-bar { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px; }
        .cb-filter-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .cb-filter-tag { font-size: 11px; padding: 4px 10px; border-radius: 15px; cursor: pointer; border: 1px solid #ddd; background: #fff; transition: all 0.2s; }
        .cb-filter-tag:hover { border-color: var(--primary); }
        .cb-filter-tag.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .cb-filter-tag .cnt { margin-left: 4px; opacity: 0.7; }
        .card-body { font-size: 13px; color: #555; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        /* CB åˆ—è¡¨è¡¨æ ¼ */
        .cb-table-wrap { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .cb-table { width: 100%; border-collapse: collapse; font-size: 13px; background: #fff; border-radius: 8px; overflow: hidden; }
        .cb-table th { background: #f8f9fa; padding: 12px 8px; text-align: center; color: #666; font-weight: 600; border-bottom: 2px solid #eee; white-space: nowrap; }
        .cb-table td { padding: 10px 8px; border-bottom: 1px solid #f0f0f0; text-align: center; white-space: nowrap; }
        .cb-table tr:hover td { background: #fffaf8; }
        .cb-table .code { color: var(--primary); font-weight: 600; cursor: pointer; }
        .cb-table .stock { color: var(--link); cursor: pointer; }
        .cb-table th.sortable { cursor: pointer; user-select: none; }
        .cb-table th.sortable:hover { background: #eee; }
        .cb-table th .sort-icon { font-size: 10px; color: #999; margin-left: 2px; }
        .cb-table th.sort-asc .sort-icon { color: var(--primary); }
        .cb-table th.sort-desc .sort-icon { color: var(--primary); }
        .cb-table th.sort-asc .sort-icon::after { content: 'â†‘'; }
        .cb-table th.sort-desc .sort-icon::after { content: 'â†“'; }
        .cb-table tfoot { background: #f8f9fa; }
        .cb-table tfoot td { border-top: 2px solid #ddd; padding: 12px 8px; }
        
        /* æ‰‹æ©Ÿç‰ˆéš±è—éƒ¨åˆ†æ¬„ä½ */
        @media(max-width: 768px) {
            .cb-table { font-size: 12px; }
            .cb-table th, .cb-table td { padding: 8px 5px; }
            .cb-table .hide-mobile { display: none; }
        }
        
        /* æ¡Œæ©Ÿç‰ˆæ»¿ç‰ˆ */
        @media(min-width: 1024px) {
            .cb-table { font-size: 14px; }
            .cb-table th, .cb-table td { padding: 12px 10px; }
        }

        /* Modal */
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-inner { background: #fff; width: 100%; max-width: 650px; height: 92vh; border-radius: 16px 16px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        @media(min-width: 1024px) { .modal-inner { max-width: 900px; } }
        @media(min-width: 1400px) { .modal-inner { max-width: 1100px; } }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        
        .m-head { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: flex-start; }
        .m-close { width: 32px; height: 32px; border-radius: 50%; border: none; background: #f0f0f0; font-size: 20px; color: #666; cursor: pointer; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .m-close:hover { background: #e0e0e0; }
        
        .nav-grid { display: flex; gap: 4px; padding: 10px 15px; background: #fafafa; border-bottom: 1px solid #eee; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .nav-btn { padding: 6px 10px; border-radius: 8px; border: none; background: #f0f0f0; font-size: 11px; font-weight: 600; color: #666; cursor: pointer; white-space: nowrap; transition: all 0.2s; flex-shrink: 0; }
        .nav-btn.active { background: var(--primary); color: #fff; }
        .nav-btn.green { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .nav-btn.green.active { background: #4caf50; color: #fff; border-color: #4caf50; }
        
        /* ç¯©é¸åŠŸèƒ½ */
        .filterable { cursor: pointer; position: relative; }
        .filterable:hover { background: #fff3cd; }
        .filter-dropdown { position: absolute; top: 100%; left: 0; background: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; min-width: 120px; max-height: 200px; overflow-y: auto; display: none; }
        .filter-dropdown.show { display: block; }
        .filter-dropdown div { padding: 8px 12px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #eee; }
        .filter-dropdown div:hover { background: #f5f5f5; }
        .filter-dropdown div.active { background: #e3f2fd; color: #1976d2; font-weight: 600; }
        .filter-dropdown div:last-child { border-bottom: none; }
        
        /* çµ±è¨ˆåˆ— */
        .stat-row { background: #f0f7ff !important; border-top: 2px solid var(--primary); }
        .stat-row td { color: var(--primary); }

        .m-body { flex: 1; overflow-y: auto; padding: 15px; background: #fff; -webkit-overflow-scrolling: touch; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        
        .m-footer-tags { padding: 12px 15px; border-top: 1px solid #eee; background: #fafafa; display: none; }
        .m-footer-tags.show { display: block; }
        .m-footer-tags .tags-wrap { display: flex; flex-wrap: wrap; gap: 6px; }
        .m-footer-tags .tag { padding: 6px 12px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .m-footer-tags .tag:hover { transform: scale(1.05); }

        .section-head { font-size: 14px; font-weight: 700; color: #444; margin: 20px 0 10px; padding: 8px 12px; background: linear-gradient(90deg, #f8f9fa, transparent); border-left: 4px solid var(--primary); border-radius: 0 8px 8px 0; }
        .section-head:first-child { margin-top: 0; }
        .hl-block { background: #fafaf8; padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary); margin-bottom: 10px; font-size: 13px; line-height: 1.7; white-space: pre-wrap; }
        .hl-block b { color: var(--primary); }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .info-label { color: #666; }
        .info-val { font-weight: 600; color: #333; }
        
        .list-item { padding: 12px; border: 1px solid #eee; border-radius: 10px; margin-bottom: 8px; background: #fff; cursor: pointer; transition: all 0.2s; }
        .list-item:hover { border-color: var(--primary); background: #fffaf8; }
        .list-title { font-weight: 700; font-size: 14px; color: #2c3e50; margin-bottom: 4px; }
        .list-sub { font-size: 12px; color: #888; margin-bottom: 6px; }
        .list-content { font-size: 13px; color: #555; line-height: 1.6; white-space: pre-wrap; }

        .tag-link { color: var(--link); cursor: pointer; font-weight: 600; }
        .tag-link:hover { text-decoration: underline; }
        
        .fin-switcher { display: flex; margin-bottom: 10px; border: 1px solid var(--primary); border-radius: 6px; overflow: hidden; }
        .fin-btn { flex: 1; padding: 8px; text-align: center; font-size: 13px; color: var(--primary); background: #fff; cursor: pointer; font-weight: 600; border-right: 1px solid var(--primary); transition: all 0.2s; }
        .fin-btn:last-child { border-right: none; }
        .fin-btn.active { background: var(--primary); color: #fff; }
        .fin-sub-pane { display: none; }
        .fin-sub-pane.active { display: block; }
        
        .rev-unit { text-align: right; font-size: 11px; color: #888; margin-bottom: 8px; }

        .table-wrap { overflow-x: auto; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .fin-table { width: 100%; border-collapse: collapse; font-size: 12px; white-space: nowrap; }
        .fin-table th { background: #f8f9fa; padding: 10px 8px; border-bottom: 2px solid #ddd; text-align: right; color: #555; position: sticky; top: 0; }
        .fin-table td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: right; color: #333; }
        .fin-table th:first-child, .fin-table td:first-child { position: sticky; left: 0; background: #fff; border-right: 1px solid #eee; text-align: left; z-index: 2; font-weight: 700; }
        .fin-table tr:nth-child(even) td { background: #fcfcfc; }
        .fin-table tr:nth-child(even) td:first-child { background: #fcfcfc; }
        .fin-table .highlight-row td { background: #fff3e0; font-weight: 700; }
        .fin-table .highlight-row td:first-child { background: #fff3e0; color: var(--primary); }
        
        .t-up { color: var(--up); font-weight: 700; }
        .t-down { color: var(--down); font-weight: 700; }

        .rating-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .rating-card .big-num { font-size: 28px; font-weight: 800; }
        .rating-card .label { font-size: 12px; opacity: 0.8; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #f8f9fa; padding: 12px; text-align: center; border-radius: 8px; }
        .stat-box .num { font-size: 18px; font-weight: 700; color: var(--primary); }
        .stat-box .lbl { font-size: 11px; color: #888; margin-top: 2px; }

        .qa-item { margin-bottom: 15px; }
        .qa-q { background: #e3f2fd; padding: 10px 12px; border-radius: 8px 8px 0 0; font-weight: 600; color: #1565c0; font-size: 13px; }
        .qa-a { background: #f5f5f5; padding: 10px 12px; border-radius: 0 0 8px 8px; font-size: 13px; line-height: 1.6; color: #444; }

        .timeline-item { position: relative; padding-left: 20px; margin-bottom: 12px; }
        .timeline-item::before { content: ''; position: absolute; left: 0; top: 8px; width: 10px; height: 10px; background: var(--primary); border-radius: 50%; }
        .timeline-item::after { content: ''; position: absolute; left: 4px; top: 20px; width: 2px; height: calc(100% + 4px); background: #e0e0e0; }
        .timeline-item:last-child::after { display: none; }
        .timeline-date { font-size: 12px; font-weight: 700; color: var(--primary); }
        .timeline-text { font-size: 13px; color: #444; margin-top: 2px; }

        @media(min-width: 768px) { .modal { align-items: center; } .modal-inner { height: 85vh; border-radius: 16px; } }
        @media(max-width: 480px) { .cb-stats-grid { grid-template-columns: repeat(3, 1fr); } .cb-stat-num { font-size: 18px; } }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="loading-spinner"></div>
    <div style="font-weight:700;font-size:18px">Rexå¤§å”çš„168å°è‚¡ç ”ç©¶å®¤</div>
    <div style="font-size:12px;color:#888;margin-top:8px" id="loadStatus">æ­£åœ¨è¼‰å…¥è³‡æ–™åº«...</div>
</div>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š Rexå¤§å”çš„168å°è‚¡ç ”ç©¶å®¤</h1>
        <p style="font-size:12px;color:#666">å…¨æ–¹ä½å°è‚¡æŠ•è³‡æ±ºç­–ç³»çµ± v11.6</p>
    </div>

    <div class="db-switcher">
        <div class="db-tab active" data-db="news">âš¡ å¤–é›» <span class="count" id="c-news">0</span></div>
        <div class="db-tab" data-db="memo">ğŸ“‹ Memo <span class="count" id="c-memo">0</span></div>
        <div class="db-tab" data-db="reports">ğŸ“‘ ç”¢æ¥­ <span class="count" id="c-reports">0</span></div>
        <div class="db-tab" data-db="strategy">ğŸ”® å±•æœ› <span class="count" id="c-strategy">0</span></div>
        <div class="db-tab" data-db="stocks">ğŸ¢ å€‹è‚¡ <span class="count" id="c-stocks">0</span></div>
        <div class="db-tab" data-db="trends">ğŸ“ˆ è¶¨å‹¢ <span class="count" id="c-trends">0</span></div>
        <div class="db-tab" data-db="cb">ğŸ« CB <span class="count" id="c-cb">0</span></div>
        <div class="db-tab" data-db="article">ğŸ“ æ–‡ç«  <span class="count" id="c-article">0</span></div>
    </div>

    <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input type="text" class="search-input" id="search" placeholder="æœå°‹å…¬å¸ã€ä»£è™Ÿã€ç”¢æ¥­ã€#Tag..." oninput="handleInput(this)">
        <div class="clear-btn" id="clearBtn" onclick="clearSearch()">âœ•</div>
    </div>

    <!-- CB çµ±è¨ˆå€å¡Š (åªåœ¨ CB åˆ†é é¡¯ç¤º) -->
    <div id="cbStatsArea" style="display:none"></div>
    
    <!-- å€‹è‚¡çµ±è¨ˆå€å¡Š (åªåœ¨å€‹è‚¡åˆ†é é¡¯ç¤º) -->
    <div id="stockStatsArea" style="display:none"></div>
    
    <!-- Memo çµ±è¨ˆå€å¡Š (åªåœ¨ Memo åˆ†é é¡¯ç¤º) -->
    <div id="memoStatsArea" style="display:none"></div>

    <div class="result-bar">
        <div style="font-size:12px;color:#666;">æ‰¾åˆ° <b id="resCount" style="color:var(--primary)">0</b> ç­†è³‡æ–™</div>
        <div id="cbFilterTags" class="cb-filter-tags" style="display:none"></div>
    </div>
    <div class="card-list" id="list"></div>
</div>

<div class="modal" id="modal" onclick="closeModal(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">
        <div class="m-head">
            <div id="m-info" style="flex:1"></div>
            <button class="m-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="nav-grid" id="navGrid"></div>
        <div class="m-body" id="m-body"></div>
        <div class="m-footer-tags" id="m-tags"></div>
    </div>
</div>

<script>
const FILES = {
    NEWS: '01_news.xlsx', MEMO: '02_memo.xlsx', REPORTS: '03_reports.xlsx',
    MASTER: '04_master.xlsx', STRAT: '05_Strategy_01.xlsx', CB: '00_CB.xlsx', REV: '06_revenue.xlsx', ARTICLE: '07_article.xlsx'
};

const DB = { 
    news:[], memo:[], memoStock:[], memoIndustry:[], reports:[], strategy:[], stocks:{}, 
    cb:[], cbHistory:[], cbAuction:[], cbPrimary:[], cbBoard:[], cbBalance:[], cbCBAS:[],
    cbRedeem:[], cbStopConv:[], cbPriceAdj:[], cbConcept:[], cbAll:[], cbPutback:[],
    conceptLists: {}, // å„æ¦‚å¿µè‚¡æ¸…å–® { 'NVDIAæ¦‚å¿µè‚¡': ['6579','2353',...], ... }
    trends:[], conceptStocks:[], article:[] 
};
let CB_MODE = 'info'; // 'info' åŸºæœ¬è³‡æ–™, 'active' æ›ç‰Œä¸­, 'history' æ­·å², 'auction' ç«¶æ‹, 'primary' åˆç´šå¸‚å ´, 'balance' æµé€šé¤˜é¡, 'cbas' CBASå ±åƒ¹
let CB_INFO_TAB = 'issue'; // 'issue' ç™¼è¡Œæ¢ä»¶, 'timeline' æ™‚ç¨‹è³‡è¨Š, 'putback' è³£å›æ¢ä»¶
let CB_INFO_SUB = 'stats'; // 'stats' çµ±è¨ˆ, 'industry' ç”¢æ¥­åˆ†ä½ˆ
let PRIMARY_MODE = 'underwriting'; // 'underwriting' æ‰¿éŠ·ä¸­, 'board' è‘£äº‹æœƒå…¬å‘Š
let STOCK_MODE = 'all'; // 'all' å…¨éƒ¨å€‹è‚¡, 'concept' æ¦‚å¿µè‚¡
let MEMO_MODE = 'all'; // 'all' å…¨éƒ¨, 'stock' å€‹è‚¡, 'industry' ç”¢æ¥­
const META = { 
    memoDetail:{}, tracking:{}, finance:{}, products:{}, 
    concepts:{}, cbMap:{}, relatedNews:{}, relatedMemo:{},
    reportFocus:{}, reportViews:{}, reportRatings:{},
    stratMacro:{}, stratFundamental:{}, stratTheme:{}, stratChip:{}, stratTech:{}, stratQuarter:{}, stratPicks:{},
    revData: { month:{}, quarter:{}, year:{}, highlights:{} },
    cbStats: { total: 0, companies: 0, industries: {}, totalBalance: 0 },
    cbPrimaryStats: { underwriting: 0, board: 0 },
    cbBalanceStats: { total: 0, totalBalance: 0 },
    cbCBASStats: { total: 0 },
    stockStats: { total: 0, conceptTotal: 0, markets: {}, industries: {}, conceptCategories: {} },
    memoStats: { total: 0, stockTotal: 0, industryTotal: 0, brokers: {}, types: {} }
};

let CURR_DB = 'news';
const $ = id => document.getElementById(id);
const safe = v => (v==null||v==undefined?'':String(v).trim());

// çµ±ä¸€ä»£ç¢¼è™•ç†å‡½æ•¸
const normalizeCode = v => {
    if(!v) return '';
    let s = String(v).trim();
    // ç§»é™¤ .0 (Excel æ•¸å­—æ ¼å¼)
    if(s.match(/^\d+\.0$/)) s = s.replace('.0', '');
    // ç§»é™¤ TT å¾Œç¶´
    s = s.replace(/\s*TT$/i, '');
    // è£œé›¶åˆ°4ä½
    if(s.match(/^\d{1,4}$/) && s.length < 4) s = s.padStart(4, '0');
    return s;
};

const fmtDate = v => {
    if(!v) return '';
    if(typeof v === 'number' && v > 20000) { 
        const d = new Date((v-25569)*86400000); 
        return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`; 
    }
    return String(v).split(' ')[0].split('T')[0];
};
const getDateVal = v => { if(!v) return 0; if(typeof v === 'number') return (v-25569)*86400000; return new Date(v).getTime(); };
const fmtNum = (v, decimal=0) => {
    if(v===undefined||v===null||v==='') return '-';
    let n = parseFloat(String(v).replace(/,/g,''));
    if(isNaN(n)) return v;
    return decimal > 0 ? n.toFixed(decimal) : n.toLocaleString();
};
const colorClass = v => {
    if(!v||v==='-') return '';
    let n = parseFloat(String(v).replace(/[%$,]/g,''));
    return n>0?'t-up':n<0?'t-down':'';
};

const fmtTxt = t => {
    if(!t) return '';
    let html = safe(t).replace(/\n/g, '<br>');
    html = html.replace(/#(\S+)/g, '<span class="tag-link" onclick="setSearch(\'#$1\');closeModal()">#$1</span>');
    return html;
};

function handleInput(el) { 
    $('clearBtn').style.display = el.value.length > 0 ? 'block' : 'none'; 
    renderList(); 
}
function clearSearch() { 
    $('search').value=''; 
    $('search').focus(); 
    $('clearBtn').style.display='none'; 
    renderList(); 
}
window.setSearch = term => { $('search').value = term; handleInput($('search')); };

async function fetchXlsx(url) {
    try {
        $('loadStatus').innerText = `è¼‰å…¥ ${url}...`;
        const res = await fetch(url);
        if(!res.ok) throw new Error();
        return XLSX.read(await res.arrayBuffer(), {type:'array'});
    } catch(e) { console.warn('Load Error:', url); return null; }
}

async function init() {
  try {
    let wb;
    
    // 1. Master + æ¦‚å¿µè‚¡
    wb = await fetchXlsx(FILES.MASTER);
    if(wb) {
        // ä¸»è³‡æ–™åº«
        XLSX.utils.sheet_to_json(wb.Sheets['ä¸»è³‡æ–™åº«']||[]).forEach(r => {
            const code = normalizeCode(r['ä»£è™Ÿ']);
            if(code) {
                DB.stocks[code] = {...r, 'ä»£è™Ÿ': code};
                // çµ±è¨ˆå¸‚å ´å’Œç”¢æ¥­
                const market = r['å¸‚å ´åˆ†é¡'] || 'å…¶ä»–';
                const industry = r['ç”¢æ¥­åˆ†é¡'] || 'å…¶ä»–';
                META.stockStats.markets[market] = (META.stockStats.markets[market] || 0) + 1;
                META.stockStats.industries[industry] = (META.stockStats.industries[industry] || 0) + 1;
            }
        });
        META.stockStats.total = Object.keys(DB.stocks).length;
        
        // æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«
        const csSheet = wb.Sheets['ğŸ’¡æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«'];
        if(csSheet) {
            const range = XLSX.utils.decode_range(csSheet['!ref']);
            for(let R=3; R<=range.e.r; R++) {
                const code = normalizeCode(csSheet[XLSX.utils.encode_cell({r:R,c:0})]?.v);
                const name = csSheet[XLSX.utils.encode_cell({r:R,c:1})]?.v;
                const concept = csSheet[XLSX.utils.encode_cell({r:R,c:2})]?.v;
                const subCat = csSheet[XLSX.utils.encode_cell({r:R,c:3})]?.v;
                const desc = csSheet[XLSX.utils.encode_cell({r:R,c:4})]?.v;
                const importance = csSheet[XLSX.utils.encode_cell({r:R,c:5})]?.v;
                
                if(code && concept) {
                    // åŸæœ‰çš„ META.concepts å°ç…§
                    if(!META.concepts[code]) META.concepts[code] = [];
                    META.concepts[code].push({ concept: safe(concept), sub: safe(subCat) });
                    
                    // æ–°å¢åˆ° conceptStocks é™£åˆ—
                    DB.conceptStocks.push({
                        '_code': code,
                        '_name': safe(name),
                        '_concept': safe(concept),
                        '_subCat': safe(subCat),
                        '_desc': safe(desc),
                        '_importance': safe(importance),
                        '_industry': DB.stocks[code]?.['ç”¢æ¥­åˆ†é¡'] || ''
                    });
                    
                    // çµ±è¨ˆæ¦‚å¿µåˆ†é¡
                    META.stockStats.conceptCategories[concept] = (META.stockStats.conceptCategories[concept] || 0) + 1;
                }
            }
        }
        META.stockStats.conceptTotal = DB.conceptStocks.length;
        console.log('å€‹è‚¡è¼‰å…¥:', META.stockStats.total, 'æ¦‚å¿µè‚¡:', META.stockStats.conceptTotal);
        
        // è¼‰å…¥å„æ¦‚å¿µè‚¡æ¸…å–®å·¥ä½œè¡¨
        const conceptSheets = ['å¯Œæ«ƒ50æˆä»½è‚¡', 'å°ç£50æˆä»½è‚¡', 'ä¸­å‹100æˆä»½è‚¡', 'NVDIAæ¦‚å¿µè‚¡', 'å°ç©é›»æ¦‚å¿µè‚¡'];
        conceptSheets.forEach(sheetName => {
            const sheet = wb.Sheets[sheetName];
            if(sheet) {
                const rows = XLSX.utils.sheet_to_json(sheet);
                DB.conceptLists[sheetName] = rows.map(r => normalizeCode(r['ä»£ç¢¼'])).filter(c => c);
                console.log(`${sheetName}: ${DB.conceptLists[sheetName].length} æª”`);
            }
        });
    }

    // 2. Revenue - å®Œæ•´è®€å–
    wb = await fetchXlsx(FILES.REV);
    if(wb) {
        // æœˆç‡Ÿæ”¶ - æ”¶é›†å®Œæ•´è³‡æ–™
        const sheetM = wb.Sheets['000_æœˆç‡Ÿæ”¶'];
        if(sheetM) {
            const rows = XLSX.utils.sheet_to_json(sheetM, {defval: null});
            if(rows.length > 0) {
                const headers = Object.keys(rows[0]);
                const mCols = headers.filter(h => h.includes('å–®æœˆç‡Ÿæ”¶')).sort();
                const accCols = headers.filter(h => h.includes('ç´¯æœˆç‡Ÿæ”¶(å„„)') && !h.includes('å–®æœˆ')).sort();
                
                console.log('æœˆç‡Ÿæ”¶æ¬„ä½:', mCols.length, 'ç´¯è¨ˆæ¬„ä½:', accCols.length);
                
                rows.forEach(r => {
                    const code = normalizeCode(r['ä»£è™Ÿ']);
                    if(!code || code.length > 5 || code.startsWith('0')) return;
                    
                    const data = [];
                    mCols.forEach(col => {
                        const m = col.match(/(\d+)M(\d+)/);
                        if(m && r[col] !== null && r[col] !== undefined) {
                            // 25M08 = 2025å¹´8æœˆ (å‰å…©ä½å°±æ˜¯è¥¿å…ƒå¹´å¾Œå…©ä½)
                            const year = 2000 + parseInt(m[1]);
                            const month = parseInt(m[2]);
                            const period = `${year}/${month.toString().padStart(2, '0')}`;
                            const accCol = accCols.find(c => c.includes(m[0]));
                            data.push({ 
                                d: period,
                                period: m[0],
                                year: year,
                                month: month,
                                rev: r[col],
                                acc: accCol ? r[accCol] : null
                            });
                        }
                    });
                    
                    if(data.length > 0) {
                        // æŒ‰æ—¥æœŸæ’åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
                        data.sort((a, b) => b.d.localeCompare(a.d));
                        META.revData.month[code] = data;
                    }
                });
                console.log('æœˆç‡Ÿæ”¶è¼‰å…¥å…¬å¸æ•¸:', Object.keys(META.revData.month).length);
            }
        }
        
        // å­£ç‡Ÿæ”¶
        const sheetQ = wb.Sheets['000_å­£ç‡Ÿæ”¶'];
        if(sheetQ) {
            const rows = XLSX.utils.sheet_to_json(sheetQ, {defval: null});
            if(rows.length > 0) {
                const headers = Object.keys(rows[0]);
                const qCols = headers.filter(h => h.includes('å–®å­£ç‡Ÿæ”¶')).sort();
                
                rows.forEach(r => {
                    const code = normalizeCode(r['ä»£è™Ÿ']);
                    if(!code || code.length > 5 || code.startsWith('0')) return;
                    
                    const data = [];
                    qCols.forEach(col => {
                        const m = col.match(/(\d+)Q(\d)/);
                        if(m && r[col] !== null && r[col] !== undefined) {
                            const year = 2000 + parseInt(m[1]);
                            data.push({ 
                                d: `${year}Q${m[2]}`, 
                                year: year,
                                q: parseInt(m[2]),
                                rev: r[col] 
                            });
                        }
                    });
                    
                    if(data.length > 0) {
                        data.sort((a, b) => b.d.localeCompare(a.d));
                        META.revData.quarter[code] = data;
                    }
                });
                console.log('å­£ç‡Ÿæ”¶è¼‰å…¥å…¬å¸æ•¸:', Object.keys(META.revData.quarter).length);
            }
        }
        
        // å¹´ç‡Ÿæ”¶
        const sheetY = wb.Sheets['000_å¹´ç‡Ÿæ”¶'];
        if(sheetY) {
            const rows = XLSX.utils.sheet_to_json(sheetY, {defval: null});
            if(rows.length > 0) {
                const headers = Object.keys(rows[0]);
                const yCols = headers.filter(h => h.includes('å¹´åº¦ç‡Ÿæ”¶')).sort();
                
                rows.forEach(r => {
                    const code = normalizeCode(r['ä»£è™Ÿ']);
                    if(!code || code.length > 5 || code.startsWith('0')) return;
                    
                    const data = [];
                    yCols.forEach(col => {
                        const m = col.match(/(\d{4})/);
                        if(m && r[col] !== null && r[col] !== undefined) {
                            data.push({ 
                                d: m[0], 
                                year: parseInt(m[0]),
                                rev: r[col] 
                            });
                        }
                    });
                    
                    if(data.length > 0) {
                        data.sort((a, b) => b.year - a.year);
                        META.revData.year[code] = data;
                    }
                });
                console.log('å¹´ç‡Ÿæ”¶è¼‰å…¥å…¬å¸æ•¸:', Object.keys(META.revData.year).length);
            }
        }
        
        // è²¡å ±å‚™è¨»
        const sheetH = wb.Sheets['10_è²¡å ±å‚™è¨»'];
        if(sheetH) {
            XLSX.utils.sheet_to_json(sheetH, {defval: null}).forEach(r => {
                const code = normalizeCode(r['ä»£è™Ÿ']);
                if(code) META.revData.highlights[code] = r;
            });
        }
    }

    // 3. News
    wb = await fetchXlsx(FILES.NEWS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å¤–é›»ç¶œåˆå ±å°']||[]).forEach(r => {
            const code = normalizeCode(r['è‚¡è™Ÿ']);
            DB.news.push({...r, 'è‚¡è™Ÿ': code});
            if(code) { 
                if(!META.relatedNews[code]) META.relatedNews[code]=[]; 
                META.relatedNews[code].push(r); 
            }
        });
        DB.news.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
        console.log('Newsè¼‰å…¥:', DB.news.length);
    }

    // 4. Memo
    wb = await fetchXlsx(FILES.MEMO);
    if(wb) {
        // ç”¢æ¥­é¡å ±å‘Šé—œéµå­—
        const industryKeywords = ['ç”¢æ¥­', 'TPCA', 'åœ‹éš›è‚¡å¸‚', 'ç¸½ç¶“', 'ç­–ç•¥'];
        
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¡¨']||[]).forEach(r => {
            const code = normalizeCode(r['è‚¡è™Ÿ']);
            const reportType = safe(r['å ±å‘Šé¡å‹']);
            const memoData = {...r, 'è‚¡è™Ÿ': code};
            
            DB.memo.push(memoData);
            
            // åˆ¤æ–·æ˜¯å€‹è‚¡é‚„æ˜¯ç”¢æ¥­
            const isIndustry = industryKeywords.some(kw => reportType.includes(kw));
            if(isIndustry) {
                DB.memoIndustry.push(memoData);
            } else {
                DB.memoStock.push(memoData);
            }
            
            // çµ±è¨ˆåˆ¸å•†å’Œå ±å‘Šé¡å‹
            const broker = safe(r['åˆ¸å•†']);
            if(broker) META.memoStats.brokers[broker] = (META.memoStats.brokers[broker] || 0) + 1;
            if(reportType) META.memoStats.types[reportType] = (META.memoStats.types[reportType] || 0) + 1;
            
            if(code) { 
                if(!META.relatedMemo[code]) META.relatedMemo[code]=[]; 
                META.relatedMemo[code].push(r); 
            }
        });
        DB.memo.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
        DB.memoStock.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
        DB.memoIndustry.sort((a,b) => getDateVal(b['æ—¥æœŸ'])-getDateVal(a['æ—¥æœŸ']));
        
        META.memoStats.total = DB.memo.length;
        META.memoStats.stockTotal = DB.memoStock.length;
        META.memoStats.industryTotal = DB.memoIndustry.length;
        console.log('Memoè¼‰å…¥:', META.memoStats.total, 'å€‹è‚¡:', META.memoStats.stockTotal, 'ç”¢æ¥­:', META.memoStats.industryTotal);
        
        XLSX.utils.sheet_to_json(wb.Sheets['è©³ç´°å…§å®¹åº«']||[]).forEach(r => META.memoDetail[safe(r['ç·¨è™Ÿ'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['è²¡å‹™æ•¸æ“šå½™ç¸½']||[]).forEach(r => META.finance[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢å“çµæ§‹åˆ†æ']||[]).forEach(r => META.products[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['å…¬å¸è¿½è¹¤è¡¨']||[]).forEach(r => META.tracking[safe(r['å…¬å¸'])] = r);
        XLSX.utils.sheet_to_json(wb.Sheets['ç”¢æ¥­è¶¨å‹¢ç¸½è¦½']||[]).forEach(r => {
            if(r['ç”¢æ¥­']) DB.trends.push(r);
        });
    }

    // 5. Reports
    wb = await fetchXlsx(FILES.REPORTS);
    if(wb) {
        XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r => DB.reports.push(r));
        DB.reports.sort((a,b) => getDateVal(b['å ±å‘Šæ—¥æœŸ'])-getDateVal(a['å ±å‘Šæ—¥æœŸ']));
        
        XLSX.utils.sheet_to_json(wb.Sheets['ç„¦é»åˆ†æå…§å®¹']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.reportFocus[rid]) META.reportFocus[rid]=[]; META.reportFocus[rid].push(r); }
        });
        XLSX.utils.sheet_to_json(wb.Sheets['åˆ¸å•†è§€é»çµè«–']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) META.reportViews[rid] = r;
        });
        XLSX.utils.sheet_to_json(wb.Sheets['å€‹è‚¡è©•åƒ¹è¡¨']||[]).forEach(r => {
            const rid = safe(r['å ±å‘Šç·¨è™Ÿ']);
            if(rid) { if(!META.reportRatings[rid]) META.reportRatings[rid]=[]; META.reportRatings[rid].push(r); }
        });
    }

    // 6. Strategy (è¶¨å‹¢å±•æœ›) - æ–°æ ¼å¼
    wb = await fetchXlsx(FILES.STRAT);
    if(wb) {
        // è®€å–å ±å‘Šç´¢å¼•
        const indexSheet = wb.Sheets['å ±å‘Šç´¢å¼•'];
        if(indexSheet) {
            const indexData = XLSX.utils.sheet_to_json(indexSheet, {header: 1});
            // æ‰¾å ±å‘Šæ¸…å–®é–‹å§‹ä½ç½® (è·³éæ¨™é¡Œ)
            for(let i = 0; i < indexData.length; i++) {
                const row = indexData[i];
                if(row[0] === 'å ±å‘Šç·¨è™Ÿ') {
                    // æ¥ä¸‹ä¾†æ˜¯å ±å‘Šè³‡æ–™
                    for(let j = i+1; j < indexData.length; j++) {
                        const r = indexData[j];
                        if(r[0] && r[0].startsWith('RPT-')) {
                            const rptId = r[0];
                            const sheetName = wb.SheetNames.find(n => n.includes(rptId.replace('-', '')));
                            
                            DB.strategy.push({
                                'å ±å‘Šç·¨è™Ÿ': rptId,
                                'å ±å‘Šä¸»é¡Œ': r[1],
                                'ä¸»è¬›å–®ä½': r[2],
                                'è¬›è€…': r[3],
                                'å ±å‘Šæ—¥æœŸ': r[4],
                                'é æ•¸': r[5],
                                '_sheetName': sheetName
                            });
                        }
                    }
                    break;
                }
            }
        }
        
        // è®€å–æ¯å€‹å ±å‘Šçš„è©³ç´°å…§å®¹
        DB.strategy.forEach(report => {
            const sheetName = report._sheetName;
            if(sheetName && wb.Sheets[sheetName]) {
                const sheetData = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {header: 1});
                const sections = [];
                let currentSection = null;
                let basicInfo = {};
                
                for(let i = 1; i < sheetData.length; i++) {
                    const row = sheetData[i];
                    const tag = row[0];
                    const val = row[1];
                    
                    if(!tag) continue;
                    
                    // åŸºæœ¬è³‡è¨Šæ¬„ä½
                    if(['å ±å‘Šç·¨è™Ÿ', 'å ±å‘Šä¸»é¡Œ', 'å‰¯æ¨™é¡Œ', 'ç™¼å¸ƒå–®ä½', 'ä¸»è¬›äºº', 'ç™¼å¸ƒæ—¥æœŸ', 'å ±å‘Šé æ•¸', 'æ ¸å¿ƒè§€é»', 'æ¨™ç±¤åˆ†é¡', 'è³‡æ–™ä¾†æº'].includes(tag)) {
                        basicInfo[tag] = val;
                        continue;
                    }
                    
                    // åˆ†é¡æ¨™é¡Œ (ç”¨ã€ã€‘åŒ…èµ·ä¾†)
                    if(tag.startsWith('ã€') && tag.endsWith('ã€‘')) {
                        if(currentSection) sections.push(currentSection);
                        currentSection = { title: tag, items: [] };
                    } else if(currentSection) {
                        currentSection.items.push({ label: tag, value: val });
                    }
                }
                if(currentSection) sections.push(currentSection);
                
                // å„²å­˜åˆ° META
                META.stratSections = META.stratSections || {};
                META.stratSections[report['å ±å‘Šç·¨è™Ÿ']] = {
                    basic: basicInfo,
                    sections: sections
                };
            }
        });
        
        DB.strategy.sort((a,b) => getDateVal(b['å ±å‘Šæ—¥æœŸ'])-getDateVal(a['å ±å‘Šæ—¥æœŸ']));
        console.log('è¶¨å‹¢å±•æœ›è¼‰å…¥:', DB.strategy.length, 'ç¯‡å ±å‘Š');
    }

    // 7. CB - å®Œæ•´è®€å–
    wb = await fetchXlsx(FILES.CB);
    if(wb) {
        // å…ˆè®€å–æ›ç‰Œé«˜ä½è³‡æ–™ (00å·¥ä½œè¡¨)
        const cbHighLow = {};
        const sheet00Name = wb.SheetNames.find(n => n.startsWith('00_'));
        if(sheet00Name) {
            XLSX.utils.sheet_to_json(wb.Sheets[sheet00Name]||[]).forEach(r => {
                const cbCode = safe(r['ä»£è™Ÿ']);
                if(cbCode) {
                    const high = parseFloat(r['æ›ç‰Œæœ€é«˜']) || 0;
                    const low = parseFloat(r['æ›ç‰Œæœ€ä½']) || 0;
                    cbHighLow[cbCode] = {
                        high: high,
                        low: low,
                        range: low > 0 ? ((high - low) / low * 100) : 0,
                        avgVol: r['æœˆå‡æˆäº¤']
                    };
                }
            });
        }
        
        // è®€å– 09_æœ€æ–°å‹•æ…‹æ¯é€±æ—¥è¡Œæƒ… - å–å¾—æœ€æ–°æ”¶ç›¤åƒ¹
        const cbLatestPrice = {};
        XLSX.utils.sheet_to_json(wb.Sheets['09_æœ€æ–°å‹•æ…‹æ¯é€±æ—¥è¡Œæƒ…']||[]).forEach(r => {
            const cbCode = safe(r['ä»£ç¢¼']);
            if(cbCode) {
                cbLatestPrice[cbCode] = parseFloat(r['CBæ”¶ç›¤åƒ¹']) || 0;
            }
        });
        
        // è®€å– 05_CBç«¶æ‹ç¯©é¸æ¢ä»¶å€é–“ - å»ºç«‹ç”¢æ¥­ç°¡ç¨±å°ç…§è¡¨
        const industrySimpleMap = {
            'å…‰é›»æ¥­': 'å…‰é›»', 'å…¶ä»–æ¥­': 'å…¶ä»–', 'å…¶ä»–æ¥­é›»å­æ¥­': 'å…¶ä»–é›»å­',
            'åŒ–å­¸å·¥æ¥­': 'åŒ–å·¥', 'åŠå°é«”æ¥­': 'åŠå°é«”', 'å¡‘è† å·¥æ¥­': 'å¡‘è† ',
            'å±…å®¶ç”Ÿæ´»': 'å±…å®¶ç”Ÿæ´»', 'å»ºæç‡Ÿé€ æ¥­': 'å»ºæç‡Ÿé€ ', 'æ•¸ä½é›²ç«¯': 'æ•¸ä½é›²ç«¯',
            'æ–‡åŒ–å‰µæ„æ¥­': 'æ–‡åŒ–å‰µæ„', 'æ©¡è† å·¥æ¥­': 'å…¶ä»–', 'æ°´æ³¥å·¥æ¥­': 'æ°´æ³¥',
            'æ±½è»Šå·¥æ¥­': 'æ±½è»Š', 'æ²¹é›»ç‡ƒæ°£æ¥­': 'æ²¹é›»ç‡ƒæ°£', 'ç»ç’ƒé™¶ç“·': 'å…¶ä»–',
            'ç”ŸæŠ€é†«ç™‚æ¥­': 'ç”ŸæŠ€é†«ç™‚', 'ç´¡ç¹”çº–ç¶­': 'ç´¡ç¹”çº–ç¶­', 'ç¶ èƒ½ç’°ä¿': 'ç¶ èƒ½ç’°ä¿',
            'èˆªé‹æ¥­': 'èˆªé‹', 'è§€å…‰é¤æ—…': 'è§€å…‰é¤æ—…', 'è­‰åˆ¸æ¥­': 'é‡‘èä¿éšª',
            'è²¿æ˜“ç™¾è²¨æ¥­': 'è²¿æ˜“ç™¾è²¨', 'è³‡è¨Šæœå‹™æ¥­': 'è³‡è¨Šæœå‹™', 'è¾²æ¥­ç§‘æŠ€æ¥­': 'è¾²æ¥­ç§‘æŠ€',
            'é€šä¿¡ç¶²è·¯æ¥­': 'é€šä¿¡ç¶²è·¯', 'é€ ç´™å·¥æ¥­': 'é€ ç´™', 'é‹å‹•ä¼‘é–’': 'é‹å‹•ä¼‘é–’',
            'é‡‘æ§æ¥­': 'é‡‘èä¿éšª', 'éŠ€è¡Œæ¥­': 'é‡‘èä¿éšª', 'é‹¼éµå·¥æ¥­': 'é‹¼éµ',
            'é›»å™¨é›»çºœ': 'é›»å™¨é›»çºœ', 'é›»å­é€šè·¯æ¥­': 'é›»å­é€šè·¯', 'é›»å­é›¶çµ„ä»¶æ¥­': 'é›»å­é›¶çµ„ä»¶',
            'é›»æ©Ÿæ©Ÿæ¢°': 'é›»æ©Ÿæ©Ÿæ¢°', 'é›»è…¦åŠé€±é‚Šè¨­å‚™æ¥­': 'é›»è…¦åŠé€±é‚Š', 'é£Ÿå“å·¥æ¥­': 'é£Ÿå“'
        };
        const getSimpleIndustry = (ind) => industrySimpleMap[ind] || ind || 'å…¶ä»–';
        
        // è®€å– 01_ALLCBåŸºæœ¬è³‡æ–™ - å…¨éƒ¨CBï¼ˆå«æ­·å²ï¼‰
        const cbBasicInfo = {};
        const activeCodes = new Set(); // è¨˜éŒ„æ›ç‰Œä¸­çš„ä»£è™Ÿ
        
        XLSX.utils.sheet_to_json(wb.Sheets['01_ALLCBåŸºæœ¬è³‡æ–™']||[]).forEach(r => {
            const cbCode = safe(r['CBä»£è™Ÿ']);
            if(cbCode) {
                const hl = cbHighLow[cbCode] || {};
                const fullIndustry = safe(r['ç”¢æ¥­åˆ†é¡']);
                cbBasicInfo[cbCode] = {
                    stockCode: normalizeCode(r['è‚¡ç¥¨ä»£è™Ÿ']),
                    name: safe(r['åç¨±']),
                    method: safe(r['è©¢åœˆç«¶æ‹']),
                    guarantee: safe(r['æ“”ä¿']),
                    rating: r['ä¿¡è©•'],
                    issuer: safe(r['ç™¼è¡Œåˆ¸å•†']),
                    scale: r['ç™¼è¡Œè¦æ¨¡'],
                    convPrice: r['è½‰æ›åƒ¹æ ¼'],
                    years: r['ç™¼è¡Œå¹´æœŸ'],
                    issuePrice: r['ç™¼è¡Œåƒ¹æ ¼'],
                    expPrice: r['åˆ°æœŸé‚„æœ¬åƒ¹æ ¼'],
                    premium: r['è¨‚åƒ¹æº¢åƒ¹ç‡'],
                    position: safe(r['ç”¢æ¥­åœ°ä½']),
                    capital: r['è‚¡æœ¬å¤§å°'],
                    industry: getSimpleIndustry(fullIndustry),
                    listDate: r['æ›ç‰Œæ—¥æœŸ'],
                    expDate: r['åˆ°æœŸæ—¥æœŸ'],
                    high: hl.high || parseFloat(r['æ›ç‰Œæœ€é«˜']) || 0,
                    low: hl.low || parseFloat(r['æ›ç‰Œæœ€ä½']) || 0
                };
            }
        });
        
        // è®€å– 02_ALLCBç™¼è¡Œæ™‚ç¨‹
        const cbTimeline = {};
        XLSX.utils.sheet_to_json(wb.Sheets['02_ALLCBç™¼è¡Œæ™‚ç¨‹']||[]).forEach(r => {
            const cbCode = safe(r['CBä»£è™Ÿ']);
            if(cbCode) {
                cbTimeline[cbCode] = {
                    boardDate: r['è‘£äº‹æœƒå…¬å‘Š'],
                    sendDate: r['é€ä»¶æ—¥æœŸ'],
                    effectDate: r['ç”Ÿæ•ˆæ—¥æœŸ'],
                    bidDate: safe(r['è©¢åœˆç«¶æ‹æ—¥æœŸ']),
                    payDate: r['ä»£æ”¶åƒ¹æ¬¾å…¬å‘Š'],
                    listDate: r['æ›ç‰Œæ—¥æœŸ'],
                    cbasDate: r['CBASæ‹†è§£æ—¥']
                };
            }
        });
        
        // è®€å– 03_ALLCBè³£å›æ¢ä»¶
        const cbPutback = {};
        XLSX.utils.sheet_to_json(wb.Sheets['03_ALLCBè³£å›æ¢ä»¶']||[]).forEach(r => {
            const cbCode = safe(r['CBä»£è™Ÿ']);
            if(cbCode) {
                cbPutback[cbCode] = {
                    putDate1: r['è³£å›æ—¥æœŸ1'],
                    putDate2: r['è³£å›æ—¥æœŸ2'],
                    putTiming: safe(r['æŠ•è³‡äººæå‰è³£å›']),
                    putCondition: safe(r['è³£å›æ¢ä»¶'])
                };
            }
        });
        
        // æ•´åˆåˆ° DB.cbAll
        Object.entries(cbBasicInfo).forEach(([cbCode, info]) => {
            const timeline = cbTimeline[cbCode] || {};
            const putback = cbPutback[cbCode] || {};
            DB.cbAll.push({
                '_cbCode': cbCode,
                '_stockCode': info.stockCode,
                '_name': info.name,
                '_industry': info.industry,
                '_method': info.method,
                '_guarantee': info.guarantee,
                '_rating': info.rating,
                '_issuer': info.issuer,
                '_scale': info.scale,
                '_convPrice': info.convPrice,
                '_years': info.years,
                '_issuePrice': info.issuePrice,
                '_expPrice': info.expPrice,
                '_premium': info.premium,
                '_position': info.position,
                '_capital': info.capital,
                '_listDate': info.listDate,
                '_expDate': info.expDate,
                '_high': info.high,
                '_low': info.low,
                // æ™‚ç¨‹è³‡è¨Š
                '_boardDate': timeline.boardDate,
                '_sendDate': timeline.sendDate,
                '_effectDate': timeline.effectDate,
                '_bidDate': timeline.bidDate,
                '_payDate': timeline.payDate,
                '_cbasDate': timeline.cbasDate,
                // è³£å›æ¢ä»¶
                '_putDate1': putback.putDate1,
                '_putDate2': putback.putDate2,
                '_putTiming': putback.putTiming,
                '_putCondition': putback.putCondition
            });
        });
        console.log('CBåŸºæœ¬è³‡æ–™è¼‰å…¥:', DB.cbAll.length, 'ç­†');
        
        // å»ºç«‹æå‰è³£å›è³‡æ–™åº«ï¼ˆè¿‘3å€‹æœˆå…§å¯è³£å›çš„CBï¼‰
        const today = new Date();
        const threeMonthsLater = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);
        
        DB.cbAll.forEach(cb => {
            // è§£æè³£å›æ—¥æœŸ1å’Œè³£å›æ—¥æœŸ2
            const checkPutDate = (dateVal) => {
                if(!dateVal) return null;
                let d;
                if(typeof dateVal === 'number') {
                    // Excel æ—¥æœŸæ•¸å­—
                    d = new Date((dateVal - 25569) * 86400 * 1000);
                } else if(typeof dateVal === 'string') {
                    d = new Date(dateVal.replace(/\//g, '-'));
                } else if(dateVal instanceof Date) {
                    d = dateVal;
                }
                if(d && !isNaN(d.getTime())) {
                    // æª¢æŸ¥æ˜¯å¦åœ¨ä»Šå¤©åˆ°3å€‹æœˆå¾Œä¹‹é–“
                    if(d >= today && d <= threeMonthsLater) {
                        return d;
                    }
                }
                return null;
            };
            
            const putDate1 = checkPutDate(cb._putDate1);
            const putDate2 = checkPutDate(cb._putDate2);
            const nearestPutDate = putDate1 || putDate2;
            
            if(nearestPutDate) {
                DB.cbPutback.push({
                    ...cb,
                    '_nearestPutDate': nearestPutDate,
                    '_daysToput': Math.ceil((nearestPutDate - today) / (24 * 60 * 60 * 1000))
                });
            }
        });
        // æŒ‰è³£å›æ—¥æœŸæ’åº
        DB.cbPutback.sort((a, b) => a._nearestPutDate - b._nearestPutDate);
        console.log('æå‰è³£å›CBè¼‰å…¥:', DB.cbPutback.length, 'ç­†');
        
        // å»ºç«‹æ­·å²CBè³‡æ–™åº«ï¼ˆå…ˆæ”¾å…¨éƒ¨ï¼Œå¾Œé¢æœƒæ’é™¤æ›ç‰Œä¸­çš„ï¼‰
        // éæ¿¾æ‰æ›ç‰Œæœ€é«˜æˆ–æœ€ä½ç‚º 0 çš„è³‡æ–™
        Object.entries(cbBasicInfo).forEach(([cbCode, info]) => {
            const high = info.high;
            const low = info.low;
            // åªåŠ å…¥æœ‰æ•ˆè³‡æ–™ï¼ˆhigh å’Œ low éƒ½ä¸ç‚º 0ï¼‰
            if(high > 0 && low > 0) {
                DB.cbHistory.push({
                    '_cbCode': cbCode,
                    '_stockCode': info.stockCode,
                    '_name': info.name,
                    '_industry': info.industry,
                    '_method': info.method,
                    '_guarantee': info.guarantee,
                    '_high': high,
                    '_low': low,
                    '_range': (high - low) / low * 100,
                    'è½‰æ›åƒ¹æ ¼(å…ƒ)': info.convPrice,
                    'åˆ°æœŸæ—¥': info.expDate,
                    'æ›ç‰Œæ—¥æœŸ': info.listDate,
                    'ç™¼è¡Œè¦æ¨¡': info.scale,
                    'ç™¼è¡Œåˆ¸å•†': info.issuer
                });
            }
        });
        
        // æ—¥è¡Œæƒ… (æœ‰ç”¢æ¥­è³‡è¨Š) - å…ˆè®€å–å»ºç«‹ç”¢æ¥­å°ç…§
        const dailyMap = {};
        XLSX.utils.sheet_to_json(wb.Sheets['09_æœ€æ–°å‹•æ…‹æ¯é€±æ—¥è¡Œæƒ…']||[]).forEach(r => {
            const code = safe(r['ä»£ç¢¼']);
            const name = safe(Object.values(r)[1]);
            const ind = getSimpleIndustry(safe(r['ç”¢æ¥­']));
            
            if(code) {
                dailyMap[code] = {
                    name: name,
                    industry: ind,
                    cbPrice: r['CBæ”¶ç›¤åƒ¹'],
                    stockPrice: r['è‚¡åƒ¹'],
                    convPrice: r['è½‰æ›åƒ¹æ ¼'],
                    convValue: r['è½‰æ›åƒ¹å€¼'],
                    premium: r['æº¢(æŠ˜)åƒ¹%'],
                    expDate: r['åˆ°æœŸæ—¥']
                };
            }
        });
        
        // æ›ç‰Œä¸­ CB - åˆä½µæ—¥è¡Œæƒ…è³‡æ–™å’Œæ›ç‰Œé«˜ä½
        const activeCbCodes = new Set();
        META.cbStats.industries = {}; // é‡ç½®ç”¢æ¥­çµ±è¨ˆ
        
        XLSX.utils.sheet_to_json(wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™']||[]).forEach(r => {
            const cbCode = safe(r['ä»£è™Ÿ']);
            const stockCode = normalizeCode(r['è½‰æ›æ¨™çš„ä»£ç¢¼']);
            const daily = dailyMap[cbCode] || {};
            const hl = cbHighLow[cbCode] || {};
            const basic = cbBasicInfo[cbCode] || {};
            
            activeCbCodes.add(cbCode); // è¨˜éŒ„æ›ç‰Œä¸­çš„ä»£è™Ÿ
            
            // ç”¢æ¥­å„ªå…ˆä½¿ç”¨ 01 å·¥ä½œè¡¨çš„è³‡æ–™ï¼ˆå·²è½‰æ›ç‚ºç°¡æ½”åç¨±ï¼‰
            const industry = basic.industry || daily.industry || 'å…¶ä»–';
            
            const cbData = {
                ...r,
                '_stockCode': stockCode,
                '_cbCode': cbCode,
                '_name': safe(r['åç¨±']),
                '_stockName': safe(r['è½‰æ›æ¨™çš„åç¨±']),
                '_industry': industry,
                '_cbPrice': daily.cbPrice,
                '_stockPrice': daily.stockPrice,
                '_convValue': daily.convValue,
                '_premium': daily.premium,
                '_high': hl.high || 0,
                '_low': hl.low || 0,
                '_range': hl.range || 0,
                '_method': basic.method || '',      // è©¢åœˆ or ç«¶æ‹
                '_guarantee': basic.guarantee || '' // æœ‰æ“”ä¿ or ç„¡æ“”ä¿
            };
            
            DB.cb.push(cbData);
            if(stockCode) { 
                if(!META.cbMap[stockCode]) META.cbMap[stockCode]=[]; 
                META.cbMap[stockCode].push(cbData); 
            }
            // çµ±è¨ˆç”¢æ¥­
            if(industry) {
                META.cbStats.industries[industry] = (META.cbStats.industries[industry] || 0) + 1;
            }
        });
        
        // å¾æ­·å² CB ä¸­æ’é™¤æ›ç‰Œä¸­çš„
        DB.cbHistory = DB.cbHistory.filter(c => !activeCbCodes.has(c._cbCode));
        
        // è®€å– 04_æ‰€æœ‰CBç«¶æ‹è³‡æ–™åº«
        XLSX.utils.sheet_to_json(wb.Sheets['04_æ‰€æœ‰CBç«¶æ‹è³‡æ–™åº«']||[]).forEach(r => {
            const cbCode = safe(r['CBä»£è™Ÿ']);
            if(!cbCode) return; // è·³éç©ºè³‡æ–™
            
            // å„ªå…ˆä½¿ç”¨ 00 å·¥ä½œè¡¨çš„æ›ç‰Œé«˜ä½ï¼Œè‹¥ç„¡å‰‡ç”¨ 04 å·¥ä½œè¡¨çš„
            const hl = cbHighLow[cbCode] || {};
            const high = hl.high || parseFloat(r['æ›ç‰Œæœ€é«˜']) || 0;
            const low = hl.low || parseFloat(r['æ›ç‰Œæœ€ä½']) || 0;
            // æœ€æ–°æ”¶ç›¤å¾ 09 å·¥ä½œè¡¨å–å¾—
            const latestPrice = cbLatestPrice[cbCode] || 0;
            
            DB.cbAuction.push({
                '_cbCode': cbCode,
                '_stockCode': normalizeCode(r['è‚¡ç¥¨ä»£è™Ÿ']),
                '_name': safe(r['åç¨±']),
                '_industry': getSimpleIndustry(safe(r['ç”¢æ¥­åˆ†é¡'])),
                '_guarantee': safe(r['æ“”ä¿']),
                '_high': high,
                '_low': low,
                '_latestPrice': latestPrice,
                '_range': low > 0 ? (high - low) / low * 100 : 0,
                'é–‹æ¨™æ—¥æœŸ': r['é–‹æ¨™æ—¥æœŸ'],
                'æˆªæ¨™æ—¥': r['æˆªæ¨™æ—¥'],
                'ç™¼è¡Œè¦æ¨¡': r['ç™¼è¡Œè¦æ¨¡'],
                'ç«¶æ‹å¼µæ•¸': r['ç«¶æ‹å¼µæ•¸'],
                'åº•æ¨™åƒ¹': r['åº•æ¨™åƒ¹'],
                'ç†è«–åƒ¹': r['ç†è«–åƒ¹'],
                'æœ€ä½å¾—æ¨™': r['æœ€ä½å¾—æ¨™'],
                'æœ€ä½æº¢åƒ¹': r['æœ€ä½æº¢åƒ¹'],
                'å¹³å‡å¾—æ¨™': r['å¹³å‡å¾—æ¨™'],
                'å¹³å‡æº¢åƒ¹': r['å¹³å‡æº¢åƒ¹'],
                'æŠ•æ¨™å€æ•¸': r['æŠ•æ¨™å€æ•¸'],
                'åˆæ ¼ä»¶æ•¸': r['åˆæ ¼ä»¶æ•¸'],
                'ç™¼è¡Œåˆ¸å•†': safe(r['ç™¼è¡Œåˆ¸å•†']),
                'è½‰æ›åƒ¹': r['è½‰æ›åƒ¹'],
                'è¨‚åƒ¹æº¢åƒ¹ç‡': r['è¨‚åƒ¹æº¢åƒ¹ç‡']
            });
        });
        
        // è®€å– 06_ç™¼è¡Œæ¡ˆä»¶ (æ‰¿éŠ·ä¸­)
        XLSX.utils.sheet_to_json(wb.Sheets['06_ç™¼è¡Œæ¡ˆä»¶']||[]).forEach(r => {
            DB.cbPrimary.push({
                '_stockCode': normalizeCode(r['è‚¡ç¥¨ä»£è™Ÿ']),
                '_cbCode': safe(r['æ¨™çš„ä»£è™Ÿ']),
                '_name': safe(r['ç™¼è¡Œæ¨™çš„']),
                '_method': safe(r['è©¢åœˆ/ç«¶æ‹']),
                '_tcri': safe(r['TCRI/æ“”ä¿']),
                '_amount': r['ç™¼è¡Œé‡'],
                '_broker': safe(r['ç™¼è¡Œåˆ¸å•†']),
                '_sendDate': r['é€ä»¶æ—¥'],
                '_effectDate': r['ç”Ÿæ•ˆæ—¥'],
                '_bidPeriod': safe(r['è©¢åœˆ/æŠ•æ¨™æœŸé–“']),
                '_premium': r['æº¢åƒ¹ç‡'],
                '_convPrice': r['è½‰æ›åƒ¹'],
                '_listDate': r['æ›ç‰Œæ—¥'],
                '_optionDate': r['å¯æ‹†è§£é¸æ“‡æ¬Šæ—¥'],
                '_price': r['æ‰¿éŠ·åƒ¹æ ¼'],
                '_years': r['å¹´æœŸ'],
                '_putback': safe(r['è³£å›æ¢ä»¶']),
                '_capital': r['è‚¡æœ¬'],
                '_stockPrice': r['è‚¡åƒ¹'],
                '_volatility': r['60å¤©æ³¢å‹•ç‡']
            });
        });
        META.cbPrimaryStats.underwriting = DB.cbPrimary.length;
        
        // è®€å– 07_è‘£äº‹æœƒæ±ºè­°
        XLSX.utils.sheet_to_json(wb.Sheets['07_è‘£äº‹æœƒæ±ºè­°']||[]).forEach(r => {
            DB.cbBoard.push({
                '_stockCode': normalizeCode(r['è‚¡é°¾ä»£è™Ÿ'] || r['è‚¡ç¥¨ä»£è™Ÿ']),
                '_cbCode': safe(r['CBä»£ç¢¼']),
                '_name': safe(r['ç™¼è¡Œæ¨™çš„']),
                '_method': safe(r['è©¢åœˆ/ç«¶åƒ¹']),
                '_tcri': safe(r['TCRI/æ“”ä¿']),
                '_amount': r['ç™¼è¡Œé‡'],
                '_broker': safe(r['ä¸»è¾¦åˆ¸å•†']),
                '_maturity': safe(r['åˆ°æœŸæ—¥']),
                '_boardDate': r['è‘£äº‹æœƒé€šé'],
                '_capital': r['è‚¡æœ¬(å„„)'],
                '_note': safe(r['å‚™è¨»'])
            });
        });
        META.cbPrimaryStats.board = DB.cbBoard.length;
        
        // è®€å– 10_æœ€æ–°å‹•æ…‹æ¯é€±é¤˜é¡è¡¨
        XLSX.utils.sheet_to_json(wb.Sheets['10_æœ€æ–°å‹•æ…‹æ¯é€±é¤˜é¡è¡¨']||[]).forEach(r => {
            DB.cbBalance.push({
                '_cbCode': safe(r['è­‰åˆ¸ä»£è™Ÿ']),
                '_name': safe(r['è­‰åˆ¸åç¨±']),
                '_thisWeek': r['æœ¬é€±è‚¡é¡'],
                '_lastWeek': r['ä¸Šé€±è‚¡é¡'],
                '_change': r['å¢æ¸›æ•¸é¡'],
                '_changeRate': r['å¢æ¸›æ¯”ç‡'],
                '_remainRate': r['ç™¼è¡Œæ¯”ç‡(å‰©é¤˜æ¯”ç‡)']
            });
        });
        META.cbBalanceStats.total = DB.cbBalance.length;
        
        // è®€å– 11_æœ€æ–°å‹•æ…‹CBASå ±åƒ¹è¡¨
        XLSX.utils.sheet_to_json(wb.Sheets['11_æœ€æ–°å‹•æ…‹CBASå ±åƒ¹è¡¨']||[]).forEach(r => {
            const tcriVal = safe(r['æ“”ä¿éŠ€è¡Œ/ä¿¡ç”¨è©•ç­‰(TCRI)']);
            // åˆ¤æ–·æ“”ä¿ï¼šå¦‚æœæ˜¯ç´”æ•¸å­—æˆ–å«æ•¸å­—çš„è©•ç­‰(å¦‚ twA+)å‰‡ç„¡æ“”ä¿ï¼Œæœ‰éŠ€è¡Œåç¨±å‰‡æœ‰æ“”ä¿
            const isGuaranteed = tcriVal && !/^\d+$/.test(tcriVal) && /éŠ€|å•†éŠ€|åˆåº«/.test(tcriVal);
            
            DB.cbCBAS.push({
                '_name': safe(r['å¯è½‰å‚µåç¨±']),
                '_cbCode': safe(r['å¯è½‰å‚µä»£ç¢¼']),
                '_tcri': tcriVal,
                '_guarantee': isGuaranteed ? 'æœ‰' : 'ç„¡',
                '_premium': r['æ¬Šåˆ©é‡‘(ä½°å…ƒå ±åƒ¹)'],
                '_optExpiry': r['é¸æ“‡æ¬Šåˆ°æœŸæ—¥'],
                '_putPrice': r['è³£å›åƒ¹æ ¼(A)'],
                '_putDate': r['è³£å›æ—¥æœŸ(B)'],
                '_remainYears': r['å‰©é¤˜å¹´æœŸ'],
                '_discountRate': r['æŠ˜ç¾ç‡(C)'],
                '_premiumRef': r['æ¬Šåˆ©é‡‘åƒè€ƒåƒ¹'],
                '_stockPrice': r['ç¾è‚¡åƒè€ƒåƒ¹'],
                '_convPrice': r['è½‰æ›åƒ¹æ ¼'],
                '_convValue': r['CBè½‰æ›åƒ¹å€¼'],
                '_cbPrice': r['CBåƒè€ƒåƒ¹'],
                '_premiumPct': r['æº¢(æŠ˜)åƒ¹%'],
                '_vol120': r['è‚¡åƒ¹æ³¢å‹•ç‡120å¤©%'],
                '_vol240': r['è‚¡åƒ¹æ³¢å‹•ç‡240å¤©%'],
                '_remainPct': r['æµé€šé¤˜é¡å ç™¼è¡Œç¸½é¡%'],
                '_origAmount': r['åŸå§‹ç™¼è¡Œé‡'],
                '_industry': safe(r['ç”¢æ¥­'])
            });
        });
        META.cbCBASStats.total = DB.cbCBAS.length;
        
        // è®€å– 12_å…¬å¸åŸ·è¡Œè´–å›æ¬Š
        XLSX.utils.sheet_to_json(wb.Sheets['12_å…¬å¸åŸ·è¡Œè´–å›æ¬Š']||[]).forEach(r => {
            const subject = safe(r['ä¸»æ—¨']);
            // å¾ä¸»æ—¨è§£æçµ‚æ­¢æ«ƒæª¯è²·è³£æ—¥æœŸ
            const endMatch = subject.match(/(\d{3})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥çµ‚æ­¢æ«ƒæª¯è²·è³£/);
            let endDate = '';
            if(endMatch) {
                const year = parseInt(endMatch[1]) + 1911;
                endDate = `${year}/${endMatch[2].padStart(2,'0')}/${endMatch[3].padStart(2,'0')}`;
            }
            // å¾ä¸»æ—¨è§£æCBä»£è™Ÿ
            const cbMatch = subject.match(/ä»£ç¢¼[ï¼š:](\d+)/);
            const cbCode = cbMatch ? cbMatch[1] : '';
            // å¾ä¸»æ—¨è§£æCBç°¡ç¨±
            const cbNameMatch = subject.match(/ç°¡ç¨±[ï¼š:]([^ï¼Œ,]+)[ï¼Œ,]/);
            const cbName = cbNameMatch ? cbNameMatch[1] : '';
            
            // å–å¾— CB æ”¶ç›¤åƒ¹å’Œæ›ç‰Œé«˜ä½
            const daily = dailyMap[cbCode] || {};
            const hl = cbHighLow[cbCode] || {};
            
            DB.cbRedeem.push({
                '_stockCode': normalizeCode(r['å…¬å¸ä»£è™Ÿ']),
                '_name': safe(r['å…¬å¸åç¨±']),
                '_cbCode': cbCode,
                '_cbName': cbName,
                '_reportDate': safe(r['ç”³å ±æ—¥æœŸ']),
                '_endDate': endDate,
                '_cbPrice': daily.cbPrice || 0,
                '_high': hl.high || 0,
                '_low': hl.low || 0,
                '_subject': subject,
                '_asoExpiry': r['ASOåˆ°æœŸæ—¥']
            });
        });
        
        // è®€å– 13_åœæ­¢è½‰æ›è³‡è¨Š
        XLSX.utils.sheet_to_json(wb.Sheets['13_åœæ­¢è½‰æ›è³‡è¨Š']||[]).forEach(r => {
            DB.cbStopConv.push({
                '_cbCode': safe(r['å‚µåˆ¸ä»£ç¢¼']),
                '_name': safe(r['å‚µåˆ¸ç°¡ç¨±']),
                '_startDate': safe(r['åœæ­¢è½‰(äº¤)æ›èµ·æ—¥']),
                '_endDate': safe(r['åœæ­¢è½‰(äº¤)æ›è¿„æ—¥']),
                '_reason': safe(r['åœæ­¢è½‰(äº¤)æ›äº‹ç”±'])
            });
        });
        
        // è®€å– 14_è½‰æ›åƒ¹æ ¼èª¿æ•´
        XLSX.utils.sheet_to_json(wb.Sheets['14_è½‰æ›åƒ¹æ ¼èª¿æ•´']||[]).forEach(r => {
            const subject = safe(r['ä¸»æ—¨']);
            
            // è§£æèª¿æ•´æ—¥æœŸ
            const dateMatch = subject.match(/è‡ª(\d{3})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥èµ·/);
            let adjDate = '';
            if(dateMatch) {
                const year = parseInt(dateMatch[1]) + 1911;
                adjDate = `${year}/${dateMatch[2].padStart(2,'0')}/${dateMatch[3].padStart(2,'0')}`;
            }
            
            // è§£æåŸå§‹åƒ¹æ ¼å’Œèª¿æ•´å¾Œåƒ¹æ ¼
            const priceMatch = subject.match(/è½‰æ›åƒ¹æ ¼è‡ª([\d.]+)å…ƒèª¿æ•´ç‚º([\d.]+)å…ƒ/);
            const origPrice = priceMatch ? priceMatch[1] : '';
            const newPrice = priceMatch ? priceMatch[2] : '';
            
            // è§£æ CB ä»£è™Ÿå’Œç°¡ç¨±
            const cbMatch = subject.match(/ä»£ç¢¼[ï¼š:](\d+)/);
            const cbCode = cbMatch ? cbMatch[1] : '';
            const nameMatch = subject.match(/ç°¡ç¨±[ï¼š:]([^ï¼Œ,]+)[ï¼Œ,]/);
            const cbName = nameMatch ? nameMatch[1] : '';
            
            DB.cbPriceAdj.push({
                '_stockCode': normalizeCode(r['å…¬å¸ä»£è™Ÿ']),
                '_name': safe(r['å…¬å¸åç¨±']),
                '_cbCode': cbCode,
                '_cbName': cbName,
                '_adjDate': adjDate,
                '_origPrice': origPrice,
                '_newPrice': newPrice,
                '_subject': subject
            });
        });
        
        // è¨ˆç®—çµ±è¨ˆ
        META.cbStats.total = DB.cb.length;
        META.cbStats.historyTotal = DB.cbHistory.length;
        META.cbStats.auctionTotal = DB.cbAuction.length;
        const companies = new Set();
        let totalBal = 0;
        DB.cb.forEach(c => {
            if(c['_stockCode']) companies.add(c['_stockCode']);
            const bal = parseFloat(c['æœ€æ–°é¤˜é¡(ç™¾è¬)']) || 0;
            totalBal += bal;
        });
        META.cbStats.companies = companies.size;
        META.cbStats.totalBalance = totalBal;
        
        console.log('CBè¼‰å…¥:', DB.cb.length, 'æ­·å²CB:', DB.cbHistory.length, 'ç«¶æ‹:', DB.cbAuction.length, 
                    'æ‰¿éŠ·ä¸­:', DB.cbPrimary.length, 'è‘£äº‹æœƒ:', DB.cbBoard.length, 
                    'é¤˜é¡:', DB.cbBalance.length, 'CBAS:', DB.cbCBAS.length,
                    'å¼·åˆ¶è´–å›:', DB.cbRedeem.length, 'åœæ­¢è½‰æ›:', DB.cbStopConv.length, 'åƒ¹æ ¼èª¿æ•´:', DB.cbPriceAdj.length);
    }

    // è¼‰å…¥æ–‡ç« è³‡æ–™åº«
    wb = await fetchXlsx(FILES.ARTICLE);
    if(wb) {
        const sheet = wb.Sheets['ã€æ–‡ç« æ¸…å–®ã€‘'] || wb.Sheets[wb.SheetNames[0]];
        if(sheet) {
            // è·³éå‰ 3 åˆ—æ¨™é¡Œ
            const rows = XLSX.utils.sheet_to_json(sheet, {range: 2});
            rows.forEach(r => {
                const articleId = safe(r['ã€æ–‡ç« æ¸…å–®ã€‘'] || r['æ–‡ç« ç·¨è™Ÿ']);
                if(articleId && articleId.startsWith('CB-')) {
                    DB.article.push({
                        '_id': articleId,
                        '_title': safe(r['Unnamed: 1'] || r['æ–‡ç« ä¸»é¡Œ'] || ''),
                        '_date': safe(r['Unnamed: 2'] || r['ç™¼å¸ƒæ—¥æœŸ'] || ''),
                        '_difficulty': safe(r['Unnamed: 3'] || r['é›£åº¦'] || ''),
                        '_tags': safe(r['Unnamed: 4'] || r['ä¸»é¡Œæ¨™ç±¤'] || ''),
                        '_pages': safe(r['Unnamed: 5'] || r['é æ•¸'] || ''),
                        '_prereq': safe(r['Unnamed: 6'] || r['å…ˆå‚™çŸ¥è­˜'] || ''),
                        '_related': safe(r['Unnamed: 7'] || r['é—œè¯æ–‡ç« '] || '')
                    });
                }
            });
            console.log('æ–‡ç« è¼‰å…¥:', DB.article.length, 'ç¯‡');
        }
    }

    // æ›´æ–°è¨ˆæ•¸
    $('c-news').innerText = DB.news.length;
    $('c-memo').innerText = DB.memo.length;
    $('c-reports').innerText = DB.reports.length;
    $('c-strategy').innerText = DB.strategy.length;
    $('c-stocks').innerText = Object.keys(DB.stocks).length;
    $('c-trends').innerText = DB.trends.length;
    $('c-cb').innerText = DB.cb.length;
    $('c-article').innerText = DB.article.length;

    // ç¢ºä¿éš±è— loader
    setTimeout(() => { $('loader').classList.add('hidden'); }, 100);
    
    document.querySelectorAll('.db-tab').forEach(tab => {
        tab.onclick = () => {
            CURR_DB = tab.dataset.db;
            document.querySelectorAll('.db-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            renderList();
        };
    });
    
    renderList();
  } catch(e) {
    console.error('Init Error:', e);
    $('loader').classList.add('hidden');
    $('loadStatus').innerText = 'è¼‰å…¥ç™¼ç”ŸéŒ¯èª¤';
  }
}

// å€‹è‚¡çµ±è¨ˆå€å¡Š
function renderStockStats() {
    const stats = META.stockStats;
    const industries = Object.entries(stats.industries).sort((a,b) => b[1]-a[1]);
    const concepts = Object.entries(stats.conceptCategories).sort((a,b) => b[1]-a[1]);
    const markets = Object.entries(stats.markets).sort((a,b) => b[1]-a[1]);
    
    // é ç±¤ HTML
    const tabsHtml = `
        <div class="cb-mode-switcher">
            <span class="cb-mode-tab ${STOCK_MODE==='all'?'active':''}" onclick="setStockMode('all')">ğŸ¢ å…¨éƒ¨å€‹è‚¡</span>
            <span class="cb-mode-tab ${STOCK_MODE==='concept'?'active':''}" onclick="setStockMode('concept')">ğŸ’¡ æ¦‚å¿µè‚¡</span>
        </div>
    `;
    
    if(STOCK_MODE === 'all') {
        // å…¨éƒ¨å€‹è‚¡çµ±è¨ˆ
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.total}</div>
                        <div class="cb-stat-label">ä¸Šå¸‚æ«ƒå…¬å¸</div>
                    </div>
                    ${markets.slice(0, 4).map(([m, cnt]) => 
                        `<div class="cb-stat-item clickable" onclick="setSearch('${m}')">
                            <div class="cb-stat-num">${cnt}</div>
                            <div class="cb-stat-label">${m}</div>
                        </div>`
                    ).join('')}
                </div>
                <div class="cb-ind-title">ğŸ“Š å„ç”¢æ¥­åˆ†ä½ˆ</div>
                <div class="cb-ind-grid">
                    ${industries.slice(0, 25).map(([ind, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${ind}')">${ind}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    } else if(STOCK_MODE === 'concept') {
        // æ¦‚å¿µè‚¡çµ±è¨ˆ
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.conceptTotal}</div>
                        <div class="cb-stat-label">æ¦‚å¿µè‚¡ç­†æ•¸</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${concepts.length}</div>
                        <div class="cb-stat-label">æ¦‚å¿µåˆ†é¡æ•¸</div>
                    </div>
                </div>
                <div class="cb-ind-title">ğŸ’¡ ç†±é–€æ¦‚å¿µåˆ†é¡</div>
                <div class="cb-ind-grid">
                    ${concepts.slice(0, 30).map(([c, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${c}')">${c}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    return '';
}

// åˆ‡æ›å€‹è‚¡æ¨¡å¼
function setStockMode(mode) {
    STOCK_MODE = mode;
    $('search').value = '';
    renderList();
}

// Memo çµ±è¨ˆå€å¡Š
function renderMemoStats() {
    const stats = META.memoStats;
    const brokers = Object.entries(stats.brokers).sort((a,b) => b[1]-a[1]);
    const types = Object.entries(stats.types).sort((a,b) => b[1]-a[1]);
    
    // é ç±¤ HTML
    const tabsHtml = `
        <div class="cb-mode-switcher">
            <span class="cb-mode-tab ${MEMO_MODE==='all'?'active':''}" onclick="setMemoMode('all')">ğŸ“‹ å…¨éƒ¨</span>
            <span class="cb-mode-tab ${MEMO_MODE==='stock'?'active':''}" onclick="setMemoMode('stock')">ğŸ¢ å€‹è‚¡</span>
            <span class="cb-mode-tab ${MEMO_MODE==='industry'?'active':''}" onclick="setMemoMode('industry')">ğŸ­ ç”¢æ¥­</span>
        </div>
    `;
    
    if(MEMO_MODE === 'all') {
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.total}</div>
                        <div class="cb-stat-label">Memoç¸½æ•¸</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setMemoMode('stock')">
                        <div class="cb-stat-num">${stats.stockTotal}</div>
                        <div class="cb-stat-label">å€‹è‚¡å ±å‘Š</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setMemoMode('industry')">
                        <div class="cb-stat-num">${stats.industryTotal}</div>
                        <div class="cb-stat-label">ç”¢æ¥­å ±å‘Š</div>
                    </div>
                </div>
                <div class="cb-ind-title">ğŸ“Š å ±å‘Šé¡å‹åˆ†ä½ˆ</div>
                <div class="cb-ind-grid">
                    ${types.slice(0, 15).map(([t, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${t}')">${t}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    } else if(MEMO_MODE === 'stock') {
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.stockTotal}</div>
                        <div class="cb-stat-label">å€‹è‚¡å ±å‘Šæ•¸</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${brokers.length}</div>
                        <div class="cb-stat-label">åˆ¸å•†æ•¸</div>
                    </div>
                </div>
                <div class="cb-ind-title">ğŸ¦ å„åˆ¸å•†å ±å‘Šæ•¸</div>
                <div class="cb-ind-grid">
                    ${brokers.slice(0, 15).map(([b, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${b}')">${b}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    } else if(MEMO_MODE === 'industry') {
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.industryTotal}</div>
                        <div class="cb-stat-label">ç”¢æ¥­å ±å‘Šæ•¸</div>
                    </div>
                </div>
                <div class="cb-ind-title">ğŸ“Š ç”¢æ¥­å ±å‘Šé¡å‹</div>
                <div class="cb-ind-grid">
                    ${types.filter(([t]) => t.includes('ç”¢æ¥­') || t.includes('TPCA')).map(([t, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${t}')">${t}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    return '';
}

// åˆ‡æ› Memo æ¨¡å¼
function setMemoMode(mode) {
    MEMO_MODE = mode;
    $('search').value = '';
    renderList();
}

// ç«¶æ‹å‰ååè¡¨æ ¼
function renderAuctionTop10() {
    if(DB.cbAuction.length === 0) return '';
    
    // æœ‰æ“”ä¿ - æœ€ä½å¾—æ¨™ç”±é«˜åˆ°ä½å‰å
    const guarLowest = DB.cbAuction
        .filter(c => c._guarantee === 'æœ‰æ“”ä¿' && parseFloat(c['æœ€ä½å¾—æ¨™']) > 0)
        .sort((a, b) => parseFloat(b['æœ€ä½å¾—æ¨™']) - parseFloat(a['æœ€ä½å¾—æ¨™']))
        .slice(0, 10);
    
    // ç„¡æ“”ä¿ - æœ€ä½å¾—æ¨™ç”±é«˜åˆ°ä½å‰å
    const noGuarLowest = DB.cbAuction
        .filter(c => c._guarantee === 'ç„¡æ“”ä¿' && parseFloat(c['æœ€ä½å¾—æ¨™']) > 0)
        .sort((a, b) => parseFloat(b['æœ€ä½å¾—æ¨™']) - parseFloat(a['æœ€ä½å¾—æ¨™']))
        .slice(0, 10);
    
    // æœ‰æ“”ä¿ - å¹³å‡å¾—æ¨™ç”±é«˜åˆ°ä½å‰å
    const guarAvg = DB.cbAuction
        .filter(c => c._guarantee === 'æœ‰æ“”ä¿' && parseFloat(c['å¹³å‡å¾—æ¨™']) > 0)
        .sort((a, b) => parseFloat(b['å¹³å‡å¾—æ¨™']) - parseFloat(a['å¹³å‡å¾—æ¨™']))
        .slice(0, 10);
    
    // ç„¡æ“”ä¿ - å¹³å‡å¾—æ¨™ç”±é«˜åˆ°ä½å‰å
    const noGuarAvg = DB.cbAuction
        .filter(c => c._guarantee === 'ç„¡æ“”ä¿' && parseFloat(c['å¹³å‡å¾—æ¨™']) > 0)
        .sort((a, b) => parseFloat(b['å¹³å‡å¾—æ¨™']) - parseFloat(a['å¹³å‡å¾—æ¨™']))
        .slice(0, 10);
    
    const renderTable = (list, title, valueField) => {
        if(list.length === 0) return '';
        return `<div class="cb-ind-title" style="margin-top:15px">${title}</div>
        <div class="auction-top10-table">
            <table>
                <thead><tr><th>æ’å</th><th>CBä»£è™Ÿ</th><th>åç¨±</th><th>é–‹æ¨™æ—¥</th><th>æœ€ä½å¾—æ¨™</th><th>å¹³å‡å¾—æ¨™</th><th>æœ€æ–°æ”¶ç›¤</th><th>æ›ç‰Œæœ€é«˜</th><th>æ›ç‰Œæœ€ä½</th><th>æŠ•æ¨™å€æ•¸</th></tr></thead>
                <tbody>
                ${list.map((c, i) => `<tr>
                    <td>${i+1}</td>
                    <td class="code">${c._cbCode}</td>
                    <td>${c._name}</td>
                    <td>${fmtDate(c['é–‹æ¨™æ—¥æœŸ'])}</td>
                    <td class="${valueField === 'æœ€ä½å¾—æ¨™' ? 'highlight' : ''}">${fmtNum(c['æœ€ä½å¾—æ¨™'], 2)}</td>
                    <td class="${valueField === 'å¹³å‡å¾—æ¨™' ? 'highlight' : ''}">${fmtNum(c['å¹³å‡å¾—æ¨™'], 2)}</td>
                    <td>${c._latestPrice > 0 ? fmtNum(c._latestPrice, 2) : '-'}</td>
                    <td>${c._high > 0 ? fmtNum(c._high, 2) : '-'}</td>
                    <td>${c._low > 0 ? fmtNum(c._low, 2) : '-'}</td>
                    <td>${fmtNum(c['æŠ•æ¨™å€æ•¸'], 2)}x</td>
                </tr>`).join('')}
                </tbody>
            </table>
        </div>`;
    };
    
    let html = '';
    html += renderTable(guarLowest, 'ğŸ† æœ‰æ“”ä¿ï½œæœ€ä½å¾—æ¨™ Top 10ï¼ˆç”±é«˜åˆ°ä½ï¼‰', 'æœ€ä½å¾—æ¨™');
    html += renderTable(noGuarLowest, 'ğŸ† ç„¡æ“”ä¿ï½œæœ€ä½å¾—æ¨™ Top 10ï¼ˆç”±é«˜åˆ°ä½ï¼‰', 'æœ€ä½å¾—æ¨™');
    html += renderTable(guarAvg, 'ğŸ† æœ‰æ“”ä¿ï½œå¹³å‡å¾—æ¨™ Top 10ï¼ˆç”±é«˜åˆ°ä½ï¼‰', 'å¹³å‡å¾—æ¨™');
    html += renderTable(noGuarAvg, 'ğŸ† ç„¡æ“”ä¿ï½œå¹³å‡å¾—æ¨™ Top 10ï¼ˆç”±é«˜åˆ°ä½ï¼‰', 'å¹³å‡å¾—æ¨™');
    
    return html;
}

// CB çµ±è¨ˆå€å¡Š
function renderCBStats() {
    const stats = META.cbStats;
    const industries = Object.entries(stats.industries).sort((a,b) => b[1]-a[1]);
    
    // è¨ˆç®—ç¯©é¸æ¨™ç±¤æ•¸é‡ï¼ˆæ ¹æ“šç•¶å‰æ¨¡å¼ï¼‰
    let cbList = [];
    if(CB_MODE === 'active') cbList = DB.cb;
    else if(CB_MODE === 'history') cbList = DB.cbHistory;
    else if(CB_MODE === 'auction') cbList = DB.cbAuction;
    else if(CB_MODE === 'primary') cbList = PRIMARY_MODE === 'underwriting' ? DB.cbPrimary : DB.cbBoard;
    else if(CB_MODE === 'balance') cbList = DB.cbBalance;
    else if(CB_MODE === 'cbas') cbList = DB.cbCBAS;
    
    const methodCnt = { 'è©¢åœˆ': 0, 'ç«¶æ‹': 0 };
    const guarCnt = { 'æœ‰æ“”ä¿': 0, 'ç„¡æ“”ä¿': 0 };
    cbList.forEach(c => {
        if(c._method === 'è©¢åœˆ') methodCnt['è©¢åœˆ']++;
        else if(c._method === 'ç«¶æ‹') methodCnt['ç«¶æ‹']++;
        if(c._guarantee === 'æœ‰æ“”ä¿') guarCnt['æœ‰æ“”ä¿']++;
        else if(c._guarantee === 'ç„¡æ“”ä¿' || c._guarantee === '0') guarCnt['ç„¡æ“”ä¿']++;
    });
    
    const q = $('search').value.toLowerCase().trim();
    
    // é ç±¤ HTML - å››åˆ—æ’åˆ— + ä¸»æ¨™é¡Œ
    const tabsHtml = `
        <div class="cb-mode-header">ğŸ“Š å¯è½‰å‚µè³‡æ–™åº«</div>
        <div class="cb-mode-switcher">
            <div class="cb-mode-row">
                <span class="cb-mode-tab ${CB_MODE==='info'?'active':''}" onclick="setCbMode('info')">ğŸ“‹ åŸºæœ¬è³‡æ–™</span>
                <span class="cb-mode-tab ${CB_MODE==='history'?'active':''}" onclick="setCbMode('history')">ğŸ“œ æ­·å²é«˜ä½</span>
                <span class="cb-mode-tab ${CB_MODE==='active'?'active':''}" onclick="setCbMode('active')">ğŸ« ç›®å‰æ›ç‰Œ</span>
            </div>
            <div class="cb-mode-row">
                <span class="cb-mode-tab ${CB_MODE==='primary'?'active':''}" onclick="setCbMode('primary')">ğŸ“ åˆç´šå¸‚å ´</span>
                <span class="cb-mode-tab ${CB_MODE==='auction'?'active':''}" onclick="setCbMode('auction')">ğŸ”¨ ç«¶æ‹è³‡è¨Š</span>
                <span class="cb-mode-tab ${CB_MODE==='cbas'?'active':''}" onclick="setCbMode('cbas')">ğŸ’¹ CBASå ±åƒ¹</span>
            </div>
            <div class="cb-mode-row">
                <span class="cb-mode-tab ${CB_MODE==='putback'?'active':''}" onclick="setCbMode('putback')">ğŸ“… æå‰è³£å›</span>
                <span class="cb-mode-tab ${CB_MODE==='redeem'?'active':''}" onclick="setCbMode('redeem')">ğŸ”” å¼·åˆ¶è´–å›</span>
                <span class="cb-mode-tab ${CB_MODE==='stopconv'?'active':''}" onclick="setCbMode('stopconv')">â¸ï¸ æš«åœè½‰æ›</span>
            </div>
            <div class="cb-mode-row">
                <span class="cb-mode-tab ${CB_MODE==='balance'?'active':''}" onclick="setCbMode('balance')">ğŸ“Š æµé€šé¤˜é¡</span>
                <span class="cb-mode-tab ${CB_MODE==='priceadj'?'active':''}" onclick="setCbMode('priceadj')">ğŸ“ˆ åƒ¹æ ¼èµ°å‹¢</span>
                <span class="cb-mode-tab ${CB_MODE==='concept'?'active':''}" onclick="setCbMode('concept')">ğŸ’¡ æ¦‚å¿µè‚¡ç¥¨</span>
            </div>
        </div>
    `;
    
    if(CB_MODE === 'info') {
        // åŸºæœ¬è³‡æ–™æ¨¡å¼ - çµ±è¨ˆæ‰€æœ‰CB
        const allInd = {};
        const allMethod = { 'è©¢åœˆ': 0, 'ç«¶æ‹': 0 };
        const allGuar = { 'æœ‰æ“”ä¿': 0, 'ç„¡æ“”ä¿': 0 };
        DB.cbAll.forEach(c => {
            const ind = c._industry || 'å…¶ä»–';
            allInd[ind] = (allInd[ind] || 0) + 1;
            if(c._method === 'è©¢åœˆ') allMethod['è©¢åœˆ']++;
            else if(c._method === 'ç«¶æ‹') allMethod['ç«¶æ‹']++;
            if(c._guarantee === 'æœ‰æ“”ä¿') allGuar['æœ‰æ“”ä¿']++;
            else if(c._guarantee === 'ç„¡æ“”ä¿' || c._guarantee === '0') allGuar['ç„¡æ“”ä¿']++;
        });
        const sortedAllInd = Object.entries(allInd).sort((a,b) => b[1]-a[1]);
        
        // è¨ˆç®—æ›ç‰Œä¸­æ•¸é‡
        const activeCnt = DB.cb.length;
        const historyCnt = DB.cbAll.length - activeCnt;
        
        // æ¬¡æ¨™ç±¤å…§å®¹ï¼ˆè—è‰²å€å¡Šï¼‰
        let subContent = '';
        if(CB_INFO_SUB === 'stats') {
            subContent = `
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${DB.cbAll.length}</div>
                        <div class="cb-stat-label">å…¨éƒ¨CB</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${activeCnt}</div>
                        <div class="cb-stat-label">æ›ç‰Œä¸­</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num trend-down">${historyCnt}</div>
                        <div class="cb-stat-label">å·²ä¸‹å¸‚</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('è©¢åœˆ')">
                        <div class="cb-stat-num">${allMethod['è©¢åœˆ']}</div>
                        <div class="cb-stat-label">è©¢åœˆ</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('ç«¶æ‹')">
                        <div class="cb-stat-num">${allMethod['ç«¶æ‹']}</div>
                        <div class="cb-stat-label">ç«¶æ‹</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('æœ‰æ“”ä¿')">
                        <div class="cb-stat-num trend-up">${allGuar['æœ‰æ“”ä¿']}</div>
                        <div class="cb-stat-label">æœ‰æ“”ä¿</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('ç„¡æ“”ä¿')">
                        <div class="cb-stat-num">${allGuar['ç„¡æ“”ä¿']}</div>
                        <div class="cb-stat-label">ç„¡æ“”ä¿</div>
                    </div>
                </div>
            `;
        } else if(CB_INFO_SUB === 'industry') {
            subContent = `
                <div class="cb-ind-grid">
                    ${sortedAllInd.slice(0, 24).map(([ind, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${ind}')">${ind}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            `;
        }
        
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-sub-tabs">
                    <span class="cb-sub-tab blue ${CB_INFO_SUB==='stats'?'active':''}" onclick="setCbInfoSub('stats')">ğŸ“Š çµ±è¨ˆ</span>
                    <span class="cb-sub-tab blue ${CB_INFO_SUB==='industry'?'active':''}" onclick="setCbInfoSub('industry')">ğŸ­ ç”¢æ¥­åˆ†ä½ˆ</span>
                </div>
                ${subContent}
                <div class="cb-info-tabs">
                    <span class="cb-info-tab ${CB_INFO_TAB==='issue'?'active':''}" onclick="setCbInfoTab('issue')">ğŸ“‹ ç™¼è¡Œæ¢ä»¶</span>
                    <span class="cb-info-tab ${CB_INFO_TAB==='timeline'?'active':''}" onclick="setCbInfoTab('timeline')">ğŸ—“ æ™‚ç¨‹è³‡è¨Š</span>
                    <span class="cb-info-tab ${CB_INFO_TAB==='putback'?'active':''}" onclick="setCbInfoTab('putback')">ğŸ’° è³£å›æ¢ä»¶</span>
                </div>
            </div>
        `;
    } else if(CB_MODE === 'active') {
        // æ›ç‰Œä¸­ CB çµ±è¨ˆ
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.total}</div>
                        <div class="cb-stat-label">æ›ç‰Œä¸­CB</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${stats.companies}</div>
                        <div class="cb-stat-label">ç™¼è¡Œå…¬å¸æ•¸</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${fmtNum(stats.totalBalance/100, 0)}</div>
                        <div class="cb-stat-label">ç¸½é¤˜é¡(å„„)</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('è©¢åœˆ')">
                        <div class="cb-stat-num">${methodCnt['è©¢åœˆ']}</div>
                        <div class="cb-stat-label">è©¢åœˆ</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('ç«¶æ‹')">
                        <div class="cb-stat-num">${methodCnt['ç«¶æ‹']}</div>
                        <div class="cb-stat-label">ç«¶æ‹</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('æœ‰æ“”ä¿')">
                        <div class="cb-stat-num">${guarCnt['æœ‰æ“”ä¿']}</div>
                        <div class="cb-stat-label">æœ‰æ“”ä¿</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('ç„¡æ“”ä¿')">
                        <div class="cb-stat-num">${guarCnt['ç„¡æ“”ä¿']}</div>
                        <div class="cb-stat-label">ç„¡æ“”ä¿</div>
                    </div>
                </div>
                <div class="cb-ind-title">ğŸ“Š å„ç”¢æ¥­CBåˆ†ä½ˆ</div>
                <div class="cb-ind-grid">
                    ${industries.slice(0, 20).map(([ind, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${ind}')">${ind}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    } else if(CB_MODE === 'history') {
        // æ­·å² CB
        const historyInd = {};
        DB.cbHistory.forEach(c => {
            const ind = c._industry || 'å…¶ä»–';
            historyInd[ind] = (historyInd[ind] || 0) + 1;
        });
        const sortedHistInd = Object.entries(historyInd).sort((a,b) => b[1]-a[1]);
        
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${DB.cbHistory.length}</div>
                        <div class="cb-stat-label">æ­·å²CBç¸½æ•¸</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('è©¢åœˆ')">
                        <div class="cb-stat-num">${methodCnt['è©¢åœˆ']}</div>
                        <div class="cb-stat-label">è©¢åœˆ</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('ç«¶æ‹')">
                        <div class="cb-stat-num">${methodCnt['ç«¶æ‹']}</div>
                        <div class="cb-stat-label">ç«¶æ‹</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('æœ‰æ“”ä¿')">
                        <div class="cb-stat-num">${guarCnt['æœ‰æ“”ä¿']}</div>
                        <div class="cb-stat-label">æœ‰æ“”ä¿</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('ç„¡æ“”ä¿')">
                        <div class="cb-stat-num">${guarCnt['ç„¡æ“”ä¿']}</div>
                        <div class="cb-stat-label">ç„¡æ“”ä¿</div>
                    </div>
                </div>
                <div class="cb-ind-title">ğŸ“Š å„ç”¢æ¥­æ­·å²CBåˆ†ä½ˆ</div>
                <div class="cb-ind-grid">
                    ${sortedHistInd.slice(0, 20).map(([ind, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${ind}')">${ind}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    } else if(CB_MODE === 'auction') {
        // ç«¶æ‹çµ±è¨ˆ - ä½¿ç”¨ç¨ç«‹è¨ˆæ•¸å™¨
        const auctionInd = {};
        const auctionGuar = { 'æœ‰æ“”ä¿': 0, 'ç„¡æ“”ä¿': 0 };
        let totalHigh = 0, totalLow = 0, totalRange = 0, validHighLowCnt = 0;
        let totalLowestBid = 0, totalMultiple = 0, bidCnt = 0, multipleCnt = 0;
        
        DB.cbAuction.forEach(c => {
            const ind = c._industry || 'å…¶ä»–';
            auctionInd[ind] = (auctionInd[ind] || 0) + 1;
            
            // æ›ç‰Œé«˜ä½çµ±è¨ˆ (å¾ _high, _low æ¬„ä½)
            if(c._high > 0 && c._low > 0) {
                totalHigh += c._high;
                totalLow += c._low;
                totalRange += c._range;
                validHighLowCnt++;
            }
            
            // æœ€ä½å¾—æ¨™çµ±è¨ˆ
            const lowestBid = parseFloat(c['æœ€ä½å¾—æ¨™']) || 0;
            if(lowestBid > 0) { totalLowestBid += lowestBid; bidCnt++; }
            
            // æŠ•æ¨™å€æ•¸çµ±è¨ˆ
            const multiple = parseFloat(c['æŠ•æ¨™å€æ•¸']) || 0;
            if(multiple > 0) { totalMultiple += multiple; multipleCnt++; }
            
            // æ“”ä¿çµ±è¨ˆ
            if(c._guarantee === 'æœ‰æ“”ä¿') auctionGuar['æœ‰æ“”ä¿']++;
            else if(c._guarantee === 'ç„¡æ“”ä¿') auctionGuar['ç„¡æ“”ä¿']++;
        });
        
        const avgHigh = validHighLowCnt > 0 ? totalHigh / validHighLowCnt : 0;
        const avgLow = validHighLowCnt > 0 ? totalLow / validHighLowCnt : 0;
        const avgRange = validHighLowCnt > 0 ? totalRange / validHighLowCnt : 0;
        const avgLowestBid = bidCnt > 0 ? totalLowestBid / bidCnt : 0;
        const avgMultiple = multipleCnt > 0 ? totalMultiple / multipleCnt : 0;
        const sortedAuctionInd = Object.entries(auctionInd).sort((a,b) => b[1]-a[1]);
        
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${DB.cbAuction.length}</div>
                        <div class="cb-stat-label">ç«¶æ‹CBç¸½æ•¸</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${fmtNum(avgHigh, 1)}</div>
                        <div class="cb-stat-label">å¹³å‡æ›ç‰Œé«˜é»</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${fmtNum(avgLow, 1)}</div>
                        <div class="cb-stat-label">å¹³å‡æ›ç‰Œä½é»</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${fmtNum(avgLowestBid, 1)}</div>
                        <div class="cb-stat-label">å¹³å‡æœ€ä½å¾—æ¨™</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${fmtNum(avgMultiple, 1)}x</div>
                        <div class="cb-stat-label">å¹³å‡æŠ•æ¨™å€æ•¸</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('æœ‰æ“”ä¿')">
                        <div class="cb-stat-num">${auctionGuar['æœ‰æ“”ä¿']}</div>
                        <div class="cb-stat-label">æœ‰æ“”ä¿</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('ç„¡æ“”ä¿')">
                        <div class="cb-stat-num">${auctionGuar['ç„¡æ“”ä¿']}</div>
                        <div class="cb-stat-label">ç„¡æ“”ä¿</div>
                    </div>
                </div>
                <div class="cb-ind-title">ğŸ“Š å„ç”¢æ¥­ç«¶æ‹CBåˆ†ä½ˆ</div>
                <div class="cb-ind-grid">
                    ${sortedAuctionInd.slice(0, 20).map(([ind, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${ind}')">${ind}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
                <div class="cb-ind-title" style="margin-top:15px">ğŸ” æ“”ä¿ç¯©é¸</div>
                <div class="cb-ind-grid">
                    <div class="cb-ind-tag" onclick="setSearch('æœ‰æ“”ä¿')">æœ‰æ“”ä¿<span class="num">${auctionGuar['æœ‰æ“”ä¿']}</span></div>
                    <div class="cb-ind-tag" onclick="setSearch('ç„¡æ“”ä¿')">ç„¡æ“”ä¿<span class="num">${auctionGuar['ç„¡æ“”ä¿']}</span></div>
                </div>
                ${renderAuctionTop10()}
            </div>
        `;
    } else if(CB_MODE === 'primary') {
        // åˆç´šå¸‚å ´ - æ‰¿éŠ·ä¸­/è‘£äº‹æœƒ
        const primaryTabsHtml = `
            <div class="cb-sub-switcher">
                <span class="cb-sub-tab ${PRIMARY_MODE==='underwriting'?'active':''}" onclick="setPrimaryMode('underwriting')">ğŸ“‹ æ‰¿éŠ·ä¸­æ¡ˆä»¶</span>
                <span class="cb-sub-tab ${PRIMARY_MODE==='board'?'active':''}" onclick="setPrimaryMode('board')">ğŸ“ è‘£äº‹æœƒå…¬å‘Š</span>
            </div>
        `;
        
        if(PRIMARY_MODE === 'underwriting') {
            const brokerCnt = {};
            DB.cbPrimary.forEach(c => {
                const broker = c._broker || 'å…¶ä»–';
                brokerCnt[broker] = (brokerCnt[broker] || 0) + 1;
            });
            const sortedBrokers = Object.entries(brokerCnt).sort((a,b) => b[1]-a[1]);
            
            return `
                <div class="cb-stats">
                    ${tabsHtml}
                    ${primaryTabsHtml}
                    <div class="cb-stats-grid">
                        <div class="cb-stat-item">
                            <div class="cb-stat-num">${META.cbPrimaryStats.underwriting}</div>
                            <div class="cb-stat-label">æ‰¿éŠ·ä¸­æ¡ˆä»¶</div>
                        </div>
                        <div class="cb-stat-item clickable" onclick="setSearch('ç«¶æ‹')">
                            <div class="cb-stat-num">${DB.cbPrimary.filter(c => c._method === 'ç«¶æ‹').length}</div>
                            <div class="cb-stat-label">ç«¶æ‹</div>
                        </div>
                        <div class="cb-stat-item clickable" onclick="setSearch('è©¢åœˆ')">
                            <div class="cb-stat-num">${DB.cbPrimary.filter(c => c._method === 'è©¢åœˆ').length}</div>
                            <div class="cb-stat-label">è©¢åœˆ</div>
                        </div>
                    </div>
                    <div class="cb-ind-title">ğŸ¦ ç™¼è¡Œåˆ¸å•†åˆ†ä½ˆ</div>
                    <div class="cb-ind-grid">
                        ${sortedBrokers.slice(0, 15).map(([b, cnt]) => 
                            `<div class="cb-ind-tag" onclick="setSearch('${b}')">${b}<span class="num">${cnt}</span></div>`
                        ).join('')}
                    </div>
                </div>
            `;
        } else {
            const brokerCnt = {};
            DB.cbBoard.forEach(c => {
                const broker = c._broker || 'å…¶ä»–';
                brokerCnt[broker] = (brokerCnt[broker] || 0) + 1;
            });
            const sortedBrokers = Object.entries(brokerCnt).sort((a,b) => b[1]-a[1]);
            
            return `
                <div class="cb-stats">
                    ${tabsHtml}
                    ${primaryTabsHtml}
                    <div class="cb-stats-grid">
                        <div class="cb-stat-item">
                            <div class="cb-stat-num">${META.cbPrimaryStats.board}</div>
                            <div class="cb-stat-label">è‘£äº‹æœƒå…¬å‘Š</div>
                        </div>
                        <div class="cb-stat-item clickable" onclick="setSearch('ç«¶æ‹')">
                            <div class="cb-stat-num">${DB.cbBoard.filter(c => c._method === 'ç«¶æ‹' || c._method === 'ç«¶åƒ¹').length}</div>
                            <div class="cb-stat-label">ç«¶æ‹</div>
                        </div>
                        <div class="cb-stat-item clickable" onclick="setSearch('è©¢åœˆ')">
                            <div class="cb-stat-num">${DB.cbBoard.filter(c => c._method === 'è©¢åœˆ').length}</div>
                            <div class="cb-stat-label">è©¢åœˆ</div>
                        </div>
                    </div>
                    <div class="cb-ind-title">ğŸ¦ ä¸»è¾¦åˆ¸å•†åˆ†ä½ˆ</div>
                    <div class="cb-ind-grid">
                        ${sortedBrokers.slice(0, 15).map(([b, cnt]) => 
                            `<div class="cb-ind-tag" onclick="setSearch('${b}')">${b}<span class="num">${cnt}</span></div>`
                        ).join('')}
                    </div>
                </div>
            `;
        }
    } else if(CB_MODE === 'balance') {
        // æµé€šé¤˜é¡
        // è¨ˆç®—æ¸›å¹…å‰ååï¼ˆå¢æ¸›æ¯”ç‡ç”±å°åˆ°å¤§ï¼Œè² æ•¸è¶Šå¤§æ¸›è¶Šå¤šï¼‰
        const topDecreaseRate = [...DB.cbBalance]
            .filter(c => parseFloat(c._changeRate) < 0)
            .sort((a, b) => parseFloat(a._changeRate) - parseFloat(b._changeRate))
            .slice(0, 10);
        
        // è¨ˆç®—æ¸›å°‘æ•¸é¡å‰ååï¼ˆå¢æ¸›æ•¸é¡ç”±å°åˆ°å¤§ï¼Œè² æ•¸è¶Šå¤§æ¸›è¶Šå¤šï¼‰
        const topDecreaseAmount = [...DB.cbBalance]
            .filter(c => parseFloat(c._change) < 0)
            .sort((a, b) => parseFloat(a._change) - parseFloat(b._change))
            .slice(0, 10);
        
        const renderBalanceTop10 = (list, title, highlightField) => {
            if(list.length === 0) return '';
            return `<div class="cb-ind-title" style="margin-top:15px">${title}</div>
            <div class="balance-top10-table">
                <table>
                    <thead><tr><th>åæ¬¡</th><th>ä»£è™Ÿ</th><th>åç¨±</th><th>æœ¬é€±</th><th>ä¸Šé€±</th><th>å¢æ¸›</th><th>æ¯”ç‡</th><th>å‰©é¤˜%</th></tr></thead>
                    <tbody>
                    ${list.map((c, i) => `<tr>
                        <td>${i+1}</td>
                        <td class="code">${c._cbCode}</td>
                        <td class="name-cell">${c._name}</td>
                        <td>${fmtNum(c._thisWeek, 0)}</td>
                        <td>${fmtNum(c._lastWeek, 0)}</td>
                        <td class="${highlightField === '_change' ? 'highlight-red' : ''}">${fmtNum(c._change, 0)}</td>
                        <td class="${highlightField === '_changeRate' ? 'highlight-red' : ''}">${fmtNum(c._changeRate, 2)}%</td>
                        <td>${fmtNum(c._remainRate, 1)}%</td>
                    </tr>`).join('')}
                    </tbody>
                </table>
            </div>`;
        };
        
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${META.cbBalanceStats.total}</div>
                        <div class="cb-stat-label">CBæª”æ•¸</div>
                    </div>
                </div>
                ${renderBalanceTop10(topDecreaseRate, 'ğŸ“‰ æœ¬é€±æ¸›å¹…å‰10å', '_changeRate')}
                ${renderBalanceTop10(topDecreaseAmount, 'ğŸ“‰ æ¸›å°‘æ•¸é¡å‰10å', '_change')}
            </div>
        `;
    } else if(CB_MODE === 'cbas') {
        // CBASå ±åƒ¹
        const industryCnt = {};
        DB.cbCBAS.forEach(c => {
            const ind = c._industry || 'å…¶ä»–';
            industryCnt[ind] = (industryCnt[ind] || 0) + 1;
        });
        const sortedInd = Object.entries(industryCnt).sort((a,b) => b[1]-a[1]);
        
        // è¨ˆç®—ç¬¦åˆæ¢ä»¶çš„æ•¸é‡ï¼šå¹´æœŸ>2 ä¸” æ¬Šåˆ©é‡‘<5
        const filteredCnt = DB.cbCBAS.filter(c => {
            const years = parseFloat(c._remainYears) || 0;
            const premium = parseFloat(c._premium) || 0;
            return years > 2 && premium < 5;
        }).length;
        
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${META.cbCBASStats.total}</div>
                        <div class="cb-stat-label">CBASå ±åƒ¹æª”æ•¸</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('å¹´æœŸ>2 æ¬Šåˆ©é‡‘<5')">
                        <div class="cb-stat-num">${filteredCnt}</div>
                        <div class="cb-stat-label">å¹´æœŸ>2ä¸”æ¬Šåˆ©é‡‘<5</div>
                    </div>
                </div>
                <div class="cb-ind-title">ğŸ“Š å„ç”¢æ¥­åˆ†ä½ˆ</div>
                <div class="cb-ind-grid">
                    ${sortedInd.slice(0, 20).map(([ind, cnt]) => 
                        `<div class="cb-ind-tag" onclick="setSearch('${ind}')">${ind}<span class="num">${cnt}</span></div>`
                    ).join('')}
                </div>
                <div class="cb-ind-title" style="margin-top:15px">ğŸ” æ¢ä»¶ç¯©é¸</div>
                <div class="cb-ind-grid">
                    <div class="cb-ind-tag" onclick="setSearch('å¹´æœŸ>2 æ¬Šåˆ©é‡‘<5')">å¹´æœŸ>2 ä¸” æ¬Šåˆ©é‡‘<5<span class="num">${filteredCnt}</span></div>
                </div>
            </div>
        `;
    } else if(CB_MODE === 'putback') {
        // æå‰è³£å›
        const within30 = DB.cbPutback.filter(c => c._daysToput <= 30).length;
        const within60 = DB.cbPutback.filter(c => c._daysToput > 30 && c._daysToput <= 60).length;
        const within90 = DB.cbPutback.filter(c => c._daysToput > 60).length;
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${DB.cbPutback.length}</div>
                        <div class="cb-stat-label">è¿‘3å€‹æœˆå¯è³£å›</div>
                    </div>
                    <div class="cb-stat-item clickable" onclick="setSearch('')">
                        <div class="cb-stat-num trend-down">${within30}</div>
                        <div class="cb-stat-label">30å¤©å…§</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num trend-warning">${within60}</div>
                        <div class="cb-stat-label">31-60å¤©</div>
                    </div>
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${within90}</div>
                        <div class="cb-stat-label">61-90å¤©</div>
                    </div>
                </div>
            </div>
        `;
    } else if(CB_MODE === 'redeem') {
        // å¼·åˆ¶è´–å›
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${DB.cbRedeem.length}</div>
                        <div class="cb-stat-label">å¼·åˆ¶è´–å›å…¬å‘Š</div>
                    </div>
                </div>
            </div>
        `;
    } else if(CB_MODE === 'stopconv') {
        // åœæ­¢è½‰æ›
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${DB.cbStopConv.length}</div>
                        <div class="cb-stat-label">åœæ­¢è½‰æ›ä¸­</div>
                    </div>
                </div>
            </div>
        `;
    } else if(CB_MODE === 'priceadj') {
        // è½‰æ›åƒ¹æ ¼èª¿æ•´
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${DB.cbPriceAdj.length}</div>
                        <div class="cb-stat-label">åƒ¹æ ¼èª¿æ•´å…¬å‘Š</div>
                    </div>
                </div>
            </div>
        `;
    } else if(CB_MODE === 'concept') {
        // æ¦‚å¿µè‚¡ CB
        // è¨ˆç®—å„æ¦‚å¿µè‚¡å°æ‡‰çš„æ›ç‰Œä¸­ CB æ•¸é‡
        const conceptCbCounts = {};
        const conceptNames = ['å¯Œæ«ƒ50æˆä»½è‚¡', 'å°ç£50æˆä»½è‚¡', 'ä¸­å‹100æˆä»½è‚¡', 'NVDIAæ¦‚å¿µè‚¡', 'å°ç©é›»æ¦‚å¿µè‚¡'];
        
        conceptNames.forEach(cName => {
            const stockCodes = DB.conceptLists[cName] || [];
            const cbCount = DB.cb.filter(cb => stockCodes.includes(cb._stockCode)).length;
            conceptCbCounts[cName] = cbCount;
        });
        
        // å–å¾—åŸå§‹æœå°‹å­—ä¸²ï¼ˆä¸è½‰å°å¯«ï¼‰
        const searchVal = $('search').value.trim();
        
        return `
            <div class="cb-stats">
                ${tabsHtml}
                <div class="cb-stats-grid">
                    <div class="cb-stat-item">
                        <div class="cb-stat-num">${DB.cb.length}</div>
                        <div class="cb-stat-label">æ›ç‰Œä¸­CB</div>
                    </div>
                </div>
                <div class="cb-ind-title">ğŸ’¡ æ¦‚å¿µè‚¡åˆ†é¡</div>
                <div class="cb-ind-grid">
                    ${conceptNames.map(cName => 
                        `<div class="cb-ind-tag ${searchVal === cName ? 'active' : ''}" onclick="setSearch('${cName}')">${cName.replace('æˆä»½è‚¡','').replace('æ¦‚å¿µè‚¡','')}<span class="num">${conceptCbCounts[cName]}</span></div>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    return '';
}

// åˆ‡æ›åˆç´šå¸‚å ´å­æ¨¡å¼
function setPrimaryMode(mode) {
    PRIMARY_MODE = mode;
    $('search').value = '';
    renderList();
}

// åˆ‡æ› CB æ¨¡å¼
function setCbMode(mode) {
    CB_MODE = mode;
    $('search').value = '';
    renderList();
}

function setCbInfoTab(tab) {
    CB_INFO_TAB = tab;
    renderList();
}

function setCbInfoSub(sub) {
    CB_INFO_SUB = sub;
    renderList();
}

// åˆ—è¡¨å…§å³æ™‚ç¯©é¸
function renderList() {
    const q = $('search').value.toLowerCase().trim();
    const qOriginal = $('search').value.trim(); // ä¿ç•™åŸå§‹å¤§å°å¯«
    let list = [];
    
    // é¡¯ç¤º/éš±è—çµ±è¨ˆå€å¡Š
    if(CURR_DB === 'cb') {
        $('cbStatsArea').innerHTML = renderCBStats();
        $('cbStatsArea').style.display = 'block';
        $('stockStatsArea').style.display = 'none';
        $('memoStatsArea').style.display = 'none';
        $('cbFilterTags').style.display = 'none';
    } else if(CURR_DB === 'stocks') {
        $('stockStatsArea').innerHTML = renderStockStats();
        $('stockStatsArea').style.display = 'block';
        $('cbStatsArea').style.display = 'none';
        $('memoStatsArea').style.display = 'none';
        $('cbFilterTags').style.display = 'none';
    } else if(CURR_DB === 'memo') {
        $('memoStatsArea').innerHTML = renderMemoStats();
        $('memoStatsArea').style.display = 'block';
        $('cbStatsArea').style.display = 'none';
        $('stockStatsArea').style.display = 'none';
        $('cbFilterTags').style.display = 'none';
    } else {
        $('cbStatsArea').style.display = 'none';
        $('stockStatsArea').style.display = 'none';
        $('memoStatsArea').style.display = 'none';
        $('cbFilterTags').style.display = 'none';
    }
    
    if(CURR_DB==='news') list = DB.news;
    else if(CURR_DB==='memo') {
        if(MEMO_MODE === 'all') list = DB.memo;
        else if(MEMO_MODE === 'stock') list = DB.memoStock;
        else if(MEMO_MODE === 'industry') list = DB.memoIndustry;
    }
    else if(CURR_DB==='reports') list = DB.reports;
    else if(CURR_DB==='strategy') list = DB.strategy;
    else if(CURR_DB==='stocks') {
        if(STOCK_MODE === 'all') list = Object.values(DB.stocks);
        else if(STOCK_MODE === 'concept') list = DB.conceptStocks;
    }
    else if(CURR_DB==='trends') list = DB.trends;
    else if(CURR_DB==='article') list = DB.article;
    else if(CURR_DB==='cb') {
        if(CB_MODE === 'info') list = DB.cbAll;
        else if(CB_MODE === 'active') list = DB.cb;
        else if(CB_MODE === 'history') list = DB.cbHistory;
        else if(CB_MODE === 'auction') list = DB.cbAuction;
        else if(CB_MODE === 'primary') list = PRIMARY_MODE === 'underwriting' ? DB.cbPrimary : DB.cbBoard;
        else if(CB_MODE === 'balance') list = DB.cbBalance;
        else if(CB_MODE === 'cbas') list = DB.cbCBAS;
        else if(CB_MODE === 'putback') list = DB.cbPutback;
        else if(CB_MODE === 'redeem') list = DB.cbRedeem;
        else if(CB_MODE === 'stopconv') list = DB.cbStopConv;
        else if(CB_MODE === 'priceadj') list = DB.cbPriceAdj;
        else if(CB_MODE === 'concept') list = DB.cb; // æ¦‚å¿µè‚¡ç”¨æ›ç‰Œä¸­ CB
    }

    const filtered = list.filter(i => {
        const str = JSON.stringify(i).toLowerCase();
        
        // CBAS ç‰¹æ®Šæ¢ä»¶ç¯©é¸
        if(CURR_DB === 'cb' && CB_MODE === 'cbas' && q === 'å¹´æœŸ>2 æ¬Šåˆ©é‡‘<5') {
            const years = parseFloat(i._remainYears) || 0;
            const premium = parseFloat(i._premium) || 0;
            return years > 2 && premium < 5;
        }
        
        // æ¦‚å¿µè‚¡ç¯©é¸
        if(CURR_DB === 'cb' && CB_MODE === 'concept') {
            const conceptNames = ['å¯Œæ«ƒ50æˆä»½è‚¡', 'å°ç£50æˆä»½è‚¡', 'ä¸­å‹100æˆä»½è‚¡', 'NVDIAæ¦‚å¿µè‚¡', 'å°ç©é›»æ¦‚å¿µè‚¡'];
            // ç”¨åŸå§‹å¤§å°å¯«æ¯”å°
            const matchedConcept = conceptNames.find(c => c === qOriginal || c.toLowerCase() === q);
            if(matchedConcept) {
                const stockCodes = DB.conceptLists[matchedConcept] || [];
                // æª¢æŸ¥ CB çš„è½‰æ›æ¨™çš„ä»£ç¢¼æ˜¯å¦åœ¨æ¦‚å¿µè‚¡æ¸…å–®ä¸­
                const cbStockCode = i._stockCode || '';
                return stockCodes.includes(cbStockCode);
            }
            // æ²’æœ‰é¸æ“‡æ¦‚å¿µè‚¡æ™‚é¡¯ç¤ºæ‰€æœ‰æ›ç‰Œä¸­ CB
            if(!q) return true;
            // å¦‚æœæœ‰æœå°‹å­—ä¸²ä½†ä¸æ˜¯æ¦‚å¿µè‚¡åç¨±ï¼Œé€²è¡Œä¸€èˆ¬æœå°‹
        }
        
        if(str.includes(q)) return true;
        if(CURR_DB==='memo' && i['ç·¨è™Ÿ']) {
            const d = META.memoDetail[i['ç·¨è™Ÿ']];
            if(d && JSON.stringify(d).toLowerCase().includes(q)) return true;
        }
        return false;
    });
    
    $('resCount').innerText = filtered.length;

    let html = '';
    
    // CB ç”¨è¡¨æ ¼å½¢å¼
    if(CURR_DB === 'cb') {
        // åˆç´šå¸‚å ´ã€æµé€šé¤˜é¡ã€CBASã€å¼·åˆ¶è´–å›ã€åœæ­¢è½‰æ›ã€åƒ¹æ ¼èª¿æ•´ã€åŸºæœ¬è³‡æ–™ ä¸éœ€è¦éæ¿¾æ›ç‰Œé«˜ä½
        let validFiltered = filtered;
        const noFilterModes = ['primary', 'balance', 'cbas', 'redeem', 'stopconv', 'priceadj', 'info'];
        if(!noFilterModes.includes(CB_MODE)) {
            // éæ¿¾æ‰æ›ç‰Œæœ€é«˜æˆ–æœ€ä½ç‚º 0 çš„è³‡æ–™ï¼ˆåƒ…é©ç”¨æ–¼æ›ç‰Œä¸­ã€æ­·å²ã€ç«¶æ‹ï¼‰
            validFiltered = filtered.filter(r => {
                const high = parseFloat(r['_high']) || 0;
                const low = parseFloat(r['_low']) || 0;
                return high > 0 && low > 0;
            });
        }
        
        // æ›´æ–°é¡¯ç¤ºç­†æ•¸
        $('resCount').innerText = validFiltered.length;
        
        // åˆ—è¡¨ç¯©é¸æ¡†å·²ç§»é™¤ï¼Œç›´æ¥ä½¿ç”¨ä¸»æœå°‹æ¡†
        
        if(CB_MODE === 'info') {
            // åŸºæœ¬è³‡æ–™æ¨¡å¼ - æ ¹æ“šå­æ¨™ç±¤é¡¯ç¤ºä¸åŒæ¬„ä½
            if(CB_INFO_TAB === 'issue') {
                // ç™¼è¡Œæ¢ä»¶
                html = <div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                    <thead><tr>
                        <th class="sortable" data-col="_cbCode" data-type="string">CBä»£è™Ÿ</th>
                        <th>CBç°¡ç¨±</th>
                        <th class="sortable" data-col="_stockCode" data-type="string">è‚¡ç¥¨</th>
                        <th class="sortable filterable hide-mobile" data-col="_industry" data-type="string">ç”¢æ¥­ â–¼</th>
                        <th class="sortable filterable" data-col="_method" data-type="string">è©¢/ç«¶ â–¼</th>
                        <th class="sortable filterable" data-col="_guarantee" data-type="string">æ“”ä¿ â–¼</th>
                        <th class="sortable" data-col="_rating" data-type="num">ä¿¡è©•</th>
                        <th class="sortable hide-mobile" data-col="_scale" data-type="num">è¦æ¨¡</th>
                        <th class="sortable" data-col="_convPrice" data-type="num">è½‰æ›åƒ¹</th>
                        <th class="sortable hide-mobile" data-col="_years" data-type="num">å¹´æœŸ</th>
                        <th class="sortable hide-mobile" data-col="_high" data-type="num">æœ€é«˜</th>
                        <th class="sortable hide-mobile" data-col="_low" data-type="num">æœ€ä½</th>
                        <th class="sortable" data-col="_range" data-type="num">æŒ¯å¹…%</th>
                    </tr></thead><tbody>`;
                
                // è¨ˆç®—çµ±è¨ˆ
                let totalHigh = 0, countHigh = 0;
                let totalLow = 0, countLow = 0;
                let totalRange = 0, countRange = 0;
                
                validFiltered.slice(0, 150).forEach(r => {
                    const isActive = DB.cb.find(c => c._cbCode === r._cbCode);
                    const statusClass = isActive ? 'active-cb' : '';
                    const cbCode = r._cbCode || '';
                    const high = parseFloat(r._high) || 0;
                    const low = parseFloat(r._low) || 0;
                    const range = (high > 0 && low > 0) ? ((high - low) / low * 100) : 0;
                    
                    // ç´¯è¨ˆçµ±è¨ˆ
                    if(high > 0) { totalHigh += high; countHigh++; }
                    if(low > 0) { totalLow += low; countLow++; }
                    if(range > 0) { totalRange += range; countRange++; }
                    
                    html += `<tr class="${statusClass}">
                        <td class="code cb-link" data-cb="${cbCode}">${cbCode}</td>
                        <td>${r._name || ''}</td>
                        <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode}</td>
                        <td class="hide-mobile">${r._industry || ''}</td>
                        <td>${r._method || ''}</td>
                        <td>${r._guarantee || ''}</td>
                        <td>${r._rating || ''}</td>
                        <td class="hide-mobile">${r._scale || ''}</td>
                        <td>${fmtNum(r._convPrice, 2)}</td>
                        <td class="hide-mobile">${r._years || ''}</td>
                        <td class="hide-mobile">${high > 0 ? fmtNum(high, 1) : '-'}</td>
                        <td class="hide-mobile">${low > 0 ? fmtNum(low, 1) : '-'}</td>
                        <td class="${colorClass(range)}">${range > 0 ? fmtNum(range, 1) : '-'}</td>
                    </tr>`;
                });
                
                // çµ±è¨ˆåˆ—
                const avgHigh = countHigh > 0 ? (totalHigh / countHigh).toFixed(1) : '-';
                const avgLow = countLow > 0 ? (totalLow / countLow).toFixed(1) : '-';
                const avgRange = countRange > 0 ? (totalRange / countRange).toFixed(1) : '-';
                
                html += `</tbody><tfoot><tr class="stat-row">
                    <td colspan="3" style="text-align:right;font-weight:600">çµ±è¨ˆ (${validFiltered.length}ç­†)</td>
                    <td class="hide-mobile"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="hide-mobile"></td>
                    <td></td>
                    <td class="hide-mobile"></td>
                    <td class="hide-mobile" style="font-weight:600">${avgHigh}</td>
                    <td class="hide-mobile" style="font-weight:600">${avgLow}</td>
                    <td style="font-weight:600">${avgRange}%</td>
                </tr></tfoot>`;
            } else if(CB_INFO_TAB === 'timeline') {
                // æ™‚ç¨‹è³‡è¨Š
                html = <div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                    <thead><tr>
                        <th class="sortable" data-col="_cbCode" data-type="string">CBä»£è™Ÿ</th>
                        <th>CBç°¡ç¨±</th>
                        <th class="sortable" data-col="_stockCode" data-type="string">è‚¡ç¥¨</th>
                        <th class="sortable" data-col="_boardDate" data-type="date">è‘£äº‹æœƒ</th>
                        <th class="sortable hide-mobile" data-col="_sendDate" data-type="date">é€ä»¶æ—¥</th>
                        <th class="sortable hide-mobile" data-col="_effectDate" data-type="date">ç”Ÿæ•ˆæ—¥</th>
                        <th class="sortable" data-col="_bidDate" data-type="string">è©¢/ç«¶æ—¥æœŸ</th>
                        <th class="sortable" data-col="_listDate" data-type="date">æ›ç‰Œæ—¥</th>
                        <th class="sortable" data-col="_expDate" data-type="date">åˆ°æœŸæ—¥</th>
                        <th class="sortable hide-mobile" data-col="_cbasDate" data-type="date">CBASæ‹†è§£</th>
                    </tr></thead><tbody>`;
                
                validFiltered.slice(0, 150).forEach(r => {
                    const isActive = DB.cb.find(c => c._cbCode === r._cbCode);
                    const statusClass = isActive ? 'active-cb' : '';
                    const cbCode = r._cbCode || '';
                    html += `<tr class="${statusClass}">
                        <td class="code cb-link" data-cb="${cbCode}">${cbCode}</td>
                        <td>${r._name || ''}</td>
                        <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode}</td>
                        <td>${fmtDate(r._boardDate)}</td>
                        <td class="hide-mobile">${fmtDate(r._sendDate)}</td>
                        <td class="hide-mobile">${fmtDate(r._effectDate)}</td>
                        <td>${r._bidDate || ''}</td>
                        <td>${fmtDate(r._listDate)}</td>
                        <td>${fmtDate(r._expDate)}</td>
                        <td class="hide-mobile">${fmtDate(r._cbasDate)}</td>
                    </tr>`;
                });
            } else if(CB_INFO_TAB === 'putback') {
                // è³£å›æ¢ä»¶
                html = <div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                    <thead><tr>
                        <th class="sortable" data-col="_cbCode" data-type="string">CBä»£è™Ÿ</th>
                        <th>CBç°¡ç¨±</th>
                        <th class="sortable" data-col="_stockCode" data-type="string">è‚¡ç¥¨</th>
                        <th class="sortable" data-col="_listDate" data-type="date">æ›ç‰Œæ—¥</th>
                        <th class="sortable" data-col="_expDate" data-type="date">åˆ°æœŸæ—¥</th>
                        <th class="sortable" data-col="_putDate1" data-type="date">è³£å›æ—¥1</th>
                        <th class="sortable" data-col="_putDate2" data-type="date">è³£å›æ—¥2</th>
                        <th class="sortable" data-col="_putTiming" data-type="string">è³£å›æ™‚æ©Ÿ</th>
                        <th>è³£å›æ¢ä»¶</th>
                    </tr></thead><tbody>`;
                
                validFiltered.slice(0, 150).forEach(r => {
                    const isActive = DB.cb.find(c => c._cbCode === r._cbCode);
                    const statusClass = isActive ? 'active-cb' : '';
                    const cbCode = r._cbCode || '';
                    html += `<tr class="${statusClass}">
                        <td class="code cb-link" data-cb="${cbCode}">${cbCode}</td>
                        <td>${r._name || ''}</td>
                        <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode}</td>
                        <td>${fmtDate(r._listDate)}</td>
                        <td>${fmtDate(r._expDate)}</td>
                        <td>${fmtDate(r._putDate1)}</td>
                        <td>${fmtDate(r._putDate2)}</td>
                        <td>${r._putTiming || ''}</td>
                        <td style="max-width:150px;white-space:normal;text-align:left">${r._putCondition || ''}</td>
                    </tr>`;
                });
            }
            html += `</tbody></table></div>`;
        } else if(CB_MODE === 'auction') {
            // ç«¶æ‹æ¨¡å¼å°ˆå±¬è¡¨æ ¼
            // è¨ˆç®—å¹³å‡å€¼
            const avgMultiple = validFiltered.reduce((s, r) => s + (parseFloat(r['æŠ•æ¨™å€æ•¸']) || 0), 0) / (validFiltered.length || 1);
            const avgTheory = validFiltered.reduce((s, r) => s + (parseFloat(r['ç†è«–åƒ¹']) || 0), 0) / (validFiltered.length || 1);
            const avgLowestBid = validFiltered.reduce((s, r) => s + (parseFloat(r['æœ€ä½å¾—æ¨™']) || 0), 0) / (validFiltered.length || 1);
            const avgLowestPrem = validFiltered.reduce((s, r) => s + (parseFloat(r['æœ€ä½æº¢åƒ¹']) || 0), 0) / (validFiltered.length || 1);
            const avgAvgBid = validFiltered.reduce((s, r) => s + (parseFloat(r['å¹³å‡å¾—æ¨™']) || 0), 0) / (validFiltered.length || 1);
            const avgAvgPrem = validFiltered.reduce((s, r) => s + (parseFloat(r['å¹³å‡æº¢åƒ¹']) || 0), 0) / (validFiltered.length || 1);
            const avgHigh = validFiltered.reduce((s, r) => s + (parseFloat(r['_high']) || 0), 0) / (validFiltered.length || 1);
            const avgLow = validFiltered.reduce((s, r) => s + (parseFloat(r['_low']) || 0), 0) / (validFiltered.length || 1);
            const avgRange = validFiltered.reduce((s, r) => s + (parseFloat(r['_range']) || 0), 0) / (validFiltered.length || 1);
            
            html = <div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                <thead><tr>
                    <th class="sortable" data-col="_cbCode" data-type="string">CBä»£è™Ÿ</th>
                    <th>CBç°¡ç¨±</th>
                    <th class="sortable hide-mobile" data-col="é–‹æ¨™æ—¥æœŸ" data-type="date">é–‹æ¨™æ—¥</th>
                    <th class="sortable" data-col="æŠ•æ¨™å€æ•¸" data-type="num">æŠ•æ¨™å€æ•¸</th>
                    <th class="sortable hide-mobile" data-col="ç†è«–åƒ¹" data-type="num">ç†è«–åƒ¹</th>
                    <th class="sortable" data-col="æœ€ä½å¾—æ¨™" data-type="num">æœ€ä½å¾—æ¨™</th>
                    <th class="sortable hide-mobile" data-col="æœ€ä½æº¢åƒ¹" data-type="num">æœ€ä½æº¢åƒ¹</th>
                    <th class="sortable" data-col="å¹³å‡å¾—æ¨™" data-type="num">å¹³å‡å¾—æ¨™</th>
                    <th class="sortable hide-mobile" data-col="å¹³å‡æº¢åƒ¹" data-type="num">å¹³å‡æº¢åƒ¹</th>
                    <th class="sortable" data-col="_high" data-type="num">æ›ç‰Œæœ€é«˜</th>
                    <th class="sortable" data-col="_low" data-type="num">æ›ç‰Œæœ€ä½</th>
                    <th class="sortable" data-col="_range" data-type="num">æŒ¯å¹…%</th>
                </tr></thead><tbody>`;
            
            validFiltered.slice(0, 100).forEach(r => {
                const cbCode = r['_cbCode'];
                const cbName = r['_name'];
                const openDate = fmtDate(r['é–‹æ¨™æ—¥æœŸ']);
                const multiple = r['æŠ•æ¨™å€æ•¸'];
                const theory = r['ç†è«–åƒ¹'];
                const lowestBid = r['æœ€ä½å¾—æ¨™'];
                const lowestPrem = parseFloat(r['æœ€ä½æº¢åƒ¹']) || 0;
                const avgBid = r['å¹³å‡å¾—æ¨™'];
                const avgPrem = parseFloat(r['å¹³å‡æº¢åƒ¹']) || 0;
                const high = r['_high'];
                const low = r['_low'];
                const range = r['_range'];
                
                html += `<tr>
                    <td class="code">${cbCode}</td>
                    <td>${cbName}</td>
                    <td class="hide-mobile">${openDate}</td>
                    <td>${fmtNum(multiple, 2)}x</td>
                    <td class="hide-mobile">${fmtNum(theory, 2)}</td>
                    <td>${fmtNum(lowestBid, 2)}</td>
                    <td class="hide-mobile ${colorClass(lowestPrem * 100)}">${fmtNum(lowestPrem * 100, 1)}%</td>
                    <td>${fmtNum(avgBid, 2)}</td>
                    <td class="hide-mobile ${colorClass(avgPrem * 100)}">${fmtNum(avgPrem * 100, 1)}%</td>
                    <td>${fmtNum(high, 1)}</td>
                    <td>${fmtNum(low, 1)}</td>
                    <td class="${colorClass(range)}">${fmtNum(range, 1)}%</td>
                </tr>`;
            });
            
            html += `</tbody><tfoot><tr class="summary-row">
                <td colspan="2"><b>å¹³å‡å€¼ (${validFiltered.length} ç­†)</b></td>
                <td class="hide-mobile"></td>
                <td><b>${fmtNum(avgMultiple, 2)}x</b></td>
                <td class="hide-mobile"><b>${fmtNum(avgTheory, 2)}</b></td>
                <td><b>${fmtNum(avgLowestBid, 2)}</b></td>
                <td class="hide-mobile"><b>${fmtNum(avgLowestPrem * 100, 1)}%</b></td>
                <td><b>${fmtNum(avgAvgBid, 2)}</b></td>
                <td class="hide-mobile"><b>${fmtNum(avgAvgPrem * 100, 1)}%</b></td>
                <td><b>${fmtNum(avgHigh, 1)}</b></td>
                <td><b>${fmtNum(avgLow, 1)}</b></td>
                <td><b>${fmtNum(avgRange, 1)}%</b></td>
            </tr></tfoot></table></div>`;
        } else if(CB_MODE === 'primary') {
            // åˆç´šå¸‚å ´è¡¨æ ¼
            if(PRIMARY_MODE === 'underwriting') {
                html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                    <thead><tr>
                        <th>è‚¡ç¥¨ä»£è™Ÿ</th>
                        <th>CBä»£è™Ÿ</th>
                        <th>ç™¼è¡Œæ¨™çš„</th>
                        <th class="hide-mobile">è©¢åœˆ/ç«¶æ‹</th>
                        <th class="hide-mobile">TCRI</th>
                        <th>ç™¼è¡Œé‡(å„„)</th>
                        <th class="hide-mobile">ç™¼è¡Œåˆ¸å•†</th>
                        <th class="hide-mobile">æŠ•æ¨™æœŸé–“</th>
                        <th>è½‰æ›åƒ¹</th>
                        <th class="hide-mobile">æº¢åƒ¹ç‡</th>
                        <th class="hide-mobile">æ›ç‰Œæ—¥</th>
                    </tr></thead><tbody>`;
                
                validFiltered.slice(0, 100).forEach(r => {
                    html += `<tr>
                        <td class="code">${r._stockCode}</td>
                        <td>${r._cbCode}</td>
                        <td>${r._name}</td>
                        <td class="hide-mobile">${r._method}</td>
                        <td class="hide-mobile">${r._tcri}</td>
                        <td>${fmtNum(r._amount, 0)}</td>
                        <td class="hide-mobile">${r._broker}</td>
                        <td class="hide-mobile">${r._bidPeriod}</td>
                        <td>${fmtNum(r._convPrice, 2)}</td>
                        <td class="hide-mobile">${fmtNum(parseFloat(r._premium)*100, 1)}%</td>
                        <td class="hide-mobile">${fmtDate(r._listDate)}</td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            } else {
                // è‘£äº‹æœƒå…¬å‘Š
                html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                    <thead><tr>
                        <th>è‚¡ç¥¨ä»£è™Ÿ</th>
                        <th>CBä»£ç¢¼</th>
                        <th>ç™¼è¡Œæ¨™çš„</th>
                        <th class="hide-mobile">è©¢åœˆ/ç«¶åƒ¹</th>
                        <th class="hide-mobile">TCRI</th>
                        <th>ç™¼è¡Œé‡(å„„)</th>
                        <th class="hide-mobile">ä¸»è¾¦åˆ¸å•†</th>
                        <th>è‘£äº‹æœƒé€šé</th>
                        <th class="hide-mobile">è‚¡æœ¬(å„„)</th>
                        <th class="hide-mobile">å‚™è¨»</th>
                    </tr></thead><tbody>`;
                
                validFiltered.slice(0, 100).forEach(r => {
                    html += `<tr>
                        <td class="code">${r._stockCode}</td>
                        <td>${r._cbCode}</td>
                        <td>${r._name}</td>
                        <td class="hide-mobile">${r._method}</td>
                        <td class="hide-mobile">${r._tcri}</td>
                        <td>${fmtNum(r._amount, 0)}</td>
                        <td class="hide-mobile">${r._broker}</td>
                        <td>${fmtDate(r._boardDate)}</td>
                        <td class="hide-mobile">${fmtNum(r._capital, 1)}</td>
                        <td class="hide-mobile">${r._note || ''}</td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            }
        } else if(CB_MODE === 'balance') {
            // æµé€šé¤˜é¡è¡¨æ ¼
            html = <div class="cb-table-wrap"><table class="cb-table balance-table" id="cbTable">
                <thead><tr>
                    <th class="sortable" data-col="_cbCode" data-type="string">ä»£è™Ÿ</th>
                    <th>åç¨±</th>
                    <th class="sortable" data-col="_thisWeek" data-type="num">æœ¬é€±</th>
                    <th class="sortable" data-col="_lastWeek" data-type="num">ä¸Šé€±</th>
                    <th class="sortable" data-col="_change" data-type="num">å¢æ¸›</th>
                    <th class="sortable" data-col="_changeRate" data-type="num">æ¯”ç‡%</th>
                    <th class="sortable" data-col="_remainRate" data-type="num">å‰©é¤˜%</th>
                </tr></thead><tbody>`;
            
            validFiltered.slice(0, 150).forEach(r => {
                const change = parseFloat(r._change) || 0;
                const changeRate = parseFloat(r._changeRate) || 0;
                html += `<tr>
                    <td class="code">${r._cbCode}</td>
                    <td class="name-col">${r._name}</td>
                    <td>${fmtNum(r._thisWeek, 0)}</td>
                    <td>${fmtNum(r._lastWeek, 0)}</td>
                    <td class="${change > 0 ? 'up' : change < 0 ? 'down' : ''}">${change !== 0 ? fmtNum(change, 0) : '-'}</td>
                    <td class="${changeRate > 0 ? 'up' : changeRate < 0 ? 'down' : ''}">${changeRate !== 0 ? fmtNum(changeRate, 2)+'%' : '-'}</td>
                    <td>${fmtNum(r._remainRate, 0)}%</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else if(CB_MODE === 'cbas') {
            // CBASå ±åƒ¹è¡¨æ ¼
            html = <div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                <thead><tr>
                    <th class="sortable" data-col="_cbCode" data-type="string">ä»£è™Ÿ</th>
                    <th>åç¨±</th>
                    <th class="sortable" data-col="_guarantee" data-type="string">æ“”ä¿</th>
                    <th class="sortable" data-col="_remainYears" data-type="num">å¹´æœŸ</th>
                    <th class="sortable" data-col="_premium" data-type="num">æ¬Šåˆ©é‡‘</th>
                    <th class="sortable" data-col="_convPrice" data-type="num">è½‰æ›åƒ¹</th>
                    <th class="sortable" data-col="_stockPrice" data-type="num">è‚¡åƒ¹</th>
                    <th class="sortable hide-mobile" data-col="_convValue" data-type="num">è½‰æ›åƒ¹å€¼</th>
                    <th class="sortable" data-col="_premiumPct" data-type="num">æº¢æŠ˜åƒ¹%</th>
                    <th class="sortable hide-mobile" data-col="_vol120" data-type="num">æ³¢å‹•ç‡</th>
                    <th class="hide-mobile">ç”¢æ¥­</th>
                </tr></thead><tbody>`;
            
            validFiltered.slice(0, 150).forEach(r => {
                const premPct = parseFloat(r._premiumPct) || 0;
                html += `<tr>
                    <td class="code">${r._cbCode}</td>
                    <td class="name-col">${r._name}</td>
                    <td>${r._guarantee}</td>
                    <td>${fmtNum(r._remainYears, 2)}</td>
                    <td>${fmtNum(r._premium, 2)}</td>
                    <td>${fmtNum(r._convPrice, 2)}</td>
                    <td>${fmtNum(r._stockPrice, 2)}</td>
                    <td class="hide-mobile">${fmtNum(r._convValue, 2)}</td>
                    <td class="${colorClass(premPct)}">${fmtNum(premPct, 1)}%</td>
                    <td class="hide-mobile">${fmtNum(parseFloat(r._vol120)*100, 1)}%</td>
                    <td class="hide-mobile">${r._industry || ''}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else if(CB_MODE === 'putback') {
            // æå‰è³£å›è¡¨æ ¼
            html = <div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                <thead><tr>
                    <th>CBä»£è™Ÿ</th>
                    <th>CBç°¡ç¨±</th>
                    <th>è‚¡ç¥¨</th>
                    <th>è³£å›æ—¥æœŸ</th>
                    <th>å‰©é¤˜å¤©æ•¸</th>
                    <th class="hide-mobile">è³£å›æ¢ä»¶</th>
                    <th>è½‰æ›åƒ¹</th>
                    <th class="hide-mobile">ç”¢æ¥­</th>
                </tr></thead><tbody>`;
            
            validFiltered.forEach(r => {
                const daysClass = r._daysToput <= 30 ? 'trend-down' : (r._daysToput <= 60 ? 'trend-warning' : '');
                html += `<tr>
                    <td class="code cb-link" data-cb="${r._cbCode}">${r._cbCode}</td>
                    <td>${r._name || ''}</td>
                    <td class="stock" onclick="openStock('${r._stockCode}')">${r._stockCode}</td>
                    <td>${fmtDate(r._nearestPutDate)}</td>
                    <td class="${daysClass}">${r._daysToput} å¤©</td>
                    <td class="hide-mobile" style="max-width:200px;white-space:normal;text-align:left">${r._putCondition || '-'}</td>
                    <td>${fmtNum(r._convPrice, 2)}</td>
                    <td class="hide-mobile">${r._industry || ''}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else if(CB_MODE === 'redeem') {
            // å¼·åˆ¶è´–å›è¡¨æ ¼
            html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                <thead><tr>
                    <th>CBä»£è™Ÿ</th>
                    <th>CBç°¡ç¨±</th>
                    <th>ç”³å ±æ—¥æœŸ</th>
                    <th>çµ‚æ­¢è²·è³£æ—¥</th>
                    <th>æ›ç‰Œæœ€é«˜</th>
                    <th>æ›ç‰Œæœ€ä½</th>
                    <th>CBæ”¶ç›¤</th>
                    <th class="hide-mobile">ä¸»æ—¨</th>
                </tr></thead><tbody>`;
            
            validFiltered.forEach(r => {
                html += `<tr>
                    <td class="code">${r._cbCode}</td>
                    <td>${r._cbName}</td>
                    <td>${r._reportDate}</td>
                    <td>${r._endDate}</td>
                    <td>${fmtNum(r._high, 2)}</td>
                    <td>${fmtNum(r._low, 2)}</td>
                    <td>${fmtNum(r._cbPrice, 2)}</td>
                    <td class="hide-mobile subject-col">${r._subject}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else if(CB_MODE === 'stopconv') {
            // åœæ­¢è½‰æ›è¡¨æ ¼
            html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                <thead><tr>
                    <th>å‚µåˆ¸ä»£ç¢¼</th>
                    <th>å‚µåˆ¸ç°¡ç¨±</th>
                    <th>åœæ­¢èµ·æ—¥</th>
                    <th>åœæ­¢è¿„æ—¥</th>
                    <th>äº‹ç”±</th>
                </tr></thead><tbody>`;
            
            validFiltered.forEach(r => {
                html += `<tr>
                    <td class="code">${r._cbCode}</td>
                    <td>${r._name}</td>
                    <td>${r._startDate}</td>
                    <td>${r._endDate}</td>
                    <td>${r._reason}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else if(CB_MODE === 'priceadj') {
            // è½‰æ›åƒ¹æ ¼èª¿æ•´è¡¨æ ¼
            html = `<div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                <thead><tr>
                    <th>CBä»£è™Ÿ</th>
                    <th>CBç°¡ç¨±</th>
                    <th>èª¿æ•´æ—¥æœŸ</th>
                    <th>åŸå§‹åƒ¹æ ¼</th>
                    <th>èª¿æ•´å¾Œåƒ¹æ ¼</th>
                    <th class="hide-mobile">ä¸»æ—¨</th>
                </tr></thead><tbody>`;
            
            validFiltered.forEach(r => {
                const origPrice = parseFloat(r._origPrice) || 0;
                const newPrice = parseFloat(r._newPrice) || 0;
                const priceChange = newPrice - origPrice;
                html += `<tr>
                    <td class="code">${r._cbCode}</td>
                    <td>${r._cbName}</td>
                    <td>${r._adjDate}</td>
                    <td>${r._origPrice}</td>
                    <td class="${priceChange < 0 ? 'down' : priceChange > 0 ? 'up' : ''}">${r._newPrice}</td>
                    <td class="hide-mobile subject-col">${r._subject}</td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
        } else {
            // æ›ç‰Œä¸­ / æ­·å² æ¨¡å¼è¡¨æ ¼
            // è¨ˆç®—å¹³å‡å€¼
            const validData = validFiltered.filter(r => r['_premium'] !== null && r['_premium'] !== undefined);
            const avgConvPrice = validData.reduce((s, r) => s + (parseFloat(r['è½‰æ›åƒ¹æ ¼(å…ƒ)']) || 0), 0) / (validData.length || 1);
            const avgStockPrice = validData.reduce((s, r) => s + (parseFloat(r['_stockPrice']) || 0), 0) / (validData.length || 1);
            const avgConvValue = validData.reduce((s, r) => s + (parseFloat(r['_convValue']) || 0), 0) / (validData.length || 1);
            const avgPremium = validData.reduce((s, r) => s + (parseFloat(r['_premium']) || 0), 0) / (validData.length || 1);
            const avgHigh = validFiltered.reduce((s, r) => s + (parseFloat(r['_high']) || 0), 0) / (validFiltered.length || 1);
            const avgLow = validFiltered.reduce((s, r) => s + (parseFloat(r['_low']) || 0), 0) / (validFiltered.length || 1);
            const avgRange = validFiltered.reduce((s, r) => s + (parseFloat(r['_range']) || 0), 0) / (validFiltered.length || 1);
            
            html = <div class="cb-table-wrap"><table class="cb-table" id="cbTable">
                <thead><tr>
                    <th class="sortable" data-col="_cbCode" data-type="string">CBä»£è™Ÿ <span class="sort-icon">â‡…</span></th>
                    <th>CBç°¡ç¨±</th>
                    <th class="hide-mobile">æ¨™çš„è‚¡ç¥¨</th>
                    <th class="sortable hide-mobile" data-col="_industry" data-type="string">ç”¢æ¥­ <span class="sort-icon">â‡…</span></th>
                    <th class="sortable hide-mobile" data-col="convPrice" data-type="num">è½‰æ›åƒ¹ <span class="sort-icon">â‡…</span></th>
                    <th class="sortable hide-mobile" data-col="_stockPrice" data-type="num">è‚¡åƒ¹ <span class="sort-icon">â‡…</span></th>
                    <th class="sortable hide-mobile" data-col="_convValue" data-type="num">è½‰æ›åƒ¹å€¼ <span class="sort-icon">â‡…</span></th>
                    <th class="sortable hide-mobile" data-col="_premium" data-type="num">æº¢æŠ˜åƒ¹% <span class="sort-icon">â‡…</span></th>
                    <th class="sortable" data-col="_high" data-type="num">æ›ç‰Œæœ€é«˜ <span class="sort-icon">â‡…</span></th>
                    <th class="sortable" data-col="_low" data-type="num">æ›ç‰Œæœ€ä½ <span class="sort-icon">â‡…</span></th>
                    <th class="sortable" data-col="_cbPrice" data-type="num">CBæ”¶ç›¤ <span class="sort-icon">â‡…</span></th>
                    <th class="sortable" data-col="_range" data-type="num">æŒ¯å¹…% <span class="sort-icon">â‡…</span></th>
                    <th class="sortable" data-col="expDate" data-type="date">åˆ°æœŸæ—¥ <span class="sort-icon">â‡…</span></th>
                </tr></thead><tbody>`;
            
            validFiltered.slice(0, 100).forEach(r => {
            const cbCode = r['_cbCode'] || safe(r['ä»£è™Ÿ']);
            const cbName = r['_name'] || safe(r['åç¨±']);
            const stockCode = r['_stockCode'] || '';
            const stockName = r['_stockName'] || safe(r['è½‰æ›æ¨™çš„åç¨±']);
            const ind = r['_industry'] || '';
            const convPrice = r['è½‰æ›åƒ¹æ ¼(å…ƒ)'];
            const stockPrice = r['_stockPrice'];
            const convValue = r['_convValue'];
            const premium = r['_premium'];
            const high = r['_high'];
            const low = r['_low'];
            const cbPrice = r['_cbPrice'];
            const range = r['_range'];
            const expDate = fmtDate(r['åˆ°æœŸæ—¥']);
            
            html += `<tr>
                <td class="code">${cbCode}</td>
                <td>${cbName}</td>
                <td class="stock hide-mobile" onclick="openStock('${stockCode}')">${stockName} ${stockCode}</td>
                <td class="hide-mobile">${ind}</td>
                <td class="hide-mobile">${fmtNum(convPrice, 1)}</td>
                <td class="hide-mobile">${fmtNum(stockPrice, 2)}</td>
                <td class="hide-mobile ${colorClass(convValue)}">${fmtNum(convValue, 2)}</td>
                <td class="hide-mobile ${colorClass(premium)}">${premium ? fmtNum(premium, 1)+'%' : '-'}</td>
                <td>${fmtNum(high, 1)}</td>
                <td>${fmtNum(low, 1)}</td>
                <td>${fmtNum(cbPrice, 2)}</td>
                <td class="${colorClass(range)}">${fmtNum(range, 1)}%</td>
                <td>${expDate}</td>
            </tr>`;
        });
        
        // åˆè¨ˆåˆ—
        html += `</tbody><tfoot><tr class="summary-row">
            <td colspan="2"><b>å¹³å‡å€¼ (${validFiltered.length} ç­†)</b></td>
            <td class="hide-mobile"></td>
            <td class="hide-mobile"></td>
            <td class="hide-mobile"><b>${fmtNum(avgConvPrice, 1)}</b></td>
            <td class="hide-mobile"><b>${fmtNum(avgStockPrice, 2)}</b></td>
            <td class="hide-mobile"><b>${fmtNum(avgConvValue, 2)}</b></td>
            <td class="hide-mobile ${colorClass(avgPremium)}"><b>${fmtNum(avgPremium, 1)}%</b></td>
            <td><b>${fmtNum(avgHigh, 1)}</b></td>
            <td><b>${fmtNum(avgLow, 1)}</b></td>
            <td><b>${fmtNum(avgRange, 1)}%</b></td>
            <td></td>
        </tr></tfoot></table></div>`;
        }
    } else {
        // å…¶ä»–åˆ†é ç”¨å¡ç‰‡
        filtered.slice(0, 100).forEach(i => {
            let title='', sub='', date='', code='', tagClass='brk', body='', click='', cardClass='card';
            
            if(CURR_DB==='stocks') {
                if(STOCK_MODE === 'all') {
                    title = i['å…¬å¸åç¨±']; code = i['ä»£è™Ÿ']; sub = i['ç”¢æ¥­åˆ†é¡']; 
                    body = i['æ¥­å‹™æ‘˜è¦'] || i['ç”¢æ¥­ç´°åˆ†'] || '';
                    click = `openStock('${code}')`;
                } else if(STOCK_MODE === 'concept') {
                    // æ¦‚å¿µè‚¡æ¨¡å¼
                    title = i['_name']; code = i['_code']; 
                    sub = i['_concept']; tagClass = 'concept';
                    body = `${i['_subCat'] ? 'ã€'+i['_subCat']+'ã€‘' : ''}${i['_desc'] || ''}`;
                    click = `openStock('${code}')`;
                }
                // æŸ¥è©¢è©²è‚¡ç¥¨æ˜¯å¦æœ‰æ›ç‰Œä¸­çš„ CB
                const cbList = META.cbMap[code] || [];
                if(cbList.length > 0) {
                    const cbTags = cbList.map(cb => `<span class="tag cb-tag">${cb._name || cb['åç¨±']}</span>`).join('');
                    i._cbTags = cbTags;
                }
            }
            else if(CURR_DB==='news') {
                const dataType = i['è³‡æ–™é¡å‹'] || '';
                const isIndustry = dataType === 'ç”¢æ¥­è¶¨å‹¢';
                title = i['å…¬å¸']; 
                code = i['è‚¡è™Ÿ']; 
                sub = isIndustry ? 'ç”¢æ¥­è¶¨å‹¢' : i['å ±å°é‡é»åˆ†é¡']; 
                date = i['æ—¥æœŸ']; 
                tagClass = isIndustry ? 'trend-ind' : 'ind';
                body = safe(i['å®Œæ•´å ±å°å…§å®¹']).substring(0, 150);
                click = `openNews('${i['ç·¨è™Ÿ']}')`;
                // ç”¢æ¥­è¶¨å‹¢å¡ç‰‡åŠ ä¸Šç‰¹æ®Šæ¨£å¼
                if(isIndustry) cardClass = 'card industry-card';
            }
            else if(CURR_DB==='memo') {
                title = i['å…¬å¸']; code = i['è‚¡è™Ÿ']; sub = i['å ±å‘Šé¡å‹']; date = i['æ—¥æœŸ'];
                const d = META.memoDetail[i['ç·¨è™Ÿ']];
                body = d ? (safe(d['ç‡Ÿé‹é‡é»']).substring(0,100) + '...') : 'é»æ“ŠæŸ¥çœ‹è©³æƒ…';
                click = `openMemo('${i['ç·¨è™Ÿ']}')`;
                // ç”¢æ¥­ç›¸é—œçš„ Memo ç”¨ç´«è‰²
                const reportType = i['å ±å‘Šé¡å‹'] || '';
                if(reportType.includes('ç”¢æ¥­')) {
                    tagClass = 'trend-ind';
                    cardClass = 'card industry-card';
                }
            }
            else if(CURR_DB==='reports') {
                title = i['å ±å‘Šæ¨™é¡Œ']; sub = i['åˆ¸å•†åç¨±'] + ' - ' + safe(i['ç”¢æ¥­åç¨±']); 
                date = i['å ±å‘Šæ—¥æœŸ']; tagClass = 'ind';
                body = i['å‰¯æ¨™é¡Œ'] || '';
                click = `openReport('${i['å ±å‘Šç·¨è™Ÿ']}')`;
            }
            else if(CURR_DB==='strategy') {
                // è¶¨å‹¢å±•æœ›æ–°æ ¼å¼
                title = i['å ±å‘Šä¸»é¡Œ']; 
                sub = i['ä¸»è¬›å–®ä½']; 
                date = i['å ±å‘Šæ—¥æœŸ'];
                tagClass = 'ind';
                const secData = META.stratSections?.[i['å ±å‘Šç·¨è™Ÿ']];
                const coreView = secData?.basic?.['æ ¸å¿ƒè§€é»'] || '';
                const speaker = i['è¬›è€…'] || '';
                body = `${speaker ? 'è¬›è€…: '+speaker+' | ' : ''}${coreView.substring(0, 80)}${coreView.length > 80 ? '...' : ''}`;
                click = `openStrategy('${i['å ±å‘Šç·¨è™Ÿ']}')`;
            }
            else if(CURR_DB==='trends') {
                title = i['ç”¢æ¥­']; sub = i['è¶¨å‹¢åˆ¤æ–·']; tagClass = 'trend-up';
                code = i['è‚¡è™Ÿ']; 
                body = `ä»£è¡¨:${i['ä»£è¡¨å…¬å¸']} | ä½ç½®:${i['æ™¯æ°£ä½ç½®']}`;
                click = `openTrend('${i['ç”¢æ¥­']}')`;
            }
            else if(CURR_DB==='article') {
                title = i._title; 
                sub = i._difficulty; 
                tagClass = 'ind';
                date = i._date;
                const tags = i._tags || '';
                const pages = i._pages || '';
                body = `${tags} | ${pages}`;
                click = `openArticle('${i._id}')`;
            }

            html += `<div class="${cardClass}" onclick="${click}">
                <div class="card-head"><div class="card-title">${title} ${code?`<span style="color:#999;font-weight:400">${code}</span>`:''}</div>${i._cbTags ? `<div class="cb-tags">${i._cbTags}</div>` : ''}</div>
                <div class="card-meta"><span class="tag ${tagClass}">${sub||'ä¸€èˆ¬'}</span>${date?`<span class="tag dt">${fmtDate(date)}</span>`:''}</div>
                <div class="card-body">${body}</div>
            </div>`;
        });
    }
    
    $('list').innerHTML = html || '<div style="text-align:center;padding:30px;color:#999">ç„¡ç›¸ç¬¦è³‡æ–™</div>';
    
    // CB æ¨¡å¼æ™‚åŠ ä¸Š class è®“è¡¨æ ¼æ»¿ç‰ˆ
    if(CURR_DB === 'cb') {
        $('list').classList.add('cb-mode');
        setTimeout(initCbSort, 50);
    } else {
        $('list').classList.remove('cb-mode');
    }
}

// Modal ç›¸é—œ
function showModal(infoHtml, navItems) {
    $('m-info').innerHTML = infoHtml;
    $('navGrid').innerHTML = navItems.map((n,i) => 
        `<button class="nav-btn ${i===0?'active':''}" onclick="swTab('${n.id}', this)">${n.icon} ${n.label}</button>`
    ).join('');
    $('navGrid').style.display = navItems.length > 1 ? 'flex' : 'none';
    // é è¨­æ¸…ç©ºåº•éƒ¨æ¨™ç±¤ï¼ˆMemoæœƒè‡ªå·±è¨­å®šï¼‰
    const tagsEl = $('m-tags');
    if(tagsEl && !tagsEl.innerHTML) {
        tagsEl.classList.remove('show');
    }
    $('modal').classList.add('show');
}

window.swTab = (id, el) => {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    if(el) el.classList.add('active');
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    const pane = document.getElementById('tab-'+id);
    if(pane) pane.classList.add('active');
};

window.swFin = idx => {
    document.querySelectorAll('.fin-btn').forEach((b,i) => b.classList.toggle('active', i===idx));
    document.querySelectorAll('.fin-sub-pane').forEach((p,i) => p.classList.toggle('active', i===idx));
};

window.closeModal = e => {
    if(!e || e.target.id==='modal' || e.target.classList.contains('m-close')) {
        $('modal').classList.remove('show');
        // æ¸…ç©ºåº•éƒ¨æ¨™ç±¤
        const tagsEl = $('m-tags');
        if(tagsEl) {
            tagsEl.innerHTML = '';
            tagsEl.classList.remove('show');
        }
    }
};

// CB è¡¨æ ¼ç¯©é¸
let cbFilters = {}; // å„²å­˜ç¯©é¸æ¢ä»¶

window.initCbFilter = () => {
    document.querySelectorAll('.cb-table th.filterable').forEach(th => {
        th.addEventListener('click', (e) => {
            e.stopPropagation();
            const col = th.dataset.col;
            
            // é—œé–‰å…¶ä»–ä¸‹æ‹‰é¸å–®
            document.querySelectorAll('.filter-dropdown').forEach(d => d.remove());
            
            // æ”¶é›†è©²æ¬„ä½çš„æ‰€æœ‰å”¯ä¸€å€¼
            const values = new Set();
            document.querySelectorAll('.cb-table tbody tr').forEach(row => {
                const idx = Array.from(th.parentNode.children).indexOf(th);
                const val = row.children[idx]?.textContent?.trim();
                if(val && val !== '-') values.add(val);
            });
            
            // å»ºç«‹ä¸‹æ‹‰é¸å–®
            const dropdown = document.createElement('div');
            dropdown.className = 'filter-dropdown show';
            dropdown.innerHTML = `<div data-val="" class="${!cbFilters[col] ? 'active' : ''}">å…¨éƒ¨</div>` +
                Array.from(values).sort().map(v => 
                    `<div data-val="${v}" class="${cbFilters[col] === v ? 'active' : ''}">${v}</div>`
                ).join('');
            
            th.style.position = 'relative';
            th.appendChild(dropdown);
            
            // é»æ“Šé¸é …
            dropdown.querySelectorAll('div').forEach(opt => {
                opt.onclick = (e) => {
                    e.stopPropagation();
                    const val = opt.dataset.val;
                    if(val) {
                        cbFilters[col] = val;
                    } else {
                        delete cbFilters[col];
                    }
                    dropdown.remove();
                    applyCbFilters();
                };
            });
            
            // é»æ“Šå¤–éƒ¨é—œé–‰
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown() {
                    dropdown.remove();
                    document.removeEventListener('click', closeDropdown);
                }, { once: true });
            }, 10);
        });
    });
};

window.applyCbFilters = () => {
    document.querySelectorAll('.cb-table tbody tr').forEach(row => {
        let show = true;
        Object.entries(cbFilters).forEach(([col, val]) => {
            const th = document.querySelector(`.cb-table th[data-col="${col}"]`);
            if(th) {
                const idx = Array.from(th.parentNode.children).indexOf(th);
                const cellVal = row.children[idx]?.textContent?.trim();
                if(cellVal !== val) show = false;
            }
        });
        row.style.display = show ? '' : 'none';
    });
    
    // æ›´æ–°ç¯©é¸æ¨™è¨˜
    document.querySelectorAll('.cb-table th.filterable').forEach(th => {
        const col = th.dataset.col;
        if(cbFilters[col]) {
            th.style.background = '#fff3cd';
        } else {
            th.style.background = '';
        }
    });
};

// CB è¡¨æ ¼æ’åº
let cbSortCol = null;
let cbSortDir = 'asc';

window.initCbSort = () => {
    // å…ˆåˆå§‹åŒ–ç¯©é¸
    initCbFilter();
    
    document.querySelectorAll('.cb-table th.sortable').forEach(th => {
        th.addEventListener('click', (e) => {
            // å¦‚æœæ˜¯ç¯©é¸æ¬„ä½ä¸”é»æ“Šäº†ä¸‹æ‹‰é¸å–®ï¼Œä¸æ’åº
            if(th.classList.contains('filterable') && th.querySelector('.filter-dropdown')) return;
            
            const col = th.dataset.col;
            const type = th.dataset.type;
            
            // åˆ‡æ›æ’åºæ–¹å‘
            if(cbSortCol === col) {
                cbSortDir = cbSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                cbSortCol = col;
                cbSortDir = 'desc'; // é è¨­ç”±å¤§åˆ°å°
            }
            
            // æ›´æ–°æ¨£å¼
            document.querySelectorAll('.cb-table th.sortable').forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });
            th.classList.add(cbSortDir === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // å–å¾— tbody ä¸¦æ’åº
            const tbody = document.querySelector('.cb-table tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                let aVal, bVal;
                const aIndex = Array.from(th.parentNode.children).indexOf(th);
                
                // å–å¾—å°æ‡‰æ¬„ä½çš„å€¼
                aVal = a.children[aIndex]?.textContent?.trim() || '';
                bVal = b.children[aIndex]?.textContent?.trim() || '';
                
                // ç§»é™¤ % å’Œ x ç¬¦è™Ÿï¼Œä»¥åŠé€—è™Ÿ
                aVal = aVal.replace(/%/g, '').replace(/x/g, '').replace(/,/g, '');
                bVal = bVal.replace(/%/g, '').replace(/x/g, '').replace(/,/g, '');
                
                // è™•ç† - ç¬¦è™Ÿï¼ˆè¡¨ç¤ºç„¡è³‡æ–™ï¼‰
                if(aVal === '-') aVal = type === 'num' ? '-999999999' : '';
                if(bVal === '-') bVal = type === 'num' ? '-999999999' : '';
                
                if(type === 'num') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else if(type === 'date') {
                    aVal = aVal.replace(/\//g, '');
                    bVal = bVal.replace(/\//g, '');
                }
                
                if(aVal < bVal) return cbSortDir === 'asc' ? -1 : 1;
                if(aVal > bVal) return cbSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            // é‡æ–°æ’åˆ—
            rows.forEach(row => tbody.appendChild(row));
        });
    });
};

// é–‹å•Ÿå€‹è‚¡
// é–‹å•Ÿ CB åŸºæœ¬è³‡æ–™è©³æƒ…
window.openCbInfo = function(cbCode) {
    if(!cbCode) return;
    
    const cbCodeStr = String(cbCode).trim();
    
    // å„ªå…ˆå¾ DB.cb (08å·¥ä½œè¡¨-æ›ç‰Œä¸­) æ‰¾
    let activeCb = DB.cb.find(c => String(c._cbCode).trim() === cbCodeStr);
    // å¾ DB.cbAll (01åŸºæœ¬è³‡æ–™) æ‰¾åŸºæœ¬è³‡è¨Š
    let basicCb = DB.cbAll.find(c => String(c._cbCode).trim() === cbCodeStr);
    
    if(!activeCb && !basicCb) {
        console.log('CB not found:', cbCode);
        return;
    }
    
    const isActive = !!activeCb;
    // åˆä½µè³‡æ–™ï¼šæ›ç‰Œä¸­ç”¨ activeCb ç‚ºä¸»ï¼Œè£œå…… basicCb çš„è³‡æ–™
    const cb = isActive ? { ...basicCb, ...activeCb } : basicCb;
    
    const statusTag = isActive ? '<span class="tag trend-up">æ›ç‰Œä¸­</span>' : '<span class="tag dt">å·²ä¸‹å¸‚</span>';
    
    const infoHtml = `
        <div style="font-size:22px;font-weight:700;margin-bottom:5px">${cb._name || cb['åç¨±']} <span style="color:#999;font-size:16px">${cbCode}</span></div>
        <div class="card-meta">
            ${statusTag}
            <span class="tag brk">${cb._industry || 'æœªåˆ†é¡'}</span>
            <span class="tag ind">${cb._method || ''}</span>
            <span class="tag ${cb._guarantee === 'æœ‰æ“”ä¿' ? 'trend-up' : 'dt'}">${cb._guarantee || ''}</span>
        </div>
    `;

    let tIssue, tTimeline, tPutback;
    
    if(isActive) {
        // ===== æ›ç‰Œä¸­ï¼šé¡¯ç¤ºå³æ™‚è³‡æ–™ =====
        const cbPrice = cb._cbPrice || cb['æ”¶ç›¤'] || 0;
        const stockPrice = cb._stockPrice || cb['è‚¡ç¥¨æ”¶ç›¤'] || 0;
        const convPrice = parseFloat(cb['è½‰æ›åƒ¹æ ¼']) || cb._convPrice || 0;
        const convValue = convPrice > 0 ? (stockPrice / convPrice * 100).toFixed(2) : '-';
        const premium = cbPrice > 0 && convValue !== '-' ? ((cbPrice / convValue - 1) * 100).toFixed(2) : '-';
        const high = cb._high || 0;
        const low = cb._low || 0;
        const range = (high > 0 && low > 0) ? ((high - low) / low * 100) : 0;
        
        tIssue = `
            <div class="section-head">ğŸ“ˆ å³æ™‚è¡Œæƒ…</div>
            <div class="grid-2">
                <div class="stat-box"><div class="num" style="color:var(--primary)">${fmtNum(cbPrice, 2)}</div><div class="lbl">CBæ”¶ç›¤</div></div>
                <div class="stat-box"><div class="num">${fmtNum(stockPrice, 2)}</div><div class="lbl">è‚¡ç¥¨æ”¶ç›¤</div></div>
            </div>
            <div class="grid-3">
                <div class="stat-box"><div class="num">${fmtNum(convPrice, 2)}</div><div class="lbl">è½‰æ›åƒ¹</div></div>
                <div class="stat-box"><div class="num">${convValue}</div><div class="lbl">è½‰æ›åƒ¹å€¼</div></div>
                <div class="stat-box"><div class="num ${colorClass(-parseFloat(premium))}">${premium}%</div><div class="lbl">æº¢åƒ¹ç‡</div></div>
            </div>
            <div class="section-head">ğŸ“Š æ›ç‰Œè¡¨ç¾</div>
            <div class="grid-3">
                <div class="stat-box"><div class="num trend-up">${fmtNum(high, 1)}</div><div class="lbl">æ›ç‰Œæœ€é«˜</div></div>
                <div class="stat-box"><div class="num trend-down">${fmtNum(low, 1)}</div><div class="lbl">æ›ç‰Œæœ€ä½</div></div>
                <div class="stat-box"><div class="num ${colorClass(range)}">${fmtNum(range, 1)}%</div><div class="lbl">æŒ¯å¹…</div></div>
            </div>
            <div class="section-head">ğŸ“ ç™¼è¡Œæ¢ä»¶</div>
            <div class="info-row"><span class="info-label">ç™¼è¡Œè¦æ¨¡</span><span class="info-val">${cb['ç™¼è¡Œç¸½é¡(å„„)'] || cb._scale || '-'} å„„</span></div>
            <div class="info-row"><span class="info-label">æµé€šå¼µæ•¸</span><span class="info-val">${cb['æµé€šå¼µæ•¸'] ? fmtNum(cb['æµé€šå¼µæ•¸'], 0) : '-'}</span></div>
            <div class="info-row"><span class="info-label">æµé€šé¤˜é¡</span><span class="info-val">${cb['æµé€šé¤˜é¡(å…ƒ)'] ? fmtNum(cb['æµé€šé¤˜é¡(å…ƒ)'] / 100000000, 2) + 'å„„' : '-'}</span></div>
            <div class="info-row"><span class="info-label">ç™¼è¡Œå¹´æœŸ</span><span class="info-val">${cb._years || '-'} å¹´</span></div>
            <div class="info-row"><span class="info-label">åˆ°æœŸæ—¥</span><span class="info-val">${fmtDate(cb['åˆ°æœŸæ—¥æœŸ']) || fmtDate(cb._expDate)}</span></div>
        `;
        
        tTimeline = `
            <div class="section-head">ğŸ“… é‡è¦æ—¥æœŸ</div>
            <div class="info-row"><span class="info-label">æ›ç‰Œæ—¥æœŸ</span><span class="info-val">${fmtDate(cb['æ›ç‰Œæ—¥æœŸ']) || fmtDate(cb._listDate)}</span></div>
            <div class="info-row"><span class="info-label">åˆ°æœŸæ—¥æœŸ</span><span class="info-val">${fmtDate(cb['åˆ°æœŸæ—¥æœŸ']) || fmtDate(cb._expDate)}</span></div>
            <div class="info-row"><span class="info-label">åœæ­¢è½‰æ›èµ·æ—¥</span><span class="info-val">${fmtDate(cb['åœæ­¢è½‰æ›èµ·æ—¥']) || '-'}</span></div>
            <div class="info-row"><span class="info-label">åœæ­¢è½‰æ›è¿„æ—¥</span><span class="info-val">${fmtDate(cb['åœæ­¢è½‰æ›è¿„æ—¥']) || '-'}</span></div>
            <div class="info-row"><span class="info-label">CBASæ‹†è§£æ—¥</span><span class="info-val">${fmtDate(cb._cbasDate) || '-'}</span></div>
            <div class="section-head">ğŸ“‹ å…¶ä»–è³‡è¨Š</div>
            <div class="info-row"><span class="info-label">ä¿¡ç”¨è©•ç­‰</span><span class="info-val">${cb._rating || '-'}</span></div>
            <div class="info-row"><span class="info-label">ç™¼è¡Œåˆ¸å•†</span><span class="info-val">${cb._issuer || '-'}</span></div>
            <div class="info-row"><span class="info-label">ç”¢æ¥­åœ°ä½</span><span class="info-val">${cb._position || '-'}</span></div>
        `;
        
    } else {
        // ===== å·²ä¸‹å¸‚ï¼šé¡¯ç¤ºæ­·å²è³‡æ–™ =====
        const high = cb._high || 0;
        const low = cb._low || 0;
        const range = (high > 0 && low > 0) ? ((high - low) / low * 100) : 0;
        
        tIssue = `
            <div class="section-head">ğŸ“ ç™¼è¡Œæ¢ä»¶</div>
            <div class="grid-2">
                <div class="stat-box"><div class="num">${fmtNum(cb._convPrice, 2)}</div><div class="lbl">è½‰æ›åƒ¹æ ¼</div></div>
                <div class="stat-box"><div class="num">${cb._scale || '-'}</div><div class="lbl">ç™¼è¡Œè¦æ¨¡(å„„)</div></div>
            </div>
            <div class="info-row"><span class="info-label">ä¿¡ç”¨è©•ç­‰</span><span class="info-val">${cb._rating || '-'}</span></div>
            <div class="info-row"><span class="info-label">ç™¼è¡Œå¹´æœŸ</span><span class="info-val">${cb._years || '-'} å¹´</span></div>
            <div class="info-row"><span class="info-label">ç™¼è¡Œåƒ¹æ ¼</span><span class="info-val">${cb._issuePrice || '-'}</span></div>
            <div class="info-row"><span class="info-label">åˆ°æœŸé‚„æœ¬åƒ¹æ ¼</span><span class="info-val">${cb._expPrice || '-'}</span></div>
            <div class="info-row"><span class="info-label">è¨‚åƒ¹æº¢åƒ¹ç‡</span><span class="info-val">${cb._premium ? fmtNum(cb._premium * 100, 1) + '%' : '-'}</span></div>
            <div class="info-row"><span class="info-label">ç™¼è¡Œåˆ¸å•†</span><span class="info-val">${cb._issuer || '-'}</span></div>
            ${high > 0 ? `
            <div class="section-head">ğŸ“Š æ›ç‰ŒæœŸé–“è¡¨ç¾</div>
            <div class="grid-3">
                <div class="stat-box"><div class="num">${fmtNum(high, 1)}</div><div class="lbl">æ›ç‰Œæœ€é«˜</div></div>
                <div class="stat-box"><div class="num">${fmtNum(low, 1)}</div><div class="lbl">æ›ç‰Œæœ€ä½</div></div>
                <div class="stat-box"><div class="num ${colorClass(range)}">${fmtNum(range, 1)}%</div><div class="lbl">æŒ¯å¹…</div></div>
            </div>` : ''}
        `;
        
        tTimeline = `
            <div class="section-head">ğŸ“… æ™‚ç¨‹è³‡è¨Š</div>
            <div class="info-row"><span class="info-label">è‘£äº‹æœƒå…¬å‘Š</span><span class="info-val">${fmtDate(cb._boardDate)}</span></div>
            <div class="info-row"><span class="info-label">é€ä»¶æ—¥æœŸ</span><span class="info-val">${fmtDate(cb._sendDate)}</span></div>
            <div class="info-row"><span class="info-label">ç”Ÿæ•ˆæ—¥æœŸ</span><span class="info-val">${fmtDate(cb._effectDate)}</span></div>
            <div class="info-row"><span class="info-label">è©¢åœˆ/ç«¶æ‹æ—¥æœŸ</span><span class="info-val">${cb._bidDate || '-'}</span></div>
            <div class="info-row"><span class="info-label">æ›ç‰Œæ—¥æœŸ</span><span class="info-val">${fmtDate(cb._listDate)}</span></div>
            <div class="info-row"><span class="info-label">åˆ°æœŸæ—¥æœŸ</span><span class="info-val">${fmtDate(cb._expDate)}</span></div>
            <div class="info-row"><span class="info-label">CBASæ‹†è§£æ—¥</span><span class="info-val">${fmtDate(cb._cbasDate)}</span></div>
        `;
    }
    
    // è³£å›æ¢ä»¶ï¼ˆå…±ç”¨ï¼‰
    tPutback = `
        <div class="section-head">ğŸ’° è³£å›æ¢ä»¶</div>
        <div class="info-row"><span class="info-label">è³£å›æ—¥æœŸ1</span><span class="info-val">${fmtDate(cb._putDate1)}</span></div>
        <div class="info-row"><span class="info-label">è³£å›æ—¥æœŸ2</span><span class="info-val">${fmtDate(cb._putDate2)}</span></div>
        <div class="info-row"><span class="info-label">æŠ•è³‡äººæå‰è³£å›</span><span class="info-val">${cb._putTiming || '-'}</span></div>
        <div class="info-row"><span class="info-label">è³£å›æ¢ä»¶</span><span class="info-val">${cb._putCondition || '-'}</span></div>
    `;
    
    // ç™¼è¡Œå…¬å¸é€£çµ
    const stockCode = cb._stockCode || cb['è½‰æ›æ¨™çš„ä»£ç¢¼'];
    tIssue += `
        <div class="section-head" style="margin-top:15px">ğŸ¢ ç™¼è¡Œå…¬å¸</div>
        <div class="hl-block clickable" onclick="openStock('${stockCode}');closeModal()" style="background:#e8f5e9;border-left:3px solid #4caf50;">
            <b>${stockCode}</b> ${cb._stockName || ''} - é»æ“ŠæŸ¥çœ‹å…¬å¸åŸºæœ¬è³‡æ–™
        </div>
    `;

    const navItems = isActive ? [
        {id:'issue', icon:'ğŸ“ˆ', label:'å³æ™‚è¡Œæƒ…'},
        {id:'timeline', icon:'ğŸ“…', label:'æ™‚ç¨‹'},
        {id:'putback', icon:'ğŸ’°', label:'è³£å›'}
    ] : [
        {id:'issue', icon:'ğŸ“‹', label:'ç™¼è¡Œæ¢ä»¶'},
        {id:'timeline', icon:'ğŸ—“', label:'æ™‚ç¨‹è³‡è¨Š'},
        {id:'putback', icon:'ğŸ’°', label:'è³£å›æ¢ä»¶'}
    ];

    // çµ„åˆå…§å®¹
    $('m-body').innerHTML = `
        <div class="tab-pane active" id="tab-issue">${tIssue}</div>
        <div class="tab-pane" id="tab-timeline">${tTimeline}</div>
        <div class="tab-pane" id="tab-putback">${tPutback}</div>
    `;
    
    showModal(infoHtml, navItems);
    
    // è¨­å®šç¶ è‰²æ¨£å¼
    document.querySelectorAll('#navGrid .nav-btn').forEach(btn => btn.classList.add('green'));
};

window.openStock = code => {
    if(!code || code==='-') return;
    code = normalizeCode(code);
    const s = DB.stocks[code] || { 'å…¬å¸åç¨±': code, 'ä»£è™Ÿ': code };
    const name = s['å…¬å¸åç¨±'] || code;
    const concepts = META.concepts[code] || [];
    const cbs = META.cbMap[code] || [];
    const memos = META.relatedMemo[code] || [];
    const news = META.relatedNews[code] || [];
    const fin = META.finance[name] || {};
    const prod = META.products[name] || {};
    const track = META.tracking[name] || {};
    const revM = META.revData.month[code] || [];
    const revQ = META.revData.quarter[code] || [];
    const revY = META.revData.year[code] || [];
    const revH = META.revData.highlights[code] || {};

    const infoHtml = `
        <div style="font-size:22px;font-weight:700;margin-bottom:5px">${name} <span style="color:#999;font-size:16px">${code}</span></div>
        <div class="card-meta">
            <span class="tag ind">${s['ç”¢æ¥­åˆ†é¡']||'æœªåˆ†é¡'}</span>
            ${concepts.slice(0,3).map(c=>`<span class="tag concept">#${c.concept}</span>`).join('')}
        </div>
        <div style="font-size:13px;color:#666;margin-top:5px;line-height:1.5">${s['æ¥­å‹™æ‘˜è¦']||''}</div>
    `;

    const navItems = [
        {id:'basic', icon:'ğŸ“Š', label:'ç¸½è¦½'},
        {id:'fin', icon:'ğŸ’°', label:'ç‡Ÿæ”¶'},
        {id:'prod', icon:'ğŸ“¦', label:'ç”¢å“'},
        {id:'rep', icon:'ğŸ“°', label:'å ±å‘Š'},
        {id:'rate', icon:'â­', label:'è©•åƒ¹'}
    ];

    // Tab 1: åŸºæœ¬è³‡æ–™
    let tBasic = `
        <div class="grid-2">
            <div class="stat-box"><div class="num">${s['æˆäº¤']||'-'}</div><div class="lbl">æ”¶ç›¤åƒ¹</div></div>
            <div class="stat-box"><div class="num ${colorClass(s['æ¼²è·Œå¹…'])}">${s['æ¼²è·Œå¹…']||'-'}%</div><div class="lbl">æ¼²è·Œå¹…</div></div>
        </div>
    `;
    if(concepts.length) {
        tBasic += `<div class="section-head">ğŸ’¡ æ¦‚å¿µè‚¡åˆ†é¡</div>`;
        tBasic += concepts.map(c => `<div class="list-item" onclick="setSearch('#${c.concept}');closeModal()"><div class="list-title">#${c.concept}</div><div class="list-sub">${c.sub||''}</div></div>`).join('');
    }
    if(cbs.length) {
        tBasic += `<div class="section-head">ğŸ« å¯è½‰å‚µ (${cbs.length})</div>`;
        tBasic += cbs.map(c => `<div class="hl-block"><b>${c['åç¨±']}</b><br>è½‰åƒ¹: ${c['è½‰æ›åƒ¹æ ¼(å…ƒ)']} | é¤˜é¡: ${c['æœ€æ–°é¤˜é¡(ç™¾è¬)']}M | åˆ°æœŸ: ${fmtDate(c['åˆ°æœŸæ—¥'])}</div>`).join('');
    }

    // Tab 2: ç‡Ÿæ”¶
    let tFin = '';
    
    // Debug info
    console.log('ç‡Ÿæ”¶è³‡æ–™:', code, 'æœˆ:', revM.length, 'å­£:', revQ.length, 'å¹´:', revY.length);
    
    // ç‡Ÿæ”¶äº®é»
    if(revH['å–®æœˆç‡Ÿæ”¶å‰µç´€éŒ„æœˆæ•¸']) {
        tFin += `<div style="margin-bottom:15px"><span class="tag trend-up">ğŸ”¥ æ­·å²æ–°é«˜ ${revH['å–®æœˆç‡Ÿæ”¶å‰µç´€éŒ„æœˆæ•¸']} æ¬¡</span></div>`;
    }
    
    if(revM.length > 0 || revQ.length > 0 || revY.length > 0) {
        // åªå–è¿‘12æœŸ
        const recent12M = revM.slice(0, 12);
        const recent12Q = revQ.slice(0, 12);
        const recent12Y = revY.slice(0, 12);
        
        // è¨ˆç®—æœˆå¢ç‡å’Œå¹´å¢ç‡
        const revWithGrowth = recent12M.map((r, idx) => {
            const prevMonth = revM.find(p => p.month === r.month && p.year === r.year - 1);
            const lastMonth = revM.find(p => {
                if(r.month === 1) return p.year === r.year - 1 && p.month === 12;
                return p.year === r.year && p.month === r.month - 1;
            });
            return {
                ...r,
                yoy: prevMonth ? ((r.rev - prevMonth.rev) / prevMonth.rev * 100) : null,
                mom: lastMonth ? ((r.rev - lastMonth.rev) / lastMonth.rev * 100) : null,
                prevYearRev: prevMonth ? prevMonth.rev : null
            };
        });
        
        // å¹´åº¦æ¯”è¼ƒè¡¨ - å»ºç«‹è³‡æ–™çµæ§‹ï¼ˆåªå–è¿‘4å¹´ï¼‰
        const years = [...new Set(revM.map(r => r.year))].sort((a,b) => b-a).slice(0, 4);
        const monthlyByYear = {};
        years.forEach(y => { monthlyByYear[y] = {}; });
        revM.forEach(r => {
            if(monthlyByYear[r.year]) monthlyByYear[r.year][r.month] = r.rev;
        });
        
        // è¨ˆç®—å¹´åº¦åŠ ç¸½å’Œå¹´å¢ç‡
        const yearTotals = years.map(y => {
            const total = Object.values(monthlyByYear[y] || {}).reduce((a,b) => a+b, 0);
            return { year: y, total };
        });
        const yearGrowth = yearTotals.map((yt, idx) => {
            const prev = yearTotals[idx + 1];
            return { ...yt, yoy: prev ? ((yt.total - prev.total) / prev.total * 100) : null };
        });
        
        tFin += `
            <div class="fin-switcher">
                <div class="fin-btn active" onclick="swFin(0)">æœˆç‡Ÿæ”¶</div>
                <div class="fin-btn" onclick="swFin(1)">å¹´ç‡Ÿæ”¶</div>
            </div>
            
            <div id="ft-0" class="fin-sub-pane active">
                ${revWithGrowth.length > 0 ? `
                <div class="rev-unit">ğŸ’° å–®ä½ï¼šå„„å…ƒ</div>
                <div class="table-wrap"><table class="fin-table">
                    <thead><tr>
                        <th>æœŸåˆ¥</th>
                        <th>ç‡Ÿæ¥­æ”¶å…¥</th>
                        <th>æœˆå¢ç‡</th>
                        <th>å»å¹´åŒæœŸ</th>
                        <th>å¹´å¢ç‡</th>
                    </tr></thead>
                    <tbody>${revWithGrowth.map(r => {
                        const momClass = r.mom > 0 ? '' : (r.mom < 0 ? 't-down' : '');
                        const yoyClass = r.yoy > 0 ? '' : (r.yoy < 0 ? 't-down' : '');
                        return `<tr>
                            <td>${r.d}</td>
                            <td>${fmtNum(r.rev, 1)}</td>
                            <td class="${momClass}">${r.mom !== null ? (r.mom >= 0 ? '+' : '') + fmtNum(r.mom, 2) + '%' : '-'}</td>
                            <td>${r.prevYearRev ? fmtNum(r.prevYearRev, 1) : '-'}</td>
                            <td class="${yoyClass}">${r.yoy !== null ? (r.yoy >= 0 ? '+' : '') + fmtNum(r.yoy, 2) + '%' : '-'}</td>
                        </tr>`;
                    }).join('')}</tbody>
                </table></div>
                ` : '<div style="text-align:center;padding:20px;color:#999">ç„¡æœˆç‡Ÿæ”¶è³‡æ–™</div>'}
            </div>
            
            <div id="ft-1" class="fin-sub-pane">
                ${years.length > 0 ? `
                <div class="rev-unit">ğŸ’° å–®ä½ï¼šå„„å…ƒ</div>
                <div class="table-wrap"><table class="fin-table">
                    <thead><tr>
                        <th>æœŸåˆ¥</th>
                        ${years.map(y => `<th>${y}</th>`).join('')}
                    </tr></thead>
                    <tbody>
                        <tr class="highlight-row">
                            <td>å¹´åº¦åŠ ç¸½</td>
                            ${yearGrowth.map(yg => `<td>${fmtNum(yg.total, 1)}</td>`).join('')}
                        </tr>
                        <tr class="highlight-row">
                            <td>å¹´å¢ç‡</td>
                            ${yearGrowth.map(yg => {
                                const cls = yg.yoy > 0 ? '' : (yg.yoy < 0 ? 't-down' : '');
                                return `<td class="${cls}">${yg.yoy !== null ? (yg.yoy >= 0 ? '+' : '') + fmtNum(yg.yoy, 2) + '%' : '-'}</td>`;
                            }).join('')}
                        </tr>
                        ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `
                            <tr>
                                <td>${m}æœˆ</td>
                                ${years.map(y => `<td>${monthlyByYear[y]?.[m] ? fmtNum(monthlyByYear[y][m], 1) : ''}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table></div>
                ` : '<div style="text-align:center;padding:20px;color:#999">ç„¡å¹´ç‡Ÿæ”¶è³‡æ–™</div>'}
            </div>
        `;
    } else {
        tFin = '<div style="text-align:center;padding:30px;color:#999">ç„¡ç‡Ÿæ”¶è³‡æ–™<br><small>è«‹ç¢ºèª 06_revenue.xlsx å·²æ­£ç¢ºè¼‰å…¥</small></div>';
    }
    
    if(fin['4Q25æŒ‡å¼•']) tFin += `<div class="hl-block" style="margin-top:15px"><b>ğŸ”® æœªä¾†æŒ‡å¼•</b><br>${fmtTxt(fin['4Q25æŒ‡å¼•'])}</div>`;

    // Tab 3: ç”¢å“çµæ§‹
    let tProd = '';
    if(prod['ä¸»è¦ç”¢å“1']) {
        tProd += `<div class="section-head">ğŸ“¦ ç”¢å“çµ„åˆ</div>`;
        [1,2,3].forEach(n => {
            if(prod[`ä¸»è¦ç”¢å“${n}`]) {
                tProd += `<div class="info-row"><span class="info-label">${prod[`ä¸»è¦ç”¢å“${n}`]}</span><span class="info-val">${prod[`ä½”æ¯”/è¡¨ç¾${n}`]||''}</span></div>`;
            }
        });
    }
    if(prod['é—œéµæˆé•·å‹•èƒ½']) tProd += `<div class="hl-block"><b>ğŸš€ æˆé•·å‹•èƒ½</b><br>${fmtTxt(prod['é—œéµæˆé•·å‹•èƒ½'])}</div>`;
    if(prod['2026å±•æœ›']) tProd += `<div class="hl-block"><b>ğŸ”® 2026å±•æœ›</b><br>${fmtTxt(prod['2026å±•æœ›'])}</div>`;
    if(!tProd) tProd = '<div style="text-align:center;padding:30px;color:#999">ç„¡ç”¢å“è³‡æ–™</div>';

    // Tab 4: ç›¸é—œå ±å‘Š
    let tRep = '';
    if(memos.length) {
        tRep += `<div class="section-head">ğŸ“‹ Call Memo (${memos.length})</div>`;
        memos.forEach(m => {
            tRep += `<div class="list-item" onclick="openMemo('${m['ç·¨è™Ÿ']}')">
                <div class="list-title">${m['åˆ¸å•†']} - ${m['å ±å‘Šé¡å‹']}</div>
                <div class="list-sub">${fmtDate(m['æ—¥æœŸ'])} | ${m['é‡è¦æ€§']||''}</div>
            </div>`;
        });
    }
    if(news.length) {
        tRep += `<div class="section-head">âš¡ å¤–é›»å ±å° (${news.length})</div>`;
        news.slice(0,5).forEach(n => {
            tRep += `<div class="list-item" onclick="openNews('${n['ç·¨è™Ÿ']}')">
                <div class="list-title">${n['å ±å°é‡é»åˆ†é¡']}</div>
                <div class="list-sub">${fmtDate(n['æ—¥æœŸ'])}</div>
            </div>`;
        });
    }
    if(!tRep) tRep = '<div style="text-align:center;padding:30px;color:#999">ç„¡ç›¸é—œå ±å‘Š</div>';

    // Tab 5: è©•åƒ¹è©•ç­‰
    let tRate = '';
    if(track['æŠ•è³‡è©•ç­‰']) {
        tRate += `<div class="rating-card"><div class="label">æŠ•è³‡è©•ç­‰</div><div class="big-num">${track['æŠ•è³‡è©•ç­‰']}</div></div>`;
        tRate += `<div class="info-row"><span class="info-label">ç›®æ¨™åƒ¹</span><span class="info-val" style="color:var(--primary);font-size:18px">${track['ç›®æ¨™åƒ¹']||'-'}</span></div>`;
        tRate += `<div class="info-row"><span class="info-label">è¿½è¹¤ç‹€æ…‹</span><span class="info-val">${track['è¿½è¹¤ç‹€æ…‹']||'-'}</span></div>`;
    }
    if(!tRate) tRate = '<div style="text-align:center;padding:30px;color:#999">ç„¡è©•åƒ¹è³‡æ–™</div>';

    $('m-body').innerHTML = `
        <div id="tab-basic" class="tab-pane active">${tBasic}</div>
        <div id="tab-fin" class="tab-pane">${tFin}</div>
        <div id="tab-prod" class="tab-pane">${tProd}</div>
        <div id="tab-rep" class="tab-pane">${tRep}</div>
        <div id="tab-rate" class="tab-pane">${tRate}</div>
    `;
    showModal(infoHtml, navItems);
};

// é–‹å•Ÿ Memo
window.openMemo = id => {
    const m = DB.memo.find(i => String(i['ç·¨è™Ÿ']) === String(id));
    if(!m) return;
    const d = META.memoDetail[id] || {};

    const infoHtml = `
        <div style="font-size:20px;font-weight:700;margin-bottom:5px">${m['å…¬å¸']} <span style="color:#999;font-size:14px">${m['è‚¡è™Ÿ']}</span></div>
        <div class="card-meta">
            <span class="tag brk">${m['åˆ¸å•†']}</span>
            <span class="tag ind">${m['å ±å‘Šé¡å‹']}</span>
            <span class="tag dt">${fmtDate(m['æ—¥æœŸ'])}</span>
        </div>
        <div style="font-size:12px;color:#666;margin-top:5px">åˆ†æå¸«: ${m['åˆ†æå¸«']||'-'} | ${m['é‡è¦æ€§']||''}</div>
    `;

    // 6 å€‹ç¨ç«‹åˆ†é ï¼ˆæ¨™ç±¤ç§»åˆ°åº•éƒ¨å›ºå®šå€ï¼‰
    const navItems = [
        {id:'op', icon:'ğŸ¯', label:'ç‡Ÿé‹é‡é»'},
        {id:'strat', icon:'ğŸš€', label:'ç­–ç•¥æ–¹å‘'},
        {id:'qa', icon:'â“', label:'QAæ‘˜è¦'},
        {id:'rex', icon:'ğŸ‘€', label:'Rexè§€å¯Ÿ'},
        {id:'follow', icon:'ğŸ“Œ', label:'å¾ŒçºŒè¿½è¹¤'},
        {id:'timeline', icon:'ğŸ“…', label:'é—œéµæ™‚ç¨‹'}
    ];

    // Tab 1: ç‡Ÿé‹é‡é»
    const tOp = d['ç‡Ÿé‹é‡é»'] ? `<div class="hl-block">${fmtTxt(d['ç‡Ÿé‹é‡é»'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ç„¡è³‡æ–™</div>';
    
    // Tab 2: ç­–ç•¥æ–¹å‘
    const tStrat = d['ç­–ç•¥æ–¹å‘'] ? `<div class="hl-block">${fmtTxt(d['ç­–ç•¥æ–¹å‘'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ç„¡è³‡æ–™</div>';
    
    // Tab 3: QAæ‘˜è¦
    let tQA = '';
    if(d['é‡è¦QAæ‘˜è¦']) {
        const qaText = safe(d['é‡è¦QAæ‘˜è¦']);
        const lines = qaText.split('\n');
        let currentQ = '', currentA = '';
        lines.forEach(line => {
            if(line.match(/^Q\d*[ï¼š:]/i)) {
                if(currentQ && currentA) {
                    tQA += `<div class="qa-item"><div class="qa-q">${currentQ}</div><div class="qa-a">${currentA}</div></div>`;
                }
                currentQ = line.replace(/^Q\d*[ï¼š:]\s*/i, '');
                currentA = '';
            } else if(line.match(/^A\d*[ï¼š:]/i)) {
                currentA = line.replace(/^A\d*[ï¼š:]\s*/i, '');
            } else if(currentA) {
                currentA += '\n' + line;
            }
        });
        if(currentQ && currentA) {
            tQA += `<div class="qa-item"><div class="qa-q">${currentQ}</div><div class="qa-a">${currentA}</div></div>`;
        }
    }
    if(!tQA) tQA = '<div style="color:#999;text-align:center;padding:20px">ç„¡QAè³‡æ–™</div>';

    // Tab 4: Rexè§€å¯Ÿ
    const tRex = d['Rexè§€å¯Ÿ'] ? `<div class="hl-block">${fmtTxt(d['Rexè§€å¯Ÿ'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ç„¡è§€å¯Ÿè¨˜éŒ„</div>';

    // Tab 5: å¾ŒçºŒè¿½è¹¤
    const tFollow = d['å¾ŒçºŒè¿½è¹¤'] ? `<div class="hl-block">${fmtTxt(d['å¾ŒçºŒè¿½è¹¤'])}</div>` : '<div style="color:#999;text-align:center;padding:20px">ç„¡è¿½è¹¤é …ç›®</div>';

    // Tab 6: é—œéµæ™‚ç¨‹
    let tTimeline = '';
    if(d['é—œéµæ™‚ç¨‹']) {
        safe(d['é—œéµæ™‚ç¨‹']).split('\n').filter(l=>l.trim()).forEach(line => {
            const match = line.match(/^\[([^\]]+)\]\s*(.+)/);
            if(match) {
                tTimeline += `<div class="timeline-item"><div class="timeline-date">${match[1]}</div><div class="timeline-text">${match[2]}</div></div>`;
            } else {
                tTimeline += `<div class="timeline-item"><div class="timeline-text">${line}</div></div>`;
            }
        });
    }
    if(!tTimeline) tTimeline = '<div style="color:#999;text-align:center;padding:20px">ç„¡æ™‚ç¨‹è³‡æ–™</div>';

    // åº•éƒ¨å›ºå®šæ¨™ç±¤å€
    let tagsHtml = '';
    if(d['æ¨™ç±¤']) {
        const tags = safe(d['æ¨™ç±¤']).split(/[,ï¼Œ\s]+/).filter(t=>t);
        if(tags.length > 0) {
            tagsHtml = `<div class="tags-wrap">${tags.map(tag => 
                `<span class="tag concept" onclick="setSearch('${tag}');closeModal()">${tag}</span>`
            ).join('')}</div>`;
        }
    }

    $('m-body').innerHTML = `
        <div id="tab-op" class="tab-pane active">${tOp}</div>
        <div id="tab-strat" class="tab-pane">${tStrat}</div>
        <div id="tab-qa" class="tab-pane">${tQA}</div>
        <div id="tab-rex" class="tab-pane">${tRex}</div>
        <div id="tab-follow" class="tab-pane">${tFollow}</div>
        <div id="tab-timeline" class="tab-pane">${tTimeline}</div>
    `;
    
    // è¨­å®šåº•éƒ¨æ¨™ç±¤
    const tagsEl = $('m-tags');
    if(tagsHtml) {
        tagsEl.innerHTML = tagsHtml;
        tagsEl.classList.add('show');
    } else {
        tagsEl.innerHTML = '';
        tagsEl.classList.remove('show');
    }
    
    showModal(infoHtml, navItems);
};

// é–‹å•Ÿç”¢æ¥­å ±å‘Š
window.openReport = rid => {
    const r = DB.reports.find(i => i['å ±å‘Šç·¨è™Ÿ'] === rid);
    if(!r) return;
    
    const focus = META.reportFocus[rid] || [];
    const views = META.reportViews[rid] || {};
    const ratings = META.reportRatings[rid] || [];

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;color:var(--primary);margin-bottom:5px">${r['å ±å‘Šæ¨™é¡Œ']}</div>
        <div class="card-meta">
            <span class="tag brk">${r['åˆ¸å•†åç¨±']}</span>
            <span class="tag ind">${r['ç”¢æ¥­åç¨±']||''}</span>
            <span class="tag dt">${fmtDate(r['å ±å‘Šæ—¥æœŸ'])}</span>
        </div>
    `;

    const navItems = [
        {id:'sum', icon:'ğŸ“Š', label:'ç¸½è¦½'},
        {id:'focus', icon:'ğŸ”', label:'ç„¦é»åˆ†æ'},
        {id:'view', icon:'ğŸ’¡', label:'åˆ¸å•†è§€é»'},
        {id:'pick', icon:'â­', label:'å€‹è‚¡è©•åƒ¹'}
    ];

    let tSum = '';
    ['æ ¸å¿ƒé‡é»1','æ ¸å¿ƒé‡é»2','æ ¸å¿ƒé‡é»3','æ ¸å¿ƒé‡é»4','æ ¸å¿ƒé‡é»5'].forEach((k,i) => {
        if(r[k]) tSum += `<div class="hl-block"><b>${i+1}.</b> ${r[k]}</div>`;
    });
    if(r['ç”¢æ¥­è©•ç­‰']) tSum += `<div class="info-row"><span class="info-label">ç”¢æ¥­è©•ç­‰</span><span class="info-val" style="color:var(--primary)">${r['ç”¢æ¥­è©•ç­‰']}</span></div>`;

    let tFocus = '';
    if(focus.length) {
        focus.forEach(f => {
            tFocus += `<div class="section-head">${f['æ®µè½æ¨™é¡Œ']||`æ®µè½${f['æ®µè½ç·¨è™Ÿ']}`}</div>`;
            tFocus += `<div class="hl-block">${fmtTxt(f['æ®µè½å…§å®¹'])}</div>`;
            if(f['å¸‚å ´è¦æ¨¡æ•¸æ“š']) tFocus += `<div class="info-row"><span class="info-label">å¸‚å ´è¦æ¨¡</span><span class="info-val">${f['å¸‚å ´è¦æ¨¡æ•¸æ“š']}</span></div>`;
        });
    } else tFocus = '<div style="color:#999;text-align:center;padding:20px">ç„¡ç„¦é»åˆ†æ</div>';

    let tView = '';
    if(views['è§€é»å…§å®¹']) tView += `<div class="hl-block">${fmtTxt(views['è§€é»å…§å®¹'])}</div>`;
    [1,2,3].forEach(n => {
        if(views[`é¦–é¸å€‹è‚¡${n}`]) tView += `<div class="list-item"><div class="list-title">ğŸŒŸ ${views[`é¦–é¸å€‹è‚¡${n}`]}</div><div class="list-sub">${views[`é¦–é¸ç†ç”±${n}`]||''}</div></div>`;
    });
    if(views['é¢¨éšªæé†’']) tView += `<div class="hl-block" style="border-left-color:#e74c3c"><b>âš ï¸ é¢¨éšªæé†’</b><br>${views['é¢¨éšªæé†’']}</div>`;
    if(!tView) tView = '<div style="color:#999;text-align:center;padding:20px">ç„¡åˆ¸å•†è§€é»</div>';

    let tPick = '';
    if(ratings.length) {
        ratings.forEach(rt => {
            const stockCode = normalizeCode(rt['è‚¡ç¥¨ä»£è™Ÿ']);
            tPick += `<div class="list-item" onclick="openStock('${stockCode}')">
                <div class="list-title">${rt['å…¬å¸åç¨±']} <span style="color:#999">${stockCode}</span></div>
                <div style="display:flex;gap:15px;margin-top:8px;font-size:12px">
                    <div><span style="color:#888">è©•ç­‰</span> <b style="color:var(--primary)">${rt['è©•ç­‰']||'-'}</b></div>
                    <div><span style="color:#888">ç›®æ¨™åƒ¹</span> <b>${rt['ç›®æ¨™åƒ¹']||'-'}</b></div>
                    <div><span style="color:#888">25F EPS</span> <b>${rt['EPS_FY25F']||'-'}</b></div>
                </div>
                ${rt['æŠ•è³‡äº®é»']?`<div style="font-size:12px;color:#666;margin-top:5px">${rt['æŠ•è³‡äº®é»']}</div>`:''}
            </div>`;
        });
    } else tPick = '<div style="color:#999;text-align:center;padding:20px">ç„¡å€‹è‚¡è©•åƒ¹</div>';

    $('m-body').innerHTML = `
        <div id="tab-sum" class="tab-pane active">${tSum}</div>
        <div id="tab-focus" class="tab-pane">${tFocus}</div>
        <div id="tab-view" class="tab-pane">${tView}</div>
        <div id="tab-pick" class="tab-pane">${tPick}</div>
    `;
    showModal(infoHtml, navItems);
};

// é–‹å•Ÿè¶¨å‹¢å±•æœ›å ±å‘Š (æ–°æ ¼å¼)
window.openStrategy = rid => {
    const r = DB.strategy.find(i => i['å ±å‘Šç·¨è™Ÿ'] === rid);
    if(!r) return;
    
    const secData = META.stratSections?.[rid];
    if(!secData) return;
    
    const basic = secData.basic || {};
    const sections = secData.sections || [];

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;color:var(--primary);margin-bottom:5px">${basic['å ±å‘Šä¸»é¡Œ'] || r['å ±å‘Šä¸»é¡Œ']}</div>
        ${basic['å‰¯æ¨™é¡Œ'] ? `<div style="font-size:13px;color:#666;margin-bottom:8px;font-style:italic">${basic['å‰¯æ¨™é¡Œ']}</div>` : ''}
        <div class="card-meta">
            <span class="tag brk">${basic['ç™¼å¸ƒå–®ä½'] || r['ä¸»è¬›å–®ä½']}</span>
            ${basic['ä¸»è¬›äºº'] ? `<span class="tag ind">${basic['ä¸»è¬›äºº']}</span>` : ''}
            <span class="tag dt">${fmtDate(basic['ç™¼å¸ƒæ—¥æœŸ'] || r['å ±å‘Šæ—¥æœŸ'])}</span>
            ${basic['å ±å‘Šé æ•¸'] ? `<span class="tag dt">${basic['å ±å‘Šé æ•¸']}</span>` : ''}
        </div>
    `;

    // å»ºç«‹é ç±¤ - ç¬¬ä¸€å€‹æ˜¯ç¸½è¦½ï¼Œå…¶é¤˜æ˜¯å„åˆ†é¡
    const navItems = [{id:'overview', icon:'ğŸ“‹', label:'ç¸½è¦½'}];
    sections.forEach((sec, idx) => {
        // å¾æ¨™é¡Œä¸­æå–ç°¡çŸ­åç¨±
        let label = sec.title.replace(/ã€|ã€‘/g, '').split(' ')[0];
        if(label.length > 6) label = label.substring(0, 6);
        const icons = ['ğŸŒ', 'ğŸ¦', 'ğŸ‡ºğŸ‡¸', 'ğŸ‡¨ğŸ‡³', 'ğŸ‡ªğŸ‡º', 'ğŸ‡¹ğŸ‡¼', 'ğŸ’±', 'ğŸ¤–', 'ğŸ’»', 'ğŸ­', 'ğŸ“ˆ', 'â­', 'ğŸ”—', 'ğŸ’¡', 'ğŸ“Š', 'ğŸ¯'];
        navItems.push({id: `sec${idx}`, icon: icons[idx % icons.length], label: label});
    });

    // ç¸½è¦½å…§å®¹
    let tOverview = '';
    if(basic['æ ¸å¿ƒè§€é»']) {
        tOverview += `<div class="hl-block"><b>ğŸ“Œ æ ¸å¿ƒè§€é»</b><br>${fmtTxt(basic['æ ¸å¿ƒè§€é»'])}</div>`;
    }
    if(basic['æ¨™ç±¤åˆ†é¡']) {
        const tags = basic['æ¨™ç±¤åˆ†é¡'].split('#').filter(t => t.trim());
        tOverview += `<div style="margin:15px 0;display:flex;flex-wrap:wrap;gap:6px">`;
        tags.forEach(tag => {
            tOverview += `<span style="background:#f0f0f0;padding:4px 10px;border-radius:15px;font-size:12px;color:#666">#${tag.trim()}</span>`;
        });
        tOverview += `</div>`;
    }
    
    // åœ¨ç¸½è¦½é¡¯ç¤ºå„åˆ†é¡æ‘˜è¦
    sections.forEach(sec => {
        tOverview += `<div class="section-head">${sec.title}</div>`;
        const preview = sec.items.slice(0, 3);
        preview.forEach(item => {
            const val = item.value ? String(item.value).substring(0, 100) : '';
            tOverview += `<div class="list-item" style="padding:8px 0;border-bottom:1px solid #f0f0f0">
                <span style="font-weight:600;color:#333">${item.label}</span>: 
                <span style="color:#666">${val}${String(item.value || '').length > 100 ? '...' : ''}</span>
            </div>`;
        });
        if(sec.items.length > 3) {
            tOverview += `<div style="font-size:11px;color:#999;padding:5px 0">é‚„æœ‰ ${sec.items.length - 3} é …...</div>`;
        }
    });

    // å„åˆ†é¡è©³ç´°å…§å®¹
    let tabPanes = `<div id="tab-overview" class="tab-pane active">${tOverview}</div>`;
    
    sections.forEach((sec, idx) => {
        let content = `<div class="section-head">${sec.title}</div>`;
        sec.items.forEach(item => {
            const val = item.value ? String(item.value) : '';
            // æª¢æŸ¥æ˜¯å¦æ˜¯è‚¡ç¥¨ä»£è™Ÿ (4ä½æ•¸å­—)
            const isStockCode = /^\d{4}$/.test(item.label);
            
            if(isStockCode) {
                // è‚¡ç¥¨é …ç›® - å¯é»æ“Š
                content += `<div class="list-item" onclick="openStock('${item.label}')" style="cursor:pointer">
                    <div class="list-title">${val} <span style="color:#999">${item.label}</span></div>
                </div>`;
            } else if(val.length > 100) {
                // é•·å…§å®¹ - ç”¨å€å¡Šé¡¯ç¤º
                content += `<div class="hl-block"><b>${item.label}</b><br>${fmtTxt(val)}</div>`;
            } else {
                // çŸ­å…§å®¹ - è¡¨æ ¼å¼é¡¯ç¤º
                content += `<div class="list-item" style="display:flex;padding:10px 0;border-bottom:1px solid #f0f0f0">
                    <div style="font-weight:600;color:#333;min-width:120px">${item.label}</div>
                    <div style="color:#555;flex:1">${val}</div>
                </div>`;
            }
        });
        tabPanes += `<div id="tab-sec${idx}" class="tab-pane">${content}</div>`;
    });

    $('m-body').innerHTML = tabPanes;
    showModal(infoHtml, navItems);
};

// é–‹å•Ÿç”¢æ¥­è¶¨å‹¢
window.openTrend = indName => {
    const t = DB.trends.find(i => i['ç”¢æ¥­'] === indName);
    if(!t) return;

    const infoHtml = `
        <div style="font-size:20px;font-weight:700;margin-bottom:5px">${t['ç”¢æ¥­']}</div>
        <div class="card-meta">
            <span class="tag trend-up">${t['è¶¨å‹¢åˆ¤æ–·']}</span>
            <span class="tag ind">${t['æ™¯æ°£ä½ç½®']}</span>
        </div>
    `;

    const stockCode = normalizeCode(t['è‚¡è™Ÿ']);
    const content = `
        <div class="info-row"><span class="info-label">ä»£è¡¨å…¬å¸</span><span class="info-val tag-link" onclick="openStock('${stockCode}')">${t['ä»£è¡¨å…¬å¸']} ${stockCode}</span></div>
        <div class="section-head">ğŸš€ é—œéµé©…å‹•å› ç´ </div>
        <div class="hl-block">${fmtTxt(t['é—œéµé©…å‹•å› ç´ '])}</div>
        <div class="section-head">âš ï¸ é¢¨éšªå› ç´ </div>
        <div class="hl-block" style="border-left-color:#e74c3c">${fmtTxt(t['é¢¨éšªå› ç´ '])}</div>
        <div class="section-head">ğŸ”® 2026å±•æœ›</div>
        <div class="hl-block">${fmtTxt(t['2026å±•æœ›'])}</div>
        <div class="section-head">ğŸ’¡ æŠ•è³‡å»ºè­°</div>
        <div class="hl-block">${fmtTxt(t['æŠ•è³‡å»ºè­°'])}</div>
    `;

    $('m-body').innerHTML = `<div id="tab-main" class="tab-pane active">${content}</div>`;
    showModal(infoHtml, []);
};

// é–‹å•Ÿå¤–é›»
window.openNews = id => {
    const n = DB.news.find(i => String(i['ç·¨è™Ÿ']) === String(id));
    if(!n) return;

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;margin-bottom:5px">${n['å…¬å¸']} <span style="color:#999;font-size:14px">${n['è‚¡è™Ÿ']}</span></div>
        <div class="card-meta">
            <span class="tag ind">${n['å ±å°é‡é»åˆ†é¡']}</span>
            <span class="tag dt">${fmtDate(n['æ—¥æœŸ'])}</span>
        </div>
    `;

    let content = `<div class="hl-block">${fmtTxt(n['å®Œæ•´å ±å°å…§å®¹'])}</div>`;
    if(n['æ¨™ç±¤']) {
        content += `<div style="margin-top:15px;display:flex;flex-wrap:wrap;gap:5px">`;
        safe(n['æ¨™ç±¤']).split(/[,ï¼Œ\s]+/).forEach(tag => {
            if(tag) content += `<span class="tag concept" style="cursor:pointer" onclick="setSearch('${tag}');closeModal()">${tag}</span>`;
        });
        content += `</div>`;
    }

    $('m-body').innerHTML = `<div id="tab-main" class="tab-pane active">${content}</div>`;
    showModal(infoHtml, []);
};

// é–‹å•Ÿæ–‡ç« 
window.openArticle = id => {
    const a = DB.article.find(i => i._id === id);
    if(!a) return;

    const infoHtml = `
        <div style="font-size:18px;font-weight:700;margin-bottom:5px">${a._title}</div>
        <div class="card-meta">
            <span class="tag ind">${a._difficulty || 'å…¥é–€ç´š'}</span>
            <span class="tag dt">${a._date || ''}</span>
            ${a._pages ? `<span class="tag">${a._pages}</span>` : ''}
        </div>
    `;

    let content = '';
    
    // ä¸»é¡Œæ¨™ç±¤
    if(a._tags) {
        content += `<div class="info-row"><span class="info-label">ä¸»é¡Œæ¨™ç±¤</span><span class="info-val">${a._tags}</span></div>`;
    }
    
    // å…ˆå‚™çŸ¥è­˜
    if(a._prereq && a._prereq !== 'NaN' && a._prereq !== 'nan') {
        content += `<div class="info-row"><span class="info-label">å…ˆå‚™çŸ¥è­˜</span><span class="info-val tag-link">${a._prereq}</span></div>`;
    }
    
    // é—œè¯æ–‡ç« 
    if(a._related && a._related !== 'NaN' && a._related !== 'nan') {
        content += `<div class="info-row"><span class="info-label">é—œè¯æ–‡ç« </span><span class="info-val tag-link">${a._related}</span></div>`;
    }
    
    // æ–‡ç« ç·¨è™Ÿ
    content += `<div class="info-row"><span class="info-label">æ–‡ç« ç·¨è™Ÿ</span><span class="info-val">${a._id}</span></div>`;

    $('m-body').innerHTML = `<div id="tab-main" class="tab-pane active">${content}</div>`;
    showModal(infoHtml, []);
};

// âœ… æ­£ç¢ºçš„äº‹ä»¶å§”æ´¾ï¼šç¶å®šåœ¨ document ä¸Šï¼Œç›£è½æ‰€æœ‰å‹•æ…‹ç”Ÿæˆçš„ .cb-link
document.addEventListener('click', function(e) {
    // æª¢æŸ¥é»æ“Šçš„ç›®æ¨™æ˜¯å¦æœ‰ cb-link class
    if (e.target && e.target.classList.contains('cb-link')) {
        const cbCode = e.target.dataset.cb;
        console.log('CB clicked via delegation:', cbCode);
        if (cbCode) {
            openCbInfo(cbCode);
        }
    }
});

window.onload = init;
</script>
</body>
</html>
