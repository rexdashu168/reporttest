<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤ (Memo Pro)</title>
    
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        if (typeof XLSX === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"><\/script>');
        }
    </script>

    <style>
        /* ===== åŸºç¤è¨­å®š (ç¶­æŒåŸç‰ˆé¢¨æ ¼) ===== */
        :root { --primary: #c96442; --bg: #f5f4ef; --text: #333; --gray: #666; --border: #e0e0e0; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; }

        /* ===== ç½®é ‚é˜²è­·ç½© ===== */
        .sticky-wrapper {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: var(--bg);
            padding: 10px 12px 5px 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }

        /* Loading */
        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .splash-icon { font-size: 48px; animation: bounce 2s infinite; margin-bottom: 15px; }
        .splash-title { font-size: 18px; font-weight: 700; margin-bottom: 5px; }
        .splash-subtitle { font-size: 13px; color: #888; }
        .splash-bar { width: 200px; height: 4px; background: #ddd; border-radius: 2px; overflow: hidden; margin-top: 15px; }
        .splash-progress { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

        /* Components */
        .header { text-align: center; padding-bottom: 10px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
        .header h1 { color: var(--primary); font-size: 20px; margin: 0 0 4px 0; }
        .header p { font-size: 11px; color: #888; margin: 0; }

        .db-switcher { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 8px; }
        .db-tab { flex: 0 0 auto; padding: 6px 14px; background: #fff; border: 1px solid #ccc; border-radius: 20px; font-size: 13px; color: #555; display: flex; align-items: center; gap: 5px; cursor: pointer; transition: 0.2s; }
        .db-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); transform: scale(1.02); }
        .count { background: rgba(0,0,0,0.15); padding: 1px 6px; border-radius: 10px; font-size: 10px; }

        .search-box { position: relative; width: 100%; margin-bottom: 5px; }
        .search-input { width: 100%; padding: 10px 12px 10px 38px; border-radius: 20px; border: 2px solid #ddd; background: #fff; font-size: 14px; outline: none; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999; }

        /* Card List */
        .card-list { padding: 12px; display: flex; flex-direction: column; gap: 10px; }
        .card { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #e0e0e0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); cursor: pointer; }
        .card:active { background: #fafafa; transform: scale(0.99); }
        .card-head { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .card-title { font-weight: 700; font-size: 16px; line-height: 1.3; }
        .card-meta { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px; }
        .tag { font-size: 10px; padding: 2px 8px; border-radius: 6px; color: #fff; font-weight: 500; white-space: nowrap; }
        .tag.brk { background: var(--primary); }
        .tag.ind { background: #2980b9; }
        .tag.dt { background: #e0e0e0; color: #666; }
        .card-body { font-size: 13px; color: #555; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* Modal */
        .modal { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        .modal.show { display: flex; }
        .modal-inner { background: #fff; width: 100%; max-width: 600px; height: 90vh; border-radius: 16px 16px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        .m-head { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .m-close { width: 32px; height: 32px; border-radius: 50%; border: none; background: #f0f0f0; font-size: 20px; color: #666; cursor: pointer; }
        .m-body { flex: 1; overflow-y: auto; padding: 15px; background: #fafaf8; }
        
        /* Modal Components */
        .tab-buttons { display: flex; gap: 8px; padding-bottom: 10px; overflow-x: auto; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .tab-btn { padding: 6px 12px; background: #f5f5f5; border-radius: 15px; font-size: 13px; color: #666; white-space: nowrap; border: 1px solid #eee; cursor: pointer; }
        .tab-btn.active { background: #fff3e6; color: var(--primary); border-color: var(--primary); font-weight: bold; }
        .tab-content { display: none; animation: fadeIn 0.2s; }
        .tab-content.active { display: block; }

        /* 6-Grid Stats */
        .grid-6 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: #fff; padding: 12px; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .stat-label { font-size: 12px; color: #888; margin-bottom: 4px; }
        .stat-val { font-size: 15px; font-weight: 700; color: #333; }
        .stat-val.up { color: #e74c3c; } .stat-val.down { color: #27ae60; }

        .section-block { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .section-title { font-size: 14px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .content-text { font-size: 13px; line-height: 1.7; color: #444; white-space: pre-wrap; }
        
        .auto-table { width: 100%; font-size: 12px; border-collapse: collapse; margin-top: 10px; background: #fff; border: 1px solid #eee; }
        .auto-table th { background: #f0f0f0; text-align: left; padding: 8px; border-bottom: 2px solid #ddd; white-space: nowrap; }
        .auto-table td { padding: 8px; border-bottom: 1px solid #eee; color: #444; }

        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @media(min-width: 768px) { .modal { align-items: center; } .modal-inner { height: 85vh; border-radius: 16px; } }
    </style>
</head>
<body>

    <div class="loading-overlay" id="loader">
        <div class="splash-icon">ğŸ“Š</div>
        <div id="loadTitle" class="splash-title">ç³»çµ±å•Ÿå‹•ä¸­...</div>
        <div id="loadSub" class="splash-subtitle">æ­£åœ¨åŒæ­¥ Rexå¤§å”è³‡æ–™åº«</div>
        <div class="splash-bar"><div class="splash-progress" id="loadBar"></div></div>
    </div>

    <div class="container">
        <div class="sticky-wrapper">
            <div class="header">
                <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
                <p>åˆ¸å•†ç ”ç©¶å ±å‘Š Ã— å¤–é›»å¿«å ± Ã— Call Memo Ã— æŠ•è³‡ç­–ç•¥</p>
            </div>

            <div class="db-switcher">
                <div class="db-tab active" onclick="setDB('news')">âš¡ å¤–é›» <span class="count" id="c-news">0</span></div>
                <div class="db-tab" onclick="setDB('memo')">ğŸ“‹ Memo <span class="count" id="c-memo">0</span></div>
                <div class="db-tab" onclick="setDB('reports')">ğŸ“‘ å ±å‘Š <span class="count" id="c-reports">0</span></div>
                <div class="db-tab" onclick="setDB('strategy')">ğŸ¯ ç­–ç•¥ <span class="count" id="c-strategy">0</span></div>
                <div class="db-tab" onclick="setDB('stocks')">ğŸ¢ å€‹è‚¡ <span class="count" id="c-stocks">0</span></div>
                <div class="db-tab" onclick="setDB('cb')">ğŸ« CB <span class="count" id="c-cb">0</span></div>
                <div class="db-tab" onclick="setDB('industry')">ğŸ­ ç”¢æ¥­ <span class="count" id="c-industry">0</span></div>
            </div>

            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="search-input" id="search" placeholder="æœå°‹å…¬å¸ã€è‚¡è™Ÿ...">
            </div>
            
            <div class="stats-bar" style="text-align:right;font-size:11px;color:#888;">
                æ‰¾åˆ° <b id="resCount" style="color:var(--primary)">0</b> ç­†è³‡æ–™
            </div>
        </div>

        <div class="card-list" id="list"></div>
    </div>

    <div class="modal" id="modal" onclick="closeModal(event)">
        <div class="modal-inner" onclick="event.stopPropagation()">
            <div class="m-head">
                <div id="m-header"></div>
                <button class="m-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="m-body" id="m-body"></div>
        </div>
    </div>

<script>
    const FILES = {
        NEWS: '01_news.xlsx', MEMO: '02_memo.xlsx', REPORTS: '03_reports.xlsx',
        MASTER: '04_master.xlsx', STRAT: '05_Strategy.xlsx', CB: '00_CB.xlsx', REV: '06_revenue.xlsx'
    };

    const DB = { news:[], memo:[], reports:[], strategy:[], stocks:{}, cb:[], industry:[] };
    const IDX = { 
        memoDetail:{}, tracking:{}, finance:{}, products:{}, 
        reportDetail:{}, revenue:{}, cbMap:{}, relatedNews:{}, relatedMemo:{}
    };
    let CURR_DB = 'news';

    // --- å·¥å…· ---
    const $ = id => document.getElementById(id);
    const safe = v => (v==null || v==='undefined') ? '' : String(v).trim();
    const fmtDate = v => {
        if(!v) return '';
        if(typeof v === 'number') {
            const d = new Date((v-25569)*86400000);
            return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
        }
        return v;
    };
    const fmtTxt = t => safe(t).replace(/\n/g, '<br>').replace(/â€¢/g, '<br>â€¢ ');
    const loadStep = (t,s,p) => { $('loadTitle').innerText=t; $('loadSub').innerText=s; $('loadBar').style.width=p+'%'; };

    // --- è¼‰å…¥å¼•æ“ ---
    async function fetchFile(url) {
        try {
            const res = await fetch(url);
            if(!res.ok) throw new Error();
            return XLSX.read(await res.arrayBuffer(), {type:'array'});
        } catch(e) { console.warn('File not found:', url); return null; }
    }

    async function init() {
        loadStep('è®€å–åŸºç¤è³‡æ–™...', 'News, CB, Master', 10);
        await Promise.all([loadNewsData(), loadCBData(), loadMasterData()]);
        
        loadStep('è§£æç ”ç©¶å ±å‘Š...', 'Memo, Reports', 50);
        await Promise.all([loadMemoData(), loadReportsData()]);
        
        loadStep('è¼‰å…¥ç­–ç•¥èˆ‡è²¡å‹™...', 'Strategy, Revenue', 80);
        await Promise.all([loadStrategyData(), loadRevenueData()]);

        loadStep('å®Œæˆ', 'Ready', 100);
        updateCounts();
        renderList();
        $('search').addEventListener('input', renderList);
        setTimeout(()=>$('loader').classList.add('hidden'), 500);
    }

    // --- å€‹åˆ¥è¼‰å…¥å‡½å¼ (åš´æ ¼å°æ‡‰å·¥ä½œè¡¨) ---
    async function loadNewsData() {
        let wb = await fetchFile(FILES.NEWS);
        if(wb) XLSX.utils.sheet_to_json(wb.Sheets['å¤–é›»ç¶œåˆå ±å°']||[]).forEach(r => {
            if(safe(r['è³‡æ–™é¡å‹'])==='å€‹è‚¡å ±å°') {
                DB.news.push(r);
                const k = safe(r['è‚¡è™Ÿ']); if(k) { if(!IDX.relatedNews[k]) IDX.relatedNews[k]=[]; IDX.relatedNews[k].push(r); }
            }
        });
    }

    async function loadCBData() {
        let wb = await fetchFile(FILES.CB);
        if(wb) XLSX.utils.sheet_to_json(wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™']||[]).forEach(r => {
            DB.cb.push(r);
            const k = safe(r['è½‰æ›æ¨™çš„ä»£ç¢¼']); if(k) { if(!IDX.cbMap[k]) IDX.cbMap[k]=[]; IDX.cbMap[k].push(r); }
        });
    }

    async function loadMemoData() {
        let wb = await fetchFile(FILES.MEMO);
        if(wb) {
            XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¡¨']||[]).forEach(r => {
                DB.memo.push(r);
                const k = safe(r['è‚¡è™Ÿ']); if(k) { if(!IDX.relatedMemo[k]) IDX.relatedMemo[k]=[]; IDX.relatedMemo[k].push(r); }
            });
            XLSX.utils.sheet_to_json(wb.Sheets['è©³ç´°å…§å®¹åº«']||[]).forEach(r=>IDX.memoDetail[safe(r['ç·¨è™Ÿ'])]=r);
            XLSX.utils.sheet_to_json(wb.Sheets['å…¬å¸è¿½è¹¤è¡¨']||[]).forEach(r=>IDX.tracking[safe(r['å…¬å¸'])]=r);
            XLSX.utils.sheet_to_json(wb.Sheets['è²¡å‹™æ•¸æ“šå½™ç¸½']||[]).forEach(r=>IDX.finance[safe(r['å…¬å¸'])]=r);
            XLSX.utils.sheet_to_json(wb.Sheets['ç”¢å“çµæ§‹åˆ†æ']||[]).forEach(r=>IDX.products[safe(r['å…¬å¸'])]=r);
            XLSX.utils.sheet_to_json(wb.Sheets['ç”¢æ¥­è¶¨å‹¢ç¸½è¦½']||[]).forEach(r=>DB.industry.push(r)); // ç¨ç«‹åˆ° Industry Tab
        }
    }

    async function loadReportsData() {
        let wb = await fetchFile(FILES.REPORTS);
        if(wb) {
            XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r=>DB.reports.push(r));
            XLSX.utils.sheet_to_json(wb.Sheets['ç„¦é»åˆ†æå…§å®¹']||[]).forEach(r=>{ 
                const id=safe(r['å ±å‘Šç·¨è™Ÿ']); if(!IDX.reportDetail[id]) IDX.reportDetail[id]=[]; IDX.reportDetail[id].push(r); 
            });
        }
    }

    async function loadStrategyData() {
        let wb = await fetchFile(FILES.STRAT);
        if(wb) XLSX.utils.sheet_to_json(wb.Sheets['å ±å‘Šç¸½è¦½']||[]).forEach(r=>DB.strategy.push(r));
    }

    async function loadMasterData() {
        let wb = await fetchFile(FILES.MASTER);
        if(wb) XLSX.utils.sheet_to_json(wb.Sheets['ä¸»è³‡æ–™åº«']||[]).forEach(r=>{ if(r['ä»£è™Ÿ']) DB.stocks[safe(r['ä»£è™Ÿ'])]=r; });
    }

    async function loadRevenueData() {
        let wb = await fetchFile(FILES.REV);
        if(wb) {
            const rows = XLSX.utils.sheet_to_json(wb.Sheets['000_æœˆç‡Ÿæ”¶']||[]);
            const h = Object.keys(rows[0]||{}).filter(k=>k.includes('å–®æœˆç‡Ÿæ”¶'));
            rows.forEach(r => { IDX.revenue[safe(r['ä»£è™Ÿ'])] = h.slice(-12).map(k=>({p:k.replace('å–®æœˆç‡Ÿæ”¶(å„„)',''), v:r[k]})); });
        }
    }

    // --- æ¸²æŸ“åˆ—è¡¨ ---
    function setDB(db) {
        CURR_DB = db;
        document.querySelectorAll('.db-tab').forEach(t=>t.classList.remove('active'));
        event.currentTarget.classList.add('active');
        renderList();
    }

    function updateCounts() {
        $('c-news').innerText = DB.news.length; $('c-memo').innerText = DB.memo.length;
        $('c-reports').innerText = DB.reports.length; $('c-strategy').innerText = DB.strategy.length;
        $('c-stocks').innerText = Object.keys(DB.stocks).length; $('c-cb').innerText = DB.cb.length; $('c-industry').innerText = DB.industry.length;
    }

    function renderList() {
        const q = $('search').value.toLowerCase();
        let list = [], html = '';
        
        if(CURR_DB==='news') list = DB.news;
        else if(CURR_DB==='memo') list = DB.memo;
        else if(CURR_DB==='reports') list = DB.reports;
        else if(CURR_DB==='strategy') list = DB.strategy;
        else if(CURR_DB==='stocks') list = Object.values(DB.stocks);
        else if(CURR_DB==='cb') list = DB.cb;
        else if(CURR_DB==='industry') list = DB.industry;

        const filtered = list.filter(i => JSON.stringify(i).toLowerCase().includes(q));
        $('resCount').innerText = filtered.length;

        filtered.slice(0,50).forEach(i => {
            let id, title, sub, date, content;
            
            if(CURR_DB==='news') { id=i['ç·¨è™Ÿ']; title=i['å…¬å¸']; sub=i['åˆ¸å•†ä¾†æº']; date=i['æ—¥æœŸ']; content=i['å®Œæ•´å ±å°å…§å®¹']; }
            else if(CURR_DB==='memo') { id=i['ç·¨è™Ÿ']; title=`${i['å…¬å¸']} (${i['è‚¡è™Ÿ']})`; sub=i['åˆ¸å•†']; date=i['æ—¥æœŸ']; content=IDX.memoDetail[id]?.['ç‡Ÿé‹é‡é»']; }
            else if(CURR_DB==='reports') { id=i['å ±å‘Šç·¨è™Ÿ']; title=i['å ±å‘Šæ¨™é¡Œ']; sub=i['åˆ¸å•†åç¨±']; date=i['å ±å‘Šæ—¥æœŸ']; content=i['æ ¸å¿ƒé‡é»1']; }
            else if(CURR_DB==='strategy') { id=i['å ±å‘Šç·¨è™Ÿ']; title=i['å ±å‘Šæ¨™é¡Œ']; sub=i['å ±å‘Šé¡å‹']; date=i['å ±å‘Šæ—¥æœŸ']; content=i['ç¸½ç¶“è§€é»æ‘˜è¦']; }
            else if(CURR_DB==='stocks') { id=i['ä»£è™Ÿ']; title=`${i['å…¬å¸åç¨±']} ${i['ä»£è™Ÿ']}`; sub=i['ç”¢æ¥­åˆ†é¡']; content=i['æ¥­å‹™æ‘˜è¦']; }
            else if(CURR_DB==='cb') { id=i['ä»£è™Ÿ']; title=`${i['åç¨±']} (${i['ä»£è™Ÿ']})`; sub=`è½‰åƒ¹:${i['è½‰æ›åƒ¹æ ¼(å…ƒ)']}`; content=`æ¨™çš„:${i['è½‰æ›æ¨™çš„åç¨±']} | é¤˜é¡:${i['æœ€æ–°é¤˜é¡(ç™¾è¬)']}`; }
            else if(CURR_DB==='industry') { id=i['ç”¢æ¥­']; title=i['ç”¢æ¥­']; sub=i['è¶¨å‹¢åˆ¤æ–·']; content=i['é—œéµé©…å‹•å› ç´ ']; }

            html += `<div class="card" onclick="openSmartModal('${CURR_DB}', '${id}')">
                <div class="card-head"><div class="card-title">${title}</div></div>
                <div class="card-meta"><span class="tag brk">${sub||'ä¸€èˆ¬'}</span>${date?`<span class="tag dt">${fmtDate(date)}</span>`:''}</div>
                <div class="card-body">${safe(content).substring(0,80)}...</div>
            </div>`;
        });
        $('list').innerHTML = html;
    }

    // ===== æ™ºæ…§å½ˆçª— (Smart Auto-Field + Custom Layout) =====
    function renderDynamicData(dataObj) {
        if(!dataObj) return '';
        const ignore = ['id', 'ç·¨è™Ÿ', 'code', 'stockCode', 'company', 'name', 'tags', 'content', 'å®Œæ•´å ±å°å…§å®¹', 'æ ¸å¿ƒé‡é»1', 'ç”¢æ¥­', 'è¶¨å‹¢åˆ¤æ–·'];
        let html = '<div class="section-block"><h4>ğŸ“‚ å®Œæ•´æ˜ç´°</h4><table class="auto-table"><thead><tr><th>æ¬„ä½</th><th>å…§å®¹</th></tr></thead><tbody>';
        for (const [key, val] of Object.entries(dataObj)) {
            if(val && typeof val !== 'object' && !ignore.includes(key) && !key.startsWith('__')) {
                html += `<tr><td>${key}</td><td>${safeStr(val)}</td></tr>`;
            }
        }
        return html + '</tbody></table></div>';
    }

    function openSmartModal(type, id) {
        let mergedData = {}, title = '', tags = '';
        let contentHtml = '';

        // 1. Memo (å€‹è‚¡å ±å‘Šå°ˆç”¨ä»‹é¢)
        if(type === 'memo') {
            const m = DB.memo.find(x=>x['ç·¨è™Ÿ']==id);
            const detail = IDX.memoDetail[id]||{};
            const track = IDX.tracking[m['å…¬å¸']]||{};
            const fin = IDX.finance[m['å…¬å¸']]||{};
            const prod = IDX.products[m['å…¬å¸']]||{};
            mergedData = { ...m, ...track, ...fin, ...detail };
            title = `${m['å…¬å¸']} (${m['è‚¡è™Ÿ']})`;
            tags = `<span class="tag brk">${m['åˆ¸å•†']}</span><span class="tag dt">${fmtDate(m['æ—¥æœŸ'])}</span>`;

            contentHtml = `
            <div class="tab-buttons"><button class="tab-btn active" onclick="swTab('ov')">ç¸½è¦½</button><button class="tab-btn" onclick="swTab('op')">ç‡Ÿé‹</button><button class="tab-btn" onclick="swTab('dt')">æ˜ç´°</button></div>
            
            <div id="tab-ov" class="tab-content active">
                <div class="grid-6">
                    <div class="stat-box"><div class="stat-label">ç‡Ÿæ”¶YoY</div><div class="stat-val ${safe(m['ç‡Ÿæ”¶YoY']).includes('+')?'up':''}">${m['ç‡Ÿæ”¶YoY']||'-'}</div></div>
                    <div class="stat-box"><div class="stat-label">æ¯›åˆ©ç‡</div><div class="stat-val">${m['æ¯›åˆ©ç‡']||'-'}</div></div>
                    <div class="stat-box"><div class="stat-label">EPS</div><div class="stat-val">${m['EPS']||'-'}</div></div>
                    <div class="stat-box"><div class="stat-label">è©•ç­‰</div><div class="stat-val">${track['æŠ•è³‡è©•ç­‰']||'-'}</div></div>
                    <div class="stat-box"><div class="stat-label">ç›®æ¨™åƒ¹</div><div class="stat-val up">${track['ç›®æ¨™åƒ¹']||'-'}</div></div>
                    <div class="stat-box"><div class="stat-label">ç‹€æ…‹</div><div class="stat-val">${track['è¿½è¹¤ç‹€æ…‹']||'-'}</div></div>
                </div>
                ${prod['ä¸»è¦ç”¢å“1'] ? `<div class="section-block"><h4>ğŸ“¦ ç”¢å“çµæ§‹</h4>
                    ${[1,2,3].map(i=>prod['ä¸»è¦ç”¢å“'+i] ? `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:5px 0;"><span>${prod['ä¸»è¦ç”¢å“'+i]}</span><b>${prod['ä½”æ¯”/è¡¨ç¾'+i]}</b></div>` : '').join('')}
                </div>` : ''}
            </div>
            
            <div id="tab-op" class="tab-content">
                <div class="section-block"><h4>ğŸ“Œ ç‡Ÿé‹é‡é»</h4><div class="content-text">${fmtTxt(detail['ç‡Ÿé‹é‡é»'])}</div></div>
                ${detail['ç­–ç•¥æ–¹å‘'] ? `<div class="section-block"><h4>ğŸš€ ç­–ç•¥æ–¹å‘</h4><div class="content-text">${fmtTxt(detail['ç­–ç•¥æ–¹å‘'])}</div></div>` : ''}
            </div>

            <div id="tab-dt" class="tab-content">${renderDynamicData(mergedData)}</div>`;
        } 
        
        // 2. Stock (å€‹è‚¡æŸ¥è©¢ä¸­å¿ƒ)
        else if(type === 'stocks') {
            mergedData = DB.stocks[id];
            const code = mergedData['ä»£è™Ÿ'];
            title = `${mergedData['å…¬å¸åç¨±']} (${code})`;
            tags = `<span class="tag ind">${mergedData['ç”¢æ¥­åˆ†é¡']}</span>`;
            
            const memos = IDX.relatedMemo[code] || [];
            const news = IDX.relatedNews[code] || [];
            const cbs = IDX.cbMap[code];

            contentHtml = `
            <div class="tab-buttons"><button class="tab-btn active" onclick="swTab('bas')">åŸºæœ¬</button><button class="tab-btn" onclick="swTab('rel')">ç›¸é—œå ±å‘Š</button><button class="tab-btn" onclick="swTab('all')">æ˜ç´°</button></div>
            
            <div id="tab-bas" class="tab-content active">
                <div class="grid-6">
                    <div class="stat-box"><div class="stat-label">è‚¡åƒ¹</div><div class="stat-val" style="font-size:18px">${mergedData['æˆäº¤']}</div></div>
                    <div class="stat-box"><div class="stat-label">æ¼²è·Œå¹…</div><div class="stat-val ${safe(mergedData['æ¼²è·Œå¹…']).includes('-')?'down':'up'}">${mergedData['æ¼²è·Œå¹…']}</div></div>
                    <div class="stat-box"><div class="stat-label">å¸‚å€¼</div><div class="stat-val">${mergedData['å¸‚å€¼(å„„)']}å„„</div></div>
                    <div class="stat-box"><div class="stat-label">æ›ç‰Œ</div><div class="stat-val">${mergedData['æ›ç‰Œå¹´æ•¸']}å¹´</div></div>
                </div>
                <div class="section-block"><h4>ğŸ’¼ æ¥­å‹™æ‘˜è¦</h4><div class="content-text">${mergedData['æ¥­å‹™æ‘˜è¦']}</div></div>
                ${cbs ? `<div class="section-block"><h4>ğŸ« å¯è½‰å‚µ</h4>${cbs.map(c=>`<div>${c['åç¨±']} (è½‰:${c['è½‰æ›åƒ¹æ ¼(å…ƒ)']})</div>`).join('')}</div>` : ''}
            </div>

            <div id="tab-rel" class="tab-content">
                ${memos.length ? `<h4>Call Memo (${memos.length})</h4>` + memos.map(m=>`<div class="related-item" onclick="openSmartModal('memo','${m['ç·¨è™Ÿ']}')"><div class="related-title">${m['å ±å‘Šé¡å‹']}</div><div class="related-meta">${fmtDate(m['æ—¥æœŸ'])} | ${m['åˆ¸å•†']}</div></div>`).join('') : ''}
                ${news.length ? `<h4>å¤–é›» (${news.length})</h4>` + news.map(n=>`<div class="related-item" onclick="openSmartModal('news','${n['ç·¨è™Ÿ']}')"><div class="related-title">${n['å ±å°é‡é»åˆ†é¡']}</div><div class="related-meta">${fmtDate(n['æ—¥æœŸ'])}</div></div>`).join('') : ''}
            </div>

            <div id="tab-all" class="tab-content">${renderDynamicData(mergedData)}</div>`;
        }
        
        // 3. Others (é€šç”¨é‚è¼¯)
        else {
            if(type === 'news') { mergedData = DB.news.find(x=>x['ç·¨è™Ÿ']==id); title = mergedData['å…¬å¸']; }
            else if(type === 'cb') { mergedData = DB.cb.find(x=>x['ä»£è™Ÿ']==id); title = `${mergedData['åç¨±']} (${mergedData['ä»£è™Ÿ']})`; }
            else if(type === 'reports') { mergedData = DB.reports.find(x=>x['å ±å‘Šç·¨è™Ÿ']==id); title = mergedData['å ±å‘Šæ¨™é¡Œ']; }
            else if(type === 'strategy') { mergedData = DB.strategy.find(x=>x['å ±å‘Šç·¨è™Ÿ']==id); title = mergedData['å ±å‘Šæ¨™é¡Œ']; }
            else if(type === 'industry') { mergedData = DB.industry[id]; title = mergedData['ç”¢æ¥­']; }

            contentHtml = renderDynamicData(mergedData);
            if(mergedData['å®Œæ•´å ±å°å…§å®¹']) contentHtml = `<div class="section-block"><div class="content-text">${fmtTxt(mergedData['å®Œæ•´å ±å°å…§å®¹'])}</div></div>` + contentHtml;
        }

        $('m-header').innerHTML = `<div style="font-size:18px;font-weight:700;margin-bottom:5px;">${title}</div><div class="card-meta">${tags}</div>`;
        $('m-body').innerHTML = contentHtml;
        $('modal').classList.add('show');
    }

    window.swTab = (id) => {
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        $('tab-'+id).classList.add('active');
    };
    
    window.closeModal = (e) => { if(!e || e.target.id==='modal') $('modal').classList.remove('show'); };
    window.onload = init;
</script>
</body>
</html>
