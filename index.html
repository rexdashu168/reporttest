<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* === åŸºç¤æ¨£å¼ === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif; background: #f5f4ef; min-height: 100vh; color: #2d2d2d; }
        .container { max-width: 1200px; margin: 0 auto; padding: 12px; }
        
        /* === Header === */
        .header { text-align: center; padding: 20px 0 15px; border-bottom: 1px solid #e5e3dc; margin-bottom: 15px; }
        .header h1 { font-size: 22px; color: #c96442; margin-bottom: 4px; }
        .header .subtitle { color: #6b6b6b; font-size: 13px; }
        
        /* === è³‡æ–™åº«åˆ‡æ›æŒ‰éˆ• === */
        .db-switcher { display: flex; justify-content: center; gap: 6px; margin: 15px 0; flex-wrap: wrap; }
        .db-tab { padding: 8px 14px; border: 2px solid #e5e3dc; background: #fff; border-radius: 20px; font-size: 12px; font-weight: 600; color: #6b6b6b; cursor: pointer; transition: all 0.2s; }
        .db-tab:hover { border-color: #c96442; color: #c96442; }
        .db-tab.active { background: #c96442; border-color: #c96442; color: #fff; }
        .db-tab .count { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 8px; font-size: 10px; margin-left: 3px; }
        .db-tab.active .count { background: rgba(255,255,255,0.3); }
        
        /* === Loading å‹•ç•« === */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f5f4ef; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loading-overlay.hidden { display: none; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #e5e3dc; border-top-color: #c96442; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-status { color: #6b6b6b; font-size: 14px; text-align: center; }
        .loading-detail { color: #999; font-size: 12px; margin-top: 8px; }
        .loading-progress { width: 200px; height: 4px; background: #e5e3dc; border-radius: 2px; margin-top: 15px; overflow: hidden; }
        .loading-progress-bar { height: 100%; background: #c96442; width: 0%; transition: width 0.3s; }
        
        /* === æœå°‹èˆ‡ç¯©é¸ === */
        .search-section { background: #fff; border: 1px solid #e5e3dc; border-radius: 16px; padding: 14px; margin-bottom: 15px; }
        .main-search { position: relative; margin-bottom: 10px; }
        .main-search::before { content: "ğŸ”"; position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 15px; }
        #mainSearchInput { width: 100%; padding: 12px 12px 12px 44px; border: 2px solid #e5e3dc; border-radius: 25px; background: #fafaf8; font-size: 15px; }
        #mainSearchInput:focus { outline: none; border-color: #c96442; background: #fff; }
        
        .search-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #e5e3dc; border-radius: 12px; margin-top: 4px; max-height: 400px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .search-suggestions.active { display: block; }
        .suggestion-group { padding: 6px 0; border-bottom: 1px solid #f0eeea; }
        .suggestion-group-title { padding: 4px 12px; font-size: 10px; color: #8b8b8b; text-transform: uppercase; }
        .suggestion-item { padding: 10px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .suggestion-item:hover { background: #fafaf8; }
        .suggestion-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .suggestion-icon.company { background: #e8f5ec; }
        .suggestion-icon.tag { background: #fff3e6; }
        .suggestion-icon.stock { background: #e6f0ff; }
        .suggestion-text { flex: 1; }
        .suggestion-main { font-size: 13px; font-weight: 500; }
        .suggestion-sub { font-size: 11px; color: #8b8b8b; margin-top: 2px; }
        .suggestion-count { font-size: 11px; color: #8b8b8b; background: #f0eeea; padding: 2px 8px; border-radius: 10px; }
        
        .hot-tags { margin-bottom: 10px; }
        .hot-tags-title { font-size: 11px; color: #8b8b8b; margin-bottom: 6px; }
        .hot-tags-list { display: flex; flex-wrap: wrap; gap: 5px; }
        .hot-tag { padding: 5px 10px; background: linear-gradient(135deg, #fff3e6, #ffe6cc); border: none; border-radius: 12px; font-size: 12px; color: #c96442; cursor: pointer; transition: all 0.2s; }
        .hot-tag:hover { background: #c96442; color: #fff; }
        
        .filter-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .filter-select { flex: 1; min-width: 100px; }
        .filter-select select { width: 100%; padding: 9px 10px; border: 1px solid #e5e3dc; border-radius: 18px; background: #fafaf8; font-size: 12px; cursor: pointer; }
        .filter-select select:focus { outline: none; border-color: #c96442; }
        .clear-all-btn { padding: 9px 14px; background: transparent; border: 1px solid #d64545; border-radius: 18px; font-size: 12px; color: #d64545; cursor: pointer; transition: all 0.2s; }
        .clear-all-btn:hover { background: #d64545; color: #fff; }
        
        .active-filters { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .active-filter { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; background: #c96442; color: #fff; border-radius: 12px; font-size: 11px; }
        .active-filter .remove { cursor: pointer; opacity: 0.8; }
        
        .stats-bar { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; margin-bottom: 10px; font-size: 12px; color: #6b6b6b; }
        .stats-bar strong { color: #c96442; }
        .sort-options { display: flex; gap: 6px; }
        .sort-btn { padding: 4px 10px; background: #eceae3; border: none; border-radius: 10px; font-size: 11px; cursor: pointer; transition: all 0.2s; }
        .sort-btn:hover { background: #ddd; }
        .sort-btn.active { background: #c96442; color: #fff; }
        
        /* === å¡ç‰‡åˆ—è¡¨ === */
        .reports-list { display: flex; flex-direction: column; gap: 10px; }
        .card-base { background: #fff; border: 1px solid #e5e3dc; border-radius: 14px; padding: 14px; cursor: pointer; transition: all 0.2s; }
        .card-base:hover { border-color: #c96442; box-shadow: 0 4px 16px rgba(201,100,66,0.12); transform: translateY(-1px); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .card-left { display: flex; align-items: center; gap: 8px; flex: 1; flex-wrap: wrap; }
        .company-name { font-size: 15px; font-weight: 700; }
        .company-link { color: #c96442; cursor: pointer; text-decoration: underline; }
        .stock-code { font-size: 11px; color: #8b8b8b; background: #f0eeea; padding: 2px 6px; border-radius: 6px; cursor: pointer; }
        .stock-code:hover { background: #c96442; color: #fff; }
        .importance { color: #f5a623; font-size: 11px; }
        
        .card-meta { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .meta-tag { font-size: 10px; padding: 3px 8px; border-radius: 10px; font-weight: 500; }
        .meta-tag.broker { background: #c96442; color: #fff; }
        .meta-tag.category { background: #5a9e6f; color: #fff; }
        .meta-tag.industry { background: #6b8cce; color: #fff; }
        .meta-tag.date { background: #eceae3; color: #5a5a5a; }
        .meta-tag.analyst { background: #e6f0ff; color: #4a6fa5; }
        .meta-tag.trend { background: #27ae60; color: #fff; }
        .meta-tag.rating { background: #9b59b6; color: #fff; }
        .meta-tag.tp { background: #dcfce7; color: #166534; }
        
        .card-content { font-size: 13px; color: #5a5a5a; line-height: 1.6; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .card-tags { display: flex; flex-wrap: wrap; gap: 4px; }
        .mini-tag { font-size: 10px; padding: 2px 6px; background: #fff3e6; color: #c96442; border-radius: 6px; cursor: pointer; }
        .mini-tag:hover { background: #c96442; color: #fff; }
        
        .card-data { display: flex; gap: 12px; flex-wrap: wrap; padding-top: 8px; border-top: 1px solid #f0eeea; margin-top: 8px; }
        .data-item { font-size: 11px; }
        .data-label { color: #8b8b8b; }
        .data-value { font-weight: 600; }
        .data-value.positive { color: #2e7d46; }
        
        .trend-card { background: linear-gradient(135deg, #fff, #f0fdf4); border: 2px solid #5a9e6f; }
        .trend-badge { font-size: 10px; padding: 2px 8px; background: #5a9e6f; color: #fff; border-radius: 8px; margin-bottom: 6px; display: inline-block; }
        .stock-card { background: linear-gradient(135deg, #fff, #f8f9ff); border: 2px solid #6b8cce; }
        .stock-badge { font-size: 10px; padding: 2px 8px; background: #6b8cce; color: #fff; border-radius: 8px; margin-bottom: 6px; display: inline-block; }
        .industry-card { background: linear-gradient(135deg, #fff, #faf5ff); border: 2px solid #9b59b6; }
        .industry-badge { font-size: 10px; padding: 2px 8px; background: #9b59b6; color: #fff; border-radius: 8px; margin-bottom: 6px; display: inline-block; }
        .strategy-card { background: linear-gradient(135deg, #fff, #fff8f0); border: 2px solid #e67e22; }
        .strategy-badge { font-size: 10px; padding: 2px 8px; background: #e67e22; color: #fff; border-radius: 8px; margin-bottom: 6px; display: inline-block; }
        
        /* === Modal å½ˆçª— === */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; overflow-y: auto; padding: 15px 10px; }
        .modal-overlay.active { display: block; }
        .modal-content { max-width: 900px; margin: 0 auto; background: #fff; border-radius: 18px; overflow: hidden; animation: modalIn 0.2s ease; }
        @keyframes modalIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-header { padding: 16px; background: #fafaf8; border-bottom: 1px solid #e5e3dc; display: flex; justify-content: space-between; align-items: flex-start; }
        .modal-header-info { flex: 1; }
        .modal-meta { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 3px; }
        .modal-subtitle { font-size: 13px; color: #6b6b6b; }
        .modal-close { width: 32px; height: 32px; border: none; background: #eceae3; border-radius: 50%; font-size: 18px; cursor: pointer; margin-left: 10px; }
        .modal-close:hover { background: #d64545; color: #fff; }
        
        .modal-body { padding: 16px; max-height: 70vh; overflow-y: auto; }
        .modal-section { margin-bottom: 18px; }
        .section-title { font-size: 13px; font-weight: 600; color: #c96442; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #eceae3; }
        .content-block { background: #fafaf8; border-radius: 10px; padding: 12px; font-size: 13px; line-height: 1.8; white-space: pre-wrap; }
        
        /* è²¡å‹™æ•¸æ“šç¶²æ ¼ */
        .finance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .finance-card { background: #f8fafc; border-radius: 12px; padding: 20px; border: 1px solid #e2e8f0; }
        .finance-card h4 { margin: 0 0 15px 0; color: #1e293b; font-size: 1rem; border-bottom: 2px solid #3b82f6; padding-bottom: 8px; }
        .finance-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; }
        .finance-item:last-child { border-bottom: none; }
        .finance-item span:first-child { color: #64748b; }
        .finance-item span:last-child { font-weight: 600; color: #1e293b; }
        
        /* ç”¢å“èˆ‡å…¶ä»–æ¨£å¼ */
        .products-list { display: grid; gap: 12px; margin-bottom: 20px; }
        .product-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 15px 20px; border-radius: 10px; border-left: 4px solid #3b82f6; margin-bottom: 8px; }
        .product-name { font-weight: 600; color: #1e293b; font-size: 16px; margin-bottom: 4px; }
        .product-ratio { color: #64748b; font-size: 14px; line-height: 1.5; }
        
        .section-block { background: #f8fafc; border-radius: 12px; padding: 20px; margin-top: 20px; }
        .section-block h4 { margin: 0 0 12px 0; color: #1e293b; font-size: 1rem; }
        .content-text { color: #374151; line-height: 1.8; white-space: pre-wrap; }
        .full-content { background: #f8fafc; padding: 25px; border-radius: 12px; max-height: 60vh; overflow-y: auto; }
        .timeline-text { font-family: 'Monaco', 'Consolas', monospace; font-size: 0.9rem; }
        .rex-view { background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%); border-left: 4px solid #f59e0b; }
        .no-data { color: #94a3b8; text-align: center; padding: 40px; font-style: italic; }
        
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-chip { background: #e0f2fe; color: #0369a1; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; }
        .tags-block { display: flex; flex-wrap: wrap; gap: 5px; }
        .modal-tag { font-size: 12px; padding: 4px 10px; background: #fff3e6; color: #c96442; border-radius: 12px; cursor: pointer; }
        .modal-tag:hover { background: #c96442; color: #fff; }
        
        .info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .info-item { background: #fafaf8; padding: 10px; border-radius: 8px; }
        .info-label { font-size: 13px; color: #8b8b8b; margin-bottom: 3px; }
        .info-value { font-size: 13px; font-weight: 600; }
        .info-value.large { font-size: 16px; }
        
        .tab-buttons { display: flex; gap: 4px; margin-bottom: 12px; flex-wrap: wrap; border-bottom: 1px solid #eceae3; padding-bottom: 8px; }
        .tab-btn { padding: 8px 14px; background: #eceae3; border: none; border-radius: 8px 8px 0 0; font-size: 12px; cursor: pointer; font-weight: 500; }
        .tab-btn:hover { background: #ddd; }
        .tab-btn.active { background: #c96442; color: #fff; }
        .tab-content { display: none; padding: 15px 5px; line-height: 1.8; }
        .tab-content.active { display: block; }
        
        .timeline-item { padding: 10px; background: #fafaf8; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #c96442; cursor: pointer; }
        .timeline-item:hover { background: #f0eeea; }
        .timeline-date { font-size: 13px; color: #c96442; font-weight: 600; }
        .timeline-event { font-size: 15px; margin: 4px 0; }
        .timeline-note { font-size: 13px; color: #6b6b6b; }
        .timeline-status { font-size: 12px; padding: 2px 6px; background: #e8f5ec; color: #2e7d46; border-radius: 6px; margin-top: 4px; display: inline-block; }
        
        .related-item { padding: 10px; background: #fafaf8; border-radius: 8px; margin-bottom: 8px; cursor: pointer; border: 1px solid transparent; }
        .related-item:hover { background: #fff; border-color: #c96442; }
        .related-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .related-meta { font-size: 11px; color: #8b8b8b; }
        
        .empty-state { text-align: center; padding: 50px 20px; color: #8b8b8b; }
        .error-box { background: #fff3f3; border: 1px solid #d64545; border-radius: 12px; padding: 20px; margin: 20px; text-align: center; }
        .error-box h3 { color: #d64545; margin-bottom: 10px; }
        .error-box p { color: #666; font-size: 13px; margin-bottom: 8px; }
        .error-box code { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        
        @media (max-width: 600px) { .header h1 { font-size: 18px; } .db-tab { padding: 6px 10px; font-size: 11px; } .filter-row { flex-direction: column; } .filter-select { min-width: 100%; } .info-grid { grid-template-columns: 1fr 1fr; } .tab-btn { padding: 6px 10px; font-size: 11px; } }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-status" id="loadingStatus">æ­£åœ¨è¼‰å…¥ç ”ç©¶å ±å‘Š...</div>
        <div class="loading-detail" id="loadingDetail"></div>
        <div class="loading-progress"><div class="loading-progress-bar" id="loadingProgressBar"></div></div>
    </div>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
            <p class="subtitle">åˆ¸å•†ç ”ç©¶å ±å‘Š Ã— å¤–é›»å¿«å ± Ã— Call Memo Ã— æŠ•è³‡ç­–ç•¥</p>
        </div>
        <div class="db-switcher">
            <button class="db-tab active" data-db="news" onclick="switchDB('news')">âš¡ å¤–é›»å ±å° <span class="count" id="newsCount">0</span></button>
            <button class="db-tab" data-db="memo" onclick="switchDB('memo')">ğŸ“‹ å ±å‘ŠMemo <span class="count" id="memoCount">0</span></button>
            <button class="db-tab" data-db="reports" onclick="switchDB('reports')">ğŸ“‘ ç”¢æ¥­å ±å‘Š <span class="count" id="reportsCount">0</span></button>
            <button class="db-tab" data-db="strategy" onclick="switchDB('strategy')">ğŸ¯ æŠ•è³‡å±•æœ› <span class="count" id="strategyCount">0</span></button>
            <button class="db-tab" data-db="trends" onclick="switchDB('trends')">ğŸ“ˆ ç”¢æ¥­è¶¨å‹¢ <span class="count" id="trendsCount">0</span></button>
            <button class="db-tab" data-db="industry" onclick="switchDB('industry')">ğŸ­ ç”¢æ¥­å‹•æ…‹ <span class="count" id="industryCount">0</span></button>
            <button class="db-tab" data-db="stocks" onclick="switchDB('stocks')">ğŸ¢ å€‹è‚¡æŸ¥è©¢ <span class="count" id="stocksCount">0</span></button>
            <button class="db-tab" data-db="cb" onclick="switchDB('cb')">ğŸ« CBçµ±è¨ˆ <span class="count" id="cbCount">0</span></button>
        </div>
        <div class="search-section">
            <div class="main-search">
                <input type="text" id="mainSearchInput" placeholder="æœå°‹å…¬å¸åç¨±ã€è‚¡è™Ÿã€æ¨™ç±¤ã€åˆ¸å•†...">
                <div class="search-suggestions" id="searchSuggestions"></div>
            </div>
            <div class="hot-tags">
                <div class="hot-tags-title">ğŸ”¥ ç†±é–€é—œéµå­—</div>
                <div class="hot-tags-list" id="hotTagsList"></div>
            </div>
            <div class="filter-row">
                <div class="filter-select"><select id="brokerFilter"><option value="">æ‰€æœ‰åˆ¸å•†</option></select></div>
                <div class="filter-select" id="categoryFilterWrap"><select id="categoryFilter"><option value="">æ‰€æœ‰åˆ†é¡</option></select></div>
                <div class="filter-select" id="importanceFilterWrap"><select id="importanceFilter"><option value="">æ‰€æœ‰é‡è¦æ€§</option><option value="â­â­â­â­â­">â­â­â­â­â­</option><option value="â­â­â­â­">â­â­â­â­</option><option value="â­â­â­">â­â­â­</option></select></div>
                <div class="filter-select" id="industryFilterWrap" style="display:none;"><select id="industryFilter"><option value="">æ‰€æœ‰ç”¢æ¥­</option></select></div>
                <div class="filter-select" id="marketFilterWrap" style="display:none;"><select id="marketFilter"><option value="">æ‰€æœ‰å¸‚å ´</option></select></div>
                <button class="clear-all-btn" onclick="clearAllFilters()">æ¸…é™¤ç¯©é¸</button>
            </div>
            <div class="active-filters" id="activeFilters"></div>
        </div>
        <div class="stats-bar">
            <span>æ‰¾åˆ° <strong id="filteredCount">0</strong> ç­†çµæœ</span>
            <div class="sort-options">
                <button class="sort-btn active" data-sort="date" onclick="setSort('date')">æœ€æ–°</button>
                <button class="sort-btn" data-sort="importance" onclick="setSort('importance')">é‡è¦æ€§</button>
            </div>
        </div>
        <div class="reports-list" id="reportsList"></div>
    </div>
    
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-header-info" id="modalHeaderInfo"></div>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

<script>
// ===== æª”æ¡ˆè·¯å¾‘å®šç¾© =====
const NEWS_FILE = '01_news.xlsx';
const MEMO_FILE = '02_memo.xlsx';
const REPORTS_FILE = '03_reports.xlsx';
const MASTER_FILE = '04_master.xlsx';
const STRATEGY_FILE = '05_Strategy.xlsx';
const CB_FILE = '00_CB.xlsx';
const REVENUE_FILE = '06_revenue.xlsx';

// ===== å…¨åŸŸè³‡æ–™è®Šæ•¸ =====
let newsData = [], newsContent = {}, trendsData = [];
let cbData = {}; // è‚¡ç¥¨ä»£è™Ÿ -> [CBè³‡è¨Šé™£åˆ—]
let cbIndustry = {}; // è‚¡ç¥¨ä»£è™Ÿ -> ç”¢æ¥­åˆ†é¡
let cbList = []; // æ‰€æœ‰CBåˆ—è¡¨
let cbPriceRange = {}; // CBä»£è™Ÿ -> {high, low}
let revenueData = {}; // è‚¡ç¥¨ä»£è™Ÿ -> {è‚¡æœ¬, å¸‚å€¼, ç‡Ÿæ”¶å¹´å¢, 1å¹´é«˜ä½, ç”¢æ¥­åœ°ä½}
let memoReports = [], memoTracking = {}, memoFinance = {}, memoProducts = {}, memoTimeline = [], memoIndustryTrends = [], memoDetails = {}, memoAnalysts = [];
let reportsData = [], reportDetails = {}, reportStocksData = {}, reportConclusions = {};
let masterStocks = {}, conceptStocks = [];
let strategyReports = [], strategyMacro = {}, strategyFundamental = {}, strategyThemes = {}, strategyChips = {}, strategyTechnical = {}, strategyQuarters = {}, strategyPicks = {};
let currentDB = 'news', currentSort = 'date';
let activeFilters = { search: '', broker: '', category: '', importance: '', industry: '', tag: '', market: '' };
let searchIndex = { companies: {}, tags: {}, brokers: {}, stocks: {}, industries: {} };

// ===== å·¥å…·å‡½æ•¸ =====
async function fetchFile(url) {
    const response = await fetch(url);
    if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥ ' + url);
    return await response.arrayBuffer();
}

function updateLoadingStatus(msg, detail = '', progress = 0) {
    document.getElementById('loadingStatus').textContent = msg;
    document.getElementById('loadingDetail').textContent = detail;
    document.getElementById('loadingProgressBar').style.width = progress + '%';
}

function formatDate(v) {
    if (!v) return '';
    if (typeof v === 'string') return v;
    if (typeof v === 'number') {
        const d = new Date((v - 25569) * 86400 * 1000);
        return d.toLocaleDateString('zh-TW');
    }
    return String(v);
}

function safeStr(v) { return (v === null || v === undefined) ? '' : String(v).trim(); }

function formatContent(text, forceSimple = false) {
    if (!text) return '';
    if (forceSimple) return text.replace(/;/g, 'ï¼›').replace(/â€¢/g, '<br>â€¢ ');
    
    const segments = text.split(';').filter(s => s.trim());
    if (segments.length <= 1) return text.replace(/â€¢/g, '<br>â€¢ ');
    
    let html = '';
    segments.forEach(seg => {
        seg = seg.trim();
        if (!seg) return;
        const colonMatch = seg.match(/^([^:ï¼š]{2,20})[:ï¼š](.+)$/);
        if (colonMatch) {
            const title = colonMatch[1].trim();
            const body = colonMatch[2].trim();
            let icon = 'ğŸ“Œ', color = '#c96442';
            if (title.includes('å±•æœ›') || title.includes('é æœŸ')) { icon = 'ğŸ”®'; color = '#9b59b6'; }
            else if (title.includes('é¢¨éšª') || title.includes('æŒ‘æˆ°')) { icon = 'âš ï¸'; color = '#e74c3c'; }
            else if (title.includes('æˆé•·') || title.includes('ç‡Ÿæ”¶') || title.includes('ç²åˆ©')) { icon = 'ğŸ“ˆ'; color = '#27ae60'; }
            else if (title.includes('ç”¢å“') || title.includes('çµ„åˆ')) { icon = 'ğŸ“¦'; color = '#3498db'; }
            else if (title.includes('AI') || title.includes('ä¼ºæœå™¨')) { icon = 'ğŸ¤–'; color = '#8e44ad'; }
            else if (title.includes('EV') || title.includes('é›»å‹•è»Š')) { icon = 'ğŸš—'; color = '#16a085'; }
            else if (title.includes('åŠå°é«”') || title.includes('æ™¶ç‰‡')) { icon = 'ğŸ’'; color = '#2980b9'; }
            else if (title.includes('å¸ƒå±€') || title.includes('ç”¢èƒ½')) { icon = 'ğŸ­'; color = '#7f8c8d'; }
            
            html += '<div style="margin-bottom:12px;padding:12px 14px;background:linear-gradient(135deg,#fff,#fafaf8);border-radius:10px;border-left:4px solid ' + color + ';box-shadow:0 1px 3px rgba(0,0,0,0.05);">';
            html += '<div style="font-weight:600;color:' + color + ';margin-bottom:8px;font-size:16px;">' + icon + ' ' + title + '</div>';
            html += '<div style="font-size:15px;line-height:1.8;color:#444;">' + body + '</div>';
            html += '</div>';
        } else {
            html += '<div style="margin-bottom:10px;padding:10px 12px;background:#fafaf8;border-radius:8px;font-size:15px;line-height:1.8;color:#444;">' + seg + '</div>';
        }
    });
    return html;
}

function parseTags(tagStr) {
    if (!tagStr) return [];
    return tagStr.split('#').filter(t => t.trim()).map(t => t.trim());
}

function excelDateToStr(val) {
    if (!val) return '';
    if (!isNaN(val) && typeof val === 'number') {
        const utc_days = Math.floor(val - 25569);
        const date = new Date(utc_days * 86400 * 1000);
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}/${m}/${d}`;
    }
    const str = String(val);
    const match = str.match(/(\d{4})-(\d{2})-(\d{2})/);
    if (match) return `${match[1]}/${match[2]}/${match[3]}`;
    return str;
}

// ===== è³‡æ–™è¼‰å…¥å‡½æ•¸ =====
async function loadCBData() {
    try {
        const data = await fetchFile(CB_FILE);
        const wb = XLSX.read(data, { type: 'array' });
        
        const ws00 = wb.Sheets['00_CBä»£è™Ÿåç¨±éæ¿¾åŠæ›ç‰Œé«˜ä½_20251031'];
        if (ws00) {
            XLSX.utils.sheet_to_json(ws00).forEach(r => {
                if (!r['ä»£è™Ÿ']) return;
                const cbCode = String(r['ä»£è™Ÿ']).trim();
                const high = parseFloat(r['æ›ç‰Œæœ€é«˜']) || 0;
                const low = parseFloat(r['æ›ç‰Œæœ€ä½']) || 0;
                cbPriceRange[cbCode] = {
                    high: high,
                    low: low,
                    range: high > 0 && low > 0 ? ((high - low) / low * 100).toFixed(1) : '0'
                };
            });
        }
        
        const ws16 = wb.Sheets['16_ç”¢æ¥­åˆ†é¡'];
        if (ws16) {
            XLSX.utils.sheet_to_json(ws16).forEach(r => {
                if (!r['è‚¡ç¥¨ä»£è™Ÿ']) return;
                const code = String(r['è‚¡ç¥¨ä»£è™Ÿ']);
                cbIndustry[code] = {
                    industry: r['ç”¢æ¥­åˆ†é¡'] || 'å…¶ä»–',
                    subIndustry: r['ç´°åˆ†ç”¢æ¥­'] || '',
                    position: r['ç”¢æ¥­åœ°ä½èªªæ˜'] || '',
                    market: r['å¸‚å ´åˆ†é¡'] || '',
                    name: r['å…¬å¸åç¨±'] || ''
                };
            });
        }
        
        const ws = wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™'];
        if (ws) {
            XLSX.utils.sheet_to_json(ws).forEach(r => {
                if (!r['è½‰æ›æ¨™çš„ä»£ç¢¼']) return;
                const stockCode = String(r['è½‰æ›æ¨™çš„ä»£ç¢¼']).trim();
                const stockName = String(r['è½‰æ›æ¨™çš„åç¨±'] || '');
                const ind = cbIndustry[stockCode] || {};
                
                const issueAmt = parseFloat(r['å¯¦éš›ç™¼è¡Œç¸½é¡(ç™¾è¬)']) || 0;
                const remainAmt = parseFloat(r['æœ€æ–°é¤˜é¡(ç™¾è¬)']) || 0;
                const remainPct = issueAmt > 0 ? ((remainAmt / issueAmt) * 100).toFixed(1) : '0';
                const convPrice = parseFloat(r['è½‰æ›åƒ¹æ ¼(å…ƒ)']) || 0;
                
                const cbInfo = {
                    cbCode: String(r['ä»£è™Ÿ']),
                    cbName: String(r['åç¨±'] || ''),
                    stockCode: stockCode,
                    stockName: stockName,
                    conversionPrice: convPrice,
                    maturityDate: excelDateToStr(r['åˆ°æœŸæ—¥']),
                    issueDate: excelDateToStr(r['ç™¼è¡Œæ—¥æœŸ']),
                    issueAmount: issueAmt,
                    remainAmount: remainAmt,
                    remainPct: remainPct,
                    industry: ind.industry || 'å…¶ä»–',
                    market: ind.market || ''
                };
                
                const codeKey = stockCode.replace(/\s/g, '');
                if (!cbData[codeKey]) cbData[codeKey] = [];
                cbData[codeKey].push(cbInfo);
                cbList.push(cbInfo);
            });
        }
    } catch (e) { console.warn('CBè³‡æ–™è¼‰å…¥å¤±æ•—:', e); }
}

async function loadRevenueData() {
    try {
        const data = await fetchFile(REVENUE_FILE);
        const wb = XLSX.read(data, { type: 'array' });
        
        const ws12 = wb.Sheets['12_å…¬å¸åŸºæœ¬è³‡æ–™'];
        if (ws12) {
            XLSX.utils.sheet_to_json(ws12).forEach(r => {
                if (!r['ä»£è™Ÿ']) return;
                const code = String(r['ä»£è™Ÿ']).trim();
                revenueData[code] = { monthly: [], quarterly: [], yearly: [], highlights: {}, priceHistory: {} };
            });
        }
        
        const ws10 = wb.Sheets['10_è²¡å ±å‚™è¨»'];
        if (ws10) {
            XLSX.utils.sheet_to_json(ws10).forEach(r => {
                if (!r['ä»£è™Ÿ']) return;
                const code = String(r['ä»£è™Ÿ']).trim();
                if (revenueData[code]) {
                    revenueData[code].highlights = {
                        monthRank: r['å–®æœˆç‡Ÿæ”¶æ­·æœˆæ’å'] || '',
                        monthRecord: r['å–®æœˆç‡Ÿæ”¶å‰µç´€éŒ„æœˆæ•¸'] || '',
                        monthStreak: r['å–®æœˆç‡Ÿæ”¶é€£å¢æ¸›æœˆæ•¸'] || '',
                        yearRank: r['å–®æœˆç‡Ÿæ”¶æ­·å¹´æ’å'] || '',
                        yearRecord: r['å–®æœˆç‡Ÿæ”¶å‰µç´€éŒ„å¹´æ•¸'] || '',
                        cumStreak: r['ç´¯æœˆç‡Ÿæ”¶é€£å¢æ¸›å¹´æ•¸'] || '',
                        qtrStreak: r['å–®å­£ç‡Ÿæ”¶é€£çºŒå¢æ¸›å­£æ•¸'] || '',
                        profitStreak: r['å–®å­£æ·¨åˆ©é€£çºŒæç›Šå­£æ•¸'] || ''
                    };
                }
            });
        }
        
        // ç‡Ÿæ”¶è³‡æ–™è®€å–ç°¡åŒ– (ä¾æ“šå¯¦éš›Excelçµæ§‹å¯èƒ½éœ€å¾®èª¿)
        const processRevenueSheet = (sheetName, targetKey, colPattern, stripStr) => {
            const ws = wb.Sheets[sheetName];
            if (ws) {
                const rows = XLSX.utils.sheet_to_json(ws);
                const headers = Object.keys(rows[0] || {});
                const cols = headers.filter(h => h.includes(colPattern)).slice(-12);
                rows.forEach(r => {
                    if (!r['ä»£è™Ÿ']) return;
                    const code = String(r['ä»£è™Ÿ']).trim();
                    if (revenueData[code]) {
                        revenueData[code][targetKey] = cols.map(col => ({
                            period: col.replace(stripStr, ''),
                            value: r[col] || ''
                        }));
                    }
                });
            }
        };

        processRevenueSheet('000_æœˆç‡Ÿæ”¶', 'monthly', 'å–®æœˆç‡Ÿæ”¶', 'å–®æœˆç‡Ÿæ”¶(å„„)');
        processRevenueSheet('000_å­£ç‡Ÿæ”¶', 'quarterly', 'å–®å­£ç‡Ÿæ”¶', 'å–®å­£ç‡Ÿæ”¶(å„„)');
        processRevenueSheet('000_å¹´ç‡Ÿæ”¶', 'yearly', 'å¹´åº¦ç‡Ÿæ”¶', 'å¹´åº¦ç‡Ÿæ”¶(å„„)');
        processRevenueSheet('000_æœˆç´¯ç‡Ÿæ”¶å¹´å¢', 'yoyTrend', 'ç´¯æœˆç‡Ÿæ”¶å¹´å¢', 'ç´¯æœˆç‡Ÿæ”¶å¹´å¢(%)');
        
        const ws13 = wb.Sheets['13_æ­·å²é«˜ä½'];
        if (ws13) {
            XLSX.utils.sheet_to_json(ws13).forEach(r => {
                if (!r['ä»£è™Ÿ']) return;
                const code = String(r['ä»£è™Ÿ']).trim();
                if (revenueData[code]) {
                    revenueData[code].priceHistory = {
                        y1Low: r['1å¹´æœ€ä½è‚¡åƒ¹'] || '', y1High: r['1å¹´æœ€é«˜è‚¡åƒ¹'] || '',
                        y3Low: r['3å¹´æœ€ä½è‚¡åƒ¹'] || '', y3High: r['3å¹´æœ€é«˜è‚¡åƒ¹'] || '',
                        y5Low: r['5å¹´æœ€ä½è‚¡åƒ¹'] || '', y5High: r['5å¹´æœ€é«˜è‚¡åƒ¹'] || '',
                        y10Low: r['10å¹´æœ€ä½è‚¡åƒ¹'] || '', y10High: r['10å¹´æœ€é«˜è‚¡åƒ¹'] || ''
                    };
                }
            });
        }
        
        const ws19 = wb.Sheets['19_å¹´æœˆå‘¨æ¼²è·Œå¹…'];
        if (ws19) {
            const rows = XLSX.utils.sheet_to_json(ws19);
            const headers = Object.keys(rows[0] || {});
            const pctCols = headers.filter(h => h.includes('æ¼²è·Œå¹…') && !h.includes('æœˆ') && !h.includes('å‘¨')).slice(-10);
            rows.forEach(r => {
                if (!r['ä»£è™Ÿ']) return;
                const code = String(r['ä»£è™Ÿ']).trim();
                if (revenueData[code]) {
                    revenueData[code].yearPct = pctCols.map(col => ({
                        period: col.replace('æ¼²è·Œå¹…', ''),
                        value: r[col] || ''
                    }));
                }
            });
        }
        
        const wsPos = wb.Sheets['ä¸Šå¸‚æ«ƒç”¢æ¥­åœ°ä½'];
        if (wsPos) {
            XLSX.utils.sheet_to_json(wsPos).forEach(r => {
                if (!r['ä»£ç¢¼']) return;
                const code = String(r['ä»£ç¢¼']).trim();
                if (revenueData[code]) revenueData[code].position = r['ç”¢æ¥­åœ°ä½'] || '';
            });
        }
        
    } catch (e) { console.warn('ç‡Ÿæ”¶è³‡æ–™è¼‰å…¥å¤±æ•—:', e); }
}

async function loadNewsData() {
    try {
        const ab = await fetchFile(NEWS_FILE);
        const wb = XLSX.read(ab, { type: 'array' });
        const ws = wb.Sheets['å¤–é›»ç¶œåˆå ±å°'];
        if (ws) {
            XLSX.utils.sheet_to_json(ws).forEach(r => {
                if (!r['ç·¨è™Ÿ']) return;
                const dataType = safeStr(r['è³‡æ–™é¡å‹']);
                const id = safeStr(r['ç·¨è™Ÿ']);
                
                if (dataType === 'å€‹è‚¡å ±å°') {
                    newsData.push({
                        id: id, date: safeStr(r['æ—¥æœŸ']), company: safeStr(r['å…¬å¸']),
                        stockCode: safeStr(r['è‚¡è™Ÿ']), broker: safeStr(r['åˆ¸å•†ä¾†æº']),
                        category: safeStr(r['å ±å°é‡é»åˆ†é¡']), importance: safeStr(r['é‡è¦æ€§']),
                        tags: safeStr(r['æ¨™ç±¤'])
                    });
                    newsContent[id] = safeStr(r['å®Œæ•´å ±å°å…§å®¹']);
                } else if (dataType === 'ç”¢æ¥­è¶¨å‹¢') {
                    trendsData.push({
                        id: id, date: safeStr(r['æ—¥æœŸ']), topic: safeStr(r['å…¬å¸']),
                        broker: safeStr(r['åˆ¸å•†ä¾†æº']), content: safeStr(r['å®Œæ•´å ±å°å…§å®¹']),
                        companies: safeStr(r['è‚¡è™Ÿ']), tags: safeStr(r['æ¨™ç±¤']),
                        importance: safeStr(r['é‡è¦æ€§'])
                    });
                }
            });
        }
    } catch (e) { console.warn('å¤–é›»è¼‰å…¥å¤±æ•—:', e); }
}

async function loadMemoData() {
    try {
        const ab = await fetchFile(MEMO_FILE);
        const wb = XLSX.read(ab, { type: 'array' });
        
        const processSheet = (name, cb) => {
            const ws = wb.Sheets[name];
            if (ws) XLSX.utils.sheet_to_json(ws).forEach(cb);
        };

        processSheet('å ±å‘Šç¸½è¡¨', r => {
            if (!r['ç·¨è™Ÿ']) return;
            memoReports.push({
                id: safeStr(r['ç·¨è™Ÿ']), date: safeStr(r['æ—¥æœŸ']), company: safeStr(r['å…¬å¸']),
                stockCode: safeStr(r['è‚¡è™Ÿ']), broker: safeStr(r['åˆ¸å•†']), analyst: safeStr(r['åˆ†æå¸«']),
                type: safeStr(r['å ±å‘Šé¡å‹']), importance: safeStr(r['é‡è¦æ€§']), industry: safeStr(r['ç”¢æ¥­']),
                revenueYoY: safeStr(r['ç‡Ÿæ”¶YoY']), grossMargin: safeStr(r['æ¯›åˆ©ç‡']), eps: safeStr(r['EPS'])
            });
        });

        processSheet('è©³ç´°å…§å®¹åº«', r => {
            if (!r['ç·¨è™Ÿ']) return;
            memoDetails[safeStr(r['ç·¨è™Ÿ'])] = {
                operation: safeStr(r['ç‡Ÿé‹é‡é»']), strategy: safeStr(r['ç­–ç•¥æ–¹å‘']),
                qa: safeStr(r['é‡è¦QAæ‘˜è¦']), rexView: safeStr(r['Rexè§€å¯Ÿ']),
                followUp: safeStr(r['å¾ŒçºŒè¿½è¹¤']), timeline: safeStr(r['é—œéµæ™‚ç¨‹']), tags: safeStr(r['æ¨™ç±¤'])
            };
        });

        processSheet('å…¬å¸è¿½è¹¤è¡¨', r => {
            if (!r['ç·¨è™Ÿ']) return;
            memoTracking[safeStr(r['ç·¨è™Ÿ'])] = {
                rating: safeStr(r['æŠ•è³‡è©•ç­‰']), targetPrice: safeStr(r['ç›®æ¨™åƒ¹']), trackStatus: safeStr(r['è¿½è¹¤ç‹€æ…‹'])
            };
        });

        processSheet('è²¡å‹™æ•¸æ“šå½™ç¸½', r => {
            if (!r['ç·¨è™Ÿ']) return;
            memoFinance[safeStr(r['ç·¨è™Ÿ'])] = {
                revenue3Q: safeStr(r['3Q25ç‡Ÿæ”¶']), revenueYoY: safeStr(r['ç‡Ÿæ”¶YoY']), revenueQoQ: safeStr(r['ç‡Ÿæ”¶QoQ']),
                grossMargin: safeStr(r['æ¯›åˆ©ç‡']), grossMarginYoY: safeStr(r['æ¯›åˆ©ç‡YoY']),
                netIncome: safeStr(r['ç¨…å¾Œæ·¨åˆ©']), netIncomeYoY: safeStr(r['æ·¨åˆ©YoY']),
                eps: safeStr(r['EPS']), guidance4Q: safeStr(r['4Q25æŒ‡å¼•'])
            };
        });

        processSheet('ç”¢å“çµæ§‹åˆ†æ', r => {
            if (!r['ç·¨è™Ÿ']) return;
            memoProducts[safeStr(r['ç·¨è™Ÿ'])] = {
                products: [
                    { name: safeStr(r['ä¸»è¦ç”¢å“1']), ratio: safeStr(r['ä½”æ¯”/è¡¨ç¾1']) },
                    { name: safeStr(r['ä¸»è¦ç”¢å“2']), ratio: safeStr(r['ä½”æ¯”/è¡¨ç¾2']) },
                    { name: safeStr(r['ä¸»è¦ç”¢å“3']), ratio: safeStr(r['ä½”æ¯”/è¡¨ç¾3']) }
                ].filter(p => p.name),
                driver: safeStr(r['é—œéµæˆé•·å‹•èƒ½']), outlook2026: safeStr(r['2026å±•æœ›'])
            };
        });

        processSheet('ç”¢æ¥­è¶¨å‹¢ç¸½è¦½', r => {
            if (!r['ç”¢æ¥­']) return;
            memoIndustryTrends.push({
                industry: safeStr(r['ç”¢æ¥­']), trend: safeStr(r['è¶¨å‹¢åˆ¤æ–·']), cycle: safeStr(r['æ™¯æ°£ä½ç½®']),
                companies: safeStr(r['ä»£è¡¨å…¬å¸']), drivers: safeStr(r['é—œéµé©…å‹•å› ç´ ']),
                risks: safeStr(r['é¢¨éšªå› ç´ ']), outlook2026: safeStr(r['2026å±•æœ›']), suggestion: safeStr(r['æŠ•è³‡å»ºè­°'])
            });
        });
        
    } catch (e) { console.warn('Memoè¼‰å…¥å¤±æ•—:', e); }
}

async function loadReportsData() {
    try {
        const ab = await fetchFile(REPORTS_FILE);
        const wb = XLSX.read(ab, { type: 'array' });
        
        const ws1 = wb.Sheets['å ±å‘Šç¸½è¦½'];
        if (ws1) {
            XLSX.utils.sheet_to_json(ws1).forEach(r => {
                if (!r['å ±å‘Šç·¨è™Ÿ']) return;
                const rp = {
                    id: safeStr(r['å ±å‘Šç·¨è™Ÿ']), broker: safeStr(r['åˆ¸å•†åç¨±']), date: formatDate(r['å ±å‘Šæ—¥æœŸ']),
                    industry: safeStr(r['ç”¢æ¥­åç¨±']), title: safeStr(r['å ±å‘Šæ¨™é¡Œ']), subtitle: safeStr(r['å‰¯æ¨™é¡Œ']),
                    rating: safeStr(r['ç”¢æ¥­è©•ç­‰']), highlights: []
                };
                for (let i = 1; i <= 5; i++) if (r['æ ¸å¿ƒé‡é»' + i]) rp.highlights.push(safeStr(r['æ ¸å¿ƒé‡é»' + i]));
                reportsData.push(rp);
            });
        }
        
        const ws2 = wb.Sheets['ç„¦é»åˆ†æå…§å®¹'];
        if (ws2) {
            XLSX.utils.sheet_to_json(ws2).forEach(r => {
                if (!r['å ±å‘Šç·¨è™Ÿ']) return;
                const id = safeStr(r['å ±å‘Šç·¨è™Ÿ']);
                if (!reportDetails[id]) reportDetails[id] = [];
                reportDetails[id].push({
                    sectionTitle: safeStr(r['æ®µè½æ¨™é¡Œ']), content: safeStr(r['æ®µè½å…§å®¹']),
                    marketSize: safeStr(r['å¸‚å ´è¦æ¨¡æ•¸æ“š']), growthRate: safeStr(r['æˆé•·ç‡æ•¸æ“š'])
                });
            });
        }
        
        const ws4 = wb.Sheets['é¦–é¸å€‹è‚¡è©•åƒ¹'];
        if (ws4) {
            XLSX.utils.sheet_to_json(ws4).forEach(r => {
                if (!r['å ±å‘Šç·¨è™Ÿ']) return;
                const id = safeStr(r['å ±å‘Šç·¨è™Ÿ']);
                if (!reportStocksData[id]) reportStocksData[id] = [];
                reportStocksData[id].push({
                    name: safeStr(r['å…¬å¸åç¨±']), code: safeStr(r['è‚¡ç¥¨ä»£è™Ÿ']),
                    target: r['ç›®æ¨™åƒ¹'], eps25: r['EPS_FY25F'], eps26: r['EPS_FY26F'], highlight: safeStr(r['æŠ•è³‡äº®é»'])
                });
            });
        }
    } catch (e) { console.warn('ç”¢æ¥­å ±å‘Šè¼‰å…¥å¤±æ•—:', e); }
}

async function loadMasterData() {
    try {
        const ab = await fetchFile(MASTER_FILE);
        const wb = XLSX.read(ab, { type: 'array' });
        
        const s1 = wb.Sheets['ä¸»è³‡æ–™åº«'];
        if (s1) {
            XLSX.utils.sheet_to_json(s1).forEach(r => {
                if (!r['ä»£è™Ÿ']) return;
                const code = safeStr(r['ä»£è™Ÿ']);
                const stockData = {
                    code: code, name: safeStr(r['å…¬å¸åç¨±']), market: safeStr(r['å¸‚å ´åˆ†é¡']),
                    industry: safeStr(r['ç”¢æ¥­åˆ†é¡']), subIndustry: safeStr(r['ç”¢æ¥­ç´°åˆ†']),
                    price: safeStr(r['æˆäº¤']), change: safeStr(r['æ¼²è·Œåƒ¹']), changePercent: safeStr(r['æ¼²è·Œå¹…']),
                    volume: safeStr(r['æˆäº¤å¼µæ•¸']), capital: safeStr(r['è‚¡æœ¬(å„„)']), marketCap: safeStr(r['å¸‚å€¼(å„„)']),
                    listedYears: safeStr(r['æ›ç‰Œå¹´æ•¸']), chairman: safeStr(r['è‘£äº‹é•·']), ceo: safeStr(r['ç¸½ç¶“ç†']),
                    position: safeStr(r['ç”¢æ¥­åœ°ä½']), business: safeStr(r['æ¥­å‹™æ‘˜è¦']), updateDate: safeStr(r['è³‡æ–™æ›´æ–°æ—¥æœŸ'])
                };
                masterStocks[code] = stockData;
                if (r['å…¬å¸åç¨±']) masterStocks[safeStr(r['å…¬å¸åç¨±'])] = stockData;
            });
        }
        
        const s2 = wb.Sheets['ğŸ’¡æ¦‚å¿µè‚¡æ—ç¾¤è³‡æ–™åº«'];
        if (s2) {
            const rows = XLSX.utils.sheet_to_json(s2, { header: 1 });
            for (let i = 3; i < rows.length; i++) {
                const rw = rows[i];
                if (!rw || !rw[0]) continue;
                conceptStocks.push({
                    code: safeStr(rw[0]), name: safeStr(rw[1]), concept: safeStr(rw[2]),
                    subRole: safeStr(rw[3]), description: safeStr(rw[4])
                });
            }
        }
    } catch (e) { console.warn('ä¸»è³‡æ–™åº«è¼‰å…¥å¤±æ•—:', e); }
}

async function loadStrategyData() {
    try {
        const ab = await fetchFile(STRATEGY_FILE);
        const wb = XLSX.read(ab, { type: 'array' });
        
        const s1 = wb.Sheets['å ±å‘Šç¸½è¦½'];
        if (s1) {
            XLSX.utils.sheet_to_json(s1).forEach(r => {
                if (!r['å ±å‘Šç·¨è™Ÿ']) return;
                strategyReports.push({
                    id: safeStr(r['å ±å‘Šç·¨è™Ÿ']), broker: safeStr(r['åˆ¸å•†åç¨±']), date: formatDate(r['å ±å‘Šæ—¥æœŸ']),
                    type: safeStr(r['å ±å‘Šé¡å‹']), title: safeStr(r['å ±å‘Šæ¨™é¡Œ']), subtitle: safeStr(r['å‰¯æ¨™é¡Œ']),
                    marketView: safeStr(r['å¤§ç›¤è§€é»']), indexLow: r['æŒ‡æ•¸é æ¸¬å€é–“_ä½'], indexHigh: r['æŒ‡æ•¸é æ¸¬å€é–“_é«˜'],
                    macroSummary: safeStr(r['ç¸½ç¶“è§€é»æ‘˜è¦'])
                });
            });
        }
        
        const s4 = wb.Sheets['é¡Œæèˆ‡è¶¨å‹¢'];
        if (s4) {
            XLSX.utils.sheet_to_json(s4).forEach(r => {
                if (!r['å ±å‘Šç·¨è™Ÿ']) return;
                const id = safeStr(r['å ±å‘Šç·¨è™Ÿ']);
                if (!strategyThemes[id]) strategyThemes[id] = [];
                strategyThemes[id].push({ topic: safeStr(r['é¡Œæä¸»é¡Œ']), content: safeStr(r['é¡Œæå…§å®¹']) });
            });
        }
        
        const s8 = wb.Sheets['é¸è‚¡ç­–ç•¥'];
        if (s8) {
            XLSX.utils.sheet_to_json(s8).forEach(r => {
                if (!r['å ±å‘Šç·¨è™Ÿ']) return;
                const id = safeStr(r['å ±å‘Šç·¨è™Ÿ']);
                if (!strategyPicks[id]) strategyPicks[id] = [];
                strategyPicks[id].push({
                    industry: safeStr(r['ç”¢æ¥­åˆ†é¡']), theme: safeStr(r['æŠ•è³‡é¡Œæ']),
                    stockCode: safeStr(r['è‚¡ç¥¨ä»£è™Ÿ']), stockName: safeStr(r['å…¬å¸åç¨±']),
                    q1: safeStr(r['26Q1']), q2: safeStr(r['26Q2'])
                });
            });
        }
    } catch (e) { console.warn('æŠ•è³‡ç­–ç•¥è¼‰å…¥å¤±æ•—:', e); }
}

// ===== ç´¢å¼•èˆ‡ç¯©é¸ =====
function buildSearchIndex() {
    searchIndex = { companies: {}, tags: {}, brokers: {}, stocks: {}, industries: {} };
    Object.values(masterStocks).forEach(s => {
        if (s.code && !searchIndex.stocks[s.code]) searchIndex.stocks[s.code] = { name: s.name, code: s.code, market: s.market, industry: s.industry };
    });
    newsData.forEach(item => {
        if (item.company) {
            if (!searchIndex.companies[item.company]) searchIndex.companies[item.company] = { count: 0, code: item.stockCode };
            searchIndex.companies[item.company].count++;
        }
        parseTags(item.tags).forEach(tag => {
            if (!searchIndex.tags[tag]) searchIndex.tags[tag] = 0;
            searchIndex.tags[tag]++;
        });
        if (item.broker) {
            if (!searchIndex.brokers[item.broker]) searchIndex.brokers[item.broker] = 0;
            searchIndex.brokers[item.broker]++;
        }
    });
    memoReports.forEach(item => {
        if (item.company) {
            if (!searchIndex.companies[item.company]) searchIndex.companies[item.company] = { count: 0, code: item.stockCode };
            searchIndex.companies[item.company].count++;
        }
        const detail = memoDetails[item.id];
        if (detail && detail.tags) {
            parseTags(detail.tags).forEach(tag => {
                if (!searchIndex.tags[tag]) searchIndex.tags[tag] = 0;
                searchIndex.tags[tag]++;
            });
        }
    });
}

function buildFilters() {
    const brokers = [...new Set([...newsData.map(n => n.broker), ...memoReports.map(m => m.broker), ...reportsData.map(r => r.broker), ...strategyReports.map(s => s.broker)])].filter(Boolean).sort();
    document.getElementById('brokerFilter').innerHTML = '<option value="">æ‰€æœ‰åˆ¸å•†</option>' + brokers.map(b => '<option value="' + b + '">' + b + '</option>').join('');
    
    const categories = [...new Set(newsData.map(n => n.category))].filter(Boolean).sort();
    document.getElementById('categoryFilter').innerHTML = '<option value="">æ‰€æœ‰åˆ†é¡</option>' + categories.map(c => '<option value="' + c + '">' + c + '</option>').join('');
    
    const industries = [...new Set([...reportsData.map(r => r.industry), ...memoReports.map(m => m.industry), ...Object.values(masterStocks).map(s => s.industry)])].filter(Boolean).sort();
    document.getElementById('industryFilter').innerHTML = '<option value="">æ‰€æœ‰ç”¢æ¥­</option>' + industries.map(i => '<option value="' + i + '">' + i + '</option>').join('');
    
    const markets = [...new Set(Object.values(masterStocks).map(s => s.market))].filter(Boolean).sort();
    document.getElementById('marketFilter').innerHTML = '<option value="">æ‰€æœ‰å¸‚å ´</option>' + markets.map(m => '<option value="' + m + '">' + m + '</option>').join('');
    
    ['brokerFilter', 'categoryFilter', 'importanceFilter', 'industryFilter', 'marketFilter'].forEach(id => {
        document.getElementById(id).onchange = applyFilters;
    });
}

function buildHotTags() {
    const topTags = Object.entries(searchIndex.tags).sort((a, b) => b[1] - a[1]).slice(0, 12);
    document.getElementById('hotTagsList').innerHTML = topTags.map(([tag]) => '<button class="hot-tag" onclick="searchByTag(\'' + tag + '\')">#' + tag + '</button>').join('');
}

function updateCounts() {
    document.getElementById('newsCount').textContent = newsData.length;
    document.getElementById('memoCount').textContent = memoReports.length;
    document.getElementById('reportsCount').textContent = reportsData.length;
    document.getElementById('strategyCount').textContent = strategyReports.length;
    document.getElementById('trendsCount').textContent = trendsData.length;
    document.getElementById('industryCount').textContent = memoIndustryTrends.length;
    document.getElementById('cbCount').textContent = cbList.length;
    document.getElementById('stocksCount').textContent = new Set(Object.values(masterStocks).map(s => s.code)).size;
}

// ===== æœå°‹èˆ‡äº’å‹• =====
function onSearchInput(e) {
    const q = e.target.value.trim().toLowerCase();
    if (q.length > 0) showSuggestions(q);
    else hideSuggestions();
    activeFilters.search = q;
    renderCurrentDB();
}

function showSuggestions(query = '') {
    const c = document.getElementById('searchSuggestions');
    if (!query) {
        c.innerHTML = '';
        return;
    }
    const mC = Object.entries(searchIndex.companies).filter(([n]) => n.toLowerCase().includes(query)).sort((a, b) => b[1].count - a[1].count).slice(0, 4);
    const mT = Object.entries(searchIndex.tags).filter(([t]) => t.toLowerCase().includes(query)).sort((a, b) => b[1] - a[1]).slice(0, 4);
    const mS = Object.entries(searchIndex.stocks).filter(([cd, d]) => cd.includes(query) || d.name.toLowerCase().includes(query)).slice(0, 4);
    
    let html = '';
    if (mS.length > 0) html += '<div class="suggestion-group"><div class="suggestion-group-title">ğŸ“Š å€‹è‚¡è³‡æ–™</div>' + mS.map(([cd, d]) => '<div class="suggestion-item" onclick="openStockModal(\'' + cd + '\')"><div class="suggestion-icon stock">ğŸ“ˆ</div><div class="suggestion-text"><div class="suggestion-main">' + d.name + '</div><div class="suggestion-sub">' + cd + ' | ' + d.market + '</div></div></div>').join('') + '</div>';
    if (mC.length > 0) html += '<div class="suggestion-group"><div class="suggestion-group-title">ğŸ” æœå°‹å ±å°</div>' + mC.map(([n, d]) => '<div class="suggestion-item" onclick="searchByCompany(\'' + n + '\')"><div class="suggestion-icon company">ğŸ¢</div><div class="suggestion-text"><div class="suggestion-main">' + n + '</div></div><span class="suggestion-count">' + d.count + 'ç­†</span></div>').join('') + '</div>';
    if (mT.length > 0) html += '<div class="suggestion-group"><div class="suggestion-group-title">ğŸ·ï¸ æ¨™ç±¤</div>' + mT.map(([t, cnt]) => '<div class="suggestion-item" onclick="searchByTag(\'' + t + '\')"><div class="suggestion-icon tag">ğŸ·ï¸</div><div class="suggestion-text"><div class="suggestion-main">#' + t + '</div></div><span class="suggestion-count">' + cnt + 'ç­†</span></div>').join('') + '</div>';
    
    if (html) { c.innerHTML = html; c.classList.add('active'); }
    else hideSuggestions();
}

function hideSuggestions() { document.getElementById('searchSuggestions').classList.remove('active'); }
function searchByCompany(company) { document.getElementById('mainSearchInput').value = company; activeFilters.search = company.toLowerCase(); hideSuggestions(); renderCurrentDB(); }
function searchByTag(tag) { document.getElementById('mainSearchInput').value = '#' + tag; activeFilters.search = ''; activeFilters.tag = tag; hideSuggestions(); updateActiveFiltersDisplay(); renderCurrentDB(); }

function switchDB(db) {
    currentDB = db;
    document.querySelectorAll('.db-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.db === db));
    document.getElementById('categoryFilterWrap').style.display = (db === 'news') ? 'block' : 'none';
    document.getElementById('importanceFilterWrap').style.display = ['news', 'memo'].includes(db) ? 'block' : 'none';
    document.getElementById('industryFilterWrap').style.display = ['reports', 'memo', 'industry', 'stocks'].includes(db) ? 'block' : 'none';
    document.getElementById('marketFilterWrap').style.display = (db === 'stocks') ? 'block' : 'none';
    renderCurrentDB();
}

function applyFilters() {
    activeFilters.broker = document.getElementById('brokerFilter').value;
    activeFilters.category = document.getElementById('categoryFilter').value;
    activeFilters.importance = document.getElementById('importanceFilter').value;
    activeFilters.industry = document.getElementById('industryFilter').value;
    activeFilters.market = document.getElementById('marketFilter').value;
    updateActiveFiltersDisplay();
    renderCurrentDB();
}

function updateActiveFiltersDisplay() {
    const c = document.getElementById('activeFilters');
    let html = '';
    if (activeFilters.tag) html += '<span class="active-filter">#' + activeFilters.tag + ' <span class="remove" onclick="removeFilter(\'tag\')">âœ•</span></span>';
    if (activeFilters.broker) html += '<span class="active-filter">' + activeFilters.broker + ' <span class="remove" onclick="removeFilter(\'broker\')">âœ•</span></span>';
    if (activeFilters.industry) html += '<span class="active-filter">' + activeFilters.industry + ' <span class="remove" onclick="removeFilter(\'industry\')">âœ•</span></span>';
    c.innerHTML = html;
}

function removeFilter(type) {
    activeFilters[type] = '';
    const fm = { broker: 'brokerFilter', category: 'categoryFilter', importance: 'importanceFilter', industry: 'industryFilter', market: 'marketFilter' };
    if (fm[type]) document.getElementById(fm[type]).value = '';
    if (type === 'tag') document.getElementById('mainSearchInput').value = '';
    updateActiveFiltersDisplay();
    renderCurrentDB();
}

function clearAllFilters() {
    activeFilters = { search: '', broker: '', category: '', importance: '', industry: '', tag: '', market: '' };
    ['mainSearchInput', 'brokerFilter', 'categoryFilter', 'importanceFilter', 'industryFilter', 'marketFilter'].forEach(id => document.getElementById(id).value = '');
    updateActiveFiltersDisplay();
    renderCurrentDB();
}

function setSort(sort) {
    currentSort = sort;
    document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.sort === sort));
    renderCurrentDB();
}

function renderCurrentDB() {
    const renderers = { news: renderNews, memo: renderMemo, reports: renderReports, strategy: renderStrategy, trends: renderTrends, industry: renderIndustry, stocks: renderStocks, cb: renderCB };
    if (renderers[currentDB]) renderers[currentDB]();
}

// ===== æ¸²æŸ“å‡½æ•¸ =====
function renderNews() {
    let filtered = newsData.filter(item => {
        if (activeFilters.search) {
            const st = [item.company, item.stockCode, item.broker, item.category, item.tags, newsContent[item.id] || ''].join(' ').toLowerCase();
            if (!st.includes(activeFilters.search)) return false;
        }
        if (activeFilters.tag && !item.tags.includes(activeFilters.tag)) return false;
        if (activeFilters.broker && item.broker !== activeFilters.broker) return false;
        if (activeFilters.category && item.category !== activeFilters.category) return false;
        if (activeFilters.importance && item.importance !== activeFilters.importance) return false;
        return true;
    });
    
    if (currentSort === 'importance') filtered.sort((a, b) => (b.importance?.length || 0) - (a.importance?.length || 0));
    else filtered.sort((a, b) => String(b.date).localeCompare(String(a.date)));
    
    document.getElementById('filteredCount').textContent = filtered.length;
    const list = document.getElementById('reportsList');
    
    if (filtered.length === 0) { list.innerHTML = '<div class="empty-state"><p>ğŸ” æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å ±å°</p></div>'; return; }
    
    list.innerHTML = filtered.map(item => {
        const content = newsContent[item.id] || '';
        const preview = content.replace(/â€¢/g, '').substring(0, 120);
        const tags = parseTags(item.tags).slice(0, 4);
        return `<div class="card-base" onclick="openNewsModal('${item.id}')">
            <div class="card-header"><div class="card-left"><span class="company-name company-link" onclick="event.stopPropagation();openStockModal('${item.stockCode}')">${item.company}</span>${item.stockCode && item.stockCode !== '-' ? `<span class="stock-code" onclick="event.stopPropagation();openStockModal('${item.stockCode}')">${item.stockCode}</span>` : ''}</div><span class="importance">${item.importance}</span></div>
            <div class="card-meta"><span class="meta-tag broker">${item.broker}</span><span class="meta-tag category">${item.category}</span><span class="meta-tag date">${item.date}</span></div>
            <div class="card-content">${preview}...</div>
            <div class="card-tags">${tags.map(t => `<span class="mini-tag" onclick="event.stopPropagation();searchByTag('${t}')">#${t}</span>`).join('')}</div>
        </div>`;
    }).join('');
}

function renderMemo() {
    let filtered = memoReports.filter(item => {
        const detail = memoDetails[item.id] || {};
        if (activeFilters.search) {
            const st = [item.company, item.stockCode, item.broker, item.analyst, item.industry, detail.operation || '', detail.strategy || '', detail.tags || ''].join(' ').toLowerCase();
            if (!st.includes(activeFilters.search)) return false;
        }
        if (activeFilters.tag && !(detail.tags || '').includes(activeFilters.tag)) return false;
        if (activeFilters.broker && item.broker !== activeFilters.broker) return false;
        if (activeFilters.importance && item.importance !== activeFilters.importance) return false;
        if (activeFilters.industry && item.industry !== activeFilters.industry) return false;
        return true;
    });
    
    if (currentSort === 'importance') filtered.sort((a, b) => (b.importance?.length || 0) - (a.importance?.length || 0));
    else filtered.sort((a, b) => String(b.date).localeCompare(String(a.date)));
    
    document.getElementById('filteredCount').textContent = filtered.length;
    const list = document.getElementById('reportsList');
    
    if (filtered.length === 0) { list.innerHTML = '<div class="empty-state"><p>ğŸ” æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å ±å‘Š</p></div>'; return; }
    
    list.innerHTML = filtered.map(item => {
        const detail = memoDetails[item.id] || {};
        const tracking = memoTracking[item.id] || {}; // æ³¨æ„ï¼šé€™è£¡æ”¹ç”¨ id å°æ‡‰
        const preview = (detail.operation || '').substring(0, 100);
        const tags = parseTags(detail.tags).slice(0, 4);
        return `<div class="card-base" onclick="openMemoModal('${item.id}')">
            <div class="card-header"><div class="card-left"><span class="company-name company-link" onclick="event.stopPropagation();openStockModal('${item.stockCode}')">${item.company}</span><span class="stock-code" onclick="event.stopPropagation();openStockModal('${item.stockCode}')">${item.stockCode}</span></div><span class="importance">${item.importance}</span></div>
            <div class="card-meta"><span class="meta-tag broker">${item.broker}</span><span class="meta-tag industry">${item.industry}</span><span class="meta-tag date">${item.date}</span>${tracking.trackStatus ? `<span class="meta-tag trend">${tracking.trackStatus}</span>` : ''}</div>
            <div class="card-content">${preview}...</div>
            <div class="card-data"><div class="data-item"><span class="data-label">ç‡Ÿæ”¶YoY </span><span class="data-value ${item.revenueYoY.includes('+') ? 'positive' : ''}">${item.revenueYoY}</span></div><div class="data-item"><span class="data-label">æ¯›åˆ©ç‡ </span><span class="data-value">${item.grossMargin}</span></div><div class="data-item"><span class="data-label">EPS </span><span class="data-value">${item.eps}</span></div>${tracking.targetPrice ? `<div class="data-item"><span class="data-label">ç›®æ¨™åƒ¹ </span><span class="data-value positive">${tracking.targetPrice}</span></div>` : ''}</div>
            <div class="card-tags" style="margin-top:8px;">${tags.map(t => `<span class="mini-tag" onclick="event.stopPropagation();searchByTag('${t}')">#${t}</span>`).join('')}</div>
        </div>`;
    }).join('');
}

function renderReports() {
    let filtered = reportsData.filter(report => {
        if (activeFilters.search) {
            const st = [report.title, report.subtitle, report.broker, report.industry, report.highlights.join(' ')].join(' ').toLowerCase();
            if (!st.includes(activeFilters.search)) return false;
        }
        if (activeFilters.broker && report.broker !== activeFilters.broker) return false;
        if (activeFilters.industry && report.industry !== activeFilters.industry) return false;
        return true;
    });
    
    filtered.sort((a, b) => String(b.date).localeCompare(String(a.date)));
    document.getElementById('filteredCount').textContent = filtered.length;
    const list = document.getElementById('reportsList');
    
    if (filtered.length === 0) { list.innerHTML = '<div class="empty-state"><p>ğŸ” æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å ±å‘Š</p></div>'; return; }
    
    list.innerHTML = filtered.map(report => {
        const stocks = reportStocksData[report.id] || [];
        return `<div class="card-base" onclick="openReportModal('${report.id}')">
            <div class="card-meta"><span class="meta-tag broker">${report.broker}</span><span class="meta-tag industry">${report.industry}</span><span class="meta-tag date">${report.date}</span></div>
            <div class="company-name" style="margin:8px 0 4px;font-size:16px;">${report.title}</div>
            ${report.subtitle ? `<div style="font-size:15px;color:#6b6b6b;margin-bottom:8px;">${report.subtitle}</div>` : ''}
            <div class="card-content">${report.highlights.slice(0, 2).join(' / ')}</div>
            ${stocks.length > 0 ? `<div class="card-tags" style="margin-top:8px;">${stocks.slice(0, 5).map(s => `<span class="mini-tag" onclick="event.stopPropagation();openStockModal('${s.code}')">${s.name}</span>`).join('')}</div>` : ''}
        </div>`;
    }).join('');
}

function renderStrategy() {
    let filtered = strategyReports.filter(report => {
        if (activeFilters.search) {
            const st = [report.title, report.subtitle, report.broker, report.macroSummary, report.marketView].join(' ').toLowerCase();
            if (!st.includes(activeFilters.search)) return false;
        }
        if (activeFilters.broker && report.broker !== activeFilters.broker) return false;
        return true;
    });
    
    filtered.sort((a, b) => String(b.date).localeCompare(String(a.date)));
    document.getElementById('filteredCount').textContent = filtered.length;
    const list = document.getElementById('reportsList');
    
    if (filtered.length === 0) { list.innerHTML = '<div class="empty-state"><p>ğŸ” æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç­–ç•¥å ±å‘Š</p></div>'; return; }
    
    list.innerHTML = filtered.map(report => {
        const picks = strategyPicks[report.id] || [];
        return `<div class="card-base strategy-card" onclick="openStrategyModal('${report.id}')">
            <span class="strategy-badge">ğŸ¯ ${report.type}</span>
            <div class="card-meta"><span class="meta-tag broker">${report.broker}</span><span class="meta-tag date">${report.date}</span></div>
            <div class="company-name" style="margin:8px 0 4px;font-size:16px;">${report.title}</div>
            ${report.subtitle ? `<div style="font-size:15px;color:#6b6b6b;margin-bottom:8px;">${report.subtitle}</div>` : ''}
            <div class="card-content">${(report.marketView || report.macroSummary || '').substring(0, 100)}...</div>
            ${picks.length > 0 ? `<div style="margin-top:10px;padding-top:8px;border-top:1px solid #f0eeea;"><div style="font-size:13px;color:#8b8b8b;margin-bottom:5px;">ğŸ“ˆ é¸è‚¡ç­–ç•¥ (${picks.length}æª”)</div><div class="card-tags">${picks.slice(0, 6).map(p => `<span class="mini-tag" onclick="event.stopPropagation();openStockModal('${p.stockCode}')">${p.stockName}</span>`).join('')}</div></div>` : ''}
        </div>`;
    }).join('');
}

function renderTrends() {
    let filtered = trendsData.filter(item => {
        if (activeFilters.search) {
            const st = [item.topic, item.broker, item.content, item.companies, item.tags].join(' ').toLowerCase();
            if (!st.includes(activeFilters.search)) return false;
        }
        if (activeFilters.tag && !item.tags.includes(activeFilters.tag)) return false;
        if (activeFilters.broker && item.broker !== activeFilters.broker) return false;
        return true;
    });
    
    filtered.sort((a, b) => String(b.date).localeCompare(String(a.date)));
    document.getElementById('filteredCount').textContent = filtered.length;
    const list = document.getElementById('reportsList');
    
    if (filtered.length === 0) { list.innerHTML = '<div class="empty-state"><p>ğŸ” æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¶¨å‹¢</p></div>'; return; }
    
    list.innerHTML = filtered.map(item => {
        const tags = parseTags(item.tags).slice(0, 4);
        return `<div class="card-base trend-card" onclick="openTrendModal('${item.id}')">
            <span class="trend-badge">ğŸ“ˆ ç”¢æ¥­è¶¨å‹¢</span>
            <div class="card-meta"><span class="meta-tag broker">${item.broker}</span><span class="meta-tag date">${item.date}</span></div>
            <div class="company-name" style="margin:8px 0;">${item.topic}</div>
            <div style="font-size:14px;color:#5a9e6f;margin-bottom:8px;">ğŸ“Œ ${item.companies}</div>
            <div class="card-content">${item.content.substring(0, 100)}...</div>
            <div class="card-tags" style="margin-top:8px;">${tags.map(t => `<span class="mini-tag" onclick="event.stopPropagation();searchByTag('${t}')">#${t}</span>`).join('')}</div>
        </div>`;
    }).join('');
}

function renderIndustry() {
    let filtered = memoIndustryTrends.filter(item => {
        if (activeFilters.search) {
            const st = [item.industry, item.trend, item.companies, item.driver, item.suggestion].join(' ').toLowerCase();
            if (!st.includes(activeFilters.search)) return false;
        }
        if (activeFilters.industry && item.industry !== activeFilters.industry) return false;
        return true;
    });
    
    document.getElementById('filteredCount').textContent = filtered.length;
    const list = document.getElementById('reportsList');
    
    if (filtered.length === 0) { list.innerHTML = '<div class="empty-state"><p>ğŸ” æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç”¢æ¥­</p></div>'; return; }
    
    list.innerHTML = filtered.map((item, idx) => `<div class="card-base industry-card" onclick="openIndustryModal(${idx})">
        <span class="industry-badge">${item.trend}</span>
        <div class="card-header"><div class="card-left"><span class="company-name">${item.industry}</span></div><span class="meta-tag trend">${item.cycle}</span></div>
        <div style="font-size:14px;color:#9b59b6;margin:8px 0;">ğŸ“Œ ${item.companies}</div>
        <div class="card-content">${item.drivers.substring(0, 100)}...</div>
    </div>`).join('');
}

function renderStocks() {
    const uniqueStocks = {};
    Object.values(masterStocks).forEach(s => { if (s.code && !uniqueStocks[s.code]) uniqueStocks[s.code] = s; });
    
    let filtered = Object.values(uniqueStocks).filter(s => {
        if (activeFilters.search) {
            const st = [s.code, s.name, s.industry, s.subIndustry, s.business].join(' ').toLowerCase();
            if (!st.includes(activeFilters.search)) return false;
        }
        if (activeFilters.industry && s.industry !== activeFilters.industry) return false;
        if (activeFilters.market && s.market !== activeFilters.market) return false;
        return true;
    });
    
    filtered.sort((a, b) => a.code.localeCompare(b.code));
    document.getElementById('filteredCount').textContent = filtered.length;
    const list = document.getElementById('reportsList');
    
    if (filtered.length === 0) { list.innerHTML = '<div class="empty-state"><p>ğŸ” æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å€‹è‚¡</p></div>'; return; }
    
    list.innerHTML = filtered.slice(0, 50).map(s => {
        const concepts = conceptStocks.filter(c => c.code === s.code).slice(0, 3);
        const cbs = cbData[s.code] || [];
        const cbTag = cbs.length > 0 ? `<span class="meta-tag" style="background:#e74c3c;color:#fff;font-weight:600;">ğŸ« æœ‰CB(${cbs.length}æª”)</span>` : '';
        return `<div class="card-base stock-card" onclick="openStockModal('${s.code}')">
            <span class="stock-badge">${s.market}</span>
            <div class="card-header"><div class="card-left"><span class="company-name">${s.name}</span><span class="stock-code">${s.code}</span></div><div style="text-align:right;"><div style="font-size:16px;font-weight:700;">${s.price}</div><div style="font-size:13px;color:${String(s.changePercent).includes('-') ? '#d64545' : '#2e7d46'};">${s.change} (${s.changePercent})</div></div></div>
            <div class="card-meta"><span class="meta-tag industry">${s.industry}</span><span class="meta-tag date">å¸‚å€¼ ${parseFloat(s.marketCap).toFixed(2)}å„„</span>${cbTag}</div>
            <div class="card-content">${(s.business || '').substring(0, 80)}...</div>
            ${concepts.length > 0 ? `<div class="card-tags" style="margin-top:8px;">${concepts.map(c => `<span class="mini-tag">${c.concept}</span>`).join('')}</div>` : ''}
        </div>`;
    }).join('') + (filtered.length > 50 ? `<div style="text-align:center;padding:20px;color:#8b8b8b;">é¡¯ç¤ºå‰ 50 ç­†ï¼Œå…± ${filtered.length} ç­†</div>` : '');
}

function renderCB() {
    const industryStats = {};
    cbList.forEach(cb => {
        const ind = cb.industry || 'å…¶ä»–';
        if (!industryStats[ind]) industryStats[ind] = { count: 0, cbs: [], totalAmount: 0 };
        industryStats[ind].count++;
        industryStats[ind].cbs.push(cb);
        industryStats[ind].totalAmount += parseFloat(cb.remainAmount) || 0;
    });
    
    const sortedIndustries = Object.entries(industryStats).sort((a, b) => b[1].count - a[1].count);
    let filteredCBs = cbList;
    if (activeFilters.search) {
        const q = activeFilters.search.toLowerCase();
        filteredCBs = cbList.filter(cb => [cb.cbCode, cb.cbName, cb.stockCode, cb.stockName, cb.industry].join(' ').toLowerCase().includes(q));
    }
    if (activeFilters.industry) filteredCBs = filteredCBs.filter(cb => cb.industry === activeFilters.industry);
    
    document.getElementById('filteredCount').textContent = filteredCBs.length;
    const list = document.getElementById('reportsList');
    
    let html = `<div style="background:linear-gradient(135deg,#fff5f5,#fff0f0);border-radius:15px;padding:20px;margin-bottom:20px;border:1px solid #f5d5d5;">
        <h3 style="margin:0 0 15px 0;color:#c96442;font-size:18px;">ğŸ« å¯è½‰å‚µå¸‚å ´çµ±è¨ˆ</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;">
            <div style="text-align:center;padding:15px;background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);"><div style="font-size:28px;font-weight:700;color:#e74c3c;">${cbList.length}</div><div style="font-size:14px;color:#666;">æ›ç‰Œä¸­CBç¸½æ•¸</div></div>
            <div style="text-align:center;padding:15px;background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);"><div style="font-size:28px;font-weight:700;color:#3498db;">${Object.keys(cbData).length}</div><div style="font-size:14px;color:#666;">ç™¼è¡ŒCBå…¬å¸æ•¸</div></div>
            <div style="text-align:center;padding:15px;background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);"><div style="font-size:28px;font-weight:700;color:#27ae60;">${(cbList.reduce((sum, cb) => sum + (parseFloat(cb.remainAmount) || 0), 0) / 1000).toFixed(1)}</div><div style="font-size:14px;color:#666;">ç¸½é¤˜é¡(åå„„)</div></div>
        </div>
    </div>`;
    
    html += `<div style="background:#fff;border-radius:15px;padding:20px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);">
        <h3 style="margin:0 0 15px 0;color:#333;font-size:16px;">ğŸ“Š å„ç”¢æ¥­CBåˆ†ä½ˆ</h3>
        <div style="display:flex;flex-wrap:wrap;gap:10px;">
            ${sortedIndustries.map(([ind, data]) => `<div onclick="activeFilters.industry='${ind}';renderCB();" style="cursor:pointer;padding:10px 15px;background:${activeFilters.industry === ind ? '#e74c3c' : '#f8f8f8'};color:${activeFilters.industry === ind ? '#fff' : '#333'};border-radius:10px;display:flex;align-items:center;gap:8px;">
                <span style="font-weight:600;">${ind}</span><span style="background:${activeFilters.industry === ind ? 'rgba(255,255,255,0.3)' : '#e74c3c'};color:${activeFilters.industry === ind ? '#fff' : '#fff'};padding:2px 8px;border-radius:10px;font-size:13px;">${data.count}</span>
            </div>`).join('')}
            ${activeFilters.industry ? `<div onclick="activeFilters.industry='';renderCB();" style="cursor:pointer;padding:10px 15px;background:#fff;border:1px solid #e74c3c;color:#e74c3c;border-radius:10px;">âœ• æ¸…é™¤ç¯©é¸</div>` : ''}
        </div>
    </div>`;
    
    html += `<div style="background:#fff;border-radius:15px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.05);">
        <h3 style="margin:0 0 15px 0;color:#333;font-size:16px;">ğŸ“‹ CBåˆ—è¡¨ ${activeFilters.industry ? `(${activeFilters.industry})` : ''}</h3>
        <div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:14px;">
            <thead><tr style="background:#f8f8f8;">
                <th style="padding:10px;text-align:left;">CBä»£è™Ÿ</th><th style="padding:10px;text-align:left;">æ¨™çš„è‚¡ç¥¨</th>
                <th style="padding:10px;text-align:right;">è½‰æ›åƒ¹</th><th style="padding:10px;text-align:right;">å¸‚åƒ¹</th><th style="padding:10px;text-align:right;">è½‰æ›åƒ¹å€¼</th>
                <th style="padding:10px;text-align:right;">æ›ç‰Œé«˜/ä½</th><th style="padding:10px;text-align:center;">åˆ°æœŸæ—¥</th>
            </tr></thead>
            <tbody>
                ${filteredCBs.slice(0, 100).map(cb => {
                    const stock = masterStocks[cb.stockCode] || {};
                    const marketPrice = parseFloat(stock.price) || 0;
                    const convValue = cb.conversionPrice > 0 ? ((marketPrice / cb.conversionPrice) * 100).toFixed(2) : '-';
                    const convColor = parseFloat(convValue) >= 100 ? '#27ae60' : (parseFloat(convValue) >= 80 ? '#f39c12' : '#e74c3c');
                    const range = cbPriceRange[cb.cbCode] || {high: '-', low: '-'};
                    return `<tr style="border-bottom:1px solid #f0f0f0;cursor:pointer;" onclick="openStockModal('${cb.stockCode}')">
                        <td style="padding:10px;font-weight:600;color:#e74c3c;">${cb.cbCode}</td>
                        <td style="padding:10px;"><span style="color:#c96442;">${cb.stockName}</span></td>
                        <td style="padding:10px;text-align:right;">${cb.conversionPrice}</td>
                        <td style="padding:10px;text-align:right;">${marketPrice || '-'}</td>
                        <td style="padding:10px;text-align:right;color:${convColor};font-weight:600;">${convValue}</td>
                        <td style="padding:10px;text-align:right;">${range.high}/${range.low}</td>
                        <td style="padding:10px;text-align:center;">${cb.maturityDate}</td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table></div>
    </div>`;
    
    list.innerHTML = html;
}

function renderTimeline() {
    // é ç•™å‡½æ•¸ï¼Œç¢ºä¿æ¸²æŸ“é‚è¼¯å®Œæ•´
    // ç›®å‰æ™‚é–“è»¸è³‡æ–™å°šæœªå®Œå…¨æ•´åˆåˆ°ä»‹é¢ï¼Œå¦‚æœ‰éœ€è¦å¯è§£é™¤ä¸‹æ–¹è¨»è§£
}

// ===== Modal åŠŸèƒ½å‡½æ•¸ =====

function openModal() {
    document.getElementById('modalOverlay').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal(e) {
    if (e && e.target !== document.getElementById('modalOverlay')) return;
    document.getElementById('modalOverlay').classList.remove('active');
    document.body.style.overflow = '';
}

function switchTab(tabId) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    const target = document.getElementById('tab-' + tabId);
    if(target) target.classList.add('active');
}

function openNewsModal(id) {
    const item = newsData.find(n => n.id == id);
    if (!item) return;
    const content = formatContent(newsContent[id] || '');
    const tags = parseTags(item.tags);
    
    document.getElementById('modalHeaderInfo').innerHTML = `
        <div class="modal-meta"><span class="meta-tag broker">${item.broker}</span><span class="meta-tag date">${item.date}</span><span class="meta-tag category">${item.category}</span></div>
        <h2 class="modal-title"><span class="company-link" onclick="openStockModal('${item.stockCode}')">${item.company}</span>${item.stockCode && item.stockCode !== '-' ? ` (${item.stockCode})` : ''}</h2>
    `;
    
    document.getElementById('modalBody').innerHTML = `
        <div class="modal-section"><h3 class="section-title">ğŸ“ å®Œæ•´å ±å°å…§å®¹</h3><div class="content-block">${content}</div></div>
        <div class="modal-section"><h3 class="section-title">ğŸ·ï¸ ç›¸é—œæ¨™ç±¤</h3><div class="tags-block">${tags.map(t => `<span class="modal-tag" onclick="searchByTag('${t}');closeModal();">#${t}</span>`).join('')}</div></div>
    `;
    openModal();
}

function openMemoModal(id) {
    const item = memoReports.find(m => m.id == id);
    if (!item) return;
    
    const detail = memoDetails[id] || {};
    const tracking = memoTracking[id] || {};
    const finance = memoFinance[id] || {};
    const products = memoProducts[id] || {};
    const tags = parseTags(detail.tags);
    
    document.getElementById('modalHeaderInfo').innerHTML = `
        <div class="modal-meta"><span class="meta-tag broker">${item.broker}</span><span class="meta-tag industry">${item.industry}</span><span class="meta-tag date">${item.date}</span>${tracking.targetPrice ? `<span class="meta-tag tp">ç›®æ¨™åƒ¹ ${tracking.targetPrice}</span>` : ''}</div>
        <h2 class="modal-title"><span class="company-link" onclick="openStockModal('${item.stockCode}')">${item.company}</span> (${item.stockCode})</h2>
        <p class="modal-subtitle">${item.type} | ${item.analyst || ''}</p>
    `;
    
    let html = `<div class="tab-buttons">
        <button class="tab-btn active" onclick="switchTab('overview')">ğŸ“Š ç¸½è¦½</button>
        <button class="tab-btn" onclick="switchTab('operation')">ğŸ¯ ç‡Ÿé‹é‡é»</button>
        <button class="tab-btn" onclick="switchTab('strategy')">ğŸš€ ç­–ç•¥æ–¹å‘</button>
        <button class="tab-btn" onclick="switchTab('finance')">ğŸ’° è²¡å‹™æ•¸æ“š</button>
        <button class="tab-btn" onclick="switchTab('products')">ğŸ“¦ ç”¢å“çµæ§‹</button>
        <button class="tab-btn" onclick="switchTab('rex')">ğŸ‘€ Rexè§€å¯Ÿ</button>
    </div>`;
    
    html += `<div class="tab-content active" id="tab-overview">
        <div class="info-grid">
            <div class="info-item"><div class="info-label">ç‡Ÿæ”¶YoY</div><div class="info-value">${item.revenueYoY || finance.revenueYoY || '-'}</div></div>
            <div class="info-item"><div class="info-label">æ¯›åˆ©ç‡</div><div class="info-value">${item.grossMargin || finance.grossMargin || '-'}</div></div>
            <div class="info-item"><div class="info-label">EPS</div><div class="info-value">${item.eps || finance.eps || '-'}</div></div>
            <div class="info-item"><div class="info-label">æŠ•è³‡è©•ç­‰</div><div class="info-value">${tracking.rating || '-'}</div></div>
            <div class="info-item"><div class="info-label">ç›®æ¨™åƒ¹</div><div class="info-value">${tracking.targetPrice || '-'}</div></div>
        </div>
        ${tags.length > 0 ? `<div class="section-block"><h4>æ¨™ç±¤</h4><div class="tags-container">${tags.map(t => `<span class="tag-chip">${t}</span>`).join('')}</div></div>` : ''}
    </div>`;
    
    html += `<div class="tab-content" id="tab-operation">${detail.operation ? `<div class="content-text full-content">${detail.operation.replace(/\n/g, '<br>')}</div>` : '<p class="no-data">ç„¡è³‡æ–™</p>'}</div>`;
    html += `<div class="tab-content" id="tab-strategy">${detail.strategy ? `<div class="content-text full-content">${detail.strategy.replace(/\n/g, '<br>')}</div>` : '<p class="no-data">ç„¡è³‡æ–™</p>'}</div>`;
    html += `<div class="tab-content" id="tab-finance">
        <div class="finance-grid">
            <div class="finance-card"><h4>ç‡Ÿæ”¶è¡¨ç¾</h4><div class="finance-item"><span>3Q25ç‡Ÿæ”¶</span><span>${finance.revenue3Q || '-'}</span></div><div class="finance-item"><span>ç‡Ÿæ”¶YoY</span><span>${finance.revenueYoY || '-'}</span></div></div>
            <div class="finance-card"><h4>ç²åˆ©èƒ½åŠ›</h4><div class="finance-item"><span>æ¯›åˆ©ç‡</span><span>${finance.grossMargin || '-'}</span></div><div class="finance-item"><span>ç¨…å¾Œæ·¨åˆ©</span><span>${finance.netIncome || '-'}</span></div></div>
        </div>
    </div>`;
    html += `<div class="tab-content" id="tab-products">${products.products && products.products.length > 0 ? products.products.map(p => `<div class="product-item"><div class="product-name">${p.name}</div><div class="product-ratio">${p.ratio}</div></div>`).join('') : '<p class="no-data">ç„¡è³‡æ–™</p>'}</div>`;
    html += `<div class="tab-content" id="tab-rex">${detail.rexView ? `<div class="content-text full-content rex-view">${detail.rexView.replace(/\n/g, '<br>')}</div>` : '<p class="no-data">ç„¡è³‡æ–™</p>'}</div>`;
    
    document.getElementById('modalBody').innerHTML = html;
    openModal();
}

function openReportModal(id) {
    const report = reportsData.find(r => r.id == id);
    if (!report) return;
    const details = reportDetails[id] || [];
    const stocks = reportStocksData[id] || [];
    
    document.getElementById('modalHeaderInfo').innerHTML = `<div class="modal-meta"><span class="meta-tag broker">${report.broker}</span><span class="meta-tag industry">${report.industry}</span></div><h2 class="modal-title">${report.title}</h2>`;
    let html = `<div class="modal-section"><h3 class="section-title">âœ¨ æ ¸å¿ƒé‡é»</h3><ul style="padding-left:20px;">${report.highlights.map(h => `<li>${h}</li>`).join('')}</ul></div>`;
    if (details.length > 0) html += `<div class="modal-section"><h3 class="section-title">ğŸ“Š è©³ç´°åˆ†æ</h3>${details.map(d => `<div style="margin-bottom:15px;background:#fafaf8;padding:12px;border-radius:8px;"><div style="font-weight:700;color:#c96442;">${d.sectionTitle}</div><div class="content-text">${d.content}</div></div>`).join('')}</div>`;
    if (stocks.length > 0) html += `<div class="modal-section"><h3 class="section-title">ğŸ† é¦–é¸å€‹è‚¡</h3>${stocks.map(s => `<div class="card-base" onclick="closeModal();setTimeout(()=>openStockModal('${s.code}'),100);"><b>${s.name}</b> ç›®æ¨™åƒ¹: ${s.target}</div>`).join('')}</div>`;
    
    document.getElementById('modalBody').innerHTML = html;
    openModal();
}

function openStrategyModal(id) {
    const report = strategyReports.find(r => r.id == id);
    if (!report) return;
    const themes = strategyThemes[id] || [];
    const picks = strategyPicks[id] || [];
    
    document.getElementById('modalHeaderInfo').innerHTML = `<div class="modal-meta"><span class="meta-tag broker">${report.broker}</span><span class="meta-tag trend">${report.type}</span></div><h2 class="modal-title">${report.title}</h2>`;
    let html = `<div class="modal-section"><h3 class="section-title">ğŸŒ ç¸½ç¶“è§€é»</h3><div class="content-block">${report.marketView || report.macroSummary}</div></div>`;
    if (themes.length > 0) html += `<div class="modal-section"><h3 class="section-title">ğŸ”¥ æŠ•è³‡é¡Œæ</h3><div style="display:flex;flex-wrap:wrap;gap:10px;">${themes.map(t => `<div style="flex:1;min-width:250px;background:#fff8e1;padding:12px;border-radius:8px;"><b>${t.topic}</b><br>${t.content}</div>`).join('')}</div></div>`;
    if (picks.length > 0) html += `<div class="modal-section"><h3 class="section-title">ğŸ¯ é¸è‚¡ç­–ç•¥</h3>${picks.map(p => `<div style="padding:8px;border-bottom:1px solid #eee;cursor:pointer;" onclick="closeModal();setTimeout(()=>openStockModal('${p.stockCode}'),100);">${p.stockName} (${p.stockCode}) - ${p.theme}</div>`).join('')}</div>`;
    
    document.getElementById('modalBody').innerHTML = html;
    openModal();
}

function openTrendModal(id) {
    const item = trendsData.find(t => t.id == id);
    if (!item) return;
    document.getElementById('modalHeaderInfo').innerHTML = `<div class="modal-meta"><span class="meta-tag broker">${item.broker}</span></div><h2 class="modal-title">${item.topic}</h2>`;
    document.getElementById('modalBody').innerHTML = `<div class="modal-section"><h3 class="section-title">ğŸ“– è¶¨å‹¢å…§å®¹</h3><div class="content-text full-content">${formatContent(item.content)}</div></div><div class="modal-section"><h3 class="section-title">ğŸ”— ç›¸é—œå€‹è‚¡</h3><div style="font-weight:600;color:#2e7d46;">${item.companies}</div></div>`;
    openModal();
}

function openIndustryModal(idx) {
    const item = memoIndustryTrends[idx];
    if (!item) return;
    document.getElementById('modalHeaderInfo').innerHTML = `<div class="modal-meta"><span class="meta-tag industry">${item.industry}</span></div><h2 class="modal-title">${item.industry} - ${item.trend}</h2>`;
    document.getElementById('modalBody').innerHTML = `<div class="info-grid"><div class="info-item">æ™¯æ°£ä½ç½®: ${item.cycle}</div></div><div class="modal-section"><h3 class="section-title">ğŸ”¥ é©…å‹•å› ç´ </h3><div class="content-block">${item.drivers}</div></div><div class="modal-section"><h3 class="section-title">ğŸ’¡ æŠ•è³‡å»ºè­°</h3><div class="content-block">${item.suggestion}</div></div>`;
    openModal();
}

function openStockModal(codeOrName) {
    const stock = masterStocks[codeOrName] || masterStocks[String(codeOrName)];
    if (!stock) { alert('æ‰¾ä¸åˆ°è³‡æ–™'); return; }
    
    const revenue = revenueData[stock.code] || {};
    const concepts = conceptStocks.filter(c => c.code === stock.code);
    const tracking = memoTracking[stock.name] || {}; // æ³¨æ„ï¼šå¯èƒ½éœ€è¦ç”¨ code æˆ– name é—œè¯
    const relatedNews = newsData.filter(n => n.stockCode === stock.code || n.company === stock.name).slice(0, 5);
    const relatedMemo = memoReports.filter(m => m.stockCode === stock.code || m.company === stock.name);
    
    document.getElementById('modalHeaderInfo').innerHTML = `<div class="modal-meta"><span class="meta-tag industry">${stock.industry}</span></div><h2 class="modal-title">${stock.name} (${stock.code})</h2>`;
    
    let html = `<div class="tab-buttons">
        <button class="tab-btn active" onclick="switchStockTab('basic')">ğŸ“Š åŸºæœ¬è³‡æ–™</button>
        <button class="tab-btn" onclick="switchStockTab('finance')">ğŸ’° è²¡å‹™</button>
        <button class="tab-btn" onclick="switchStockTab('news')">ğŸ“‹ å ±å‘Š</button>
    </div>`;
    
    html += `<div class="tab-content active" id="stock-basic">
        <div class="info-grid">
            <div class="info-item"><div class="info-label">è‚¡åƒ¹</div><div class="info-value large">${stock.price}</div></div>
            <div class="info-item"><div class="info-label">å¸‚å€¼</div><div class="info-value">${parseFloat(stock.marketCap).toFixed(2)}å„„</div></div>
            <div class="info-item"><div class="info-label">è‚¡æœ¬</div><div class="info-value">${parseFloat(stock.capital).toFixed(2)}å„„</div></div>
            ${tracking.targetPrice ? `<div class="info-item"><div class="info-label">ç›®æ¨™åƒ¹</div><div class="info-value large" style="color:#2e7d46;">${tracking.targetPrice}</div></div>` : ''}
        </div>
        ${stock.business ? `<div class="modal-section" style="margin-top:10px;"><h3 class="section-title">ğŸ’¼ æ¥­å‹™æ‘˜è¦</h3><div class="content-block">${stock.business}</div></div>` : ''}
        ${(() => {
            const stockCode = String(stock.code).trim().replace(/\s/g, '');
            const cbs = cbData[stockCode] || [];
            if (cbs.length === 0) return '';
            const stockPrice = parseFloat(stock.price) || 0;
            return `<div class="modal-section"><h3 class="section-title">ğŸ« å¯è½‰æ›å…¬å¸å‚µ (${cbs.length}æª”)</h3>${cbs.map(cb => {
                const convValue = cb.conversionPrice > 0 ? ((stockPrice / cb.conversionPrice) * 100).toFixed(2) : '-';
                return `<div class="product-item" style="border-left:3px solid #e74c3c;"><div class="product-name" style="color:#e74c3c;">${cb.cbName} (${cb.cbCode})</div><div class="product-ratio">è½‰æ›åƒ¹:${cb.conversionPrice} | è½‰æ›åƒ¹å€¼:<b>${convValue}</b> | é¤˜é¡:${cb.remainAmount}</div></div>`;
            }).join('')}</div>`;
        })()}
    </div>`;
    
    // è²¡å‹™æ•¸æ“šé ç±¤ (ç°¡åŒ–ç‰ˆ)
    const genTable = (data) => {
        if (!data || data.length === 0) return '<p class="no-data">ç„¡è³‡æ–™</p>';
        return `<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:12px;"><tr style="background:#f8f6f1;">${data.map(d => `<th style="padding:6px;border:1px solid #ddd;">${d.period}</th>`).join('')}</tr><tr>${data.map(d => `<td style="padding:6px;border:1px solid #ddd;text-align:right;">${d.value}</td>`).join('')}</tr></table></div>`;
    };
    
    html += `<div class="tab-content" id="stock-finance">
        <div class="modal-section"><h3 class="section-title">æœˆç‡Ÿæ”¶</h3>${genTable(revenue.monthly)}</div>
        <div class="modal-section"><h3 class="section-title">EPS</h3>${genTable(revenue.quarterly)}</div>
    </div>`;
    
    // ç›¸é—œå ±å‘Š
    html += `<div class="tab-content" id="stock-news">
        ${relatedNews.map(n => `<div class="related-item" onclick="closeModal();setTimeout(()=>openNewsModal('${n.id}'),100);"><div class="related-title">${n.category}</div><div class="related-meta">${n.date} | ${n.broker}</div></div>`).join('')}
        ${relatedMemo.map(m => `<div class="related-item" onclick="closeModal();setTimeout(()=>openMemoModal('${m.id}'),100);"><div class="related-title">${m.type} - ${m.broker}</div><div class="related-meta">${m.date} | è©•ç­‰: ${m.rating || '-'}</div></div>`).join('')}
    </div>`;
    
    document.getElementById('modalBody').innerHTML = html;
    openModal();
}

function switchStockTab(tabId) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById('stock-' + tabId).classList.add('active');
}

// ===== ä¸»ç¨‹å¼å…¥å£ =====
window.onload = async function() {
    const overlay = document.getElementById('loadingOverlay');
    try {
        updateLoadingStatus('æ­£åœ¨è¼‰å…¥å¤–é›»è³‡æ–™...', NEWS_FILE, 10); await loadNewsData();
        updateLoadingStatus('æ­£åœ¨è¼‰å…¥ Call Memo...', MEMO_FILE, 30); await loadMemoData();
        updateLoadingStatus('æ­£åœ¨è¼‰å…¥ç”¢æ¥­å ±å‘Š...', REPORTS_FILE, 50); await loadReportsData();
        updateLoadingStatus('æ­£åœ¨è¼‰å…¥ä¸»è³‡æ–™åº«...', MASTER_FILE, 70); await loadMasterData();
        updateLoadingStatus('æ­£åœ¨è¼‰å…¥æŠ•è³‡ç­–ç•¥...', STRATEGY_FILE, 85); await loadStrategyData();
        updateLoadingStatus('æ­£åœ¨è¼‰å…¥å¯è½‰å‚µè³‡æ–™...', CB_FILE, 88); await loadCBData();
        updateLoadingStatus('æ­£åœ¨è¼‰å…¥ç‡Ÿæ”¶è³‡æ–™...', REVENUE_FILE, 93); await loadRevenueData();
        
        updateLoadingStatus('å»ºç«‹ç´¢å¼•ä¸­...', '', 97);
        buildSearchIndex();
        buildFilters();
        buildHotTags();
        updateCounts();
        
        updateLoadingStatus('è¼‰å…¥å®Œæˆï¼', '', 100);
        setTimeout(() => { renderCurrentDB(); overlay.classList.add('hidden'); }, 300);

        const si = document.getElementById('mainSearchInput');
        si.addEventListener('input', onSearchInput);
        si.addEventListener('focus', () => showSuggestions());
        document.addEventListener('click', e => { if (!e.target.closest('.main-search')) hideSuggestions(); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
    } catch (e) {
        console.error('è¼‰å…¥éŒ¯èª¤:', e);
        overlay.innerHTML = `<div class="error-box"><h3>âš ï¸ è¼‰å…¥å¤±æ•—</h3><p>${e.message}</p><p>è«‹ç¢ºèªæª”æ¡ˆåç¨±æ˜¯å¦æ­£ç¢ºä¸”ä½¿ç”¨æœ¬åœ°ä¼ºæœå™¨åŸ·è¡Œã€‚</p><button onclick="location.reload()" style="margin-top:20px;padding:8px 20px;cursor:pointer;">é‡æ–°è¼‰å…¥</button></div>`;
    }
};
</script>
</body>
</html>
