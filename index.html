<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤ - æˆ°æƒ…ä¸­å¿ƒç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* === æ ¸å¿ƒè®Šæ•¸èˆ‡åŸºç¤è¨­å®š === */
        :root { --primary: #c96442; --bg: #f5f4ef; --white: #ffffff; --cb-color: #c2185b; --success: #27ae60; --danger: #e74c3c; --text: #2d2d2d; --gray: #888; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif; background: var(--bg); min-height: 100vh; color: var(--text); font-size: 14px; line-height: 1.5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        
        /* === Header === */
        .header { text-align: center; padding: 25px 0 20px; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px; background: #fff; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .header h1 { font-size: 24px; color: var(--primary); margin-bottom: 6px; letter-spacing: 1px; }
        .header .subtitle { color: var(--gray); font-size: 13px; }
        
        /* === Tab åˆ‡æ› === */
        .db-switcher { display: flex; justify-content: center; gap: 8px; margin: 20px 0; flex-wrap: wrap; }
        .db-tab { padding: 8px 16px; border: 1px solid #ddd; background: #fff; border-radius: 20px; font-size: 13px; font-weight: 600; color: #666; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .db-tab:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }
        .db-tab.active { background: var(--primary); border-color: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(201,100,66,0.3); }
        .db-tab .count { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 8px; font-size: 11px; margin-left: 4px; }
        .db-tab.active .count { background: rgba(255,255,255,0.3); }
        
        /* === æœå°‹å€å¡Š === */
        .search-section { background: #fff; border-radius: 16px; padding: 16px; margin-bottom: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.04); position: relative; }
        .main-search { position: relative; margin-bottom: 12px; }
        .main-search::before { content: "ğŸ”"; position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 16px; color: #999; }
        #mainSearchInput { width: 100%; padding: 14px 14px 14px 48px; border: 2px solid #eee; border-radius: 30px; background: #fafaf8; font-size: 15px; transition: all 0.3s; }
        #mainSearchInput:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px rgba(201,100,66,0.1); }
        
        .search-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #eee; border-radius: 12px; margin-top: 6px; max-height: 400px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 8px 30px rgba(0,0,0,0.12); }
        .suggestion-group-title { padding: 8px 16px; font-size: 11px; color: #999; font-weight: 700; background: #f9f9f9; }
        .suggestion-item { padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #f0f0f0; }
        .suggestion-item:hover { background: #f5f4ef; }
        .suggestion-icon { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; background: #eee; }
        
        /* === åˆ—è¡¨å¡ç‰‡ === */
        .reports-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .card-base { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.2s; position: relative; display: flex; flex-direction: column; }
        .card-base:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.06); border-color: var(--primary); }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .company-name { font-size: 16px; font-weight: 700; color: #333; }
        .stock-code { font-size: 12px; color: #666; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
        
        .card-meta { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .meta-tag { font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 500; }
        .meta-tag.broker { background: #e8f4fd; color: #2980b9; }
        .meta-tag.industry { background: #fdf2e9; color: #d35400; }
        .meta-tag.date { background: #f5f5f5; color: #666; }
        .meta-tag.cb { background: #fce4ec; color: #c2185b; border: 1px solid #f8bbd0; }
        
        .card-content { font-size: 13px; color: #555; margin-bottom: 12px; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; flex-grow: 1; }
        .card-footer { margin-top: auto; padding-top: 10px; border-top: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #888; }
        
        /* === Modal è¦–çª— === */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; backdrop-filter: blur(3px); justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { width: 95%; max-width: 950px; height: 90vh; background: #fff; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0,0,0,0.2); animation: modalIn 0.25s ease-out; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .modal-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-controls { display: flex; gap: 10px; align-items: center; }
        .modal-back-btn { padding: 6px 12px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px; transition: 0.2s; color: #555; font-weight: 600; }
        .modal-back-btn:hover { background: #e0e0e0; color: #333; }
        .modal-close { width: 32px; height: 32px; border: none; background: #f5f5f5; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: var(--danger); color: #fff; }
        
        .modal-body { flex-grow: 1; overflow-y: auto; padding: 20px; background: #fafaf8; }
        
        /* Modal Tabs */
        .modal-tabs { display: flex; gap: 5px; padding: 10px 20px; background: #fff; border-bottom: 1px solid #eee; overflow-x: auto; flex-shrink: 0; }
        .modal-tab { padding: 8px 16px; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; color: #666; white-space: nowrap; transition: 0.2s; }
        .modal-tab:hover { background: #f5f5f5; color: var(--primary); }
        .modal-tab.active { background: var(--primary); color: #fff; }
        .tab-pane { display: none; animation: fadeIn 0.3s; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* CB å°ˆç”¨å…§éƒ¨ Tabs (Sub-tabs) */
        .cb-sub-tabs { display: flex; gap: 15px; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 0; }
        .cb-sub-tab { cursor: pointer; padding: 8px 5px; font-size: 13px; font-weight: 600; color: #888; border-bottom: 3px solid transparent; transition: 0.2s; }
        .cb-sub-tab:hover { color: var(--cb-color); }
        .cb-sub-tab.active { color: var(--cb-color); border-bottom-color: var(--cb-color); }
        .cb-sub-pane { display: none; padding-top: 10px; }
        .cb-sub-pane.active { display: block; }
        
        /* å…§å®¹å…ƒä»¶ */
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .info-card { background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); border: 1px solid #eee; }
        .info-label { font-size: 12px; color: #888; margin-bottom: 4px; }
        .info-value { font-size: 15px; font-weight: 700; color: #333; }
        
        .section-box { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .section-title { font-size: 15px; font-weight: 700; color: var(--primary); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #f5f4ef; display: flex; align-items: center; gap: 8px; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th { text-align: left; padding: 10px; background: #f8f9fa; color: #666; font-weight: 600; border-bottom: 2px solid #eee; white-space: nowrap; }
        .data-table td { padding: 10px; border-bottom: 1px solid #eee; color: #333; }
        .data-table tr:hover td { background: #fdfbf7; }
        .val-pos { color: var(--success); font-weight: 600; }
        .val-neg { color: var(--danger); font-weight: 600; }
        
        /* Loading */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f5f4ef; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .loading-bar-container { width: 200px; height: 4px; background: #ddd; border-radius: 2px; overflow: hidden; margin-top: 15px; }
        .loading-bar { height: 100%; width: 0%; background: var(--primary); transition: width 0.3s; }
        .error-msg { padding: 20px; background: #fff5f5; border: 1px solid #feb2b2; border-radius: 8px; color: #c53030; text-align: center; margin: 20px; }
        
        @media (max-width: 600px) { .header h1 { font-size: 18px; } .db-tab { padding: 6px 10px; font-size: 11px; } .info-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <div style="font-size:40px;margin-bottom:10px;">ğŸ“Š</div>
    <h3 id="loadingText">ç³»çµ±å•Ÿå‹•ä¸­...</h3>
    <div style="font-size:12px;color:#888;margin-top:5px;" id="loadingDetail">æ­£åœ¨æ•´åˆè²¡å‹™èˆ‡CBè³‡æ–™åº«</div>
    <div class="loading-bar-container"><div class="loading-bar" id="loadingBar"></div></div>
</div>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š Rexå¤§å”æŠ•è³‡ç ”ç©¶å®¤</h1>
        <p class="subtitle">ç‡Ÿæ”¶ Ã— ç ”å ± Ã— CBå¯è½‰å‚µ Ã— ç”¢æ¥­è¶¨å‹¢ | å…¨æ–¹ä½æˆ°æƒ…ä¸­å¿ƒ</p>
    </div>

    <div class="db-switcher">
        <div class="db-tab active" onclick="switchDB('stock')" data-db="stock">ğŸ¢ å€‹è‚¡ç¸½è¦½<span class="count" id="cnt-stock">0</span></div>
        <div class="db-tab" onclick="switchDB('cb')" data-db="cb">ğŸ« CBæˆ°æƒ…<span class="count" id="cnt-cb">0</span></div>
        <div class="db-tab" onclick="switchDB('news')" data-db="news">âš¡ å¤–é›»å¿«å ±<span class="count" id="cnt-news">0</span></div>
        <div class="db-tab" onclick="switchDB('report')" data-db="report">ğŸ“‘ ç”¢æ¥­å ±å‘Š<span class="count" id="cnt-report">0</span></div>
        <div class="db-tab" onclick="switchDB('strategy')" data-db="strategy">ğŸ¯ æŠ•è³‡ç­–ç•¥<span class="count" id="cnt-strategy">0</span></div>
    </div>

    <div class="search-section">
        <div class="main-search">
            <input type="text" id="searchInput" placeholder="è¼¸å…¥ä»£è™Ÿã€å…¬å¸åã€CBç°¡ç¨± (ä¾‹å¦‚: 2330, ä¸–ç´€é‹¼å…«, æ©Ÿå™¨äºº)...">
            <div class="search-suggestions" id="searchSuggestions"></div>
        </div>
        <div style="font-size:12px;color:#888;text-align:right;">* æ”¯æ´ä»£è™Ÿã€åç¨±ã€CBä»£ç¢¼ã€æ¦‚å¿µè‚¡é—œéµå­—æœå°‹</div>
    </div>

    <div class="reports-list" id="mainList"></div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-controls">
                <button class="modal-back-btn" id="modalBackBtn" onclick="modalGoBack()" style="display:none;">â¬…ï¸ è¿”å›</button>
                <div id="modalTitleArea"></div>
            </div>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-tabs" id="modalTabs"></div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<script>
// === å…¨åŸŸè®Šæ•¸ ===
const FILES = { news: '01_news.xlsx', memo: '02_memo.xlsx', report: '03_ç”¢æ¥­å±•æœ›å ±å‘Š.xlsx', master: '04_master.xlsx', strategy: '05_Strategy_çµ±ä¸€æŠ•é¡§.xlsx', cb: '00_CB.xlsx', revenue: '06_revenue.xlsx' };
let DB = { stocks: {}, revenue: {}, cb: {}, cbList: [], cbDetails: {}, news: [], reports: [], strategy: [] };
let state = { currentDB: 'stock', history: [], search: '' };

const $ = id => document.getElementById(id);
const formatNum = (n) => n ? parseFloat(n).toLocaleString() : '-';
const safeStr = (s) => (s || '').toString().trim();

// === è³‡æ–™è¼‰å…¥æ ¸å¿ƒ (å„ªåŒ–ç‰ˆ) ===
async function loadData() {
    const updateProgress = (txt, pct) => { $('loadingText').innerText = txt; $('loadingBar').style.width = pct + '%'; };

    try {
        // 1. è¼‰å…¥ä¸»æª”
        updateProgress('è®€å–è‚¡ç¥¨ä¸»æª”...', 10);
        let buf = await fetch(FILES.master).then(r => r.arrayBuffer());
        let wb = XLSX.read(buf, {type:'array'});
        XLSX.utils.sheet_to_json(wb.Sheets['ä¸»è³‡æ–™åº«']).forEach(r => {
            let code = safeStr(r['ä»£è™Ÿ']);
            if(code) DB.stocks[code] = { code, name: safeStr(r['å…¬å¸åç¨±']), industry: safeStr(r['ç”¢æ¥­åˆ†é¡']), market: safeStr(r['å¸‚å ´åˆ†é¡']), price: r['æˆäº¤'], cap: r['å¸‚å€¼(å„„)'], business: safeStr(r['æ¥­å‹™æ‘˜è¦']), hasCB: false };
        });

        // 2. è¼‰å…¥ç‡Ÿæ”¶ (æ™ºæ…§æ¬„ä½åµæ¸¬)
        updateProgress('è§£æè²¡å‹™ç‡Ÿæ”¶...', 30);
        buf = await fetch(FILES.revenue).then(r => r.arrayBuffer());
        wb = XLSX.read(buf, {type:'array'});
        
        const processRevenueSheet = (sheetName, type) => {
            let sheet = wb.Sheets[sheetName];
            if(!sheet) return;
            let data = XLSX.utils.sheet_to_json(sheet);
            if(data.length > 0) {
                // æ™ºæ…§æŠ“å–æ¬„ä½: åŒ…å«é¡å‹é—œéµå­—(å¦‚"å–®æœˆ") ä½†æ’é™¤"æ’å"ã€"æˆé•·"ç­‰éæ•¸å€¼æ¬„ä½
                let keys = Object.keys(data[0]);
                let targetCols = keys.filter(k => k.includes(type) && !k.includes('æ’å') && !k.includes('æˆé•·') && !k.includes('å‚™è¨»')).sort();
                
                data.forEach(r => {
                    let code = safeStr(r['ä»£è™Ÿ']);
                    if(!DB.revenue[code]) DB.revenue[code] = {};
                    if(!DB.revenue[code][type]) DB.revenue[code][type] = [];
                    // å–æœ€è¿‘ 12 æœŸ
                    targetCols.slice(-12).forEach(col => {
                        let period = col.replace(type, '').replace('(å„„)', '').replace('å–®å­£ç‡Ÿæ”¶', '').replace('å¹´åº¦ç‡Ÿæ”¶', '');
                        DB.revenue[code][type].push({ period, value: r[col] });
                    });
                });
            }
        };
        processRevenueSheet('000_æœˆç‡Ÿæ”¶', 'å–®æœˆç‡Ÿæ”¶');
        processRevenueSheet('000_å­£ç‡Ÿæ”¶', 'å–®å­£ç‡Ÿæ”¶');
        processRevenueSheet('000_å¹´ç‡Ÿæ”¶', 'å¹´åº¦ç‡Ÿæ”¶');
        
        // ç‡Ÿæ”¶äº®é»
        let wsNote = wb.Sheets['10_è²¡å ±å‚™è¨»'];
        if(wsNote) XLSX.utils.sheet_to_json(wsNote).forEach(r => {
            let code = safeStr(r['ä»£è™Ÿ']);
            if(code) {
                if(!DB.revenue[code]) DB.revenue[code] = {};
                DB.revenue[code].highlights = { monthRecord: r['å–®æœˆç‡Ÿæ”¶å‰µç´€éŒ„æœˆæ•¸'], monthStreak: r['å–®æœˆç‡Ÿæ”¶é€£å¢æ¸›æœˆæ•¸'], yearRank: r['å–®æœˆç‡Ÿæ”¶æ­·å¹´æ’å'] };
            }
        });

        // 3. è¼‰å…¥ CB è³‡æ–™ (æ·±åº¦æ•´åˆ 01-15 Sheets)
        updateProgress('æ•´åˆå¯è½‰å‚µæˆ°æƒ…...', 50);
        buf = await fetch(FILES.cb).then(r => r.arrayBuffer());
        wb = XLSX.read(buf, {type:'array'});
        
        // å»ºç«‹ CB è©³ç´°è³‡æ–™ç´¢å¼•å‡½æ•¸
        const getCB = (code) => {
            if (!DB.cbDetails[code]) DB.cbDetails[code] = { code, adjustments: [] };
            return DB.cbDetails[code];
        };

        // 08_åŸºæœ¬è³‡æ–™ (æ ¸å¿ƒ)
        let wsCB = wb.Sheets['08_æœ€æ–°å‹•æ…‹æ¯é€±åŸºæœ¬è³‡æ–™'];
        if(wsCB) XLSX.utils.sheet_to_json(wsCB).forEach(r => {
            let cbCode = safeStr(r['ä»£è™Ÿ']);
            let stockCode = safeStr(r['è½‰æ›æ¨™çš„ä»£ç¢¼']);
            let obj = getCB(cbCode);
            Object.assign(obj, {
                stockCode, name: safeStr(r['åç¨±']), stockName: safeStr(r['è½‰æ›æ¨™çš„åç¨±']),
                convPrice: parseFloat(r['è½‰æ›åƒ¹æ ¼(å…ƒ)']), balance: parseFloat(r['æœ€æ–°é¤˜é¡(ç™¾è¬)']),
                issueDate: safeStr(r['ç™¼è¡Œæ—¥æœŸ']), maturityDate: safeStr(r['åˆ°æœŸæ—¥']),
                issueAmount: parseFloat(r['å¯¦éš›ç™¼è¡Œç¸½é¡(ç™¾è¬)']),
                remainPct: (parseFloat(r['æœ€æ–°é¤˜é¡(ç™¾è¬)']) / parseFloat(r['å¯¦éš›ç™¼è¡Œç¸½é¡(ç™¾è¬)'])) * 100
            });
            // æ­¸æˆ¶
            DB.cbList.push(obj);
            if(!DB.cb[stockCode]) DB.cb[stockCode] = [];
            DB.cb[stockCode].push(obj);
            if(DB.stocks[stockCode]) DB.stocks[stockCode].hasCB = true;
        });

        // 01_åŸºæœ¬è³‡æ–™ (è£œå……æ“”ä¿)
        let wsBasic = wb.Sheets['01_ALLCBåŸºæœ¬è³‡æ–™'];
        if(wsBasic) XLSX.utils.sheet_to_json(wsBasic).forEach(r => {
            let obj = getCB(safeStr(r['CBä»£è™Ÿ']));
            obj.guarantee = safeStr(r['æ“”ä¿']);
            obj.rating = safeStr(r['ä¿¡è©•']);
            obj.underwriter = safeStr(r['ç™¼è¡Œåˆ¸å•†']);
        });

        // 03_è³£å›æ¢ä»¶ (ç­–ç•¥é—œéµ)
        let wsPut = wb.Sheets['03_ALLCBè³£å›æ¢ä»¶'];
        if(wsPut) XLSX.utils.sheet_to_json(wsPut).forEach(r => {
            let obj = getCB(safeStr(r['CBä»£è™Ÿ']));
            obj.putDate = safeStr(r['è³£å›æ—¥æœŸ1']);
            obj.putPrice = safeStr(r['è³£å›æ¢ä»¶']);
        });

        // 09_æ—¥è¡Œæƒ… (æœ€æ–°åƒ¹æ ¼)
        let wsQuote = wb.Sheets['09_æœ€æ–°å‹•æ…‹æ¯é€±æ—¥è¡Œæƒ…'];
        if(wsQuote) XLSX.utils.sheet_to_json(wsQuote).forEach(r => {
            let obj = getCB(safeStr(r['ä»£ç¢¼']));
            obj.price = parseFloat(r['CBæ”¶ç›¤åƒ¹']) || 0;
            obj.premium = parseFloat(r['æº¢(æŠ˜)åƒ¹%']);
        });

        // 11_CBASå ±åƒ¹ (é«˜éšæ•¸æ“š)
        let wsCBAS = wb.Sheets['11_æœ€æ–°å‹•æ…‹CBASå ±åƒ¹è¡¨'];
        if(wsCBAS) XLSX.utils.sheet_to_json(wsCBAS).forEach(r => {
            let obj = getCB(safeStr(r['å¯è½‰å‚µä»£ç¢¼']));
            obj.cbasPrice = r['æ¬Šåˆ©é‡‘(ä½°å…ƒå ±åƒ¹)'];
            obj.leverage = r['æ§“æ¡¿å€æ•¸'];
            obj.volatility = r['è‚¡åƒ¹æ³¢å‹•ç‡120å¤©%'];
        });

        // 14_è½‰æ›åƒ¹æ ¼èª¿æ•´ (æ­·å²ç´€éŒ„)
        let wsAdj = wb.Sheets['14_è½‰æ›åƒ¹æ ¼èª¿æ•´'];
        if(wsAdj) XLSX.utils.sheet_to_json(wsAdj).forEach(r => {
            let stockCode = safeStr(r['å…¬å¸ä»£è™Ÿ']);
            // å°‡èª¿æ•´ç´€éŒ„ç¶å®šåˆ°è©²å…¬å¸æ——ä¸‹çš„æ‰€æœ‰ CB (ç°¡å–®å°æ‡‰)
            if(DB.cb[stockCode]) {
                DB.cb[stockCode].forEach(cb => {
                    cb.adjustments.push({ desc: safeStr(r['ä¸»æ—¨']) });
                });
            }
        });

        // 4. è¼‰å…¥å¤–é›»
        updateProgress('è¼‰å…¥å¤–é›»å¿«å ±...', 80);
        buf = await fetch(FILES.news).then(r => r.arrayBuffer());
        wb = XLSX.read(buf, {type:'array'});
        XLSX.utils.sheet_to_json(wb.Sheets['å¤–é›»ç¶œåˆå ±å°']).forEach(r => {
            DB.news.push({ date: safeStr(r['æ—¥æœŸ']), title: safeStr(r['å…¬å¸']), content: safeStr(r['å®Œæ•´å ±å°å…§å®¹']), broker: safeStr(r['åˆ¸å•†ä¾†æº']), stockCode: safeStr(r['è‚¡è™Ÿ']) });
        });

        updateProgress('æˆ°æƒ…å®¤å°±ç·’', 100);
        setTimeout(() => { $('loadingOverlay').style.display = 'none'; renderMainList(); setupSearch(); }, 500);

    } catch (e) {
        alert('è³‡æ–™è¼‰å…¥å¤±æ•—: ' + e.message); console.error(e);
    }
}

// === åˆ—è¡¨æ¸²æŸ“é‚è¼¯ ===
function renderMainList() {
    let container = $('mainList');
    container.innerHTML = '';
    let data = [];
    let renderer = null;

    if(state.currentDB === 'stock') { data = Object.values(DB.stocks); renderer = renderStockCard; }
    else if (state.currentDB === 'cb') { data = DB.cbList; renderer = renderCBCard; }
    else if (state.currentDB === 'news') { data = DB.news; renderer = renderNewsCard; }
    
    // æœå°‹éæ¿¾
    if(state.search) {
        let q = state.search.toLowerCase();
        data = data.filter(item => JSON.stringify(item).toLowerCase().includes(q));
    }

    $('cnt-' + state.currentDB).innerText = data.length;
    data.slice(0, 50).forEach(item => container.appendChild(renderer(item)));
}

function renderStockCard(stock) {
    let div = document.createElement('div');
    div.className = 'card-base';
    div.onclick = () => openStockModal(stock.code);
    let cbTag = stock.hasCB ? `<span class="meta-tag cb">ğŸ« æœ‰CB</span>` : '';
    div.innerHTML = `<div class="card-header"><span class="company-name">${stock.name} <span class="stock-code">${stock.code}</span></span>${cbTag}</div>
        <div class="card-meta"><span class="meta-tag industry">${stock.industry}</span><span class="meta-tag date">å¸‚å€¼ ${formatNum(stock.cap)}å„„</span></div>
        <div class="card-content">${stock.business || 'æš«ç„¡èªªæ˜'}</div>
        <div class="card-footer"><span class="price-info">è‚¡åƒ¹ ${stock.price}</span></div>`;
    return div;
}

function renderCBCard(cb) {
    let div = document.createElement('div');
    div.className = 'card-base';
    div.style.borderLeft = '4px solid var(--cb-color)';
    div.onclick = () => openStockModal(cb.stockCode); // é»æ“Š CB å¡ç‰‡é€²å…¥å€‹è‚¡æˆ°æƒ…
    
    // ç°¡æ˜“è¨ˆç®—
    let stock = DB.stocks[cb.stockCode] || {price: 0};
    let convVal = cb.convPrice > 0 ? (stock.price / cb.convPrice) * 100 : 0;
    let premium = cb.price > 0 ? ((cb.price - convVal) / convVal) * 100 : 0;
    
    div.innerHTML = `<div class="card-header"><span class="company-name">${cb.name} <span class="stock-code">${cb.code}</span></span></div>
        <div class="card-meta"><span class="meta-tag date">åˆ°æœŸ ${cb.maturityDate}</span><span class="meta-tag broker">é¤˜é¡ ${cb.remainPct.toFixed(1)}%</span></div>
        <div class="info-grid" style="margin:0; gap:5px;">
            <div><div class="info-label">CBå¸‚åƒ¹</div><div class="info-value">${cb.price||'-'}</div></div>
            <div><div class="info-label">æ¨™çš„è‚¡åƒ¹</div><div class="info-value">${stock.price}</div></div>
            <div><div class="info-label">è½‰æ›åƒ¹</div><div class="info-value">${cb.convPrice}</div></div>
            <div><div class="info-label">æº¢åƒ¹ç‡</div><div class="info-value ${premium<0?'val-pos':'val-neg'}">${premium?premium.toFixed(1)+'%':'-'}</div></div>
        </div>`;
    return div;
}

function renderNewsCard(news) {
    return Object.assign(document.createElement('div'), {
        className: 'card-base',
        innerHTML: `<div class="card-header"><span class="company-name">${news.title}</span><span class="stock-code">${news.stockCode}</span></div><div class="card-meta"><span class="meta-tag date">${news.date}</span><span class="meta-tag broker">${news.broker}</span></div><div class="card-content">${news.content}</div>`
    });
}

// === Modal æ ¸å¿ƒé‚è¼¯ (åŒ…å«æ™ºæ…§å°èˆª) ===
function openStockModal(code) {
    let stock = DB.stocks[code];
    if(!stock) return;
    
    // æ™ºæ…§æ­·å²å°èˆªï¼šå¦‚æœå‰ä¸€å€‹ç€è¦½çš„ä¸æ˜¯é€™æª”ï¼Œå°±æ¨å…¥æ­·å²
    if(state.history.length > 0 && state.history[state.history.length-1] !== code) {
        $('modalBackBtn').style.display = 'flex';
        let prevName = DB.stocks[state.history[state.history.length-1]].name;
        $('modalBackBtn').innerText = `â¬…ï¸ è¿”å› ${prevName}`;
    } else { 
        if(state.history.length === 0) state.history.push(code); 
        $('modalBackBtn').style.display = 'none';
    }
    // ç¢ºä¿ç•¶å‰ code åœ¨å †ç–Šé ‚ç«¯
    if(state.history[state.history.length-1] !== code) state.history.push(code);

    $('modalOverlay').classList.add('active');
    $('modalTitleArea').innerHTML = `<h2 style="font-size:20px; font-weight:700;">${stock.name} (${stock.code})</h2><div style="font-size:13px;color:#666;">${stock.industry} | ${stock.market}</div>`;
    
    // å»ºç«‹ Modal Tabs
    let tabsHtml = `<button class="modal-tab active" onclick="switchModalTab('basic')">ğŸ“Š åŸºæœ¬è³‡æ–™</button><button class="modal-tab" onclick="switchModalTab('financial')">ğŸ’° è²¡å‹™ç‡Ÿæ”¶</button><button class="modal-tab" onclick="switchModalTab('news')">ğŸ“° ç›¸é—œå ±å°</button>`;
    // åªæœ‰ç•¶æœ‰ CB æ™‚æ‰é¡¯ç¤ºæˆ°æƒ…åˆ†é 
    if(stock.hasCB) tabsHtml += `<button class="modal-tab" onclick="switchModalTab('cb')" style="color:#c2185b;">ğŸ« å¯è½‰å‚µ/CBAS</button>`;
    $('modalTabs').innerHTML = tabsHtml;
    
    // æº–å‚™è³‡æ–™
    let rev = DB.revenue[code] || {};
    let cbs = DB.cb[code] || [];
    let newsList = DB.news.filter(n => n.stockCode == code).slice(0, 10);
    
    // 1. åŸºæœ¬è³‡æ–™ Tab
    let basicHtml = `<div class="tab-pane active" id="tab-basic"><div class="section-box"><div class="info-grid">
        <div class="info-card"><div class="info-label">æˆäº¤åƒ¹</div><div class="info-value" style="font-size:24px;color:var(--primary);">${stock.price}</div></div>
        <div class="info-card"><div class="info-label">è‚¡æœ¬</div><div class="info-value">${formatNum(stock.cap/10)} å„„</div></div>
        <div class="info-card"><div class="info-label">ç”¢æ¥­åœ°ä½</div><div class="info-value" style="font-size:13px;font-weight:400;">${stock.industry}</div></div>
    </div><div class="section-title">ğŸ¢ æ¥­å‹™å…§å®¹</div><div style="line-height:1.8;color:#444;">${stock.business}</div></div></div>`;
    
    // 2. è²¡å‹™ç‡Ÿæ”¶ Tab (å‹•æ…‹æ¸²æŸ“)
    let revHtml = `<div class="tab-pane" id="tab-financial">`;
    if(rev.monthly) {
        if(rev.highlights) revHtml += `<div class="info-grid"><div class="info-card" style="background:#f0f9ff;"><div class="info-label">å–®æœˆç´€éŒ„</div><div class="info-value">${rev.highlights.monthRecord||'-'}</div></div><div class="info-card" style="background:#f0f9ff;"><div class="info-label">é€£å¢/æ¸›æœˆ</div><div class="info-value">${rev.highlights.monthStreak||'-'}</div></div></div>`;
        revHtml += `<div class="section-box"><div class="section-title">ğŸ“ˆ æœˆç‡Ÿæ”¶è¶¨å‹¢</div><div style="overflow-x:auto;"><table class="data-table"><thead><tr><th>å¹´æœˆ</th><th>ç‡Ÿæ”¶(å„„)</th></tr></thead><tbody>`;
        [...rev.monthly].reverse().forEach(m => revHtml += `<tr><td>${m.period}</td><td>${m.value}</td></tr>`);
        revHtml += `</tbody></table></div></div>`;
    } else revHtml += `<div class="error-msg">âš ï¸ æš«ç„¡è©³ç´°ç‡Ÿæ”¶è³‡æ–™</div>`;
    revHtml += `</div>`;
    
    // 3. CB æˆ°æƒ…å®¤ (å…¨æ–°è¨­è¨ˆï¼šå« Sub-tabs)
    let cbHtml = `<div class="tab-pane" id="tab-cb">`;
    if(cbs.length > 0) {
        cbs.forEach((cb, idx) => {
            let stockPrice = parseFloat(stock.price) || 0;
            let convVal = (stockPrice / cb.convPrice) * 100;
            let premium = cb.price ? ((cb.price - convVal)/convVal * 100) : 0;
            let subTabId = `cbsub-${cb.code}`;
            
            cbHtml += `<div class="section-box" style="border-left:4px solid var(--cb-color);">
                <div class="section-title" style="color:var(--cb-color);">${cb.name} (${cb.code}) <span style="font-size:12px;background:#fce4ec;padding:2px 8px;border-radius:10px;color:var(--cb-color);margin-left:10px;">å‰©é¤˜ ${cb.remainPct.toFixed(1)}%</span></div>
                
                <div class="cb-sub-tabs">
                    <div class="cb-sub-tab active" onclick="switchSubTab('${subTabId}', 'market')">ğŸ“Š è¡Œæƒ…èˆ‡ç±Œç¢¼</div>
                    <div class="cb-sub-tab" onclick="switchSubTab('${subTabId}', 'terms')">ğŸ“ ç™¼è¡Œæ¢æ¬¾</div>
                    <div class="cb-sub-tab" onclick="switchSubTab('${subTabId}', 'events')">ğŸ“‰ è½‰æ›åƒ¹ç•°å‹•</div>
                </div>

                <div id="${subTabId}-market" class="cb-sub-pane active">
                    <div class="info-grid">
                        <div class="info-card"><div class="info-label">CBå¸‚åƒ¹</div><div class="info-value">${cb.price || '-'}</div></div>
                        <div class="info-card"><div class="info-label">è½‰æ›åƒ¹æ ¼</div><div class="info-value">${cb.convPrice}</div></div>
                        <div class="info-card"><div class="info-label">è½‰æ›åƒ¹å€¼</div><div class="info-value">${convVal.toFixed(2)}</div></div>
                        <div class="info-card"><div class="info-label">æº¢åƒ¹ç‡</div><div class="info-value ${premium<0?'val-pos':'val-neg'}">${premium.toFixed(2)}%</div></div>
                    </div>
                    <div style="background:#f8f9fa;padding:12px;border-radius:8px;">
                        <div style="font-weight:700;margin-bottom:8px;color:#555;">CBAS é¸æ“‡æ¬Šå ±åƒ¹</div>
                        <div style="display:flex;gap:20px;font-size:14px;">
                            <span>æ¬Šåˆ©é‡‘: <b>${cb.cbasPrice || '-'}</b></span>
                            <span>æ§“æ¡¿: <b>${cb.leverage || '-'}x</b></span>
                            <span>æ³¢å‹•ç‡: <b>${cb.volatility || '-'}</b></span>
                        </div>
                    </div>
                </div>

                <div id="${subTabId}-terms" class="cb-sub-pane">
                    <table class="data-table">
                        <tr><td>ç™¼è¡Œæ—¥æœŸ</td><td>${cb.issueDate}</td><td>åˆ°æœŸæ—¥æœŸ</td><td>${cb.maturityDate}</td></tr>
                        <tr><td>ç™¼è¡Œç¸½é¡</td><td>${cb.issueAmount} ç™¾è¬</td><td>æ“”ä¿æƒ…å½¢</td><td>${cb.guarantee || 'ç„¡'}</td></tr>
                        <tr><td>ä¿¡ç”¨è©•ç­‰</td><td>${cb.rating || '-'}</td><td>æ‰¿éŠ·å•†</td><td>${cb.underwriter || '-'}</td></tr>
                        <tr><td style="color:var(--primary);font-weight:bold;">è³£å›æ¬Šæ—¥æœŸ</td><td colspan="3" style="color:var(--primary);font-weight:bold;">${cb.putDate || '-'}</td></tr>
                        <tr><td>è³£å›åƒ¹æ ¼</td><td colspan="3">${cb.putPrice || '-'}</td></tr>
                    </table>
                </div>

                <div id="${subTabId}-events" class="cb-sub-pane">
                    <div style="max-height:200px;overflow-y:auto;">
                        ${(cb.adjustments && cb.adjustments.length > 0) ? 
                            cb.adjustments.map(a => `<div style="padding:8px 0;border-bottom:1px solid #eee;font-size:13px;">${a.desc}</div>`).join('') : 
                            '<div style="color:#999;padding:10px;">æš«ç„¡ç•°å‹•ç´€éŒ„</div>'}
                    </div>
                </div>
            </div>`;
        });
    }
    cbHtml += `</div>`;
    
    // 4. æ–°è Tab
    let newsHtml = `<div class="tab-pane" id="tab-news"><div class="section-box">`;
    newsList.forEach(n => newsHtml += `<div style="padding:10px 0;border-bottom:1px solid #eee;"><div style="font-size:12px;color:#888;">${n.date} | ${n.broker}</div><div style="font-weight:600;">${n.content}</div></div>`);
    newsHtml += `</div></div>`;
    
    $('modalBody').innerHTML = basicHtml + revHtml + cbHtml + newsHtml;
}

// === äº’å‹•æ§åˆ¶å‡½æ•¸ ===
function switchModalTab(tabName) {
    document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    event.target.classList.add('active');
    $('tab-' + tabName).classList.add('active');
}

function switchSubTab(groupId, tabName) {
    let parent = document.getElementById(groupId + '-' + tabName).parentElement;
    let tabs = parent.previousElementSibling; // cb-sub-tabs div
    tabs.querySelectorAll('.cb-sub-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    parent.querySelectorAll('.cb-sub-pane').forEach(p => p.classList.remove('active'));
    document.getElementById(groupId + '-' + tabName).classList.add('active');
}

function closeModal() { $('modalOverlay').classList.remove('active'); state.history = []; }

function modalGoBack() {
    state.history.pop(); // ç§»é™¤ç•¶å‰
    let prevCode = state.history.pop(); // å–å¾—ä¸Šä¸€å€‹
    if(prevCode) openStockModal(prevCode); // é‡æ–°é–‹å•Ÿä¸Šä¸€å€‹
    else closeModal();
}

function switchDB(db) { state.currentDB = db; document.querySelectorAll('.db-tab').forEach(t => t.classList.toggle('active', t.dataset.db === db)); renderMainList(); }

function setupSearch() {
    let inp = $('searchInput');
    inp.addEventListener('input', (e) => {
        state.search = e.target.value.trim();
        if(state.search.length > 0) {
            $('searchSuggestions').style.display = 'block';
            let hits = Object.values(DB.stocks).filter(s => s.code.includes(state.search) || s.name.includes(state.search)).slice(0, 5);
            let html = hits.map(s => `<div class="suggestion-item" onclick="openStockModal('${s.code}')"><div class="suggestion-icon">ğŸ¢</div><div>${s.name} (${s.code})</div></div>`).join('');
            
            // æœå°‹ CB
            let cbHits = DB.cbList.filter(c => c.name.includes(state.search) || c.code.includes(state.search)).slice(0, 3);
            if(cbHits.length > 0) html += `<div class="suggestion-group-title">å¯è½‰å‚µ</div>` + cbHits.map(c => `<div class="suggestion-item" onclick="openStockModal('${c.stockCode}')"><div class="suggestion-icon">ğŸ«</div><div>${c.name}</div></div>`).join('');
            
            $('searchSuggestions').innerHTML = html || '<div style="padding:10px;color:#999;">ç„¡ç¬¦åˆçµæœ</div>';
        } else $('searchSuggestions').style.display = 'none';
        renderMainList();
    });
    
    document.addEventListener('click', (e) => { if(!e.target.closest('.search-section')) $('searchSuggestions').style.display = 'none'; });
}

window.onload = loadData;
</script>
</body>
</html>
